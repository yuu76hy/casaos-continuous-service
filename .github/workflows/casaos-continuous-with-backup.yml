name: CasaOSå¤‡ä»½æ¢å¤ï¼ˆå…ˆè£…åæ¢ ä»…ä¸ªäººæ•°æ® ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–å‡†å¤‡
        run: |
          set -e
          echo "===== ç³»ç»Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      - name: 2-å®˜æ–¹ä¸€é”®å®‰è£…Dockerï¼ˆå«composeï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          sudo apt remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash
          sudo systemctl enable docker containerd && sudo systemctl start docker containerd
          sleep 3
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆï¼Œè‡ªå¸¦composeåŠŸèƒ½"

      - name: 3-åˆ›å»ºå…å¯†rootæƒé™ç”¨æˆ·
        run: |
          set -e
          echo "===== åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
            echo "âœ… ç”¨æˆ·å¯†ç ï¼šè‡ªå®šä¹‰é…ç½®"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "âœ… ç”¨æˆ·éšæœºå¯†ç ï¼š$RANDOM_PASSï¼ˆå¦¥å–„ä¿å­˜ï¼‰"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME" && sudo usermod -aG docker "$USER_NAME"
          echo "âœ… rootsç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 4-Rcloneé…ç½®+WebDAVæ ¡éªŒ+å¿«ç…§æ£€æµ‹
        run: |
          set -e
          echo "===== WebDAVé…ç½®ä¸å¿«ç…§æ£€æµ‹ ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} 2>/dev/null || true
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… é¦–æ¬¡éƒ¨ç½²æ— å¿«ç…§ï¼Œå°†çº¯å‡€å¯åŠ¨CasaOS"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: 5-å…¨æ–°å®‰è£…çº¯å‡€CasaOSï¼ˆä»…ç¨‹åºï¼Œæ— æ•°æ®ï¼‰
        run: |
          set -e
          echo "===== å®‰è£…çº¯å‡€CasaOSç¨‹åº ====="
          sudo systemctl restart docker containerd && sleep 3
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo rm -rf /usr/bin/casaos 2>/dev/null || true
          sudo systemctl daemon-reload
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos && sudo systemctl stop docker 2>/dev/null || true
          echo "âœ… çº¯å‡€CasaOSå®‰è£…å®Œæˆï¼Œå¾…å¯åŠ¨"

      - name: 6-æ¢å¤ä¸ªäººæ ¸å¿ƒæ•°æ®ï¼ˆæ— å¿«ç…§è‡ªåŠ¨è·³è¿‡ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ¢å¤ä¸ªäººæ ¸å¿ƒæ•°æ® ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} 2>/dev/null || true
          echo "âœ… ä¸ªäººæ•°æ®æ¢å¤å®Œæˆ"

      # æ ¸å¿ƒä¼˜åŒ–ï¼šåŒºåˆ†æœ‰æ— å¿«ç…§å¯åŠ¨é€»è¾‘ï¼Œæ— å¿«ç…§å¿«é€Ÿçº¯å‡€å¯åŠ¨ï¼Œä¸å¡é¡¿
      - name: 7-æƒé™æ ¡æ­£+å·®å¼‚åŒ–å¯åŠ¨æœåŠ¡ï¼ˆæ— å¿«ç…§ç²¾ç®€ç‰ˆï¼‰
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£+å¯åŠ¨æœåŠ¡ ====="
          # å·®å¼‚åŒ–æƒé™é…ç½®ï¼šæœ‰å¿«ç…§å…¨é‡æ ¡æ­£ï¼Œæ— å¿«ç…§æç®€æ ¡æ­£
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          else
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA /root/.config 2>/dev/null || true
            sudo chown -R root:root /etc/casaos /var/lib/casaos /DATA /root/.config /var/lib/docker
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          fi
          # ä¿®å¤docker.sockæƒé™+é‡Šæ”¾ç«¯å£
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo chmod 660 /run/docker.sock 2>/dev/null || true
          sudo chown root:docker /run/docker.sock 2>/dev/null || true
          sudo lsof -t -i:80 -i:443 | xargs sudo kill -9 2>/dev/null || true
          sudo docker network create casaos 2>/dev/null || true

          # å·®å¼‚åŒ–å¯åŠ¨ï¼šæ— å¿«ç…§çŸ­ç­‰å¾…ï¼Œä¸åå¤æ ¡éªŒï¼Œé¿å…å¡é¡¿
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then sleep 4; else sleep 2; fi
          sudo systemctl enable --now casaos
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then sleep 6; else sleep 3; fi

          # ç²¾ç®€æ ¡éªŒï¼šæ— å¿«ç…§ä¸çº ç»“å³æ—¶çŠ¶æ€ï¼Œåå°åŠ è½½å³å¯
          if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
            echo "âœ… Docker+CasaOSå¯åŠ¨æˆåŠŸï¼"
          elif [ "${{ env.HAS_SNAPSHOT }}" = "false" ]; then
            echo "âœ… é¦–æ¬¡çº¯å‡€éƒ¨ç½²ï¼ŒCasaOSåå°å¯åŠ¨ä¸­ï¼ˆç¨ç­‰2åˆ†é’Ÿå³å¯è®¿é—®ï¼‰"
          else
            sudo systemctl restart docker containerd casaos && sleep 3
            echo "âœ… é‡è¯•å¯åŠ¨å®Œæˆ"
          fi

      - name: 8-Tailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then exit 0; fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes --accept-dns
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)
          echo "âœ… Tailscaleç»„ç½‘å®Œæˆï¼ŒIPï¼š${TS_IP:-æœªè·å–}"

      - name: 9-ä¸ªäººæ•°æ®å¤‡ä»½+è‡ªåŠ¨ç»­è·‘
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== å¤‡ä»½ä¸ªäººæ•°æ®+è‡ªåŠ¨ç»­è·‘ ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          full_backup(){
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            sudo tar -czPf /tmp/$SNAPSHOT_NAME --exclude=${EXCLUDE_RULES} $PERSONAL_DATA_DIRS
            rclone copy /tmp/$SNAPSHOT_NAME mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf
            sudo rm -f /tmp/$SNAPSHOT_NAME
            echo "âœ… å¤‡ä»½å®Œæˆï¼š$SNAPSHOT_NAME"
          }
          trigger_renew(){
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && return 1
            curl -fsSL --fail --connect-timeout 30 -X POST -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_snapshot"}'
            echo "âœ… è‡ªåŠ¨ç»­è·‘å·²è§¦å‘"
          }
          while true; do
            run_mins=$(( (date +%s - start_time)/60 ))
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then full_backup && trigger_renew && RENEW_TRIGGERED=true; fi
            [ $run_mins -ge $MAX_RUN_MINUTES ] && exit 0
            sleep 60
          done

      - name: 10-æ”¶å°¾æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç† ====="
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          if sudo systemctl is-active --quiet casaos; then
            echo "ğŸ‰ é¦–æ¬¡éƒ¨ç½²å®Œæˆï¼CasaOSçº¯å‡€è¿è¡Œâœ…"
          else
            echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆï¼ŒCasaOSåå°å¯åŠ¨ä¸­ï¼Œç¨åå³å¯è®¿é—®"
          fi
