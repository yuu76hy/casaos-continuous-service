name: CasaOS-Tailscale-Service-TEST-10MIN
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  run-service:
    runs-on: ubuntu-24.04
    timeout-minutes: 10  # 总运行时长10分钟
    env:
      MAX_RUN_MINUTES: 5  # 运行5分钟后，剩余5分钟触发备份续跑
      RUNNER_PASSWORD: "runner123"
      CASAOS_PORT: 80
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      LOG_DIR: /home/runner/logs
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      CLEAN_INTERVAL: 60  # 1分钟清理一次空间
      B2_BACKUP_BUCKET: "casaos-backup"
      BACKUP_MARKER: "latest_backup_TEST.txt"  # 测试专用标记
      LOG_FILE: "casaos_service_TEST_${{ github.run_id }}_$(date +%Y%m%d_%H%M%S).log"
      HEALTH_CHECK_TIMEOUT: 120  # 健康检查超时缩短为2分钟
      NEW_RUN_ID_FILE: "/home/runner/new_run_id_TEST.txt"

    steps:
      - name: 步骤1 - 系统环境初始化
        id: step1
        continue-on-error: false
        run: |
          mkdir -p $LOG_DIR
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "========== 测试环境初始化 =========="
          echo "====================================="
          echo "1. 正在更新系统软件包列表..."
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "系统更新失败！"; exit 1; }
          echo "2. 正在升级系统软件包..."
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "系统升级失败！"; exit 1; }
          echo "3. 正在安装核心依赖工具..."
          pkgs="tar gzip rsync rclone netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release bc jq"
          sudo apt install -y $pkgs || { echo "依赖工具安装失败！"; exit 1; }
          echo "4. 正在设置Runner用户密码..."
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          echo "5. 正在创建数据目录..."
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          echo "====================================="
          echo "步骤1：测试环境初始化 执行完成！"
          echo "====================================="

      - name: 步骤2 - 配置B2对象存储
        id: step2
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤2：配置B2对象存储"
          echo "====================================="
          B2_KEY_ID=${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY=${{ secrets.B2_APPLICATION_KEY }}
          if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
            echo "错误：B2密钥未配置！请检查GitHub Secrets。"; exit 1;
          fi
          mkdir -p ~/.config/rclone
          echo "[b2_backend]" > ~/.config/rclone/rclone.conf
          echo "type = b2" >> ~/.config/rclone/rclone.conf
          echo "account = $B2_KEY_ID" >> ~/.config/rclone/rclone.conf
          echo "key = $B2_APPLICATION_KEY" >> ~/.config/rclone/rclone.conf
          echo "hard_delete = true" >> ~/.config/rclone/rclone.conf
          echo "timeout = 15s" >> ~/.config/rclone/rclone.conf  # 缩短超时适配短周期
          echo "retries = 2" >> ~/.config/rclone/rclone.conf    # 减少重试次数
          chmod 600 ~/.config/rclone/rclone.conf
          rclone mkdir b2_backend:${B2_BACKUP_BUCKET}/test_backups/ || echo "测试备份目录已存在，跳过创建"
          echo "====================================="
          echo "步骤2：配置B2对象存储 执行完成！"
          echo "====================================="

      - name: 步骤3 - 检查测试备份并恢复（带校验）
        id: step3
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤3：检查测试备份并恢复（如有）"
          echo "====================================="
          BACKUP_MARKER_FILE="$BACKUP_DIR/$BACKUP_MARKER"
          rclone copy b2_backend:${B2_BACKUP_BUCKET}/${BACKUP_MARKER} $BACKUP_DIR/ --timeout 15s || echo "未找到测试备份标记文件，跳过下载"
          
          if [ -f "$BACKUP_MARKER_FILE" ]; then
            LATEST_BACKUP=$(cat "$BACKUP_MARKER_FILE")
            echo "最新测试备份文件名称：$LATEST_BACKUP"
            echo "$BACKUP_EXCLUDE" | tr ' ' '\n' | sed 's/--exclude=//g' > $BACKUP_DIR/exclude-list.txt
            if rclone cat b2_backend:${B2_BACKUP_BUCKET}/test_backups/${LATEST_BACKUP} --timeout 60s --retries 2 | sudo tar -zxf - -C / --exclude-from=$BACKUP_DIR/exclude-list.txt 2>/dev/null; then
              echo "测试备份数据恢复完成，开始校验关键目录..."
              if [ -d "/etc/casaos" ] && [ -d "/var/lib/docker" ]; then
                echo "恢复校验通过：关键目录存在"
                echo "HAS_BACKUP=true" >> $GITHUB_ENV
              else
                echo "警告：恢复校验失败！关键目录缺失，使用全新环境"
                echo "HAS_BACKUP=false" >> $GITHUB_ENV
              fi
            else
              echo "警告：测试备份数据恢复失败，使用全新环境！"
              echo "HAS_BACKUP=false" >> $GITHUB_ENV
            fi
          else
            echo "未找到测试备份标记文件，使用全新环境！"
            echo "HAS_BACKUP=false" >> $GITHUB_ENV
          fi
          echo "====================================="
          echo "步骤3：检查测试备份并恢复 执行完成！"
          echo "====================================="

      - name: 步骤4 - 安装CasaOS
        id: step4
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤4：安装CasaOS"
          echo "====================================="
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || { echo "CasaOS安装警告，继续执行"; }
          sudo systemctl start casaos
          if sudo systemctl is-active --quiet casaos; then
            echo "CasaOS服务启动成功！"
          else
            echo "警告：CasaOS服务启动异常，请检查日志！"
          fi
          echo "====================================="
          echo "步骤4：安装CasaOS 执行完成！"
          echo "====================================="

      - name: 步骤5 - 部署Tailscale组网
        id: step5
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤5：部署Tailscale组网"
          echo "====================================="
          if ! curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart"; then
            echo "Tailscale脚本安装失败，尝试APT方式安装..."
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
            sudo apt update && sudo apt install -y tailscale || { echo "错误：Tailscale安装失败！"; exit 1; }
          fi
          sudo systemctl enable --now tailscaled && sleep 3  # 缩短等待时间
          MAX_RETRIES=3  # 减少重试次数
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          if [ -z "$TS_AUTH_KEY" ]; then
            echo "错误：Tailscale授权密钥未配置！"; exit 1;
          fi
          TAILSCALE_IP=""
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-TEST-${{ github.run_id }} --accept-routes=false --accept-dns=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "Tailscale组网成功！内网IP：$TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            echo "Tailscale组网重试中，剩余次数：$MAX_RETRIES"
            sleep 3
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "错误：Tailscale组网失败！"; exit 1;
          fi
          echo "====================================="
          echo "步骤5：部署Tailscale组网 执行完成！"
          echo "====================================="

      - name: 步骤6 - 输出测试服务访问信息
        id: step6
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "=========== 测试服务访问信息 ==========="
          echo "====================================="
          echo "测试服务总运行时长：10分钟"
          echo "备份续跑触发时机：运行5分钟后（剩余5分钟）"
          echo "系统剩余空间：$(df -h / | awk 'NR==2{print $4}')"
          echo "Runner用户密码：$RUNNER_PASSWORD"
          echo "B2存储连接状态：success"
          echo "CasaOS管理面板地址：http://$TAILSCALE_IP:$CASAOS_PORT"
          echo "数据来源：$(if [ $HAS_BACKUP = 'true' ]; then echo "从B2测试备份恢复"; else echo "全新测试环境部署"; fi)"
          echo "测试日志文件路径：$LOG_DIR/$LOG_FILE"
          echo "====================================="
          echo "测试服务启动完成！"
          echo "====================================="

      - name: 步骤7 - 核心保活+备份续跑+健康检查（10分钟版）
        id: step7
        continue-on-error: true
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "==== 核心保活+备份续跑+健康检查 ===="
          echo "====================================="
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}
          CURRENT_RUN_ID=${{ github.run_id }}

          auto_clean() {
            echo "[$(date)] 执行测试环境空间清理..."
            BEFORE=$(df -h / | awk 'NR==2{print $4}')
            sudo apt clean -y && sudo apt autoremove -y --purge
            sudo docker system prune -af --volumes 2>/dev/null
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null
            AFTER=$(df -h / | awk 'NR==2{print $4}')
            echo "[$(date)] 空间清理完成：$BEFORE → $AFTER"
          }

          do_backup() {
            echo "[$(date)] 【测试触发】服务剩余5分钟，开始执行备份任务..."
            TS=$(date +%Y%m%d_%H%M%S)
            BK_NAME="casaos_TEST_${CURRENT_RUN_ID}_$TS.tar.gz"
            sudo systemctl stop casaos
            sleep 2  # 缩短停止等待时间
            # 备份到测试专用目录
            if sudo tar -zcf - $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat b2_backend:${B2_BACKUP_BUCKET}/test_backups/${BK_NAME} --timeout 30s --retries 2; then
              BK_SIZE=$(rclone size b2_backend:${B2_BACKUP_BUCKET}/test_backups/${BK_NAME} --json | jq -r '.size')
              if [ "$BK_SIZE" -gt 0 ]; then
                echo "【测试通过】备份校验通过：大小 $BK_SIZE 字节"
                echo "$BK_NAME" > $BACKUP_DIR/$BACKUP_MARKER
                rclone copy $BACKUP_DIR/$BACKUP_MARKER b2_backend:${B2_BACKUP_BUCKET}/ --timeout 15s
                rclone copy $LOG_DIR/$LOG_FILE b2_backend:${B2_BACKUP_BUCKET}/test_logs/ --timeout 15s
                echo "测试日志已上传到B2: test_logs/$LOG_FILE"
              else
                echo "【测试失败】备份校验失败：文件大小为0"
              fi
            else
              echo "【测试失败】备份上传失败！"
            fi
            sudo systemctl start casaos
            backup_done=true
          }

          trigger_renew() {
            echo "[$(date)] 【测试触发】触发新的测试服务续跑..."
            if [ -z "$GITHUB_PAT" ] || [ -z "$REPO" ]; then
              echo "【测试失败】续跑失败：PAT或仓库信息未配置"
              return 1
            fi
            RESPONSE=$(curl -s -X POST https://api.github.com/repos/$REPO/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_PAT" \
              -d '{"event_type":"renew_vnc"}' \
              -w "%{http_code}" -o /dev/null --connect-timeout 15s)
            if [ "$RESPONSE" -eq 204 ]; then
              echo "【测试通过】续跑触发请求成功！等待新测试容器启动..."
              return 0
            else
              echo "【测试失败】续跑触发失败，HTTP状态码：$RESPONSE"
              return 1
            fi
          }

          check_new_container() {
            echo "[$(date)] 开始检查新测试容器健康状态，超时${HEALTH_CHECK_TIMEOUT}秒..."
            start_check=$(date +%s)
            while [ $(( $(date +%s) - start_check )) -lt $HEALTH_CHECK_TIMEOUT ]; do
              RUNS=$(curl -s -H "Authorization: Bearer $GITHUB_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&event=repository_dispatch" \
                | jq -r '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID' and .name | contains("TEST")) | .id')
              if [ -n "$RUNS" ]; then
                NEW_RUN_ID=$(echo "$RUNS" | head -n 1)
                echo "[$(date)] 【测试通过】发现新测试容器Run ID：$NEW_RUN_ID"
                echo $NEW_RUN_ID > $NEW_RUN_ID_FILE
                sleep 30  # 大幅缩短新容器等待时间
                echo "[$(date)] 【测试通过】新测试容器已启动并完成初始化！"
                return 0
              fi
              echo "[$(date)] 新测试容器尚未启动，等待5秒..."
              sleep 5
            done
            echo "[$(date)] 【测试失败】健康检查超时，未检测到正常新容器！"
            return 1
          }

          echo "核心保活逻辑启动（10分钟测试模式）..."
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi

            if (( $(echo "$free_space < 1" | bc -l) )); then
              echo "[$(date)] 剩余空间不足1G，紧急清理..."
              auto_clean
              last_clean=$now
            fi

            # 核心触发条件：剩余5分钟时执行
            if [ $((MAX_RUN_MINUTES - run_mins)) -eq 0 ] && [ "$backup_done" = false ]; then
              do_backup
              if trigger_renew; then
                if check_new_container; then
                  echo "[$(date)] 【测试全流程通过】新容器健康检查通过，旧测试容器退出..."
                  sudo systemctl stop casaos tailscaled
                  sudo tailscale down
                  echo "[$(date)] 旧测试容器已安全退出！"
                  exit 0
                else
                  echo "[$(date)] 【测试部分失败】新容器健康检查失败，旧容器继续运行..."
                fi
              else
                echo "[$(date)] 【测试部分失败】续跑触发失败，旧容器继续运行..."
              fi
            fi

            # 服务保活
            if ! sudo systemctl is-active --quiet casaos; then
              echo "[$(date)] CasaOS未运行，重启..."
              sudo systemctl restart casaos
            fi
            if ! sudo systemctl is-active --quiet tailscaled; then
              echo "[$(date)] Tailscale未运行，重启..."
              sudo systemctl restart tailscaled
            fi

            echo "[$(date)] 已运行 $run_mins 分钟 | 剩余时间: $((MAX_RUN_MINUTES - run_mins)) 分钟 | 剩余空间: $(df -h / | awk 'NR==2{print $4}')"
            sleep 5  # 缩短循环间隔，提升响应速度
          done

      - name: 步骤8 - 测试环境清理
        id: step8
        if: always()
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤8：测试环境清理"
          echo "====================================="
          sudo systemctl stop casaos tailscaled || true
          sudo tailscale down || true
          rm -rf $BACKUP_DIR $NETDISK_ROOT || true
          rclone copy $LOG_DIR/$LOG_FILE b2_backend:${B2_BACKUP_BUCKET}/test_logs/ --timeout 15s || echo "测试日志上传失败"
          echo "====================================="
          echo "步骤8：测试环境清理完成！"
          echo "====================================="
