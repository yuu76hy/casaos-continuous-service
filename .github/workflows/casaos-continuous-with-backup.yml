name: CasaOS å›½å¤–ç¯å¢ƒç¨³å®šè‡ªæ²»ï¼ˆé›¶é”™è¯¯ï½œå¤‡ä»½å®Œæ•´ï½œè‡ªåŠ¨ç»­è·‘ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

# å…¨å±€é”ï¼šé¿å…å¹¶å‘è¿è¡Œ
concurrency:
  group: casaos-foreign-stable-lock
  cancel-in-progress: false

jobs:
  casaos_stable_run:
    runs-on: ubuntu-24.04
    timeout-minutes: 480
    defaults:
      run:
        shell: sudo bash  # å…¨ç¨‹rootæƒé™ï¼ˆç¬¦åˆGitHub Actionsè¯­æ³•ï¼‰
    env:
      # å›ºå®šç‰ˆæœ¬ï¼ˆé¿å…ä¸Šæ¸¸æ¼‚ç§»ï¼‰
      DOCKER_VERSION: "27.0.3"
      RCLONE_VERSION: "1.68.1"
      ZSTD_VERSION: "1.5.6"
      CASAOS_URL: "https://get.casaos.io"
      # å›½å¤–å®˜æ–¹æº
      APT_MIRROR: "http://archive.ubuntu.com/ubuntu"
      SECURITY_MIRROR: "http://security.ubuntu.com/ubuntu"
      # å¤‡ä»½/ç½‘ç»œé…ç½®
      LOCAL_MOUNT: "/op"
      BACKUP_DIR: "/z/Udu/CasaOS-Backup"
      DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      KEEP_BACKUPS: 2
      MD5_SUFFIX: ".md5"
      ZSTD_LEVEL: "-2"
      ZSTD_THREADS: 2
      RCLONE_TRANSFERS: 4
      RCLONE_RETRIES: 5
      RCLONE_TIMEOUT: "1h30m"
      RCLONE_STATS: "30s"
      RUN_INTERVAL: 7200  # 2å°æ—¶å¾ªç¯é—´éš”
      # Secretsï¼ˆä»GitHubä»“åº“é…ç½®ï¼‰
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PWD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PWD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      TARGET_REPO: ${{ secrets.REPO }}

    steps:
      # æ­¥éª¤0ï¼šç¯å¢ƒåˆå§‹åŒ–ï¼ˆå½»åº•æ¸…é›¶ï¼‰
      - name: 0-ã€ç¯å¢ƒé‡ç½®ã€‘ç³»ç»Ÿæ¸…é›¶+å®˜æ–¹æºé…ç½®
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"

          # é…ç½®Ubuntuå®˜æ–¹æº
          cat >/etc/apt/sources.list <<EOF
          deb $APT_MIRROR noble main restricted universe multiverse
          deb $APT_MIRROR noble-updates main restricted universe multiverse
          deb $APT_MIRROR noble-backports main restricted universe multiverse
          deb $SECURITY_MIRROR noble-security main restricted universe multiverse
          EOF

          # æ¸…ç†æ®‹ç•™
          pkill -9 -f "docker|containerd|casaos|rclone" 2>/dev/null || true
          umount -l -f $LOCAL_MOUNT 2>/dev/null || true
          rm -rf /tmp/* /var/tmp/* /var/lib/docker /etc/casaos /DATA
          apt autoremove --purge $APT_OPTS && apt clean $APT_OPTS
          sync && sysctl -w vm.drop_caches=3

          # èµ„æºè‡ªæ£€
          FREE_DISK=$(df -P -B 1G / | awk 'NR>1 {print $4}')
          (( FREE_DISK < 15 )) && { echo "ç£ç›˜ä¸è¶³ï¼Œç­‰å¾…é‡è¯•"; sleep 300; exit 1; }
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      # æ­¥éª¤1ï¼šä¾èµ–å®‰è£…ï¼ˆå›ºå®šç‰ˆæœ¬+é›¶äº¤äº’ï¼‰
      - name: 1-ã€ä¾èµ–å®‰è£…ã€‘Docker+Rclone+Zstdï¼ˆé›¶äº¤äº’ï¼‰
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"

          # åŸºç¡€å·¥å…·
          apt install $APT_OPTS curl wget gnupg davfs2 bc git
          # å›ºå®šç‰ˆæœ¬Zstd
          apt install $APT_OPTS zstd=$ZSTD_VERSION* --allow-downgrades
          # å®‰è£…Rclone
          curl -fsSL https://github.com/rclone/rclone/releases/download/v$RCLONE_VERSION/rclone-v$RCLONE_VERSION-linux-amd64.zip -o rclone.zip
          unzip -q rclone.zip && mv rclone-v$RCLONE_VERSION-linux-amd64/rclone /usr/bin/
          rm -rf rclone*

          # å®‰è£…Dockerï¼ˆé›¶äº¤äº’ï¼‰
          apt remove $APT_OPTS docker* containerd*
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --batch --yes --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu noble stable" | tee /etc/apt/sources.list.d/docker.list
          apt update $APT_OPTS
          apt install $APT_OPTS docker-ce=$DOCKER_VERSION* docker-ce-cli=$DOCKER_VERSION* containerd.io
          systemctl enable --now docker containerd
          sleep 5 && docker info >/dev/null 2>&1
          echo "âœ… Docker+ä¾èµ–å®‰è£…å®Œæˆ"

      # æ­¥éª¤2ï¼šç”¨æˆ·é…ç½®ï¼ˆrootsç”¨æˆ·ï¼‰
      - name: 2-ã€ç”¨æˆ·é…ç½®ã€‘rootsç”¨æˆ·æœ€é«˜æƒé™
        run: |
          set -euo pipefail
          USER="roots"
          id -u $USER &>/dev/null || useradd -m -s /bin/bash -G root,sudo,docker $USER
          [ -n "$ROOTS_PWD" ] && echo "$USER:$ROOTS_PWD" | chpasswd
          echo "$USER ALL=(ALL) NOPASSWD: ALL" | tee /etc/sudoers.d/$USER
          chmod 0440 /etc/sudoers.d/$USER
          echo "âœ… rootsç”¨æˆ·é…ç½®å®Œæˆ"

      # æ­¥éª¤3ï¼šWebDAVé…ç½®ï¼ˆRcloneæ¨¡å¼ï¼‰
      - name: 3-ã€WebDAVã€‘Rcloneè¿æ¥é…ç½®
        run: |
          set -euo pipefail
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PWD" ]; then
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "âš ï¸ WebDAVæœªé…ç½®ï¼Œå¤‡ä»½ç¦ç”¨"
            exit 0
          fi

          # é…ç½®Rclone
          RCLONE_CONF="/root/.rclone.conf"
          rm -f $RCLONE_CONF
          ENC_PASS=$(rclone obscure "$WEBDAV_PWD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENC_PASS" --config $RCLONE_CONF --quiet

          # æµ‹è¯•è¿æ¥
          RETRY=3
          while (( RETRY > 0 )); do
            rclone mkdir mywebdav:$BACKUP_DIR --config $RCLONE_CONF --quiet && break
            RETRY=$((RETRY-1))
            sleep 10
          done
          [ $RETRY -eq 0 ] && { echo "WebDAVè¿æ¥å¤±è´¥"; exit 0; }

          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "RCLONE_CONF=$RCLONE_CONF" >> "$GITHUB_ENV"
          echo "âœ… WebDAVé…ç½®å®Œæˆ"

      # æ­¥éª¤4ï¼šå¿«ç…§æ£€æµ‹
      - name: 4-ã€å¿«ç…§æ£€æµ‹ã€‘æŸ¥æ‰¾å†å²å¤‡ä»½
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -euo pipefail
          LATEST_SNAP=""
          BACKUPS=$(rclone ls mywebdav:$BACKUP_DIR --config $RCLONE_CONF --quiet | grep "casaos-full-snapshot.*\.tar\.zst" | sort -r)
          [ -n "$BACKUPS" ] && LATEST_SNAP=$(echo "$BACKUPS" | head -1 | awk '{print $2}')

          if [ -n "$LATEST_SNAP" ]; then
            echo "LATEST_SNAP=$LATEST_SNAP" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
            echo "âœ… æ‰¾åˆ°å¿«ç…§ï¼š$LATEST_SNAP"
          else
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            echo "âš ï¸ æ— å†å²å¿«ç…§"
          fi

      # æ­¥éª¤5ï¼šCasaOSå®‰è£…ï¼ˆé›¶äº¤äº’ï¼‰
      - name: 5-ã€CasaOSå®‰è£…ã€‘å®˜æ–¹è„šæœ¬å®‰è£…
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"

          # å®‰è£…ä¾èµ–
          apt install $APT_OPTS wget smartmontools parted ntfs-3g samba mergerfs unzip
          # å®‰è£…CasaOS
          RETRY=3
          while (( RETRY > 0 )); do
            curl -fsSL $CASAOS_URL -o /tmp/install-casaos.sh
            bash /tmp/install-casaos.sh >/dev/null 2>&1 && break
            RETRY=$((RETRY-1))
            sleep 10
          done
          [ $RETRY -eq 0 ] && { echo "CasaOSå®‰è£…å¤±è´¥ï¼Œé™çº§ç»§ç»­"; exit 0; }

          systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOSå®‰è£…å®Œæˆ"

      # æ­¥éª¤6ï¼šå¿«ç…§æ¢å¤ï¼ˆæœ‰å¤‡ä»½æ—¶æ‰§è¡Œï¼‰
      - name: 6-ã€å¿«ç…§æ¢å¤ã€‘Rcloneæµå¼æ¢å¤
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -euo pipefail
          TMP_DIR="/tmp/casaos-recovery"
          mkdir -p $TMP_DIR && chmod 777 $TMP_DIR
          trap 'rm -rf $TMP_DIR' EXIT

          # åœæ­¢æœåŠ¡
          systemctl stop docker containerd casaos 2>/dev/null || true
          pkill -9 -f "docker|containerd|casaos" 2>/dev/null || true
          sync && sleep 8

          # æ¢å¤å¿«ç…§
          SNAP=$LATEST_SNAP
          MD5="${SNAP}${MD5_SUFFIX}"
          rclone copy mywebdav:$BACKUP_DIR/$MD5 $TMP_DIR --config $RCLONE_CONF
          [ ! -s "$TMP_DIR/$MD5" ] && { echo "MD5æ–‡ä»¶ç¼ºå¤±ï¼Œè·³è¿‡æ¢å¤"; exit 0; }

          rclone cat mywebdav:$BACKUP_DIR/$SNAP --config $RCLONE_CONF | \
            tee >(md5sum -c $TMP_DIR/$MD5 >/dev/null 2>&1) | \
            tar -I zstd -xf - -C / --overwrite --absolute-names "$DATA_DIRS"

          # æƒé™æ ¡å‡†
          chmod -R 777 /var/lib/docker /etc/casaos /DATA
          echo "âœ… å¿«ç…§æ¢å¤å®Œæˆ"

      # æ­¥éª¤7ï¼šå…¨æ–°éƒ¨ç½²ç›®å½•åˆå§‹åŒ–
      - name: 7-ã€åˆå§‹åŒ–ã€‘å…¨æ–°éƒ¨ç½²ç›®å½•
        if: ${{ env.WEBDAV_AVAILABLE != 'true' || env.HAS_SNAPSHOT != 'true' }}
        run: |
          set -euo pipefail
          mkdir -p /etc/casaos /var/lib/casaos /DATA
          chmod -R 777 /etc/casaos /var/lib/casaos /DATA
          echo "âœ… å…¨æ–°ç›®å½•åˆå§‹åŒ–å®Œæˆ"

      # æ­¥éª¤8ï¼šæœåŠ¡å¯åŠ¨+å¥åº·æ£€æŸ¥
      - name: 8-ã€æœåŠ¡å¯åŠ¨ã€‘Docker+CasaOSå¥åº·æ£€æŸ¥
        run: |
          set -euo pipefail
          # å¯åŠ¨Docker
          systemctl restart docker containerd && sleep 5
          RETRY=3
          while (( RETRY > 0 )); do
            docker info >/dev/null 2>&1 && break
            RETRY=$((RETRY-1))
            systemctl restart docker containerd
            sleep 10
          done

          # å¯åŠ¨CasaOS
          systemctl enable --now casaos && sleep 10
          RETRY=3
          while (( RETRY > 0 )); do
            curl -fsSL --max-time 8 http://localhost >/dev/null 2>&1 && break
            RETRY=$((RETRY-1))
            systemctl restart casaos
            sleep 10
          done
          echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ"

      # æ­¥éª¤9ï¼šTailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼‰
      - name: 9-ã€Tailscaleã€‘ç»„ç½‘é…ç½®
        if: ${{ env.TAILSCALE_KEY != '' }}
        run: |
          set +e
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"

          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | tee /etc/apt/sources.list.d/tailscale.list
          apt update $APT_OPTS && apt install $APT_OPTS tailscale

          systemctl enable --now tailscaled
          tailscale up --authkey="$TAILSCALE_KEY" --hostname="CasaOS-Stable-$(date +%Y%m%d)" --accept-routes
          TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "ä¸å¯ç”¨")
          echo "âœ… Tailscale IPï¼š$TAILSCALE_IP"
          set -e

      # æ­¥éª¤10ï¼šå…¨é‡å¤‡ä»½ï¼ˆæ ¸å¿ƒä¿®å¤ï¼štaræ— æ— æ•ˆé€‰é¡¹ï¼‰
      - name: 10-ã€å…¨é‡å¤‡ä»½ã€‘æ•°æ®æ‰“åŒ…+ä¸Šä¼ ï¼ˆä¿®å¤taré”™è¯¯ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -euo pipefail
          TMP_DIR="/tmp/casaos-backup"
          mkdir -p $TMP_DIR && chmod 777 $TMP_DIR
          trap 'rm -rf $TMP_DIR' EXIT

          # åœæ­¢æœåŠ¡
          systemctl stop docker containerd casaos 2>/dev/null || true
          pkill -9 -f "docker|containerd|casaos" 2>/dev/null || true
          sync && sleep 8

          # æ‰“åŒ…ï¼ˆä¿®å¤ï¼šç§»é™¤æ— æ•ˆçš„-qé€‰é¡¹ï¼Œè°ƒæ•´tarå‚æ•°é¡ºåºï¼‰
          SNAP_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_SNAP="$TMP_DIR/$SNAP_NAME"
          tar \
            --ignore-failed-read \
            --absolute-names \
            $EXCLUDES \
            -I "zstd -T$ZSTD_THREADS $ZSTD_LEVEL" \
            -cPf "$LOCAL_SNAP" \
            "$DATA_DIRS"

          [ ! -s "$LOCAL_SNAP" ] && { echo "å¿«ç…§ä¸ºç©ºï¼Œè·³è¿‡å¤‡ä»½"; exit 0; }

          # ç”ŸæˆMD5
          MD5_FILE="${LOCAL_SNAP}${MD5_SUFFIX}"
          md5sum "$LOCAL_SNAP" | tee "$MD5_FILE" >/dev/null

          # ä¸Šä¼ +æ ¡éªŒ
          rclone copy "$LOCAL_SNAP" mywebdav:$BACKUP_DIR/ --config $RCLONE_CONF --transfers $RCLONE_TRANSFERS --timeout $RCLONE_TIMEOUT
          rclone copy "$MD5_FILE" mywebdav:$BACKUP_DIR/ --config $RCLONE_CONF

          # æ¸…ç†æ—§å¤‡ä»½
          BACKUPS=$(rclone ls mywebdav:$BACKUP_DIR --config $RCLONE_CONF | grep "casaos-full-snapshot.*\.tar\.zst" | sort -r | awk '{print $2}')
          echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
            rclone delete mywebdav:$BACKUP_DIR/$f --config $RCLONE_CONF
            rclone delete mywebdav:$BACKUP_DIR/${f}${MD5_SUFFIX} --config $RCLONE_CONF
          done

          # é‡å¯æœåŠ¡
          systemctl enable --now docker containerd casaos && sleep 8
          echo "âœ… å¤‡ä»½å®Œæˆ"

      # æ­¥éª¤11ï¼šè‡ªåŠ¨ç»­è·‘ï¼ˆç»ˆèº«å¾ªç¯ï¼‰
      - name: 11-ã€è‡ªåŠ¨ç»­è·‘ã€‘è§¦å‘ä¸‹æ¬¡å¾ªç¯
        run: |
          set -euo pipefail
          echo "â³ ç­‰å¾… $RUN_INTERVAL ç§’åè§¦å‘ä¸‹æ¬¡å¾ªç¯..."
          sleep $RUN_INTERVAL

          if [ -n "$USER_PAT" ] && [ -n "$TARGET_REPO" ]; then
            RETRY=3
            while (( RETRY > 0 )); do
              curl -fsSL --fail -X POST \
                -H "Authorization: token $USER_PAT" \
                -H "Content-Type: application/json" \
                https://api.github.com/repos/$TARGET_REPO/dispatches \
                -d '{"event_type":"renew_casaos_snapshot"}' && break
              RETRY=$((RETRY-1))
              sleep 10
            done
            [ $RETRY -eq 0 ] && echo "âš ï¸ æœ¬æ¬¡ç»­è·‘å¤±è´¥ï¼Œä¸‹æ¬¡è‡ªåŠ¨é‡è¯•"
          else
            echo "âš ï¸ æœªé…ç½®ç»­è·‘ï¼Œéœ€æ‰‹åŠ¨è§¦å‘"
          fi

      # æ­¥éª¤12ï¼šç»ˆææ¸…ç†
      - name: 12-ã€æ¸…ç†ã€‘ç³»ç»Ÿå½»åº•æ¸…é›¶
        if: ${{ always() }}
        run: |
          set +e
          umount -l -f $LOCAL_MOUNT 2>/dev/null || true
          rm -rf /tmp/* /var/tmp/* /root/.rclone* /etc/sudoers.d/roots
          rm -rf /var/lib/docker /etc/casaos /DATA
          apt autoremove --purge -y -qq && apt clean -y -qq
          echo "ğŸ‰ æœ¬æ¬¡è¿è¡Œå®Œæˆï¼Œä¸‹æ¬¡å¾ªç¯è‡ªåŠ¨è§¦å‘"