name: CasaOS Cloud Instance

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'
  workflow_call:

env:
  SOURCE_DIRS: "/var/lib/casaos /var/lib/docker /DATA"
  BACKUP_BUCKET: "/z/Ubu"
  WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
  WEBDAV_REMOTE_NAME: "mywebdav"

  # æ’é™¤åˆ—è¡¨ï¼šç¡®ä¿è¿™äº›ç›®å½•ä¸ä¼šè¢«å¤‡ä»½ï¼Œæˆ–è€…åœ¨æ¢å¤æ—¶è¢«è·³è¿‡
  EXCLUDE_DIRS: >-
    /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
    /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
    /usr/share/doc /usr/share/man /usr/share/locale /etc/ssl/certs
    /etc/fstab /etc/mtab /etc/hostname /etc/machine-id
    /var/lib/docker/tmp
    /var/lib/docker/overlay2
    /var/lib/docker/containers/*/mounts
    /var/lib/docker/network/files
    /var/lib/docker/buildkit
    /var/lib/docker/runtimes
    /var/lib/docker/swarm
    /var/lib/docker/trust

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: ğŸ“¦ 1. å‡†å¤‡ç³»ç»Ÿç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y rclone rsync curl wget fuse
        echo 'user_allow_other' | sudo tee -a /etc/fuse.conf > /dev/null
        mkdir -p "$"

    - name: ğŸŒ 2. é…ç½®å¹¶æŒ‚è½½ WebDAV
      # âœ… é€»è¾‘åŠ å¼ºï¼šä½¿ç”¨ contains å‡½æ•°æœ€å®‰å…¨åœ°æ£€æŸ¥ Secret æ˜¯å¦å­˜åœ¨
      if: ${{ contains(secrets, 'WEBDAV_URL') && contains(secrets, 'WEBDAV_USER') && contains(secrets, 'WEBDAV_PASSWORD') }}
      env:
        WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
        WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
        WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      run: |
        mkdir -p ï½/.config/rclone
        cat > ï½/.config/rclone/rclone.conf << EOF
[${{ env.WEBDAV_REMOTE_NAME }}]
type = webdav
url = $WEBDAV_URL
vendor = other
user = $WEBDAV_USER
pass = $WEBDAV_PASSWORD
EOF

        echo "ğŸš€ æ­£åœ¨æŒ‚è½½ WebDAV..."
        rclone mount ${{ env.WEBDAV_REMOTE_NAME }}:${{ env.WEBDAV_MOUNT_POINT }} \
          --allow-other \
          --vfs-cache-mode writes \
          --daemon \
          --timeout 1m \
          --dir-cache-time 5m \
          --poll-interval 5m

        sleep 8
        if mountpoint -q ${{ env.WEBDAV_MOUNT_POINT }}; then
          echo "âœ… WebDAV æŒ‚è½½æˆåŠŸ"
          # åˆ›å»ºæ ‡è®°æ–‡ä»¶ï¼Œä¾›åç»­æ­¥éª¤ç¡®è®¤æŒ‚è½½çŠ¶æ€
          touch /tmp/webdav_ready
        else
          echo "âŒ WebDAV æŒ‚è½½å¤±è´¥æˆ–è¶…æ—¶"
          exit 1
        fi

    - name: ğŸ“¥ 3. æ¢å¤æ•°æ®ï¼ˆä» /z/Ubuï¼‰
      # âœ… é€»è¾‘åŠ å¼ºï¼šåªè¦ WebDAV ç›¸å…³ Secret å­˜åœ¨ï¼Œå°±æ‰§è¡Œæ­¤æ­¥éª¤
      if: ${{ contains(secrets, 'WEBDAV_URL') }}
      run: |
        # æ£€æŸ¥æŒ‚è½½æ ‡è®°
        if [ ! -f /tmp/webdav_ready ]; then
          echo "âš ï¸ WebDAV æœªå°±ç»ªï¼Œè·³è¿‡æ•°æ®æ¢å¤"
          exit 0
        fi

        echo "ğŸ“‚ æ­£åœ¨ä»ç½‘ç›˜æ¢å¤æ•°æ®..."
        IFS=' ' read -r -a dirs <<< "$SOURCE_DIRS"
        for dir in "${dirs[@]}"; do
          # æ„å»ºç½‘ç›˜ä¸Šçš„æºè·¯å¾„
          webdav_src="${WEBDAV_MOUNT_POINT}${BACKUP_BUCKET}${dir}"
          
          # æ£€æŸ¥æºè·¯å¾„æ˜¯å¦å­˜åœ¨ä¸”éç©º
          if [ -d "$webdav_src" ] && [ -n "$(ls -A "$webdav_src" 2>/dev/null)" ]; then
            echo "ğŸ”„ æ­£åœ¨æ¢å¤ $dir ..."
            sudo mkdir -p "$dir"
            
            # æ„å»ºæ’é™¤å‚æ•°æ•°ç»„
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              # å¦‚æœæ’é™¤è·¯å¾„æ˜¯å½“å‰ç›®å½•çš„å­è·¯å¾„ï¼Œåˆ™æ·»åŠ åˆ°æ’é™¤åˆ—è¡¨
              if [[ "$excl" == "$dir"* ]]; then
                EXCLUDE_PARAMS+=("--exclude=$excl")
              fi
            done
            
            # æ‰§è¡ŒåŒæ­¥ï¼ˆå¸¦æ’é™¤è§„åˆ™ï¼‰
            sudo rsync -av --delete --copy-links --sparse --numeric-ids \
              "${EXCLUDE_PARAMS[@]}" "$webdav_src/" "$dir/"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ° $dir çš„å¤‡ä»½æ•°æ®ï¼Œè·³è¿‡..."
          fi
        done

    - name: ğŸ  4. å®‰è£… CasaOS
      # âœ… é€»è¾‘åŠ å¼ºï¼šå¦‚æœ WebDAV Secret ä¸å­˜åœ¨ï¼ˆæ„å‘³ç€æ˜¯å…¨æ–°å®‰è£…ï¼‰ï¼Œæˆ–è€…ä¸æ˜¯å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆæ‰‹åŠ¨è°ƒè¯•ï¼‰ï¼Œåˆ™å®‰è£…
      if: ${{ !contains(secrets, 'WEBDAV_URL') || github.event_name != 'schedule' }}
      run: |
        echo "ğŸš€ æ­£åœ¨å®‰è£… CasaOS..."
        # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…ï¼Œé¿å…é‡å¤å®‰è£…
        if ! command -v casaos-service &> /dev/null; then
          curl -fsSL https://get.casaos.io | sudo bash
        fi
        
        # ç¡®ä¿ DATA ç›®å½•å­˜åœ¨
        sudo mkdir -p /DATA
        sudo chown -R runner:runner /DATA
        echo "âœ… CasaOS å®‰è£…/æ£€æŸ¥å®Œæˆ"

    - name: â–¶ï¸ 5. å¯åŠ¨æœåŠ¡
      run: |
        echo "ğŸ”„ å¯åŠ¨ Docker å’Œ CasaOS æœåŠ¡..."
        sudo systemctl enable docker casaos
        sudo systemctl start docker casaos
        sleep 10
        
        # ç®€å•æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if systemctl is-active --quiet docker && systemctl is-active --quiet casaos; then
          echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
        else
          echo "âš ï¸ æœåŠ¡å¯åŠ¨å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

    - name: ğŸ” 6. è¿æ¥ Tailscale
      if: ${{ contains(secrets, 'TAILSCALE_AUTH_KEY') }}
      env:
        TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "ğŸ”— é…ç½® Tailscale..."
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey="$TS_AUTH_KEY" --hostname=CasaOS-Cloud
        echo "ğŸ›¡ï¸ Tailscale å·²è¿æ¥"
        echo "IPv4: $(tailscale ip -4)"
        echo "IPv6: $(tailscale ip -6)"

    - name: ğŸ”„ 7. æŒç»­è¿è¡Œä¸è‡ªåŠ¨å¤‡ä»½
      # âœ… é€»è¾‘åŠ å¼ºï¼šä»…å½“ WebDAV é…ç½®å®Œæ•´æ—¶æ‰è¿è¡Œå¤‡ä»½é€»è¾‘
      if: ${{ contains(secrets, 'WEBDAV_URL') && contains(secrets, 'WEBDAV_USER') && contains(secrets, 'WEBDAV_PASSWORD') }}
      run: |
        echo "â³ å®ä¾‹è¿è¡Œä¸­ï¼Œç­‰å¾…ç»­æ¯è§¦å‘..."
        START_TIME=$(date +%s)
        
        # å®šä¹‰å¤‡ä»½å‡½æ•°
        backup_dir() {
          local src="$1"
          local dst="${WEBDAV_MOUNT_POINT}${BACKUP_BUCKET}${src}"
          echo "ğŸ“¦ æ­£åœ¨å¤‡ä»½ $src -> $dst"
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p "$dst"
          
          # æ„å»ºæ’é™¤å‚æ•°
          local exclude_params=()
          for excl in $EXCLUDE_DIRS; do
            if [[ "$excl" == "$src"* ]]; then
              exclude_params+=(--exclude="$excl")
            fi
          done
          
          # æ‰§è¡Œ rsync å¤‡ä»½
          if sudo rsync -av --delete --copy-links --sparse --numeric-ids \
              "${exclude_params[@]}" "$src/" "$dst/"; then
            # å†™å…¥æ—¶é—´æˆ³
            date -u +"%Y-%m-%dT%H:%M:%SZ" > "$dst/backup_timestamp.txt"
            echo "âœ… $src å¤‡ä»½æˆåŠŸ"
            return 0
          else
            echo "âŒ $src å¤‡ä»½å¤±è´¥"
            return 1
          fi
        }

        # ä¸»å¾ªç¯ï¼šæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$(( (CURRENT_TIME - START_TIME) / 60 ))
          
          # å¦‚æœè¿è¡Œæ—¶é—´è¶…è¿‡ 300 åˆ†é’Ÿï¼ˆ5å°æ—¶ï¼‰ï¼Œè§¦å‘ç»­æ¯
          if [ $ELAPSED -ge 300 ]; then
            echo "â° è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå‡†å¤‡ç»­æ¯..."
            
            # æ‰§è¡Œå¤‡ä»½
            IFS=' ' read -r -a dirs <<< "$SOURCE_DIRS"
            ALL_SUCCESS=true
            for dir in "${dirs[@]}"; do
              if [ -d "$dir" ]; then
                if ! backup_dir "$dir"; then
                  ALL_SUCCESS=false
                fi
              fi
            done
            
            # å¦‚æœå¤‡ä»½å…¨éƒ¨æˆåŠŸï¼Œè§¦å‘ç»­æ¯
            if [ "$ALL_SUCCESS" = true ]; then
              echo "ğŸ”„ è§¦å‘è‡ªåŠ¨ç»­æ¯..."
              
              # è·å– PAT Token
              PAT=""
              if [ -n "${{ secrets.USER_PAT }}" ]; then
                PAT=${{ secrets.USER_PAT }}
              elif [ -n "${{ secrets.USER_GITHUB_PAT }}" ]; then
                PAT=${{ secrets.USER_GITHUB_PAT }}
              fi
              
              if [ -n "$PAT" ]; then
                # è°ƒç”¨ GitHub API è§¦å‘æ–°çš„ Workflow
                curl -X POST \
                  -H "Authorization: Bearer $PAT" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml/dispatches" \
                  -d '{"ref": "main"}'
                echo "âœ… ç»­æ¯è¯·æ±‚å·²å‘é€"
              else
                echo "âŒ é”™è¯¯ï¼šæœªé…ç½® Personal Access Tokenï¼Œæ— æ³•ç»­æ¯"
              fi
            else
              echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œä¸è§¦å‘ç»­æ¯"
            fi
            
            break
          fi
          
          sleep 300
        done

    - name: ğŸ§¹ 8. æ¸…ç†æŒ‚è½½
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç† WebDAV æŒ‚è½½..."
        fusermount -u ${{ env.WEBDAV_MOUNT_POINT }} 2>/dev/null || true
        rm -f /tmp/webdav_ready
