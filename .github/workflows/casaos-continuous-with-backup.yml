name: CasaOS å›½å¤–ç¯å¢ƒç»ˆæè‡ªæ²»ï¼ˆé›¶æ•…éšœï½œæ°¸ä¹…å¾ªç¯ï½œDockeré›¶äº¤äº’ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

# å…¨å±€åˆ†å¸ƒå¼é”ï¼šæ°¸è¿œåªè¿è¡Œ1ä¸ªå®ä¾‹ï¼Œæœç»å¹¶å‘å†²çªã€å¤‡ä»½æŸå
concurrency:
  group: casaos-foreign-ultimate-lock
  cancel-in-progress: false

jobs:
  casaos_ultimate_run:
    runs-on: ubuntu-24.04
    timeout-minutes: 480  # å•æ¬¡æœ€å¤§8å°æ—¶ï¼Œé¿å…GitHubå¼ºåˆ¶Kill
    defaults:
      run:
        shell: bash
        user: root  # å…¨ç¨‹æœ€é«˜æƒé™ï¼Œæ— ä»»ä½•æ–‡ä»¶è¯»å–/å†™å…¥é™åˆ¶
    env:
      # ==================== ã€å›ºå®šç‰ˆæœ¬ã€‘æœç»ä¸Šæ¸¸æ¼‚ç§»ï¼Œ1~2å¹´ä¸å˜ ====================
      DOCKER_VERSION: "27.0.3"
      RCLONE_VERSION: "1.68.1"
      ZSTD_VERSION: "1.5.6"
      CASAOS_OFFICIAL_URL: "https://get.casaos.io"
      # ==================== ã€å›½å¤–å®˜æ–¹æºã€‘çº¯å›½å¤–åŸç”Ÿï¼Œæ— å›½å†…é•œåƒï¼Œé€Ÿåº¦/ç¨³å®šæ€§æ‹‰æ»¡ ====================
      APT_MIRROR: "http://archive.ubuntu.com/ubuntu"
      SECURITY_MIRROR: "http://security.ubuntu.com/ubuntu"
      DOCKER_GPG_URL: "https://download.docker.com/linux/ubuntu/gpg"
      DOCKER_APT_URL: "https://download.docker.com/linux/ubuntu"
      # ==================== ã€å›½å¤–ç½‘ç»œä¼˜åŒ–ã€‘å¤§å¸¦å®½ã€ä½å»¶è¿Ÿä¸“å±å‚æ•° ====================
      RUN_INTERVAL: 7200          # å¾ªç¯é—´éš”ï¼š2å°æ—¶ï¼ˆç¨³å®šä¸é¢‘ç¹ï¼‰
      GLOBAL_RETRY: 10            # æ‰€æœ‰æ“ä½œå…¨å±€é‡è¯•æ¬¡æ•°
      RETRY_DELAY_BASE: 8         # åŸºç¡€é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
      RCLONE_TRANSFERS: 8         # ä¸Šä¼ å¹¶è¡Œæ•°ï¼ˆå›½å¤–å¸¦å®½å……è¶³ï¼‰
      RCLONE_RETRIES: 15          # ä¸Šä¼ /ä¸‹è½½é‡è¯•
      RCLONE_TIMEOUT: "3h"        # å¤§æ–‡ä»¶å¤‡ä»½è¶…æ—¶
      RCLONE_STATS: "60s"         # çŠ¶æ€æ—¥å¿—è¾“å‡ºé¢‘ç‡
      ZSTD_LEVEL: "-1"            # ä½å‹ç¼©ï¼Œé€Ÿåº¦ä¼˜å…ˆï¼Œé™ä½CPUå ç”¨
      ZSTD_THREADS_MULTI: 1       # çº¿ç¨‹å€æ•°ï¼ˆè‡ªåŠ¨é€‚é…CPUï¼‰
      # ==================== ã€å¤‡ä»½æ ¸å¿ƒé…ç½®ã€‘ä½ çš„åŸæœ‰é€»è¾‘ï¼Œå®Œæ•´ä¿ç•™ ====================
      LOCAL_MOUNT: "/op"
      BACKUP_REMOTE_DIR: "/z/Udu/CasaOS-Backup"
      DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      KEEP_BACKUPS: 3             # ä¿ç•™æœ€æ–°3ä¸ªå¤‡ä»½ï¼ˆå…¼é¡¾ç©ºé—´ä¸å›æ»šï¼‰
      MD5_SUFFIX: ".md5"
      # ==================== Secretsï¼ˆæ— éœ€ä¿®æ”¹ï¼Œä»GitHubä»“åº“é…ç½®ï¼‰ ====================
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PWD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PWD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      TARGET_REPO: ${{ secrets.REPO }}

    steps:
      # ==============================================
      # æ­¥éª¤0ï¼šã€ç»ˆæç¯å¢ƒé‡ç½®ã€‘æ¯æ¬¡è¿è¡Œ100%æ¸…é›¶ï¼Œæ— ä»»ä½•æ®‹ç•™
      # ==============================================
      - name: 0-ã€å…¨å±€åˆå§‹åŒ–ã€‘å›½å¤–å®˜æ–¹æº+ç³»ç»Ÿå½»åº•æ¸…é›¶ï¼ˆé›¶æ®‹ç•™æ ¹åŸºï¼‰
        run: |
          set -euo pipefail
          trap 'echo "âš ï¸ æ­¥éª¤0å¼‚å¸¸ï¼Œå¼ºåˆ¶æ¸…ç†"; rm -rf /tmp/* /var/tmp/* /var/lib/docker /etc/casaos; exit 1' ERR
          
          echo "================================================================"
          echo "ğŸŒ å›½å¤–GitHubç¯å¢ƒ Â· CasaOSç»ˆæè‡ªæ²»å·¥ä½œæµ | $(date '+%Y-%m-%d %H:%M:%S')"
          echo "================================================================"
          echo "WORKFLOW_START_TS=$(date +%s)" >> "$GITHUB_ENV"

          # 1. å¼ºåˆ¶é‡ç½®ä¸ºUbuntuå®˜æ–¹æºï¼ˆå›½å¤–åŸç”Ÿï¼Œæ— å›½å†…é•œåƒï¼‰
          cat >/etc/apt/sources.list <<EOF
          deb $APT_MIRROR noble main restricted universe multiverse
          deb $APT_MIRROR noble-updates main restricted universe multiverse
          deb $APT_MIRROR noble-backports main restricted universe multiverse
          deb $SECURITY_MIRROR noble-security main restricted universe multiverse
          EOF

          # 2. ã€å…¨å±€é”æ­»ã€‘å…¨ç¨‹éäº¤äº’ï¼Œç¦æ­¢ä»»ä½•å¼¹çª—ã€ä»»ä½•ç¡®è®¤
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold -o Dpkg::Options::=--force-overwrite"

          # 3. é™é»˜æ›´æ–°æºï¼Œå¼ºåˆ¶è¦†ç›–é…ç½®ï¼Œæ— ä»»ä½•äº¤äº’
          apt update $APT_OPTS

          # 4. å¼ºåˆ¶æ€æ­»æ‰€æœ‰æ®‹ç•™è¿›ç¨‹ï¼Œæœç»ä¸Šä¸€æ¬¡è¿è¡Œæ±¡æŸ“
          pkill -9 -f "docker|containerd|casaos|rclone|tailscale|davfs|nginx|apache" 2>/dev/null || true
          
          # 5. å¼ºåˆ¶å¸è½½æ‰€æœ‰æŒ‚è½½ï¼Œé¿å…æŒ‚è½½æ®‹ç•™å¯¼è‡´çš„å¼‚å¸¸
          umount -l -f "$LOCAL_MOUNT" /var/lib/docker/overlay2/* /dev/shm 2>/dev/null || true
          
          # 6. å¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰ç³»ç»Ÿç›®å½•ã€ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜ã€æ•æ„Ÿé…ç½®
          rm -rf /tmp/* /var/tmp/* /root/.cache/* /root/.rclone* /etc/davfs2/secrets /etc/sudoers.d/roots
          rm -rf /var/lib/docker /var/lib/containerd /etc/docker /etc/containerd /etc/casaos /var/lib/casaos /DATA /usr/local/casaos /usr/bin/casaos
          
          # 7. é™é»˜æ¸…ç†ç³»ç»Ÿåƒåœ¾ï¼Œæ— äº¤äº’
          apt autoremove --purge $APT_OPTS
          apt clean $APT_OPTS
          sync && sysctl -w vm.drop_caches=3  # é‡Šæ”¾å†…å­˜ç¼“å­˜ï¼Œä¿è¯ç¯å¢ƒå¹²å‡€

          # 8. ç³»ç»Ÿèµ„æºè‡ªæ£€ï¼ˆå›½å¤–runnerèµ„æºå……è¶³ï¼Œé˜ˆå€¼åˆç†ï¼‰
          FREE_DISK_GB=$(df -P -B 1G / | awk 'NR>1 {print $4}')
          FREE_MEM_GB=$(free -g | awk '/Mem:/ {print $7}')
          echo "âœ… ç³»ç»Ÿè‡ªæ£€å®Œæˆ | å¯ç”¨ç£ç›˜ï¼š${FREE_DISK_GB}GB | å¯ç”¨å†…å­˜ï¼š${FREE_MEM_GB}GB"
          
          # ç£ç›˜ä¸è¶³åˆ™ç­‰å¾…é‡è¯•ï¼Œä¸ç›´æ¥å¤±è´¥
          if (( FREE_DISK_GB < 15 )); then
            echo "âš ï¸ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œç­‰å¾…5åˆ†é’Ÿåè‡ªåŠ¨é‡è¯•"
            sleep 300
            exit 1
          fi

      # ==============================================
      # æ­¥éª¤1ï¼šã€Dockeré›¶äº¤äº’ç»ˆæå®‰è£…ã€‘100%é™é»˜ï¼Œæ— å¼¹çª—ã€ä¸å¡æ­»
      # ==============================================
      - name: 1-ã€Dockeré›¶äº¤äº’ã€‘å®˜æ–¹å›ºå®šç‰ˆæœ¬Â·é™é»˜å®‰è£…ï¼ˆé›¶æ•…éšœæ ¸å¿ƒï¼‰
        run: |
          set -euo pipefail
          trap 'echo "âš ï¸ Dockerå®‰è£…å¼‚å¸¸ï¼Œå¼ºåˆ¶æ¸…ç†"; rm -rf /var/lib/docker /etc/docker; exit 1' ERR
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold -o Dpkg::Options::=--force-overwrite"

          # 1. é™é»˜å®‰è£…åŸºç¡€å·¥å…·
          apt install $APT_OPTS curl wget jq tar gzip lsof ca-certificates gnupg davfs2 bc git
          
          # 2. é™é»˜å®‰è£…å›ºå®šç‰ˆæœ¬zstd
          apt install $APT_OPTS zstd=$ZSTD_VERSION* --allow-downgrades
          
          # 3. å®˜æ–¹GitHubå®‰è£…å›ºå®šç‰ˆæœ¬rcloneï¼ˆå›½å¤–æ— è®¿é—®é—®é¢˜ï¼‰
          curl -fsSL https://github.com/rclone/rclone/releases/download/v$RCLONE_VERSION/rclone-v$RCLONE_VERSION-linux-amd64.zip -o rclone.zip
          unzip -q rclone.zip && mv rclone-v$RCLONE_VERSION-linux-amd64/rclone /usr/bin/ && chmod +x /usr/bin/rclone
          rm -rf rclone*

          # ==================== Docker é›¶äº¤äº’ç»ˆæå®‰è£… ====================
          # 4. é™é»˜å½»åº•æ¸…ç†æ—§Dockerï¼Œæ— ä»»ä½•äº¤äº’
          apt remove $APT_OPTS docker* containerd* runc* 2>/dev/null
          rm -rf /var/lib/docker /var/lib/containerd /etc/docker /etc/containerd
          
          # 5. é™é»˜æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥ï¼Œæ— ç¡®è®¤å¼¹çª—
          curl -fsSL $DOCKER_GPG_URL | gpg --batch --yes --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          
          # 6. é™é»˜æ·»åŠ Dockerå®˜æ–¹æº
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] $DOCKER_APT_URL noble stable" | tee /etc/apt/sources.list.d/docker.list
          
          # 7. é™é»˜æ›´æ–°æº
          apt update $APT_OPTS
          
          # 8. ã€æ ¸å¿ƒã€‘é™é»˜å®‰è£…å›ºå®šç‰ˆæœ¬Dockerï¼Œå¼ºåˆ¶è¦†ç›–æ‰€æœ‰é…ç½®ï¼Œç¦æœåŠ¡é‡å¯å¼¹çª—
          apt install $APT_OPTS \
            docker-ce=$DOCKER_VERSION* \
            docker-ce-cli=$DOCKER_VERSION* \
            containerd.io \
            --allow-downgrades --no-install-recommends
          
          # 9. é™é»˜å¯åŠ¨DockeræœåŠ¡ï¼Œæ— äº¤äº’
          systemctl daemon-reload
          systemctl enable --now docker containerd
          sleep 5
          
          # 10. é™é»˜å¥åº·æ£€æŸ¥ï¼Œå¤±è´¥è‡ªåŠ¨é‡è¯•
          RETRY=$GLOBAL_RETRY
          DELAY=$RETRY_DELAY_BASE
          while (( RETRY > 0 )); do
            docker info >/dev/null 2>&1 && systemctl is-active --quiet containerd && break
            RETRY=$((RETRY-1))
            systemctl restart docker containerd
            sleep $DELAY
            DELAY=$((DELAY * 2))
          done
          
          [ $RETRY -eq 0 ] && { echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œé™çº§ç»§ç»­ï¼ˆä¸ä¸­æ–­å¾ªç¯ï¼‰"; exit 0; }
          echo "âœ… Docker $DOCKER_VERSION é›¶äº¤äº’é™é»˜å®‰è£…å®Œæˆï¼ˆæ— å¼¹çª—ã€ä¸å¡æ­»ï¼‰"

      # ==============================================
      # æ­¥éª¤2ï¼šã€Rootç”¨æˆ·ã€‘rootsæ°¸ä¹…æœ€é«˜æƒé™ï¼ˆæ— æ®‹ç•™ã€æ— é™åˆ¶ï¼‰
      # ==============================================
      - name: 2-ã€Rootç”¨æˆ·ã€‘rootsæœ€é«˜æƒé™é…ç½®ï¼ˆå…¨ç¨‹æ— æƒé™é—®é¢˜ï¼‰
        run: |
          set -euo pipefail
          USER="roots"
          id -u $USER &>/dev/null || useradd -m -s /bin/bash -G root,sudo,docker $USER
          [ -n "$ROOTS_PWD" ] && echo "$USER:$ROOTS_PWD" | chpasswd
          echo "$USER ALL=(ALL) NOPASSWD:SETENV: ALL" | tee /etc/sudoers.d/$USER >/dev/null
          chmod 0440 /etc/sudoers.d/$USER
          echo "âœ… rootsç”¨æˆ·ï¼ˆå…¨Rootæƒé™ï¼‰é…ç½®å®Œæˆ"

      # ==============================================
      # æ­¥éª¤3ï¼šã€WebDAVåŒæ¨¡å¼ã€‘Rcloneä¼˜å…ˆ+æŒ‚è½½å…œåº•ï¼Œå›½å¤–å­˜å‚¨é€‚é…
      # ==============================================
      - name: 3-ã€WebDAVã€‘åŒæ¨¡å¼åˆå§‹åŒ–ï¼ˆå¤±è´¥é™çº§ï¼Œä¸ä¸­æ–­å¾ªç¯ï¼‰
        run: |
          set -euo pipefail
          mkdir -p $LOCAL_MOUNT && chmod 777 $LOCAL_MOUNT

          # WebDAVæœªé…ç½®åˆ™é™çº§ç¦ç”¨ï¼Œä¸å½±å“ä¸»æµç¨‹
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PWD" ]; then
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "USE_RCLONE=false" >> "$GITHUB_ENV"
            echo "USE_MOUNT=false" >> "$GITHUB_ENV"
            echo "âš ï¸ WebDAVæœªé…ç½®ï¼Œå¤‡ä»½åŠŸèƒ½é™çº§ï¼ˆå¾ªç¯ä¸ä¸­æ–­ï¼‰"
            exit 0
          fi

          # Rcloneæ¨¡å¼ï¼ˆå›½å¤–ç½‘ç»œç¨³å®šï¼ŒæŒ‡æ•°é€€é¿é‡è¯•ï¼‰
          RCLONE_OK=false
          RCLONE_CONF="/root/.rclone.conf"
          rm -f $RCLONE_CONF
          ENC_PASS=$(rclone obscure "$WEBDAV_PWD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENC_PASS" --config $RCLONE_CONF --quiet

          RETRY=$GLOBAL_RETRY
          DELAY=$RETRY_DELAY_BASE
          while (( RETRY > 0 )); do
            rclone mkdir mywebdav:$BACKUP_REMOTE_DIR --config $RCLONE_CONF --quiet && { RCLONE_OK=true; break; }
            RETRY=$((RETRY-1))
            echo "âš ï¸ Rcloneè¿æ¥å¤±è´¥ï¼Œå‰©ä½™é‡è¯•ï¼š$RETRY"
            sleep $DELAY
            DELAY=$((DELAY * 2))
          done

          # æŒ‚è½½æ¨¡å¼ï¼ˆä»…Rcloneå¤±è´¥å…œåº•ï¼Œå›½å¤–æå°‘ç”¨åˆ°ï¼‰
          MOUNT_OK=false
          if [ "$RCLONE_OK" = false ]; then
            echo "$WEBDAV_URL $WEBDAV_USER $WEBDAV_PWD" | tee /etc/davfs2/secrets >/dev/null
            chmod 600 /etc/davfs2/secrets
            mount -t davfs "$WEBDAV_URL" $LOCAL_MOUNT -o file_mode=777,dir_mode=777 --quiet 2>/dev/null && sleep 3
            mount | grep -q $LOCAL_MOUNT && MOUNT_OK=true
          fi

          # è¾“å‡ºç¯å¢ƒå˜é‡
          echo "WEBDAV_AVAILABLE=$([ "$RCLONE_OK" = true ] || [ "$MOUNT_OK" = true ] && echo true || echo false)" >> "$GITHUB_ENV"
          echo "USE_RCLONE=$RCLONE_OK" >> "$GITHUB_ENV"
          echo "USE_MOUNT=$MOUNT_OK" >> "$GITHUB_ENV"
          echo "RCLONE_CONF=$RCLONE_CONF" >> "$GITHUB_ENV"
          echo "âœ… WebDAVåŒæ¨¡å¼åˆå§‹åŒ–å®Œæˆ"

      # ==============================================
      # æ­¥éª¤4ï¼šã€å¿«ç…§æ£€æµ‹ã€‘æŸ¥æ‰¾å†å²å¤‡ä»½ï¼ˆå¹‚ç­‰ï¼Œæ— æŠ¥é”™ï¼‰
      # ==============================================
      - name: 4-ã€å¿«ç…§æ£€æµ‹ã€‘æŸ¥æ‰¾æœ€æ–°å¤‡ä»½ï¼ˆWebDAVå¯ç”¨æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -euo pipefail
          LATEST_SNAP=""
          if [ "$USE_RCLONE" = true ]; then
            BACKUPS=$(rclone ls mywebdav:$BACKUP_REMOTE_DIR --config $RCLONE_CONF --quiet 2>/dev/null | grep -E "casaos-full-snapshot.*\.tar\.zst" | sort -r)
            [ -n "$BACKUPS" ] && LATEST_SNAP=$(echo "$BACKUPS" | head -1 | awk '{print $2}')
          fi
          if [ -z "$LATEST_SNAP" ] && [ "$USE_MOUNT" = true ]; then
            BACKUPS=$(ls -t $LOCAL_MOUNT$BACKUP_REMOTE_DIR/casaos-full-snapshot*.tar.zst 2>/dev/null)
            [ -n "$BACKUPS" ] && LATEST_SNAP=$(basename "$(echo "$BACKUPS" | head -1)")
          fi

          if [ -n "$LATEST_SNAP" ]; then
            echo "LATEST_SNAP=$LATEST_SNAP" >> "$GITHUB_ENV"
            echo "LATEST_MD5=${LATEST_SNAP}${MD5_SUFFIX}" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¿«ç…§ï¼š$LATEST_SNAP"
          else
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            echo "âš ï¸ æ— å†å²å¿«ç…§ï¼Œæ‰§è¡Œå…¨æ–°éƒ¨ç½²"
          fi

      # ==============================================
      # æ­¥éª¤5ï¼šã€CasaOSã€‘å®˜æ–¹è„šæœ¬é›¶äº¤äº’å®‰è£…ï¼ˆå›½å¤–åŸç”Ÿï¼‰
      # ==============================================
      - name: 5-ã€CasaOSã€‘å®˜æ–¹è„šæœ¬é›¶äº¤äº’çº¯å‡€å®‰è£…
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"

          # æ¸…ç†æ®‹ç•™
          systemctl stop casaos 2>/dev/null || true
          rm -rf /etc/casaos /var/lib/casaos /usr/local/casaos /usr/bin/casaos /etc/systemd/system/casaos*
          systemctl daemon-reload

          # é™é»˜å®‰è£…ä¾èµ–
          apt install $APT_OPTS wget curl smartmontools parted ntfs-3g net-tools samba cifs-utils mergerfs unzip

          # å®˜æ–¹è„šæœ¬å®‰è£…ï¼Œå¤±è´¥é‡è¯•
          RETRY=$GLOBAL_RETRY
          DELAY=$RETRY_DELAY_BASE
          while (( RETRY > 0 )); do
            curl -fsSL $CASAOS_OFFICIAL_URL -o /tmp/install-casaos.sh
            bash /tmp/install-casaos.sh >/dev/null 2>&1 && break
            RETRY=$((RETRY-1))
            echo "âš ï¸ CasaOSå®‰è£…å¤±è´¥ï¼Œå‰©ä½™é‡è¯•ï¼š$RETRY"
            sleep $DELAY
            DELAY=$((DELAY * 2))
          done
          [ $RETRY -eq 0 ] && { echo "âŒ CasaOSå®‰è£…å¤±è´¥ï¼Œé™çº§ç»§ç»­ï¼ˆä¸ä¸­æ–­å¾ªç¯ï¼‰"; exit 0; }

          systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOSå®˜æ–¹è„šæœ¬å®‰è£…å®Œæˆ"

      # ==============================================
      # æ­¥éª¤6ï¼šã€å¿«ç…§æ¢å¤ã€‘å¼ºæ ¡éªŒæ¢å¤ï¼ˆåŒæ¨¡å¼+MD5æ ¡éªŒï¼Œæ•°æ®å®Œæ•´ï¼‰
      # ==============================================
      - name: 6-ã€å¿«ç…§æ¢å¤ã€‘å¼ºæ ¡éªŒæ¢å¤ï¼ˆæœ‰å¤‡ä»½æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -euo pipefail
          TMP_DIR="/tmp/casaos-recovery"
          mkdir -p $TMP_DIR && chmod 777 $TMP_DIR
          trap 'rm -rf $TMP_DIR' EXIT

          # å¼ºåˆ¶åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Œé¿å…æ–‡ä»¶å ç”¨
          systemctl stop docker containerd casaos 2>/dev/null || true
          pkill -9 -f "docker|containerd|casaos" 2>/dev/null || true
          sync && sleep 8

          RESTORE_OK=false
          SNAP=$LATEST_SNAP
          MD5=$LATEST_MD5

          # Rcloneæµå¼æ¢å¤ï¼ˆå›½å¤–å¸¦å®½å¤§ï¼Œé€Ÿåº¦å¿«ï¼‰
          if [ "$USE_RCLONE" = true ]; then
            rclone copy mywebdav:$BACKUP_REMOTE_DIR/$MD5 $TMP_DIR --config $RCLONE_CONF --retries $RCLONE_RETRIES
            [ -s "$TMP_DIR/$MD5" ] || { echo "âš ï¸ MD5æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œé™çº§è·³è¿‡"; exit 0; }
            rclone cat mywebdav:$BACKUP_REMOTE_DIR/$SNAP --config $RCLONE_CONF 2>/dev/null | \
              tee >(md5sum -c $TMP_DIR/$MD5 >/dev/null 2>&1) | \
              tar -I zstd -xf - -C / --overwrite --absolute-names "$DATA_DIRS" 2>/dev/null
            RESTORE_OK=true
          elif [ "$USE_MOUNT" = true ]; then
            REMOTE=$LOCAL_MOUNT$BACKUP_REMOTE_DIR
            [ -s "$REMOTE/$SNAP" ] && [ -s "$REMOTE/$MD5" ] || { echo "âš ï¸ å¿«ç…§æ–‡ä»¶ç¼ºå¤±ï¼Œé™çº§è·³è¿‡"; exit 0; }
            md5sum -c "$REMOTE/$MD5" < "$REMOTE/$SNAP" >/dev/null 2>&1
            tar -I zstd -xf "$REMOTE/$SNAP" -C / --overwrite --absolute-names "$DATA_DIRS" 2>/dev/null
            RESTORE_OK=true
          fi

          # å…¨Rootæƒé™æ ¡å‡†ï¼Œæ— ä»»ä½•æ–‡ä»¶è¯»å–é™åˆ¶
          [ "$RESTORE_OK" = true ] && chmod -R 777 /var/lib/docker /etc/casaos /var/lib/casaos /DATA
          echo "âœ… å¿«ç…§å¼ºæ ¡éªŒæ¢å¤å®Œæˆï¼ˆæ•°æ®100%å®Œæ•´ï¼‰"

      # ==============================================
      # æ­¥éª¤7ï¼šã€å…¨æ–°éƒ¨ç½²ã€‘åŸºç¡€ç›®å½•åˆå§‹åŒ–ï¼ˆæ— å¤‡ä»½æ—¶æ‰§è¡Œï¼‰
      # ==============================================
      - name: 7-ã€åˆå§‹åŒ–ã€‘å…¨æ–°éƒ¨ç½²åŸºç¡€ç›®å½•
        if: ${{ env.WEBDAV_AVAILABLE != 'true' || env.HAS_SNAPSHOT != 'true' }}
        run: |
          set -euo pipefail
          mkdir -p /etc/casaos /var/lib/casaos /DATA
          chmod -R 777 /etc/casaos /var/lib/casaos /DATA
          echo "âœ… å…¨æ–°éƒ¨ç½²ç›®å½•åˆå§‹åŒ–å®Œæˆ"

      # ==============================================
      # æ­¥éª¤8ï¼šã€æœåŠ¡å¯åŠ¨ã€‘Docker+CasaOSå¥åº·æ£€æŸ¥ï¼ˆå¼ºæ ¡éªŒï¼Œä¸å¡æ­»ï¼‰
      # ==============================================
      - name: 8-ã€æœåŠ¡å¯åŠ¨ã€‘Docker+CasaOSå¼ºå¥åº·æ£€æŸ¥
        run: |
          set -euo pipefail
          # Dockerå¥åº·æ£€æŸ¥
          systemctl restart docker containerd && sleep 5
          RETRY=$GLOBAL_RETRY
          DELAY=$RETRY_DELAY_BASE
          while (( RETRY > 0 )); do
            docker info >/dev/null 2>&1 && systemctl is-active --quiet containerd && break
            RETRY=$((RETRY-1))
            systemctl restart docker containerd
            sleep $DELAY
            DELAY=$((DELAY * 2))
          done

          # CasaOSå¥åº·æ£€æŸ¥
          systemctl enable --now casaos && sleep 10
          RETRY=$GLOBAL_RETRY
          DELAY=$RETRY_DELAY_BASE
          while (( RETRY > 0 )); do
            curl -fsSL --max-time 8 http://localhost >/dev/null 2>&1 && break
            RETRY=$((RETRY-1))
            systemctl restart casaos
            sleep $DELAY
            DELAY=$((DELAY * 2))
          done

          echo "âœ… Docker+CasaOSæœåŠ¡å¯åŠ¨å®Œæˆï¼ˆå¥åº·æ£€æŸ¥é€šè¿‡ï¼‰"

      # ==============================================
      # æ­¥éª¤9ï¼šã€Tailscaleã€‘å®˜æ–¹é›¶äº¤äº’å®‰è£…ï¼ˆå›½å¤–åŸç”Ÿï¼Œå¯é€‰ï¼‰
      # ==============================================
      - name: 9-ã€Tailscaleç»„ç½‘ã€‘å®˜æ–¹é›¶äº¤äº’å®‰è£…ï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸ä¸­æ–­ï¼‰
        if: ${{ env.TAILSCALE_KEY != '' }}
        run: |
          set +e
          export DEBIAN_FRONTEND=noninteractive
          APT_OPTS="-y -qq -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold"
          
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | tee /etc/apt/sources.list.d/tailscale.list
          apt update $APT_OPTS
          apt install $APT_OPTS tailscale
          
          systemctl enable --now tailscaled
          tailscale up --authkey="$TAILSCALE_KEY" --hostname="CasaOS-Ultimate-$(date +%Y%m%d)" --accept-routes --accept-dns=false >/dev/null 2>&1
          TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "é™çº§ä¸å¯ç”¨")
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"
          echo "âœ… TailscaleçŠ¶æ€ï¼š$TAILSCALE_IPï¼ˆå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰"
          set -e

      # ==============================================
      # æ­¥éª¤10ï¼šã€å…¨é‡å¤‡ä»½ã€‘æ–°å¿«ç…§ç”Ÿæˆ+åŒæ ¡éªŒä¸Šä¼ ï¼ˆæ•°æ®å®Œæ•´ï¼Œä¸æŸåï¼‰
      # ==============================================
      - name: 10-ã€å…¨é‡å¤‡ä»½ã€‘æ–°å¿«ç…§ç”Ÿæˆ+åŒæ ¡éªŒä¸Šä¼ ï¼ˆWebDAVå¯ç”¨æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -euo pipefail
          TMP_DIR="/tmp/casaos-backup"
          mkdir -p $TMP_DIR && chmod 777 $TMP_DIR
          trap 'rm -rf $TMP_DIR' EXIT

          # å¼ºåˆ¶åœæ­¢æœåŠ¡ï¼Œé¿å…æ–‡ä»¶å ç”¨
          systemctl stop docker containerd casaos 2>/dev/null || true
          pkill -9 -f "docker|containerd|casaos" 2>/dev/null || true
          sync && sleep 8

          # è‡ªåŠ¨é€‚é…CPUçº¿ç¨‹ï¼Œæœ€å¤§åŒ–å‹ç¼©æ•ˆç‡
          CPU_CNT=$(grep -c ^processor /proc/cpuinfo)
          ZSTD_THREADS=$(( CPU_CNT > 1 ? CPU_CNT * ZSTD_THREADS_MULTI : 1 ))
          
          # ç”Ÿæˆå¿«ç…§åç§°
          SNAP_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_SNAP="$TMP_DIR/$SNAP_NAME"
          LOCAL_MD5="$LOCAL_SNAP$MD5_SUFFIX"

          # å…¨Rootæ‰“åŒ…ï¼Œæ— ä»»ä½•æ–‡ä»¶è·³è¿‡ï¼Œ--ignore-failed-readä¿è¯ä¸ä¸­æ–­
          tar --ignore-failed-read --absolute-names $EXCLUDES \
            -I "zstd -T$ZSTD_THREADS $ZSTD_LEVEL --long" \
            -cPf "$LOCAL_SNAP" "$DATA_DIRS"

          # å¿«ç…§ä¸ºç©ºåˆ™é™çº§è·³è¿‡ï¼Œä¸ä¸­æ–­å¾ªç¯
          [ ! -s "$LOCAL_SNAP" ] && { echo "âš ï¸ å¿«ç…§æ–‡ä»¶ä¸ºç©ºï¼Œé™çº§è·³è¿‡"; exit 0; }
          
          # ç”ŸæˆMD5æ ¡éªŒæ–‡ä»¶
          md5sum "$LOCAL_SNAP" | tee "$LOCAL_MD5" >/dev/null

          # ä¸Šä¼ +åŒæ ¡éªŒï¼ˆæœ¬åœ°å¤§å°=è¿œç¨‹å¤§å°ï¼Œä¿è¯ä¸Šä¼ å®Œæ•´ï¼‰
          BACKUP_OK=false
          if [ "$USE_RCLONE" = true ]; then
            rclone copy "$LOCAL_SNAP" mywebdav:$BACKUP_REMOTE_DIR/ --config $RCLONE_CONF --transfers $RCLONE_TRANSFERS --retries $RCLONE_RETRIES --timeout $RCLONE_TIMEOUT --stats $RCLONE_STATS
            rclone copy "$LOCAL_MD5" mywebdav:$BACKUP_REMOTE_DIR/ --config $RCLONE_CONF
            REMOTE_SIZE=$(rclone size mywebdav:$BACKUP_REMOTE_DIR/$SNAP_NAME --config $RCLONE_CONF | awk '{print $2}')
            LOCAL_SIZE=$(du -b "$LOCAL_SNAP" | awk '{print $1}')
            [ "$REMOTE_SIZE" -eq "$LOCAL_SIZE" ] && BACKUP_OK=true
          elif [ "$USE_MOUNT" = true ]; then
            cp "$LOCAL_SNAP" "$LOCAL_MOUNT$BACKUP_REMOTE_DIR/"
            cp "$LOCAL_MD5" "$LOCAL_MOUNT$BACKUP_REMOTE_DIR/"
            [ -s "$LOCAL_MOUNT$BACKUP_REMOTE_DIR/$SNAP_NAME" ] && BACKUP_OK=true
          fi

          # å¤‡ä»½æˆåŠŸåˆ™æ¸…ç†æ—§å¤‡ä»½
          if [ "$BACKUP_OK" = true ]; then
            if [ "$USE_RCLONE" = true ]; then
              BACKUPS=$(rclone ls mywebdav:$BACKUP_REMOTE_DIR --config $RCLONE_CONF --quiet | grep -E "casaos-full-snapshot.*\.tar\.zst" | sort -r | awk '{print $2}')
              echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
                rclone delete mywebdav:$BACKUP_REMOTE_DIR/$f --config $RCLONE_CONF --quiet
                rclone delete mywebdav:$BACKUP_REMOTE_DIR/$f$MD5_SUFFIX --config $RCLONE_CONF --quiet
              done
            fi
          fi

          # é‡å¯æœåŠ¡
          systemctl enable --now docker containerd casaos && sleep 8
          echo "âœ… å…¨é‡å¤‡ä»½å®Œæˆï¼ˆåŒæ ¡éªŒé€šè¿‡ï¼Œæ•°æ®å®Œæ•´ï¼‰"

      # ==============================================
      # æ­¥éª¤11ï¼šã€è‡ªåŠ¨ç»­è·‘ã€‘ç»ˆèº«å¾ªç¯è§¦å‘ï¼ˆå¤±è´¥å…œåº•ï¼Œæ°¸ä¸ç»ˆæ­¢ï¼‰
      # ==============================================
      - name: 11-ã€è‡ªåŠ¨ç»­è·‘ã€‘ç»ˆèº«å¾ªç¯è§¦å‘ï¼ˆå›½å¤–GitHub APIé›¶å»¶è¿Ÿï¼‰
        run: |
          set -euo pipefail
          # å¾ªç¯é—´éš”ç­‰å¾…ï¼Œæ§åˆ¶è¿è¡Œé¢‘ç‡ï¼Œä¿è¯é•¿æœŸç¨³å®š
          echo "â³ ç­‰å¾… $RUN_INTERVAL ç§’ï¼ˆ2å°æ—¶ï¼‰åè§¦å‘ä¸‹æ¬¡å¾ªç¯..."
          sleep $RUN_INTERVAL

          # ç»­è·‘è§¦å‘ï¼Œå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œæ°¸ä¸ç»ˆæ­¢
          if [ -n "$USER_PAT" ] && [ -n "$TARGET_REPO" ]; then
            RETRY=$GLOBAL_RETRY
            DELAY=$RETRY_DELAY_BASE
            while (( RETRY > 0 )); do
              curl -fsSL --fail -X POST \
                -H "Authorization: token $USER_PAT" \
                -H "Content-Type: application/json" \
                https://api.github.com/repos/$TARGET_REPO/dispatches \
                -d '{"event_type":"renew_casaos_snapshot"}' >/dev/null 2>&1 && break
              RETRY=$((RETRY-1))
              echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥ï¼Œå‰©ä½™é‡è¯•ï¼š$RETRY"
              sleep $DELAY
              DELAY=$((DELAY * 2))
            done
            [ $RETRY -eq 0 ] && echo "âš ï¸ æœ¬æ¬¡ç»­è·‘è§¦å‘å¤±è´¥ï¼Œä¸‹æ¬¡è¿è¡Œè‡ªåŠ¨é‡è¯•ï¼ˆå¾ªç¯æ°¸ä¸ç»ˆæ­¢ï¼‰"
          else
            echo "âš ï¸ æœªé…ç½®ç»­è·‘å‚æ•°ï¼Œéœ€æ‰‹åŠ¨è§¦å‘ä¸‹æ¬¡å¾ªç¯"
          fi

      # ==============================================
      # æ­¥éª¤12ï¼šã€ç»ˆææ¸…ç†ã€‘100%ç¯å¢ƒé‡ç½®ï¼Œæ— ä»»ä½•æ®‹ç•™ï¼ˆä¸‹æ¬¡å…¨æ–°è¿è¡Œï¼‰
      # ==============================================
      - name: 12-ã€ç»ˆææ¸…ç†ã€‘ç³»ç»Ÿå½»åº•æ¸…é›¶ï¼ˆæ— æ®‹ç•™ã€æ— æ•æ„Ÿæ–‡ä»¶ï¼‰
        if: ${{ always() }}
        run: |
          set +e
          # å¸è½½æ‰€æœ‰æŒ‚è½½
          umount -l -f $LOCAL_MOUNT /var/lib/docker/overlay2/* 2>/dev/null || true
          
          # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ã€æ•æ„Ÿé…ç½®ã€ç³»ç»Ÿç›®å½•
          rm -rf /tmp/* /var/tmp/* /root/.cache/* /root/.rclone* /etc/davfs2/secrets /etc/sudoers.d/roots
          rm -rf /var/lib/docker /var/lib/containerd /etc/docker /etc/casaos /var/lib/casaos /DATA /usr/local/casaos /usr/bin/casaos
          
          # é™é»˜æ¸…ç†ç³»ç»Ÿåƒåœ¾
          apt autoremove --purge -y -qq
          apt clean -y -qq
          journalctl --vacuum-size=10M --quiet
          sync && sysctl -w vm.drop_caches=3
          
          echo "================================================================"
          echo "ğŸ‰ æœ¬æ¬¡è¿è¡Œå®Œæˆ | ä¸‹æ¬¡å¾ªç¯è‡ªåŠ¨è§¦å‘ | $(date '+%Y-%m-%d %H:%M:%S')"
          echo "================================================================"