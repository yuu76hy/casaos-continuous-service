name: CasaOS-Tailscale-Full-Deploy
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      # æ ¸å¿ƒé…ç½®
      MAX_RUN_MINUTES: 330
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubuntu /a/Ubuntu"
      CASAOS_DATA: /var/lib/casaos
      DOCKER_DATA: /var/lib/docker
      # ä»…æ’é™¤ç³»ç»Ÿæ ¸å¿ƒç›®å½•ï¼Œå…¶ä½™å…¨é‡å¤‡ä»½æ¢å¤
      EXCLUDE_DIRS: "/bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp"
      # é‡è¯•é…ç½®
      MAX_MOUNT_RETRIES: 2  # æœ€å¤§é‡è¯•æ¬¡æ•°
      RETRY_DELAY: 10       # é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
      # Secrets å¼•ç”¨ï¼ˆéœ€åœ¨ä»“åº“é…ç½®ï¼‰
      WEBDAV_URL: "${{ secrets.WEBDAV_URL }}"
      WEBDAV_USER: "${{ secrets.WEBDAV_USER }}"
      WEBDAV_PASSWORD: "${{ secrets.WEBDAV_PASSWORD }}"
      USER_PAT: "${{ secrets.USER_PAT }}"
      TAILSCALE_AUTH_KEY: "${{ secrets.TAILSCALE_AUTH_KEY }}"
      REPO: "${{ github.repository }}"

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ==========
      - name: æ­¥éª¤1 - ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        id: step1
        run: |
          echo "===== æ­¥éª¤1ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ====="
          mkdir -p /home/runner/logs $WEBDAV_MOUNT_POINT
          LOG_FILE=/home/runner/logs/casaos-tailscale-${{ github.run_id }}.log
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
          exec > >(tee -a $LOG_FILE) 2>&1
          
          # ç³»ç»Ÿæ›´æ–°+å®‰è£…å…¨é‡ä¾èµ–
          sudo apt update -y && sudo apt upgrade -y -q
          sudo apt install -y rsync davfs2 curl wget jq iptables || { echo "ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          
          # é…ç½®sudoå…å¯†
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee -a /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      # ========== æ­¥éª¤2ï¼šæŒ‚è½½WebDAVå¹¶æ£€æµ‹å¤‡ä»½ç›®å½•ï¼ˆå¸¦2æ¬¡é‡è¯•+ç›®å½•ç©ºåˆ¤æ–­ä¿®å¤ï¼‰ ==========
      - name: æ­¥éª¤2 - æŒ‚è½½WebDAVå¹¶æ£€æµ‹å¤‡ä»½ç›®å½•
        id: step2
        run: |
          echo "===== æ­¥éª¤2ï¼šæŒ‚è½½WebDAVå¹¶æ£€æµ‹å¤‡ä»½ç›®å½• ====="
          # é…ç½®WebDAVå…å¯†æŒ‚è½½
          echo "$WEBDAV_URL $WEBDAV_USER $WEBDAV_PASSWORD" | sudo tee -a /etc/davfs2/secrets
          sudo chmod 600 /etc/davfs2/secrets
          
          # ========== æ ¸å¿ƒï¼šWebDAVæŒ‚è½½é‡è¯•é€»è¾‘ ==========
          mount_success=false
          retry_count=0
          
          while [ $retry_count -le $MAX_MOUNT_RETRIES ]; do
            # å…ˆå¸è½½æ—§æŒ‚è½½
            sudo umount $WEBDAV_MOUNT_POINT 2>/dev/null || true
            
            echo "ğŸ”„ å°è¯•æŒ‚è½½WebDAVï¼ˆç¬¬ $((retry_count+1)) æ¬¡ï¼‰"
            if sudo mount -t davfs -o uid=runner,gid=runner $WEBDAV_URL $WEBDAV_MOUNT_POINT; then
              echo "âœ… WebDAVæŒ‚è½½æˆåŠŸï¼"
              mount_success=true
              break
            else
              echo "âŒ WebDAVæŒ‚è½½å¤±è´¥ï¼ˆç¬¬ $((retry_count+1)) æ¬¡ï¼‰"
              retry_count=$((retry_count+1))
              if [ $retry_count -le $MAX_MOUNT_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åé‡è¯•..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          # é‡è¯•åä»å¤±è´¥åˆ™é€€å‡º
          if [ "$mount_success" = "false" ]; then
            echo "âŒ WebDAVæŒ‚è½½é‡è¯• $MAX_MOUNT_RETRIES æ¬¡åä»å¤±è´¥ï¼Œç»ˆæ­¢ä»»åŠ¡"
            exit 1
          fi

          # ========== ä¿®å¤ï¼šç›®å½•å­˜åœ¨ä½†ä¸ºç©ºçš„åˆ¤æ–­é€»è¾‘ ==========
          for dir in $BACKUP_DIRS; do
            target_path=$WEBDAV_MOUNT_POINT$dir
            # ç¬¬ä¸€æ­¥ï¼šåˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$target_path" ]; then
              echo "âš ï¸ $dir ç›®å½•ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºç©ºç›®å½•"
              sudo mkdir -p "$target_path"
              echo "HAS_${dir//\//_}=false" >> $GITHUB_ENV
            else
              # ç¬¬äºŒæ­¥ï¼šç›®å½•å­˜åœ¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
              if [ "$(ls -A $target_path)" ]; then
                echo "âœ… æ£€æµ‹åˆ° $dir å­˜åœ¨æœ‰æ•ˆå¤‡ä»½æ•°æ®ï¼ˆæ¢å¤æºå¯ç”¨ï¼‰"
                echo "HAS_${dir//\//_}=true" >> $GITHUB_ENV
              else
                echo "âš ï¸ $dir ç›®å½•å­˜åœ¨ä½†æ— å¤‡ä»½æ•°æ®"
                echo "HAS_${dir//\//_}=false" >> $GITHUB_ENV
              fi
            fi
          done
          echo "âœ… WebDAVæŒ‚è½½+å¤‡ä»½ç›®å½•æ£€æµ‹å®Œæˆ"

      # ========== æ­¥éª¤3ï¼šä»z/aåŒç›˜å…¨é‡æ¢å¤æ•°æ® ==========
      - name: æ­¥éª¤3 - ä»z/aåŒç›˜å…¨é‡æ¢å¤æ•°æ®
        id: step3
        run: |
          echo "===== æ­¥éª¤3ï¼šåŒç›˜å…¨é‡æ¢å¤æ•°æ® ====="
          RESTORE_DONE=false
          # ä¼˜å…ˆä»/z/Ubuntuæ¢å¤ï¼Œå¤±è´¥åˆ™å°è¯•/a/Ubuntu
          for dir in $BACKUP_DIRS; do
            env_key="HAS_${dir//\//_}"
            target_path=$WEBDAV_MOUNT_POINT$dir
            if [ "${!env_key}" = "true" ] && [ "$RESTORE_DONE" = "false" ]; then
              echo "ğŸ”„ å¼€å§‹ä» $dir å…¨é‡æ¢å¤æ•°æ®"
              EXCLUDE_PARAMS=()
              for excl in $EXCLUDE_DIRS; do
                EXCLUDE_PARAMS+=("--exclude=${excl}/*")
              done
              sudo rsync -av --delete --ignore-errors "${EXCLUDE_PARAMS[@]}" "$target_path/" / || { echo "$diræ¢å¤å¤±è´¥"; continue; }
              echo "âœ… ä» $dir å…¨é‡æ¢å¤å®Œæˆ"
              RESTORE_DONE=true
            fi
          done
          if [ "$RESTORE_DONE" = "false" ]; then
            echo "âš ï¸ åŒç›˜å‡æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®ï¼Œè·³è¿‡æ¢å¤"
          fi
          echo "DATA_RESTORED=$RESTORE_DONE" >> $GITHUB_ENV

      # ========== æ­¥éª¤4ï¼šæ¸…ç©ºå¤‡ä»½ç›®å½•æ—§æ•°æ® ==========
      - name: æ­¥éª¤4 - æ¸…ç©ºå¤‡ä»½ç›®å½•æ—§æ•°æ®
        id: step4
        run: |
          echo "===== æ­¥éª¤4ï¼šæ¸…ç©ºå¤‡ä»½ç›®å½•æ—§æ•°æ® ====="
          for dir in $BACKUP_DIRS; do
            target_path=$WEBDAV_MOUNT_POINT$dir
            echo "ğŸ”„ æ¸…ç©º $dir æ—§å¤‡ä»½æ•°æ®"
            sudo rm -rf "$target_path"/*
            echo "âœ… $dir æ—§æ•°æ®å·²æ¸…ç©º"
          done
          echo "âœ… æ‰€æœ‰å¤‡ä»½ç›®å½•å·²å‡†å¤‡å°±ç»ª"

      # ========== æ­¥éª¤5ï¼šå®‰è£…CasaOSï¼ˆæœ‰å¤‡ä»½åˆ™è·³è¿‡ï¼‰ ==========
      - name: æ­¥éª¤5 - å®‰è£…CasaOSï¼ˆæœ‰å¤‡ä»½åˆ™è·³è¿‡ï¼‰
        id: step5
        run: |
          echo "===== æ­¥éª¤5ï¼šå®‰è£…CasaOS ====="
          if [ "${{ env.DATA_RESTORED }}" = "true" ] && [ -d "$CASAOS_DATA" ]; then
            echo "âœ… æ£€æµ‹åˆ°CasaOSå¤‡ä»½æ•°æ®ï¼Œè·³è¿‡å®‰è£…"
            exit 0
          fi
          echo "ğŸ”„ å¼€å§‹å®‰è£…CasaOS"
          curl -fsSL https://get.casaos.io | sudo bash || { echo "CasaOSå®‰è£…å¤±è´¥"; exit 1; }
          echo "âœ… CasaOSå®‰è£…å®Œæˆ"

      # ========== æ­¥éª¤6ï¼šå¯åŠ¨CasaOS+DockeræœåŠ¡ ==========
      - name: æ­¥éª¤6 - å¯åŠ¨CasaOS+DockeræœåŠ¡
        id: step6
        run: |
          echo "===== æ­¥éª¤6ï¼šå¯åŠ¨CasaOS+DockeræœåŠ¡ ====="
          sudo systemctl enable --now docker || { echo "Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          sudo systemctl enable --now casaos || { echo "CasaOSå¯åŠ¨å¤±è´¥"; exit 1; }
          sleep 30
          echo "DockerçŠ¶æ€: $(sudo systemctl is-active docker)"
          echo "CasaOSçŠ¶æ€: $(sudo systemctl is-active casaos)"
          echo "âœ… CasaOS+DockeræœåŠ¡å¯åŠ¨å®Œæˆ"

      # ========== æ­¥éª¤7ï¼šéƒ¨ç½²Tailscaleç»„ç½‘ ==========
      - name: æ­¥éª¤7 - éƒ¨ç½²Tailscaleç»„ç½‘
        id: step7
        run: |
          echo "===== æ­¥éª¤7ï¼šéƒ¨ç½²Tailscaleç»„ç½‘ ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âŒ æœªé…ç½®Tailscaleæˆæƒå¯†é’¥ï¼Œç»„ç½‘å¤±è´¥"; exit 1;
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash || { echo "Tailscaleå®‰è£…å¤±è´¥"; exit 1; }
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-github-runner" || { echo "Tailscaleç»„ç½‘å¤±è´¥"; exit 1; }
          TAILSCALE_IP=$(sudo tailscale ip -4)
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œå†…ç½‘IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      # ========== æ­¥éª¤8ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: æ­¥éª¤8 - è¾“å‡ºè®¿é—®ä¿¡æ¯
        id: step8
        run: |
          echo "===== æ­¥éª¤8ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ====="
          RUNNER_PUBLIC_IP=$(curl -s ifconfig.me)
          TAILSCALE_IP=${{ env.TAILSCALE_IP }}
          echo "====================================="
          echo "ğŸ”— å…¬ç½‘è®¿é—®åœ°å€: http://$RUNNER_PUBLIC_IP:80"
          echo "ğŸ”’ Tailscaleå†…ç½‘è®¿é—®: http://$TAILSCALE_IP:80"
          echo "====================================="
          echo "ğŸ”‘ CasaOSé»˜è®¤è´¦å·: admin"
          echo "ğŸ”‘ CasaOSé»˜è®¤å¯†ç : password"
          echo "âš ï¸ ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
          echo "âœ… è®¿é—®ä¿¡æ¯è¾“å‡ºå®Œæˆ"

      # ========== æ­¥éª¤9ï¼šä¿æ´»+å•ç›®å½•å¤‡ä»½å®Œæˆè§¦å‘ç»­è·‘ ==========
      - name: æ­¥éª¤9 - ä¿æ´»+å•ç›®å½•å¤‡ä»½å®Œæˆè§¦å‘ç»­è·‘
        id: step9
        run: |
          echo "===== æ­¥éª¤9ï¼šä¿æ´»+å•ç›®å½•å¤‡ä»½å®Œæˆè§¦å‘ç»­è·‘ ====="
          start_time=$(date +%s)
          backup_done=false
          trigger_done=false

          # ç»­è·‘è§¦å‘å‡½æ•°
          trigger_renew() {
            if [ "$trigger_done" = "true" ]; then return 0; fi
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ ç»­è·‘é…ç½®ç¼ºå¤±"; return 1;
            fi
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_tailscale"}' \
              -w "%{http_code}" -o /dev/null)
            if [ $RESPONSE -eq 204 ]; then
              echo "âœ… ç»­è·‘ä»»åŠ¡è§¦å‘æˆåŠŸï¼"
              trigger_done=true
              return 0
            else
              echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥ï¼ŒçŠ¶æ€ç : $RESPONSE"; return 1;
            fi
          }

          # å¤‡ä»½å‡½æ•°ï¼šå•ç›®å½•å®Œæˆå³è§¦å‘ç»­è·‘
          backup_single_dir() {
            local dir=$1
            local target_path=$WEBDAV_MOUNT_POINT$dir
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=${excl}/*")
            done
            echo "ğŸ”„ å¼€å§‹å¤‡ä»½ $dir"
            sudo rsync -av --delete --ignore-errors "${EXCLUDE_PARAMS[@]}" / "$target_path/"
            if [ $? -eq 0 ]; then
              echo "âœ… $dir å¤‡ä»½å®Œæˆï¼"
              echo "backup_time=$(date +%Y%m%d_%H%M%S) runner_id=${{ github.run_id }}" | sudo tee "$target_path/backup_marker.txt" > /dev/null
              # å…³é”®ï¼šå•ä¸ªç›®å½•å¤‡ä»½å®Œæˆç«‹å³è§¦å‘ç»­è·‘
              echo "ğŸ”” æ£€æµ‹åˆ° $dir å¤‡ä»½å®Œæˆï¼Œè§¦å‘ç»­è·‘ä»»åŠ¡"
              trigger_renew
              backup_done=true
            else
              echo "âŒ $dir å¤‡ä»½å¤±è´¥"
            fi
          }

          # ä¿æ´»ä¸»å¾ªç¯
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2{print $4}')

            # å‰©ä½™30åˆ†é’Ÿæ‰§è¡Œå¤‡ä»½
            if [ $((MAX_RUN_MINUTES - run_mins)) -eq 30 ] && [ "$backup_done" = "false" ]; then
              echo "âš ï¸ ä»»åŠ¡å‰©ä½™30åˆ†é’Ÿï¼Œå¼€å§‹æ‰§è¡Œå¤‡ä»½"
              # éå†ç›®å½•å¤‡ä»½ï¼Œä»»æ„ä¸€ä¸ªå®Œæˆå³è§¦å‘ç»­è·‘
              for dir in $BACKUP_DIRS; do
                backup_single_dir $dir
                # è§¦å‘æˆåŠŸåˆ™é€€å‡ºå¾ªç¯ï¼Œæ— éœ€å¤‡ä»½å…¶ä»–ç›®å½•
                if [ "$trigger_done" = "true" ]; then
                  echo "âœ… ç»­è·‘å·²è§¦å‘ï¼Œæ—§ä»»åŠ¡å‡†å¤‡é€€å‡º"
                  exit 0
                fi
              done
            fi

            echo "ğŸ“Š ä¿æ´»çŠ¶æ€ï¼šå·²è¿è¡Œ $run_mins åˆ†é’Ÿ | å‰©ä½™ $((MAX_RUN_MINUTES-run_mins)) åˆ†é’Ÿ | å¯ç”¨ç©ºé—´ $free_space"
            sleep 60
          done

      # ========== æ­¥éª¤10ï¼šæ¸…ç†ç¯å¢ƒ ==========
      - name: æ­¥éª¤10 - æ¸…ç†ç¯å¢ƒ
        id: step10
        if: ${{ always() }}
        run: |
          echo "===== æ­¥éª¤10ï¼šç¯å¢ƒæ¸…ç† ====="
          sudo umount $WEBDAV_MOUNT_POINT 2>/dev/null || true
          for dir in $BACKUP_DIRS; do
            log_path=$WEBDAV_MOUNT_POINT$dir/logs
            sudo mkdir -p $log_path
            sudo cp ${{ env.LOG_FILE }} $log_path/ || echo "âš ï¸ æ—¥å¿—åŒæ­¥åˆ° $dir å¤±è´¥"
          done
          sudo rm -rf /tmp/* /home/runner/*.log
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
