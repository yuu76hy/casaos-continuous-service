name: 1Panel-å¿«ç…§-å¤‡ä»½-æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_1panel_snapshot]

jobs:
  1panel_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # ä»…ä¿ç•™1Panelæ ¸å¿ƒç›®å½•
      CORE_DIRS: "/var/lib/docker /etc/docker /DATA /etc/systemd/system /opt/1panel /etc/1panel /var/log/1panel"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/opt/1panel/logs
        --exclude=/opt/1panel/tmp
        --exclude=/etc/1panel/*.tmp
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true

    steps:
      - name: ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–å®‰è£…
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ…ç¯å¢ƒå·²æˆåŠŸåˆå§‹åŒ–"

      - name: åˆ›å»ºrootsç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… rootsç”¨æˆ·åˆ›å»ºï¼Œå¯†ç ï¼š$RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi

      - name: é…ç½®Rclone for WebDAV
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒç¼ºå°‘WebDAVå‡­è¯"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="webdav" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒWebDAVè¿æ¥å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "âœ…WebDAVå·²è¿æ¥"
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "1panel-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ…æœ€æ–°è¿œç¨‹å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸æœªæ‰¾åˆ°è¿œç¨‹å¿«ç…§"
          fi

      - name: ä»WebDAVæ¢å¤1Panelå¿«ç…§
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== æ¢å¤1Panelå¿«ç…§ï¼š$LATEST_SNAPSHOT ====="
          
          # åœæ­¢ç›¸å…³æœåŠ¡
          sudo systemctl stop docker.service docker.socket 1panel.service || echo "âš ï¸æœåŠ¡æœªè¿è¡Œ"
          sudo systemctl mask docker.socket
          sudo pkill -9 docker 1panel || true
          sync && sleep 3
          
          # éªŒè¯å¿«ç…§æœ‰æ•ˆæ€§
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "âŒå¿«ç…§æ— æ•ˆæˆ–æ— æ³•è¯»å–"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
            exit 1
          fi
          
          # æ¢å¤å¿«ç…§
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --warning=no-all --preserve-permissions --absolute-names $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "âœ…1Panelå¿«ç…§æ¢å¤æˆåŠŸ"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # åˆ é™¤å·²æ¢å¤çš„å¿«ç…§
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt --config /home/runner/.rclone.conf
          else
            echo "âŒ1Panelå¿«ç…§æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          fi
          sudo systemctl unmask docker.socket

      - name: æ¸…ç†1Panelæ®‹ç•™ï¼ˆæ¢å¤å¤±è´¥æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== å½»åº•æ¸…é™¤1Panelæ®‹ç•™ ====="
          # åœæ­¢æœåŠ¡
          sudo systemctl stop 1panel.service docker.service docker.socket || true
          sudo systemctl disable 1panel.service docker.service docker.socket || true
          # æ¸…ç†å®¹å™¨/é•œåƒ/å·
          sudo docker rm -f $(sudo docker ps -aq) || true
          sudo docker rmi -f $(sudo docker images -aq) || true
          sudo docker volume rm -f $(sudo docker volume ls -q) || true
          # åˆ é™¤æ–‡ä»¶ç›®å½•
          sudo rm -rf /opt/1panel /etc/1panel /var/log/1panel /usr/bin/1panel /usr/lib/systemd/system/1panel*
          sudo rm -rf /var/lib/docker /etc/docker /DATA/1panel* /tmp/1panel*
          # å¸è½½ç›¸å…³åŒ…
          sudo apt purge -y 1panel* docker* containerd* runc* || true
          sudo apt autoremove -y && sudo apt clean
          echo "âœ…1Panelæ®‹ç•™å·²æ¸…é™¤"

      - name: å…¨æ–°å®‰è£…1Panelï¼ˆæ¢å¤å¤±è´¥æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== å®‰è£…1Panel ====="
          curl -fsSL https://get.1panel.io | sudo bash - || { echo "âŒ1Panelå®‰è£…å¤±è´¥"; exit 1; }
          # å¯åŠ¨åŸºç¡€æœåŠ¡
          sudo systemctl unmask docker.socket
          sudo systemctl enable --now docker.service docker.socket
          sleep 10
          sudo systemctl enable --now 1panel.service
          sleep 5
          echo "âœ…1Panelå®‰è£…å®Œæˆ"

      - name: é‡å¯1PanelæœåŠ¡ï¼ˆæ¢å¤æˆåŠŸæ—¶æ‰§è¡Œï¼‰
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          sudo systemctl unmask docker.socket
          sudo systemctl daemon-reload
          # å¯åŠ¨Docker
          sudo systemctl enable --now docker.service docker.socket
          sleep 10
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒDockeræœåŠ¡å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          # å¯åŠ¨å¹¶ä¿®å¤1Panel
          if systemctl list-unit-files | grep -q 1panel.service; then
            sudo chmod 755 /usr/bin/1panel
            sudo chown root:root /etc/systemd/system/1panel.service
            sudo systemctl daemon-reload
            sudo systemctl enable --now 1panel.service
            sleep 5
            if ! sudo systemctl is-active --quiet 1panel.service; then
              echo "âš ï¸1Panelå¯åŠ¨å¤±è´¥ï¼Œæ‰§è¡Œä¿®å¤"
              curl -fsSL https://get.1panel.io | sudo bash -s -- --repair
              sudo systemctl enable --now 1panel.service
              sleep 5
            fi
            echo "âœ…1PanelæœåŠ¡é‡å¯æˆåŠŸ"
          else
            echo "âŒæœªæ‰¾åˆ°1PanelæœåŠ¡æ–‡ä»¶"
            exit 1
          fi

      - name: éƒ¨ç½²Tailscale
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ç¼ºå°‘Tailscaleå¯†é’¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ]; then
            echo "âŒTailscaleå®‰è£…å¤±è´¥"
            exit 0
          fi
          if ! sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="1panel-snapshot-${{ github.run_id }}"; then
            echo "âŒTailscaleç™»å½•å¤±è´¥"
            sudo "$TAILSCALE_PATH" status
            exit 0
          fi
          echo "âœ…Tailscale IP: $(sudo "$TAILSCALE_PATH" ip -4)"

      - name: åˆ›å»º1Panelå¿«ç…§å¹¶ä¸Šä¼ WebDAV
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # è§¦å‘å¿«ç…§ç»­è®¢
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒUSER_PATæˆ–REPOä¸ºç©º"
              return 1
            fi
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_1panel_snapshot"}'; then
              echo "âŒè§¦å‘ç»­è®¢å¤±è´¥"
              return 1
            fi
            echo "âœ…ç»­è®¢æµç¨‹è§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true
            return 0
          }
          
          # åˆ›å»ºå¹¶ä¸Šä¼ å¿«ç…§
          create_and_upload_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then return 1; fi
            # éªŒè¯1Panelå…³é”®æ–‡ä»¶
            echo "ğŸ”éªŒè¯1Panelå…³é”®æ–‡ä»¶"
            for file in /etc/systemd/system/1panel.service /usr/bin/1panel /opt/1panel; do
              if [ ! -e "$file" ]; then
                echo "âŒå…³é”®æ–‡ä»¶/ç›®å½•ä¸å­˜åœ¨ï¼š$file"
                exit 1
              fi
            done
            # å®šä¹‰å¿«ç…§ä¿¡æ¯
            SNAPSHOT_NAME="1panel-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„åˆ›å»º1Panelå¿«ç…§ï¼š$SNAPSHOT_NAME"
            # åœæ­¢æœåŠ¡
            sudo systemctl stop 1panel.service docker.service docker.socket || true
            sudo systemctl mask docker.socket
            sudo pkill -9 docker 1panel || true
            sync && sleep 5
            # éå†æ ¸å¿ƒç›®å½•
            for dir in $CORE_DIRS; do
              if [ ! -d "$dir" ] && [ ! -f "$dir" ]; then
                echo "âš ï¸ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ï¼š$dir"
              fi
            done
            # ç”Ÿæˆå¿«ç…§
            sudo tar -czf "${TMP_SNAPSHOT}" --absolute-names --ignore-failed-read --warning=no-all $EXCLUDE_RULES $CORE_DIRS
            sudo chown runner:runner "${TMP_SNAPSHOT}"
            sudo chmod 644 "${TMP_SNAPSHOT}"
            # éªŒè¯å¿«ç…§
            if [ ! -f "${TMP_SNAPSHOT}" ] || [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 1024 ]; then
              echo "âŒå¿«ç…§æ— æ•ˆï¼ˆå¤§å°<1KBï¼‰"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket 1panel.service || true
              return 1
            fi
            echo "âœ…å¿«ç…§åˆ›å»ºæˆåŠŸï¼Œå¤§å°ï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"
            # ä¸Šä¼ å¿«ç…§
            if ! sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" --config /home/runner/.rclone.conf --transfers 4 --log-file /tmp/rclone_upload.log; then
              echo "âŒå¿«ç…§ä¸Šä¼ å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š/tmp/rclone_upload.log"
              cat /tmp/rclone_upload.log || true
              rm -f "${TMP_SNAPSHOT}"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket 1panel.service || true
              return 1
            fi
            echo "âœ…å¿«ç…§ä¸Šä¼ æˆåŠŸï¼š${REMOTE_PATH}"
            # ä¸Šä¼ å…ƒæ•°æ®
            META_FILE="/tmp/snapshot_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
            # é‡å¯æœåŠ¡
            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket 1panel.service || true
            return 0
          }
          
          # å¾ªç¯æ‰§è¡Œå¿«ç…§ä»»åŠ¡
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Šå·¥ä½œæµè¿è¡Œæ—¶é—´ï¼š$run_minsåˆ†é’Ÿ"
            # è¿è¡Œ2åˆ†é’Ÿååˆ›å»ºå¿«ç…§
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â°å¼€å§‹åˆ›å»ºå¹¶ä¸Šä¼ 1Panelå¿«ç…§"
              if create_and_upload_snapshot; then
                trigger_renew
              else
                echo "âŒå¿«ç…§åˆ›å»ºå¤±è´¥ï¼Œè·³è¿‡ç»­è®¢"
              fi
            fi
            # è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œé€€å‡ºå·¥ä½œæµ"
              exit 0
            fi
            sleep 60
          done

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: ${{ always() }}
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          sudo rm -rf /tmp/1panel-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          echo "âœ…ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
