name: CasaOS纯净部署（zstd19高压缩+备份保留2份+自动清理 稳定精简版）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 15
      ZSTD_COMPRESS_OPTS: "-19 --long=31 --rm -T0"
      ZSTD_DECOMPRESS_OPTS: "--long=31 --memory=2048MB"

    steps:
      # ========== 步骤1：系统初始化+全域深度清理（含zstd安装） ==========
      - name: 1-系统初始化+全域深度清理（安装zstd）
        if: ${{ always() }}
        run: |
          set -e
          echo "WORKFLOW_START_TIME=$(date +%s)" >> "$GITHUB_ENV"
          echo "===== 1-系统初始化+全域深度清理 ====="
          sudo apt update -y -qq
          sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg zstd -qq
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          for dir in /usr/local/lib/gh /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n \
                     /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google; do
            [ -e "$dir" ] && sudo rm -rf "$dir" 2>/dev/null || true
          done
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          echo "✅ 系统初始化完成（zstd已安装）"

      # ========== 步骤2：安装最新版 Docker ==========
      - name: 2-官方纯净安装 Docker（含 compose）
        run: |
          set -e
          echo "===== 2-安装 Docker ====="
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "✅ Docker 安装完成"

      # ========== 步骤3：安装最新版 CasaOS ==========
      - name: 3-官方纯净安装 CasaOS
        run: |
          set -e
          echo "===== 3-安装 CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          echo "✅ CasaOS 安装完成，待配置"

      # ========== 步骤4：创建并配置管理员用户（roots） ==========
      - name: 4-创建 roots 管理员+免密&Docker 权限
        run: |
          set -e
          echo "===== 4-配置管理员用户 ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd || {
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "🔑 roots 随机密码：$RANDOM_PASS"
          }
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "✅ 管理员配置完成"

      # ========== 步骤5：WebDAV 备份环境初始化（匹配.tar.zst） ==========
      - name: 5-WebDAV 配置+快照检测（zstd格式）
        run: |
          set -e
          echo "===== 5-WebDAV 环境初始化 ====="
          if [ -z "$WEBDAV_URL$WEBDAV_USER$WEBDAV_PASSWORD" ]; then
            echo "⚠️ WebDAV 未配置，关闭备份"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          rclone mkdir "mywebdav:$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf 2>/dev/null || true
          REMOTE_SNAPSHOTS=$(rclone ls "mywebdav:$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | \
            grep 'casaos-full-snapshot.*\.tar\.zst$' | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "✅ 检测到zstd快照：$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "✅ 无zstd快照，纯净启动"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "✅ WebDAV 初始化完成（zstd格式）"

      # ========== 步骤6：从 WebDAV 恢复历史数据（zstd解压）【核心修复+进度优化】 ==========
      - name: 6-恢复历史快照（zstd解压+路径精准还原）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== 6-恢复历史数据（zstd解压） ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          
          # 🔑 修复1：移除tar命令中错误的$PERSONAL_DATA_DIRS（解包时不应指定目标目录列表）
          # 🔑 修复2：$EXCLUDE_RULES置于tar命令末尾作为过滤规则
          # 🔑 优化：rclone cat添加--stats 5s，每5秒输出下载速度（stderr，不影响管道）
          echo "=== 📥 开始下载快照（5秒刷新速度）==="
          rclone cat "mywebdav:$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" \
            --config /home/runner/.rclone.conf \
            --stats 5s | \
            zstd -dc $ZSTD_DECOMPRESS_OPTS | sudo tar -xPf - -C / --overwrite --preserve-permissions $EXCLUDE_RULES
          echo "=== ✅ 快照下载完成 ==="
          
          # 验证关键目录恢复
          for check_dir in $PERSONAL_DATA_DIRS; do
            if [ ! -d "$check_dir" ] || [ -z "$(ls -A "$check_dir" 2>/dev/null)" ]; then
              echo "❌ 关键目录恢复失败：$check_dir"
              exit 1
            fi
          done
          
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          
          rclone delete "mywebdav:$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "✅ zstd快照恢复完成（高压缩率无损还原），关键目录均验证通过"

      # ========== 步骤7：启动 Docker & CasaOS 服务 ==========
      - name: 7-启动 Docker & CasaOS 核心服务
        run: |
          set -e
          echo "===== 7-启动核心服务 ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "✅ 服务启动完成，CasaOS 可访问"

      # ========== 步骤8：Tailscale 组网（可选） ==========
      - name: 8-Tailscale 组网（可选）
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "⚠️ Tailscale 未配置，跳过"
            exit 0
          fi
          echo "===== 8-Tailscale 组网 ====="
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null)
          echo "✅ Tailscale 组网成功，内网IP：${TAILSCALE_IP:-未获取}"

      # ========== 步骤9：延时校准 ==========
      - name: 9-延时校准（满15分钟再备份）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 9-延时校准（15分钟） ====="
          START_TIME="${WORKFLOW_START_TIME:-$(date +%s)}"
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          TARGET_SEC=$((TARGET_RUN_MINUTES * 60))
          WAIT_SEC=$((TARGET_SEC - ELAPSED))
          if [ $WAIT_SEC -gt 0 ]; then
            echo "⏳ 全流程已运行 ${ELAPSED}s，还需等待 ${WAIT_SEC}s"
            sleep $WAIT_SEC
          else
            echo "⚠️ 已超时 ${ELAPSED}s，跳过等待"
          fi
          echo "✅ 时长校准完成"

      # ========== 步骤10：停止所有服务 ==========
      - name: 10-停止所有服务（备份前置）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 10-停止所有服务 ====="
          sudo systemctl stop casaos docker containerd tailscaled 2>/dev/null || true
          for proc in casaos docker containerd tailscaled; do
            pgrep -x "$proc" &>/dev/null && sudo pkill -9 -x "$proc" 2>/dev/null || true
          done
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sync && sleep 5
          echo "✅ 服务已安全停止"

      # ========== 步骤11：全量备份（zstd19高压缩）【核心修复+进度优化】 ==========
      - name: 11-全量备份（zstd19高压缩）+清旧备份+触发续跑
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 11-核心备份流程（zstd19高压缩） ====="
          full_backup() {
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
            SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
            
            # 🔑 修复：$EXCLUDE_RULES 和 --warning 必须放在 $PERSONAL_DATA_DIRS 之前（tar语法要求）
            sudo tar -cPf - $EXCLUDE_RULES --warning=no-file-changed $PERSONAL_DATA_DIRS | \
              zstd $ZSTD_COMPRESS_OPTS -o "$SNAPSHOT_PATH" || return 1
            
            echo "=== 📤 开始上传备份（5秒刷新速度）==="
            # 🔑 优化：rclone copy 添加 --stats 5s，每5秒输出上传速度+ETA（stderr）
            rclone copy "$SNAPSHOT_PATH" "mywebdav:$WEBDAV_SNAPSHOT_DIR/" \
              --config /home/runner/.rclone.conf \
              --transfers 4 --fast-list --retries 3 \
              --stats 5s || { sudo rm -f "$SNAPSHOT_PATH"; return 1; }
            echo "=== ✅ 上传完成 ==="
            
            # 验证文件大小一致性
            LOCAL_SIZE=$(stat -c%s "$SNAPSHOT_PATH")
            REMOTE_SIZE=$(rclone ls "mywebdav:$WEBDAV_SNAPSHOT_DIR/$SNAPSHOT_NAME" --config /home/runner/.rclone.conf | awk '{print $1}')
            if [ "$LOCAL_SIZE" -ne "$REMOTE_SIZE" ]; then
              echo "❌ 备份上传大小不匹配，本地$LOCAL_SIZE vs 远程$REMOTE_SIZE"
              sudo rm -f "$SNAPSHOT_PATH"
              return 1
            fi
            sudo rm -f "$SNAPSHOT_PATH"
            echo "✅ 备份成功：$SNAPSHOT_NAME (zstd19)，大小：$((LOCAL_SIZE/1024/1024))MB"
            return 0
          }
          full_backup || { echo "⚠️ 首次失败，10分钟后重试"; sleep 600; full_backup; }
          
          # 精准清理旧备份（仅.tar.zst）
          BACKUPS=$(rclone ls "mywebdav:$WEBDAV_SNAPSHOT_DIR" \
            --config /home/runner/.rclone.conf | grep '\.tar\.zst$' | sed 's/^[0-9]\+ //' | sort -r)
          COUNT=$(echo "$BACKUPS" | wc -l)
          if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
            echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS + 1)) | while read -r file; do
              rclone delete "mywebdav:$WEBDAV_SNAPSHOT_DIR/$file" \
                --config /home/runner/.rclone.conf 2>/dev/null || true
              echo "🗑️  删除旧备份：$file"
            done
            echo "✅ 旧备份清理完成，保留最新${KEEP_BACKUPS}份（仅.tar.zst）"
          else
            echo "ℹ️ 当前备份数($COUNT) ≤ 保留数($KEEP_BACKUPS)，无需清理"
          fi
          
          # 触发续跑
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}' 2>/dev/null && \
              echo "✅ 自动续跑已触发" || echo "⚠️ 续跑触发失败（不影响备份）"
          fi
          echo "✅ 备份全流程完成（zstd19高压缩率）"

      # ========== 步骤12：敏感信息清理 ==========
      - name: 12-敏感清理+流程完结
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 12-清理+完结 ====="
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "✅ 敏感信息清理完成"
          echo "🎉 CasaOS 部署+备份全流程 100% 完成（zstd19高压缩）"
          echo "🔚 服务保持停止，等待下一次调度"
