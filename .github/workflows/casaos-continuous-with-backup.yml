name: CasaOS纯净部署（Tailscale内网版 /aaa目录 拉取即删 检测删除）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"
      TARGET_RUN_MINUTES: 1
      MAX_POLL_TIMES: 60
      RETRY_TIMES: 3

    steps:
      - name: 1-系统初始化+全域深度清理
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 1-系统初始化+全域深度清理 ====="
          sudo apt update -y -qq
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server -qq
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          sudo systemctl enable --now ssh
          echo "✅ 系统初始化+深度清理完成"

      - name: 2-官方纯净安装 Docker
        run: |
          set -e
          echo "===== 2-安装 Docker（官方源） ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash
          sudo systemctl enable docker containerd
          sudo systemctl stop docker containerd 2>/dev/null || true
          docker --version || true
          sudo usermod -aG docker runner
          echo "✅ Docker 安装完成，已停止服务"

      - name: 3-官方纯净安装 CasaOS
        run: |
          set -e
          echo "===== 3-安装 CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          echo "✅ CasaOS 安装完成，已停止服务"

      - name: 4-创建 roots 管理员+SSH密码登录
        run: |
          set -e
          echo "===== 4-配置管理员用户 roots ====="
          if [ -z "$SSH_PASS" ]; then
            echo "❌ 错误：ROOTS_PASSWORD 未配置"
            exit 1
          fi
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          echo "$USER_NAME:$SSH_PASS" | sudo chpasswd
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config 2>/dev/null
          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null
          sudo systemctl restart ssh
          echo "✅ 管理员用户 & SSH 密码登录配置完成"

      - name: 5-Tailscale 组网+上线+显示本机IP地址
        run: |
          set -e
          echo "===== 5-Tailscale组网 + 显示本机信息 ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "⚠️ Tailscale 未配置，跳过组网"
            exit 0
          fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq
          sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2

          TS_SUFFIX=$((RANDOM % 10))
          TS_HOSTNAME="CasaOS-${TS_SUFFIX}"
          echo "🔖 本次 Tailscale 主机名：${TS_HOSTNAME}"

          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --accept-routes

          echo -e "\n=== 🖥️ 本机 IP 信息 ==="
          LOCAL_IP=$(hostname -I | awk '{print $1}')
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "获取失败")
          echo "✅ 物理内网IP: $LOCAL_IP"
          echo "✅ Tailscale内网IP: $TAILSCALE_IP"
          echo "==================================="
          echo "✅ Tailscale 组网上线完成"

      - name: 6-从内网/aaa拉备份→删远程→本地恢复
        run: |
          set -e
          echo "===== 6-拉取备份并恢复（Tailscale 在线节点） ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "ℹ️ Tailscale 未配置，纯净启动"
            exit 0
          fi
          if [ -z "$SSH_PASS" ]; then
            echo "❌ 错误：SSH_PASS 未配置"
            exit 1
          fi

          TS_STATUS_JSON=$(sudo tailscale status --json)
          SELF_ID=$(echo "$TS_STATUS_JSON" | jq -r '.Self.ID')
          SELF_HOSTNAME=$(echo "$TS_STATUS_JSON" | jq -r '.Self.HostName')
          echo "ℹ️ 本机 Tailscale ID: $SELF_ID"
          echo "ℹ️ 本机 Tailscale 主机名: $SELF_HOSTNAME"

          echo -e "\n🔍 筛选在线 CasaOS 节点"
          TARGET_LIST=$(echo "$TS_STATUS_JSON" | jq -r --arg self "$SELF_ID" '
            .Peer[] | 
            select(
              .Online == true and
              .HostName != null and
              (.HostName | tostring) | contains("CasaOS") and
              .ID != $self
            ) |
            "\(.HostName)|\(.TailscaleIPs[0])"
          ' || true)

          if [ -z "$TARGET_LIST" ]; then
            echo "ℹ️ 未找到在线 CasaOS 节点，纯净启动"
            exit 0
          fi

          echo -e "\n📋 可用节点："
          echo "$TARGET_LIST" | while IFS='|' read -r h ip; do
            echo "  - $h | $ip"
          done

          TARGET_LINE=$(echo "$TARGET_LIST" | head -1)
          TARGET_HOST=$(echo "$TARGET_LINE" | cut -d'|' -f1)
          TARGET_IP=$(echo "$TARGET_LINE" | cut -d'|' -f2)
          echo -e "\n🎯 目标节点：$TARGET_HOST ($TARGET_IP)"

          echo -e "\n🛑 停止相关服务"
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 "casaos" "docker" "containerd" 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sync && sleep 2

          echo -e "\n📂 获取远程最新备份"
          LATEST_FILE=""
          for ((i=1; i<=RETRY_TIMES; i++)); do
            echo "第 $i 次尝试获取备份文件..."
            LATEST_FILE=$(sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              "$SSH_USER@$TARGET_IP" "ls -t \"$REMOTE_BACKUP_BASE\"/casaos-*.tar.gz 2>/dev/null | head -1")
            [ -n "$LATEST_FILE" ] && break
            sleep 3
          done

          if [ -z "$LATEST_FILE" ]; then
            echo "ℹ️ 无备份，纯净启动"
            exit 0
          fi
          echo "✅ 找到备份：$LATEST_FILE"

          sudo mkdir -p "$LOCAL_BACKUP_DIR"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$(basename "$LATEST_FILE")"
          echo -e "\n⬇️ 拉取备份：$LOCAL_FILE"
          for ((i=1; i<=RETRY_TIMES; i++)); do
            echo "第 $i 次尝试拉取..."
            sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
              "$SSH_USER@$TARGET_IP:$LATEST_FILE" "$LOCAL_FILE" && break
            sleep 3
          done

          echo -e "\n🗑️ 拉取即删：删除远程源文件"
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            "$SSH_USER@$TARGET_IP" "rm -f '$LATEST_FILE'" || true

          echo -e "\n🔧 解压恢复"
          sudo tar -xzf "$LOCAL_FILE" -C / --overwrite --preserve-permissions
          for dir in $PERSONAL_DATA_DIRS; do
            [ -d "$dir" ] && sudo chown -R root:root "$dir"
          done
          [ -d "/etc/casaos" ]     && sudo chmod -R 755 /etc/casaos
          [ -d "/DATA" ]           && sudo chmod -R 755 /DATA
          [ -d "/root/.config" ]   && sudo chmod -R 755 /root/.config
          [ -d "/var/lib/casaos" ] && sudo chmod -R 700 /var/lib/casaos
          [ -d "/var/lib/docker" ] && sudo chmod -R 700 /var/lib/docker
          echo "✅ 恢复与权限校正完成"

      - name: 7-启动 Docker & CasaOS
        run: |
          set -e
          echo "===== 7-启动核心服务 ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "✅ Docker & CasaOS 启动完成"

      - name: 8-稳定运行指定分钟
        run: |
          set -e
          echo "===== 8-稳定运行 $TARGET_RUN_MINUTES 分钟 ====="
          sleep $((TARGET_RUN_MINUTES * 60))
          echo "✅ 稳定运行完成"

      # ====================== 【这里是修复后的步骤9】 ======================
      - name: 9-停止所有服务（安全备份，保留Tailscale组网）
        run: |
          set -e
          echo "===== 9-停止业务服务（安全备份，保留Tailscale在线） ====="
          # 只停止会占用数据目录的服务：casaos、docker、containerd
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sudo pkill -9 "casaos" "docker" "containerd" 2>/dev/null || true
          
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sudo umount /var/lib/docker/overlay2/*/merged 2>/dev/null || true
          sync && sleep 5
          echo "✅ 业务服务已停止，Tailscale保持在线，可安全备份"
      # ====================================================================

      - name: 10-本地全量备份
        run: |
          set -e
          echo "===== 10-生成本地全量备份 ====="
          sudo mkdir -p "$LOCAL_BACKUP_DIR"
          IFS=' ' read -r -a DIR_ARRAY <<< "$PERSONAL_DATA_DIRS"
          for dir in "${DIR_ARRAY[@]}"; do
            [ ! -d "$dir" ] && { echo "⚠️ 创建 $dir"; sudo mkdir -p "$dir"; }
          done

          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.gz"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$SNAP_NAME"
          sudo tar -cz \
            --ignore-failed-read \
            --exclude='*.log' --exclude='*.tmp' --exclude='*.cache' \
            --exclude='/var/lib/docker/tmp' \
            --exclude='/var/lib/docker/containers/*/*.log' \
            --exclude='/var/lib/docker/overlay2/*/tmp' \
            --exclude='/DATA/tmp' --exclude='/DATA/cache' --exclude='/DATA/logs' \
            -f "$LOCAL_FILE" "${DIR_ARRAY[@]}"

          if [ -f "$LOCAL_FILE" ] && [ -s "$LOCAL_FILE" ]; then
            echo "✅ 备份完成：$SNAP_NAME"
            echo "BACKUP_FILE=$LOCAL_FILE" >> $GITHUB_ENV
            echo "SNAP_NAME=$SNAP_NAME" >> $GITHUB_ENV
          else
            echo "❌ 备份失败"
            exit 1
          fi

      - name: 11-触发下一轮续跑
        run: |
          set -e
          echo "===== 11-触发下一轮 ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
            echo "⚠️ 未配置 PAT/REPO，跳过"
            exit 0
          fi
          curl -s -f -X POST \
            -H "Authorization: token $USER_PAT" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"renew_casaos_snapshot"}' >/dev/null 2>&1
          [ $? -eq 0 ] && echo "✅ 续跑触发成功" || echo "⚠️ 续跑触发失败"

      - name: 12-移入/aaa并轮询删除
        run: |
          set -e
          echo "===== 12-备份移入 /aaa + 等待删除 ====="
          if [ -z "$BACKUP_FILE" ] || [ -z "$SNAP_NAME" ]; then
            echo "ℹ️ 无备份，跳过"
            exit 0
          fi

          LOCAL_AAA="/aaa"
          sudo mkdir -p "$LOCAL_AAA"
          TARGET_FILE="$LOCAL_AAA/$SNAP_NAME"
          sudo mv -v "$BACKUP_FILE" "$TARGET_FILE"

          echo -e "\n⌛ 每30秒检查是否被删除（最多 $MAX_POLL_TIMES 次）"
          poll_count=0
          while [ $poll_count -lt $MAX_POLL_TIMES ]; do
            if [ ! -f "$TARGET_FILE" ]; then
              echo "🎉 文件已删除"
              break
            fi
            poll_count=$((poll_count + 1))
            echo "→ 第 $poll_count/$MAX_POLL_TIMES 次，等待30秒..."
            sleep 30
          done

          if [ $poll_count -ge $MAX_POLL_TIMES ]; then
            echo "⚠️ 达到最大轮询次数，自动退出"
          fi
          echo "✅ 步骤12 完成"

      - name: 13-最终清理
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 13-最终清理 ====="
          sudo rm -rf "$LOCAL_BACKUP_DIR" /tmp/* 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "✅ 清理完成"
          echo "🎉 全流程正常结束"