name: å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½æ¢å¤
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_full_env_snapshot]

jobs:
  full_user_env_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      BACKUP_ROOT: "/"
      # ä»…æ’é™¤æ—¥å¿—/ä¸´æ—¶åƒåœ¾æ–‡ä»¶ï¼Œæ— ä»»ä½•å…¶ä»–æ’é™¤ï¼Œä¸ä¸¢ä»»ä½•æ•°æ®
      EXCLUDE_RULES: "--exclude=/tmp/* --exclude=/var/tmp/* --exclude=/var/log/* --exclude=/var/cache/apt/archives/* --exclude=*.log --exclude=*.log.* --exclude=*.tmp --exclude=*.swp --exclude=*.bak --exclude=/DATA/tmp/* --exclude=/DATA/cache/* --exclude=/DATA/logs/*"
      # æ ¸å¿ƒç”¨æˆ·æ•°æ®æ ‡è®°ï¼Œå…¨é‡å¤‡ä»½è‡ªåŠ¨åŒ…å«æ‰€æœ‰ç›®å½•
      USER_DATA_MARK: "FULL_USER_ENV_BACKUP_MARK"
      USER_DATA_MARK_FILE: "/root/${USER_DATA_MARK}.flag"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true
      BACKUP_DELAY_SEC: 300

    steps:
      - name: 1. ç¯å¢ƒåˆå§‹åŒ–ï¼ˆLocale+Rclone+åŸºç¡€ä¾èµ–ï¼‰
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl rsync ca-certificates apt-transport-https
          # ç¨³å®šLocaleï¼Œæœç»ä¹±ç 
          sudo locale-gen en_US.UTF-8
          sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          export LC_CTYPE=en_US.UTF-8
          
          # å®˜æ–¹å®‰è£…Rcloneï¼Œå…œåº•ä¿éšœ
          sudo -v ; curl https://rclone.org/install.sh | sudo bash -s -- -q
          if ! command -v rclone &>/dev/null; then
            wget -q https://downloads.rclone.org/rclone-current-linux-amd64.zip -O /tmp/rclone.zip
            unzip -q /tmp/rclone.zip -d /tmp && sudo cp /tmp/rclone-*/rclone /usr/bin/ && sudo chmod +x /usr/bin/rclone
            rm -rf /tmp/rclone.zip /tmp/rclone-*
          fi
          echo "âœ… Rcloneå®‰è£…å®Œæˆï¼š$(rclone --version | head -n1)"
          
          # æƒé™é…ç½®+ç›®å½•å‡†å¤‡
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner >/dev/null && sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºç®¡ç†å‘˜+æ ¸å¿ƒæ•°æ®æ ‡è®°æ–‡ä»¶
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          # åˆ›å»ºrootsç®¡ç†å‘˜ï¼Œæˆæƒsudo+docker
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… rootséšæœºå¯†ç ï¼š$RANDOM_PASS"
            fi
            sudo usermod -aG sudo,docker roots
          fi
          # åˆ›å»ºæ ¸å¿ƒæ ‡è®°æ–‡ä»¶ï¼Œå¤‡ä»½æ¢å¤å¿…éªŒï¼Œç¡®ä¿å…¨é‡å®Œæ•´
          sudo touch ${USER_DATA_MARK_FILE}
          sudo chmod 600 ${USER_DATA_MARK_FILE}
          echo "å…¨é‡å¤‡ä»½æ—¶é—´:$(date +%F_%T) | å…¨é‡ç”¨æˆ·ç¯å¢ƒå®Œæ•´å¤‡ä»½" | sudo tee ${USER_DATA_MARK_FILE} >/dev/null
          echo "âœ… ç®¡ç†å‘˜åˆ›å»ºå®Œæˆï¼Œæ ¸å¿ƒæ ‡è®°æ–‡ä»¶ç”Ÿæˆï¼š${USER_DATA_MARK_FILE}"

      - name: 3. Rclone WebDAVé…ç½®+è¿é€šæ€§+å¿«ç…§æ£€ç´¢
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          # å‡­è¯æ ¡éªŒï¼Œç¼ºå¤±ç›´æ¥è·³è¿‡
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # é…ç½®WebDAVï¼Œå¯†ç åŠ å¯†å­˜å‚¨
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="other" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf --non-interactive
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          # è¿é€šæ€§åŒé‡æ ¡éªŒï¼Œç¡®ä¿å¯ç”¨
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            sleep 3
            if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
              echo "âŒ WebDAVè¿æ¥å¤±è´¥"
              echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
              exit 0
            fi
          fi
          # åˆ›å»ºå¤‡ä»½ç›®å½•ï¼Œæ£€ç´¢æœ€æ–°å…¨é‡å¿«ç…§
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf 2>/dev/null
          REMOTE_SNAPSHOTS=$(rclone lsf mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --mode=time --reverse --config /home/runner/.rclone.conf | grep -E "^full-user-env-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz$")
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(echo "$REMOTE_SNAPSHOTS" | head -n1 | xargs)
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å…¨é‡å¤‡ä»½ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æ— å†å²å…¨é‡å¤‡ä»½ï¼Œå°†éƒ¨ç½²çº¯å‡€ç³»ç»Ÿ+åŸºç¡€ä¾èµ–"
          fi
          echo "âœ… WebDAVé…ç½®å®Œæˆ"

      - name: 4. å…¨é‡æ¢å¤ç”¨æˆ·ç¯å¢ƒï¼ˆæ— å·®åˆ«å®Œæ•´è¿˜åŸï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== å¼€å§‹å…¨é‡æ¢å¤ç”¨æˆ·ç¯å¢ƒï¼ˆå®Œæ•´è¿˜åŸæ‰€æœ‰æ•°æ®ï¼‰ ====="
          # å¼ºåˆ¶åœæœ+æ•°æ®è½ç›˜ï¼Œé¿å…æ–‡ä»¶å ç”¨å†²çª
          sudo systemctl stop $(systemctl list-unit-files --type=service --state=enabled | grep -v "loaded" | awk '{print $1}') 2>/dev/null || true
          sudo pkill -9 docker 2>/dev/null || true
          sudo sync && sleep 5
          echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®è½ç›˜å®Œæˆ"
          
          # å¿«ç…§å®Œæ•´æ€§æ ¡éªŒï¼Œæœç»æŸåæ–‡ä»¶æ¢å¤
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåï¼Œæ¢å¤ç»ˆæ­¢"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi
          
          # æ ¸å¿ƒæ¢å¤ï¼šæ ¹ç›®å½•æ— å·®åˆ«è¦†ç›–ï¼Œä»…è¿‡æ»¤åƒåœ¾æ–‡ä»¶ï¼Œå®Œæ•´è¿˜åŸæ‰€æœ‰æ•°æ®
          echo "ğŸ”„ è§£å‹å…¨é‡å¿«ç…§ï¼Œå®Œæ•´è¿˜åŸæ‰€æœ‰ç”¨æˆ·æ•°æ®"
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / \
            --overwrite --preserve-permissions --preserve-links --preserve-time --preserve-owner \
            --warning=no-file-changed --no-ignore-failed-read \
            $EXCLUDE_RULES
          if [ $? -ne 0 ]; then
            echo "âŒ å¿«ç…§è§£å‹å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi
          
          # æ ¸å¿ƒæ ¡éªŒï¼šæ ‡è®°æ–‡ä»¶å­˜åœ¨å³ä»£è¡¨æ•°æ®å®Œæ•´
          if [ ! -f ${USER_DATA_MARK_FILE} ]; then
            echo "âŒ æ ¸å¿ƒæ ‡è®°æ–‡ä»¶ç¼ºå¤±ï¼Œæ¢å¤ä¸å®Œæ•´"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi
          # æƒé™ä¿®å¤å…œåº•ï¼Œç¡®ä¿æœåŠ¡æ­£å¸¸å¯åŠ¨
          sudo chown -R root:root / /etc /usr /bin /sbin /lib /lib64
          sudo chown -R root:docker /var/lib/docker /etc/docker
          sudo chown -R roots:roots /home/roots /root
          sudo chmod -R 755 /usr/bin /usr/sbin /bin /sbin
          sudo systemctl daemon-reload && sudo sync && sleep 3
          
          # åˆ é™¤å·²æ¢å¤æ—§å¿«ç…§ï¼Œé‡Šæ”¾äº‘ç«¯ç©ºé—´
          if rclone ls mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/full-user-env-meta.txt --config /home/runner/.rclone.conf
            echo "âœ… æ—§å¿«ç…§åŠå…ƒæ•°æ®å·²åˆ é™¤"
          fi
          
          echo "âœ… å…¨é‡ç”¨æˆ·ç¯å¢ƒæ¢å¤å®Œæˆï¼Œæ‰€æœ‰æ•°æ®1:1è¿˜åŸ"
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"

      - name: 5. çº¯å‡€ç³»ç»Ÿå…œåº•éƒ¨ç½²ï¼ˆæ— å¤‡ä»½æ—¶è‡ªåŠ¨å®‰è£…ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set +e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== çº¯å‡€ç³»ç»Ÿéƒ¨ç½²åŸºç¡€ä¾èµ–ï¼ˆé€‚é…å…¨é‡å¤‡ä»½ï¼‰ ====="
          # çº¯å‡€ç³»ç»Ÿåˆå§‹åŒ–ï¼Œæ¸…ç†å†—ä½™
          sudo systemctl reset-failed 2>/dev/null || true
          sudo apt autoremove -y 2>/dev/null || true
          # é¢„è£…æ ¸å¿ƒä¾èµ–ï¼Œæ”¯æŒæ‰€æœ‰è½¯ä»¶å®‰è£…è¿è¡Œ
          sudo apt install -y fuse3 libssl-dev libcurl4-openssl-dev ca-certificates apt-transport-https rsync git wget curl jq
          # å®‰è£…Dockeræ ¸å¿ƒå¥—ä»¶ï¼ŒåŸºç¡€å¿…å¤‡
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          sudo apt update -y && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
          # Dockerå¯åŠ¨ä¸‰é‡æ ¡éªŒï¼Œç¡®ä¿å¯ç”¨
          INSTALL_SUCCESS=false
          for i in 1 3; do
            sudo systemctl enable --now docker && sleep 5
            if command -v docker &>/dev/null && sudo systemctl is-active --quiet docker && sudo docker info >/dev/null 2>&1; then
              INSTALL_SUCCESS=true
              break
            fi
            sudo apt reinstall -y docker-ce docker-ce-cli containerd.io -y
          done
          if [ "$INSTALL_SUCCESS" = "false" ]; then
            echo "âŒ Dockerå®‰è£…å¤±è´¥"
            exit 1
          fi
          # åˆ›å»ºæ ¸å¿ƒæ ‡è®°æ–‡ä»¶ï¼Œè¡”æ¥åç»­å…¨é‡å¤‡ä»½
          sudo touch ${USER_DATA_MARK_FILE}
          echo "å…¨é‡å¤‡ä»½æ—¶é—´:$(date +%F_%T) | çº¯å‡€ç³»ç»ŸåŸºç¡€ç¯å¢ƒ" | sudo tee ${USER_DATA_MARK_FILE} >/dev/null
          sudo systemctl daemon-reload
          echo "âœ… çº¯å‡€ç³»ç»Ÿ+åŸºç¡€ä¾èµ–éƒ¨ç½²å®Œæˆ"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          exit 0

      - name: 6. å¯åŠ¨æ‰€æœ‰æœåŠ¡+å®Œæ•´æ€§æ ¡éªŒ
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== å¯åŠ¨æ‰€æœ‰æœåŠ¡+å®Œæ•´æ€§æ ¡éªŒ ====="
          # Dockerä¼˜å…ˆå¯åŠ¨ï¼Œå¤šé‡åŠ å›º
          for i in 1 5; do
            sudo systemctl enable --now docker && sleep 8
            if sudo systemctl is-active --quiet docker && sudo docker info >/dev/null 2>&1; then
              echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            sudo systemctl reset-failed docker && sudo apt reinstall -y docker-ce docker-ce-cli containerd.io -y
          done
          # å¯åŠ¨æ‰€æœ‰å·²å®‰è£…æœåŠ¡ï¼Œå®Œæ•´è¿˜åŸè¿è¡ŒçŠ¶æ€
          sudo systemctl start $(systemctl list-unit-files --type=service --state=enabled | grep -v "loaded" | awk '{print $1}') 2>/dev/null || true
          # åŠŸèƒ½æ ¡éªŒï¼Œç¡®ä¿ç¯å¢ƒå¯ç”¨
          sleep 5
          if sudo docker run --rm hello-world >/dev/null 2>&1; then
            echo "âœ… DockeråŠŸèƒ½æ­£å¸¸"
          else
            echo "âŒ DockeråŠŸèƒ½å¼‚å¸¸ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          # è¾“å‡ºæœåŠ¡å™¨IPï¼Œä¾¿äºè®¿é—®
          SERVER_IP=$(hostname -I | awk '{print $1}' | head -n1)
          echo "âœ… å…¨é‡æœåŠ¡å¯åŠ¨å®Œæˆï¼ŒæœåŠ¡å™¨IPï¼š${SERVER_IP}"
          echo "SERVER_IP=${SERVER_IP}" >> "$GITHUB_ENV"

      - name: 7. éƒ¨ç½²Tailscaleï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          # å®‰è£…Tailscaleï¼Œå†…ç½‘è®¿é—®å¿…å¤‡
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          if [ -z "$(which tailscale)" ]; then
            echo "âŒ Tailscaleå®‰è£…å¤±è´¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          # å¯åŠ¨å¹¶é…ç½®Tailscale
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --accept-dns --hostname="full-env-server-${{ github.run_id }}" --advertise-exit-node=false
          sleep 3
          TAILSCALE_IP=$(sudo tailscale ip -4 | head -n1)
          if [ -n "$TAILSCALE_IP" ]; then
            echo "âœ… Tailscaleéƒ¨ç½²å®Œæˆï¼Œå†…ç½‘IPï¼š${TAILSCALE_IP}"
          else
            echo "âš ï¸ Tailscaleéƒ¨ç½²æˆåŠŸï¼Œæœªè·å–å†…ç½‘IP"
          fi

      - name: 8. å»¶æ—¶ç¨³å®š+Tarå…¨é‡å¤‡ä»½ï¼ˆæ ¸å¿ƒå¤‡ä»½æ­¥éª¤ï¼‰
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== å»¶æ—¶ç­‰å¾…æœåŠ¡ç¨³å®šï¼Œå‡†å¤‡å…¨é‡å¤‡ä»½ ====="
          # 5åˆ†é’Ÿå»¶æ—¶å€’è®¡æ—¶ï¼Œç¡®ä¿æœåŠ¡+æ•°æ®å®Œå…¨ç¨³å®šï¼Œå¤‡ä»½æ— è„æ•°æ®
          countdown=$BACKUP_DELAY_SEC
          while [ $countdown -gt 0 ]; do
            echo "å‰©ä½™ç­‰å¾…æ—¶é—´ï¼š${countdown}ç§’"
            sleep 10
            countdown=$((countdown - 10))
          done
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘è§¦å‘å‡½æ•°ï¼Œé˜²æ­¢GitHub Actionsè¶…æ—¶ä¸­æ–­å¤‡ä»½
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              return 1
            fi
            if [ "$RENEW_TRIGGERED" = "true" ]; then
              return 0
            fi
            if curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_full_env_snapshot"}'; then
              echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
              RENEW_TRIGGERED=true
            else
              echo "âŒ ç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥"
            fi
          }

          # æ ¸å¿ƒï¼šTarå…¨é‡æ‰“åŒ…å‡½æ•°ï¼Œä»…æ»¤åƒåœ¾ï¼Œå…¨é‡å¤‡ä»½æ‰€æœ‰æ•°æ®
          full_backup_full_user_env() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAVä¸å¯ç”¨ï¼Œæ‹’ç»å¤‡ä»½"
              return 1
            fi
            # å¤‡ä»½å‰æ ¡éªŒï¼šæ ¸å¿ƒæ ‡è®°æ–‡ä»¶å­˜åœ¨å³ç¯å¢ƒå®Œæ•´
            if [ ! -f ${USER_DATA_MARK_FILE} ]; then
              echo "âŒ æ ¸å¿ƒæ ‡è®°æ–‡ä»¶ç¼ºå¤±ï¼Œç¯å¢ƒä¸å®Œæ•´ï¼Œæ‹’ç»å¤‡ä»½"
              exit 1
            fi
            echo "âœ… å¤‡ä»½å‰æ ¡éªŒé€šè¿‡ï¼Œå¼€å§‹å…¨é‡Taræ‰“åŒ…"

            # å¿«ç…§å‘½åè§„èŒƒï¼Œå¸¦æ—¶é—´æˆ³ï¼Œç‰ˆæœ¬æ¸…æ™°
            SNAPSHOT_NAME="full-user-env-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"

            # åœæœè½ç›˜ï¼Œä¿è¯å¤‡ä»½æ•°æ®ä¸€è‡´æ€§ï¼Œæ— è„æ•°æ®
            echo "ğŸ”§ åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Œæ•°æ®è½ç›˜"
            sudo systemctl stop $(systemctl list-unit-files --type=service --state=enabled | grep -v "loaded" | awk '{print $1}') 2>/dev/null || true
            sudo pkill -9 docker 2>/dev/null || true
            sudo sync && sleep 5
            echo "âœ… æœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®è½ç›˜å®Œæˆ"

            # Tarå…¨é‡æ‰“åŒ…ï¼šé«˜å‹ç¼©ç‡+å®Œæ•´ä¿ç•™æ‰€æœ‰å±æ€§ï¼Œä»…æ’é™¤åƒåœ¾æ–‡ä»¶
            echo "ğŸ”„ å¼€å§‹Tarå…¨é‡æ‰“åŒ…ï¼ˆgzipå‹ç¼©ï¼Œä¿ç•™æƒé™/é“¾æ¥/å±ä¸»/æ—¶é—´æˆ³ï¼‰"
            sudo tar -c6zf "${TMP_SNAPSHOT}" \
              --preserve-permissions --preserve-links --preserve-time --preserve-owner \
              --ignore-failed-read --warning=no-all \
              $EXCLUDE_RULES \
              ${BACKUP_ROOT}
            if [ $? -ne 0 ]; then
              echo "âŒ Tarå…¨é‡æ‰“åŒ…å¤±è´¥"
              sudo systemctl start docker
              return 1
            fi

            # æ‰“åŒ…å®Œæˆç«‹å³é‡å¯æœåŠ¡ï¼Œå‡å°‘ä¸šåŠ¡ä¸­æ–­æ—¶é—´
            echo "ğŸ”§ å…¨é‡æ‰“åŒ…å®Œæˆï¼Œç«‹å³é‡å¯æ‰€æœ‰æœåŠ¡"
            sudo systemctl start docker && sudo systemctl start $(systemctl list-unit-files --type=service --state=enabled | grep -v "loaded" | awk '{print $1}') 2>/dev/null || true
            sleep 8
            if sudo systemctl is-active --quiet docker; then
              echo "âœ… æ‰€æœ‰æœåŠ¡é‡å¯æˆåŠŸï¼Œä¸šåŠ¡æ¢å¤æ­£å¸¸"
            else
              echo "âš ï¸ æœåŠ¡é‡å¯å¼‚å¸¸ï¼Œå¤‡ä»½æµç¨‹æ­£å¸¸ç»§ç»­"
            fi

            # å¿«ç…§ä¸‰é‡æ ¡éªŒï¼šå­˜åœ¨æ€§+å¤§å°+æ ¸å¿ƒæ ‡è®°ï¼Œç¡®ä¿å¤‡ä»½æœ‰æ•ˆ
            if [ ! -f "${TMP_SNAPSHOT}" ]; then
              echo "âŒ å…¨é‡å¿«ç…§æ–‡ä»¶æœªç”Ÿæˆ"
              return 1
            fi
            SNAPSHOT_SIZE=$(stat -c%s "${TMP_SNAPSHOT}")
            if [ $SNAPSHOT_SIZE -lt 104857600 ]; then
              echo "âŒ å¿«ç…§æ–‡ä»¶å°äº100MBï¼Œåˆ¤å®šä¸ºæ®‹ç¼ºå¤‡ä»½"
              return 1
            fi
            if tar -tzf "${TMP_SNAPSHOT}" | grep -q "${USER_DATA_MARK_FILE}"; then
              echo "âœ… å¿«ç…§æ–‡ä»¶åŒ…å«æ ¸å¿ƒæ ‡è®°ï¼Œå¤‡ä»½å®Œæ•´æœ‰æ•ˆ"
            else
              echo "âŒ å¿«ç…§æ–‡ä»¶ç¼ºå¤±æ ¸å¿ƒæ ‡è®°ï¼Œå¤‡ä»½æ— æ•ˆ"
              return 1
            fi
            echo "âœ… Tarå…¨é‡æ‰“åŒ…å®Œæˆï¼Œå‹ç¼©åå¤§å°ï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')ï¼Œå‹ç¼©ç‡40%-55%"

            # å¤šçº¿ç¨‹ä¸Šä¼ WebDAVï¼Œæé€Ÿ+é‡è¯•åŠ å›ºï¼Œç¡®ä¿ä¸Šä¼ æˆåŠŸ
            echo "ğŸ”„ ä¸Šä¼ å…¨é‡å¿«ç…§åˆ°WebDAVäº‘ç«¯å­˜å‚¨"
            sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 8 --checkers 16 --fast-list --retries 5 --low-level-retries 10 \
              --ignore-existing --progress --log-level INFO
            if [ $? -ne 0 ]; then
              echo "âŒ å…¨é‡å¿«ç…§ä¸Šä¼ å¤±è´¥"
              return 1
            fi
            echo "âœ… å…¨é‡å¿«ç…§ä¸Šä¼ æˆåŠŸï¼Œå­˜å‚¨è·¯å¾„ï¼š${REMOTE_PATH}"

            # ç”Ÿæˆæ ¸å¿ƒå…ƒæ•°æ®æ–‡ä»¶ï¼Œè®°å½•å¤‡ä»½å…³é”®ä¿¡æ¯
            META_FILE="/tmp/full-user-env-meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%F_%T)" >> "${META_FILE}"
            echo "file_size_bytes=${SNAPSHOT_SIZE}" >> "${META_FILE}"
            echo "file_size_human=$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')" >> "${META_FILE}"
            echo "server_ip=${SERVER_IP}" >> "${META_FILE}"
            echo "backup_mark=${USER_DATA_MARK}" >> "${META_FILE}"
            # ä¸Šä¼ å…ƒæ•°æ®ï¼Œä¾¿äºåç»­ç®¡ç†
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/full-user-env-meta.txt" --config /home/runner/.rclone.conf --overwrite
            echo "âœ… å¤‡ä»½å…ƒæ•°æ®æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

            # æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼Œé‡Šæ”¾æœåŠ¡å™¨ç£ç›˜ç©ºé—´
            sudo rm -rf "${TMP_SNAPSHOT}" "${META_FILE}"
            echo "âœ… æœ¬åœ°ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
            return 0
          }

          # æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼Œå¤±è´¥åˆ™ç»ˆæ­¢æµç¨‹
          if ! full_backup_full_user_env; then
            echo "âŒ å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½å¤±è´¥ï¼Œæµç¨‹ç»ˆæ­¢"
            exit 1
          fi

          # è¶…æ—¶åˆ¤æ–­ï¼Œå‰©ä½™æ—¶é—´ä¸è¶³åˆ™è§¦å‘ç»­è·‘
          current_time=$(date +%s)
          elapsed_minutes=$(( (current_time - start_time) / 60 ))
          remaining_minutes=$(( MAX_RUN_MINUTES - elapsed_minutes - 15 ))
          echo "ğŸ“Š å…¨é‡å¤‡ä»½è€—æ—¶ï¼š${elapsed_minutes}åˆ†é’Ÿï¼Œå‰©ä½™è¿è¡Œæ—¶é—´ï¼š${remaining_minutes}åˆ†é’Ÿ"
          if [ $remaining_minutes -lt 30 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
            echo "âš ï¸ å‰©ä½™è¿è¡Œæ—¶é—´ä¸è¶³30åˆ†é’Ÿï¼Œè§¦å‘ç»­è·‘å·¥ä½œæµ"
            trigger_renew
          fi

          echo "===== å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½å®Œæˆï¼Œæ‰€æœ‰æ•°æ®å®Œæ•´ç•™å­˜äº‘ç«¯ ====="
