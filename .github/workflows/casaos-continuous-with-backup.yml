name: CasaOS-完整备份恢复迁移（含根用户+组网）

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-full-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu/CasaOS-Backup"
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /usr/lib/systemd/system/docker.service /etc/systemd/system/docker.service.d /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/local/bin/casaos /usr/lib/systemd/system/casaos.service /etc/systemd/system/casaos.service /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=/var/lib/docker/volumes/*/_data/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-系统初始化&依赖全量安装（零报错版）
        run: |
          set -e
          echo "===== 系统初始化，安装核心依赖 ====="
          # 快速更新，跳过不必要交互
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          # 安装必备依赖，精简无冗余
          sudo apt install -y curl wget jq fuse3 tar gzip bzip2 locales openssl ca-certificates apt-transport-https sshpass net-tools iputils-ping -qq
          
          # 彻底修复locale编码问题，无警告
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8 LC_CTYPE=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_CTYPE=zh_CN.UTF-8
          echo "✅ 中文编码配置完成，无警告"
          
          # Rclone安装：官方标准命令+双重兜底，必成功
          echo "===== 安装Rclone ====="
          if ! command -v rclone &>/dev/null; then
            INSTALL_RETRY=3
            until sudo -v && curl -fsSL https://rclone.org/install.sh | sudo bash; do
              INSTALL_RETRY=$((INSTALL_RETRY-1))
              if [ $INSTALL_RETRY -eq 0 ]; then
                echo "⚠️ 脚本安装失败，执行deb包兜底安装"
                RCLONE_VER=$(curl -s https://api.github.com/repos/rclone/rclone/releases/latest | jq -r .tag_name | sed 's/v//')
                wget -q https://downloads.rclone.org/v${RCLONE_VER}/rclone-v${RCLONE_VER}-linux-amd64.deb -O /tmp/rclone.deb
                sudo dpkg -i /tmp/rclone.deb >/dev/null 2>&1
                sudo apt install -f -y -qq
                rm -f /tmp/rclone.deb
                break
              fi
              sleep 3
            done
          fi
          if command -v rclone &>/dev/null; then
            echo "✅ Rclone安装成功，版本：$(rclone --version | head -n1)"
          else
            echo "❌ Rclone安装失败，终止流程"
            exit 1
          fi
          
          # Docker安装：适配Ubuntu24.04，稳定可靠
          echo "===== 安装Docker ====="
          if ! command -v docker &>/dev/null; then
            sudo apt install -y docker.io docker-compose-plugin -qq
            sudo systemctl enable --now docker
            sudo usermod -aG docker runner
          fi
          echo "✅ Docker安装完成，状态：$(sudo systemctl is-active docker)"
          echo "✅ 系统初始化完成，所有依赖就绪"

      - name: 2-创建根权限用户（完整权限，无权限报错）
        run: |
          set -e
          echo "===== 创建根权限管理员用户 ====="
          USER_NAME="roots"
          # 避免重复创建报错
          if id -u "$USER_NAME" >/dev/null 2>&1; then
            echo "✅ $USER_NAME用户已存在，跳过创建"
          else
            sudo useradd -m -s /bin/bash "$USER_NAME"
            echo "✅ $USER_NAME用户创建成功"
          fi
          # 密码配置：自定义优先，无则随机，无空密码报错
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
            echo "✅ 密码配置完成（自定义）"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "✅ 密码配置完成（随机）：$RANDOM_PASS"
          fi
          # 免密sudo+docker权限，无权限问题
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          sudo chmod 755 /home/"$USER_NAME"
          echo "✅ 根权限用户配置完成：免密sudo+docker管理"

      - name: 3-Rclone配置&WebDAV连通校验（无连接报错）
        run: |
          set -e
          echo "===== 配置Rclone+校验WebDAV ====="
          # 凭证校验，避免后续空值报错
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "❌ WebDAV凭证缺失，备份恢复禁用"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # 配置WebDAV，加密密码，无权限报错
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf >/dev/null
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          # 连通性测试，超时兜底
          if ! timeout 30 rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "❌ WebDAV连接失败，检查凭证地址"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # 创建备份目录，无重复创建报错
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf >/dev/null 2>&1 || true
          # 查找最新快照，避免排序报错
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null | grep "casaos-full-snapshot-.*\.tar\.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT=$(echo "$REMOTE_SNAPSHOTS" | head -n1)
            echo "✅ 检测到最新快照：$LATEST_SNAPSHOT"
            echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
          else
            echo "⚠️ 无备份快照，将执行全新安装"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "✅ WebDAV配置完成，连通正常"

      - name: 4-自动恢复（快照完整还原，无解压报错）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== 全量恢复：${{ env.LATEST_SNAPSHOT }} ====="
          # 停止服务+清理锁文件，无进程占用报错
          sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
          sudo systemctl mask docker.socket casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/casaos.pid 2>/dev/null || true
          sync && sleep 3
          echo "✅ 服务停止，锁文件清理完成"
          
          # 快照完整性校验，避免损坏恢复
          echo "🔍 校验快照完整性..."
          if ! timeout 60 rclone cat mywebdav:${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf | tar -tzf - >/dev/null 2>&1; then
            echo "❌ 快照损坏，恢复终止"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos
            exit 1
          fi
          echo "✅ 快照完整有效，开始恢复"
          
          # 解压恢复，保留权限，无覆盖报错
          rclone cat mywebdav:${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions $EXCLUDE_RULES
          echo "✅ 全量恢复完成，数据完整还原"
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
          
          # 清理远程快照（可选，注释即保留）
          rclone delete mywebdav:${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf 2>/dev/null || true
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt --config /home/runner/.rclone.conf 2>/dev/null || true
          
          # 恢复服务配置，无重载报错
          sudo systemctl unmask docker.socket casaos
          sudo systemctl daemon-reload
          echo "✅ 恢复完成，服务配置就绪"

      - name: 5-无快照全新安装CasaOS（修复参数错误，兜底无报错）
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== 全新安装CasaOS ====="
          # 确保Docker正常运行，无启动报错
          sudo systemctl enable --now docker
          sleep 3
          if ! sudo systemctl is-active --quiet docker; then
            sudo systemctl restart docker
            sleep 3
          fi
          if ! sudo systemctl is-active --quiet docker; then
            echo "❌ Docker启动失败，终止安装"
            exit 1
          fi
          # 官方标准安装命令（移除无效的--force参数）+重试，无参数报错
          INSTALL_RETRY=3
          until curl -fsSL https://get.casaos.io | sudo bash; do
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            if [ $INSTALL_RETRY -eq 0 ]; then
              echo "❌ CasaOS安装失败"
              cat /var/log/casaos-install.log 2>/dev/null || true
              exit 1
            fi
            echo "⚠️ 安装失败，剩余${INSTALL_RETRY}次重试"
            sleep 10
          done
          echo "✅ CasaOS全新安装成功"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"

      - name: 6-恢复后环境修复+服务启动（无缝可用）
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          echo "===== 环境修复+服务启动 ====="
          sudo systemctl daemon-reload
          
          # Docker启动+重试，必启动无报错
          DOCKER_RETRY=5
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl start docker docker.socket
            sleep 5
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "✅ Docker启动成功"
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl reset-failed docker
            sleep 3
          done
          if [ $DOCKER_RETRY -eq 0 ]; then
            echo "❌ Docker启动失败，排查：sudo journalctl -u docker"
            exit 1
          fi
          
          # CasaOS环境修复，无缺失报错
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/casaos/appstore /DATA 2>/dev/null || true
          sudo chown -R root:root /etc/casaos /var/lib/casaos
          sudo chmod -R 755 /etc/casaos /var/lib/casaos
          sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock
          # 补全可执行文件（移除--force参数，使用官方标准命令）
          if [ ! -f "/usr/bin/casaos" ] && [ ! -f "/usr/local/bin/casaos" ]; then
            curl -fsSL https://get.casaos.io | sudo bash -s -- --skip-config
          fi
          [ -f "/usr/local/bin/casaos" ] && sudo ln -sf /usr/local/bin/casaos /usr/bin/casaos 2>/dev/null || true
          # 修复服务文件，无配置错乱
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          curl -fsSL https://raw.githubusercontent.com/IceWhaleTech/CasaOS/main/service/casaos.service -o /tmp/casaos.service
          sudo cp /tmp/casaos.service /etc/systemd/system/ /usr/lib/systemd/system/
          sudo chmod 644 /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service
          sudo systemctl daemon-reload
          sudo docker network create casaos 2>/dev/null || true
          
          # CasaOS启动+重试，无启动报错
          CASAOS_RETRY=3
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo systemctl start casaos
            sleep 4
            if sudo systemctl is-active --quiet casaos; then
              echo "✅ CasaOS启动成功，无缝可用"
              break
            fi
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl reset-failed casaos
            sleep 2
          done
          # 状态验证
          echo "📊 服务状态："
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager
          echo "✅ 环境修复完成，正常运行"

      - name: 7-全新安装后服务初始化（稳定无报错）
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== 全新安装环境初始化 ====="
          sudo systemctl enable --now docker casaos
          sleep 4
          echo "📊 服务状态："
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager
          echo "✅ CasaOS全新环境就绪，可直接访问"

      - name: 8-Tailscale组网部署（极简核心参数，零解析错误）
        run: |
          set -e
          echo "===== Tailscale组网配置 ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "⚠️ 未配置Tailscale密钥，跳过组网"
            exit 0
          fi
          
          # 安装Tailscale，适配Ubuntu24.04，强制更新到最新版
          echo "===== 安装/更新Tailscale ====="
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq
          sudo apt install -y tailscale -qq --upgrade
          
          # 确保tailscaled服务就绪（核心修复：先重启服务）
          echo "===== 重启tailscaled服务 ====="
          sudo systemctl stop tailscaled 2>/dev/null || true
          sudo systemctl start tailscaled
          sudo systemctl enable tailscaled
          sleep 5 # 等待服务完全启动
          
          # 极简组网命令：仅保留核心必选参数（避免参数解析错误）
          echo "===== 执行Tailscale组网 ====="
          TS_HOSTNAME="CasaOS-Server-$(hostname | cut -c1-8)"
          # 仅使用--authkey和--hostname（官方最稳定的核心参数）
          if ! sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME"; then
            echo "⚠️ Tailscale组网命令执行失败，输出详细日志："
            sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --verbose
            exit 1
          fi
          
          # 验证组网结果
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)
          if [ -n "$TS_IP" ]; then
            echo "✅ Tailscale组网成功，远程IPv4：$TS_IP"
            echo "✅ 主机名：$TS_HOSTNAME，开机自动重连"
          else
            echo "⚠️ 组网完成但未获取到IP，状态：$(sudo tailscale status | head -3)"
          fi

      - name: 9-全量备份+自动续跑（修复Shell算术语法错误）
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          echo "===== 启动全量备份+自动续跑 ====="
          
          # 续跑函数：无权限/连接报错
          trigger_workflow_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "⚠️ 续跑配置缺失，跳过"
              return 1
            fi
            if ! curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "⚠️ 续跑触发失败，不影响备份"
              return 1
            fi
            echo "✅ 续跑工作流触发成功"
            RENEW_TRIGGERED=true
            return 0
          }
          
          # 备份核心函数：无打包/上传报错
          full_backup_and_upload() {
            if [ "${{ env.WEBDAV_AVAILABLE }}" != "true" ]; then
              echo "❌ WebDAV不可用，跳过备份"
              return 1
            fi
            # 前置检查：目录+空间充足
            for dir in $CORE_BACKUP_DIRS; do
              sudo mkdir -p "$dir" 2>/dev/null || true
            done
            BACKUP_TMP_DIR="/home/runner/casaos-backup-tmp"
            sudo rm -rf "$BACKUP_TMP_DIR" && sudo mkdir -p "$BACKUP_TMP_DIR"
            sudo chown -R runner:runner "$BACKUP_TMP_DIR"
            sudo chmod 777 "$BACKUP_TMP_DIR"
            # 空间校验，避免写满
            FREE_SPACE=$(df -k "$BACKUP_TMP_DIR" | awk 'NR==2{print $4}')
            FREE_SPACE_GB=$((FREE_SPACE/1024/1024))
            if [ $FREE_SPACE_GB -lt 5 ]; then
              echo "❌ 可用空间不足5GB，跳过备份"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "✅ 前置检查通过，可用空间：$FREE_SPACE_GB GB"
            
            # 打包：无权限/文件占用报错
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            LOCAL_SNAPSHOT="$BACKUP_TMP_DIR/$SNAPSHOT_NAME"
            REMOTE_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "🔄 全量打包中..."
            sudo tar -czf "$LOCAL_SNAPSHOT" \
              --ignore-failed-read \
              --warning=no-all \
              --preserve-permissions \
              --dereference \
              $EXCLUDE_RULES \
              $CORE_BACKUP_DIRS >/dev/null 2>&1
            sudo chown runner:runner "$LOCAL_SNAPSHOT"
            SNAPSHOT_SIZE=$(du -sh "$LOCAL_SNAPSHOT" | awk '{print $1}')
            echo "✅ 打包完成，快照大小：$SNAPSHOT_SIZE"
            
            # 三重校验：杜绝无效备份
            SNAPSHOT_KB=$(du -k "$LOCAL_SNAPSHOT" | awk '{print $1}')
            if [ $SNAPSHOT_KB -lt 1024 ]; then echo "❌ 快照过小，无效"; sudo rm -rf "$BACKUP_TMP_DIR"; return 1; fi
            TAR_CONTENT=$(tar -tzf "$LOCAL_SNAPSHOT" 2>/dev/null)
            if ! echo "$TAR_CONTENT" | grep -q "var/lib/docker" || ! echo "$TAR_CONTENT" | grep -q "var/lib/casaos"; then echo "❌ 核心文件缺失"; sudo rm -rf "$BACKUP_TMP_DIR"; return 1; fi
            tar -tzf "$LOCAL_SNAPSHOT" 2>/dev/null | head -5 >/dev/null || { echo "❌ 快照损坏"; sudo rm -rf "$BACKUP_TMP_DIR"; return 1; }
            echo "✅ 快照校验通过，完整有效"
            
            # 停止服务+上传，无占用/上传报错
            sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
            sudo pkill -9 docker containerd casaos 2>/dev/null || true
            sync && sleep 2
            echo "📤 上传快照到WebDAV..."
            rclone copy "$LOCAL_SNAPSHOT" "$REMOTE_SNAPSHOT" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --fast-list \
              --progress \
              --log-level ERROR
            if [ $? -ne 0 ]; then
              echo "❌ 上传失败"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "✅ 上传成功，远程地址：$REMOTE_SNAPSHOT"
            
            # 上传元数据，无写入报错
            META_FILE="$BACKUP_TMP_DIR/backup-meta.txt"
            echo "snapshot_name=$SNAPSHOT_NAME" > "$META_FILE"
            echo "backup_time=$(date '+%Y-%m-%d %H:%M:%S')" >> "$META_FILE"
            echo "backup_size=$SNAPSHOT_SIZE" >> "$META_FILE"
            echo "backup_content=Docker+CasaOS+DATA全量" >> "$META_FILE"
            rclone copy "$META_FILE" "${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt" --config /home/runner/.rclone.conf 2>/dev/null || true
            
            # 清理+恢复服务，无残留报错
            sudo rm -rf "$BACKUP_TMP_DIR"
            sudo systemctl start docker docker.socket casaos 2>/dev/null || true
            sleep 3
            echo "✅ 备份完成，服务恢复正常"
            return 0
          }
          
          # 主循环：定时备份+防超时，修复算术扩展语法错误
          while true; do
            # 核心修复：用$(date +%s)执行命令并获取结果，再进行算术运算
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "📊 已运行${run_mins}分钟，状态稳定"
            
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "⏰ 触发全量备份"
              if full_backup_and_upload; then
                trigger_workflow_renew
              else
                echo "❌ 备份失败，30分钟后重试"
                sleep 1800
              fi
            fi
            
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "⏹️ 达到最大运行时间，正常退出"
              exit 0
            fi
            sleep 60
          done

      - name: 10-收尾清理（无论成败必执行，无残留）
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 收尾清理，释放资源 ====="
          # 解除掩码，恢复服务默认状态
          sudo systemctl unmask docker.socket casaos 2>/dev/null || true
          # 清理临时文件，无删除报错
          sudo rm -rf /home/runner/casaos-backup-tmp /home/runner/tmp /tmp/* 2>/dev/null || true
          sudo rm -rf /home/runner/.rclone.conf /etc/sudoers.d/roots /tmp/casaos.service 2>/dev/null || true
          # 修复权限，无权限错乱
          sudo chown -R runner:runner /home/runner 2>/dev/null || true
          sudo chmod -R 755 /home/runner 2>/dev/null || true
          # 清理缓存，释放空间
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # 最终状态汇总
          echo "✅ 清理完成，无残留文件"
          echo "📊 最终服务状态："
          sudo systemctl status docker --no-pager 2>/dev/null || echo "Docker状态未知"
          sudo systemctl status casaos --no-pager 2>/dev/null || echo "CasaOS状态未知"
          sudo systemctl status tailscaled --no-pager 2>/dev/null || echo "Tailscale状态未知"
          echo "🎉 全流程执行完成，功能全部就绪"
