name: CasaOS-Server-Snapshot-Backup-Restore

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      # æ”¹ä¸ºè‹±æ–‡è·¯å¾„ï¼Œé¿å…XMLè§£æä¸­æ–‡ä¹±ç 
      WEBDAV_SNAPSHOT_EN_DIR: "object-storage/ubuntu"
      CORE_DIRS: "/var/lib /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp --exclude=$WEBDAV_MOUNT_POINT
      # GitHub Secrets - éœ€é…ç½®
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: Env Init & Create EN Dir
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          # æœ¬åœ°è‹±æ–‡è·¯å¾„ï¼šå¯¹åº”æœåŠ¡ç«¯ object-storage/ubuntu
          WEBDAV_SNAPSHOT_DIR="${WEBDAV_MOUNT_POINT}/${WEBDAV_SNAPSHOT_EN_DIR}"
          sudo mkdir -p "$WEBDAV_SNAPSHOT_DIR"
          echo "âœ… Env init done, WebDAV EN dir: $WEBDAV_SNAPSHOT_DIR"
          echo "WEBDAV_SNAPSHOT_DIR=$WEBDAV_SNAPSHOT_DIR" >> "$GITHUB_ENV"

      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            [ -n "$ROOTS_PASSWORD" ] && echo "roots:$ROOTS_PASSWORD" | sudo chpasswd || {
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots password: $RANDOM_PASS"
            }
            sudo usermod -aG sudo roots
          fi

      - name: Mount WebDAV (Fix Vendor & URL)
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8

          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets missing"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          mkdir -p "$WEBDAV_MOUNT_POINT"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          # ========== æ ¸å¿ƒä¿®å¤1ï¼šé€‚é…ä¸åŒWebDAVæœåŠ¡çš„vendorå‚æ•° ==========
          # æ ¹æ®ä½ çš„WebDAVç±»å‹ä¿®æ”¹vendorï¼š
          # - Nextcloud â†’ vendor="nextcloud"
          # - ownCloud â†’ vendor="owncloud"
          # - é˜¿é‡Œäº‘ç›˜/å¤¸å…‹ â†’ æ³¨é‡Švendorè¡Œï¼ˆç”¨é»˜è®¤å€¼ï¼‰
          # - é€šç”¨æœåŠ¡ â†’ vendor="webdav"
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          
          # æŒ‚è½½å‘½ä»¤ï¼šå¼ºåˆ¶UTF-8ç¼–ç ï¼Œç”ŸæˆæŒ‚è½½æ—¥å¿—
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" \
            --config /home/runner/.rclone.conf \
            --vfs-cache-mode writes \
            --vfs-write-back 0s \
            --transfers 4 \
            --daemon-timeout 1h \
            --allow-other \
            --allow-non-empty \
            --header "Content-Type: application/xml; charset=utf-8" \
            --log-level INFO \
            --log-file /tmp/rclone_mount.log >/dev/null 2>&1 &
          
          # æ£€æŸ¥æŒ‚è½½ï¼ˆé‡è¯•5æ¬¡ï¼‰
          for i in $(seq 1 5); do
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              echo "âœ… WebDAV mounted successfully (UTF-8 XML support)"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              # æ£€æµ‹è‹±æ–‡è·¯å¾„ä¸‹çš„å†å²å¿«ç…§
              if ls "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "âœ… Found latest snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ No historical snapshot in $WEBDAV_SNAPSHOT_DIR"
              fi
              exit 0
            fi
            echo "âš ï¸ Mount attempt $i failed, retrying..."
            sleep 10
          done
          
          echo "âŒ WebDAV mount failed"
          cat /tmp/rclone_mount.log || echo "âš ï¸ No mount log"
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      - name: Restore Snapshot & Cleanup
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== Restore from: $LATEST_SNAPSHOT ====="
          sudo systemctl stop docker.service docker.socket casaos.service
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3
          sudo tar -xzf "$LATEST_SNAPSHOT" -C / --overwrite --ignore-failed-read --warning=no-all $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "âœ… Restore success"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            sudo rm -f "$LATEST_SNAPSHOT" "$WEBDAV_SNAPSHOT_DIR/snapshot_meta.txt"
            sudo systemctl unmask docker.socket
          else
            echo "âŒ Restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
          fi

      - name: Install CasaOS If No Snapshot
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed"

      - name: Start Services
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket casaos.service
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Services started"
              exit 0
            fi
            echo "âš ï¸ Start attempt $i failed"
          done
          echo "âŒ Service start failed"
          exit 1

      - name: Deploy Tailscale
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscale key missing, skip"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"
          echo "âœ… Tailscale IP: $(sudo tailscale ip -4)"

      - name: Create Snapshot & Sync (Fix XML Error)
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          trigger_renew() {
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && return 1
            curl -fsS -X POST -H "Authorization: token $USER_PAT" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/$REPO/dispatches" -d '{"event_type":"renew_casaos_snapshot"}'
            [ $? -eq 0 ] && echo "âœ… Renew triggered" && RENEW_TRIGGERED=true
          }

          create_snapshot() {
            [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            WEBDAV_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ Creating snapshot: $SNAPSHOT_NAME (EN dir: $WEBDAV_SNAPSHOT_DIR)"

            # å½»åº•åœæ­¢æœåŠ¡
            sudo systemctl stop docker.service docker.socket casaos.service
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5

            # æ‰“åŒ…å¿«ç…§
            sudo tar -czf "${TMP_SNAPSHOT}" --absolute-names --ignore-failed-read --warning=no-all $EXCLUDE_RULES $CORE_DIRS
            [ ! -f "${TMP_SNAPSHOT}" ] && echo "âŒ Snapshot not found" && sudo systemctl unmask docker.socket && sudo systemctl start docker casaos && return 1
            echo "âœ… Snapshot created: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            # æ£€æŸ¥å¯å†™æ€§
            if ! sudo touch "${WEBDAV_SNAPSHOT_DIR}/.test-write" 2>/dev/null; then
              echo "âŒ WebDAV dir read-only" && sudo systemctl unmask docker.socket && sudo systemctl start docker casaos && return 1
            fi
            sudo rm -f "${WEBDAV_SNAPSHOT_DIR}/.test-write"

            # å¤åˆ¶+åŒæ­¥
            sudo cp "${TMP_SNAPSHOT}" "${WEBDAV_SNAPSHOT}"
            if [ $? -eq 0 ]; then
              echo "âœ… Copied to local mount dir"
              # ========== æ ¸å¿ƒä¿®å¤2ï¼šåŒæ­¥å‘½ä»¤æ·»åŠ XMLç¼–ç å¤´ï¼Œç”¨è‹±æ–‡è·¯å¾„ ==========
              rclone sync "$WEBDAV_SNAPSHOT_DIR" "mywebdav:/${WEBDAV_SNAPSHOT_EN_DIR}" \
                --config /home/runner/.rclone.conf \
                --transfers 4 \
                --header "Content-Type: application/xml; charset=utf-8" \
                --log-level INFO \
                --log-file /tmp/rclone_sync.log
              if [ $? -eq 0 ]; then
                echo "âœ… Snapshot synced to WebDAV EN dir: mywebdav:/${WEBDAV_SNAPSHOT_EN_DIR}"
                # å†™å…¥å…ƒä¿¡æ¯
                echo "snapshot_name=${SNAPSHOT_NAME}" | sudo tee "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" | sudo tee -a "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                # åŒæ­¥å…ƒä¿¡æ¯
                rclone sync "$WEBDAV_SNAPSHOT_DIR" "mywebdav:/${WEBDAV_SNAPSHOT_EN_DIR}" --config /home/runner/.rclone.conf --log-file /tmp/rclone_meta.log
              else
                echo "âŒ Sync failed, check log:"
                cat /tmp/rclone_sync.log || echo "âš ï¸ No sync log"
                cat /tmp/rclone_mount.log || echo "âš ï¸ No mount log"
                sudo systemctl unmask docker.socket && sudo systemctl start docker casaos && return 1
              fi
            else
              echo "âŒ Copy failed" && sudo systemctl unmask docker.socket && sudo systemctl start docker casaos && return 1
            fi

            # æ¢å¤æœåŠ¡+æ¸…ç†æ—§å¿«ç…§
            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket casaos.service
            find "$WEBDAV_SNAPSHOT_DIR" -name "casaos-server-snapshot-*.tar.gz" -mtime +7 -delete && echo "âœ… Old snapshots cleaned" || echo "âš ï¸ No old snapshots"
            return 0
          }

          # ä¿æ´»å¾ªç¯
          while true; do
            run_mins=$(( ($(date +%s) - start_time) / 60 ))
            echo "ğŸ“Š Running for $run_mins minutes"
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Time to create snapshot"
              create_snapshot && trigger_renew
            fi
            [ $run_mins -ge $MAX_RUN_MINUTES ] && echo "â¹ï¸ Timeout" && exit 0
            sleep 60
          done

      - name: Cleanup
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket || true
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT"
          fi
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          echo "âœ… Cleanup done"
