name: CasaOS+VNC+Tailscale æŒç»­æœåŠ¡ï¼ˆè½»é‡æ¸…ç†ç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  casaos-vnc-server:
    runs-on: ubuntu-24.04
    timeout-minutes: 350
    env:
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340
      FIXED_VNC_PWD: "123456789"
      CASAOS_PORT: 80
      BACKUP_DIR: /home/runner/backup
      INC_BACKUP_BASE: "casaos_base.tar.gz"
      KEEP_BACKUP_NUM: 1
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      RUNNER_PASSWORD: "runner123"
    steps:
      - name: è½»é‡æ¸…ç†ï¼ˆåªåˆ å¤§æ–‡ä»¶ï¼Œä¸åˆ ç³»ç»Ÿç¼“å­˜ï¼‰
        id: clean_disk_light
        run: |
          echo "===== åˆå§‹å¯ç”¨ç©ºé—´ ====="
          df -h / || true
          # åªåˆ é™¤ GitHub Actions æ—§æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶ï¼ˆæœ€å¤§çš„å†—ä½™é¡¹ï¼‰
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* || true
          sudo rm -rf /home/runner/actions-runner/_work/_temp/* || true
          # ä¸åˆ ç³»ç»Ÿaptç¼“å­˜ï¼Œä¿ç•™åŸºç¡€ä¾èµ–
          echo "===== è½»é‡æ¸…ç†åå¯ç”¨ç©ºé—´ ====="
          df -h / || true

      - name: ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        id: init_env
        continue-on-error: false
        run: |
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿæ›´æ–°å¤±è´¥"; exit 1; }
          sudo apt install -y --no-install-recommends tar gzip rsync rclone tigervnc-standalone-server netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release || { echo "ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          # è®¾ç½®runnerå¯†ç 
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          sudo mkdir -p $BACKUP_DIR
          sudo chown -R runner:runner $BACKUP_DIR
          # è®°å½•ç³»ç»Ÿä¿¡æ¯
          echo "OS_VERSION=$(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '"')" >> $GITHUB_ENV
          echo "RUNNER_USER=$(whoami)" >> $GITHUB_ENV

      - name: é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆrcloneï¼‰
        id: config_rclone
        continue-on-error: false
        env:
          OSS_CONFIG: ${{ secrets.OSS_CONFIG }}
        run: |
          # è§£æOSSé…ç½®ï¼ˆå®¹é”™å¤„ç†ï¼‰
          export OSS_ENDPOINT=$(echo "$OSS_CONFIG" | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /endpoint:/){gsub("endpoint:","",$i);print $i}}}')
          export OSS_AK=$(echo "$OSS_CONFIG" | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /ak:/){gsub("ak:","",$i);print $i}}}')
          export OSS_SK=$(echo "$OSS_CONFIG" | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /sk:/){gsub("sk:","",$i);print $i}}}')
          
          # åˆ›å»ºrcloneé…ç½®æ–‡ä»¶ï¼ˆä¿®å¤YAMLå¤šè¡Œæ–‡æœ¬è¯­æ³•ï¼‰
          mkdir -p ~/.config/rclone
          # æ”¹ç”¨echoå†™å…¥ï¼Œé¿å…EOFå¤šè¡Œæ ¼å¼é”™è¯¯
          echo "[oss]" > ~/.config/rclone/rclone.conf
          echo "type = s3" >> ~/.config/rclone/rclone.conf
          echo "provider = Other" >> ~/.config/rclone/rclone.conf
          echo "endpoint = $OSS_ENDPOINT" >> ~/.config/rclone/rclone.conf
          echo "access_key_id = $OSS_AK" >> ~/.config/rclone/rclone.conf
          echo "secret_access_key = $OSS_SK" >> ~/.config/rclone/rclone.conf
          
          chmod 600 ~/.config/rclone/rclone.conf
          # æ£€æµ‹è¿æ¥
          if rclone lsd oss:; then
            echo "OSS_CONNECT_STATUS=âœ… æˆåŠŸ" >> $GITHUB_ENV
            echo "OSS_ENDPOINT=$OSS_ENDPOINT" >> $GITHUB_ENV
          else
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi

      - name: å®‰è£… Docker + CasaOSï¼ˆç²¾ç®€ç‰ˆï¼‰
        id: install_services
        run: |
          # å®‰è£…Dockerï¼ˆç²¾ç®€æ¨¡å¼ï¼‰
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          sudo apt update -y && sudo apt install -y --no-install-recommends docker-ce docker-ce-cli containerd.io
          sudo systemctl start docker && sudo systemctl enable docker
          # æ£€æµ‹DockerçŠ¶æ€
          if sudo systemctl is-active --quiet docker; then
            echo "DOCKER_STATUS=âœ… è¿è¡Œä¸­" >> $GITHUB_ENV
          else
            echo "DOCKER_STATUS=âŒ æœªå¯åŠ¨" >> $GITHUB_ENV
          fi

          # å®‰è£…CasaOSï¼ˆè·³è¿‡å†—ä½™ä¾èµ–ï¼‰
          curl -fsSL https://get.casaos.io | sudo bash -s -- --lite || echo "CasaOSå®‰è£…è­¦å‘Š"
          sleep 10 && sudo systemctl start casaos
          # æ£€æµ‹CasaOSçŠ¶æ€
          if sudo systemctl is-active --quiet casaos; then
            echo "CASAOS_STATUS=âœ… è¿è¡Œä¸­" >> $GITHUB_ENV
          else
            echo "CASAOS_STATUS=âŒ æœªå¯åŠ¨" >> $GITHUB_ENV
          fi

      - name: é…ç½® VNC + Tailscale
        id: deploy_core
        run: |
          # é…ç½®VNC
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          # å†™å…¥VNCå¯åŠ¨è„šæœ¬ï¼ˆæ”¹ç”¨echoé¿å…EOFè¯­æ³•é”™è¯¯ï¼‰
          echo "#!/bin/bash" > $VNCDIR/xstartup
          echo "export DISPLAY=:0" >> $VNCDIR/xstartup
          echo "export XDG_RUNTIME_DIR=/tmp/runtime-runner" >> $VNCDIR/xstartup
          echo "mkdir -p \$XDG_RUNTIME_DIR && chmod 700 \$XDG_RUNTIME_DIR" >> $VNCDIR/xstartup
          echo "exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title \"CasaOSæœåŠ¡\"" >> $VNCDIR/xstartup
          chmod +x $VNCDIR/xstartup
          
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth
          # æ£€æµ‹VNCçŠ¶æ€
          if pgrep -x Xvnc >/dev/null; then
            echo "VNC_STATUS=âœ… è¿è¡Œä¸­ (ç«¯å£:$VNC_PORT)" >> $GITHUB_ENV
          else
            echo "VNC_STATUS=âŒ å¯åŠ¨å¤±è´¥" >> $GITHUB_ENV
          fi

          # é…ç½®Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo sh || true
          sudo systemctl enable --now tailscaled && sleep 3
          MAX_RETRIES=3
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "TAILSCALE_STATUS=âœ… è¿è¡Œä¸­ (IP:$TAILSCALE_IP)" >> $GITHUB_ENV
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            sleep 5
          done
          if [ $MAX_RETRIES -eq 0 ]; then
            echo "TAILSCALE_STATUS=âŒ å¯åŠ¨å¤±è´¥ï¼ˆå¯†é’¥å¯èƒ½æ— æ•ˆï¼‰" >> $GITHUB_ENV
          fi

      - name: è¾“å‡ºè¯¦ç»†çŠ¶æ€
        id: output_info
        run: |
          echo -e "\n========================================"
          echo -e " ğŸš€ æœåŠ¡éƒ¨ç½²çŠ¶æ€æ±‡æ€»ï¼ˆè½»é‡æ¸…ç†ç‰ˆï¼‰"
          echo -e "========================================"
          echo -e " ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯ | å¯ç”¨ç©ºé—´: $(df -h / | awk 'NR==2{print $4}')"
          echo -e "   - ç³»ç»Ÿç‰ˆæœ¬: ${OS_VERSION} | è¿è¡Œç”¨æˆ·: ${RUNNER_USER}"
          echo -e "   - runnerå¯†ç : \033[1;32m${RUNNER_PASSWORD}\033[0m"
          echo -e " ğŸ“¦ å¯¹è±¡å­˜å‚¨ | çŠ¶æ€: ${OSS_CONNECT_STATUS} | ç«¯ç‚¹: ${OSS_ENDPOINT}"
          echo -e " ğŸ¯ æœåŠ¡çŠ¶æ€ | Docker: ${DOCKER_STATUS} | CasaOS: ${CASAOS_STATUS}"
          echo -e "   - VNC: ${VNC_STATUS} | Tailscale: ${TAILSCALE_STATUS}"
          echo -e " ğŸ”— è®¿é—®åœ°å€ | VNC: ${TAILSCALE_IP:-æœªè·å–}:${VNC_PORT} | CasaOS: http://${TAILSCALE_IP:-æœªè·å–}:${CASAOS_PORT}"
          echo -e "========================================\n"

      - name: ä¿æ´»+å¤‡ä»½ï¼ˆæŒ‰éœ€æ¸…ç†ï¼‰
        id: core_logic
        run: |
          start_time=$(date +%s)
          last_backup_time=$start_time

          full_backup() {
            if [ "${OSS_CONNECT_STATUS}" = "âœ… æˆåŠŸ" ]; then
              sudo tar -zcf $BACKUP_DIR/$INC_BACKUP_BASE $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*"
              rclone copy $BACKUP_DIR/$INC_BACKUP_BASE oss:casaos-backup/ && rm -f $BACKUP_DIR/$INC_BACKUP_BASE
            fi
          }

          inc_backup() {
            if [ "${OSS_CONNECT_STATUS}" = "âœ… æˆåŠŸ" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              sudo tar -zcf $BACKUP_DIR/inc_$TIMESTAMP.tar.gz $BACKUP_EXCLUDE / --listed-incremental=$BACKUP_DIR/backup.snar --wildcards "*/casaos/*" "*/docker/*"
              rclone copy $BACKUP_DIR/inc_$TIMESTAMP.tar.gz oss:casaos-backup/ && rm -f $BACKUP_DIR/inc_$TIMESTAMP.tar.gz
            fi
          }

          # åˆå§‹å¤‡ä»½
          if [ ! -f "$BACKUP_DIR/$INC_BACKUP_BASE" ]; then
            full_backup
          else
            inc_backup
          fi

          # ä¸»å¾ªç¯
          while true; do
            current_time=$(date +%s)
            run_minutes=$(( (current_time - start_time) / 60 ))
            # è·å–å¯ç”¨ç©ºé—´ï¼ˆæ•°å­—éƒ¨åˆ†ï¼‰
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            # åªåœ¨ç©ºé—´ä¸è¶³2GBæ—¶æ‰æ¸…ç†
            if (( $(echo "$FREE_SPACE < 2" | bc -l) )); then
              echo "âš ï¸  ç©ºé—´ä¸è¶³2GBï¼ŒæŒ‰éœ€æ¸…ç†..."
              sudo apt clean -y || true
              sudo docker system prune -af || true
              rm -rf /tmp/* || true
            fi

            # å‰©ä½™10åˆ†é’Ÿè§¦å‘ç»­è·‘
            if [ $((MAX_RUN_MINUTES - run_minutes)) -eq 10 ]; then
              echo "===== å‰©ä½™10åˆ†é’Ÿï¼Œè§¦å‘ç»­è·‘ ====="
              full_backup
              # è§¦å‘æ–°å®ä¾‹
              curl -X POST \
                https://api.github.com/repos/${{ github.repository }}/dispatches \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.USER_GITHUB_PAT }}" \
                -d '{"event_type":"renew_vnc"}' || echo "ç»­è·‘è§¦å‘å¤±è´¥"
            fi

            # æ¯2å°æ—¶å¢é‡å¤‡ä»½
            if [ $((current_time - last_backup_time)) -ge 7200 ]; then
              inc_backup
              last_backup_time=$current_time
            fi

            # æœåŠ¡å¥åº·æ£€æŸ¥
            if ! pgrep -x Xvnc >/dev/null; then
              echo "VNCæœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."
              vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth
            fi
            if ! sudo systemctl is-active --quiet docker; then
              echo "DockeræœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."
              sudo systemctl restart docker
            fi
            if ! sudo systemctl is-active --quiet casaos; then
              echo "CasaOSæœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."
              sudo systemctl restart casaos
            fi
            if ! sudo systemctl is-active --quiet tailscaled; then
              echo "TailscaleæœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."
              sudo systemctl restart tailscaled
            fi

            # è¾“å‡ºè¿è¡ŒçŠ¶æ€
            echo "[$(date)] è¿è¡Œ${run_minutes}åˆ†é’Ÿ | å‰©ä½™ç©ºé—´: $(df -h / | awk 'NR==2{print $4}') | Tailscale IP: ${TAILSCALE_IP:-æœªè·å–}"
            sleep 300
          done

      - name: ä¼˜é›…æ¸…ç†
        id: clean_env
        if: always()
        run: |
          echo "===== æ¸…ç†ç¯å¢ƒ ====="
          # åœæ­¢VNC
          vncserver -kill $DISPLAY || true
          pkill -9 Xvnc || true
          # åœæ­¢æ ¸å¿ƒæœåŠ¡
          sudo systemctl stop docker casaos tailscaled || true
          sudo tailscale down || true
          # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
          rm -rf $BACKUP_DIR $VNCDIR /tmp/* || true
          echo "===== ç¯å¢ƒæ¸…ç†å®Œæˆ ====="
