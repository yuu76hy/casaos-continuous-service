name: CasaOS-å…¨é‡å¤‡ä»½æ¢å¤è¿ç§»ï¼ˆåŸæœºæœåŠ¡æ–‡ä»¶+æ— ç½‘ç»œä¾èµ–ï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # è‡ªåŠ¨ç»­è·‘è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # å¯é€‰ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½ï¼ˆéœ€å¯ç”¨è¯·å–æ¶ˆæ³¨é‡Šï¼‰

jobs:
  casaos-full-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360  # æœ€å¤§è¿è¡Œæ—¶é—´ï¼ˆ6å°æ—¶ï¼‰
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"  # æœåŠ¡ç«¯å®é™…å¤‡ä»½ç›®å½•
      # æ ¸å¿ƒå¤‡ä»½è·¯å¾„ï¼ˆå«åŸæœºcasaos.serviceåŒè·¯å¾„ï¼Œè¦†ç›–æ‰€æœ‰æƒ…å†µï¼‰
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /usr/lib/systemd/system/docker.service /etc/systemd/system/docker.service.d /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/lib/systemd/system/casaos.service /etc/systemd/system/casaos.service /DATA"
      # æ’é™¤å†—ä½™æ–‡ä»¶ï¼ˆå‡å°‘å¿«ç…§ä½“ç§¯ï¼‰
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=/var/lib/docker/volumes/*/_data/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
      # ä»GitHub Secretsè¯»å–é…ç½®ï¼ˆéœ€æå‰é…ç½®ï¼‰
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–&æ ¸å¿ƒä¾èµ–å®‰è£…
        run: |
          set -e
          echo "===== ç³»ç»Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          # å®‰è£…å¿…å¤‡ä¾èµ–ï¼ˆå«ä¸­æ–‡ç¼–ç ï¼‰
          sudo apt install -y curl wget jq fuse3 tar gzip bzip2 locales openssl ca-certificates apt-transport-https sshpass net-tools iputils-ping -qq
          sudo locale-gen zh_CN.UTF-8 && sudo update-locale LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          
          # å®‰è£…Rcloneï¼ˆæ–‡ä»¶ä¸Šä¼ å·¥å…·ï¼‰
          if ! command -v rclone &>/dev/null; then
            INSTALL_RETRY=3
            until curl -fsSL https://rclone.org/install.sh | sudo bash; do
              INSTALL_RETRY=$((INSTALL_RETRY-1))
              [ $INSTALL_RETRY -eq 0 ] && { wget -q https://downloads.rclone.org/v$(curl -s https://api.github.com/repos/rclone/rclone/releases/latest | jq -r .tag_name | sed 's/v//')/rclone-v$(curl -s https://api.github.com/repos/rclone/rclone/releases/latest | jq -r .tag_name | sed 's/v//')-linux-amd64.deb -O /tmp/rclone.deb; sudo dpkg -i /tmp/rclone.deb; sudo apt install -f -y; break; }
              sleep 3
            done
          fi
          
          # å®‰è£…Dockerï¼ˆCasaOSä¾èµ–ï¼‰
          if ! command -v docker &>/dev/null; then
            sudo apt install -y docker.io docker-compose-plugin -qq
            sudo systemctl enable --now docker && sudo usermod -aG docker runner
          fi
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä¾èµ–å…¨éƒ¨å°±ç»ª"

      - name: 2-åˆ›å»ºæ ¹æƒé™ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå…å¯†sudoï¼‰
        run: |
          set -e
          echo "===== é…ç½®æ ¹æƒé™ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          # é…ç½®å¯†ç ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å¯†ç ï¼Œæ— åˆ™ç”Ÿæˆéšæœºå¯†ç ï¼‰
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd || { RANDOM_PASS=$(openssl rand -base64 12); echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd; echo "âœ… éšæœºå¯†ç ï¼š$RANDOM_PASS"; }
          # æˆäºˆå…å¯†sudo+dockerç®¡ç†æƒé™
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME" && sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          echo "âœ… æ ¹æƒé™ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 3-Rcloneé…ç½®+WebDAVè¿é€šæ ¡éªŒï¼ˆé€‚é…/z/Uduï¼‰
        run: |
          set -e
          echo "===== WebDAVé…ç½®ä¸æ ¡éªŒ ====="
          # æ ¡éªŒå‡­è¯æ˜¯å¦å®Œæ•´
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œç¦ç”¨å¤‡ä»½æ¢å¤" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
          fi
          # æ ¡éªŒURLåè®®å‰ç¼€
          if ! echo "$WEBDAV_URL" | grep -qE "^http://|^https://"; then
            echo "âŒ WebDAVåœ°å€ç¼ºå¤±http/httpså‰ç¼€" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
          fi
          
          # é…ç½®Rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="webdav" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          
          # æ ¡éªŒæœåŠ¡ç«¯/z/Uduç›®å½•æƒé™ï¼ˆæ ¸å¿ƒé€‚é…ï¼‰
          echo "ğŸ” æ ¡éªŒ/z/Uduç›®å½•æƒé™..."
          rclone mkdir mywebdav:/z/Udu --config /home/runner/.rclone.conf 2>/dev/null || true
          if ! timeout 30 rclone ls mywebdav:/z/Udu --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ /z/Uduç›®å½•æ— è®¿é—®æƒé™" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
          fi
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null || true
          
          # æŸ¥æ‰¾æœ€æ–°å¿«ç…§ï¼ˆé˜²é‡å¤æ‹¼æ¥é€»è¾‘ï¼‰
          echo "ğŸ” æŸ¥æ‰¾æœ€æ–°å¤‡ä»½å¿«ç…§..."
          REMOTE_FILES=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null)
          if [ -n "$REMOTE_FILES" ]; then
            REMOTE_SNAPSHOTS=$(echo "$REMOTE_FILES" | grep -E "casaos-full-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz" | sed -E 's/^[0-9]+[[:space:]]+//' | xargs -n1 basename | sort -r | uniq)
            LATEST_SNAPSHOT=$(echo "$REMOTE_SNAPSHOTS" | head -n1 | xargs)
            # å®‰å…¨æ¸…æ´—ï¼šé¿å…è·¯å¾„é‡å¤
            [ $(echo "$LATEST_SNAPSHOT" | grep -c "/") -gt 0 ] && LATEST_SNAPSHOT=$(basename "$LATEST_SNAPSHOT")
            echo "âœ… æœ€æ–°å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
            echo "FULL_SNAPSHOT_PATH=${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æ— å†å²å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…"
          fi
          
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "âœ… WebDAVé…ç½®å®Œæˆï¼Œå¯æ­£å¸¸å¤‡ä»½/æ¢å¤"

      - name: 4-è‡ªåŠ¨æ¢å¤ï¼ˆä½¿ç”¨åŸæœºå¤‡ä»½çš„serviceæ–‡ä»¶ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== å…¨é‡æ¢å¤ï¼š${{ env.LATEST_SNAPSHOT }} ====="
          # æ¸…æ´—è·¯å¾„ï¼ˆæœ€ç»ˆä¿éšœï¼‰
          CLEAN_FULL_PATH="${{ env.WEBDAV_SNAPSHOT_DIR }}/$(basename ${{ env.LATEST_SNAPSHOT }})"
          echo "ğŸ” æ¢å¤è·¯å¾„ï¼š${CLEAN_FULL_PATH}"
          
          # åœæ­¢æœåŠ¡+æ¸…ç†é”æ–‡ä»¶
          sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
          sudo systemctl mask docker.socket casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/casaos.pid 2>/dev/null || true
          sync && sleep 3
          
          # æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
          if ! timeout 60 rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æŸåæˆ–è·¯å¾„é”™è¯¯" && echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV" && sudo systemctl unmask docker.socket casaos && exit 1
          fi
          
          # æ¢å¤æ•°æ®ï¼ˆç›´æ¥è¿˜åŸåŸæœºæ–‡ä»¶ï¼Œå«casaos.serviceï¼‰
          rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions $EXCLUDE_RULES
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼ŒåŸæœºserviceæ–‡ä»¶å·²è¿˜åŸ"
          
          # åˆ é™¤å·²æ¢å¤çš„å¿«ç…§ï¼ˆé¿å…é‡å¤æ¢å¤ï¼‰
          rclone delete mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf 2>/dev/null || true
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt --config /home/runner/.rclone.conf 2>/dev/null || true
          
          sudo systemctl unmask docker.socket casaos && sudo systemctl daemon-reload
          echo "âœ… æ¢å¤å®Œæˆï¼ŒæœåŠ¡é…ç½®å°±ç»ª"
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"

      - name: 5-æ— å¿«ç…§æ—¶å…¨æ–°å®‰è£…CasaOS
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…CasaOS ====="
          # å¯åŠ¨Docker
          sudo systemctl enable --now docker && sleep 3
          [ ! $(sudo systemctl is-active --quiet docker) ] && sudo systemctl restart docker && sleep 3
          [ ! $(sudo systemctl is-active --quiet docker) ] && echo "âŒ Dockerå¯åŠ¨å¤±è´¥" && exit 1
          
          # å®‰è£…CasaOSï¼ˆå®˜æ–¹è„šæœ¬ï¼Œè‡ªåŠ¨ç”Ÿæˆserviceæ–‡ä»¶ï¼‰
          INSTALL_RETRY=3
          until curl -fsSL https://get.casaos.io | sudo bash; do
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            [ $INSTALL_RETRY -eq 0 ] && { echo "âŒ CasaOSå®‰è£…å¤±è´¥"; cat /var/log/casaos-install.log 2>/dev/null; exit 1; }
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œå‰©ä½™${INSTALL_RETRY}æ¬¡é‡è¯•" && sleep 10
          done
          echo "âœ… CasaOSå…¨æ–°å®‰è£…æˆåŠŸ"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"

      - name: 6-æœåŠ¡å¯åŠ¨+ç¯å¢ƒä¿®å¤ï¼ˆæ— ç½‘ç»œæ‹‰å–ï¼‰
        run: |
          set -e
          echo "===== æœåŠ¡å¯åŠ¨ä¸ç¯å¢ƒä¿®å¤ ====="
          sudo systemctl daemon-reload
          
          # å¯åŠ¨Dockerï¼ˆå®¹é”™é‡è¯•ï¼‰
          DOCKER_RETRY=5
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl start docker docker.socket && sleep 5
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Dockerå¯åŠ¨æˆåŠŸ" && break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1)) && sudo systemctl reset-failed docker && sleep 3
          done
          [ $DOCKER_RETRY -eq 0 ] && { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          
          # ä¿®å¤ç›®å½•æƒé™ï¼ˆä¿éšœCasaOSè¿è¡Œï¼‰
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/casaos/appstore /DATA 2>/dev/null || true
          sudo chown -R root:root /etc/casaos /var/lib/casaos && sudo chmod -R 755 /etc/casaos /var/lib/casaos
          sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock
          
          # å¯åŠ¨CasaOSï¼ˆä½¿ç”¨åŸæœºå¤‡ä»½/å®‰è£…ç”Ÿæˆçš„serviceæ–‡ä»¶ï¼‰
          sudo docker network create casaos 2>/dev/null || true
          CASAOS_RETRY=3
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo systemctl start casaos && sleep 4
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… CasaOSå¯åŠ¨æˆåŠŸï¼Œå¯æ­£å¸¸è®¿é—®" && break
            fi
            CASAOS_RETRY=$((CASAOS_RETRY-1)) && sudo systemctl reset-failed casaos && sleep 2
          done
          
          # è¾“å‡ºæœåŠ¡çŠ¶æ€
          echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
          sudo systemctl status docker --no-pager 2>/dev/null || echo "DockerçŠ¶æ€æœªçŸ¥"
          sudo systemctl status casaos --no-pager 2>/dev/null || echo "CasaOSçŠ¶æ€æœªçŸ¥"
          echo "âœ… ç¯å¢ƒä¿®å¤å®Œæˆ"

      - name: 7-Tailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼Œéœ€é…ç½®å¯†é’¥ï¼‰
        run: |
          set -e
          echo "===== Tailscaleç»„ç½‘é…ç½® ====="
          [ -z "$TAILSCALE_AUTH_KEY" ] && echo "âš ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘" && exit 0
          
          # å®‰è£…Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq --upgrade
          
          # å¯åŠ¨å¹¶ç»„ç½‘
          sudo systemctl restart tailscaled && sudo systemctl enable tailscaled && sleep 5
          TS_HOSTNAME="CasaOS-Server-$(hostname | cut -c1-8)"
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME"
          
          # è¾“å‡ºç»„ç½‘ä¿¡æ¯
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)
          [ -n "$TS_IP" ] && echo "âœ… ç»„ç½‘æˆåŠŸï¼Œè¿œç¨‹IPv4ï¼š$TS_IP" || echo "âš ï¸ ç»„ç½‘å®Œæˆä½†æœªè·å–IP"

      - name: 8-å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ˆå«åŸæœºserviceæ–‡ä»¶ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          start_time=$(date +%s)
          R
