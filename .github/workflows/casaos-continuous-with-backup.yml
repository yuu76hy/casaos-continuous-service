name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆTailscaleå†…ç½‘ç‰ˆ /aaaç›®å½• æ‹‰å–å³åˆ  æ— é™æ£€æµ‹åˆ é™¤ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA"
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"
      TARGET_RUN_MINUTES: 1  # æ”¹ä¸º1åˆ†é’Ÿ
      RETRY_TIMES: 3
      MAX_POLL_TIMES: 360

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç†
        if: ${{ always() }}
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç† ====="
          # é”™è¯¯ä»…æ—¥å¿—ï¼Œä¸ç»ˆæ­¢
          sudo apt update -y -qq || echo "âŒ aptæ›´æ–°å¤±è´¥"
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server zstd -qq || echo "âŒ å®‰è£…ä¾èµ–å¤±è´¥"

          sudo apt remove -y docker* containerd* runc* 2>/dev/null || echo "âŒ å¸è½½æ—§Dockerå¤±è´¥ï¼ˆå¯èƒ½æœªå®‰è£…ï¼‰"

          sudo systemctl stop casaos 2>/dev/null || echo "âŒ åœæ­¢CasaOSå¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
          sudo systemctl disable casaos 2>/dev/null || echo "âŒ ç¦ç”¨CasaOSå¤±è´¥ï¼ˆå¯èƒ½æœªå®‰è£…ï¼‰"
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || echo "âŒ åˆ é™¤CasaOSæœåŠ¡æ–‡ä»¶å¤±è´¥"
          sudo systemctl daemon-reload || echo "âŒ é‡è½½systemdå¤±è´¥"

          sudo rm -rf \
            /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n \
            /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google \
            2>/dev/null || echo "âŒ æ¸…ç†å†—ä½™ç›®å½•å¤±è´¥"

          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y || echo "âŒ è‡ªåŠ¨å¸è½½ä¾èµ–å¤±è´¥"
          sudo DEBIAN_FRONTEND=noninteractive apt clean || echo "âŒ æ¸…ç†aptç¼“å­˜å¤±è´¥"
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || echo "âŒ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥"

          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || echo "âŒ é‡Šæ”¾ç¼“å­˜å¤±è´¥"
          sudo systemctl enable --now ssh || echo "âŒ å¯åŠ¨SSHæœåŠ¡å¤±è´¥"
          echo "âœ… 1-ç³»ç»Ÿåˆå§‹åŒ–+æ·±åº¦æ¸…ç†æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 2-å®˜æ–¹çº¯å‡€å®‰è£… Docker
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 2-å®‰è£… Dockerï¼ˆå®˜æ–¹æºï¼‰ ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash || echo "âŒ Dockerå®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥"
          sudo systemctl enable docker containerd || echo "âŒ è®¾ç½®Dockerå¼€æœºè‡ªå¯å¤±è´¥"
          sudo systemctl stop docker containerd 2>/dev/null || echo "âŒ åœæ­¢Dockerå¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
          docker --version || echo "âŒ æ£€æŸ¥Dockerç‰ˆæœ¬å¤±è´¥ï¼ˆå¯èƒ½æœªå®‰è£…æˆåŠŸï¼‰"
          sudo usermod -aG docker runner || echo "âŒ ç»™runnerç”¨æˆ·æ·»åŠ Dockeræƒé™å¤±è´¥"
          echo "âœ… 2-Dockerå®‰è£…æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 3-å®˜æ–¹çº¯å‡€å®‰è£… CasaOS
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 3-å®‰è£… CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash || echo "âŒ CasaOSå®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥"
          sudo systemctl stop casaos 2>/dev/null || echo "âŒ åœæ­¢CasaOSå¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
          sudo systemctl disable casaos 2>/dev/null || echo "âŒ ç¦ç”¨CasaOSå¼€æœºè‡ªå¯å¤±è´¥"
          echo "âœ… 3-CasaOSå®‰è£…æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 4-åˆ›å»º roots ç®¡ç†å‘˜+SSHå¯†ç ç™»å½•
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 4-é…ç½®ç®¡ç†å‘˜ç”¨æˆ· roots ====="
          if [[ -z "${SSH_PASS:-}" ]]; then
            echo "âŒ é”™è¯¯ï¼šROOTS_PASSWORD æœªé…ç½®"
          fi

          USER_NAME="roots"
          if ! id -u "${USER_NAME}" &>/dev/null; then
            sudo useradd -m -s /bin/bash "${USER_NAME}" || echo "âŒ åˆ›å»ºrootsç”¨æˆ·å¤±è´¥"
          fi
          echo "${USER_NAME}:${SSH_PASS}" | sudo chpasswd || echo "âŒ è®¾ç½®rootsç”¨æˆ·å¯†ç å¤±è´¥"
          echo "${USER_NAME} ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"${USER_NAME}" >/dev/null || echo "âŒ é…ç½®rootsç”¨æˆ·sudoæƒé™å¤±è´¥"
          sudo chmod 0440 /etc/sudoers.d/"${USER_NAME}" || echo "âŒ ä¿®æ”¹sudoersæ–‡ä»¶æƒé™å¤±è´¥"
          sudo usermod -aG docker "${USER_NAME}" || echo "âŒ ç»™rootsç”¨æˆ·æ·»åŠ Dockeræƒé™å¤±è´¥"

          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || echo "âŒ å¼€å¯SSHå¯†ç è®¤è¯å¤±è´¥"
          sudo systemctl restart ssh || echo "âŒ é‡å¯SSHæœåŠ¡å¤±è´¥"
          echo "âœ… 4-ç®¡ç†å‘˜ç”¨æˆ·é…ç½®æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 5-Tailscale ç»„ç½‘+ä¸Šçº¿+æ˜¾ç¤ºæœ¬æœºIP
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 5-Tailscaleç»„ç½‘ + æ˜¾ç¤ºæœ¬æœºä¿¡æ¯ ====="
          if [[ -z "${TAILSCALE_AUTH_KEY:-}" ]]; then
            echo "âš ï¸ Tailscale æœªé…ç½®ï¼Œè·³è¿‡ç»„ç½‘"
          else
            echo "ğŸ”§ ä½¿ç”¨å®˜æ–¹ä¸€é”®è„šæœ¬å®‰è£… Tailscale"
            curl -fsSL https://tailscale.com/install.sh | sudo bash || echo "âŒ Tailscaleå®‰è£…å¤±è´¥"

            sudo systemctl enable --now tailscaled && sleep 2 || echo "âŒ å¯åŠ¨tailscaledæœåŠ¡å¤±è´¥"

            TS_SUFFIX=$((RANDOM % 10000))
            TS_HOSTNAME="CasaOS-${TS_SUFFIX}"
            echo "ğŸ”– æœ¬æ¬¡ Tailscale ä¸»æœºåï¼š${TS_HOSTNAME}"

            sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${TS_HOSTNAME}" --accept-routes || echo "âŒ Tailscaleç»„ç½‘å¤±è´¥"

            echo -e "\n=== ğŸ–¥ï¸ æœ¬æœº IP ä¿¡æ¯ ==="
            LOCAL_IP=$(hostname -I | awk '{print $1}')
            TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "è·å–å¤±è´¥")
            echo "âœ… ç‰©ç†å†…ç½‘IP: ${LOCAL_IP}"
            echo "âœ… Tailscaleå†…ç½‘IP: ${TAILSCALE_IP}"
            echo "==================================="
          fi
          echo "âœ… 5-Tailscaleç»„ç½‘æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 6-ä»å†…ç½‘/aaaæ‹‰å¤‡ä»½â†’å¤šèŠ‚ç‚¹å°è¯•â†’æ‹‰å–å³åˆ â†’è¦†ç›–æ¢å¤
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 6-æ‹‰å–å¤‡ä»½+æ‹‰å–å³åˆ +è¦†ç›–æ¢å¤ ====="
          if [[ -z "${TAILSCALE_AUTH_KEY:-}" ]]; then
            echo "â„¹ï¸ Tailscale æœªé…ç½®ï¼Œè·³è¿‡å¤‡ä»½æ‹‰å–"
          elif [[ -z "${SSH_PASS:-}" ]]; then
            echo "âŒ SSH_PASS æœªé…ç½®ï¼Œè·³è¿‡å¤‡ä»½æ‹‰å–"
          else
            TS_STATUS_JSON=$(sudo tailscale status --json || echo "{}")
            SELF_ID=$(echo "${TS_STATUS_JSON}" | jq -r '.Self.ID' || echo "")

            echo -e "\nğŸ” ç­›é€‰åœ¨çº¿+å«casaos+æ’é™¤æœ¬æœºèŠ‚ç‚¹"
            TARGET_LIST=$(echo "${TS_STATUS_JSON}" | jq -r --arg self "${SELF_ID}" '
              .Peer[] |
              select(.Online == true) |
              select(.ID != $self) |
              select( (.HostName | tostring | ascii_downcase) | contains("casaos") ) |
              "\(.HostName // "unknown")|\(.TailscaleIPs[0] // "no-ip")"
            ' || echo "")

            if [[ -z "${TARGET_LIST}" ]]; then
              echo "â„¹ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶èŠ‚ç‚¹ï¼Œè·³è¿‡å¤‡ä»½æ‹‰å–"
            else
              echo -e "\nğŸ›‘ åœæ­¢ Docker/CasaOS ç¡®ä¿æ— æ–‡ä»¶å ç”¨"
              sudo systemctl stop casaos 2>/dev/null || echo "âŒ åœæ­¢CasaOSå¤±è´¥"
              sudo systemctl stop docker containerd 2>/dev/null || echo "âŒ åœæ­¢Dockerå¤±è´¥"
              sync && sleep 2

              sudo mkdir -p "${LOCAL_BACKUP_DIR}" || echo "âŒ åˆ›å»ºæœ¬åœ°å¤‡ä»½ç›®å½•å¤±è´¥"
              RESTORE_SUCCESS=0

              while IFS='|' read -r TARGET_HOST TARGET_IP; do
                echo -e "\n==========================================================="
                echo "ğŸ¯ å°è¯•èŠ‚ç‚¹ï¼š${TARGET_HOST} | ${TARGET_IP}"
                echo "==========================================================="

                LATEST_FILE=""
                for ((i=1; i<=RETRY_TIMES; i++)); do
                  LATEST_FILE=$(sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
                    "${SSH_USER}@${TARGET_IP}" "ls -t \"${REMOTE_BACKUP_BASE}\"/casaos-*.tar.zst 2>/dev/null | head -1" || true)
                  [[ -n "${LATEST_FILE}" ]] && break
                  sleep 3
                done

                if [[ -z "${LATEST_FILE}" ]]; then
                  echo "âš ï¸ æ— å¤‡ä»½æ–‡ä»¶ï¼Œè·³è¿‡è¯¥èŠ‚ç‚¹"
                  continue
                fi

                LOCAL_FILE="${LOCAL_BACKUP_DIR}/$(basename "${LATEST_FILE}")"
                pull_success=0
                for ((i=1; i<=RETRY_TIMES; i++)); do
                  if sudo sshpass -p "${SSH_PASS}" scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
                    "${SSH_USER}@${TARGET_IP}:${LATEST_FILE}" "${LOCAL_FILE}"; then
                    pull_success=1
                    break
                  fi
                  sleep 3
                done

                if [[ ${pull_success} -ne 1 || ! -s "${LOCAL_FILE}" ]]; then
                  echo "âš ï¸ æ‹‰å–å¤±è´¥/æ–‡ä»¶æ— æ•ˆï¼Œè·³è¿‡è¯¥èŠ‚ç‚¹"
                  rm -f "${LOCAL_FILE}" 2>/dev/null || echo "âŒ åˆ é™¤æ— æ•ˆå¤‡ä»½æ–‡ä»¶å¤±è´¥"
                  continue
                fi

                echo -e "\nğŸ—‘ï¸ æ‹‰å–æˆåŠŸï¼Œåˆ é™¤è¿œç¨‹æºæ–‡ä»¶"
                sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
                  "${SSH_USER}@${TARGET_IP}" "sudo rm -f '${LATEST_FILE}'" || echo "âš ï¸ è¿œç¨‹åˆ é™¤å¤‡ä»½æ–‡ä»¶å¤±è´¥"

                echo -e "\nğŸ”§ è§£å‹æ¢å¤åˆ°æ ¹ç›®å½• / â†’ è¦†ç›–æ¨¡å¼"
                sudo tar --zstd -xf "${LOCAL_FILE}" -C / --overwrite --preserve-permissions || echo "âŒ è§£å‹å¤‡ä»½æ–‡ä»¶å¤±è´¥"

                echo -e "\nğŸ” ä¿®å¤ç›®å½•æƒé™"
                for dir in ${PERSONAL_DATA_DIRS}; do
                  [[ -d "${dir}" ]] && sudo chown -R root:root "${dir}" || echo "âŒ ä¿®å¤${dir}ç›®å½•æ‰€æœ‰è€…å¤±è´¥"
                done
                [[ -d "/etc/casaos" ]]     && sudo chmod -R 755 /etc/casaos || echo "âŒ ä¿®å¤/etc/casaosæƒé™å¤±è´¥"
                [[ -d "/DATA" ]]           && sudo chmod -R 755 /DATA || echo "âŒ ä¿®å¤/DATAæƒé™å¤±è´¥"
                [[ -d "/var/lib/casaos" ]] && sudo chmod -R 700 /var/lib/casaos || echo "âŒ ä¿®å¤/var/lib/casaosæƒé™å¤±è´¥"
                [[ -d "/var/lib/docker" ]] && sudo chmod -R 700 /var/lib/docker || echo "âŒ ä¿®å¤/var/lib/dockeræƒé™å¤±è´¥"

                echo -e "\nğŸ‰ è¯¥èŠ‚ç‚¹æ¢å¤æˆåŠŸï¼"
                RESTORE_SUCCESS=1
                break

              done < <(echo "${TARGET_LIST}")

              if [[ ${RESTORE_SUCCESS} -ne 1 ]]; then
                echo -e "\nâŒ æ‰€æœ‰èŠ‚ç‚¹å°è¯•å¤±è´¥ï¼Œæœªæ¢å¤å¤‡ä»½"
              fi
            fi
          fi
          echo "âœ… 6-å¤‡ä»½æ‹‰å–ä¸æ¢å¤æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 7-å¯åŠ¨ Docker & CasaOS
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 7-å¯åŠ¨æ ¸å¿ƒæœåŠ¡ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || echo "âŒ æ€æ­»80/443ç«¯å£å ç”¨å¤±è´¥ï¼ˆå¯èƒ½æ— å ç”¨ï¼‰"
          sudo mkdir -p /run/docker 2>/dev/null || echo "âŒ åˆ›å»º/run/dockerç›®å½•å¤±è´¥"
          sudo systemctl daemon-reload || echo "âŒ é‡è½½systemdå¤±è´¥"
          sudo systemctl enable --now docker containerd && sleep 5 || echo "âŒ å¯åŠ¨Dockerå¤±è´¥"
          sudo systemctl enable --now casaos && sleep 5 || echo "âŒ å¯åŠ¨CasaOSå¤±è´¥"
          echo "âœ… 7-æ ¸å¿ƒæœåŠ¡å¯åŠ¨æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 8-ç¨³å®šè¿è¡Œ1åˆ†é’Ÿ
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 8-ç¨³å®šè¿è¡Œ ${TARGET_RUN_MINUTES} åˆ†é’Ÿ ====="
          sleep 60 || echo "âŒ ç¨³å®šè¿è¡ŒæœŸé—´è¢«ä¸­æ–­"  # æ”¹ä¸º60ç§’ï¼ˆ1åˆ†é’Ÿï¼‰
          echo "âœ… 8-ç¨³å®šè¿è¡Œæ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 9-å®‰å…¨åœæ­¢ä¸šåŠ¡æœåŠ¡ï¼ˆä¿ç•™Tailscaleï¼‰
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 9-åœæ­¢ä¸šåŠ¡æœåŠ¡ ====="
          sudo systemctl stop casaos 2>/dev/null || echo "âŒ åœæ­¢CasaOSå¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
          sudo systemctl stop docker containerd 2>/dev/null || echo "âŒ åœæ­¢Dockerå¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || echo "âŒ åˆ é™¤pidæ–‡ä»¶å¤±è´¥ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰"
          sudo umount /var/lib/docker/overlay2/*/merged 2>/dev/null || echo "âŒ å¸è½½DockeræŒ‚è½½ç›®å½•å¤±è´¥ï¼ˆå¯èƒ½æ— æŒ‚è½½ï¼‰"
          sync && sleep 5
          echo "âœ… 9-ä¸šåŠ¡æœåŠ¡åœæ­¢æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 10-æœ¬åœ°å…¨é‡å¤‡ä»½ï¼ˆä»…4ä¸ªç›®å½•ï¼Œtar.zst å‹ç¼©çº§åˆ«13ï¼‰
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 10-ç”Ÿæˆæœ¬åœ°å…¨é‡å¤‡ä»½ ====="
          sudo mkdir -p "${LOCAL_BACKUP_DIR}" || echo "âŒ åˆ›å»ºæœ¬åœ°å¤‡ä»½ç›®å½•å¤±è´¥"
          DIR_ARRAY=(${PERSONAL_DATA_DIRS})
          for dir in "${DIR_ARRAY[@]}"; do
            [[ ! -d "${dir}" ]] && sudo mkdir -p "${dir}" || echo "âŒ åˆ›å»º${dir}ç›®å½•å¤±è´¥ï¼ˆå·²å­˜åœ¨æˆ–æƒé™ä¸è¶³ï¼‰"
          done

          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_FILE="${LOCAL_BACKUP_DIR}/${SNAP_NAME}"

          # ç®¡é“æ–¹å¼å‹ç¼©ï¼Œé”™è¯¯è®°å½•æ—¥å¿—
          sudo tar -cf - --ignore-failed-read "${DIR_ARRAY[@]}" | sudo zstd -13 -o "${LOCAL_FILE}" || echo "âŒ å¤‡ä»½å‹ç¼©å¤±è´¥"

          if [[ -f "${LOCAL_FILE}" && -s "${LOCAL_FILE}" ]]; then
            echo "âœ… å¤‡ä»½å®Œæˆï¼š${SNAP_NAME}"
            echo "BACKUP_FILE=${LOCAL_FILE}" >> "${GITHUB_ENV}"
            echo "SNAP_NAME=${SNAP_NAME}" >> "${GITHUB_ENV}"
          else
            echo "âŒ å¤‡ä»½æ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–ä¸ºç©º"
          fi
          echo "âœ… 10-æœ¬åœ°å¤‡ä»½æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 11-è§¦å‘ä¸‹ä¸€è½®ç»­è·‘
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 11-è§¦å‘ä¸‹ä¸€è½®ç»­è·‘ ====="
          if [[ -z "${USER_PAT:-}" || -z "${REPO:-}" ]]; then
            echo "âš ï¸ æœªé…ç½® PAT/REPOï¼Œè·³è¿‡ç»­è·‘è§¦å‘"
          else
            response=$(curl -s -w "%{http_code}" -o /dev/null -X POST \
              --connect-timeout 10 --max-time 15 \
              -H "Authorization: token ${USER_PAT}" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/${REPO}/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}')
            if [[ "${response}" == "204" ]]; then
              echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ"
            else
              echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥ï¼ŒHTTP code: ${response}"
            fi
          fi
          echo "âœ… 11-ç»­è·‘è§¦å‘æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 12-ç§»å…¥/aaaå¹¶æ— é™è½®è¯¢æ£€æµ‹åˆ é™¤
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 12-å¤‡ä»½ç§»å…¥/aaa + è½®è¯¢åˆ é™¤æ£€æµ‹ ====="
          if [[ -z "${BACKUP_FILE:-}" || -z "${SNAP_NAME:-}" ]]; then
            echo "â„¹ï¸ æ— æœ‰æ•ˆå¤‡ä»½æ–‡ä»¶ï¼Œè·³è¿‡ç§»å…¥ä¸è½®è¯¢"
          else
            LOCAL_AAA="/aaa"
            sudo mkdir -p "${LOCAL_AAA}" || echo "âŒ åˆ›å»º/aaaç›®å½•å¤±è´¥"
            # æ£€æŸ¥å¹¶ä¿®å¤æƒé™
            if [[ ! -w "${LOCAL_AAA}" ]]; then
              echo "âš ï¸ /aaaç›®å½•æ— å†™å…¥æƒé™ï¼Œå°è¯•ä¿®å¤"
              sudo chmod 775 "${LOCAL_AAA}" || echo "âŒ ä¿®å¤/aaaæƒé™å¤±è´¥"
            fi

            TARGET_FILE="${LOCAL_AAA}/${SNAP_NAME}"
            sudo mv -v "${BACKUP_FILE}" "${TARGET_FILE}" || echo "âŒ å¤‡ä»½æ–‡ä»¶ç§»å…¥/aaaå¤±è´¥"

            echo -e "\nâŒ› æ¯1åˆ†é’Ÿæ£€æµ‹æ–‡ä»¶æ˜¯å¦è¢«åˆ é™¤ï¼ˆæœ€å¤š${MAX_POLL_TIMES}æ¬¡ï¼‰"
            poll_count=0
            echo "è°ƒè¯•ï¼šåˆå§‹poll_count=${poll_count}, MAX_POLL_TIMES=${MAX_POLL_TIMES}, TARGET_FILE=${TARGET_FILE}"
            
            while true; do
              if [[ ! -f "${TARGET_FILE}" ]]; then
                echo "ğŸ‰ æ–‡ä»¶å·²åˆ é™¤ï¼Œé€€å‡ºè½®è¯¢"
                break
              fi
              ((poll_count++)) || true
              
              if [[ -z "${MAX_POLL_TIMES}" ]]; then
                echo "âš ï¸ MAX_POLL_TIMESæœªé…ç½®ï¼Œé»˜è®¤è®¾ä¸º360"
                MAX_POLL_TIMES=360
              fi
              if [[ ${poll_count} -ge ${MAX_POLL_TIMES} ]]; then
                echo "âš ï¸ è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œè‡ªåŠ¨é€€å‡º"
                break
              fi
              
              echo "â†’ ${poll_count}/${MAX_POLL_TIMES} æ–‡ä»¶å­˜åœ¨ï¼Œ60ç§’åé‡è¯•"
              sleep 60 || echo "âŒ è½®è¯¢ç¡çœ è¢«ä¸­æ–­"
            done
          fi
          echo "âœ… 12-ç§»å…¥ä¸è½®è¯¢æ£€æµ‹æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"

      - name: 13-æœ€ç»ˆæ¸…ç†+å…³é—­Tailscale
        if: ${{ always() }}
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 13-æœ€ç»ˆæ¸…ç† + å…³é—­Tailscale ====="
          sudo systemctl stop tailscaled 2>/dev/null || echo "âŒ åœæ­¢tailscaledå¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
          sudo rm -rf "${LOCAL_BACKUP_DIR:-}" /tmp/* 2>/dev/null || echo "âŒ æ¸…ç†æœ¬åœ°å¤‡ä»½ç›®å½•ä¸ä¸´æ—¶æ–‡ä»¶å¤±è´¥"
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || echo "âŒ åˆ é™¤rootsç”¨æˆ·sudoé…ç½®å¤±è´¥ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰"
          sudo apt autoremove -y -qq || echo "âŒ è‡ªåŠ¨å¸è½½ä¾èµ–å¤±è´¥"
          sudo apt clean -y -qq || echo "âŒ æ¸…ç†aptç¼“å­˜å¤±è´¥"
          sudo rm -rf /var/cache/apt/* 2>/dev/null || echo "âŒ æ¸…ç†aptç¼“å­˜æ–‡ä»¶å¤±è´¥"
          echo "âœ… 13-æœ€ç»ˆæ¸…ç†æ­¥éª¤æ‰§è¡Œå®Œæˆï¼ˆé”™è¯¯å·²è®°å½•æ—¥å¿—ï¼‰"
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ˆæ‰€æœ‰é”™è¯¯å·²è®°å½•æ—¥å¿—ï¼Œæœªç»ˆæ­¢æµç¨‹ï¼‰"