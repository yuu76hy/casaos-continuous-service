name: Docker-å¿«ç…§-å¤‡ä»½-æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_docker_snapshot]

jobs:
  docker_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu"
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/systemd/system /DATA"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/var/lib/docker/tmp
        --exclude=/DATA/tmp --exclude=/DATA/ç¼“å­˜ --exclude=/DATA/æ—¥å¿—
        --exclude=/etc/systemd/system/*.wants
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: 1. ç¯å¢ƒåˆå§‹åŒ–ï¼ˆæµ·å¤–æœåŠ¡å™¨ï¼‰
        run: |
          set -e
          sudo mkdir -p /etc/systemd/system 2>/dev/null || true
          
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak 2>/dev/null || true
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb http://archive.ubuntu.com/ubuntu/ noble main universe
          deb http://archive.ubuntu.com/ubuntu/ noble-updates main universe
          deb http://archive.ubuntu.com/ubuntu/ noble-security main universe
          deb http://archive.ubuntu.com/ubuntu/ noble-backports main universe
          EOF
          
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl dnsutils apt-transport-https ca-certificates gnupg lsb-release file lsof
          sudo locale-gen zh_CN.UTF-8 && export LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          
          curl -fsSL https://rclone.org/install.sh | sudo bash
          
          if grep -q "requiretty" /etc/sudoers 2>/dev/null; then
            sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          fi
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner && sudo mkdir -p /DATA && sudo chmod 755 /DATA
          
          echo "âœ…æ£€æŸ¥ç½‘ç»œè¿æ¥......"
          curl -fsSL https://github.com >/dev/null 2>&1 || { echo "âŒæ— æ³•è¿æ¥ GitHub"; exit 1; }
          echo "âœ…ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºæ ¹ç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            echo "roots:${ROOTS_PASSWORD:-$(openssl rand -base64 12)}" | sudo chpasswd
            sudo usermod -aG sudo,docker roots
            echo "âœ… roots ç”¨æˆ·æˆåŠŸåˆ›å»º"
          else
            echo "â„¹ï¸ roots ç”¨æˆ·å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: 3. é…ç½® WebDAVï¼ˆRcloneï¼‰
        id: webdav-config
        run: |
          set -e
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒç¼ºå°‘WebDAVå‡­è¯ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="generic" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAV è¿æ¥å¤±è´¥"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          WEBDAV_SNAPSHOT_DIR_CLEAN=$(echo "$WEBDAV_SNAPSHOT_DIR" | sed 's/\/$//')
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN} --config /home/runner/.rclone.conf | grep "docker-snapshot-.*.tar.gz" | awk -F '/' '{print $NF}' | sort -r | head -n1)
          
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "latest_snapshot=${WEBDAV_SNAPSHOT_DIR_CLEAN}/${LATEST_SNAPSHOT}" >> "$GITHUB_OUTPUT"
            echo "âœ…æœ€æ–°å¿«ç…§ï¼š$LATEST_SNAPSHOT"
          else
            echo "â„¹ï¸ WebDAV æ²¡æœ‰å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…Docker"
          fi
          echo "webdav_available=true" >> "$GITHUB_OUTPUT"
          echo "WEBDAV_SNAPSHOT_DIR_CLEAN=${WEBDAV_SNAPSHOT_DIR_CLEAN}" >> "$GITHUB_ENV"

      - name: 4. ä» WebDAV æ¢å¤Dockerå¿«ç…§
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' && steps.webdav-config.outputs.latest_snapshot != '' }}
        id: restore
        run: |
          set -e
          SNAPSHOT_PATH=${{ steps.webdav-config.outputs.latest_snapshot }}
          echo "===== æ¢å¤Dockerå¿«ç…§ï¼š$SNAPSHOT_PATH ====="
          
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          sudo pkill -9 docker containerd 2>/dev/null || true
          sync && sleep 3
          
          if ! rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "âŒå¿«ç…§æŸå"
            echo "restore_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          TEMP_SNAPSHOT="/tmp/snapshot.tar.gz"
          rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf > "$TEMP_SNAPSHOT"
          sudo tar -xzf "$TEMP_SNAPSHOT" -C / \
            --overwrite \
            --ignore-failed-read \
            -p \
            --same-owner
          rm -f "$TEMP_SNAPSHOT"
          
          sudo apt purge -y moby* containerd* runc* docker* -y || true
          sudo apt autoremove -y && sudo apt clean
          curl -fsSL https://get.docker.com | sudo bash
          
          rclone delete mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/snapshot_meta.txt --config /home/runner/.rclone.conf
          
          echo "âœ…Dockerå¿«ç…§å·²æˆåŠŸæ¢å¤"
          echo "restore_success=true" >> "$GITHUB_OUTPUT"

      - name: 5. æ¸…ç†Dockeræ®‹ç•™ç‰©ï¼ˆæ¢å¤å¤±è´¥ï¼‰
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== æ¸…ç†Dockeræ®‹ç•™ç‰© ====="
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo pkill -9 docker containerd 2>/dev/null || true
          sync && sleep 3
          
          if sudo docker info >/dev/null 2>&1; then
            sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true
            sudo docker rmi -f $(sudo docker images -aq) 2>/dev/null || true
            sudo docker volume rm -f $(sudo docker volume ls -q) 2>/dev/null || true
          fi
          
          sudo apt purge -y docker* moby* containerd* runc* -y || true
          sudo apt autoremove -y && sudo apt clean
          sudo rm -rf /var/lib/docker /etc/docker /var/lib/containerd /DATA/*
          echo "âœ…Dockeræ®‹ç•™ç‰©æ¸…ç†å®Œæˆ"

      - name: 6. å…¨æ–°å®‰è£…Dockerï¼ˆæ— å¿«ç…§/æ¢å¤å¤±è´¥ï¼‰
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…Docker ====="
          sudo apt purge -y docker* moby* containerd* runc* -y || true
          sudo apt autoremove -y && sudo apt clean
          
          curl -fsSL https://get.docker.com | sudo bash
          
          sudo usermod -aG docker runner
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          sudo systemctl enable --now docker.service containerd.service
          sleep 10
          
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Docker å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          echo "âœ… Docker å·²å®‰è£…å®Œæˆï¼š$(docker -v)"

      - name: 7. é‡å¯DockeræœåŠ¡ï¼ˆæ¢å¤æˆåŠŸï¼‰
        if: ${{ steps.restore.outputs.restore_success == 'true' }}
        run: |
          set -e
          echo "===== é‡å¯DockeræœåŠ¡ ====="
          
          for service in docker.service containerd.service; do
            if sudo systemctl list-unit-files --type=service | grep -q "$service"; then
              sudo systemctl reset-failed "$service" 2>/dev/null || true
            fi
          done
          sudo systemctl daemon-reload && sleep 15
          sudo systemctl enable --now containerd.service 2>/dev/null || true && sleep 3
          sudo systemctl enable --now docker.service 2>/dev/null || true && sleep 10
          
          echo "=====å¯åŠ¨å‰æ£€æŸ¥===="
          for port in 2375 2376 7946 4789; do
            if sudo lsof -i:$port -t >/dev/null; then
              echo "âš ï¸ $portç«¯å£å·²è¢«å ç”¨ï¼Œæ­£åœ¨ç»ˆæ­¢è¿›ç¨‹"
              sudo kill -9 $(sudo lsof -i:$port -t) 2>/dev/null || true
            fi
          done
          
          sudo chown -R root:root /var/lib/docker /etc/docker
          sudo chmod -R 755 /var/lib/docker /etc/docker
          sudo chmod 775 /DATA 2>/dev/null || true
          
          sudo systemctl restart docker containerd
          sleep 5
          
          echo "=====æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€===="
          docker_active=false
          for retry in {1..5}; do
            if sudo systemctl is-active --quiet docker; then
              docker_active=true
              break
            fi
            echo "â„¹ï¸ Dockeræœªæ¿€æ´»ï¼Œé‡è¯•$retry/5......"
            sudo systemctl reset-failed docker 2>/dev/null || true
            sudo systemctl restart docker
            sleep 8
          done
          
          if [ "$docker_active" = "false" ]; then
            echo "âš ï¸ Dockerå¯åŠ¨å¤±è´¥ï¼Œé‡æ–°å®‰è£…"
            curl -fsSL https://get.docker.com | sudo bash
            sudo systemctl daemon-reload
            sleep 10
            
            if ! sudo systemctl is-active --quiet docker; then
              echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œè°ƒè¯•ä¿¡æ¯ï¼š"
              echo "--- DockeræœåŠ¡çŠ¶æ€---"
              sudo systemctl status docker --no-pager
              echo "--- Dockeræœ€æ–°æ—¥å¿—---"
              sudo journalctl -u docker --no-pager | tail -30
              exit 1
            fi
          fi
          echo "âœ…DockeræœåŠ¡å·²æˆåŠŸé‡å¯"

      - name: 8. éƒ¨ç½²Tailscaleï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ç¼ºå°‘Tailscaleæˆæƒå¯†é’¥ï¼Œè·³è¿‡"
            exit 0
          fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y && sudo apt install -y tailscale
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="docker-snapshot-${{ github.run_id }}"
          echo "âœ… Tailscale IPï¼š$(sudo tailscale ip -4)"

      - name: 9. åˆ›å»ºDockerå¿«ç…§ + ä¸Šä¼  WebDAV + è§¦å‘æ›´æ–°
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' }}
        run: |
          set -e
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          stop_old_containers() {
            if sudo docker info >/dev/null 2>&1; then
              OLD_CONTAINERS=$(sudo docker ps -aq)
              if [ -n "$OLD_CONTAINERS" ]; then
                sudo docker rm -f $OLD_CONTAINERS && echo "âœ…ç»­è·‘æˆåŠŸï¼Œæ—§å®¹å™¨å·²æ¸…ç†"
              else
                echo "â„¹ï¸ç»­è·‘æˆåŠŸï¼Œæ— æ—§å®¹å™¨å¯æ¸…ç†"
              fi
            else
                echo "â„¹ï¸Dockeræœªå°±ç»ªï¼Œè·³è¿‡æ—§å®¹å™¨æ¸…ç†"
            fi
          }
          
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒç¼ºå°‘PAT/ä»“åº“ä¿¡æ¯ï¼Œè§¦å‘ç»­è·‘å¤±è´¥"
              return 1
            fi
            if curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_docker_snapshot"}'; then
              echo "âœ…ç»­è·‘å·²æˆåŠŸè§¦å‘"
              RENEW_TRIGGERED=true
              stop_old_containers
            else
              echo "âŒç»­è·‘è§¦å‘å¤±è´¥ï¼Œä¸æ‰§è¡Œæ—§å®¹å™¨æ¸…ç†"
              return 1
            fi
          }
          
          create_snapshot() {
            VALID_DIRS=""
            for dir in $CORE_BACKUP_DIRS; do
              if [ -d "$dir" ] || [ -f "$dir" ]; then
                VALID_DIRS="$VALID_DIRS $dir"
              else
                echo "â„¹ï¸è·³è¿‡ä¸å­˜åœ¨çš„è·¯å¾„ï¼š$dir"
              fi
            done
            if [ -z "$VALID_DIRS" ]; then
              echo "âŒæ— æœ‰æ•ˆå¤‡ä»½è·¯å¾„"
              return 1
            fi
              
            SNAPSHOT_NAME="docker-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/$SNAPSHOT_NAME"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/$SNAPSHOT_NAME"
              
            sudo systemctl stop docker containerd 2>/dev/null || true
            sudo pkill -9 docker containerd 2>/dev/null || true
            sync && sleep 5
              
            sudo tar -czpf "$TMP_SNAPSHOT" \
              --ignore-failed-read \
              -p \
              --same-owner \
              --acls \
              --xattrs \
              $EXCLUDE_RULES \
              $VALID_DIRS || { echo "âŒå‹ç¼©å¤±è´¥"; return 1; }
              
            if [ $(stat -c%s "$TMP_SNAPSHOT") -lt 1024 ]; then
              echo "âŒæ— æ•ˆå¿«ç…§ï¼ˆæ–‡ä»¶è¿‡å°ï¼‰"
              rm -f "$TMP_SNAPSHOT"
              return 1
            fi
            sudo chown runner:runner "$TMP_SNAPSHOT"
              
            if ! sudo -u runner rclone copy "$TMP_SNAPSHOT" "$REMOTE_PATH" --config /home/runner/.rclone.conf --transfers 4; then
              echo "âŒä¸Šä¼ å¤±è´¥"
              rm -f "$TMP_SNAPSHOT"
              return 1
            fi
              
            printf "snapshot_name=%s\ncreate_time=%s\nsnapshot_size=%s\ndocker_version=%s\n" \
              "$SNAPSHOT_NAME" \
              "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              "$(du -sh "$TMP_SNAPSHOT" | awk '{print $1}')" \
              "$(docker -v 2>/dev/null | awk '{print $3}' | sed 's/,//g')" | sudo tee /tmp/snapshot_meta.txt
            sudo -u runner rclone copy /tmp/snapshot_meta.txt "mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/snapshot_meta.txt" --config /home/runner/.rclone.conf
              
            rm -f "$TMP_SNAPSHOT" /tmp/snapshot_meta.txt
            sudo systemctl start docker containerd 2>/dev/null || true
            echo "âœ…Dockerå¿«ç…§å·²åˆ›å»ºå¹¶æˆåŠŸä¸Šä¼ "
            return 0
          }
          
          # ğŸ”¥æ ¸å¿ƒä¿®æ”¹ï¼šè§¦å‘é˜ˆå€¼ä»2åˆ†é’Ÿæ”¹ä¸º10åˆ†é’Ÿï¼Œå…¶ä½™ä¸å˜
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "â±ï¸è¿è¡Œæ—¶é—´ï¼š$run_mins / $MAX_RUN_MINUTES åˆ†é’Ÿï¼ˆ10åˆ†é’Ÿåæ‰§è¡Œå¤‡ä»½+ç»­è·‘ï¼‰"
              
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â°å·²è¿è¡Œ10åˆ†é’Ÿï¼Œå¼€å§‹æ‰§è¡Œå¤‡ä»½+ç»­è·‘"
              create_snapshot && trigger_renew
            fi
              
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸è¶…æ—¶ï¼Œé€€å‡º"
              exit 0
            fi
            sleep 60
          done

      - name: 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          sudo rm -rf /tmp/docker-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          echo "âœ…ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
