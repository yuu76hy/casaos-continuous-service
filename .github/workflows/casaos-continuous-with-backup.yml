# CasaOS + Tailscale è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥ä½œæµ
# æ”¯æŒæ‰‹åŠ¨è§¦å‘/APIç»­æœŸè§¦å‘ï¼Œé›†æˆWebDAVå¤‡ä»½/æ¢å¤ã€è‡ªåŠ¨ç»­æœŸåŠŸèƒ½
name: CasaOS-Tailscale-ç®€å•éƒ¨ç½²

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆGitHubé¡µé¢ç‚¹å‡»è¿è¡Œï¼‰
  repository_dispatch:
    types: [renew_casaos_tailscale]  # APIè§¦å‘ç»­æœŸ

jobs:
  deploy-casaos:
    runs-on: ubuntu-24.04
    timeout-minutes: 360  # æœ€å¤§è¿è¡Œæ—¶é•¿6å°æ—¶
    
    env:
      # æ ¸å¿ƒé…ç½®
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /mnt/webdav
      WEBDAV_REMOTE_PATH: /z/Ubu
      
      # å¤‡ä»½é…ç½®
      BACKUP_COMPRESSION: zstd  # å‹ç¼©æ ¼å¼ï¼šzstdï¼ˆé«˜æ•ˆï¼‰/gzï¼ˆé€šç”¨ï¼‰
      SNAPSHOT_RETENTION: 3     # ä¿ç•™æœ€æ–°3ä¸ªå¿«ç…§
      
      # è°ƒè¯•é…ç½®ï¼ˆæ•æ„Ÿä¿¡æ¯ç§»è‡³Secretsï¼‰
      DEBUG_USER: roots
      
      # æŒ‚è½½é…ç½®
      MAX_MOUNT_RETRIES: 3
      RETRY_DELAY: 15

    steps:
      - name: æ­¥éª¤1 - ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        run: |
          echo "===== æ­¥éª¤1: ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ====="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt update -y
          sudo apt install -y curl wget git jq tar gzip zstd rsync fuse3 psmisc net-tools iputils-ping ca-certificates lsb-release
          
          # å®‰è£…rcloneï¼ˆWebDAVæŒ‚è½½å·¥å…·ï¼‰
          echo "å®‰è£… rclone..."
          curl -s https://rclone.org/install.sh | sudo bash
          
          # é…ç½®fuseå…è®¸érootè®¿é—®
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          
          # åˆ›å»ºWebDAVæŒ‚è½½ç‚¹
          sudo mkdir -p ${{ env.WEBDAV_MOUNT_POINT }}
          sudo chmod 777 ${{ env.WEBDAV_MOUNT_POINT }}
          
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      - name: æ­¥éª¤2 - åˆ›å»ºè°ƒè¯•ç”¨æˆ·
        run: |
          echo "===== æ­¥éª¤2: åˆ›å»ºè°ƒè¯•ç”¨æˆ· ====="
          # ä»Secretsè¯»å–å¯†ç ï¼ˆé¿å…ç¡¬ç¼–ç ï¼‰
          DEBUG_PASSWORD="${{ secrets.DEBUG_PASSWORD }}"
          if [ -z "$DEBUG_PASSWORD" ]; then
            echo "âš ï¸ æœªé…ç½®DEBUG_PASSWORDï¼Œä½¿ç”¨é»˜è®¤å¯†ç ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰"
            DEBUG_PASSWORD="roots1234"
          fi
          
          # åˆ›å»º/æ›´æ–°è°ƒè¯•ç”¨æˆ·
          if id "${{ env.DEBUG_USER }}" &>/dev/null; then
            echo "ç”¨æˆ·å·²å­˜åœ¨ï¼Œä¿®æ”¹å¯†ç "
            echo "${{ env.DEBUG_USER }}:$DEBUG_PASSWORD" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "${{ env.DEBUG_USER }}"
            echo "${{ env.DEBUG_USER }}:$DEBUG_PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "${{ env.DEBUG_USER }}"
          fi
          
          echo "âœ… è°ƒè¯•ç”¨æˆ·åˆ›å»ºå®Œæˆ"

      - name: æ­¥éª¤3 - æŒ‚è½½ WebDAVï¼ˆå¸¦é‡è¯•ï¼‰
        id: mount_webdav
        run: |
          echo "===== æ­¥éª¤3: æŒ‚è½½ WebDAV ====="
          # æ ¡éªŒWebDAVå‡­æ®
          WEBDAV_URL="${{ secrets.WEBDAV_URL }}"
          WEBDAV_USER="${{ secrets.WEBDAV_USER }}"
          WEBDAV_PASSWORD="${{ secrets.WEBDAV_PASSWORD }}"
          
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV å‡­æ®æœªé…ç½®ï¼Œè·³è¿‡æŒ‚è½½"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # æ‹¼æ¥å®Œæ•´WebDAV URL
          WEBDAV_FULL_URL="${WEBDAV_URL}${{ env.WEBDAV_REMOTE_PATH }}"
          echo "WebDAVå®Œæ•´URL: $WEBDAV_FULL_URL"
          
          # ç”Ÿæˆrcloneé…ç½®æ–‡ä»¶
          cat > /tmp/rclone.conf <<EOF
[webdav]
type = webdav
url = $WEBDAV_FULL_URL
vendor = other
user = $WEBDAV_USER
pass = $WEBDAV_PASSWORD
EOF
          
          # æµ‹è¯•WebDAVè¿æ¥ï¼ˆå¸¦é‡è¯•ï¼‰
          CONNECT_SUCCESS=false
          for i in $(seq 1 ${{ env.MAX_MOUNT_RETRIES }}); do
            echo "æµ‹è¯•è¿æ¥ï¼ˆç¬¬$iæ¬¡ï¼‰..."
            if rclone lsd webdav: --config=/tmp/rclone.conf; then
              CONNECT_SUCCESS=true
              echo "âœ… WebDAV è¿æ¥æˆåŠŸ"
              break
            fi
            echo "âŒ è¿æ¥å¤±è´¥ï¼Œ${{ env.RETRY_DELAY }}ç§’åé‡è¯•"
            sleep ${{ env.RETRY_DELAY }}
          done
          
          if [ "$CONNECT_SUCCESS" = "false" ]; then
            echo "âŒ WebDAV è¿æ¥å¤±è´¥ï¼ˆé‡è¯•${{ env.MAX_MOUNT_RETRIES }}æ¬¡ï¼‰"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # æŒ‚è½½WebDAVï¼ˆåå°è¿è¡Œï¼‰
          echo "æŒ‚è½½ WebDAV..."
          rclone mount webdav: "${{ env.WEBDAV_MOUNT_POINT }}" \
            --config=/tmp/rclone.conf \
            --vfs-cache-mode writes \
            --allow-other \
            --daemon \
            --log-level INFO \
            --log-file /tmp/rclone.log
          
          # éªŒè¯æŒ‚è½½
          sleep 5
          if mountpoint -q "${{ env.WEBDAV_MOUNT_POINT }}"; then
            echo "âœ… WebDAV æŒ‚è½½æˆåŠŸ"
            echo "WEBDAV_AVAILABLE=true" >> $GITHUB_ENV
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p "${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
          else
            echo "âŒ WebDAV æŒ‚è½½å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: æ­¥éª¤4 - æ™ºèƒ½æ¢å¤ç³»ç»ŸçŠ¶æ€
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          echo "===== æ­¥éª¤4: æ™ºèƒ½æ¢å¤ç³»ç»ŸçŠ¶æ€ ====="
          # æŸ¥æ‰¾æœ€æ–°å¿«ç…§
          find_snapshot() {
            local snapshot_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
            if [ -d "$snapshot_dir" ]; then
              find "$snapshot_dir" -maxdepth 1 -type d -name "2*" 2>/dev/null | sort -r | head -1
            fi
          }
          
          LATEST_SNAPSHOT=$(find_snapshot)
          if [ -n "$LATEST_SNAPSHOT" ] && [ -f "$LATEST_SNAPSHOT/snapshot_info.json" ]; then
            echo "æ‰¾åˆ°æœ€æ–°å¿«ç…§: $(basename $LATEST_SNAPSHOT)"
            SNAPSHOT_INFO=$(cat "$LATEST_SNAPSHOT/snapshot_info.json")
            # ========== ç¬¬97è¡Œä¿®æ­£ä½ç½® ==========
            # åŸé”™è¯¯ï¼šjqå‘½ä»¤çš„å¼•å·/è½¬ä¹‰é—®é¢˜ï¼Œä¿®æ­£ä¸ºæ›´å¥å£®çš„å†™æ³•
            SNAPSHOT_TIME=$(echo "$SNAPSHOT_INFO" | jq -r '.timestamp' 2>/dev/null || echo "æœªçŸ¥")
            # ====================================
            echo "å¿«ç…§æ—¶é—´: $SNAPSHOT_TIME"
            
            # åœæ­¢æœåŠ¡
            sudo systemctl stop casaos docker 2>/dev/null || true
            
            # æ¢å¤å‡½æ•°
            restore_from_tar() {
              local tar_file="$1"
              local target_dir="$2"
              if [ -f "$tar_file" ]; then
                echo "æ¢å¤: $(basename $tar_file)"
                if [[ "$tar_file" == *.zst ]]; then
                  sudo tar -I 'zstd -d' -xf "$tar_file" -C "$target_dir" 2>/dev/null && return 0 || return 1
                elif [[ "$tar_file" == *.gz ]]; then
                  sudo tar -xzf "$tar_file" -C "$target_dir" 2>/dev/null && return 0 || return 1
                fi
              fi
              return 1
            }
            
            # æ¢å¤Dockerå’ŒCasaOSæ•°æ®
            DOCKER_RESTORED=false
            if restore_from_tar "$LATEST_SNAPSHOT/docker_state.tar.${{ env.BACKUP_COMPRESSION }}" "/"; then
              echo "âœ… Docker æ•°æ®æ¢å¤æˆåŠŸ"
              DOCKER_RESTORED=true
            else
              echo "âŒ Docker æ•°æ®æ¢å¤å¤±è´¥"
            fi
            
            CASAOS_RESTORED=false
            if restore_from_tar "$LATEST_SNAPSHOT/casaos_state.tar.${{ env.BACKUP_COMPRESSION }}" "/"; then
              echo "âœ… CasaOS æ•°æ®æ¢å¤æˆåŠŸ"
              CASAOS_RESTORED=true
            else
              echo "âŒ CasaOS æ•°æ®æ¢å¤å¤±è´¥"
            fi
            
            # æ ‡è®°æ¢å¤çŠ¶æ€
            if [ "$DOCKER_RESTORED" = "true" ] || [ "$CASAOS_RESTORED" = "true" ]; then
              echo "âœ… ç³»ç»ŸçŠ¶æ€æ¢å¤å®Œæˆ"
              echo "RESTORED_FROM_BACKUP=true" >> $GITHUB_ENV
            else
              echo "âŒ ç³»ç»ŸçŠ¶æ€æ¢å¤å¤±è´¥"
              echo "RESTORED_FROM_BACKUP=false" >> $GITHUB_ENV
            fi
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…"
            echo "RESTORED_FROM_BACKUP=false" >> $GITHUB_ENV
          fi

      - name: æ­¥éª¤5 - å®‰è£…/æ¢å¤ CasaOS
        run: |
          echo "===== æ­¥éª¤5: å®‰è£… CasaOS ====="
          # åŒºåˆ†æ¢å¤/å…¨æ–°å®‰è£…
          if [ "$RESTORED_FROM_BACKUP" = "true" ]; then
            echo "âœ… ä»å¤‡ä»½æ¢å¤ï¼ŒéªŒè¯ç»„ä»¶..."
            # è¡¥è£…Dockerï¼ˆå¦‚æœç¼ºå¤±ï¼‰
            if ! command -v docker &>/dev/null; then
              echo "ğŸ³ å®‰è£… Docker..."
              curl -fsSL https://get.docker.com | sudo bash
            else
              echo "âœ… Docker å·²å®‰è£…"
            fi
            # è¡¥è£…CasaOSï¼ˆå¦‚æœç¼ºå¤±ï¼‰
            if [ ! -f "/usr/local/bin/casaos" ]; then
              echo "ğŸ  å®‰è£… CasaOS..."
              curl -fsSL https://get.casaos.io | sudo bash
            else
              echo "âœ… CasaOS å·²å®‰è£…"
            fi
          else
            echo "ğŸ†• æ‰§è¡Œå…¨æ–°å®‰è£…..."
            # å®‰è£…Docker
            curl -fsSL https://get.docker.com | sudo bash
            # å®‰è£…CasaOS
            curl -fsSL https://get.casaos.io | sudo bash
          fi
          
          # é‡å¯å¹¶éªŒè¯æœåŠ¡
          sudo systemctl daemon-reload
          sudo systemctl enable docker casaos
          sudo systemctl start docker
          sleep 10
          sudo systemctl start casaos
          
          # æ£€æŸ¥CasaOS Webç•Œé¢æ˜¯å¦å¯ç”¨
          for i in $(seq 1 30); do
            if curl -s http://localhost:80 &>/dev/null; then
              echo "âœ… CasaOS Web ç•Œé¢å¯è®¿é—®"
              break
            fi
            sleep 2
          done
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          echo "ğŸ“Š å®‰è£…éªŒè¯:"
          echo "  ğŸ³ Docker: $(docker --version 2>/dev/null || echo 'æœªå®‰è£…')"
          echo "  ğŸ  CasaOS: $(sudo casaos version 2>/dev/null || echo 'æœªå®‰è£…')"

      - name: æ­¥éª¤6 - éƒ¨ç½² Tailscale
        run: |
          echo "===== æ­¥éª¤6: éƒ¨ç½² Tailscale ====="
          TAILSCALE_AUTH_KEY="${{ secrets.TAILSCALE_AUTH_KEY }}"
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æœªé…ç½® TAILSCALE_AUTH_KEYï¼Œè·³è¿‡ç»„ç½‘"
            echo "TAILSCALE_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # å®‰è£…Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          
          # å¯åŠ¨Tailscaleå¹¶ç»„ç½‘
          sudo tailscale up \
            --authkey="$TAILSCALE_AUTH_KEY" \
            --accept-routes \
            --hostname="casaos-runner-${{ github.run_id }}" \
            --accept-dns=false \
            --reset
          
          # éªŒè¯è¿æ¥
          sleep 5
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "")
          if [ -n "$TAILSCALE_IP" ]; then
            echo "âœ… Tailscale è¿æ¥æˆåŠŸ"
            echo "ğŸŒ Tailscale IP: $TAILSCALE_IP"
            echo "TAILSCALE_CONNECTED=true" >> $GITHUB_ENV
            echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          else
            echo "âŒ Tailscale è¿æ¥å¤±è´¥"
            echo "TAILSCALE_CONNECTED=false" >> $GITHUB_ENV
          fi

      - name: æ­¥éª¤7 - è¾“å‡ºè®¿é—®ä¿¡æ¯
        run: |
          echo "===== æ­¥éª¤7: è®¿é—®ä¿¡æ¯ ====="
          # è·å–IPä¿¡æ¯
          PUBLIC_IP=$(curl -s --max-time 3 https://api.ipify.org || echo "æœªçŸ¥")
          LOCAL_IP=$(hostname -I | awk '{print $1}' 2>/dev/null || echo "æœªçŸ¥")
          DEBUG_PASSWORD="${{ secrets.DEBUG_PASSWORD }}"
          if [ -z "$DEBUG_PASSWORD" ]; then
            DEBUG_PASSWORD="roots1234"
          fi
          
          # è¾“å‡ºè®¿é—®ä¿¡æ¯
          echo "========================================"
          echo "ğŸ‰ CasaOS éƒ¨ç½²å®Œæˆ"
          echo "========================================"
          echo ""
          echo "ğŸŒ å…¬ç½‘è®¿é—®: http://$PUBLIC_IP"
          echo "ğŸ  æœ¬åœ°è®¿é—®: http://$LOCAL_IP"
          echo ""
          if [ "$TAILSCALE_CONNECTED" = "true" ]; then
            echo "ğŸ”’ Tailscale è®¿é—®:"
            echo "  http://$TAILSCALE_IP"
            echo "  http://casaos-runner-${{ github.run_id }}.tailscale"
            echo ""
          fi
          echo "ğŸ”§ ç®¡ç†è®¿é—®:"
          echo "  SSH: ssh ${{ env.DEBUG_USER }}@$LOCAL_IP"
          echo "  å¯†ç : $DEBUG_PASSWORD"
          echo ""
          echo "ğŸ“Š ç³»ç»ŸçŠ¶æ€:"
          echo "  ğŸ³ Docker: $(systemctl is-active docker 2>/dev/null || echo 'unknown')"
          echo "  ğŸ  CasaOS: $(systemctl is-active casaos 2>/dev/null || echo 'unknown')"
          echo "  ğŸ’¾ æ•°æ®æ¥æº: $([ \"$RESTORED_FROM_BACKUP\" = \"true\" ] && echo 'ä»å¤‡ä»½æ¢å¤' || echo 'å…¨æ–°å®‰è£…')"
          echo "  â° å¤‡ä»½è®¡åˆ’: 300åˆ†é’Ÿæ—¶æ‰§è¡Œå®Œæ•´å¤‡ä»½"
          echo ""
          echo "âš ï¸ é‡è¦æç¤º:"
          echo "  1. ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
          echo "  2. é€šè¿‡ Tailscale è®¿é—®æ›´å®‰å…¨"
          echo "========================================"

      - name: æ­¥éª¤8 - è‡ªåŠ¨å¤‡ä»½ä¸å·¥ä½œæµç»­æœŸ
        run: |
          echo "===== æ­¥éª¤8: å®Œæ•´å¤‡ä»½ä¸ç»­æœŸ ====="
          START_TIME=$(date +%s)
          BACKUP_DONE=false
          
          # å…¨é‡å¤‡ä»½å‡½æ•°
          full_backup() {
            local timestamp=$(date +%Y%m%d_%H%M%S)
            local backup_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots/$timestamp"
            echo "ğŸ’¾ æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼ˆæ—¶é—´æˆ³: $timestampï¼‰..."
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p "$backup_dir"
            
            # åœæ­¢æœåŠ¡
            echo "â¸ï¸ åœæ­¢ Docker å’Œ CasaOS æœåŠ¡..."
            sudo systemctl stop casaos docker 2>/dev/null || true
            sleep 5
            
            # å¤‡ä»½Dockeræ•°æ®ï¼ˆæ’é™¤æ—¥å¿—/ç¼“å­˜ï¼‰
            echo "ğŸ³ å¤‡ä»½ Docker æ•°æ®..."
            if [ "${{ env.BACKUP_COMPRESSION }}" = "zstd" ]; then
              sudo tar -I 'zstd -T0 -3' -cf "$backup_dir/docker_state.tar.zst" \
                /var/lib/docker /etc/docker \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" --exclude="/var/lib/docker/tmp" 2>/dev/null
            else
              sudo tar -czf "$backup_dir/docker_state.tar.gz" \
                /var/lib/docker /etc/docker \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" --exclude="/var/lib/docker/tmp" 2>/dev/null
            fi
            
            # å¤‡ä»½CasaOSæ•°æ®
            echo "ğŸ  å¤‡ä»½ CasaOS æ•°æ®..."
            if [ "${{ env.BACKUP_COMPRESSION }}" = "zstd" ]; then
              sudo tar -I 'zstd -T0 -3' -cf "$backup_dir/casaos_state.tar.zst" \
                /var/lib/casaos /etc/casaos /usr/local/bin/casaos* \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" 2>/dev/null
            else
              sudo tar -czf "$backup_dir/casaos_state.tar.gz" \
                /var/lib/casaos /etc/casaos /usr/local/bin/casaos* \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" 2>/dev/null
            fi
            
            # é‡å¯æœåŠ¡
            echo "â–¶ï¸ é‡æ–°å¯åŠ¨æœåŠ¡..."
            sudo systemctl start docker
            sleep 5
            sudo systemctl start casaos
            
            # åˆ›å»ºæ¢å¤è„šæœ¬
            cat > "$backup_dir/restore.sh" <<'RESTORE_EOF'
#!/bin/bash
echo "å¼€å§‹æ¢å¤ CasaOS ç³»ç»Ÿ..."
# æ¢å¤CasaOSæ•°æ®
if [ -f "casaos_state.tar.gz" ]; then
  sudo tar -xzf casaos_state.tar.gz -C / 2>/dev/null && echo "âœ… CasaOS(gz) æ¢å¤å®Œæˆ"
fi
if [ -f "casaos_state.tar.zst" ]; then
  sudo tar -I 'zstd -d' -xf casaos_state.tar.zst -C / 2>/dev/null && echo "âœ… CasaOS(zstd) æ¢å¤å®Œæˆ"
fi
# æ¢å¤Dockeræ•°æ®
if [ -f "docker_state.tar.gz" ]; then
  sudo tar -xzf docker_state.tar.gz -C / 2>/dev/null && echo "âœ… Docker(gz) æ¢å¤å®Œæˆ"
fi
if [ -f "docker_state.tar.zst" ]; then
  sudo tar -I 'zstd -d' -xf docker_state.tar.zst -C / 2>/dev/null && echo "âœ… Docker(zstd) æ¢å¤å®Œæˆ"
fi
echo "ğŸ“Œ æ¢å¤å®Œæˆï¼Œå»ºè®®é‡å¯æœåŠ¡: sudo systemctl restart docker casaos"
RESTORE_EOF
            chmod +x "$backup_dir/restore.sh"
            
            # åˆ›å»ºå¿«ç…§ä¿¡æ¯æ–‡ä»¶
            cat > "$backup_dir/snapshot_info.json" <<EOF
{
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "type": "full_backup",
  "runner_id": "${{ github.run_id }}",
  "components": {
    "docker": true,
    "casaos": true
  },
  "system_info": {
    "distro": "$(lsb_release -ds 2>/dev/null | sed 's/"/\\"/g' || echo "unknown")",
    "kernel": "$(uname -r)",
    "arch": "$(uname -m)"
  }
}
EOF
            
            # éªŒè¯å¤‡ä»½æ–‡ä»¶
            if [ -f "$backup_dir/docker_state.tar.${{ env.BACKUP_COMPRESSION }}" ] && [ -f "$backup_dir/casaos_state.tar.${{ env.BACKUP_COMPRESSION }}" ]; then
              echo "âœ… å…¨é‡å¤‡ä»½å®Œæˆ: $backup_dir"
              return 0
            else
              echo "âŒ å¤‡ä»½æ–‡ä»¶éªŒè¯å¤±è´¥"
              return 1
            fi
          }
          
          # æ¸…ç†æ—§å¤‡ä»½å‡½æ•°
          cleanup_old_backups() {
            local snapshot_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
            if [ -d "$snapshot_dir" ]; then
              echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€æ–°${{ env.SNAPSHOT_RETENTION }}ä¸ªï¼‰..."
              ls -1t "$snapshot_dir" 2>/dev/null | tail -n +$(( ${{ env.SNAPSHOT_RETENTION }} + 1 )) | while read old_snap; do
                if [ -n "$old_snap" ]; then
                  echo "åˆ é™¤æ—§å¿«ç…§: $old_snap"
                  rm -rf "$snapshot_dir/$old_snap"
                fi
              done
            fi
          }
          
          # è§¦å‘å·¥ä½œæµç»­æœŸå‡½æ•°
          trigger_renewal() {
            USER_PAT="${{ secrets.USER_PAT }}"
            REPO="${{ github.repository }}"
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ æœªé…ç½®USER_PATï¼Œæ— æ³•è§¦å‘ç»­æœŸ"
              return 1
            fi
            
            echo "ğŸ”„ è§¦å‘å·¥ä½œæµç»­æœŸ..."
            for i in 1 2 3; do
              response=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: token $USER_PAT" \
                "https://api.github.com/repos/$REPO/dispatches" \
                -d '{"event_type": "renew_casaos_tailscale"}')
              if [ "$response" = "204" ]; then
                echo "âœ… ç»­æœŸè§¦å‘æˆåŠŸï¼ˆæ–°å·¥ä½œæµå·²å¯åŠ¨ï¼‰"
                return 0
              fi
              echo "âš ï¸ ç»­æœŸè§¦å‘å¤±è´¥ï¼ˆç¬¬$iæ¬¡ï¼‰ï¼Œ10ç§’åé‡è¯•"
              sleep 10
            done
            echo "âŒ ç»­æœŸè§¦å‘å¤±è´¥ï¼ˆé‡è¯•3æ¬¡ï¼‰"
            return 1
          }
          
          # ä¸»å¾ªç¯ï¼šè¿è¡Œè‡³è¶…æ—¶ï¼Œ300åˆ†é’Ÿæ—¶æ‰§è¡Œå¤‡ä»½
          echo "â° å¼€å§‹ç›‘æ§è¿è¡Œæ—¶é•¿ï¼ˆæœ€å¤§${{ env.MAX_RUN_MINUTES }}åˆ†é’Ÿï¼‰..."
          while true; do
            CURRENT_TIME=$(date +%s)
            RUN_MINUTES=$(( (CURRENT_TIME - START_TIME) / 60 ))
            REMAINING_MINUTES=$(( ${{ env.MAX_RUN_MINUTES }} - RUN_MINUTES ))
            
            echo "â±ï¸  å·²è¿è¡Œ: ${RUN_MINUTES}åˆ†é’Ÿ | å‰©ä½™: ${REMAINING_MINUTES}åˆ†é’Ÿ"
            
            # 300åˆ†é’Ÿæ—¶æ‰§è¡Œå¤‡ä»½ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰
            if [ $RUN_MINUTES -ge 300 ] && [ "$BACKUP_DONE" = "false" ]; then
              echo "ğŸš¨ åˆ°è¾¾300åˆ†é’Ÿï¼Œæ‰§è¡Œå…¨é‡å¤‡ä»½..."
              if full_backup; then
                cleanup_old_backups
                trigger_renewal
                BACKUP_DONE=true
              else
                echo "âŒ é¦–æ¬¡å¤‡ä»½å¤±è´¥ï¼Œ30ç§’åé‡è¯•..."
                sleep 30
                if full_backup; then
                  cleanup_old_backups
                  trigger_renewal
                  BACKUP_DONE=true
                else
                  echo "âŒ é‡è¯•å¤‡ä»½ä»å¤±è´¥ï¼Œè·³è¿‡ç»­æœŸ"
                  BACKUP_DONE=true
                fi
              fi
            fi
            
            # è¶…æ—¶é€€å‡º
            if [ $RUN_MINUTES -ge ${{ env.MAX_RUN_MINUTES }} ]; then
              echo "â¹ï¸ åˆ°è¾¾æœ€å¤§è¿è¡Œæ—¶é•¿ï¼ˆ${{ env.MAX_RUN_MINUTES }}åˆ†é’Ÿï¼‰ï¼Œé€€å‡º"
              exit 0
            fi
            
            # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            sleep 60
          done

      - name: æ­¥éª¤9 - æ¸…ç†ç¯å¢ƒï¼ˆæ— è®ºæˆè´¥ï¼‰
        if: always()
        run: |
          echo "===== æ­¥éª¤9: æ¸…ç†ç¯å¢ƒ ====="
          # å¸è½½WebDAV
          fusermount -u "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null || sudo umount "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null || true
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* /var/tmp/*
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"
