name: CasaOS-å®Œæ•´å¤‡ä»½æ¢å¤è¿ç§»ï¼ˆå«æ ¹ç”¨æˆ·+ç»„ç½‘ï¼‰

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-full-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu/CasaOS-Backup"
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /run/docker.sock /usr/lib/systemd/system/docker.service /etc/systemd/system/docker.service.d /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/local/bin/casaos /usr/lib/systemd/system/casaos.service /etc/systemd/system/casaos.service /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
    secrets:
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASS: ${{ secrets.WEBDAV_PASSWORD }}
      ROOT_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      GITHUB_USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      GITHUB_REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–&ä¾èµ–å…¨é‡å®‰è£…ï¼ˆåŸºç¡€å¿…å¤‡ï¼‰
        run: |
          set -e
          echo "===== å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå®‰è£…æ‰€æœ‰ä¾èµ– ====="
          sudo apt update -y && sudo apt upgrade -y -qq
          sudo apt install -y curl wget jq fuse3 tar gzip bzip2 locales openssl ca-certificates apt-transport-https sshpass net-tools iputils-ping
          # é…ç½®ä¸­æ–‡ç¼–ç ï¼Œé¿å…ä¹±ç 
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # å®‰è£…rcloneï¼ˆWebDAVä¼ è¾“å¿…å¤‡ï¼‰
          curl https://rclone.org/install.sh | sudo bash -s -- -q
          # å®‰è£…dockerï¼ˆCasaOSä¾èµ–ï¼Œæå‰é¢„è£…å…œåº•ï¼‰
          if ! command -v docker &>/dev/null; then
            sudo apt install -y docker.io docker-compose-plugin
            sudo systemctl enable docker
          fi
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰ä¾èµ–å®‰è£…å°±ç»ª"

      - name: 2-åˆ›å»ºæ ¹æƒé™ç”¨æˆ·ï¼ˆå®Œæ•´æƒé™ï¼Œè¿œç¨‹ç®¡ç†å¿…å¤‡ï¼‰
        run: |
          set -e
          echo "===== å¼€å§‹åˆ›å»ºæ ¹æƒé™ç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»º
          if id -u "$USER_NAME" >/dev/null 2>&1; then
            echo "âœ… $USER_NAMEç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            # åˆ›å»ºç”¨æˆ·ï¼Œå®¶ç›®å½•+bashç»ˆç«¯
            sudo useradd -m -s /bin/bash "$USER_NAME"
            echo "âœ… $USER_NAMEç”¨æˆ·åˆ›å»ºæˆåŠŸ"
          fi
          # è®¾ç½®ç”¨æˆ·å¯†ç ï¼ˆä¼˜å…ˆç”¨secreté…ç½®ï¼Œæ— åˆ™ç”Ÿæˆéšæœºå¯†ç ï¼‰
          if [ -n "${{ secrets.ROOTS_PASSWORD }}" ]; then
            echo "$USER_NAME:${{ secrets.ROOTS_PASSWORD }}" | sudo chpasswd
            echo "âœ… $USER_NAMEç”¨æˆ·å¯†ç å·²é…ç½®ï¼ˆè‡ªå®šä¹‰å¯†ç ï¼‰"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "âœ… $USER_NAMEç”¨æˆ·å¯†ç å·²é…ç½®ï¼ˆéšæœºå¯†ç ï¼‰ï¼š$RANDOM_PASS"
          fi
          # èµ‹äºˆå…å¯†sudoæƒé™ï¼ˆå®Œæ•´æ ¹æƒé™ï¼‰
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME"
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          # åŠ å…¥dockerç»„ï¼Œå…sudoæ“ä½œdocker
          sudo usermod -aG docker "$USER_NAME"
          # ä¿®å¤å®¶ç›®å½•æƒé™
          sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          sudo chmod 755 /home/"$USER_NAME"
          echo "âœ… æ ¹æƒé™ç”¨æˆ·é…ç½®å®Œæˆï¼šç”¨æˆ·å=$USER_NAMEï¼Œæƒé™=å…å¯†sudo+dockerç®¡ç†"

      - name: 3-Rcloneé…ç½®&WebDAVè¿é€šæ€§æ ¡éªŒï¼ˆå¤‡ä»½æ¢å¤åŸºç¡€ï¼‰
        run: |
          set -e
          echo "===== é…ç½®Rcloneï¼Œæ ¡éªŒWebDAVè¿é€šæ€§ ====="
          # æ ¡éªŒWebDAVå‡­è¯å®Œæ•´æ€§
          if [ -z "${{ secrets.WEBDAV_URL }}" ] || [ -z "${{ secrets.WEBDAV_USER }}" ] || [ -z "${{ secrets.WEBDAV_PASSWORD }}" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œå¤‡ä»½æ¢å¤åŠŸèƒ½ç¦ç”¨"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # é…ç½®rclone WebDAVè¿œç¨‹
          ENCRYPTED_PASS=$(rclone obscure "${{ secrets.WEBDAV_PASSWORD }}")
          rclone config create mywebdav webdav \
            url="${{ secrets.WEBDAV_URL }}" \
            vendor="webdav" \
            user="${{ secrets.WEBDAV_USER }}" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          # è¿é€šæ€§æµ‹è¯•+ç›®å½•åˆ›å»º
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAVè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‡­è¯å’Œåœ°å€"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf || true
          # æŸ¥æ‰¾æœ€æ–°å¿«ç…§ï¼Œç”¨äºè‡ªåŠ¨æ¢å¤
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep "casaos-full-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT=$(echo "$REMOTE_SNAPSHOTS" | head -n1)
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å¤‡ä»½å¿«ç…§ï¼š$LATEST_SNAPSHOT"
            echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ WebDAVæ— å¤‡ä»½å¿«ç…§ï¼Œåç»­å°†æ‰§è¡Œå…¨æ–°å®‰è£…"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          fi
          echo "âœ… WebDAVé…ç½®å®Œæˆï¼Œè¿é€šæ­£å¸¸ï¼Œå¤‡ä»½ç›®å½•å°±ç»ª"

      - name: 4-è‡ªåŠ¨æ¢å¤ï¼ˆæ£€æµ‹åˆ°å¿«ç…§å³å®Œæ•´è¿˜åŸï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== å¼€å§‹å…¨é‡æ¢å¤ï¼Œå¿«ç…§æ–‡ä»¶ï¼š${{ env.LATEST_SNAPSHOT }} ====="
          # å¼ºåˆ¶åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡ï¼Œæ¸…ç†æ®‹ç•™é”æ–‡ä»¶
          sudo systemctl stop docker.service docker.socket casaos.service 2>/dev/null || true
          sudo systemctl mask docker.socket casaos.service
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/casaos.pid
          sync && sleep 5
          echo "âœ… ç›¸å…³æœåŠ¡å·²åœæ­¢ï¼Œæ®‹ç•™é”æ–‡ä»¶æ¸…ç†å®Œæˆ"
          
          # å¿«ç…§æœ‰æ•ˆæ€§æ·±åº¦æ ¡éªŒï¼Œæœç»æŸåå¿«ç…§æ¢å¤
          echo "ğŸ” æ ¡éªŒå¿«ç…§å®Œæ•´æ€§..."
          if ! rclone cat mywebdav:${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf | tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåæˆ–æ— æ•ˆï¼Œæ¢å¤ç»ˆæ­¢"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          echo "âœ… å¿«ç…§å®Œæ•´æœ‰æ•ˆï¼Œå¼€å§‹è§£å‹æ¢å¤"
          
          # æ ¸å¿ƒæ¢å¤ï¼šå®Œæ•´è¿˜åŸæ‰€æœ‰æ–‡ä»¶ï¼Œä¿ç•™åŸå§‹æƒé™
          rclone cat mywebdav:${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "âœ… å…¨é‡å¿«ç…§æ¢å¤æˆåŠŸï¼ŒDocker+CasaOSæ•°æ®å®Œæ•´è¿˜åŸ"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # æ¸…ç†è¿œç¨‹å·²æ¢å¤å¿«ç…§ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼ˆå¯é€‰ä¿ç•™ï¼Œæ³¨é‡Šå³ä¸åˆ ï¼‰
            rclone delete mywebdav:${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf || true
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt --config /home/runner/.rclone.conf || true
            echo "âœ… è¿œç¨‹å·²æ¢å¤å¿«ç…§æ¸…ç†å®Œæˆ"
          else
            echo "âŒ å¿«ç…§æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          
          # æ¢å¤æœåŠ¡é…ç½®ï¼Œåˆ·æ–°ç³»ç»ŸæœåŠ¡
          sudo systemctl unmask docker.socket casaos.service
          sudo systemctl daemon-reload
          echo "âœ… æœåŠ¡é…ç½®æ¢å¤å®Œæˆï¼Œå°±ç»ªå¯åŠ¨"

      - name: 5-æ— å¿«ç…§å…¨æ–°å®‰è£…CasaOSï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== æ— å¯ç”¨å¿«ç…§ï¼Œæ‰§è¡ŒCasaOSå…¨æ–°å®‰è£… ====="
          # ç¡®ä¿dockeræ­£å¸¸è¿è¡Œ
          sudo systemctl enable --now docker
          sleep 3
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œæ— æ³•å®‰è£…CasaOS"
            exit 1
          fi
          # å®˜æ–¹ä¸€é”®å®‰è£…CasaOSï¼Œå¸¦é‡è¯•æœºåˆ¶
          INSTALL_RETRY=3
          until curl -fsSL https://get.casaos.io | sudo bash; do
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            if [ $INSTALL_RETRY -eq 0 ]; then
              echo "âŒ CasaOSå®‰è£…å¤šæ¬¡å¤±è´¥"
              cat /var/log/casaos-install.log || true
              exit 1
            fi
            echo "âš ï¸ CasaOSå®‰è£…å¤±è´¥ï¼Œ${INSTALL_RETRY}æ¬¡é‡è¯•ä¸­..."
            sleep 10
          done
          echo "âœ… CasaOSå…¨æ–°å®‰è£…æˆåŠŸï¼ŒæœåŠ¡è‡ªåŠ¨å¯åŠ¨"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"

      - name: 6-æ¢å¤åç¯å¢ƒä¿®å¤+æœåŠ¡å¯åŠ¨ï¼ˆæ— ç¼å¯ç”¨ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          echo "===== ç¯å¢ƒä¸€é”®ä¿®å¤ï¼ŒæœåŠ¡å¯åŠ¨ä¼˜åŒ– ====="
          sudo systemctl daemon-reload
          
          # DockeræœåŠ¡å¯åŠ¨ï¼ˆ5æ¬¡é‡è¯•ï¼Œå¿…èµ·å…œåº•ï¼‰
          echo "ğŸ”„ å¯åŠ¨DockeræœåŠ¡ï¼ˆ5æ¬¡é‡è¯•ï¼‰..."
          DOCKER_RETRY=5
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl start docker.service docker.socket
            sleep 8
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            echo "âš ï¸ Dockerå¯åŠ¨å¤±è´¥ï¼Œå‰©ä½™${DOCKER_RETRY}æ¬¡é‡è¯•"
            sudo systemctl reset-failed docker
            sleep 5
          done
          if [ $DOCKER_RETRY -eq 0 ]; then
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ‰‹åŠ¨æ’æŸ¥ï¼šsudo journalctl -u docker"
            exit 1
          fi
          
          # CasaOSç¯å¢ƒä¸€ç«™å¼ä¿®å¤ï¼ˆæƒé™+ä¾èµ–+é…ç½®ï¼‰
          echo "ğŸ”§ ä¿®å¤CasaOSè¿è¡Œç¯å¢ƒ..."
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/casaos/appstore /DATA
          sudo chown -R root:root /etc/casaos /var/lib/casaos
          sudo chmod -R 755 /etc/casaos /var/lib/casaos
          sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock
          # è¡¥å…¨CasaOSå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒè·¯å¾„å…¼å®¹
          if [ ! -f "/usr/bin/casaos" ] && [ ! -f "/usr/local/bin/casaos" ]; then
            curl -fsSL https://get.casaos.io | sudo bash -s -- --skip-config
          fi
          [ -f "/usr/local/bin/casaos" ] && sudo ln -sf /usr/local/bin/casaos /usr/bin/casaos || true
          # æ›¿æ¢å®˜æ–¹æ ‡å‡†æœåŠ¡æ–‡ä»¶ï¼Œä¿®å¤é…ç½®é”™ä¹±
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service
          curl -fsSL https://raw.githubusercontent.com/IceWhaleTech/CasaOS/main/service/casaos.service -o /tmp/casaos.service
          sudo cp /tmp/casaos.service /etc/systemd/system/
          sudo cp /tmp/casaos.service /usr/lib/systemd/system/
          sudo chmod 644 /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service
          sudo systemctl daemon-reload
          # è¡¥å…¨CasaOSé»˜è®¤ç½‘ç»œ
          sudo docker network create casaos 2>/dev/null || true
          
          # CasaOSæœåŠ¡å¯åŠ¨ï¼ˆ3æ¬¡é‡è¯•ï¼‰
          echo "ğŸ”„ å¯åŠ¨CasaOSæœåŠ¡..."
          CASAOS_RETRY=3
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo systemctl start casaos.service
            sleep 5
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸï¼Œæ— ç¼å¯ç”¨"
              break
            fi
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            echo "âš ï¸ CasaOSå¯åŠ¨å¤±è´¥ï¼Œå‰©ä½™${CASAOS_RETRY}æ¬¡é‡è¯•"
            sudo systemctl reset-failed casaos
            sleep 3
          done
          
          # æœ€ç»ˆçŠ¶æ€éªŒè¯
          echo "ğŸ“Š æ¢å¤å®Œæˆï¼ŒæœåŠ¡çŠ¶æ€æ±‡æ€»ï¼š"
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager
          echo "âœ… ç¯å¢ƒä¿®å¤å®Œæˆï¼ŒDocker+CasaOSæ­£å¸¸è¿è¡Œï¼Œå¯ç›´æ¥è®¿é—®ä½¿ç”¨"

      - name: 7-å…¨æ–°å®‰è£…åæœåŠ¡åˆå§‹åŒ–ï¼ˆç¨³å®šå¯åŠ¨ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…ç¯å¢ƒï¼ŒæœåŠ¡åˆå§‹åŒ–å¯åŠ¨ ====="
          sudo systemctl enable --now docker casaos
          sleep 5
          echo "ğŸ“Š å…¨æ–°å®‰è£…å®Œæˆï¼ŒæœåŠ¡çŠ¶æ€ï¼š"
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager
          echo "âœ… CasaOSå…¨æ–°ç¯å¢ƒå°±ç»ªï¼Œå¯ç›´æ¥è®¿é—®é…ç½®"

      - name: 8-Tailscaleç»„ç½‘éƒ¨ç½²ï¼ˆå®Œæ•´é…ç½®ï¼Œå¼€æœºè‡ªå¯ï¼‰
        run: |
          set -e
          echo "===== éƒ¨ç½²Tailscaleç»„ç½‘ï¼Œå®ç°è¿œç¨‹è®¿é—® ====="
          if [ -z "${{ secrets.TAILSCALE_AUTH_KEY }}" ]; then
            echo "âš ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘éƒ¨ç½²"
            exit 0
          fi
          # å®‰è£…Tailscaleç¨³å®šç‰ˆ
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          # å¯åŠ¨Tailscaleï¼Œé…ç½®å®Œæ•´å‚æ•°ï¼ˆå›ºå®šä¸»æœºå+è·¯ç”±è½¬å‘+è‡ªåŠ¨é‡è¿ï¼‰
          TS_HOSTNAME="CasaOS-Server-$(hostname | cut -c1-8)"
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --hostname="$TS_HOSTNAME" \
            --accept-routes \
            --accept-dns \
            --advertise-routes=192.168.0.0/24,10.0.0.0/24 \
            --auto-approve \
            --no-single-routing-table
          # è®¾ç½®å¼€æœºè‡ªå¯ï¼Œé‡å¯è‡ªåŠ¨ç»„ç½‘
          sudo systemctl enable --now tailscaled
          # éªŒè¯ç»„ç½‘çŠ¶æ€ï¼Œè·å–è®¿é—®åœ°å€
          TS_IP=$(sudo tailscale ip -4)
          if [ -n "$TS_IP" ]; then
            echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼è¿œç¨‹è®¿é—®IPv4ï¼š$TS_IP"
            echo "âœ… ä¸»æœºåï¼š$TS_HOSTNAMEï¼Œå¼€æœºè‡ªåŠ¨é‡è¿ï¼Œè·¯ç”±è½¬å‘å·²å¼€å¯"
          else
            echo "âŒ Tailscaleç»„ç½‘å¤±è´¥ï¼ŒæŸ¥çœ‹çŠ¶æ€ï¼šsudo tailscale status"
            sudo tailscale status
          fi

      - name: 9-å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå®Œæ•´é—­ç¯ï¼‰
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          echo "===== å¯åŠ¨å…¨é‡å¤‡ä»½æµç¨‹ï¼Œæ”¯æŒè‡ªåŠ¨ç»­è·‘ ====="
          
          # ç»­è·‘è§¦å‘å‡½æ•°ï¼ˆé˜²è¶…æ—¶ï¼Œæ— ç¼è¡”æ¥ï¼‰
          trigger_workflow_renew() {
            if [ -z "${{ secrets.GITHUB_USER_PAT }}" ] || [ -z "${{ secrets.GITHUB_REPO }}" ]; then
              echo "âŒ ç»­è·‘é…ç½®ç¼ºå¤±ï¼Œæ— æ³•è§¦å‘ç»­è·‘"
              return 1
            fi
            echo "ğŸ”„ è§¦å‘ç»­è·‘å·¥ä½œæµï¼Œé¿å…è¶…æ—¶ä¸­æ–­..."
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_USER_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ secrets.GITHUB_REPO }}/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥ï¼Œæ£€æŸ¥USER_PATæƒé™"
              return 1
            fi
            echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸï¼Œå¤‡ä»½æŒç»­ä¸ä¸­æ–­"
            RENEW_TRIGGERED=true
            return 0
          }
          
          # å…¨é‡å¤‡ä»½æ ¸å¿ƒå‡½æ•°ï¼ˆæƒé™+æ ¡éªŒ+æ¸…ç†å…¨é—­ç¯ï¼‰
          full_backup_and_upload() {
            if [ "${{ env.WEBDAV_AVAILABLE }}" != "true" ]; then
              echo "âŒ WebDAVä¸å¯ç”¨ï¼Œè·³è¿‡å¤‡ä»½"
              return 1
            fi
            
            # å‰ç½®æ£€æŸ¥ï¼šè·¯å¾„è¡¥å…¨+ç©ºé—´æ ¡éªŒ+æ–‡ä»¶å®Œæ•´æ€§
            echo "ğŸ” å¤‡ä»½å‰ç½®æ£€æŸ¥..."
            # è¡¥å…¨æ ¸å¿ƒç›®å½•ï¼Œé¿å…æ‰“åŒ…å¤±è´¥
            for dir in $CORE_BACKUP_DIRS; do
              if [ ! -e "$dir" ]; then
                sudo mkdir -p "$dir" 2>/dev/null || true
              fi
            done
            # ä¸´æ—¶ç›®å½•é…ç½®ï¼ˆæƒé™å…¨å¼€ï¼Œæ— è¯»å†™é™åˆ¶ï¼‰
            BACKUP_TMP_DIR="/home/runner/casaos-backup-tmp"
            sudo rm -rf "$BACKUP_TMP_DIR" && sudo mkdir -p "$BACKUP_TMP_DIR"
            sudo chown -R runner:runner "$BACKUP_TMP_DIR"
            sudo chmod 777 "$BACKUP_TMP_DIR"
            # ç£ç›˜ç©ºé—´æ ¡éªŒï¼ˆè‡³å°‘5GBå¯ç”¨ï¼Œé¿å…å†™æ»¡ï¼‰
            FREE_SPACE=$(df -k "$BACKUP_TMP_DIR" | awk 'NR==2{print $4}')
            FREE_SPACE_GB=$((FREE_SPACE/1024/1024))
            if [ $FREE_SPACE_GB -lt 5 ]; then
              echo "âŒ ä¸´æ—¶ç›®å½•å¯ç”¨ç©ºé—´ä¸è¶³5GBï¼ˆå½“å‰$FREE_SPACE_GB GBï¼‰"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "âœ… å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ç”¨ç©ºé—´ï¼š$FREE_SPACE_GB GB"
            
            # ç”Ÿæˆå¿«ç…§æ–‡ä»¶ï¼ˆæ—¶é—´æˆ³å‘½åï¼Œé¿å…é‡å¤ï¼‰
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            LOCAL_SNAPSHOT="$BACKUP_TMP_DIR/$SNAPSHOT_NAME"
            REMOTE_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            
            # æ ¸å¿ƒæ‰“åŒ…ï¼šsudoè·å–rootæƒé™ï¼Œè¯»å–æ‰€æœ‰æ–‡ä»¶ï¼Œä¿ç•™æƒé™
            echo "ğŸ”„ å¼€å§‹å…¨é‡æ‰“åŒ…ï¼ˆDocker+CasaOS+DATAï¼‰..."
            sudo tar -czf "$LOCAL_SNAPSHOT" \
              --ignore-failed-read \
              --warning=no-all \
              --preserve-permissions \
              --dereference \
              $EXCLUDE_RULES \
              $CORE_BACKUP_DIRS
            # æ‰“åŒ…åæ”¹å±ä¸»ï¼Œé¿å…åç»­æ“ä½œæƒé™é—®é¢˜
            sudo chown runner:runner "$LOCAL_SNAPSHOT"
            echo "âœ… å…¨é‡æ‰“åŒ…å®Œæˆï¼Œå¿«ç…§æ–‡ä»¶ï¼š$SNAPSHOT_NAME"
            
            # ä¸‰é‡æ ¡éªŒï¼šå¤§å°+æ ¸å¿ƒæ–‡ä»¶+å®Œæ•´æ€§ï¼Œæœç»æ— æ•ˆå¤‡ä»½
            echo "ğŸ” å¤‡ä»½å®Œæ•´æ€§ä¸‰é‡æ ¡éªŒ..."
            # æ ¡éªŒ1ï¼šæ–‡ä»¶å¤§å°ï¼ˆæœ€å°1MBï¼Œæ’é™¤ç©ºåŒ…ï¼‰
            SNAPSHOT_SIZE=$(du -sh "$LOCAL_SNAPSHOT" | awk '{print $1}')
            SNAPSHOT_KB=$(du -k "$LOCAL_SNAPSHOT" | awk '{print $1}')
            if [ $SNAPSHOT_KB -lt 1024 ]; then
              echo "âŒ å¿«ç…§æ–‡ä»¶è¿‡å°ï¼Œæ‰“åŒ…å¤±è´¥"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            # æ ¡éªŒ2ï¼šæ ¸å¿ƒæ–‡ä»¶å¿…å«
            TAR_CONTENT=$(tar -tzf "$LOCAL_SNAPSHOT" 2>/dev/null)
            if ! echo "$TAR_CONTENT" | grep -q "var/lib/docker" || ! echo "$TAR_CONTENT" | grep -q "var/lib/casaos" || ! echo "$TAR_CONTENT" | grep -q "usr/bin/casaos"; then
              echo "âŒ æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œå¤‡ä»½æ— æ•ˆ"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            # æ ¡éªŒ3ï¼šè§£å‹æµ‹è¯•ï¼ŒéªŒè¯å®Œæ•´æ€§
            tar -tzf "$LOCAL_SNAPSHOT" 2>/dev/null | head -10 >/dev/null
            if [ $? -ne 0 ]; then
              echo "âŒ å¿«ç…§æ–‡ä»¶æŸåï¼Œè§£å‹æµ‹è¯•å¤±è´¥"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "âœ… å¤‡ä»½æ ¡éªŒé€šè¿‡ï¼Œå¿«ç…§å¤§å°ï¼š$SNAPSHOT_SIZEï¼Œæ ¸å¿ƒæ–‡ä»¶å®Œæ•´"
            
            # å¤‡ä»½å®Œæˆååœæ­¢æœåŠ¡ï¼Œé¿å…æ–‡ä»¶å ç”¨
            echo "ğŸ›‘ å¤‡ä»½å®Œæˆï¼Œåœæ­¢æœåŠ¡æ¸…ç†èµ„æº..."
            sudo systemctl stop docker.service docker.socket casaos.service 2>/dev/null || true
            sudo pkill -9 docker containerd casaos 2>/dev/null || true
            sync && sleep 3
            
            # ä¸Šä¼ å¿«ç…§åˆ°WebDAVï¼ˆå¤šçº¿ç¨‹åŠ é€Ÿï¼Œæ–­ç‚¹ç»­ä¼ ï¼‰
            echo "ğŸ“¤ ä¸Šä¼ å¿«ç…§åˆ°WebDAVï¼ˆ4çº¿ç¨‹åŠ é€Ÿï¼‰..."
            if ! rclone copy "$LOCAL_SNAPSHOT" "$REMOTE_SNAPSHOT" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --fast-list \
              --progress \
              --log-level INFO; then
              echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "âœ… å¿«ç…§ä¸Šä¼ æˆåŠŸï¼Œè¿œç¨‹åœ°å€ï¼š$REMOTE_SNAPSHOT"
            
            # ä¸Šä¼ å¤‡ä»½å…ƒæ•°æ®ï¼Œä¾¿äºè¯†åˆ«
            META_FILE="$BACKUP_TMP_DIR/backup-meta.txt"
            echo "snapshot_name=$SNAPSHOT_NAME" > "$META_FILE"
            echo "backup_time=$(date '+%Y-%m-%d %H:%M:%S')" >> "$META_FILE"
            echo "backup_size=$SNAPSHOT_SIZE" >> "$META_FILE"
            echo "backup_content=Dockerå…¨é‡+CasaOSå®Œæ•´+DATAç›®å½•" >> "$META_FILE"
            echo "system_hostname=$(hostname)" >> "$META_FILE"
            rclone copy "$META_FILE" "${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt" --config /home/runner/.rclone.conf || true
            
            # æ¸…ç†æœ¬åœ°æ–‡ä»¶+æ¢å¤æœåŠ¡è¿è¡Œ
            echo "ğŸ§¹ æ¸…ç†æœ¬åœ°æ–‡ä»¶ï¼Œæ¢å¤æœåŠ¡è¿è¡Œ..."
            sudo rm -rf "$BACKUP_TMP_DIR"
            sudo systemctl start docker.service docker.socket casaos.service 2>/dev/null || true
            sleep 3
            # éªŒè¯æœåŠ¡æ¢å¤çŠ¶æ€
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… æœåŠ¡æ¢å¤æ­£å¸¸ï¼Œæœ¬æ¬¡å…¨é‡å¤‡ä»½æµç¨‹å®Œæˆ"
            else
              echo "âš ï¸ æœåŠ¡æ¢å¤å¼‚å¸¸ï¼Œæ‰‹åŠ¨é‡å¯ï¼šsudo systemctl restart docker casaos"
            fi
            return 0
          }
          
          # ä¸»å¾ªç¯ï¼šå®šæ—¶å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ŒæŒç»­ä¿éšœ
          while true; do
            run_mins=$(( (date +%s - start_time) / 60 ))
            echo "ğŸ“Š å·¥ä½œæµå·²è¿è¡Œ${run_mins}åˆ†é’Ÿï¼ŒçŠ¶æ€ç¨³å®š"
            
            # è¿è¡Œ2åˆ†é’Ÿè§¦å‘é¦–æ¬¡å¤‡ä»½ï¼Œä»…æ‰§è¡Œ1æ¬¡
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è¾¾åˆ°å¤‡ä»½è§¦å‘æ¡ä»¶ï¼Œå¯åŠ¨å…¨é‡å¤‡ä»½"
              if full_backup_and_upload; then
                trigger_workflow_renew
              else
                echo "âŒ æœ¬æ¬¡å¤‡ä»½å¤±è´¥ï¼Œ30åˆ†é’Ÿåè‡ªåŠ¨é‡è¯•"
                sleep 1800
              fi
            fi
            
            # è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œæ­£å¸¸é€€å‡ºï¼ˆç»­è·‘å·²è§¦å‘ï¼‰
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œå·¥ä½œæµæ­£å¸¸é€€å‡ºï¼Œç»­è·‘å·²æ¥ç®¡"
              exit 0
            fi
            
            sleep 60
          done

      - name: 10-æ”¶å°¾æ¸…ç†ï¼ˆæ— è®ºæˆè´¥å¿…æ‰§è¡Œï¼Œæ— æ®‹ç•™ï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ‰§è¡Œæ”¶å°¾æ¸…ç†ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æº ====="
          # è§£é™¤æœåŠ¡æ©ç ï¼Œæ¢å¤ç³»ç»Ÿé»˜è®¤çŠ¶æ€
          sudo systemctl unmask docker.socket casaos.service 2>/dev/null || true
          # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜ã€é…ç½®æ®‹ç•™
          sudo rm -rf /home/runner/casaos-backup-tmp /home/runner/tmp /tmp/*
          sudo rm -rf /home/runner/.rclone.conf /etc/sudoers.d/roots /tmp/casaos.service
          # ä¿®å¤ç›®å½•æƒé™ï¼Œé¿å…å½±å“åç»­æ“ä½œ
          sudo chown -R runner:runner /home/runner
          sudo chmod -R 755 /home/runner
          # æ¸…ç†aptç¼“å­˜ï¼Œé‡Šæ”¾ç©ºé—´
          sudo apt autoremove -y && sudo apt clean -y
          # æœ€ç»ˆæœåŠ¡çŠ¶æ€æ±‡æ€»
          echo "âœ… æ”¶å°¾æ¸…ç†å®Œæˆï¼Œæ— æ®‹ç•™æ–‡ä»¶ï¼Œç³»ç»Ÿèµ„æºå·²é‡Šæ”¾"
          echo "ğŸ“Š æœ€ç»ˆç³»ç»Ÿæ ¸å¿ƒæœåŠ¡çŠ¶æ€ï¼š"
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager
          sudo systemctl status tailscaled --no-pager
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ŒDocker+CasaOSç¨³å®šè¿è¡Œï¼Œå¤‡ä»½æ¢å¤+ç»„ç½‘+æ ¹ç”¨æˆ·åŠŸèƒ½å…¨éƒ¨å°±ç»ª"
