set -e
export LC_ALL=zh_CN.UTF-8
export LANG=zh_CN.UTF-8
start_time=$(date +%s)
RENEW_TRIGGERED=false

# ç»­è·‘è§¦å‘å‡½æ•°
trigger_renew() {
  [ -z "$USER_PAT" ] || [ -z "$REPO" ] && echo "âŒç»­è·‘å‡­è¯ç¼ºå¤±" && return 1
  if ! curl -fsSL --fail -X POST \
    -H "Authorization: token $USER_PAT" \
    -H "Accept: application/vnd.github.v3+json" \
    -H "Content-Type: application/json" \
    "https://api.github.com/repos/$REPO/dispatches" \
    -d '{"event_type":"renew_casaos_snapshot"}'; then
    echo "âŒç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥" && return 1
  fi
  echo "âœ…ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
  RENEW_TRIGGERED=true && return 0
}

# å…¨é‡å¤‡ä»½æ ¸å¿ƒå‡½æ•°
full_backup_snapshot() {
  [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1
  
  # å¤‡ä»½å‰æ ¡éªŒ
  if [ ! -f "/usr/bin/casaos" ] || [ ! -f "/var/lib/casaos/${BACKUP_MARK}.flag" ]; then
    echo "âŒCasaOSç¯å¢ƒä¸å®Œæ•´ï¼Œæ‹’ç»å¤‡ä»½" && exit 1
  fi
  echo "âœ…å¤‡ä»½å‰ç¯å¢ƒå®Œæ•´æ€§æ ¡éªŒé€šè¿‡"
  
  # å¿«ç…§å‘½å
  SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
  TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
  REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
  echo "ğŸ”„å¼€å§‹åˆ›å»ºå…¨é‡å¿«ç…§ï¼š${SNAPSHOT_NAME}"
  
  # ä¸€è‡´æ€§é”ï¼ˆä¿®å¤pkillå‘½ä»¤ï¼šåˆ†å¼€ç»ˆæ­¢å¤šä¸ªè¿›ç¨‹ï¼‰
  sudo systemctl stop docker.service docker.socket casaos.service
  sudo systemctl mask docker.socket casaos.service
  # ã€ä¿®æ”¹1ã€‘åˆ†å¼€æ‰§è¡Œpkillï¼Œé¿å…å‚æ•°é”™è¯¯ï¼›åŠ || trueå®¹é”™ï¼ˆè¿›ç¨‹ä¸å­˜åœ¨æ—¶ä¸æŠ¥é”™ï¼‰
  sudo pkill -9 docker || true
  sudo pkill -9 casaos || true
  sync && sleep 3
  echo "âœ…æœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®ä¸€è‡´æ€§é”å®šå®Œæˆ"
  
  # å…¨é‡æ‰“åŒ…ï¼ˆä¿®å¤taré€‰é¡¹ï¼šç”¨é€šç”¨çš„--preserve=owneræ›¿æ¢--preserve-ownerï¼‰
  sudo tar -czf "${TMP_SNAPSHOT}" \
    --absolute-names --preserve-permissions --preserve=owner --preserve-links \
    --preserve-time --ignore-failed-read --warning=no-all \
    $EXCLUDE_RULES \
    $CORE_DIRS
  # åˆ›å»ºå¤‡ä»½æ ‡è¯†
  sudo touch /var/lib/casaos/${BACKUP_MARK}.flag
  
  # è§£é”æœåŠ¡
  sudo systemctl unmask docker.socket casaos.service
  sudo systemctl start docker.service docker.socket casaos.service
  echo "âœ…æœåŠ¡å·²é‡å¯"
  
  # ä¸‰é‡æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
  [ ! -f "${TMP_SNAPSHOT}" ] && echo "âŒå¿«ç…§æœªç”Ÿæˆ" && return 1
  [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 104857600 ] && echo "âŒå¿«ç…§å°äº100Mï¼Œåˆ¤å®šæ®‹ç¼º" && return 1
  tar -tzf "${TMP_SNAPSHOT}" | grep -q "/var/lib/casaos" && echo "âœ…å¿«ç…§è§£å‹æµ‹è¯•é€šè¿‡" || { echo "âŒå¿«ç…§è§£å‹å¤±è´¥"; return 1; }
  echo "âœ…å…¨é‡å¿«ç…§åˆ›å»ºå®Œæˆï¼Œå¤§å°ï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"
  
  # å…¨é‡ä¸Šä¼ 
  sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
    --config /home/runner/.rclone.conf \
    --transfers 8 --checkers 16 --fast-list --retries 5 \
    --ignore-existing --progress --log-level INFO --log-file /tmp/rclone_full_upload.log
  [ $? -ne 0 ] && { echo "âŒä¸Šä¼ å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š/tmp/rclone_full_upload.log"; cat /tmp/rclone_full_upload.log; return 1; }
  
  # ä¸Šä¼ å…ƒæ•°æ®
  META_FILE="/tmp/snapshot_full_meta.txt"
  echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
  echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
  echo "backup_size=$(du -sb ${TMP_SNAPSHOT} | awk '{print $1}')" >> "${META_FILE}"
  echo "backup_mark=${BACKUP_MARK}" >> "${META_FILE}"
  sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_full_meta.txt" --config /home/runner/.rclone.conf
  
  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
  rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
  echo "âœ…å…¨é‡å¿«ç…§å·²ä¸Šä¼ è‡³WebDAVï¼š${REMOTE_PATH}"
  return 0
}

# ä¸»é€»è¾‘
while true; do
  run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
  echo "ğŸ“Šå·¥ä½œæµè¿è¡Œæ—¶é•¿ï¼š$run_mins åˆ†é’Ÿ"
  
  # ç«‹å³æ‰§è¡Œå…¨é‡å¤‡ä»½
  if [ "$RENEW_TRIGGERED" = "false" ]; then
    echo "â°ç«‹å³æ‰§è¡Œå…¨é‡å¤‡ä»½"
    if full_backup_snapshot; then
      trigger_renew
    else
      echo "âŒå…¨é‡å¤‡ä»½å¤±è´¥ï¼Œ1åˆ†é’Ÿåé‡è¯•"
      sleep 60
      full_backup_snapshot
    fi
  fi
  
  # è¾¾åˆ°æœ€å¤§æ—¶é•¿é€€å‡º
  [ $run_mins -ge $MAX_RUN_MINUTES ] && { echo "â¹ï¸è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é•¿ï¼Œæ­£å¸¸é€€å‡º"; exit 0; }
  sleep 60
done
