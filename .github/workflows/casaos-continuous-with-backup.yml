name: CasaOS Mini Backup (Foreign, Fixed)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # UTC 0:00 (国外常用)
  repository_dispatch:
    types: [renew_casaos_snapshot]

env:
  TZ: UTC
  BACKUP_DIR: /tmp/casaos_backups
  SNAPSHOT_PREFIX: casaos-mini-snapshot
  ZSTD_LEVEL: 6
  PARALLEL_CORE: 2
  KEEP_BACKUPS: 2
  PERSONAL_DATA_DIRS: |
    /DATA
    /etc/casaos
    /var/lib/casaos
    /var/lib/docker
    /var/lib/containerd
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
  WEBDAV_PASS: ${{ secrets.WEBDAV_PASS }}
  WEBDAV_REMOTE_DIR: /CasaOS_Backups
  USER_PAT: ${{ secrets.USER_PAT }}
  REPO: ${{ github.repository }}

jobs:
  casaos_mini_backup:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: 0-Init Working Directory
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 0-Init Working Directory =====\033[0m"
          sudo mkdir -p $BACKUP_DIR /DATA
          sudo chmod -R 777 $BACKUP_DIR /DATA
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
          echo -e "\033[1;32m✅ Working directory initialized\033[0m"

      - name: 1-System Init & Cleanup (Fixed)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 1-System Init & Cleanup =====\033[0m"
          
          # Fixed: Correct language-pack name, remove duplicate fuser
          sudo apt update -y -qq
          sudo apt install -y -qq curl wget jq tar gzip rclone lsof ca-certificates gnupg pigz zstd psmisc procps language-pack-zh-hans
          
          # Clean old services
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sudo systemctl disable casaos docker containerd 2>/dev/null || true
          [ -f /etc/systemd/system/casaos.service ] && sudo rm -f /etc/systemd/system/casaos.service
          [ -f /usr/lib/systemd/system/casaos.service ] && sudo rm -f /usr/lib/systemd/system/casaos.service
          sudo systemctl daemon-reload
          
          # Force release file locks
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          
          # Fixed: Remove /root/.config cleanup to avoid permission conflict
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /var/cache/apt/* /var/lib/docker/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          
          echo -e "\033[1;32m✅ System initialized\033[0m"

      - name: 2-Tailscale Networking (Official, Fixed)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 2-Tailscale Networking =====\033[0m"
          
          # Official install
          curl -fsSL https://tailscale.com/install.sh | sh
          sleep 2
          
          # Fixed: Correct login-server (official)
          sudo tailscale up \
            --auth-key="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --login-server="https://login.tailscale.com" \
            --accept-routes \
            --accept-dns
          
          sleep 5
          
          # Node info
          echo -e "\033[1;32m✅ Tailscale Status:\033[0m"
          tailscale status || true
          
          TS_IPv4=$(tailscale ip -4 2>/dev/null | tr -d '\n') || true
          TS_IPv6=$(tailscale ip -6 2>/dev/null | tr -d '\n') || true
          echo -e "\nNode IPv4: \033[1;36m${TS_IPv4:-N/A}\033[0m"
          echo -e "Node IPv6: \033[1;36m${TS_IPv6:-N/A}\033[0m"
          
          ping -c 3 $TS_IPv4 2>/dev/null || echo "⚠️ Ping skipped"
          
          echo "TAILSCALE_IPv4=$TS_IPv4" >> $GITHUB_ENV
          echo "TAILSCALE_IPv6=$TS_IPv6" >> $GITHUB_ENV
          echo -e "\033[1;32m✅ Tailscale connected\033[0m"

      - name: 3-Install Docker (Official, Fixed)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 3-Install Docker (Official) =====\033[0m"
          
          # Fixed: Correct official install (no mirror, foreign env)
          curl -fsSL https://get.docker.com | sudo bash
          
          # Standard Docker config (no Chinese mirrors)
          sudo tee /etc/docker/daemon.json >/dev/null <<EOF
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
          EOF
          
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd
          sleep 5
          
          sudo usermod -aG docker runner
          docker --version
          echo -e "\033[1;32m✅ Docker installed (official)\033[0m"

      - name: 4-Pull Base Images
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 4-Pull Base Images =====\033[0m"
          docker pull --quiet alpine:latest
          docker pull --quiet busybox:latest
          docker pull --quiet ubuntu:22.04
          echo -e "\033[1;32m✅ Base images pulled\033[0m"

      - name: 5-Directory Permissions (Fixed)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 5-Directory Permissions =====\033[0m"
          
          # Fixed: NO /root/.config ownership change
          sudo chown -R roots:roots /DATA
          sudo chmod -R 775 /DATA
          
          sudo chown -R root:root /etc/casaos /var/lib/casaos
          sudo chmod -R 755 /etc/casaos /var/lib/casaos
          sudo chown -R root:docker /var/lib/docker /var/lib/containerd
          sudo chmod -R 750 /var/lib/docker /var/lib/containerd
          
          echo -e "\033[1;32m✅ Permissions set\033[0m"

      - name: 6-Create Backup (ZSTD)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 6-Create Backup =====\033[0m"
          
          SNAPSHOT_NAME="${SNAPSHOT_PREFIX}_$(date +%Y%m%d_%H%M%S).tar.zst"
          echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" >> $GITHUB_ENV
          
          # Backup with exclude logs/tmp
          sudo tar -cPf - --warning=no-file-changed --ignore-failed-read \
            --exclude="*.log" --exclude="*.tmp" --exclude="*/cache/*" --exclude="*/logs/*" \
            $PERSONAL_DATA_DIRS \
            | zstd -$ZSTD_LEVEL -T$PARALLEL_CORE \
            > $BACKUP_DIR/$SNAPSHOT_NAME
          
          BACKUP_SIZE=$(du -sh $BACKUP_DIR/$SNAPSHOT_NAME | awk '{print $1}')
          echo -e "\033[1;32m✅ Backup done: $SNAPSHOT_NAME | Size: $BACKUP_SIZE\033[0m"
          
          # Clean old local backups
          ls -t $BACKUP_DIR/${SNAPSHOT_PREFIX}* | tail -n +$((KEEP_BACKUPS+1)) | xargs -r rm -f
          echo -e "\033[1;32m✅ Keep latest $KEEP_BACKUPS local backups\033[0m"

      - name: 7-Backup Integrity Check (Fixed)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 7-Backup Integrity Check =====\033[0m"
          
          TMP_RESTORE_DIR=/tmp/casaos_restore_test
          sudo mkdir -p $TMP_RESTORE_DIR
          
          zstd -d -c "$BACKUP_DIR/$SNAPSHOT_NAME" | sudo tar -xPf - -C $TMP_RESTORE_DIR --overwrite --ignore-failed-read
          
          # Validate core dirs
          for DIR in $PERSONAL_DATA_DIRS; do
            TEST_DIR="$TMP_RESTORE_DIR$DIR"
            if [ -d "$TEST_DIR" ]; then
              echo "✅ Valid: $DIR"
            else
              echo -e "\033[1;31m❌ Missing: $DIR\033[0m"
              exit 1
            fi
          done
          
          # Fixed: Permission restore only for existing dirs
          for DIR in $PERSONAL_DATA_DIRS; do
            if [ -d "$TMP_RESTORE_DIR$DIR" ]; then
              case $DIR in
                /var/lib/docker*)
                  sudo chown -R root:docker "$TMP_RESTORE_DIR$DIR"
                  sudo chmod -R 750 "$TMP_RESTORE_DIR$DIR"
                  ;;
                /etc/casaos|/var/lib/casaos)
                  sudo chown -R root:root "$TMP_RESTORE_DIR$DIR"
                  sudo chmod -R 755 "$TMP_RESTORE_DIR$DIR"
                  ;;
                /DATA)
                  sudo chown -R roots:roots "$TMP_RESTORE_DIR$DIR"
                  sudo chmod -R 775 "$TMP_RESTORE_DIR$DIR"
                  ;;
              esac
            fi
          done
          
          sudo rm -rf $TMP_RESTORE_DIR
          echo -e "\033[1;32m✅ Backup integrity passed\033[0m"

      - name: 8-Upload to WebDAV (rclone)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 8-Upload to WebDAV =====\033[0m"
          
          rclone config create webdav_backup webdav \
            url="$WEBDAV_URL" \
            user="$WEBDAV_USER" \
            pass="$WEBDAV_PASS" \
            vendor="other"
          
          rclone mkdir webdav_backup:$WEBDAV_REMOTE_DIR
          
          # Upload with resume
          rclone copy -P --transfers=3 --checksum --retries=3 \
            $BACKUP_DIR/$SNAPSHOT_NAME \
            webdav_backup:$WEBDAV_REMOTE_DIR/
          
          # Clean old remote backups (keep 7d)
          rclone delete webdav_backup:$WEBDAV_REMOTE_DIR/ \
            --include="${SNAPSHOT_PREFIX}*" \
            --min-age 7d
          
          echo -e "\033[1;32m✅ Upload & remote cleanup done\033[0m"

      - name: 9-Local Cleanup
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 9-Local Cleanup =====\033[0m"
          sudo rm -rf /tmp/casaos_* ~/.cache/rclone
          docker system prune -af --volumes
          echo -e "\033[1;32m✅ Local cleanup done\033[0m"

      - name: 10-Trigger Next Run (Fixed)
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 10-Trigger Next Backup =====\033[0m"
          
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
            echo -e "\033[1;33m⚠️ Skip trigger (no PAT/REPO)\033[0m"
            exit 0
          fi
          
          # Fixed: curl with timeout, proper headers
          curl -sS --max-time 30 -X POST \
            -H "Authorization: token $USER_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"renew_casaos_snapshot"}' | tee -a /tmp/dispatch.log
          
          if [ $? -eq 0 ]; then
            echo -e "\033[1;32m✅ Next run triggered\033[0m"
          else
            echo -e "\033[1;31m❌ Trigger failed\033[0m"
          fi