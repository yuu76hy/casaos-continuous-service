name: CasaOS-Tailscale-Full-Deploy

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 330
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu"
      CASAOS_DATA: /var/lib/casaos
      DOCKER_DATA: /var/lib/docker
      # æ‰©å±•æ’é™¤åˆ—è¡¨ï¼šè·³è¿‡ç¼“å­˜ã€æ—¥å¿—ã€ä¸´æ—¶æ–‡ä»¶ï¼Œå¤§å¹…æé€Ÿ
      EXCLUDE_DIRS: >-
        /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
        /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
        /usr/share/doc /usr/share/man /usr/share/locale
      MAX_MOUNT_RETRIES: 2
      RETRY_DELAY: 10
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ==========
      - name: æ­¥éª¤1 - ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        id: step1
        run: |
          echo "===== æ­¥éª¤1ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ====="
          mkdir -p /home/runner/logs "$WEBDAV_MOUNT_POINT"
          LOG_FILE="/home/runner/logs/casaos-tailscale-${{ github.run_id }}.log"
          exec > >(tee -a "$LOG_FILE") 2>&1

          sudo apt update -y && sudo apt upgrade -y -q
          sudo apt install -y rsync davfs2 curl wget jq iptables || { echo "ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }

          echo "runner ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ (æ—¥å¿—: $LOG_FILE)"

      # ========== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ·ï¼ˆå¸¦ sudo æƒé™ï¼‰==========
      - name: æ­¥éª¤1.5 - åˆ›å»º roots ç”¨æˆ·
        run: |
          echo "===== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ· ====="
          sudo useradd -m -s /bin/bash roots
          echo "roots:roots1234" | sudo chpasswd
          sudo usermod -aG sudo roots
          echo "âœ… ç”¨æˆ· 'roots' å·²åˆ›å»ºï¼Œå¯†ç ä¸º 'roots1234'ï¼Œå…·å¤‡ sudo æƒé™"

      # ========== æ­¥éª¤2ï¼šæŒ‚è½½WebDAV ==========
      - name: æ­¥éª¤2 - æŒ‚è½½WebDAVå¹¶éªŒè¯
        id: step2
        run: |
          echo "===== æ­¥éª¤2ï¼šæŒ‚è½½WebDAVå¹¶éªŒè¯ ====="
          echo "$WEBDAV_URL $WEBDAV_USER $WEBDAV_PASSWORD" | sudo tee -a /etc/davfs2/secrets
          sudo chmod 600 /etc/davfs2/secrets

          mount_success=false
          for retry in $(seq 1 $MAX_MOUNT_RETRIES); do
            sudo umount "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
            echo "ğŸ”„ å°è¯•æŒ‚è½½ WebDAV (ç¬¬ $retry/$MAX_MOUNT_RETRIES æ¬¡)"
            if sudo mount -t davfs -o uid=runner,gid=runner "$WEBDAV_URL" "$WEBDAV_MOUNT_POINT"; then
              mount_success=true
              break
            fi
            sleep $RETRY_DELAY
          done

          if [ "$mount_success" = "true" ]; then
            echo "âœ… WebDAVæŒ‚è½½æˆåŠŸ (è·¯å¾„: $WEBDAV_MOUNT_POINT)"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            for dir in $BACKUP_DIRS; do
              target_path="$WEBDAV_MOUNT_POINT$dir"
              if [ -d "$target_path" ] && [ -n "$(ls -A "$target_path" 2>/dev/null)" ]; then
                echo "âœ… æ£€æµ‹åˆ° $dir æœ‰æ•ˆå¤‡ä»½æ•°æ®"
                key="HAS_${dir//\//_}"
                echo "${key}=true" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ $dir æ— å¤‡ä»½æ•°æ®ï¼Œåˆ›å»ºç©ºç›®å½•"
                sudo mkdir -p "$target_path"
                key="HAS_${dir//\//_}"
                echo "${key}=false" >> "$GITHUB_ENV"
              fi
            done
          else
            echo "âŒ WebDAVæŒ‚è½½å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤æµç¨‹"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          fi
          echo "âœ… æ­¥éª¤2å®Œæˆ"

      # ========== æ­¥éª¤3ï¼šæ•°æ®æ¢å¤ï¼ˆä»…å½“WebDAVå¯ç”¨ï¼‰ ==========
      - name: æ­¥éª¤3 - æ¢å¤æ•°æ®
        id: step3
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== æ­¥éª¤3ï¼šæ¢å¤æ•°æ® ====="
          RESTORE_DONE=false
          for dir in $BACKUP_DIRS; do
            env_key="HAS_${dir//\//_}"
            if [ "${!env_key}" = "true" ]; then
              echo "ğŸ”„ ä» $dir æ¢å¤æ•°æ®"
              EXCLUDE_PARAMS=()
              for excl in $EXCLUDE_DIRS; do
                EXCLUDE_PARAMS+=("--exclude=$excl")
              done
              target_path="$WEBDAV_MOUNT_POINT$dir"
              # ğŸ‘‡ ä½¿ç”¨ --copy-links é¿å… symlink é”™è¯¯
              sudo rsync -av --delete --copy-links "${EXCLUDE_PARAMS[@]}" "$target_path/" /
              if [ $? -eq 0 ]; then
                RESTORE_DONE=true
                echo "âœ… æ•°æ®æ¢å¤å®Œæˆ ($dir)"
                break
              fi
            fi
          done
          if [ "$RESTORE_DONE" = "false" ]; then
            echo "âš ï¸ æ— æœ‰æ•ˆå¤‡ä»½æ•°æ®ï¼Œè·³è¿‡æ¢å¤"
          fi
          echo "DATA_RESTORED=$RESTORE_DONE" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤4ï¼šæ¸…ç©ºæ—§å¤‡ä»½ ==========
      - name: æ­¥éª¤4 - æ¸…ç©ºWebDAVæ—§å¤‡ä»½
        id: step4
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== æ­¥éª¤4ï¼šæ¸…ç©ºæ—§å¤‡ä»½ ====="
          for dir in $BACKUP_DIRS; do
            target_path="$WEBDAV_MOUNT_POINT$dir"
            sudo rm -rf "$target_path"/*
            echo "âœ… $dir æ—§æ•°æ®å·²æ¸…ç©º"
          done

      # ========== æ­¥éª¤5ï¼šå®‰è£…CasaOS ==========
      - name: æ­¥éª¤5 - å®‰è£…CasaOS
        id: step5
        run: |
          echo "===== æ­¥éª¤5ï¼šå®‰è£…CasaOS ====="
          if [ -d "$CASAOS_DATA" ] && [ "${{ env.DATA_RESTORED }}" = "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°å¤‡ä»½æ•°æ®ï¼Œè·³è¿‡å®‰è£…"
            exit 0
          fi
          curl -fsSL https://get.casaos.io | sudo bash
          if [ $? -ne 0 ]; then
            echo "âŒ CasaOSå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… CasaOSå®‰è£…å®Œæˆ"

      # ========== æ­¥éª¤6ï¼šå¯åŠ¨æœåŠ¡ ==========
      - name: æ­¥éª¤6 - å¯åŠ¨CasaOS+Docker
        id: step6
        run: |
          echo "===== æ­¥éª¤6ï¼šå¯åŠ¨æœåŠ¡ ====="
          sudo systemctl enable --now docker casaos
          sleep 30
          if [ "$(sudo systemctl is-active docker)" != "active" ] || [ "$(sudo systemctl is-active casaos)" != "active" ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      # ========== æ­¥éª¤7ï¼šéƒ¨ç½²Tailscale ==========
      - name: æ­¥éª¤7 - éƒ¨ç½²Tailscale
        id: step7
        run: |
          echo "===== æ­¥éª¤7ï¼šéƒ¨ç½²Tailscale ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-github-runner"
          TAILSCALE_IP=$(sudo tailscale ip -4)
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscaleè¿æ¥å¤±è´¥"
            exit 1
          fi
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œå†…ç½‘IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤8ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: æ­¥éª¤8 - è¾“å‡ºè®¿é—®ä¿¡æ¯
        id: step8
        run: |
          echo "===== æ­¥éª¤8ï¼šè®¿é—®ä¿¡æ¯ ====="
          RUNNER_PUBLIC_IP=$(curl -s ifconfig.me)
          echo "====================================="
          echo "ğŸ”— å…¬ç½‘è®¿é—®ï¼šhttp://$RUNNER_PUBLIC_IP:80"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "ğŸ”’ å†…ç½‘è®¿é—®ï¼šhttp://${{ env.TAILSCALE_IP }}:80"
          fi
          echo "ğŸ”‘ CasaOS é»˜è®¤è´¦å·ï¼šadmin / password"
          echo "ğŸ‘¤ è°ƒè¯•ç”¨æˆ·ï¼šroots / roots1234 ï¼ˆæ”¯æŒ sudoï¼‰"
          echo "âš ï¸ ç™»å½• CasaOS åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
          echo "====================================="

      # ========== æ­¥éª¤9ï¼šä¿æ´» + å¤‡ä»½ + ç»­è·‘ ==========
      - name: æ­¥éª¤9 - ä¿æ´»ä¸ç»­è·‘
        id: step9
        shell: bash
        run: |
          echo "===== æ­¥éª¤9ï¼šä¿æ´»ä¸ç»­è·‘ ====="
          start_time=$(date +%s)
          backup_done=false
          trigger_done=false

          trigger_renew() {
            if [ "$trigger_done" = "true" ] || [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              return 1
            fi
            curl -s -X POST -H "Authorization: token $USER_PAT" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_tailscale"}' > /dev/null
            if [ $? -eq 0 ]; then
              trigger_done=true
              echo "âœ… ç»­è·‘ä»»åŠ¡è§¦å‘æˆåŠŸ"
              return 0
            fi
            return 1
          }

          backup_single_dir() {
            if [ "${{ env.WEBDAV_AVAILABLE }}" != "true" ]; then
              return 1
            fi
            local dir="$1"
            local target_path="$WEBDAV_MOUNT_POINT$dir"
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=$excl")
            done
            EXCLUDE_PARAMS+=("--exclude=$WEBDAV_MOUNT_POINT")

            # ğŸ‘‡ å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨ --copy-links é¿å… symlink é”™è¯¯
            sudo rsync -av --delete --copy-links "${EXCLUDE_PARAMS[@]}" / "$target_path/"
            if [ $? -eq 0 ]; then
              echo "âœ… $dir å¤‡ä»½å®Œæˆ"
              echo "backup_time=$(date +%Y%m%d_%H%M%S) runner_id=${{ github.run_id }}" | sudo tee "$target_path/backup_marker.txt" >/dev/null
              return 0
            fi
            return 1
          }

          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2 {print $4}')
            echo "ğŸ“Š è¿è¡ŒçŠ¶æ€ï¼š$run_mins/$MAX_RUN_MINUTES åˆ†é’Ÿ | ç©ºé—´ï¼š $free_space"

            if [ $(( MAX_RUN_MINUTES - run_mins )) -eq 30 ]; then
              echo "âš ï¸ å‰©ä½™30åˆ†é’Ÿï¼Œæ‰§è¡Œå¤‡ä»½+ç»­è·‘"
              for dir in $BACKUP_DIRS; do
                if backup_single_dir "$dir"; then
                  trigger_renew
                  backup_done=true
                  break
                fi
              done
              if [ "$backup_done" = "false" ]; then
                echo "âš ï¸ å¤‡ä»½å¤±è´¥ï¼Œå°è¯•è§¦å‘ç»­è·‘"
                trigger_renew
              fi
            fi

            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â° å·²è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é•¿ ($MAX_RUN_MINUTES åˆ†é’Ÿ)ï¼Œé€€å‡ºä¿æ´»"
              exit 0
            fi

            sleep 60
          done

      # ========== æ­¥éª¤10ï¼šæ¸…ç†ç¯å¢ƒï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰ ==========
      - name: æ­¥éª¤10 - æ¸…ç†ç¯å¢ƒ
        id: step10
        if: ${{ always() }}
        run: |
          echo "===== æ­¥éª¤10ï¼šæ¸…ç†ç¯å¢ƒ ====="
          sudo umount "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
          sudo rm -rf /tmp/* /home/runner/*.log || true
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
