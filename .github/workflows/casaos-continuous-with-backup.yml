name: CasaOS-Server-å¿«ç…§-å¤‡ä»½-æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # å®Œæ•´å¤‡ä»½ç›®å½•ï¼šè¦†ç›–Docker/CasaOSæ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶
      CORE_DIRS: "/var/lib/docker /etc/docker /etc/casaos /var/lib/casaos /DATA /etc/systemd/system /usr/bin/casaos /usr/lib/systemd/system /var/run/docker.sock /etc/default/docker /usr/lib/docker /var/log/docker"
      # çº¯å‡€æ’é™¤è§„åˆ™ï¼ˆä»…è¿‡æ»¤æ— ç”¨æ–‡ä»¶ï¼‰
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/ç¼“å­˜
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.è¦æ±‚
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true

    steps:
      - name: ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–å®‰è£…
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ…ç¯å¢ƒå·²æˆåŠŸåˆå§‹åŒ–"

      - name: åˆ›å»ºæ ¹ç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots ç”¨æˆ·åˆ›å»ºï¼Œå¯†ç ï¼š$RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi

      - name: é…ç½® Rclone for WebDAVï¼ˆæ— æŒ‚è½½æ¨¡å¼ï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒç¼ºå°‘WebDAVå‡­è¯"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAV connection failed"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "âœ… WebDAV connected successfully"
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          echo "âœ… Remote directory created: mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}"
          # è·å–æœ€æ–°å¿«ç…§ï¼ˆä»…çº¯æ–‡ä»¶åï¼Œé¿å…è·¯å¾„é‡å¤ï¼‰
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "casaos-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… Found latest remote snapshot: ${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ No remote snapshots found in WebDAV directory"
          fi

      - name: Restore Snapshot from WebDAV
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== Restore from remote snapshot: $LATEST_SNAPSHOT ====="
          
          # å½»åº•åœæ­¢æ‰€æœ‰Docker/CasaOSç›¸å…³è¿›ç¨‹ï¼Œæ¸…ç†é”æ–‡ä»¶
          sudo systemctl stop docker.service docker.socket casaos.service || true
          sudo systemctl mask docker.socket casaos.service
          sudo pkill -9 docker || true
          sudo pkill -9 containerd || true
          sudo pkill -9 casaos || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock
          sync && sleep 5
          
          # æ£€æŸ¥casaosæœåŠ¡çŠ¶æ€
          if systemctl is-active --quiet casaos.service; then
            sudo systemctl stop casaos.service
            echo "âœ… Stopped casaos.service"
          else
            echo "âš ï¸ casaos.service not loaded, skip stop"
          fi
          
          # éªŒè¯å¿«ç…§æœ‰æ•ˆæ€§
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "âŒ Remote snapshot invalid or unreadable"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          
          # æ¢å¤å¿«ç…§ï¼ˆä¿ç•™ç»å¯¹è·¯å¾„ï¼Œé¿å…è·¯å¾„ä¸¢å¤±ï¼‰
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --warning=no-all --preserve-permissions --absolute-names $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "âœ… Restored from WebDAV successfully"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # åˆ é™¤å·²æ¢å¤çš„å¿«ç…§å’Œå…ƒæ•°æ®
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt --config /home/runner/.rclone.conf
            echo "âœ… Deleted restored snapshot file: ${LATEST_SNAPSHOT}"
            # æ¢å¤åç«‹å³è§£é™¤æ©ç +åˆ·æ–°systemdé…ç½®
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl daemon-reload
          else
            echo "âŒ Restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl daemon-reload
          fi

      - name: Install CasaOS if No Snapshot Restored
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed successfully"

      - name: Start Services (New Install)
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket || true
          
          # Dockerå¯åŠ¨å¸¦5æ¬¡é‡è¯•ï¼Œå¢åŠ å®é™…è¿è¡Œæ ¡éªŒ
          docker_start_success=false
          for i in $(seq 1 5); do
            sudo systemctl enable --now docker.service docker.socket
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Docker service started successfully (attempt $i)"
              docker_start_success=true
              break
            fi
            echo "âš ï¸ Docker start attempt $i failed, retrying..."
            sudo systemctl reset-failed docker
          done
          
          if [ "$docker_start_success" = "false" ]; then
            echo "âŒ Docker service failed to start after 5 attempts"
            exit 1
          fi
          
          # CasaOSå¯åŠ¨ä¾èµ–Docker
          if systemctl list-unit-files | grep -q casaos.service; then
            sudo systemctl enable --now casaos.service
            sleep 5
            if sudo systemctl is-active --quiet casaos.service; then
              echo "âœ… CasaOS service started successfully"
            else
              echo "âš ï¸ CasaOS service failed to start, check logs: sudo journalctl -u casaos"
            fi
          fi

      - name: Restart Services (From Snapshot)
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket casaos.service || true
          sudo systemctl daemon-reload
          
          # Dockerå¯åŠ¨å¸¦5æ¬¡é‡è¯•+æ—¥å¿—è¾“å‡ºï¼Œç¡®ä¿çœŸçš„èƒ½è¿è¡Œ
          echo "ğŸ”„ å¯åŠ¨ Docker æœåŠ¡ï¼ˆé‡è¯•ï¼‰......"
          docker_start_success=false
          for i in $(seq 1 5); do
            sudo systemctl start docker.service docker.socket
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Docker æœåŠ¡æˆåŠŸé‡å¯ï¼ˆå°è¯•$iï¼‰"
              docker_start_success=true
              break
            else
              echo "âš ï¸ Docker start å°è¯•å¤±è´¥$iï¼Œæ—¥å¿—ï¼š"
              sudo journalctl -u docker --no-pager -n 20
              sudo systemctl reset-failed docker
              sleep 5
            fi
          done
          
          if [ "$docker_start_success" = "false" ]; then
            echo "âŒ Docker æœåŠ¡åœ¨å°è¯• 5 æ¬¡åæœªèƒ½ä»å¿«ç…§é‡å¯"
            exit 1
          fi
          
          # CasaOSå¯åŠ¨å¸¦é‡è¯•+å…œåº•æ¢å¤serviceæ–‡ä»¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
          if systemctl list-unit-files | grep -q casaos.service; then
            echo "ğŸ”„ å¯åŠ¨CasaOSæœåŠ¡ï¼ˆé‡è¯•ï¼‰......"
            casaos_start_success=false
            for i in $(seq 1 3); do
              sudo systemctl start casaos.service
              sleep 5
              if sudo systemctl is-active --quiet casaos.service; then
                echo "âœ… CasaOSæœåŠ¡æˆåŠŸé‡å¯ï¼ˆå°è¯•$iï¼‰"
                casaos_start_success=true
                break
              else
                echo "âš ï¸ CasaOS å¯åŠ¨å°è¯•å¤±è´¥$iï¼Œæ—¥å¿—ï¼š"
                sudo journalctl -u casaos --no-pager -n 20
                sudo systemctl reset-failed casaos
                sleep 3
              fi
            done
            
            if [ "$casaos_start_success" = "false" ]; then
              echo "âš ï¸ CasaOS æœåŠ¡å°è¯•äº†ä¸‰æ¬¡åæœªèƒ½å¯åŠ¨ï¼Œä½† Docker æ­£åœ¨è¿è¡Œï¼ˆæ‰‹åŠ¨æ£€æŸ¥ï¼‰"
            fi
          else
            echo "âŒ æ‰¾ä¸åˆ°CasaOSæœåŠ¡æ–‡ä»¶ï¼æ­£åœ¨ä»å¿«ç…§ä¸­æ¢å¤æœåŠ¡æ–‡ä»¶......"
            # ä¿®å¤tarå‚æ•°ï¼š--includeæ”¾åœ¨æœ€å‰é¢+ç§»é™¤è·¯å¾„ç©ºæ ¼+è‹±æ–‡å¼•å·
            if rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite \
              --include="/etc/systemd/system/casaos.service" \
              --include="/usr/lib/systemd/system/casaos.service" >/dev/null 2>&1; then
              echo "âœ… ä»å¿«ç…§æ¢å¤casaos.serviceæ–‡ä»¶æˆåŠŸ"
            else
              # å¿«ç…§æ¢å¤å¤±è´¥æ—¶ï¼Œä¸‹è½½å®˜æ–¹CasaOS serviceæ–‡ä»¶å…œåº•
              echo "âš ï¸ ä»å¿«ç…§æ¢å¤å¤±è´¥ï¼Œå°è¯•ä¸‹è½½å®˜æ–¹CasaOS serviceæ–‡ä»¶..."
              sudo mkdir -p /etc/systemd/system /usr/lib/systemd/system
              curl -fsSL https://raw.githubusercontent.com/IceWhaleTech/CasaOS/main/service/casaos.service -o /tmp/casaos.service
              sudo cp /tmp/casaos.service /etc/systemd/system/
              sudo cp /tmp/casaos.service /usr/lib/systemd/system/
              rm -f /tmp/casaos.service
              echo "âœ… ä¸‹è½½å®˜æ–¹casaos.serviceæ–‡ä»¶æˆåŠŸ"
            fi
            
            sudo systemctl daemon-reload
            sudo systemctl start casaos.service
            if sudo systemctl is-active --quiet casaos.service; then
              echo "âœ… CasaOS æœåŠ¡å·²æ¢å¤å¹¶æˆåŠŸå¯åŠ¨"
            else
              echo "âŒ CasaOS æœåŠ¡åœ¨æ¢å¤æœåŠ¡æ–‡ä»¶åä¾ç„¶æœªèƒ½å¯åŠ¨"
              sudo journalctl -u casaos --no-pager -n 50
              exit 1
            fi
          fi
          
          # è¾“å‡ºæœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼Œä¾¿äºæ’æŸ¥
          echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager

      - name: Deploy Tailscale
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Missing Tailscale auth key, skip deployment"
            exit 0
          fi
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo chmod 644 /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y && sudo apt install -y tailscale
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ]; then
            echo "âŒ Tailscale installation failed, no executable found"
            exit 0
          fi
          echo "âœ… Tailscale installed at: $TAILSCALE_PATH"
          if ! sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"; then
            echo "âŒ Tailscale login failed"
            sudo "$TAILSCALE_PATH" status
            exit 0
          fi
          echo "âœ… Tailscale IP address: $(sudo "$TAILSCALE_PATH" ip -4)"
          echo "âœ… Tailscale deployed successfully"

      - name: Create Snapshot and Upload to WebDAV
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # è§¦å‘ç»­è·‘å·¥ä½œæµå‡½æ•°
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ USER_PAT or REPO is empty"
              return 1
            fi
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âŒ Failed to trigger renewal workflow"
              return 1
            fi
            echo "âœ… Renewal workflow triggered successfully"
            RENEW_TRIGGERED=true
            return 0
          }
          
          # åˆ›å»ºå¹¶ä¸Šä¼ å¿«ç…§å‡½æ•°ï¼ˆç§»é™¤EOFï¼Œæ”¹ç”¨echoé€è¡Œåˆ›å»ºæ–‡ä»¶ï¼‰
          create_and_upload_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              return 1
            fi
            
            # å…³é”®éªŒè¯ï¼šæ£€æŸ¥å¹¶ç”Ÿæˆç¼ºå¤±çš„casaos.serviceæ–‡ä»¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç”¨echoæ›¿ä»£EOFï¼‰
            echo "ğŸ” Verifying critical files before backup..."
            if [ ! -f "/etc/systemd/system/casaos.service" ] && [ ! -f "/usr/lib/systemd/system/casaos.service" ]; then
              echo "âš ï¸ casaos.service file not found, generate default file..."
              sudo mkdir -p /etc/systemd/system
              # æ”¹ç”¨echoé€è¡Œå†™å…¥ï¼Œå½»åº•è§„é¿YAMLçš„EOFè§£æé—®é¢˜
              echo "[Unit]" > /tmp/casaos.service
              echo "Description=CasaOS Service" >> /tmp/casaos.service
              echo "After=docker.service network.target" >> /tmp/casaos.service
              echo "" >> /tmp/casaos.service
              echo "[Service]" >> /tmp/casaos.service
              echo "Type=simple" >> /tmp/casaos.service
              echo "ExecStart=/usr/bin/casaos" >> /tmp/casaos.service
              echo "Restart=always" >> /tmp/casaos.service
              echo "RestartSec=5" >> /tmp/casaos.service
              echo "User=root" >> /tmp/casaos.service
              echo "" >> /tmp/casaos.service
              echo "[Install]" >> /tmp/casaos.service
              echo "WantedBy=multi-user.target" >> /tmp/casaos.service
              # å¤åˆ¶åˆ°ç›®æ ‡ç›®å½•
              sudo cp /tmp/casaos.service /etc/systemd/system/
              rm -f /tmp/casaos.service
            fi
            if [ ! -f "/usr/bin/casaos" ]; then
              echo "âŒ /usr/bin/casaos executable not found! Please reinstall CasaOS"
              exit 1
            fi
            echo "âœ… All critical files verified"
            
            # ç”Ÿæˆå¿«ç…§åç§°
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ Creating snapshot: $SNAPSHOT_NAME (upload to WebDAV: ${REMOTE_PATH})"
            
            # åœæ­¢æœåŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
            sudo systemctl stop docker.service docker.socket casaos.service || true
            sudo systemctl mask docker.socket casaos.service
            sudo pkill -9 docker || true
            sudo pkill -9 containerd || true
            sudo pkill -9 casaos || true
            sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock
            sync && sleep 5
            
            # æ£€æŸ¥å¤‡ä»½ç›®å½•æ˜¯å¦å­˜åœ¨
            for dir in $CORE_DIRS; do
              if [ ! -d "$dir" ] && [ ! -f "$dir" ]; then
                echo "âš ï¸ Path $dir does not exist, skip backup"
              fi
            done
            
            # æ‰“åŒ…å¿«ç…§ï¼ˆç»å¯¹è·¯å¾„ï¼Œé¿å…æ¢å¤æ—¶è·¯å¾„ä¸¢å¤±ï¼‰
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS
            
            sudo chown runner:runner "${TMP_SNAPSHOT}"
            sudo chmod 644 "${TMP_SNAPSHOT}"
            
            # éªŒè¯å¿«ç…§æœ‰æ•ˆæ€§
            if [ ! -f "${TMP_SNAPSHOT}" ] || [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 1024 ]; then
              echo "âŒ Snapshot is empty or invalid (size < 1KB)"
              sudo systemctl unmask docker.socket casaos.service
              sudo systemctl start docker.service docker.socket || true
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl start casaos.service || true
              fi
              return 1
            fi
            
            echo "âœ… Snapshot created: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"
            
            # ä¸Šä¼ å¿«ç…§åˆ°WebDAV
            if ! sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --header "Content-Type: application/xml;charset=utf-8" \
              --log-level INFO \
              --log-file /tmp/rclone_upload.log; then
              echo "âŒ Upload failed, check log: /tmp/rclone_upload.log"
              cat /tmp/rclone_upload.log || true
              rm -f "${TMP_SNAPSHOT}"
              sudo systemctl unmask docker.socket casaos.service
              sudo systemctl start docker.service docker.socket || true
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl start casaos.service || true
              fi
              return 1
            fi
            
            # ä¸Šä¼ å…ƒæ•°æ®æ–‡ä»¶
            echo "âœ… Snapshot uploaded to WebDAV: ${REMOTE_PATH}"
            META_FILE="/tmp/snapshot_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf
            rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
            
            # é‡å¯æœåŠ¡
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl start docker.service docker.socket || true
            if systemctl list-unit-files | grep -q casaos.service; then
              sudo systemctl start casaos.service || true
            fi
            return 0
          }
          
          # ä¸»å¾ªç¯ï¼šå®šæ—¶åˆ›å»ºå¿«ç…§+ç»­è·‘è§¦å‘
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Šå·¥ä½œæµç¨‹è¿è¡Œæ—¶é—´${run_mins}åˆ†é’Ÿ"
            
            # è¿è¡Œ2åˆ†é’Ÿååˆ›å»ºå¿«ç…§å¹¶è§¦å‘ç»­è·‘
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â°æ˜¯æ—¶å€™åˆ›å»ºå¹¶ä¸Šä¼ å¿«ç…§äº†"
              if create_and_upload_snapshot; then
                trigger_renew
              else
                echo "âŒå¿«ç…§åˆ›å»ºå¤±è´¥ï¼Œè·³è¿‡ç»­è·‘"
              fi
            fi
            
            # è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´åé€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸å·²è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œæ­£åœ¨é€€å‡º"
              exit 0
            fi
            
            sleep 60
          done

      - name: æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket casaos.service || true
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          echo "âœ…æ¸…ç†æˆåŠŸå®Œæˆ"
