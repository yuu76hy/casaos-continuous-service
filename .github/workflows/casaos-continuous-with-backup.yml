name: CasaOSÁ∫ØÂáÄÈÉ®ÁΩ≤ÔºàÂèåÊ®°ÂºèÁ≤æÁÆÄÁâàÔΩú‰øÆÂ§ç+‰ø°ÊÅØÊ±áÊÄªÔºâ
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      LOCAL_MOUNT_POINT: "/op"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 15
      SNAPSHOT_MD5_SUFFIX: ".md5"

    steps:
      # 1. ÂàùÂßãÂåñÁ≥ªÁªü‰∏éÁéØÂ¢É
      - name: 1-ÂàùÂßãÂåñÁ≥ªÁªü‰∏éÁéØÂ¢É
        run: |
          set -e
          echo "WORKFLOW_START_TIMESTAMP=$(date +%s)" >> "$GITHUB_ENV"
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg zstd davfs2 -qq
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          INSTALL_RETRY=3
          while [ $INSTALL_RETRY -gt 0 ]; do
            curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun && break
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            sleep 30
          done
          [ $INSTALL_RETRY -eq 0 ] && exit 1
          sudo systemctl enable --now docker containerd
          sudo usermod -aG docker runner
          echo "‚úÖ Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê"

      # 2. ÈÖçÁΩÆÁî®Êà∑‰∏éÊ£ÄÊü•Á©∫Èó¥
      - name: 2-ÈÖçÁΩÆÁî®Êà∑‰∏éÊ£ÄÊü•Á©∫Èó¥
        run: |
          set -e
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          TMP_FREE=$(df -h /tmp | grep /tmp | awk '{print $4}' | sed 's/G//')
          [ "$TMP_FREE" -lt 5 ] && exit 1
          echo "‚úÖ Áî®Êà∑ÈÖçÁΩÆ‰∏éÁ©∫Èó¥Ê£ÄÊü•ÈÄöËøá"

      # 3. ÂàùÂßãÂåñÂèåÊ®°ÂºèÔºàÊåÇËΩΩ+RcloneÔºâ
      - name: 3-ÂàùÂßãÂåñÂèåÊ®°ÂºèÔºàÊåÇËΩΩ+RcloneÔºâ
        run: |
          set -e
          sudo mkdir -p "${LOCAL_MOUNT_POINT}" && sudo chmod 755 "${LOCAL_MOUNT_POINT}"
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "USE_MOUNT=false" >> "$GITHUB_ENV"
            echo "USE_RCLONE=false" >> "$GITHUB_ENV"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # ÊåÇËΩΩÊ®°Âºè
          MOUNT_OK=false
          echo "${WEBDAV_URL} ${WEBDAV_USER} ${WEBDAV_PASSWORD}" | sudo tee -a /etc/davfs2/secrets >/dev/null
          sudo chmod 600 /etc/davfs2/secrets
          if sudo mount -t davfs "${WEBDAV_URL}" "${LOCAL_MOUNT_POINT}" -o uid=0,gid=0,file_mode=600,dir_mode=700; then
            sleep 2
            mount | grep -q "${LOCAL_MOUNT_POINT}" && MOUNT_OK=true && sudo mkdir -p "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
          fi
          # RcloneÊ®°Âºè
          RCLONE_OK=false
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf && RCLONE_OK=true
          # Ê†áËÆ∞ÂèØÁî®Áä∂ÊÄÅ
          echo "USE_MOUNT=$MOUNT_OK" >> "$GITHUB_ENV"
          echo "USE_RCLONE=$RCLONE_OK" >> "$GITHUB_ENV"
          [ "$MOUNT_OK" = true ] || [ "$RCLONE_OK" = true ] && echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV" || echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          echo "‚úÖ ÂèåÊ®°ÂºèÂàùÂßãÂåñÂÆåÊàê"

      # 4. Ê£ÄÊµãÂéÜÂè≤Âø´ÁÖß
      - name: 4-Ê£ÄÊµãÂéÜÂè≤Âø´ÁÖß
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          LATEST_SNAPSHOT=""
          # ‰ºòÂÖàÊåÇËΩΩ
          if [ "${USE_MOUNT}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            LATEST=$(ls -t "${REMOTE_DIR}"/casaos-full-snapshot*.tar.zst 2>/dev/null | head -1 || true)
            [ -n "$LATEST" ] && LATEST_SNAPSHOT=$(basename "$LATEST")
          fi
          # ÊåÇËΩΩÊó†ÂàôRclone
          if [ -z "$LATEST_SNAPSHOT" ] && [ "${USE_RCLONE}" = true ]; then
            LATEST=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | grep tar.zst | sort -r | head -1 | awk '{print $2}' || true)
            [ -n "$LATEST" ] && LATEST_SNAPSHOT="$LATEST"
          fi
          [ -n "$LATEST_SNAPSHOT" ] && {
            echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
            echo "LATEST_SNAPSHOT_MD5=${LATEST_SNAPSHOT}${SNAPSHOT_MD5_SUFFIX}" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          } || {
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          }
          echo "‚úÖ Âø´ÁÖßÊ£ÄÊµãÂÆåÊàê"

      # 5. ÂÆâË£ÖCasaOS
      - name: 5-ÂÆâË£ÖCasaOS
        run: |
          set -e
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          CASAOS_RETRY=2
          while [ $CASAOS_RETRY -gt 0 ]; do
            curl -fsSL https://get.casaos.io | sudo bash && break
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sleep 30
          done
          [ $CASAOS_RETRY -eq 0 ] && exit 1
          sudo systemctl stop casaos
          echo "‚úÖ CasaOSÂÆâË£ÖÂÆåÊàê"

      # 6. ÊÅ¢Â§çÂø´ÁÖßÔºàËá™Âä®ÂàáÊç¢Ôºâ
      - name: 6-ÊÅ¢Â§çÂø´ÁÖßÔºàËá™Âä®ÂàáÊç¢Ôºâ
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sync && sleep 2
          SNAP=${LATEST_SNAPSHOT}
          MD5=${LATEST_SNAPSHOT_MD5}
          RESTORE_OK=false
          # ÊåÇËΩΩÊÅ¢Â§ç
          if [ "${USE_MOUNT}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            SNAP_PATH="${REMOTE_DIR}/${SNAP}"
            MD5_PATH="${REMOTE_DIR}/${MD5}"
            if [ -f "$SNAP_PATH" ] && [ -f "$MD5_PATH" ]; then
              cd /tmp && cp "$MD5_PATH" .
              md5sum -c "$(basename "$MD5_PATH")" < "$SNAP_PATH" && {
                sudo mkdir -p $PERSONAL_DATA_DIRS
                sudo tar -I zstd -xf "$SNAP_PATH" -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
                RESTORE_OK=true
              }
            fi
          fi
          # RcloneÊÅ¢Â§ç
          if [ "$RESTORE_OK" = false ] && [ "${USE_RCLONE}" = true ]; then
            rclone copy mywebdav:${WEBDAV_SNAPSHOT_DIR}/${MD5} /tmp --config /home/runner/.rclone.conf
            rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAP} --config /home/runner/.rclone.conf | tee >(md5sum -c /tmp/${MD5}) >/dev/null && {
              sudo mkdir -p $PERSONAL_DATA_DIRS
              rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAP} --config /home/runner/.rclone.conf | sudo tar -I zstd -xf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
              RESTORE_OK=true
            }
          fi
          [ "$RESTORE_OK" = false ] && exit 1
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "‚úÖ Âø´ÁÖßÊÅ¢Â§çÂÆåÊàê"

      # 7. ÂàõÂª∫Á©∫ÁõÆÂΩïÔºàÊó†Âø´ÁÖßÊó∂Ôºâ
      - name: 7-ÂàõÂª∫Á©∫ÁõÆÂΩïÔºàÊó†Âø´ÁÖßÊó∂Ôºâ
        if: ${{ env.WEBDAV_AVAILABLE != 'true' || env.HAS_SNAPSHOT != 'true' }}
        run: |
          set -e
          sudo mkdir -p /etc/casaos /var/lib/casaos /DATA
          echo "‚úÖ Á©∫ÁõÆÂΩïÂàõÂª∫ÂÆåÊàê"

      # 8. ÂêØÂä®Docker‰∏éCasaOS
      - name: 8-ÂêØÂä®Docker‰∏éCasaOS
        run: |
          set -e
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo systemctl restart docker containerd
          sleep 3
          DOCKER_RETRY=3
          while [ $DOCKER_RETRY -gt 0 ]; do
            docker ps >/dev/null 2>&1 && break
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl restart docker containerd && sleep 10
          done
          [ $DOCKER_RETRY -eq 0 ] && exit 1
          sudo systemctl enable --now casaos
          sleep 5
          CASAOS_RETRY=3
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo lsof -i:80 | grep LISTEN >/dev/null 2>&1 && break
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl restart casaos && sleep 10
          done
          [ $CASAOS_RETRY -eq 0 ] && exit 1
          echo "‚úÖ ÊúçÂä°ÂêØÂä®ÂÆåÊàê"

      # 9. TailscaleÁªÑÁΩë
      - name: 9-TailscaleÁªÑÁΩë
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || true)
          echo "TAILSCALE_IP=${TAILSCALE_IP:-Êú™Ëé∑Âèñ}" >> "$GITHUB_ENV"
          echo "‚úÖ TailscaleÁªÑÁΩëÂÆåÊàêÔºåÂÜÖÁΩëIPÔºö${TAILSCALE_IP:-Êú™Ëé∑Âèñ}"

      # 10. Á≥ªÁªü‰∏éÂ§á‰ªΩÊ∏ÖÁêÜÔºà‰øÆÂ§çÁâàÔºâ
      - name: 10-Á≥ªÁªü‰∏éÂ§á‰ªΩÊ∏ÖÁêÜ
        if: ${{ always() }}
        run: |
          set -e
          # Á≥ªÁªüÊ∏ÖÁêÜ
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n /opt/hostedtoolcache /opt/runner-cache
          sudo apt autoremove --purge -y && sudo apt clean
          sudo journalctl --vacuum-size=100M --vacuum-time=7d
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/*
          sudo sync && echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || true
          # ÊóßÂ§á‰ªΩÊ∏ÖÁêÜÔºà‰øÆÂ§çÁ©∫ÂÄºÈóÆÈ¢òÔºâ
          if [ "${WEBDAV_AVAILABLE}" = true ]; then
            # ÊåÇËΩΩÊ®°ÂºèÊ∏ÖÁêÜ
            if [ "${USE_MOUNT}" = true ]; then
              REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
              BACKUPS=$(ls -t "${REMOTE_DIR}"/casaos-full-snapshot*.tar.zst 2>/dev/null)
              COUNT=$(printf "%s" "$BACKUPS" | wc -l)
              if [ $COUNT -gt $KEEP_BACKUPS ]; then
                echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
                  if [ -n "$f" ]; then
                    rm -f "$f" "${f}${SNAPSHOT_MD5_SUFFIX}"
                    echo "üóëÔ∏è ÊåÇËΩΩÊ®°ÂºèÂà†Èô§: $(basename "$f")"
                  fi
                done
              fi
            fi
            # RcloneÊ®°ÂºèÊ∏ÖÁêÜ
            if [ "${USE_RCLONE}" = true ]; then
              BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | grep tar.zst | sort -r | awk '{print $2}')
              COUNT=$(printf "%s" "$BACKUPS" | wc -l)
              if [ $COUNT -gt $KEEP_BACKUPS ]; then
                echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
                  if [ -n "$f" ]; then
                    rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$f --config /home/runner/.rclone.conf
                    rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${f}${SNAPSHOT_MD5_SUFFIX} --config /home/runner/.rclone.conf
                    echo "üóëÔ∏è rclone Ê®°ÂºèÂà†Èô§: $f"
                  fi
                done
              fi
            fi
          fi
          echo "‚úÖ Ê∏ÖÁêÜÂÆåÊàê"

      # 11. Âª∂Êó∂Ê†°ÂáÜ+ÈáçË¶Å‰ø°ÊÅØÊ±áÊÄª
      - name: 11-Âª∂Êó∂Ê†°ÂáÜ+ÈáçË¶Å‰ø°ÊÅØÊ±áÊÄª
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          START=${WORKFLOW_START_TIMESTAMP}
          NOW=$(date +%s)
          DUR=$((NOW - START))
          TARGET=$((TARGET_RUN_MINUTES * 60))
          WAIT=$((TARGET - DUR))

          # ÈáçË¶Å‰ø°ÊÅØÊ±áÊÄªËæìÂá∫
          echo "====================================="
          echo "üìä ÈáçË¶Å‰ø°ÊÅØÊ±áÊÄªÔºàÂª∂Êó∂Á≠âÂæÖÊúüÈó¥Ôºâ"
          echo "====================================="
          echo "üîå Â§á‰ªΩÊ®°ÂºèÔºö"
          [ "${USE_MOUNT}" = true ] && echo "   ‚úÖ ÊåÇËΩΩÊ®°ÂºèÔºà/opÔºâÂèØÁî®Ôºà‰ºòÂÖà‰ΩøÁî®Ôºâ"
          [ "${USE_RCLONE}" = true ] && echo "   ‚úÖ RcloneÊ®°ÂºèÂèØÁî®ÔºàÂÖúÂ∫ï‰ΩøÁî®Ôºâ"
          echo "üîç ÊúçÂä°Áä∂ÊÄÅÔºö"
          sudo systemctl is-active --quiet docker && echo "   ‚úÖ DockerÔºöÊ≠£Â∏∏ËøêË°å" || echo "   ‚ö†Ô∏è DockerÔºöÊú™ËøêË°å"
          sudo systemctl is-active --quiet casaos && echo "   ‚úÖ CasaOSÔºöÊ≠£Â∏∏ËøêË°å" || echo "   ‚ö†Ô∏è CasaOSÔºöÊú™ËøêË°å"
          [ -n "${TAILSCALE_IP}" ] && echo "üåê TailscaleÁªÑÁΩëÔºö${TAILSCALE_IP}" || echo "üåê TailscaleÔºöÊú™ÈÖçÁΩÆ/Êú™Ëé∑ÂèñIP"
          echo "‚è±Ô∏è Â∑•‰ΩúÊµÅÁä∂ÊÄÅÔºö"
          echo "   Â∑≤ËøêË°åÔºö$((DUR/60))ÂàÜ$((DUR%60))Áßí"
          if [ $WAIT -gt 0 ]; then
            echo "   ÈúÄÁ≠âÂæÖÔºö$((WAIT/60))ÂàÜ$((WAIT%60))ÁßíÔºàÊÄªÊó∂ÈïøÊª°15ÂàÜÔºâ"
            sleep $WAIT
          else
            echo "   Â∑≤Êª°Ë∂≥15ÂàÜÈíüË¶ÅÊ±ÇÔºåÁõ¥Êé•ËøõÂÖ•Â§á‰ªΩ"
          fi
          echo "====================================="
          echo "‚úÖ Âª∂Êó∂ÂÆåÊàê"

      # 12. ÊâìÂåÖÂπ∂Â§á‰ªΩ
      - name: 12-ÊâìÂåÖÂπ∂Â§á‰ªΩ
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sync && sleep 3
          SNAP_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          MD5_NAME="${SNAP_NAME}${SNAPSHOT_MD5_SUFFIX}"
          LOCAL_SNAP="/tmp/${SNAP_NAME}"
          LOCAL_MD5="/tmp/${MD5_NAME}"
          # Êú¨Âú∞ÊâìÂåÖ
          sudo tar -I 'zstd -T0 -3' -cPf "$LOCAL_SNAP" $EXCLUDE_RULES --warning=no-file-changed --exclude=*/socket --one-file-system $PERSONAL_DATA_DIRS
          sudo md5sum "$LOCAL_SNAP" > "$LOCAL_MD5"
          BACKUP_OK=false
          # ÊåÇËΩΩ‰∏ä‰º†
          if [ "${USE_MOUNT}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            cp "$LOCAL_SNAP" "$REMOTE_DIR/" && cp "$LOCAL_MD5" "$REMOTE_DIR/" && BACKUP_OK=true
          fi
          # Rclone‰∏ä‰º†
          if [ "$BACKUP_OK" = false ] && [ "${USE_RCLONE}" = true ]; then
            rclone copy "$LOCAL_SNAP" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --transfers 4 --retries 5 --timeout 2h
            rclone copy "$LOCAL_MD5" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --retries 5
            BACKUP_OK=true
          fi
          [ "$BACKUP_OK" = false ] && exit 1
          rm -f "$LOCAL_SNAP" "$LOCAL_MD5"
          sudo systemctl enable --now docker containerd casaos && sleep 3
          # Ëß¶ÂèëÁª≠Ë∑ë
          [ -n "$USER_PAT" ] && [ -n "$REPO" ] && curl -fsSL --fail -X POST -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_snapshot"}'
          echo "‚úÖ Â§á‰ªΩÂÆåÊàê"

      # 13. Êî∂Â∞æÊ∏ÖÁêÜ
      - name: 13-Êî∂Â∞æÊ∏ÖÁêÜ
        if: ${{ always() }}
        run: |
          set -e
          # Âç∏ËΩΩÊåÇËΩΩ
          mount | grep -q "${LOCAL_MOUNT_POINT}" && sudo umount "${LOCAL_MOUNT_POINT}" 2>/dev/null || true
          # Ê∏ÖÁêÜÊïèÊÑüÊñá‰ª∂
          sudo rm -rf /tmp/* /var/tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots /etc/davfs2/secrets 2>/dev/null || true
          sudo apt autoremove -y && sudo apt clean
          echo "üéâ ÂÖ®ÊµÅÁ®ãÂÆåÊàê"