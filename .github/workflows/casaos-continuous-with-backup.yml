name: CasaOS纯净部署（无优化+部署恢复分离+10分钟备份续跑关流）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360  # 360分钟冗余防中断
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      DELAY_TOTAL_MIN: 10  # 10分钟延时
      CORE_SERVICES: "docker containerd casaos" # 核心进程管控

    steps:
      - name: 1-系统初始化（极简版）
        run: |
          set -e
          echo "===== 系统快速初始化 ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "✅ 初始化完成"

      - name: 2-官方一键装Docker（含compose）
        run: |
          set -e
          echo "===== 官方一键安装Docker ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "✅ Docker安装完成"

      - name: 3-创建免密管理员用户
        run: |
          set -e
          echo "===== 创建免密管理员用户 ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ];then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "🔑 roots随机密码：$RANDOM_PASS"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "✅ 用户配置完成"

      - name: 4-WebDAV配置+快照检测+目录预创建+变量赋值
        run: |
          set -e
          echo "===== WebDAV配置&快照检测&目录预创建 ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "⚠️ WebDAV凭证缺失，跳过备份恢复"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" && sudo chmod 755 "$dir"
          done
          if rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep -q ".tar.gz"; then
            echo "✅ 检测到WebDAV备份快照"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
            # 提前赋值最新快照名，供后续恢复使用
            LATEST_SNAPSHOT=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep .tar.gz | sort -r | head -n1 | awk '{print $2}')
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "ℹ️ 无备份快照，全新部署"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "✅ WebDAV配置完成"

      - name: 5-Tailscale组网配置
        run: |
          set -e
          echo "===== Tailscale组网配置 ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "⚠️ Tailscale密钥缺失，跳过组网"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-dns=false --accept-routes=false
          sleep 3
          echo "✅ Tailscale组网成功，IP：$(tailscale ip -4)"

      - name: 6-CasaOS基础部署（仅系统，不恢复数据）
        run: |
          set -e
          echo "===== CasaOS基础部署（仅系统，不恢复数据） ====="
          curl -fsSL https://get.casaos.io | sudo bash
          if [ "$HAS_SNAPSHOT" = "false" ]; then
            sudo systemctl enable --now casaos && sleep 5
            echo "✅ CasaOS全新部署完成（无数据恢复）"
          else
            sudo systemctl stop casaos 2>/dev/null
            sudo systemctl stop docker containerd 2>/dev/null
            echo "✅ CasaOS基础部署完成，等待数据恢复"
          fi

      - name: 7-恢复个人数据（无快照自动跳过，恢复不删快照）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== 精准恢复个人数据 ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          echo "📌 恢复目录清单：$PERSONAL_DATA_DIRS"
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "✅ 数据恢复完成，权限校正完毕【恢复不删快照】"

      - name: 8-权限校正+极速启动所有服务
        run: |
          set -e
          echo "===== 权限校正+启动服务 ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          else
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          fi
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "✅ 所有服务启动完成"
          echo "📌 访问地址：服务器IP（80端口）"

      - name: 9-10分钟倒计时+停进程备份+保留2份删旧+先续跑再关流
        run: |
          set -e
          echo "⏳ 开始${DELAY_TOTAL_MIN}分钟倒计时，每分钟更新剩余时间"
          for ((i=${DELAY_TOTAL_MIN};i>0;i--)); do
            echo "⌛ 剩余延时：${i}分钟（总计${DELAY_TOTAL_MIN}分钟）"
            sleep 60
          done
          echo "🎉 倒计时结束，停进程开始备份"
          
          # 停所有进程保备份纯净
          echo "🛑 关停核心进程"
          sudo systemctl stop $CORE_SERVICES 2>/dev/null
          sudo pkill -f docker 2>/dev/null && sudo pkill -f casaos 2>/dev/null
          echo "✅ 进程已关停，开始备份"
          
          # 完整备份流程（带进度）
          SNAPSHOT_NAME="casaos-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "📥 【备份1/4】创建本地备份包：${SNAPSHOT_NAME}"
          sudo tar -zcvf /tmp/"$SNAPSHOT_NAME" $EXCLUDE_RULES $PERSONAL_DATA_DIRS --preserve-permissions
          echo "✅ 【备份2/4】本地备份完成"
          echo "📤 【备份3/4】上传WebDAV（实时进度）"
          rclone copy -P /tmp/"$SNAPSHOT_NAME" mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf
          echo "✅ 【备份4/4】上传完成"
          
          # 仅保留最新2份备份，其余全部删除（唯一清理逻辑）
          echo "🧹 清理旧备份，仅保留最新${KEEP_BACKUPS}份"
          BACKUPS_LIST=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep .tar.gz | sort -r | awk '{print $2}')
          BACKUPS_COUNT=$(echo "$BACKUPS_LIST" | wc -l)
          if [ "$BACKUPS_COUNT" -gt "$KEEP_BACKUPS" ]; then
            DELETE_LIST=$(echo "$BACKUPS_LIST" | tail -n $((BACKUPS_COUNT - KEEP_BACKUPS)))
            for backup in $DELETE_LIST; do
              rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$backup" --config /home/runner/.rclone.conf
              echo "🗑️ 删除旧备份：$backup"
            done
            echo "✅ 旧备份清理完成，保留最新${KEEP_BACKUPS}份"
          else
            echo "ℹ️ 当前备份≤${KEEP_BACKUPS}份，无需清理"
          fi
          sudo rm -f /tmp/"$SNAPSHOT_NAME"
          
          # 重启进程恢复服务
          echo "🔄 重启核心进程恢复服务"
          sudo systemctl restart $CORE_SERVICES && sleep 8
          sudo systemctl is-active --quiet $CORE_SERVICES && echo "✅ 服务恢复正常" || echo "⚠️ 进程重启异常"
          
          # 核心顺序：备份完成→先续跑→再关当前流
          echo "====================================="
          echo "📌 备份完成，执行续跑+关流"
          echo "🔄 第一步：触发续跑工作流"
          curl -X POST https://api.github.com/repos/${REPO}/dispatches \
          -H "Authorization: token ${USER_PAT}" \
          -H "Accept: application/vnd.github+json" \
          -d '{"event_type":"renew_casaos_snapshot"}'
          echo "✅ 续跑触发成功"
          echo "🔚 第二步：关闭当前工作流"
          gh auth login --with-token <<< "${USER_PAT}"
          RUN_ID=$(jq -r ".run_id" "$GITHUB_EVENT_PATH")
          gh api -X POST repos/${REPO}/actions/runs/${RUN_ID}/cancel
          echo "✅ 当前工作流（ID:${RUN_ID}）已关闭"
          echo "📌 全流程结束"
          echo "====================================="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
