name: CasaOSå…¨é‡å¤‡ä»½æ¢å¤ï¼ˆå…ˆè£…åè¦† ç¨³å®šç‰ˆï¼‰

on:
  workflow_dispatch:                # æ‰‹åŠ¨è§¦å‘ï¼ˆæ ¸å¿ƒè§¦å‘æ–¹å¼ï¼‰
  repository_dispatch:
    types: [renew_casaos_snapshot]  # è‡ªåŠ¨ç»­è·‘è§¦å‘

jobs:
  casaos-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /usr/lib/systemd/system/docker.service /etc/systemd/system/docker.service.d /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/lib/systemd/system/casaos.service /etc/systemd/system/casaos.service /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=/var/lib/docker/volumes/*/_data/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–&æ ¸å¿ƒä¾èµ–å…¨é‡å®‰è£…
        run: |
          set -e
          echo "===== ç³»ç»Ÿåˆå§‹åŒ–&ä¾èµ–å®‰è£… ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          sudo apt install -y curl wget jq fuse3 tar gzip bzip2 locales openssl ca-certificates apt-transport-https sshpass net-tools iputils-ping lsof -qq
          sudo locale-gen zh_CN.UTF-8 && sudo update-locale LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

          # å®‰è£…Rcloneï¼ˆWebDAVä¼ è¾“æ ¸å¿ƒï¼‰
          if ! command -v rclone &>/dev/null; then
            INSTALL_RETRY=3
            until curl -fsSL https://rclone.org/install.sh | sudo bash; do
              INSTALL_RETRY=$((INSTALL_RETRY-1))
              if [ $INSTALL_RETRY -eq 0 ]; then
                RCLONE_VER=$(curl -s https://api.github.com/repos/rclone/rclone/releases/latest | jq -r .tag_name | sed 's/v//')
                wget -q https://downloads.rclone.org/v${RCLONE_VER}/rclone-v${RCLONE_VER}-linux-amd64.deb -O /tmp/rclone.deb
                sudo dpkg -i /tmp/rclone.deb && sudo apt install -f -y -qq
                break
              fi
              sleep 3
            done
          fi

          # å®‰è£…Dockerï¼ˆCasaOSæ ¸å¿ƒä¾èµ–ï¼‰
          if ! command -v docker &>/dev/null; then
            sudo apt install -y docker.io docker-compose-plugin -qq
            sudo systemctl enable docker && sudo usermod -aG docker runner
          fi
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä¾èµ–å…¨éƒ¨å°±ç»ª"

      - name: 2-åˆ›å»ºrootæƒé™ç”¨æˆ·ï¼ˆå…å¯†sudoï¼‰
        run: |
          set -e
          echo "===== åˆ›å»ºæ ¹æƒé™ç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"

          # é…ç½®å¯†ç ï¼ˆè‡ªå®šä¹‰/éšæœºï¼‰
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
            echo "âœ… ç”¨æˆ·å¯†ç ï¼šè‡ªå®šä¹‰é…ç½®"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "âœ… ç”¨æˆ·éšæœºå¯†ç ï¼š$RANDOM_PASSï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼‰"
          fi

          # å…å¯†sudoæˆæƒ+Dockeræƒé™
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          echo "âœ… rootsç”¨æˆ·é…ç½®å®Œæˆï¼Œå…å¯†sudo+Dockeræƒé™"

      - name: 3-Rcloneé…ç½®+WebDAVè¿é€šæ ¡éªŒ
        run: |
          set -e
          echo "===== Rcloneé…ç½®&WebDAVè¿é€šæ ¡éªŒ ====="
          # å‡­è¯æ ¡éªŒ
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œç¦ç”¨å¤‡ä»½æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          if ! echo "$WEBDAV_URL" | grep -qE "^http://|^https://"; then
            echo "âŒ WebDAVåœ°å€æ ¼å¼é”™è¯¯ï¼Œéœ€å¸¦http/httpså‰ç¼€"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # é…ç½®Rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="webdav" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf

          # æ ¡éªŒ/z/Uduç›®å½•æƒé™
          echo "ğŸ” æ ¡éªŒ/z/Uduç›®å½•è®¿é—®æƒé™"
          rclone mkdir mywebdav:/z/Udu --config /home/runner/.rclone.conf 2>/dev/null || true
          if ! timeout 30 rclone ls mywebdav:/z/Udu --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ /z/Uduç›®å½•æ— è®¿é—®æƒé™"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # åˆ›å»ºå¿«ç…§ç›®å½•+æŸ¥æ‰¾æœ€æ–°å¿«ç…§
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null || true
          REMOTE_FILES=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null)
          LATEST_SNAPSHOT=""
          if [ -n "$REMOTE_FILES" ]; then
            LATEST_SNAPSHOT=$(echo "$REMOTE_FILES" | grep -E "casaos-full-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz" | sed -E 's/^[0-9]+[[:space:]]+//' | xargs -n1 basename | sort -r | head -n1 | xargs)
            if [ -n "$LATEST_SNAPSHOT" ]; then
              echo "âœ… æ‰¾åˆ°æœ€æ–°å¤‡ä»½å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
              echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
              echo "FULL_SNAPSHOT_PATH=${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
            fi
          fi

          if [ -z "$LATEST_SNAPSHOT" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°å¤‡ä»½å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°éƒ¨ç½²"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "âœ… WebDAVé…ç½®å®Œæˆï¼Œè¿é€šæ­£å¸¸"

      - name: 4-æ¢å¤æ ¸å¿ƒæ•°æ®ï¼ˆä»…æ•°æ®ç›®å½•ï¼Œä¸è¦†ç¨‹åºï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== æ¢å¤æ ¸å¿ƒæ•°æ®ï¼ˆä»…æ•°æ®ï¼Œä¸è¦†ç›–ç¨‹åºï¼‰====="
          CLEAN_FULL_PATH="${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}"
          echo "ğŸ” å¿«ç…§æ¢å¤è·¯å¾„ï¼š${CLEAN_FULL_PATH}"

          # åœæ­¢ç›¸å…³æœåŠ¡+æ¸…ç†æ®‹ç•™è¿›ç¨‹
          sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 3

          # å¿«ç…§å®Œæ•´æ€§æ ¡éªŒ
          echo "ğŸ” æ ¡éªŒå¿«ç…§å®Œæ•´æ€§"
          if ! timeout 60 rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåæˆ–è·¯å¾„é”™è¯¯ï¼Œæ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi

          # å…³é”®ï¼šä»…æ¢å¤æ ¸å¿ƒæ•°æ®ç›®å½•ï¼Œè·³è¿‡ç¨‹åº/æœåŠ¡æ–‡ä»¶
          echo "ğŸ”„ å¼€å§‹æ¢å¤æ ¸å¿ƒæ•°æ®ï¼ˆDockeræ•°æ®+CasaOSé…ç½®+DATAï¼‰"
          sudo mkdir -p /var/lib/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions \
            /var/lib/docker \
            /etc/casaos \
            /var/lib/casaos \
            /DATA \
            /etc/docker
          echo "âœ… æ ¸å¿ƒæ•°æ®æ¢å¤å®Œæˆ"

          # åˆ é™¤å·²æ¢å¤å¿«ç…§ï¼Œé¿å…é‡å¤æ¢å¤
          rclone delete mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf 2>/dev/null || true
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "âœ… å·²åˆ é™¤å·²ç”¨å¿«ç…§ï¼Œé¿å…é‡å¤æ¢å¤"

          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
          echo "âœ… æ•°æ®æ¢å¤æµç¨‹å®Œæˆï¼Œç­‰å¾…å®‰è£…çº¯å‡€CasaOS"

      - name: 5-å…¨æ–°å®‰è£…çº¯å‡€CasaOSï¼ˆæ ¸å¿ƒåŸºç¡€ç¯å¢ƒï¼‰
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…çº¯å‡€CasaOS ====="
          # Dockerå…œåº•å¯åŠ¨ï¼ˆä¿®å¤è¯­æ³•+å¢å¼ºå®¹é”™ï¼‰
          echo "ğŸ”§ å¯åŠ¨DockeræœåŠ¡ï¼ˆå¤šé‡è¯•å®¹é”™ï¼‰"
          sudo systemctl stop docker docker.socket containerd 2>/dev/null || true
          sudo pkill -9 docker containerd 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sudo systemctl reset-failed docker containerd 2>/dev/null || true
          sync && sleep 3

          # å¤šæ¬¡é‡è¯•å¯åŠ¨Docker
          DOCKER_RETRY=6
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl enable --now docker docker.socket containerd
            sleep 5
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Dockerå¯åŠ¨æˆåŠŸ"
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            echo "âš ï¸ Dockerå¯åŠ¨å¤±è´¥ï¼Œå‰©ä½™é‡è¯•ï¼š${DOCKER_RETRY}æ¬¡"
            echo "ğŸ“œ DockerçŠ¶æ€æ—¥å¿—ï¼š" && sudo systemctl status docker -l | head -20
            echo "ğŸ“œ Dockeræ ¸å¿ƒæ—¥å¿—ï¼š" && sudo journalctl -xeu docker --no-pager | head -20
            echo "ğŸ“œ containerdçŠ¶æ€ï¼š" && sudo systemctl status containerd -l | head -10

            # ä¿®å¤daemon.jsoné…ç½®é”™è¯¯
            if [ -f "/etc/docker/daemon.json" ] && ! jq . /etc/docker/daemon.json >/dev/null 2>&1; then
              echo "ğŸ”§ ä¿®å¤Dockeré…ç½®æ–‡ä»¶daemon.json"
              sudo mv /etc/docker/daemon.json /etc/docker/daemon.json.bak
              sudo touch /etc/docker/daemon.json
              sudo systemctl daemon-reload
            fi
            sudo systemctl reset-failed docker && sleep 3
          done

          # æœ€ç»ˆDockeræ ¡éªŒ
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            sudo journalctl -xeu docker --no-pager | head -50
            exit 1
          fi

          # æ¸…ç†CasaOSæ—§æ®‹ç•™ï¼Œç¡®ä¿çº¯å‡€
          echo "ğŸ”§ æ¸…ç†CasaOSæ—§ç‰ˆæœ¬æ®‹ç•™"
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload

          # å…¨æ–°å®‰è£…CasaOS
          echo "ğŸ”§ å…¨æ–°å®‰è£…çº¯å‡€CasaOS"
          INSTALL_RETRY=3
          until curl -fsSL https://get.casaos.io | sudo bash; do
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            if [ $INSTALL_RETRY -eq 0 ]; then
              echo "âŒ CasaOSå®‰è£…å¤±è´¥"
              cat /var/log/casaos-install.log 2>/dev/null || true
              exit 1
            fi
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œå‰©ä½™é‡è¯•ï¼š${INSTALL_RETRY}æ¬¡" && sleep 10
          done

          # å®‰è£…ååœæ­¢ï¼Œç­‰å¾…æ•°æ®æƒé™æ ¡æ­£
          sudo systemctl stop casaos && sudo systemctl daemon-reload
          echo "âœ… çº¯å‡€CasaOSå®‰è£…å®Œæˆï¼Œå·²åœæ­¢ç­‰å¾…æ•°æ®è¦†ç›–"

          # æ­£ç¡®èµ‹å€¼å¿«ç…§æ¢å¤çŠ¶æ€
          if [ "${{ env.SNAPSHOT_RESTORED }}" = "true" ]; then
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
          else
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          fi

      - name: 6-æ•°æ®æƒé™æ ¡æ­£+æœåŠ¡å…œåº•å¯åŠ¨ï¼ˆæ ¸å¿ƒè¡”æ¥ï¼‰
        run: |
          set -e
          echo "===== æ•°æ®æƒé™æ ¡æ­£+CasaOSå…œåº•å¯åŠ¨ ====="
          sudo systemctl daemon-reload

          # 1 Dockeræœ€ç»ˆå…œåº•å¯åŠ¨
          echo "ğŸ”§ ç¡®ä¿Dockerç¨³å®šè¿è¡Œ"
          DOCKER_RETRY=3
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl start docker docker.socket
            sleep 4
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Dockerç¨³å®šè¿è¡Œ"
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl reset-failed docker && sleep 3
          done
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Dockerè¿è¡Œå¼‚å¸¸ï¼Œç»ˆæ­¢å¯åŠ¨" && exit 1
          fi

          # 2 å…¨é‡æƒé™æ ¡æ­£ï¼ˆå…ˆè£…åè¦†æ ¸å¿ƒä¿éšœï¼‰
          echo "ğŸ”§ å¼ºåˆ¶æ ¡æ­£æ‰€æœ‰ç›®å½•æƒé™"
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/casaos/appstore /DATA 2>/dev/null || true
          sudo chown -R root:root /etc/casaos /var/lib/casaos /DATA /var/lib/docker
          sudo chmod -R 755 /etc/casaos /DATA
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          sudo chmod 755 /usr/bin/casaos
          sudo chmod 644 /etc/systemd/system/casaos.service
          sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock
          sudo usermod -aG docker root 2>/dev/null || true
          echo "âœ… æƒé™æ ¡æ­£å®Œæˆï¼Œæ— è®¿é—®ç“¶é¢ˆ"

          # 3 é‡Šæ”¾é»˜è®¤ç«¯å£+åˆ›å»ºä¸“å±ç½‘ç»œ
          echo "ğŸ”§ é‡Šæ”¾CasaOSé»˜è®¤ç«¯å£+åˆ›å»ºç½‘ç»œ"
          sudo lsof -t -i:80 | xargs sudo kill -9 2>/dev/null || true
          sudo lsof -t -i:443 | xargs sudo kill -9 2>/dev/null || true
          sleep 2
          sudo docker network create casaos 2>/dev/null || true
          echo "âœ… 80/443ç«¯å£å·²é‡Šæ”¾ï¼Œcasaosç½‘ç»œåˆ›å»ºå®Œæˆ"

          # 4 CasaOSå¤šé‡è¯•å…œåº•å¯åŠ¨
          echo "ğŸ”§ å¯åŠ¨CasaOSæœåŠ¡"
          CASAOS_RETRY=5
          CASAOS_STARTED=false
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo systemctl start casaos
            sleep 5
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… CasaOSå¯åŠ¨æˆåŠŸï¼å…ˆè£…åè¦†æ–¹æ¡ˆç”Ÿæ•ˆ"
              CASAOS_STARTED=true
              break
            fi
            echo "âš ï¸ å¯åŠ¨å¤±è´¥ï¼Œå‰©ä½™é‡è¯•ï¼š$((CASAOS_RETRY-1))æ¬¡"
            echo "ğŸ“œ æœåŠ¡çŠ¶æ€æ—¥å¿—ï¼š" && sudo systemctl status casaos.service -l | head -20
            echo "ğŸ“œ æ ¸å¿ƒé”™è¯¯æ—¥å¿—ï¼š" && sudo journalctl -xeu casaos.service --no-pager | head -25
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl reset-failed casaos && sleep 3
          done

          # 5 ç»ˆæå…œåº•ï¼šå¼ºåˆ¶é‡è£…ä¿®å¤
          if [ "$CASAOS_STARTED" = "false" ]; then
            echo "âŒ å¤šæ¬¡å¯åŠ¨å¤±è´¥ï¼Œæ‰§è¡Œå…œåº•é‡è£…"
            curl -fsSL https://get.casaos.io | sudo bash -s -- --force-reinstall
            sudo systemctl daemon-reload && sudo systemctl start casaos && sleep 5
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… å…œåº•é‡è£…åCasaOSå¯åŠ¨æˆåŠŸ"
              CASAOS_STARTED=true
            else
              echo "âŒ æœ€ç»ˆå¯åŠ¨å¤±è´¥ï¼Œè¯¦ç»†æ—¥å¿—å¦‚ä¸‹ï¼š"
              sudo systemctl status casaos.service -l
              sudo journalctl -xeu casaos.service --no-pager | head -30
              exit 1
            fi
          fi

          # æœ€ç»ˆçŠ¶æ€è¾“å‡º
          echo "ğŸ“Š æœ€ç»ˆæœåŠ¡è¿è¡ŒçŠ¶æ€"
          sudo systemctl status docker --no-pager 2>/dev/null || echo "DockerçŠ¶æ€æ­£å¸¸"
          sudo systemctl status casaos --no-pager 2>/dev/null || echo "CasaOSçŠ¶æ€æ­£å¸¸"
          echo "âœ… æ•°æ®è¦†ç›–+æƒé™æ ¡æ­£+æœåŠ¡å¯åŠ¨å…¨å®Œæˆ"

      - name: 7-Tailscaleè¿œç¨‹ç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          echo "===== Tailscaleè¿œç¨‹ç»„ç½‘é…ç½® ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi

          # å®‰è£…Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq --upgrade

          # å¯åŠ¨å¹¶ç»„ç½‘
          sudo systemctl restart tailscaled && sudo systemctl enable tailscaled && sleep 5
          TS_HOSTNAME="CasaOS-Server-$(hostname | cut -c1-8)"
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --accept-routes
          sleep 3
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)

          if [ -n "$TS_IP" ]; then
            echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œè¿œç¨‹è®¿é—®IPï¼š${TS_IP}"
          else
            echo "âš ï¸ Tailscaleç»„ç½‘å®Œæˆï¼Œæœªè·å–IPv4åœ°å€"
          fi

      - name: 8-å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ˆæŒä¹…åŒ–ä¿éšœï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          echo "===== å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ ====="

          # è‡ªåŠ¨ç»­è·‘è§¦å‘å‡½æ•°
          trigger_workflow_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âš ï¸ ç»­è·‘é…ç½®ç¼ºå¤±ï¼ˆUSER_PAT/REPOæœªå¡«ï¼‰ï¼Œè·³è¿‡ç»­è·‘"
              return 1
            fi
            if ! curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âš ï¸ è‡ªåŠ¨ç»­è·‘è§¦å‘å¤±è´¥"
              return 1
            fi
            echo "âœ… è‡ªåŠ¨ç»­è·‘è§¦å‘æˆåŠŸï¼Œæ–°æµç¨‹å·²å¯åŠ¨"
            RENEW_TRIGGERED=true
            return 0
          }

          # å…¨é‡å¤‡ä»½ä¸Šä¼ å‡½æ•°
          full_backup_and_upload() {
            echo "ğŸ” ç­›é€‰æœ‰æ•ˆå¤‡ä»½è·¯å¾„"
            VALID_BACKUP_DIRS=""
            for path in $CORE_BACKUP_DIRS; do
              [ -e "$path" ] && VALID_BACKUP_DIRS="$VALID_BACKUP_DIRS $path"
            done
            [ -z "$VALID_BACKUP_DIRS" ] && { echo "âŒ æ— æœ‰æ•ˆå¤‡ä»½è·¯å¾„"; return 1; }

            # æ£€æŸ¥å¤‡ä»½ç©ºé—´
            BACKUP_TMP_DIR="/home/runner/casaos-backup-tmp"
            sudo rm -rf "$BACKUP_TMP_DIR" && sudo mkdir -p "$BACKUP_TMP_DIR"
            sudo chown runner:runner "$BACKUP_TMP_DIR"
            FREE_SPACE_GB=$(( $(df -k "$BACKUP_TMP_DIR" | awk 'NR==2{print $4}') / 1024 / 1024 ))
            if [ $FREE_SPACE_GB -lt 5 ]; then
              echo "âŒ å¤‡ä»½ç©ºé—´ä¸è¶³5GBï¼Œå–æ¶ˆå¤‡ä»½"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "âœ… å¤‡ä»½ç©ºé—´å……è¶³ï¼ˆå‰©ä½™${FREE_SPACE_GB}GBï¼‰"

            # æ‰“åŒ…å¤‡ä»½æ–‡ä»¶
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            LOCAL_SNAPSHOT="$BACKUP_TMP_DIR/$SNAPSHOT_NAME"
            echo "ğŸ”„ å¼€å§‹å…¨é‡æ‰“åŒ…ï¼Œæ–‡ä»¶åï¼š${SNAPSHOT_NAME}"
            sudo tar -czPf "$LOCAL_SNAPSHOT" --ignore-failed-read --preserve-permissions --dereference $EXCLUDE_RULES $VALID_BACKUP_DIRS > "$BACKUP_TMP_DIR/tar_log.txt" 2>&1

            # æ‰“åŒ…æ ¡éªŒ
            if [ ! -s "$LOCAL_SNAPSHOT" ]; then
              echo "âŒ å¤‡ä»½æ‰“åŒ…å¤±è´¥ï¼Œæ—¥å¿—ï¼š" && cat "$BACKUP_TMP_DIR/tar_log.txt"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            SNAPSHOT_SIZE=$(du -sh "$LOCAL_SNAPSHOT" | awk '{print $1}')
            echo "âœ… æ‰“åŒ…å®Œæˆï¼Œå¤‡ä»½å¤§å°ï¼š${SNAPSHOT_SIZE}"

            # åœæ­¢æœåŠ¡+ä¸Šä¼ å¤‡ä»½
            sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
            sync && sleep 2
            echo "ğŸ“¤ ä¸Šä¼ å¤‡ä»½åˆ°WebDAV"
            if ! rclone copy "$LOCAL_SNAPSHOT" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/" --config /home/runner/.rclone.conf --transfers 4 --fast-list --progress; then
              echo "âŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥"
              sudo rm -rf "$BACKUP_TMP_DIR"
              sudo systemctl start docker docker.socket casaos 2>/dev/null || true
              return 1
            fi

            # ä¸Šä¼ å…ƒæ•°æ®
            echo "snapshot_name=$SNAPSHOT_NAME" > "$BACKUP_TMP_DIR/backup-meta.txt"
            echo "backup_time=$(date '+%Y-%m-%d %H:%M:%S')" >> "$BACKUP_TMP_DIR/backup-meta.txt"
            echo "backup_size=$SNAPSHOT_SIZE" >> "$BACKUP_TMP_DIR/backup-meta.txt"
            rclone copy "$BACKUP_TMP_DIR/backup-meta.txt" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/" --config /home/runner/.rclone.conf 2>/dev/null || true

            # æ¸…ç†+æ¢å¤æœåŠ¡
            sudo rm -rf "$BACKUP_TMP_DIR"
            sudo systemctl start docker docker.socket casaos 2>/dev/null || true
            sleep 3
            echo "âœ… å¤‡ä»½ä¸Šä¼ å®Œæˆï¼ŒæœåŠ¡å·²æ¢å¤è¿è¡Œ"
            return 0
          }

          # å¾ªç¯å¤‡ä»½+ç»­è·‘é€»è¾‘
          while true; do
            run_mins=$(( (date +%s - start_time) / 60 ))
            echo "ğŸ“Š æµç¨‹å·²è¿è¡Œ${run_mins}åˆ†é’Ÿï¼ˆä¸Šé™${MAX_RUN_MINUTES}åˆ†é’Ÿï¼‰"

            # è¿è¡Œ2åˆ†é’Ÿåè§¦å‘é¦–æ¬¡å¤‡ä»½
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è¾¾åˆ°å¤‡ä»½è§¦å‘æ¡ä»¶ï¼Œå¼€å§‹æ‰§è¡Œå…¨é‡å¤‡ä»½"
              if full_backup_and_upload; then
                trigger_workflow_renew
              else
                echo "âŒ å¤‡ä»½æ‰§è¡Œå¤±è´¥ï¼Œ30åˆ†é’Ÿåé‡è¯•"
                sleep 1800
              fi
            fi

            # è¾¾åˆ°è¿è¡Œä¸Šé™é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œå¤‡ä»½ç»­è·‘æµç¨‹ç»“æŸ"
              exit 0
            fi
            sleep 60
          done

      - name: 9-æ”¶å°¾æ¸…ç†ï¼ˆå…¨ç¨‹å¿…æ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç†&ç¯å¢ƒä¼˜åŒ– ====="
          # è§£é”æœåŠ¡+æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo systemctl unmask docker.socket casaos 2>/dev/null || true
          sudo rm -rf /home/runner/casaos-backup-tmp /tmp/* /home/runner/.rclone.conf 2>/dev/null || true
          # æ¸…ç†æƒé™é…ç½®+æ— ç”¨ä¾èµ–
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq && sudo apt autoclean -y -qq
          # æœ€ç»ˆçŠ¶æ€ç¡®è®¤
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆï¼Œç³»ç»Ÿæ— æ®‹ç•™ä¾èµ–"
          if sudo systemctl is-active --quiet casaos; then
            echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ŒCasaOSå·²ç¨³å®šè¿è¡Œ"
          else
            echo "âš ï¸ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ŒCasaOSè¿è¡Œå¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ’æŸ¥"
          fi
