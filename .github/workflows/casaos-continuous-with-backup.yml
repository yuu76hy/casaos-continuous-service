name: å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_full_env_snapshot]

jobs:
  full_user_env_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # æ ¸å¿ƒï¼šæ ¹ç›®å½•å…œåº•å…¨é‡å¤‡ä»½ï¼ˆå«æ‰€æœ‰ç”¨æˆ·å˜æ›´ï¼‰ï¼Œä»…æ’é™¤ç³»ç»Ÿä¸´æ—¶ç›®å½•
      BACKUP_ROOT: "/"
      # æ’é™¤ç³»ç»Ÿä¸´æ—¶å’Œè¿è¡Œæ—¶ç›®å½•ï¼Œä¿ç•™æ‰€æœ‰ç”¨æˆ·æ•°æ®å’Œé…ç½®
      EXCLUDE_RULES: "--exclude=/sys --exclude=/proc --exclude=/dev --exclude=/run --exclude=/mnt --exclude=/media --exclude=/tmp --exclude=/var/tmp --exclude=/var/cache/apt/archives --exclude=/boot/efi --exclude=/usr/share/doc --exclude=/usr/share/man --exclude=*.log.tmp --exclude=*.swp"
      # ç”¨æˆ·æ ¸å¿ƒæ•°æ®æ‰“æ ‡ç›®å½•ï¼ˆå¤‡ä»½æ¢å¤å¿…æ ¡éªŒï¼Œä¸¢äº†ç›´æ¥å‘Šè­¦ï¼‰
      CORE_USER_DATA: "/etc /usr /lib /lib64 /home /root /var/lib/docker /etc/docker /usr/local /usr/bin /DATA /var/lib/apt /etc/profile.d /etc/environment /etc/systemd/system /usr/lib/systemd/system"
      WEBDAV_URL:  $ {{ secrets.WEBDAV_URL }}
      WEBDAV_USER:  $ {{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD:  $ {{ secrets.WEBDAV_PASSWORD }}
      USER_PAT:  $ {{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY:  $ {{ secrets.TAILSCALE_AUTH_KEY }}
      REPO:  $ {{ github.repository }}
      ROOTS_PASSWORD:  $ {{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true
      # æ ¸å¿ƒæ ‡è®°ï¼šç”¨æˆ·æ•°æ®å…¨é‡å¤‡ä»½æ ‡è¯†ï¼ˆæ ¡éªŒæ ¸å¿ƒï¼‰
      USER_DATA_MARK: "FULL_USER_ENV_BACKUP_MARK"
      USER_DATA_MARK_FILE: "/root/ $ {USER_DATA_MARK}.flag"
      BACKUP_DELAY_SEC: 300

    steps:
      - name: 1. ç¯å¢ƒåˆå§‹åŒ–ï¼ˆLocaleä¿®å¤+Rclone+ä¾èµ–ï¼‰
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl rsync ca-certificates apt-transport-https
          # Localeç¨³å®šé…ç½®ï¼Œæ— æŠ¥é”™
          sudo locale-gen en_US.UTF-8
          sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          export LC_CTYPE=en_US.UTF-8
          
          # ä¿®å¤Rcloneå®‰è£…å‘½ä»¤ï¼ˆå…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®å‚æ•°æ ¼å¼ï¼‰
          echo "ğŸ”§ æ­£åœ¨å®‰è£…Rclone..."
          if ! command -v rclone &>/dev/null; then
            # æ­£ç¡®çš„å®‰è£…å‘½ä»¤ï¼šä½¿ç”¨ --quiet å‚æ•°
            curl -L https://rclone.org/install.sh | sudo bash -s -- --quiet
            if ! command -v rclone &>/dev/null; then
              echo "âš ï¸ Rcloneå®‰è£…å¤±è´¥ï¼Œå°è¯•å…œåº•æ–¹æ¡ˆ..."
              wget -q https://downloads.rclone.org/rclone-current-linux-amd64.zip -O /tmp/rclone.zip
              unzip -q /tmp/rclone.zip -d /tmp
              sudo cp /tmp/rclone-*/rclone /usr/bin/
              sudo chmod +x /usr/bin/rclone
              rm -rf /tmp/rclone.zip /tmp/rclone-*
            fi
          fi
          echo "âœ… Rcloneå®‰è£…å®Œæˆï¼š $ (rclone --version | head -n1)"
          
          # æƒé™é…ç½®+åˆ›å»ºæ•°æ®ç›®å½•
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner >/dev/null && sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºç®¡ç†å‘˜roots+æ ¸å¿ƒæ ‡è®°æ–‡ä»¶
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          # åˆ›å»ºç”¨æˆ·+æˆæƒ
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            [ -n " $ ROOTS_PASSWORD" ] && echo "roots: $ ROOTS_PASSWORD" | sudo chpasswd || { RANDOM_PASS= $ (openssl rand -base64 12); echo "roots: $ RANDOM_PASS" | sudo chpasswd; echo "âœ… rootséšæœºå¯†ç ï¼š $ RANDOM_PASS"; }
            sudo usermod -aG sudo,docker roots
          fi
          # åˆ›å»ºç”¨æˆ·æ ¸å¿ƒæ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆå¤‡ä»½æ¢å¤å¿…éªŒï¼‰
          sudo touch  $ {USER_DATA_MARK_FILE}
          sudo chmod 600  $ {USER_DATA_MARK_FILE}
          echo "å¤‡ä»½æ—¶é—´: $ (date +%F_%T) | æ ¸å¿ƒæ•°æ®: $ {CORE_USER_DATA}" | sudo tee  $ {USER_DATA_MARK_FILE} >/dev/null
          echo "âœ… ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºå®Œæˆï¼Œæ ¸å¿ƒæ•°æ®æ ‡è®°æ–‡ä»¶å·²ç”Ÿæˆï¼š $ {USER_DATA_MARK_FILE}"

      - name: 3. Rclone WebDAVé…ç½®+è¿é€šæ€§+å¿«ç…§æ£€ç´¢
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          # å‡­è¯æ ¡éªŒ
          [ -z " $ WEBDAV_URL" ] || [ -z " $ WEBDAV_USER" ] || [ -z " $ WEBDAV_PASSWORD" ] && { echo "âŒ WebDAVå‡­è¯ç¼ºå¤±"; echo "WEBDAV_AVAILABLE=false" >> " $ GITHUB_ENV"; exit 0; }
          # é…ç½®WebDAVï¼Œå¯†ç åŠ å¯†
          ENCRYPTED_PASS= $ (rclone obscure " $ WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url=" $ WEBDAV_URL" vendor="other" user=" $ WEBDAV_USER" pass=" $ ENCRYPTED_PASS" --config /home/runner/.rclone.conf --non-interactive
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          # è¿é€šæ€§é‡è¯•æ ¡éªŒ
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then sleep 3; ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1 && { echo "âŒ WebDAVè¿æ¥å¤±è´¥"; echo "WEBDAV_AVAILABLE=false" >> " $ GITHUB_ENV"; exit 0; }; fi
          # ç›®å½•åˆ›å»º+æ£€ç´¢æœ€æ–°å…¨é‡ç”¨æˆ·ç¯å¢ƒå¿«ç…§
          rclone mkdir mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf 2>/dev/null
          REMOTE_SNAPSHOTS= $ (rclone lsf mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR} --mode=time --reverse --config /home/runner/.rclone.conf | grep -E "^full-user-env-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz $ ")
          if [ -n " $ REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME= $ (echo " $ REMOTE_SNAPSHOTS" | head -n1 | xargs)
            LATEST_SNAPSHOT=" $ {WEBDAV_SNAPSHOT_EN_DIR}/ $ {LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½ï¼š $ {LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT= $ {LATEST_SNAPSHOT}" >> " $ GITHUB_ENV"
          else
            echo "âš ï¸ æ— å†å²å¤‡ä»½ï¼Œå°†éƒ¨ç½²çº¯å‡€ç³»ç»Ÿ+åŸºç¡€ä¾èµ–"
          fi
          echo "âœ… WebDAVé…ç½®å®Œæˆ"

      - name: 4. å…¨é‡æ¢å¤ç”¨æˆ·ç¯å¢ƒï¼ˆç³»ç»Ÿ+APP+Docker+æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼‰
        if:  $ {{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== å¼€å§‹å…¨é‡æ¢å¤ç”¨æˆ·ç¯å¢ƒï¼ˆå«ç³»ç»Ÿå˜æ›´+APP+Docker+ç”¨æˆ·æ•°æ®ï¼‰ ====="
          # å¼ºåˆ¶åœæœ+æ•°æ®è½ç›˜ï¼Œé¿å…æ–‡ä»¶å ç”¨
          sudo systemctl stop docker  $ (ls /etc/systemd/system/*.service | awk -F'/' '{print  $ 5}') 2>/dev/null || true
          sudo pkill -9 docker 2>/dev/null || true
          sudo fuser -km  $ CORE_USER_DATA 2>/dev/null || true
          sync && sleep 5
          echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®è½ç›˜å®Œæˆ"
          
          # å¿«ç…§å®Œæ•´æ€§æ ¡éªŒï¼ˆè§£å‹é¢„è§ˆï¼Œç¡®ä¿æ— æŸåï¼‰
          if ! rclone cat mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåï¼Œæ¢å¤ç»ˆæ­¢"
            echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
            exit 1
          fi
          
          # æ ¸å¿ƒæ¢å¤ï¼šæ ¹ç›®å½•å…¨é‡è¦†ç›–ï¼Œä¿ç•™æ‰€æœ‰ç”¨æˆ·å±æ€§
          echo "ğŸ”„ è§£å‹å…¨é‡å¿«ç…§ï¼Œè¿˜åŸæ‰€æœ‰ç”¨æˆ·æ•°æ®"
          rclone cat mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / \
            --overwrite --preserve-permissions --preserve-links --preserve-time --preserve-owner \
            --warning=no-file-changed --no-ignore-failed-read \
             $ EXCLUDE_RULES
          [  $ ? -ne 0 ] && { echo "âŒ å¿«ç…§è§£å‹å¤±è´¥"; echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"; exit 1; }
          
          # æ ¸å¿ƒæ ¡éªŒï¼šæ ‡è®°æ–‡ä»¶+æ ¸å¿ƒç›®å½•åŒé‡éªŒè¯ï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®å…¨æ¢å¤
          if [ ! -f  $ {USER_DATA_MARK_FILE} ]; then
            echo "âŒ æ ¸å¿ƒæ ‡è®°æ–‡ä»¶ç¼ºå¤±ï¼Œç”¨æˆ·æ•°æ®æ¢å¤ä¸å®Œæ•´"
            echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
            exit 1
          fi
          for dir in  $ CORE_USER_DATA; do
            [ ! -d " $ dir" ] && { echo "âŒ æ ¸å¿ƒç”¨æˆ·ç›®å½•ç¼ºå¤±ï¼š $ dir"; echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"; exit 1; }
          done
          echo "âœ… ç”¨æˆ·æ ¸å¿ƒæ•°æ®+æ ‡è®°æ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼Œæ¢å¤å®Œæ•´"
          
          # æƒé™ä¿®å¤+ç³»ç»Ÿé‡è½½
          sudo chown -R root:root /etc /usr /bin /sbin /lib /lib64
          sudo chown -R root:docker /var/lib/docker /etc/docker
          sudo chown -R roots:roots /home/roots /root
          sudo chmod -R 755 /usr/bin /usr/sbin /bin /sbin
          sudo chmod -R 775 /DATA && sudo chown -R root:root /DATA
          sudo systemctl daemon-reload && sync && sleep 3
          
          # åˆ é™¤å·²æ¢å¤æ—§å¿«ç…§ï¼Œé‡Šæ”¾äº‘ç«¯ç©ºé—´
          rclone ls mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf >/dev/null 2>&1 && { rclone delete mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf; rclone delete mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR}/full-user-env-meta.txt --config /home/runner/.rclone.conf; echo "âœ… æ—§å¿«ç…§åŠå…ƒæ•°æ®å·²åˆ é™¤"; }
          
          echo "âœ… å…¨é‡ç”¨æˆ·ç¯å¢ƒæ¢å¤å®Œæˆï¼šç³»ç»Ÿå˜æ›´+æ‰€æœ‰APP+Docker+ç”¨æˆ·æ•°æ®å…¨è¿˜åŸ"
          echo "SNAPSHOT_RESTORED=true" >> " $ GITHUB_ENV"

      - name: 5. çº¯å‡€ç³»ç»Ÿå…œåº•éƒ¨ç½²ï¼ˆæ— å¤‡ä»½æ—¶ï¼Œè£…åŸºç¡€ä¾èµ–ï¼‰
        if:  $ {{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set +e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== çº¯å‡€ç³»ç»Ÿéƒ¨ç½²åŸºç¡€ä¾èµ–ï¼ˆé€‚é…åç»­ç”¨æˆ·ç¯å¢ƒå®‰è£…ï¼‰ ====="
          # æ¸…ç†æ®‹ç•™ï¼Œçº¯å‡€åŸºåº•
          sudo systemctl reset-failed 2>/dev/null || true
          sudo apt autoremove -y 2>/dev/null || true
          # é¢„è£…æ ¸å¿ƒä¾èµ–ï¼ˆæ”¯æŒæ‰€æœ‰APP+Dockerå®‰è£…ï¼‰
          sudo apt install -y fuse3 libssl-dev libcurl4-openssl-dev ca-certificates apt-transport-https rsync git wget curl jq
          # å®‰è£…Dockerï¼ˆåŸºç¡€å¿…å¤‡ï¼‰
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch= $ (dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu  $ (lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          sudo apt update -y && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
          # Dockerå¯åŠ¨æ ¡éªŒ
          INSTALL_SUCCESS=false
          for i in 1 2 3; do
            sudo systemctl enable --now docker && sleep 5
            command -v docker && sudo systemctl is-active --quiet docker && INSTALL_SUCCESS=true && break
            sudo apt reinstall -y docker-ce docker-ce-cli containerd.io -y
          done
          [ " $ INSTALL_SUCCESS" = "false" ] && { echo "âŒ Dockerå®‰è£…å¤±è´¥"; exit 1; }
          # åˆ›å»ºæ ¸å¿ƒæ ‡è®°æ–‡ä»¶ï¼Œè¡”æ¥åç»­å¤‡ä»½
          sudo touch  $ {USER_DATA_MARK_FILE}
          echo "å¤‡ä»½æ—¶é—´: $ (date +%F_%T) | çº¯å‡€ç³»ç»ŸåŸºç¡€ç¯å¢ƒ" | sudo tee  $ {USER_DATA_MARK_FILE} >/dev/null
          sudo systemctl daemon-reload
          echo "âœ… çº¯å‡€ç³»ç»Ÿ+åŸºç¡€ä¾èµ–éƒ¨ç½²å®Œæˆï¼Œæ ‡è®°æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
          exit 0

      - name: 6. å¯åŠ¨å…¨é‡æœåŠ¡+å®Œæ•´æ€§æ ¡éªŒ
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== å¯åŠ¨æ‰€æœ‰æœåŠ¡+å®Œæ•´æ€§æ ¡éªŒ ====="
          # Dockerä¼˜å…ˆå¯åŠ¨+åŠ å›º
          for i in 1 5; do
            sudo systemctl enable --now docker && sleep 8
            sudo systemctl is-active --quiet docker && sudo docker info >/dev/null 2>&1 && { echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"; break; }
            sudo systemctl reset-failed docker && sudo apt reinstall -y docker-ce docker-ce-cli containerd.io -y
          done
          # å¯åŠ¨æ‰€æœ‰ç”¨æˆ·å®‰è£…æœåŠ¡
          sudo systemctl start  $ (ls /etc/systemd/system/*.service /usr/lib/systemd/system/*.service | awk -F'/' '{print  $ NF}' | sed 's/\.service//g') 2>/dev/null || true
          # å®¹å™¨+APPæ ¡éªŒ
          sleep 5
          sudo docker run --rm hello-world >/dev/null 2>&1 && echo "âœ… DockeråŠŸèƒ½æ­£å¸¸" || { echo "âŒ DockeråŠŸèƒ½å¼‚å¸¸"; exit 1; }
          # æ ¸å¿ƒç”¨æˆ·ç›®å½•æ ¡éªŒ
          for dir in  $ CORE_USER_DATA; do [ -d " $ dir" ] && echo "âœ… æ ¸å¿ƒç›®å½•æ­£å¸¸ï¼š $ dir" || { echo "âš ï¸ ç›®å½•ç¼ºå¤±ï¼š $ dir"; }; done
          # æœåŠ¡å™¨IPè¾“å‡º
          SERVER_IP= $ (hostname -I | awk '{print  $ 1}' | head -n1)
          echo "âœ… å…¨é‡æœåŠ¡å¯åŠ¨å®Œæˆï¼ŒæœåŠ¡å™¨IPï¼š $ {SERVER_IP}"
          echo "SERVER_IP= $ {SERVER_IP}" >> " $ GITHUB_ENV"

      - name: 7. éƒ¨ç½²Tailscaleï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          [ -z " $ TAILSCALE_AUTH_KEY" ] && { echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡"; exit 0; }
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          [ -z " $ (which tailscale)" ] && { echo "âŒ Tailscaleå®‰è£…å¤±è´¥"; exit 0; }
          sudo tailscale up --authkey=" $ TAILSCALE_AUTH_KEY" --accept-routes --accept-dns --hostname="full-env-server- $ {{ github.run_id }}" --advertise-exit-node=false
          sleep 3
          TAILSCALE_IP= $ (sudo tailscale ip -4 | head -n1)
          [ -n " $ TAILSCALE_IP" ] && echo "âœ… Tailscaleéƒ¨ç½²å®Œæˆï¼Œå†…ç½‘IPï¼š $ {TAILSCALE_IP}" || echo "âš ï¸ Tailscaleæ— å†…ç½‘IP"

      - name: 8. å»¶æ—¶5åˆ†é’Ÿ+Tarå…¨é‡å¤‡ä»½ï¼ˆç”¨æˆ·ç¯å¢ƒå®Œæ•´é—­ç¯ï¼‰
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          echo "===== å»¶æ—¶ç­‰å¾…æœåŠ¡ç¨³å®šï¼Œå‡†å¤‡å…¨é‡å¤‡ä»½ ====="
          # 5åˆ†é’Ÿå»¶æ—¶å€’è®¡æ—¶ï¼Œç¡®ä¿æœåŠ¡+æ•°æ®å®Œå…¨ç¨³å®š
          countdown= $ BACKUP_DELAY_SEC
          while [  $ countdown -gt 0 ]; do echo "å‰©ä½™ç­‰å¾…ï¼š $ {countdown}ç§’"; sleep 10; countdown= $ ((countdown-10)); done
          start_time= $ (date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘è§¦å‘å‡½æ•°ï¼ˆé˜²æ­¢è¶…æ—¶ï¼‰
          trigger_renew() {
            [ -z " $ USER_PAT" ] || [ -z " $ REPO" ] && return 1
            [ " $ RENEW_TRIGGERED" = "true" ] && return 0
            curl -fsSL --fail --connect-timeout 30 -X POST -H "Authorization: token  $ USER_PAT" -H "Accept: application/vnd.github.v3+json" -H "Content-Type: application/json" "https://api.github.com/repos/ $ REPO/dispatches" -d '{"event_type":"renew_full_env_snapshot"}' && { echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ"; RENEW_TRIGGERED=true; } || echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥"
          }

          # æ ¸å¿ƒï¼šTarå…¨é‡å¤‡ä»½ç”¨æˆ·ç¯å¢ƒï¼ˆæ ¹ç›®å½•å…œåº•ï¼Œä¸ä¸¢ä»»ä½•å˜æ›´ï¼‰
          full_backup_full_user_env() {
            [ " $ {WEBDAV_AVAILABLE}" != "true" ] && { echo "âŒ WebDAVä¸å¯ç”¨"; return 1; }
            # å¤‡ä»½å‰æ ¡éªŒï¼šæ ‡è®°æ–‡ä»¶+æ ¸å¿ƒç›®å½•å®Œæ•´
            [ ! -f  $ {USER_DATA_MARK_FILE} ] && { echo "âŒ æ ¸å¿ƒæ ‡è®°ç¼ºå¤±ï¼Œæ‹’ç»å¤‡ä»½"; exit 1; }
            for dir in  $ CORE_USER_DATA; do [ ! -d " $ dir" ] && { echo "âŒ æ ¸å¿ƒç›®å½•ç¼ºå¤±ï¼š $ dir"; exit 1; }; done
            echo "âœ… å¤‡ä»½å‰æ ¡éªŒé€šè¿‡ï¼Œå¼€å§‹å…¨é‡Taræ‰“åŒ…"

            # å¿«ç…§å‘½å+è·¯å¾„
            SNAPSHOT_NAME="full-user-env-snapshot- $ (date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/ $ {SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR}/ $ {SNAPSHOT_NAME}"

            # åœæœè½ç›˜ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
            echo "ğŸ”§ åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Œæ•°æ®è½ç›˜"
            sudo systemctl stop docker  $ (ls /etc/systemd/system/*.service | awk -F'/' '{print  $ 5}') 2>/dev/null || true
            sudo pkill -9 docker 2>/dev/null || true
            sync && sleep 5

            # Tarå…¨é‡æ‰“åŒ…ï¼šé«˜å‹ç¼©+å®Œæ•´ä¿ç•™æ‰€æœ‰ç”¨æˆ·å±æ€§ï¼Œæ ¹ç›®å½•å…¨é‡ä¸é—æ¼
            echo "ğŸ”„ Tarå…¨é‡æ‰“åŒ…ï¼ˆgzipå‹ç¼©ï¼Œä¿ç•™æƒé™/é“¾æ¥/å±ä¸»ï¼‰"
            sudo tar -c6zf " $ {TMP_SNAPSHOT}" \
              --preserve-permissions --preserve-links --preserve-time --preserve-owner \
              --ignore-failed-read --warning=no-all \
               $ EXCLUDE_RULES \
               $ {BACKUP_ROOT}
            [  $ ? -ne 0 ] && { echo "âŒ Taræ‰“åŒ…å¤±è´¥"; sudo systemctl start docker; return 1; }

            # ç«‹å³é‡å¯æœåŠ¡ï¼Œå‡å°‘ä¸­æ–­
            echo "ğŸ”§ æ‰“åŒ…å®Œæˆï¼Œé‡å¯æ‰€æœ‰æœåŠ¡"
            sudo systemctl start docker && sudo systemctl start  $ (ls /etc/systemd/system/*.service | awk -F'/' '{print  $ 5}') 2>/dev/null || true
            sleep 8
            sudo systemctl is-active --quiet docker && echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ" || echo "âš ï¸ æœåŠ¡é‡å¯å¼‚å¸¸ï¼Œå¤‡ä»½ç»§ç»­"

            # å¿«ç…§ä¸‰é‡å¼ºæ ¡éªŒï¼šå­˜åœ¨æ€§+å¤§å°+æ ¸å¿ƒæ•°æ®
            [ ! -f " $ {TMP_SNAPSHOT}" ] && { echo "âŒ å¿«ç…§æœªç”Ÿæˆ"; return 1; }
            SNAPSHOT_SIZE= $ (stat -c%s " $ {TMP_SNAPSHOT}")
            [  $ SNAPSHOT_SIZE -lt 104857600 ] && { echo "âŒ å¿«ç…§ï¼œ100MBï¼Œåˆ¤å®šæ®‹ç¼º"; return 1; }
            tar -tzf " $ {TMP_SNAPSHOT}" | grep -q " $ {USER_DATA_MARK_FILE}" && echo "âœ… å¿«ç…§å«æ ¸å¿ƒæ ‡è®°æ–‡ä»¶" || { echo "âŒ å¿«ç…§ç¼ºå¤±æ ¸å¿ƒæ ‡è®°"; return 1; }
            echo "âœ… Taræ‰“åŒ…å®Œæˆï¼Œå‹ç¼©åå¤§å°ï¼š $ (du -sh  $ {TMP_SNAPSHOT} | awk '{print  $ 1}')ï¼Œå‹ç¼©ç‡40%-55%"

            # å¤šçº¿ç¨‹ä¸Šä¼ WebDAVï¼Œé‡è¯•åŠ å›º
            echo "ğŸ”„ ä¸Šä¼ å…¨é‡å¿«ç…§åˆ°WebDAV"
            sudo -u runner rclone copy " $ {TMP_SNAPSHOT}" " $ {REMOTE_PATH}" \
              --config /home/runner/.rclone.conf --transfers 8 --checkers 16 --fast-list --retries 5 --low-level-retries 10 --progress
            [  $ ? -ne 0 ] && { echo "âŒ ä¸Šä¼ å¤±è´¥"; return 1; }
            echo "âœ… å¿«ç…§ä¸Šä¼ æˆåŠŸï¼š $ {REMOTE_PATH}"

            # ç”Ÿæˆæ ¸å¿ƒå…ƒæ•°æ®ï¼Œè®°å½•ç”¨æˆ·æ•°æ®ä¿¡æ¯
            META_FILE="/tmp/full-user-env-meta.txt"
            echo "snapshot_name= $ {SNAPSHOT_NAME}" > " $ {META_FILE}"
            echo "create_time= $ (date -u +%F_%T)" >> " $ {META_FILE}"
            echo "file_size_bytes= $ {SNAPSHOT_SIZE}" >> " $ {META_FILE}"
            echo "file_size_human= $ (du -sh  $ {TMP_SNAPSHOT} | awk '{print  $ 1}')" >> " $ {META_FILE}"
            echo "server_ip= $ {SERVER_IP}" >> " $ {META_FILE}"
            echo "core_user_data= $ {CORE_USER_DATA}" >> " $ {META_FILE}"
            echo "backup_mark= $ {USER_DATA_MARK}" >> " $ {META_FILE}"
            sudo -u runner rclone copy " $ {META_FILE}" "mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR}/full-user-env-meta.txt" --config /home/runner/.rclone.conf --overwrite
            echo "âœ… æ ¸å¿ƒå…ƒæ•°æ®ä¸Šä¼ å®Œæˆ"

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œé‡Šæ”¾ç©ºé—´
            sudo rm -rf " $ {TMP_SNAPSHOT}" " $ {META_FILE}"
            echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
            return 0
          }

          # æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼Œå¤±è´¥ç›´æ¥ç»ˆæ­¢
          full_backup_full_user_env || { echo "âŒ å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½å¤±è´¥"; exit 1; }

          # ç»­è·‘åˆ¤æ–­ï¼šå‰©ä½™æ—¶é—´ä¸è¶³30åˆ†é’Ÿè§¦å‘ç»­è·‘
          current_time= $ (date +%s)
          elapsed_minutes= $ (( (current_time-start_time)/60 ))
          remaining_minutes= $ (( MAX_RUN_MINUTES - elapsed_minutes -15 ))
          echo "ğŸ“Š å¤‡ä»½è€—æ—¶ï¼š $ {elapsed_minutes}åˆ†é’Ÿï¼Œå‰©ä½™è¿è¡Œæ—¶é—´ï¼š $ {remaining_minutes}åˆ†é’Ÿ"
          [  $ remaining_minutes -lt 30 ] && [ " $ RENEW_TRIGGERED" = "false" ] && echo "âš ï¸ å‰©ä½™æ—¶é—´ä¸è¶³ï¼Œè§¦å‘ç»­è·‘" && trigger_renew

          echo "===== å…¨é‡ç”¨æˆ·ç¯å¢ƒå¤‡ä»½å®Œæˆï¼ˆç³»ç»Ÿ+APP+Docker+ç”¨æˆ·æ•°æ®å…¨ç•™å­˜ï¼‰ ====="
