name: CasaOS Cloud Instance

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'
  workflow_call:

env:
  SOURCE_DIRS: "/var/lib/casaos /var/lib/docker /DATA"
  BACKUP_BUCKET: "/z/Ubu"
  WEBDAV_MOUNT_POINT: "/home/runner/webdav_mount"
  WEBDAV_REMOTE_NAME: "mywebdav"

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ðŸ“¦ Prepare Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone rsync curl wget fuse
          echo 'user_allow_other' | sudo tee -a /etc/fuse.conf > /dev/null
          mkdir -p "${{ env.WEBDAV_MOUNT_POINT }}"

      - name: ðŸŒ Mount WebDAV
        if: ${{ secrets.WEBDAV_URL != '' }}
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          mkdir -p ï½ž/.config/rclone
          cat > ï½ž/.config/rclone/rclone.conf << EOF
[${{ env.WEBDAV_REMOTE_NAME }}]
type = webdav
url = $WEBDAV_URL
vendor = other
user = $WEBDAV_USER
pass = $WEBDAV_PASSWORD
EOF
          rclone mount "${{ env.WEBDAV_REMOTE_NAME }}:${{ env.BACKUP_BUCKET }}" "${{ env.WEBDAV_MOUNT_POINT }}" --allow-other --vfs-cache-mode writes --daemon --timeout 1m --dir-cache-time 5m --poll-interval 5m
          sleep 8
          mountpoint -q "${{ env.WEBDAV_MOUNT_POINT }}" || { echo "Mount failed"; exit 1; }

      - name: ðŸ“¥ Restore Data
        if: ${{ secrets.WEBDAV_URL != '' }}
        run: |
          # å°†å¤æ‚çš„æŽ’é™¤åˆ—è¡¨å®šä¹‰åœ¨Shellå†…éƒ¨ï¼Œé¿å…YAMLè§£æžæŠ¥é”™
          EXCLUDE_DIRS="/bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media /usr/share/doc /usr/share/man /usr/share/locale /etc/ssl/certs /etc/fstab /etc/mtab /etc/hostname /etc/machine-id /var/lib/docker/tmp /var/lib/docker/overlay2 '/var/lib/docker/containers/*/mounts' /var/lib/docker/network/files /var/lib/docker/buildkit /var/lib/docker/runtimes /var/lib/docker/swarm /var/lib/docker/trust"
          
          echo "Restoring data..."
          IFS=' ' read -r -a dirs <<< "${{ env.SOURCE_DIRS }}"
          for dir in "${dirs[@]}"; do
            webdav_src="${{ env.WEBDAV_MOUNT_POINT }}${{ env.BACKUP_BUCKET }}$dir"
            if [ -d "$webdav_src" ]; then
              sudo mkdir -p "$dir"
              exclude_params=()
              for excl in $EXCLUDE_DIRS; do
                if [[ "$excl" == "$dir"* ]]; then
                  exclude_params+=("--exclude=$excl")
                fi
              done
              sudo rsync -av --delete --copy-links --sparse --numeric-ids "${exclude_params[@]}" "$webdav_src/" "$dir/"
            fi
          done

      - name: ðŸ  Install CasaOS
        if: ${{ secrets.WEBDAV_URL == '' || github.event_name != 'schedule' }}
        run: |
          echo "Installing CasaOS..."
          if ! command -v casaos-service &> /dev/null; then
            curl -fsSL https://get.casaos.io | sudo bash
          fi
          sudo mkdir -p /DATA
          sudo chown -R runner:runner /DATA

      - name: â–¶ï¸ Start Services
        run: |
          sudo systemctl enable docker casaos
          sudo systemctl start docker casaos
          sleep 10

      - name: ðŸ” Connect Tailscale
        if: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="$TS_AUTH_KEY" --hostname=CasaOS-Cloud

      - name: ðŸ”„ Run & Backup Loop
        if: ${{ secrets.WEBDAV_URL != '' }}
        run: |
          # å°†å¤æ‚çš„æŽ’é™¤åˆ—è¡¨å®šä¹‰åœ¨Shellå†…éƒ¨ï¼Œé¿å…YAMLè§£æžæŠ¥é”™
          EXCLUDE_DIRS="/bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media /usr/share/doc /usr/share/man /usr/share/locale /etc/ssl/certs /etc/fstab /etc/mtab /etc/hostname /etc/machine-id /var/lib/docker/tmp /var/lib/docker/overlay2 '/var/lib/docker/containers/*/mounts' /var/lib/docker/network/files /var/lib/docker/buildkit /var/lib/docker/runtimes /var/lib/docker/swarm /var/lib/docker/trust"
          
          echo "Running..."
          # è¿™é‡Œæ”¾ç½®ä½ çš„å¾ªçŽ¯é€»è¾‘
          # æ³¨æ„ï¼šä¸ºäº†é˜²æ­¢YAMLè¿‡é•¿ï¼Œå¤æ‚çš„é€»è¾‘å»ºè®®å†™æˆå•ç‹¬çš„è„šæœ¬æ–‡ä»¶å¼•ç”¨

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          fusermount -u "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null || true
