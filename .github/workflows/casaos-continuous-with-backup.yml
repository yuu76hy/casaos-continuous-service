name: CasaOS-Tailscale-Service-TEST-20MIN
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  run-service:
    runs-on: ubuntu-24.04
    timeout-minutes: 20  # æ€»è¿è¡Œæ—¶é•¿20åˆ†é’Ÿ
    env:
      MAX_RUN_MINUTES: 10  # è¿è¡Œ10åˆ†é’Ÿåï¼Œå‰©ä½™10åˆ†é’Ÿè§¦å‘å¤‡ä»½ç»­è·‘
      RUNNER_PASSWORD: "runner123"
      CASAOS_PORT: 80
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      LOG_DIR: /home/runner/logs
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      CLEAN_INTERVAL: 120  # 2åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡ç©ºé—´
      B2_BACKUP_BUCKET: "casaos-backup"
      BACKUP_MARKER: "latest_backup_TEST.txt"
      LOG_FILE: "casaos_service_TEST_${{ github.run_id }}_$(date +%Y%m%d_%H%M%S).log"
      HEALTH_CHECK_TIMEOUT: 180  # æ–°å®¹å™¨å¥åº·æ£€æŸ¥è¶…æ—¶3åˆ†é’Ÿ
      NEW_RUN_ID_FILE: "/home/runner/new_run_id_TEST.txt"

    steps:
      - name: æ­¥éª¤1 - ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        id: step1
        continue-on-error: false
        run: |
          mkdir -p $LOG_DIR
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "========== æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ– =========="
          echo "====================================="
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿæ›´æ–°å¤±è´¥ï¼"; exit 1; }
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿå‡çº§å¤±è´¥ï¼"; exit 1; }
          pkgs="tar gzip rsync rclone netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release bc jq"
          sudo apt install -y $pkgs || { echo "ä¾èµ–å·¥å…·å®‰è£…å¤±è´¥ï¼"; exit 1; }
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          echo "====================================="
          echo "æ­¥éª¤1ï¼šæµ‹è¯•ç¯å¢ƒåˆå§‹åŒ– æ‰§è¡Œå®Œæˆï¼"
          echo "====================================="

      - name: æ­¥éª¤2 - é…ç½®B2å¯¹è±¡å­˜å‚¨
        id: step2
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "å¼€å§‹æ‰§è¡Œæ­¥éª¤2ï¼šé…ç½®B2å¯¹è±¡å­˜å‚¨"
          echo "====================================="
          B2_KEY_ID=${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY=${{ secrets.B2_APPLICATION_KEY }}
          if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
            echo "é”™è¯¯ï¼šB2å¯†é’¥æœªé…ç½®ï¼è¯·æ£€æŸ¥GitHub Secretsã€‚"; exit 1;
          fi
          mkdir -p ~/.config/rclone
          # ä¿®å¤YAMLè¯­æ³•é”™è¯¯ï¼šæ”¹ç”¨echoé€è¡Œå†™å…¥ï¼Œé¿å…EOFå¤šè¡Œæ ¼å¼é—®é¢˜
          echo "[b2_backend]" > ~/.config/rclone/rclone.conf
          echo "type = b2" >> ~/.config/rclone/rclone.conf
          echo "account = $B2_KEY_ID" >> ~/.config/rclone/rclone.conf
          echo "key = $B2_APPLICATION_KEY" >> ~/.config/rclone/rclone.conf
          echo "hard_delete = true" >> ~/.config/rclone/rclone.conf
          echo "timeout = 20s" >> ~/.config/rclone/rclone.conf
          echo "retries = 2" >> ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          rclone mkdir b2_backend:${B2_BACKUP_BUCKET}/test_backups/ || echo "æµ‹è¯•å¤‡ä»½ç›®å½•å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          if rclone lsd b2_backend:${B2_BACKUP_BUCKET}/test_backups/; then
            echo "B2æµ‹è¯•ç›®å½•è¿æ¥æˆåŠŸï¼"
          else
            echo "é”™è¯¯ï¼šB2æµ‹è¯•ç›®å½•è®¿é—®å¤±è´¥ï¼"; exit 1;
          fi
          echo "====================================="
          echo "æ­¥éª¤2ï¼šé…ç½®B2å¯¹è±¡å­˜å‚¨ æ‰§è¡Œå®Œæˆï¼"
          echo "====================================="

      - name: æ­¥éª¤3 - æ£€æŸ¥æµ‹è¯•å¤‡ä»½å¹¶æ¢å¤ï¼ˆå¸¦æ ¡éªŒï¼‰
        id: step3
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "å¼€å§‹æ‰§è¡Œæ­¥éª¤3ï¼šæ£€æŸ¥æµ‹è¯•å¤‡ä»½å¹¶æ¢å¤"
          echo "====================================="
          BACKUP_MARKER_FILE="$BACKUP_DIR/$BACKUP_MARKER"
          rclone copy b2_backend:${B2_BACKUP_BUCKET}/${BACKUP_MARKER} $BACKUP_DIR/ --timeout 20s || echo "æœªæ‰¾åˆ°æµ‹è¯•å¤‡ä»½æ ‡è®°æ–‡ä»¶ï¼Œè·³è¿‡æ¢å¤"
          
          if [ -f "$BACKUP_MARKER_FILE" ]; then
            LATEST_BACKUP=$(cat "$BACKUP_MARKER_FILE")
            echo "æœ€æ–°æµ‹è¯•å¤‡ä»½æ–‡ä»¶ï¼š$LATEST_BACKUP"
            echo "$BACKUP_EXCLUDE" | tr ' ' '\n' | sed 's/--exclude=//g' > $BACKUP_DIR/exclude-list.txt
            if rclone cat b2_backend:${B2_BACKUP_BUCKET}/test_backups/${LATEST_BACKUP} --timeout 80s | sudo tar -zxf - -C / --exclude-from=$BACKUP_DIR/exclude-list.txt 2>/dev/null; then
              if [ -d "/etc/casaos" ] && [ -d "/var/lib/docker" ]; then
                echo "âœ… æ¢å¤æ ¡éªŒé€šè¿‡ï¼šå…³é”®ç›®å½•å­˜åœ¨"
                echo "HAS_BACKUP=true" >> $GITHUB_ENV
              else
                echo "âŒ æ¢å¤æ ¡éªŒå¤±è´¥ï¼šå…³é”®ç›®å½•ç¼ºå¤±"
                echo "HAS_BACKUP=false" >> $GITHUB_ENV
              fi
            else
              echo "âŒ å¤‡ä»½æ¢å¤å¤±è´¥ï¼Œä½¿ç”¨å…¨æ–°ç¯å¢ƒ"
              echo "HAS_BACKUP=false" >> $GITHUB_ENV
            fi
          else
            echo "â„¹ï¸  æ— æµ‹è¯•å¤‡ä»½æ ‡è®°ï¼Œå…¨æ–°ç¯å¢ƒéƒ¨ç½²"
            echo "HAS_BACKUP=false" >> $GITHUB_ENV
          fi
          echo "====================================="
          echo "æ­¥éª¤3ï¼šæ£€æŸ¥æµ‹è¯•å¤‡ä»½å¹¶æ¢å¤ æ‰§è¡Œå®Œæˆï¼"
          echo "====================================="

      - name: æ­¥éª¤4 - å®‰è£…CasaOS
        id: step4
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "å¼€å§‹æ‰§è¡Œæ­¥éª¤4ï¼šå®‰è£…CasaOS"
          echo "====================================="
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || echo "âš ï¸  CasaOSå®‰è£…è­¦å‘Šï¼Œç»§ç»­æ‰§è¡Œ"
          sudo systemctl start casaos
          sleep 3
          if sudo systemctl is-active --quiet casaos; then
            echo "âœ… CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸï¼"
          else
            echo "âŒ CasaOSæœåŠ¡å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
          fi
          echo "====================================="
          echo "æ­¥éª¤4ï¼šå®‰è£…CasaOS æ‰§è¡Œå®Œæˆï¼"
          echo "====================================="

      - name: æ­¥éª¤5 - éƒ¨ç½²Tailscaleç»„ç½‘
        id: step5
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "å¼€å§‹æ‰§è¡Œæ­¥éª¤5ï¼šéƒ¨ç½²Tailscaleç»„ç½‘"
          echo "====================================="
          if ! curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart"; then
            echo "âš ï¸  Tailscaleè„šæœ¬å®‰è£…å¤±è´¥ï¼Œå°è¯•APTæ–¹å¼"
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
            sudo apt update && sudo apt install -y tailscale || { echo "âŒ Tailscaleå®‰è£…å¤±è´¥ï¼"; exit 1; }
          fi
          sudo systemctl enable --now tailscaled && sleep 4
          MAX_RETRIES=3
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          if [ -z "$TS_AUTH_KEY" ]; then
            echo "âŒ Tailscaleå¯†é’¥æœªé…ç½®ï¼"; exit 1;
          fi
          TAILSCALE_IP=""
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-TEST-${{ github.run_id }} --accept-routes=false --accept-dns=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼å†…ç½‘IPï¼š$TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            echo "âš ï¸  Tailscaleç»„ç½‘é‡è¯•ä¸­ï¼Œå‰©ä½™æ¬¡æ•°ï¼š$MAX_RETRIES"
            sleep 4
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscaleç»„ç½‘å¤±è´¥ï¼"; exit 1;
          fi
          echo "====================================="
          echo "æ­¥éª¤5ï¼šéƒ¨ç½²Tailscaleç»„ç½‘ æ‰§è¡Œå®Œæˆï¼"
          echo "====================================="

      - name: æ­¥éª¤6 - è¾“å‡ºæµ‹è¯•æœåŠ¡è®¿é—®ä¿¡æ¯
        id: step6
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "=========== æµ‹è¯•æœåŠ¡è®¿é—®ä¿¡æ¯ ==========="
          echo "====================================="
          echo "ğŸ“‹ æµ‹è¯•æœåŠ¡æ€»è¿è¡Œæ—¶é•¿ï¼š20åˆ†é’Ÿ"
          echo "â° å¤‡ä»½ç»­è·‘è§¦å‘æ—¶æœºï¼šè¿è¡Œ10åˆ†é’Ÿåï¼ˆå‰©ä½™10åˆ†é’Ÿï¼‰"
          echo "ğŸ’¾ ç³»ç»Ÿå‰©ä½™ç©ºé—´ï¼š$(df -h / | awk 'NR==2{print $4}')"
          echo "ğŸ”‘ Runnerç”¨æˆ·å¯†ç ï¼š$RUNNER_PASSWORD"
          echo "ğŸŒ CasaOSç®¡ç†é¢æ¿ï¼šhttp://$TAILSCALE_IP:$CASAOS_PORT"
          echo "ğŸ“ æ•°æ®æ¥æºï¼š$(if [ $HAS_BACKUP = 'true' ]; then echo "B2æµ‹è¯•å¤‡ä»½æ¢å¤"; else echo "å…¨æ–°æµ‹è¯•ç¯å¢ƒ"; fi)"
          echo "ğŸ“„ æµ‹è¯•æ—¥å¿—è·¯å¾„ï¼š$LOG_DIR/$LOG_FILE"
          echo "====================================="
          echo "âœ… æµ‹è¯•æœåŠ¡å¯åŠ¨å®Œæˆï¼"
          echo "====================================="

      - name: æ­¥éª¤7 - æ ¸å¿ƒä¿æ´»+å¤‡ä»½ç»­è·‘+å¥åº·æ£€æŸ¥ï¼ˆ20åˆ†é’Ÿç‰ˆï¼‰
        id: step7
        continue-on-error: true
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "==== æ ¸å¿ƒä¿æ´»+å¤‡ä»½ç»­è·‘+å¥åº·æ£€æŸ¥ ===="
          echo "====================================="
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}
          CURRENT_RUN_ID=${{ github.run_id }}

          # ç©ºé—´æ¸…ç†å‡½æ•°
          auto_clean() {
            echo "[$(date)] ğŸ§¹ æ‰§è¡Œæµ‹è¯•ç¯å¢ƒç©ºé—´æ¸…ç†..."
            BEFORE=$(df -h / | awk 'NR==2{print $4}')
            sudo apt clean -y && sudo apt autoremove -y --purge
            sudo docker system prune -af --volumes 2>/dev/null
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null
            AFTER=$(df -h / | awk 'NR==2{print $4}')
            echo "[$(date)] ğŸ§¹ ç©ºé—´æ¸…ç†å®Œæˆï¼š$BEFORE â†’ $AFTER"
          }

          # å¤‡ä»½å‡½æ•°ï¼ˆå¢åŠ å¤šé‡æ ¡éªŒï¼‰
          do_backup() {
            echo "[$(date)] â° ã€è§¦å‘æ¡ä»¶æ»¡è¶³ã€‘å‰©ä½™10åˆ†é’Ÿï¼Œå¼€å§‹æ‰§è¡Œå¤‡ä»½ä»»åŠ¡..."
            TS=$(date +%Y%m%d_%H%M%S)
            BK_NAME="casaos_TEST_${CURRENT_RUN_ID}_$TS.tar.gz"
            BK_PATH="test_backups/${BK_NAME}"

            # åœæ­¢æœåŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
            sudo systemctl stop casaos
            sleep 3

            # æµå¼å¤‡ä»½åˆ°B2 + å®æ—¶æ ¡éªŒ
            if sudo tar -zcf - $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat b2_backend:${B2_BACKUP_BUCKET}/${BK_PATH} --timeout 40s --retries 2; then
              # æ ¡éªŒ1ï¼šæ–‡ä»¶å¤§å° > 0
              BK_SIZE=$(rclone size b2_backend:${B2_BACKUP_BUCKET}/${BK_PATH} --json | jq -r '.size')
              if [ "$BK_SIZE" -le 0 ]; then
                echo "[$(date)] âŒ å¤‡ä»½æ ¡éªŒå¤±è´¥ï¼šæ–‡ä»¶å¤§å°ä¸º0å­—èŠ‚"
                sudo systemctl start casaos
                backup_done=true
                return 1
              fi
              # æ ¡éªŒ2ï¼šè¿œç¨‹æ–‡ä»¶å­˜åœ¨
              if ! rclone ls b2_backend:${B2_BACKUP_BUCKET}/${BK_PATH} >/dev/null 2>&1; then
                echo "[$(date)] âŒ å¤‡ä»½æ ¡éªŒå¤±è´¥ï¼šè¿œç¨‹æ–‡ä»¶ä¸å­˜åœ¨"
                sudo systemctl start casaos
                backup_done=true
                return 1
              fi
              # å¤‡ä»½æˆåŠŸï¼šæ›´æ–°æ ‡è®°+ä¸Šä¼ æ—¥å¿—
              echo "$BK_NAME" > $BACKUP_DIR/$BACKUP_MARKER
              rclone copy $BACKUP_DIR/$BACKUP_MARKER b2_backend:${B2_BACKUP_BUCKET}/ --timeout 20s
              rclone copy $LOG_DIR/$LOG_FILE b2_backend:${B2_BACKUP_BUCKET}/test_logs/ --timeout 20s
              echo "[$(date)] âœ… å¤‡ä»½å…¨æµç¨‹é€šè¿‡ï¼šæ–‡ä»¶å¤§å° $BK_SIZE å­—èŠ‚"
            else
              echo "[$(date)] âŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥ï¼"
              sudo systemctl start casaos
              backup_done=true
              return 1
            fi

            # é‡å¯æœåŠ¡
            sudo systemctl start casaos
            backup_done=true
            return 0
          }

          # è§¦å‘ç»­è·‘å‡½æ•°
          trigger_renew() {
            echo "[$(date)] ğŸš€ å¼€å§‹è§¦å‘æ–°å®¹å™¨ç»­è·‘..."
            if [ -z "$GITHUB_PAT" ] || [ -z "$REPO" ]; then
              echo "[$(date)] âŒ ç»­è·‘å¤±è´¥ï¼šPATæˆ–ä»“åº“ä¿¡æ¯æœªé…ç½®"
              return 1
            fi
            RESPONSE=$(curl -s -X POST https://api.github.com/repos/$REPO/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_PAT" \
              -d '{"event_type":"renew_vnc"}' \
              -w "%{http_code}" -o /dev/null --connect-timeout 20s)
            if [ "$RESPONSE" -eq 204 ]; then
              echo "[$(date)] âœ… ç»­è·‘è§¦å‘è¯·æ±‚æˆåŠŸï¼ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨..."
              return 0
            else
              echo "[$(date)] âŒ ç»­è·‘è§¦å‘å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç ï¼š$RESPONSE"
              return 1
            fi
          }

          # æ–°å®¹å™¨å¥åº·æ£€æŸ¥å‡½æ•°ï¼ˆåŒé‡éªŒè¯ï¼‰
          check_new_container() {
            echo "[$(date)] ğŸ” å¼€å§‹æ£€æŸ¥æ–°å®¹å™¨å¥åº·çŠ¶æ€ï¼Œè¶…æ—¶${HEALTH_CHECK_TIMEOUT}ç§’..."
            start_check=$(date +%s)
            while [ $(( $(date +%s) - start_check )) -lt $HEALTH_CHECK_TIMEOUT ]; do
              # è·å–åŒä»“åº“ä¸‹è¿è¡Œä¸­çš„æµ‹è¯•å·¥ä½œæµ
              RUNS=$(curl -s -H "Authorization: Bearer $GITHUB_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&event=repository_dispatch" \
                | jq -r '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID' and .name | contains("TEST-20MIN")) | .id')
              if [ -n "$RUNS" ]; then
                NEW_RUN_ID=$(echo "$RUNS" | head -n 1)
                echo "[$(date)] âœ… å‘ç°æ–°å®¹å™¨Run IDï¼š$NEW_RUN_ID"
                echo $NEW_RUN_ID > $NEW_RUN_ID_FILE
                # ç­‰å¾…æ–°å®¹å™¨å®Œæˆéƒ¨ç½²+æœåŠ¡å¯åŠ¨
                sleep 40
                echo "[$(date)] âœ… æ–°å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡ï¼šå·²å®Œæˆåˆå§‹åŒ–å¹¶è¿è¡Œ"
                return 0
              fi
              echo "[$(date)] â³ æ–°å®¹å™¨å°šæœªå¯åŠ¨ï¼Œç­‰å¾…8ç§’..."
              sleep 8
            done
            echo "[$(date)] âŒ å¥åº·æ£€æŸ¥è¶…æ—¶ï¼šæœªæ£€æµ‹åˆ°æ­£å¸¸æ–°å®¹å™¨"
            return 1
          }

          # ä¸»å¾ªç¯
          echo "[$(date)] ğŸ¯ æ ¸å¿ƒä¿æ´»é€»è¾‘å¯åŠ¨ï¼ˆ20åˆ†é’Ÿæµ‹è¯•æ¨¡å¼ï¼‰..."
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')

            # å®šæ—¶ç©ºé—´æ¸…ç†
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi

            # ç©ºé—´ä¸è¶³ç´§æ€¥æ¸…ç†
            if (( $(echo "$free_space < 1" | bc -l) )); then
              echo "[$(date)] âš ï¸  å‰©ä½™ç©ºé—´ä¸è¶³1Gï¼Œç´§æ€¥æ¸…ç†..."
              auto_clean
              last_clean=$now
            fi

            # æ ¸å¿ƒè§¦å‘é€»è¾‘ï¼šå‰©ä½™10åˆ†é’Ÿæ—¶æ‰§è¡Œå¤‡ä»½+ç»­è·‘
            if [ $((MAX_RUN_MINUTES - run_mins)) -eq 0 ] && [ "$backup_done" = false ]; then
              # æ­¥éª¤1ï¼šæ‰§è¡Œå¤‡ä»½ï¼Œå¤‡ä»½å¤±è´¥åˆ™è·³è¿‡åç»­æµç¨‹
              if do_backup; then
                echo "[$(date)] ğŸ“¦ å¤‡ä»½ä»»åŠ¡å®Œæˆï¼Œå¼€å§‹è§¦å‘ç»­è·‘..."
                # æ­¥éª¤2ï¼šè§¦å‘æ–°å®¹å™¨ç»­è·‘
                if trigger_renew; then
                  # æ­¥éª¤3ï¼šæ£€æŸ¥æ–°å®¹å™¨å¥åº·çŠ¶æ€
                  if check_new_container; then
                    echo "[$(date)] ğŸ‰ æ–°å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œæ—§å®¹å™¨å¼€å§‹å®‰å…¨é€€å‡º..."
                    # åœæ­¢æ—§å®¹å™¨æœåŠ¡å¹¶é€€å‡º
                    sudo systemctl stop casaos tailscaled
                    sudo tailscale down
                    echo "[$(date)] âœ… æ—§å®¹å™¨å·²å®‰å…¨é€€å‡ºï¼"
                    exit 0
                  else
                    echo "[$(date)] âš ï¸  æ–°å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ—§å®¹å™¨ç»§ç»­è¿è¡Œ..."
                  fi
                else
                  echo "[$(date)] âš ï¸  ç»­è·‘è§¦å‘å¤±è´¥ï¼Œæ—§å®¹å™¨ç»§ç»­è¿è¡Œ..."
                fi
              else
                echo "[$(date)] âš ï¸  å¤‡ä»½ä»»åŠ¡å¤±è´¥ï¼Œè·³è¿‡ç»­è·‘æµç¨‹..."
              fi
            fi

            # æœåŠ¡ä¿æ´»ç›‘æ§
            if ! sudo systemctl is-active --quiet casaos; then
              echo "[$(date)] âš ï¸  CasaOSæœåŠ¡æœªè¿è¡Œï¼Œé‡å¯ä¸­..."
              sudo systemctl restart casaos
            fi
            if ! sudo systemctl is-active --quiet tailscaled; then
              echo "[$(date)] âš ï¸  TailscaleæœåŠ¡æœªè¿è¡Œï¼Œé‡å¯ä¸­..."
              sudo systemctl restart tailscaled
            fi

            # è¾“å‡ºè¿è¡ŒçŠ¶æ€
            echo "[$(date)] ğŸ“Š å·²è¿è¡Œ $run_mins åˆ†é’Ÿ | å‰©ä½™æ—¶é—´: $((MAX_RUN_MINUTES - run_mins)) åˆ†é’Ÿ | å‰©ä½™ç©ºé—´: $(df -h / | awk 'NR==2{print $4}')"
            sleep 8
          done

      - name: æ­¥éª¤8 - æµ‹è¯•ç¯å¢ƒæ¸…ç†
        id: step8
        if: always()
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "å¼€å§‹æ‰§è¡Œæ­¥éª¤8ï¼šæµ‹è¯•ç¯å¢ƒæ¸…ç†"
          echo "====================================="
          sudo systemctl stop casaos tailscaled || true
          sudo tailscale down || true
          rm -rf $BACKUP_DIR $NETDISK_ROOT || true
          rclone copy $LOG_DIR/$LOG_FILE b2_backend:${B2_BACKUP_BUCKET}/test_logs/ --timeout 20s || echo "âš ï¸  æµ‹è¯•æ—¥å¿—ä¸Šä¼ å¤±è´¥"
          echo "====================================="
          echo "âœ… æ­¥éª¤8ï¼šæµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆï¼"
          echo "====================================="
