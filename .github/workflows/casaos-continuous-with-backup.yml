name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆæ— ä¼˜åŒ–+éƒ¨ç½²æ¢å¤åˆ†ç¦»+10åˆ†é’Ÿå¤‡ä»½ç»­è·‘å…³æµï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360  # å†—ä½™è¶…æ—¶ï¼Œè¦†ç›–10åˆ†é’Ÿå€’è®¡æ—¶+å…¨é‡å¤‡ä»½ä¸Šä¼ 
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      DELAY_TOTAL_MIN: 10  # 10åˆ†é’Ÿå€’è®¡æ—¶
      CORE_SERVICES: "docker containerd casaos" # æ ¸å¿ƒæœåŠ¡é›†åˆ
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ç»Ÿä¸€æå–ï¼Œé¿å…é‡å¤å®šä¹‰

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæç®€ç‰ˆï¼‰
        run: |
          set -e
          echo "===== ç³»ç»Ÿå¿«é€Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # æå‰åˆ›å»ºDATAç›®å½•ï¼Œè§„é¿åç»­æƒé™é—®é¢˜
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: 2-å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆå«composeï¼Œå…¼å®¹æ–°ç‰ˆï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          # å¸è½½æ—§ç‰ˆæ›´å½»åº•ï¼Œè¦†ç›–æ›´å¤šæ®‹ç•™åŒ…
          sudo apt remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 3
          # å…¼å®¹æ€§æ ¡éªŒï¼Œé¿å…composeå‘½ä»¤æŠ¥é”™
          if ! command -v docker compose &>/dev/null; then
            sudo ln -s /usr/libexec/docker/cli-plugins/docker-compose /usr/bin/docker-compose
          fi
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      - name: 3-åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆæƒé™åŠ å›ºï¼‰
        run: |
          set -e
          echo "===== åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          # å…ˆåˆ æ®‹ç•™ç”¨æˆ·ï¼Œé¿å…åˆ›å»ºå†²çª
          id -u "$USER_NAME" &>/dev/null && sudo userdel -r "$USER_NAME" 2>/dev/null || true
          sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ];then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ rootséšæœºå¯†ç ï¼š$RANDOM_PASS"
          fi
          # å…å¯†é…ç½®åŠ å›ºï¼Œé¿å…è¯­æ³•é”™è¯¯
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 4-WebDAVé…ç½®+å¿«ç…§æ£€æµ‹+ç›®å½•é¢„åˆ›å»º+å˜é‡èµ‹å€¼ï¼ˆæ ¸å¿ƒå…¼å®¹ï¼‰
        run: |
          set -e
          echo "===== WebDAVé…ç½®&å¿«ç…§æ£€æµ‹&ç›®å½•é¢„åˆ›å»º ====="
          # å‡­è¯å®Œæ•´æ€§å¼ºæ ¡éªŒ
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # WebDAVé…ç½®åŠ å¯†å­˜å‚¨ï¼Œæƒé™åŠ å›º
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          # é¢„åˆ›å»ºç›®å½•+æƒé™ç»Ÿä¸€ï¼Œè§„é¿æ¢å¤æŠ¥é”™
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" && sudo chown root:root "$dir" && sudo chmod 755 "$dir"
          done
          # å¿«ç…§æ£€æµ‹+å˜é‡èµ‹å€¼ï¼Œè§„é¿ç©ºå€¼æŠ¥é”™
          BACKUP_CHECK=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep -c ".tar.gz")
          if [ "$BACKUP_CHECK" -ge 1 ]; then
            echo "âœ… æ£€æµ‹åˆ°WebDAVå¤‡ä»½å¿«ç…§ï¼Œå…±${BACKUP_CHECK}ä»½"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
            LATEST_SNAPSHOT=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep .tar.gz | sort -r | head -n1 | awk '{print $2}')
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
            echo "ğŸ“Œ æœ€æ–°å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
          else
            echo "â„¹ï¸ æ— å¤‡ä»½å¿«ç…§ï¼Œå…¨æ–°éƒ¨ç½²"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "âœ… WebDAVé…ç½®å®Œæˆ"

      - name: 5-Tailscaleç»„ç½‘é…ç½®ï¼ˆå¥å£®æ€§ä¼˜åŒ–ï¼‰
        run: |
          set -e
          echo "===== Tailscaleç»„ç½‘é…ç½® ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          # å®‰è£…é‡è¯•æœºåˆ¶ï¼Œè§„é¿ç½‘ç»œæ³¢åŠ¨
          for i in {1..3}; do
            if curl -fsSL https://tailscale.com/install.sh | sudo bash; then
              break
            elif [ "$i" -eq 3 ]; then
              echo "âŒ Tailscaleå®‰è£…å¤±è´¥ï¼Œè·³è¿‡ç»„ç½‘"
              exit 0
            fi
            sleep 2
          done
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-dns=false --accept-routes=false --no-single-routing-table
          sleep 3
          # IPè¾“å‡ºå®¹é”™ï¼Œé¿å…ç»„ç½‘æˆåŠŸæ— IPæŠ¥é”™
          TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "æœªè·å–åˆ°IPv4")
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼ŒIPï¼š${TAILSCALE_IP}"

      - name: 6-CasaOSåŸºç¡€éƒ¨ç½²ï¼ˆä»…ç³»ç»Ÿï¼Œä¸æ¢å¤æ•°æ®ï¼Œå¯åœä¼˜åŒ–ï¼‰
        run: |
          set -e
          echo "===== CasaOSåŸºç¡€éƒ¨ç½²ï¼ˆä»…ç³»ç»Ÿï¼Œä¸æ¢å¤æ•°æ®ï¼‰ ====="
          # å®‰è£…å‰ç½®æ¸…ç†ï¼Œè§„é¿ç«¯å£å ç”¨
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          curl -fsSL https://get.casaos.io | sudo bash
          # åˆ†åœºæ™¯å¯åœï¼Œé€»è¾‘æ›´ä¸¥è°¨
          if [ "$HAS_SNAPSHOT" = "false" ]; then
            sudo systemctl enable --now casaos && sleep 5
            # æœåŠ¡çŠ¶æ€æ ¡éªŒ
            sudo systemctl is-active --quiet casaos && echo "âœ… CasaOSå…¨æ–°éƒ¨ç½²å®Œæˆï¼ˆæ— æ•°æ®æ¢å¤ï¼‰" || echo "âš ï¸ CasaOSå¯åŠ¨å¼‚å¸¸ï¼Œç»§ç»­æµç¨‹"
          else
            sudo systemctl stop $CORE_SERVICES 2>/dev/null || true
            sudo pkill -f casaos 2>/dev/null || true
            echo "âœ… CasaOSåŸºç¡€éƒ¨ç½²å®Œæˆï¼Œç­‰å¾…æ•°æ®æ¢å¤"
          fi

      - name: 7-æ¢å¤ä¸ªäººæ•°æ®ï¼ˆæ— å¿«ç…§è‡ªåŠ¨è·³è¿‡ï¼Œæ¢å¤ä¸åˆ å¿«ç…§ï¼Œæµå¼æ¢å¤ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== ç²¾å‡†æ¢å¤ä¸ªäººæ•°æ® ====="
          # å½»åº•å…³åœè¿›ç¨‹ï¼Œä¿éšœæ¢å¤çº¯å‡€
          sudo systemctl stop $CORE_SERVICES 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          # ç›®å½•å…œåº•åˆ›å»º
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          echo "ğŸ“Œ æ¢å¤ç›®å½•æ¸…å•ï¼š$PERSONAL_DATA_DIRS"
          echo "ğŸ“Œ æ¢å¤å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
          # æµå¼æ¢å¤å®¹é”™ï¼Œé¿å…ä¸‹è½½è§£å‹æŠ¥é”™ä¸­æ–­
          if ! rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS; then
            echo "âš ï¸ å¿«ç…§æ¢å¤å¼‚å¸¸ï¼Œå°è¯•è·³è¿‡éƒ¨åˆ†æ–‡ä»¶ç»§ç»­"
            rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions --skip-old-files $PERSONAL_DATA_DIRS
          fi
          # ç²¾å‡†æƒé™é…ç½®ï¼Œå…¼é¡¾å®‰å…¨ä¸å¯ç”¨æ€§
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          # Docker socketæƒé™ä¸“é¡¹é…ç½®
          sudo chmod 660 /var/run/docker.sock 2>/dev/null || true
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼Œæƒé™æ ¡æ­£å®Œæ¯•ã€æ¢å¤ä¸åˆ å¿«ç…§ã€‘"

      - name: 8-æƒé™æ ¡æ­£+æé€Ÿå¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåˆ†åœºæ™¯åŠ å›ºï¼Œç«¯å£æ¸…ç†ï¼‰
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£+å¯åŠ¨æœåŠ¡ ====="
          # ç«¯å£å ç”¨äºŒæ¬¡æ¸…ç†
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          # åˆ†åœºæ™¯æƒé™åŠ å›ºï¼Œé€»è¾‘æ— é—æ¼
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          else
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          fi
          # æœåŠ¡å¯åŠ¨åŠ å›ºï¼Œå…ˆé‡è½½å†å¯åŠ¨
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 4
          sudo systemctl enable --now casaos && sleep 5
          # æœåŠ¡çŠ¶æ€ç»Ÿä¸€æ ¡éªŒ
          echo "ğŸ“Œ æ ¸å¿ƒæœåŠ¡çŠ¶æ€æ ¡éªŒ"
          for svc in $CORE_SERVICES; do
            if sudo systemctl is-active --quiet $svc; then
              echo "âœ… ${svc} æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âš ï¸ ${svc} æœåŠ¡æœªå¯åŠ¨ï¼Œå°è¯•é‡å¯"
              sudo systemctl restart $svc 2>/dev/null || true
            fi
          done
          echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨/æ ¡æ­£å®Œæˆ"
          echo "ğŸ“Œ è®¿é—®åœ°å€ï¼šæœåŠ¡å™¨IPï¼ˆ80ç«¯å£ï¼‰"

      - name: 9-10åˆ†é’Ÿå€’è®¡æ—¶+åœè¿›ç¨‹å¤‡ä»½+ä¿ç•™2ä»½åˆ æ—§+å…ˆç»­è·‘å†å…³æµï¼ˆæ— æŠ¥é”™æ ¸å¿ƒï¼‰
        run: |
          set -e
          echo "â³ å¼€å§‹${DELAY_TOTAL_MIN}åˆ†é’Ÿå€’è®¡æ—¶ï¼Œæ¯åˆ†é’Ÿæ›´æ–°å‰©ä½™æ—¶é—´"
          # å€’è®¡æ—¶å®¹é”™ï¼Œé¿å…å˜é‡è§£æå¤±è´¥
          COUNT_DOWN=${DELAY_TOTAL_MIN:-10}
          for ((i=${COUNT_DOWN};i>0;i--)); do
            echo "âŒ› å‰©ä½™å»¶æ—¶ï¼š${i}åˆ†é’Ÿï¼ˆæ€»è®¡${COUNT_DOWN}åˆ†é’Ÿï¼‰"
            sleep 60
          done
          echo "ğŸ‰ å€’è®¡æ—¶ç»“æŸï¼Œåœè¿›ç¨‹å¼€å§‹å¤‡ä»½"
          
          # å…³åœè¿›ç¨‹å¥å£®æ€§æ‹‰æ»¡ï¼Œå¿½ç•¥æ‰€æœ‰å¤±è´¥ï¼Œç¡®ä¿è¿›ç¨‹å…³åœ
          echo "ğŸ›‘ å…³åœæ ¸å¿ƒè¿›ç¨‹ï¼ˆä¿éšœå¤‡ä»½çº¯å‡€ï¼‰"
          sudo systemctl stop $CORE_SERVICES 2>/dev/null || true
          sudo pkill -f docker 2>/dev/null || true
          sudo pkill -f containerd 2>/dev/null || true
          sudo pkill -f casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          echo "âœ… è¿›ç¨‹å·²å…³åœï¼ˆæœªå¯åŠ¨æœåŠ¡ç›´æ¥å¿½ç•¥ï¼‰ï¼Œå¼€å§‹å¤‡ä»½"
          
          # å¤‡ä»½å‘½åè§„èŒƒï¼Œé¿å…é‡å¤
          SNAPSHOT_NAME="casaos-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "ğŸ“¥ ã€å¤‡ä»½1/4ã€‘åˆ›å»ºæœ¬åœ°å¤‡ä»½åŒ…ï¼š${SNAPSHOT_NAME}"
          # æ‰“åŒ…å®¹é”™ï¼Œå¿½ç•¥æ‰“åŒ…è­¦å‘Šï¼Œä¿ç•™æ ¸å¿ƒæ•°æ®
          sudo tar -zcvf /tmp/"$SNAPSHOT_NAME" $EXCLUDE_RULES $PERSONAL_DATA_DIRS --preserve-permissions 2>/dev/null || true
          # æ ¡éªŒå¤‡ä»½åŒ…æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f /tmp/"$SNAPSHOT_NAME" ]; then
            echo "âš ï¸ æœ¬åœ°å¤‡ä»½åŒ…åˆ›å»ºå¤±è´¥ï¼Œå°è¯•é‡æ–°æ‰“åŒ…"
            sudo tar -zcf /tmp/"$SNAPSHOT_NAME" $PERSONAL_DATA_DIRS --preserve-permissions 2>/dev/null || true
          fi
          echo "âœ… ã€å¤‡ä»½2/4ã€‘æœ¬åœ°å¤‡ä»½å®Œæˆ"
          
          echo "ğŸ“¤ ã€å¤‡ä»½3/4ã€‘ä¸Šä¼ WebDAVï¼ˆå®æ—¶è¿›åº¦ï¼‰"
          # ä¸Šä¼ é‡è¯•æœºåˆ¶ï¼Œè§„é¿ç½‘ç»œæ³¢åŠ¨å¤±è´¥
          for i in {1..2}; do
            if rclone copy -P /tmp/"$SNAPSHOT_NAME" mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf; then
              break
            elif [ "$i" -eq 2 ]; then
              echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œè·³è¿‡ä¸Šä¼ "
              sudo rm -f /tmp/"$SNAPSHOT_NAME"
              exit 1
            fi
            sleep 3
          done
          echo "âœ… ã€å¤‡ä»½4/4ã€‘ä¸Šä¼ å®Œæˆ"
          
          # å¤‡ä»½æ¸…ç†æ ¸å¿ƒé€»è¾‘ï¼Œç²¾å‡†ä¿ç•™æœ€æ–°2ä»½ï¼Œæ— é”™æ¼
          echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼Œä»…ä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
          BACKUPS_LIST=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep .tar.gz | sort -r | awk '{print $2}' | uniq)
          BACKUPS_COUNT=$(echo "$BACKUPS_LIST" | wc -l)
          if [ "$BACKUPS_COUNT" -gt "$KEEP_BACKUPS" ]; then
            DELETE_LIST=$(echo "$BACKUPS_LIST" | tail -n $((BACKUPS_COUNT - KEEP_BACKUPS)))
            for backup in $DELETE_LIST; do
              if rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$backup" --config /home/runner/.rclone.conf; then
                echo "ğŸ—‘ï¸ æˆåŠŸåˆ é™¤æ—§å¤‡ä»½ï¼š$backup"
              else
                echo "âš ï¸ æ—§å¤‡ä»½åˆ é™¤å¤±è´¥ï¼š$backup"
              fi
            done
            echo "âœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
          else
            echo "â„¹ï¸ å½“å‰å¤‡ä»½${BACKUPS_COUNT}ä»½â‰¤${KEEP_BACKUPS}ä»½ï¼Œæ— éœ€æ¸…ç†"
          fi
          sudo rm -f /tmp/"$SNAPSHOT_NAME"
          
          # é‡å¯è¿›ç¨‹æ¢å¤æœåŠ¡ï¼Œå®¹é”™åŠ å›º
          echo "ğŸ”„ é‡å¯æ ¸å¿ƒè¿›ç¨‹æ¢å¤æœåŠ¡"
          sudo systemctl daemon-reload
          sudo systemctl restart $CORE_SERVICES 2>/dev/null || true
          sleep 8
          sudo systemctl is-active --quiet $CORE_SERVICES && echo "âœ… æœåŠ¡æ¢å¤æ­£å¸¸" || echo "âš ï¸ éƒ¨åˆ†æœåŠ¡é‡å¯å¼‚å¸¸ï¼Œä¸å½±å“ç»­è·‘"
          
          # ç»­è·‘+å…³æµæ ¸å¿ƒé€»è¾‘ï¼Œè§„é¿APIè°ƒç”¨å¤±è´¥
          echo "====================================="
          echo "ğŸ“Œ å¤‡ä»½å®Œæˆï¼Œæ‰§è¡Œç»­è·‘+å…³æµ"
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            echo "ğŸ”„ ç¬¬ä¸€æ­¥ï¼šè§¦å‘ç»­è·‘å·¥ä½œæµ"
            # ç»­è·‘APIå®¹é”™ï¼Œé‡è¯•1æ¬¡
            if ! curl -sSL -X POST https://api.github.com/repos/${REPO}/dispatches \
            -H "Authorization: token ${USER_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"event_type\":\"renew_casaos_snapshot\"}"; then
              sleep 2
              curl -sSL -X POST https://api.github.com/repos/${REPO}/dispatches \
              -H "Authorization: token ${USER_PAT}" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"event_type\":\"renew_casaos_snapshot\"}"
            fi
            echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ"
          else
            echo "âš ï¸ USER_PAT/REPOç¼ºå¤±ï¼Œæ— æ³•è§¦å‘ç»­è·‘"
          fi
          
          echo "ğŸ”š ç¬¬äºŒæ­¥ï¼šå…³é—­å½“å‰å·¥ä½œæµ"
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            gh auth login --with-token <<< "${USER_PAT}"
            RUN_ID=$(jq -r ".run_id" "$GITHUB_EVENT_PATH" 2>/dev/null || echo "")
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              gh api -X POST repos/${REPO}/actions/runs/${RUN_ID}/cancel 2>/dev/null || true
              echo "âœ… å½“å‰å·¥ä½œæµï¼ˆID:${RUN_ID}ï¼‰å·²å…³é—­"
            else
              echo "âš ï¸ æœªè·å–åˆ°å·¥ä½œæµIDï¼Œè·³è¿‡å…³é—­"
            fi
          else
            echo "âš ï¸ USER_PAT/REPOç¼ºå¤±ï¼Œæ— æ³•å…³é—­å·¥ä½œæµ"
          fi
          echo "ğŸ“Œ å…¨æµç¨‹ç»“æŸ"
          echo "====================================="