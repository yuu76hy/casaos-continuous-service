name: CasaOS-Tailscale-Full-Deploy

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 330
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu /a/Ubu"
      CASAOS_DATA: /var/lib/casaos
      DOCKER_DATA: /var/lib/docker
      EXCLUDE_DIRS: "/bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp"
      MAX_MOUNT_RETRIES: 2
      RETRY_DELAY: 10
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}

    steps:
      # ========== Ê≠•È™§1ÔºöÁ≥ªÁªüÁéØÂ¢ÉÂàùÂßãÂåñ ==========
      - name: Ê≠•È™§1 - Á≥ªÁªüÁéØÂ¢ÉÂàùÂßãÂåñ
        id: step1
        run: |
          echo "===== Ê≠•È™§1ÔºöÁ≥ªÁªüÁéØÂ¢ÉÂàùÂßãÂåñ ====="
          mkdir -p /home/runner/logs "$WEBDAV_MOUNT_POINT"
          LOG_FILE="/home/runner/logs/casaos-tailscale-${{ github.run_id }}.log"
          exec > >(tee -a "$LOG_FILE") 2>&1

          # ÂÆâË£Ö‰æùËµñ
          sudo apt update -y && sudo apt upgrade -y -q
          sudo apt install -y rsync davfs2 curl wget jq iptables || { echo "‰æùËµñÂÆâË£ÖÂ§±Ë¥•"; exit 1; }

          # ÈÖçÁΩÆsudoÂÖçÂØÜ
          echo "runner ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          echo "‚úÖ Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê (Êó•Âøó: $LOG_FILE)"

      # ========== Ê≠•È™§2ÔºöÊåÇËΩΩWebDAVÔºàÂ§±Ë¥•Ë∑≥ËøáÂ§á‰ªΩÊÅ¢Â§çÔºâ ==========
      - name: Ê≠•È™§2 - ÊåÇËΩΩWebDAVÂπ∂È™åËØÅ
        id: step2
        run: |
          echo "===== Ê≠•È™§2ÔºöÊåÇËΩΩWebDAVÂπ∂È™åËØÅ ====="
          # ÈÖçÁΩÆÂÖçÂØÜÊåÇËΩΩ
          echo "$WEBDAV_URL $WEBDAV_USER $WEBDAV_PASSWORD" | sudo tee -a /etc/davfs2/secrets
          sudo chmod 600 /etc/davfs2/secrets

          # ÊåÇËΩΩÈáçËØïÈÄªËæë
          mount_success=false
          for retry in $(seq 1 $MAX_MOUNT_RETRIES); do
            sudo umount "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
            echo "üîÑ Â∞ùËØïÊåÇËΩΩ WebDAV (Á¨¨ $retry/$MAX_MOUNT_RETRIES Ê¨°)"
            if sudo mount -t davfs -o uid=runner,gid=runner "$WEBDAV_URL" "$WEBDAV_MOUNT_POINT"; then
              mount_success=true
              break
            fi
            sleep $RETRY_DELAY
          done

          # È™åËØÅÊåÇËΩΩÁÇπ
          if [ "$mount_success" = "true" ]; then
            echo "‚úÖ WebDAVÊåÇËΩΩÊàêÂäü (Ë∑ØÂæÑ: $WEBDAV_MOUNT_POINT)"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

            for dir in $BACKUP_DIRS; do
              target_path="$WEBDAV_MOUNT_POINT$dir"
              if [ -d "$target_path" ] && [ -n "$(ls -A "$target_path")" ]; then
                echo "‚úÖ Ê£ÄÊµãÂà∞ $dir ÊúâÊïàÂ§á‰ªΩÊï∞ÊçÆ"
                key="HAS_${dir//\//_}"
                echo "${key}=true" >> "$GITHUB_ENV"
              else
                echo "‚ö†Ô∏è $dir Êó†Â§á‰ªΩÊï∞ÊçÆÔºåÂàõÂª∫Á©∫ÁõÆÂΩï"
                sudo mkdir -p "$target_path"
                key="HAS_${dir//\//_}"
                echo "${key}=false" >> "$GITHUB_ENV"
              fi
            done
          else
            echo "‚ùå WebDAVÊåÇËΩΩÂ§±Ë¥•ÔºåË∑≥ËøáÂ§á‰ªΩÊÅ¢Â§çÊµÅÁ®ã"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          fi
          echo "‚úÖ Ê≠•È™§2ÂÆåÊàê"

      # ========== Ê≠•È™§3ÔºöÊï∞ÊçÆÊÅ¢Â§çÔºà‰ªÖWebDAVÂèØÁî®Ôºâ ==========
      - name: Ê≠•È™§3 - ÊÅ¢Â§çÊï∞ÊçÆ
        id: step3
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== Ê≠•È™§3ÔºöÊÅ¢Â§çÊï∞ÊçÆ ====="
          RESTORE_DONE=false
          for dir in $BACKUP_DIRS; do
            env_key="HAS_${dir//\//_}"
            if [ "${!env_key}" = "true" ]; then
              echo "üîÑ ‰ªé $dir ÊÅ¢Â§çÊï∞ÊçÆ"
              EXCLUDE_PARAMS=()
              for excl in $EXCLUDE_DIRS; do
                EXCLUDE_PARAMS+=("--exclude=$excl")
              done
              target_path="$WEBDAV_MOUNT_POINT$dir"
              sudo rsync -av --delete "${EXCLUDE_PARAMS[@]}" "$target_path/" /
              if [ $? -eq 0 ]; then
                RESTORE_DONE=true
                echo "‚úÖ Êï∞ÊçÆÊÅ¢Â§çÂÆåÊàê ($dir)"
                break
              fi
            fi
          done
          if [ "$RESTORE_DONE" = "false" ]; then
            echo "‚ö†Ô∏è Êó†ÊúâÊïàÂ§á‰ªΩÊï∞ÊçÆÔºåË∑≥ËøáÊÅ¢Â§ç"
          fi
          echo "DATA_RESTORED=$RESTORE_DONE" >> "$GITHUB_ENV"

      # ========== Ê≠•È™§4ÔºöÊ∏ÖÁ©∫ÊóßÂ§á‰ªΩ ==========
      - name: Ê≠•È™§4 - Ê∏ÖÁ©∫WebDAVÊóßÂ§á‰ªΩ
        id: step4
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== Ê≠•È™§4ÔºöÊ∏ÖÁ©∫ÊóßÂ§á‰ªΩ ====="
          for dir in $BACKUP_DIRS; do
            target_path="$WEBDAV_MOUNT_POINT$dir"
            sudo rm -rf "$target_path"/*
            echo "‚úÖ $dir ÊóßÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫"
          done

      # ========== Ê≠•È™§5ÔºöÂÆâË£ÖCasaOS ==========
      - name: Ê≠•È™§5 - ÂÆâË£ÖCasaOS
        id: step5
        run: |
          echo "===== Ê≠•È™§5ÔºöÂÆâË£ÖCasaOS ====="
          if [ -d "$CASAOS_DATA" ] && [ "${{ env.DATA_RESTORED }}" = "true" ]; then
            echo "‚úÖ Ê£ÄÊµãÂà∞Â§á‰ªΩÊï∞ÊçÆÔºåË∑≥ËøáÂÆâË£Ö"
            exit 0
          fi
          echo "üîÑ ÂÆâË£ÖCasaOS"
          curl -fsSL https://get.casaos.io | sudo bash
          if [ $? -ne 0 ]; then
            echo "‚ùå CasaOSÂÆâË£ÖÂ§±Ë¥•"
            exit 1
          fi
          echo "‚úÖ CasaOSÂÆâË£ÖÂÆåÊàê"

      # ========== Ê≠•È™§6ÔºöÂêØÂä®ÊúçÂä° ==========
      - name: Ê≠•È™§6 - ÂêØÂä®CasaOS+Docker
        id: step6
        run: |
          echo "===== Ê≠•È™§6ÔºöÂêØÂä®ÊúçÂä° ====="
          sudo systemctl enable --now docker casaos
          sleep 30
          echo "DockerÁä∂ÊÄÅ: $(sudo systemctl is-active docker)"
          echo "CasaOSÁä∂ÊÄÅ: $(sudo systemctl is-active casaos)"
          if [ "$(sudo systemctl is-active docker)" != "active" ] || [ "$(sudo systemctl is-active casaos)" != "active" ]; then
            echo "‚ùå ÊúçÂä°ÂêØÂä®Â§±Ë¥•"
            exit 1
          fi
          echo "‚úÖ ÊúçÂä°ÂêØÂä®ÂÆåÊàê"

      # ========== Ê≠•È™§7ÔºöÈÉ®ÁΩ≤Tailscale ==========
      - name: Ê≠•È™§7 - ÈÉ®ÁΩ≤Tailscale
        id: step7
        run: |
          echo "===== Ê≠•È™§7ÔºöÈÉ®ÁΩ≤Tailscale ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "‚ö†Ô∏è Êú™ÈÖçÁΩÆTailscaleÂØÜÈí•ÔºåË∑≥ËøáÁªÑÁΩë"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-github-runner"
          TAILSCALE_IP=$(sudo tailscale ip -4)
          if [ -z "$TAILSCALE_IP" ]; then
            echo "‚ùå TailscaleËøûÊé•Â§±Ë¥•"
            exit 1
          fi
          echo "‚úÖ TailscaleÁªÑÁΩëÊàêÂäüÔºåÂÜÖÁΩëIP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== Ê≠•È™§8ÔºöËæìÂá∫ËÆøÈóÆ‰ø°ÊÅØ ==========
      - name: Ê≠•È™§8 - ËæìÂá∫ËÆøÈóÆ‰ø°ÊÅØ
        id: step8
        run: |
          echo "===== Ê≠•È™§8ÔºöËÆøÈóÆ‰ø°ÊÅØ ====="
          RUNNER_PUBLIC_IP=$(curl -s ifconfig.me)
          echo "====================================="
          echo "üîó ÂÖ¨ÁΩëËÆøÈóÆÔºöhttp://$RUNNER_PUBLIC_IP:80"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "üîí ÂÜÖÁΩëËÆøÈóÆÔºöhttp://${{ env.TAILSCALE_IP }}:80"
          fi
          echo "üîë ÈªòËÆ§Ë¥¶Âè∑Ôºöadmin / password"
          echo "‚ö†Ô∏è ÁôªÂΩïÂêéËØ∑Á´ãÂç≥‰øÆÊîπÂØÜÁ†ÅÔºÅ"
          echo "====================================="

      # ========== Ê≠•È™§9Ôºö‰øùÊ¥ª+Â§á‰ªΩ+Áª≠Ë∑ë ==========
      - name: Ê≠•È™§9 - ‰øùÊ¥ª‰∏éÁª≠Ë∑ë
        id: step9
        shell: /usr/bin/bash
        run: |
          echo "===== Ê≠•È™§9Ôºö‰øùÊ¥ª‰∏éÁª≠Ë∑ë ====="
          start_time=$(date +%s)
          backup_done=false
          trigger_done=false

          trigger_renew() {
            if [ "$trigger_done" = "true" ] || [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              return 1
            fi
            curl -s -X POST -H "Authorization: token $USER_PAT" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_tailscale"}' > /dev/null
            if [ $? -eq 0 ]; then
              trigger_done=true
              echo "‚úÖ Áª≠Ë∑ë‰ªªÂä°Ëß¶ÂèëÊàêÂäü"
              return 0
            fi
            return 1
          }

          backup_single_dir() {
            if [ "${{ env.WEBDAV_AVAILABLE }}" != "true" ]; then
              return 1
            fi
            local dir="$1"
            local target_path="$WEBDAV_MOUNT_POINT$dir"
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=$excl")
            done
            EXCLUDE_PARAMS+=("--exclude=$WEBDAV_MOUNT_POINT")
