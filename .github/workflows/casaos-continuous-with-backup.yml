name: CasaOS 纯净部署（备份保留2份+自动清理）

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read

jobs:
  casaos-deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: "--exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
      KEEP_BACKUPS: "2"
      TARGET_RUN_MINUTES: "60"
      CASA_SERVICES: "casaos-gateway casaos-message-bus casaos-user-service casaos-local-storage casaos-app-management rclone casaos"
      SNAPSHOT_NAME: "casaos-full-snapshot-$(date +%Y%m%d-%H%M%S)-$(hostname | cut -c1-8).tar.gz"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 🔒 初始化环境与依赖
        id: init
        run: |
          set -euo pipefail
          echo "WORKFLOW_START_TIME=$(date +%s)" >> $GITHUB_ENV
          
          [ -n "${ROOTS_PASSWORD:-}" ] && echo "::add-mask::$ROOTS_PASSWORD"
          [ -n "${WEBDAV_PASSWORD:-}" ] && echo "::add-mask::$WEBDAV_PASSWORD"
          [ -n "${TAILSCALE_AUTH_KEY:-}" ] && echo "::add-mask::$TAILSCALE_AUTH_KEY"
          [ -n "${CLOUDFLARED_TOKEN:-}" ] && echo "::add-mask::$CLOUDFLARED_TOKEN"
          
          sudo apt update -qq
          sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq
          sudo apt clean -y -qq
          
          AVAILABLE_KB=$(df -P / | awk 'NR==2{print $4}')
          REQUIRED_KB=$((10 * 1024 * 1024))
          if [ "$AVAILABLE_KB" -lt "$REQUIRED_KB" ]; then
            echo "❌ 根目录可用空间不足10GB"
            exit 1
          fi

      - name: 🐳 安装Docker引擎
        run: |
          set -euo pipefail
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd
          sudo usermod -aG docker "$USER"
          if ! sudo systemctl is-active --quiet docker; then
            echo "❌ Docker服务启动失败"
            exit 1
          fi

      - name: 👤 配置roots管理员用户
        run: |
          set -euo pipefail
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "${ROOTS_PASSWORD:-}" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 16 | tr -dc 'A-Za-z0-9' | head -c12)
            echo "::add-mask::$RANDOM_PASS"
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "🔑 roots临时密码已生成（已脱敏）"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"

      - name: ☁️ 配置WebDAV备份源
        id: webdav
        run: |
          set -euo pipefail
          if [ -z "${WEBDAV_URL:-}" ] || [ -z "${WEBDAV_USER:-}" ] || [ -z "${WEBDAV_PASSWORD:-}" ]; then
            echo "⚠️ WebDAV凭证缺失，跳过备份流程"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            echo "HAS_SNAPSHOT=false" >> $GITHUB_ENV
            exit 0
          fi
          
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /root/.rclone.conf 2>/dev/null || true
          sudo chmod 600 /root/.rclone.conf
          
          for i in {1..3}; do
            if rclone mkdir "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf; then
              echo "✅ WebDAV远程目录已就绪"
              break
            elif [ $i -eq 3 ]; then
              echo "❌ WebDAV目录创建失败"
              echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
              exit 0
            fi
            sleep 2
          done
          
          LATEST=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | head -1 || true)
          if [ -n "$LATEST" ] && [ "$LATEST" != "null" ]; then
            echo "✅ 检测到最新快照：$LATEST"
            echo "LATEST_SNAPSHOT=$LATEST" >> $GITHUB_ENV
            echo "HAS_SNAPSHOT=true" >> $GITHUB_ENV
          else
            echo "ℹ️ 无历史快照"
            echo "HAS_SNAPSHOT=false" >> $GITHUB_ENV
          fi
          echo "WEBDAV_AVAILABLE=true" >> $GITHUB_ENV

      - name: 🧹 清理旧CasaOS服务
        run: |
          set -euo pipefail
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
            sudo systemctl disable "${svc}.service" 2>/dev/null || true
            sudo rm -f "/etc/systemd/system/${svc}.service" "/usr/lib/systemd/system/${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 -f "casaos|rclone" 2>/dev/null || true
          sudo rm -rf /var/lib/casaos/* /etc/casaos/* 2>/dev/null || true
          sudo systemctl daemon-reload

      - name: 📦 安装CasaOS核心
        run: |
          set -euo pipefail
          curl -fsSL https://get.casaos.io | sudo bash
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          if [ ! -f /usr/bin/casaos ]; then
            echo "❌ CasaOS安装失败"
            exit 1
          fi

      - name: 🔄 恢复历史快照数据
        if: env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true'
        run: |
          set -euo pipefail
          sudo systemctl stop docker containerd 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 docker containerd runc 2>/dev/null || true
          sync && sleep 3
          
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" 2>/dev/null || true
          done
          
          echo "🔄 恢复快照：$LATEST_SNAPSHOT"
          rclone cat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf | \
            sudo tar -xzf - -C / --preserve-permissions --overwrite $PERSONAL_DATA_DIRS 2>&1 | grep -v "Removing leading" || true
          
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true

      - name: ⚙️ 启动CasaOS服务
        run: |
          set -euo pipefail
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          
          sudo systemctl enable --now docker containerd
          sleep 5
          if ! sudo systemctl is-active --quiet docker; then
            echo "❌ Docker服务启动失败"
            exit 1
          fi
          
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 8
          if ! sudo systemctl is-active --quiet casaos; then
            echo "❌ CasaOS核心服务启动失败"
            exit 1
          fi
          
          if [ "${HAS_SNAPSHOT:-false}" != "true" ]; then
            LOCAL_IP=$(hostname -I | awk '{print $1}')
            echo "✨ 首次部署完成，访问地址：http://$LOCAL_IP"
          fi

      - name: 🌐 配置Tailscale组网
        if: env.TAILSCALE_AUTH_KEY != ''
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo systemctl enable --now tailscaled
          sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" \
            --hostname="CasaOS-$(hostname | cut -c1-8)" --accept-routes --advertise-exit-node 2>/dev/null || true
          TAIL_IP=$(sudo tailscale ip -4 2>/dev/null || echo "未获取")
          echo "✅ Tailscale访问IP：$TAIL_IP"

      - name: 🌉 配置Cloudflare Tunnel
        if: env.CLOUDFLARED_TOKEN != ''
        run: |
          set -euo pipefail
          sudo mkdir -p /usr/local/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/local/share/keyrings/cloudflare.gpg >/dev/null
          echo "deb [signed-by=/usr/local/share/keyrings/cloudflare.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null
          sudo apt update -qq && sudo apt install -y cloudflared -qq
          
          echo "CLOUDFLARED_TOKEN=${CLOUDFLARED_TOKEN}" | sudo tee /etc/default/cloudflared > /dev/null
          sudo chmod 600 /etc/default/cloudflared
          
          sudo tee /etc/systemd/system/cloudflared.service > /dev/null <<'EOF'
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
EnvironmentFile=/etc/default/cloudflared
ExecStart=/usr/bin/cloudflared tunnel run --token $CLOUDFLARED_TOKEN
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=cloudflared

[Install]
WantedBy=multi-user.target
EOF
          
          sudo systemctl daemon-reload
          sudo systemctl enable --now cloudflared
          sleep 8
          if ! sudo systemctl is-active --quiet cloudflared; then
            echo "❌ Cloudflare Tunnel启动失败，日志：journalctl -u cloudflared"
            exit 1
          fi

      - name: 📤 生成并上传最新快照
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          set -euo pipefail
          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S)-$(hostname | cut -c1-8).tar.gz"
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo systemctl stop docker containerd 2>/dev/null || true
          sync && sleep 3
          
          echo "📦 生成快照：$SNAPSHOT_NAME"
          sudo tar -czf - $EXCLUDE_RULES $PERSONAL_DATA_DIRS 2>/dev/null | \
            rclone rcat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}" --config /root/.rclone.conf || { echo "❌ 快照上传失败"; exit 1; }
          
          sudo systemctl enable --now docker containerd
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 5

      - name: 🧹 清理旧快照（保留最新2份）
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          set -euo pipefail
          OLD_SNAPSHOTS=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | tail -n +$(( ${KEEP_BACKUPS:-2} + 1 )) || true)
          
          if [ -n "$OLD_SNAPSHOTS" ] && [ "$OLD_SNAPSHOTS" != "null" ]; then
            for snap in $OLD_SNAPSHOTS; do
              echo "删除旧快照：$snap"
              rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${snap}" --config /root/.rclone.conf 2>/dev/null || true
            done
            echo "✅ 已保留最新${KEEP_BACKUPS}份快照"
          else
            echo "ℹ️ 快照数量未超过${KEEP_BACKUPS}份，无需清理"
          fi

      - name: ⏱️ 延时校准（满足最小运行时长）
        if: env.WEBDAV_AVAILABLE == 'true' && github.event_name == 'repository_dispatch'
        run: |
          set -euo pipefail
          START_TIME="${WORKFLOW_START_TIME}"
          CURRENT_TIME=$(date +%s)
          CURRENT_DURATION=$((CURRENT_TIME - START_TIME))
          TARGET_DURATION=$((TARGET_RUN_MINUTES * 60))
          WAIT_TIME=$((TARGET_DURATION - CURRENT_DURATION))
          
          if [ $WAIT_TIME -gt 0 ]; then
            echo "⏳ 等待$((WAIT_TIME / 60))分钟以满足运行时长要求"
            sleep $WAIT_TIME
          else
            echo "ℹ️ 运行时长已达标，无需等待"
          fi

      - name: 📊 部署完成报告
        run: |
          echo "========================================"
          echo "✅ CasaOS部署与备份流程完成"
          echo "📌 核心信息："
          echo "   - 本地访问：http://$(hostname -I | awk '{print $1}')"
          echo "   - Tailscale IP：$(sudo tailscale ip -4 2>/dev/null || echo "未启用")"
          echo "   - Cloudflare Tunnel：$(sudo systemctl is-active cloudflared 2>/dev/null && echo "已启用" || echo "未启用")"
          echo "   - 备份状态：已保留最新${KEEP_BACKUPS}份快照"
          echo "========================================"