name: CasaOS+VNC+Tailscale æŒç»­æœåŠ¡ï¼ˆåˆ°æœŸå¤‡ä»½+ç»­è·‘æ¢å¤æœ€ç»ˆç‰ˆï¼‰
on:
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_vnc]     # ç»­è·‘è§¦å‘

jobs:
  casaos-vnc-continuous:
    runs-on: ubuntu-24.04
    timeout-minutes: 350   # æ€»è¿è¡Œæ—¶é•¿ï¼ˆé¢„ç•™10åˆ†é’Ÿå¤‡ä»½+ç»­è·‘ï¼‰
    env:
      # åŸºç¡€ç¯å¢ƒé…ç½®
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340 # å®é™…è¿è¡Œæ—¶é•¿ï¼ˆå‰©ä½™10åˆ†é’Ÿæ‰§è¡Œå¤‡ä»½+ç»­è·‘ï¼‰
      # è®¤è¯é…ç½®
      FIXED_VNC_PWD: "123456789"
      RUNNER_PASSWORD: "runner123"
      # æœåŠ¡ç«¯å£é…ç½®
      CASAOS_PORT: 80
      # ç›®å½•é…ç½®
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      # å¤‡ä»½æ’é™¤è§„åˆ™ï¼ˆé¿å…ç³»ç»Ÿç›®å½•å†²çªï¼‰
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      # ç»´æŠ¤é…ç½®
      CLEAN_INTERVAL: 3600 # æ¯1å°æ—¶æ¸…ç†ä¸€æ¬¡
      # Backblaze B2 å­˜å‚¨é…ç½®ï¼ˆæ ¸å¿ƒå¯†é’¥ï¼‰
      B2_KEY_ID: "87dbd01ad00c"
      B2_APPLICATION_KEY: "005199ce79f1bd581cbfc54b2fb12ba6b5fd7d0fb6"
      B2_BACKUP_BUCKET: "casaos-backup"
      BACKUP_MARKER: "latest_backup.txt" # æ ‡è®°æœ€æ–°å¤‡ä»½æ–‡ä»¶åï¼ˆç”¨äºç»­è·‘æ¢å¤ï¼‰

    steps:
      ###########################################################################
      # ç¬¬ä¸€æ­¥ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–ï¼ˆåŸºç¡€ä¾èµ–+æƒé™é…ç½®ï¼‰
      ###########################################################################
      - name: 1. ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        id: init_system
        continue-on-error: false
        run: |
          echo "===== å¼€å§‹ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ====="
          # 1. æ›´æ–°ç³»ç»ŸåŒ…ç´¢å¼•å¹¶å‡çº§
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "âŒ ç³»ç»Ÿæ›´æ–°å¤±è´¥"; exit 1; }
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "âŒ ç³»ç»Ÿå‡çº§å¤±è´¥"; exit 1; }
          
          # 2. å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå«å¤‡ä»½ã€VNCã€å­˜å‚¨ç­‰å·¥å…·ï¼‰
          required_packages="tar gzip rsync rclone tigervnc-standalone-server netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release bc"
          sudo apt install -y $required_packages || { echo "âŒ æ ¸å¿ƒä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          
          # 3. é…ç½®runnerç”¨æˆ·å¯†ç ï¼ˆè¿œç¨‹ç™»å½•ç”¨ï¼‰
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          
          # 4. åˆ›å»ºå¿…è¦ç›®å½•å¹¶æˆæƒ
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          
          echo "âœ… ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      ###########################################################################
      # ç¬¬äºŒæ­¥ï¼šå¯¹è±¡å­˜å‚¨é…ç½®ï¼ˆBackblaze B2 + rcloneï¼‰
      ###########################################################################
      - name: 2. é…ç½® Backblaze B2 å­˜å‚¨ï¼ˆrcloneï¼‰
        id: config_b2_storage
        continue-on-error: false
        run: |
          echo "===== å¼€å§‹é…ç½® B2 å­˜å‚¨ ====="
          # 1. éªŒè¯B2å¯†é’¥å®Œæ•´æ€§
          if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
            echo "âŒ B2å­˜å‚¨å¯†é’¥æœªé…ç½®ï¼ˆKEY_ID/APPLICATION_KEYç¼ºå¤±ï¼‰"; exit 1;
          fi
          
          # 2. åˆ›å»ºrcloneé…ç½®ç›®å½•å¹¶å†™å…¥é…ç½®
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
[b2_backend]
type = b2
account = $B2_KEY_ID
key = $B2_APPLICATION_KEY
hard_delete = true
timeout = 30s
retries = 3
EOF
          # 3. é…ç½®æ–‡ä»¶æƒé™ï¼ˆå®‰å…¨é™åˆ¶ï¼Œä»…å½“å‰ç”¨æˆ·å¯è¯»ï¼‰
          chmod 600 ~/.config/rclone/rclone.conf
          
          # 4. æµ‹è¯•B2å­˜å‚¨è¿æ¥å¹¶åˆ›å»ºå¤‡ä»½æ¡¶
          echo "===== æµ‹è¯• B2 å­˜å‚¨è¿æ¥ ====="
          rclone mkdir b2_backend:${B2_BACKUP_BUCKET}/ || echo "â„¹ï¸  å¤‡ä»½æ¡¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          if rclone lsd b2_backend:${B2_BACKUP_BUCKET}/ --verbose --retries 3; then
            echo "âœ… B2å­˜å‚¨è¿æ¥æˆåŠŸ"
            echo "B2_CONNECT_STATUS=âœ… æˆåŠŸ" >> $GITHUB_ENV
          else
            echo "âŒ B2å­˜å‚¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š1. å¯†é’¥æ˜¯å¦æ­£ç¡® 2. ç½‘ç»œæ˜¯å¦å¯è¾¾"
            exit 1
          fi
          
          echo "âœ… B2å­˜å‚¨é…ç½®å®Œæˆ"

      ###########################################################################
      # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å†å²å¤‡ä»½ï¼ˆç”¨äºç»­è·‘æ¢å¤åˆ¤æ–­ï¼‰
      ###########################################################################
      - name: 3. æ£€æŸ¥å†å²å¤‡ä»½ï¼ˆç»­è·‘æ¢å¤ç”¨ï¼‰
        id: check_history_backup
        continue-on-error: false
        run: |
          echo "===== æ£€æŸ¥å†å²å¤‡ä»½ ====="
          # 1. å°è¯•ä¸‹è½½å¤‡ä»½æ ‡è®°æ–‡ä»¶ï¼ˆè®°å½•æœ€æ–°å¤‡ä»½æ–‡ä»¶åï¼‰
          if rclone copy b2_backend:${B2_BACKUP_BUCKET}/${BACKUP_MARKER} $BACKUP_DIR/ --timeout 30s; then
            LATEST_BACKUP=$(cat $BACKUP_DIR/${BACKUP_MARKER})
            echo "â„¹ï¸  æ‰¾åˆ°æœ€æ–°å¤‡ä»½ï¼š$LATEST_BACKUP"
            echo "LATEST_BACKUP=$LATEST_BACKUP" >> $GITHUB_ENV
            echo "HAS_HISTORY_BACKUP=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ°å†å²å¤‡ä»½ï¼ˆé¦–æ¬¡éƒ¨ç½²æˆ–æ— æœ‰æ•ˆå¤‡ä»½ï¼‰"
            echo "HAS_HISTORY_BACKUP=false" >> $GITHUB_ENV
          fi

      ###########################################################################
      # ç¬¬å››æ­¥ï¼šå®‰è£…åŸºç¡€æœåŠ¡ï¼ˆDocker + CasaOSï¼‰
      ###########################################################################
      - name: 4. å®‰è£…åŸºç¡€æœåŠ¡ï¼ˆDocker + CasaOSï¼‰
        id: install_base_services
        continue-on-error: false
        run: |
          echo "===== å®‰è£… Docker å¼•æ“ ====="
          # 1. é…ç½®Dockerå®˜æ–¹æº
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          # 2. å®‰è£…Dockerå¹¶å¯åŠ¨
          sudo apt update -y 2>&1 | grep -v "restart"
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin || { echo "âŒ Dockerå®‰è£…å¤±è´¥"; exit 1; }
          sudo systemctl enable docker && sudo systemctl start docker
          echo "âœ… Dockerå®‰è£…å¹¶å¯åŠ¨æˆåŠŸ"
          
          echo "===== å®‰è£… CasaOS ====="
          # 1. å®‰è£…CasaOSï¼ˆå®˜æ–¹è„šæœ¬ï¼‰
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || { echo "âš ï¸ CasaOSå®‰è£…è­¦å‘Šï¼ˆå¯èƒ½ä¸å½±å“ä½¿ç”¨ï¼‰"; }
          # 2. å…ˆåœæ­¢CasaOSï¼ˆè‹¥åç»­éœ€è¦æ¢å¤å¤‡ä»½ï¼Œé¿å…æ•°æ®å†²çªï¼‰
          sudo systemctl stop casaos
          sudo systemctl stop docker
          echo "âœ… CasaOSå®‰è£…å®Œæˆï¼ˆå·²åœæ­¢ï¼Œå¾…æ¢å¤/ç›´æ¥å¯åŠ¨ï¼‰"

      ###########################################################################
      # ç¬¬äº”æ­¥ï¼šç»­è·‘æ¢å¤ï¼ˆä»…å½“æœ‰å†å²å¤‡ä»½æ—¶æ‰§è¡Œï¼‰
      ###########################################################################
      - name: 5. ç»­è·‘æ¢å¤ - ä»B2æ¢å¤æœ€æ–°å¤‡ä»½
        id: restore_from_backup
        if: env.HAS_HISTORY_BACKUP == 'true'
        continue-on-error: false
        run: |
          echo "===== å¼€å§‹æ¢å¤æœ€æ–°å¤‡ä»½ï¼š${LATEST_BACKUP} ====="
          # 1. ç”Ÿæˆæ’é™¤æ–‡ä»¶ï¼ˆä¿®å¤YAMLè¯­æ³•å†²çªï¼Œæ›¿ä»£è¿›ç¨‹æ›¿æ¢ï¼‰
          echo "$BACKUP_EXCLUDE" | tr ' ' '\n' | sed 's/--exclude=//g' > $BACKUP_DIR/exclude-list.txt
          
          # 2. ä»B2ä¸‹è½½å¤‡ä»½å¹¶è§£å‹æ¢å¤ï¼ˆå†…å­˜ç›´ä¼ ï¼Œä¸è½åœ°å¤§æ–‡ä»¶ï¼‰
          rclone cat b2_backend:${B2_BACKUP_BUCKET}/${LATEST_BACKUP} --timeout 120s --retries 3 | sudo tar -zxf - -C / --exclude-from=$BACKUP_DIR/exclude-list.txt 2>/dev/null
          
          # 3. éªŒè¯æ¢å¤ç»“æœå¹¶é‡å¯æœåŠ¡
          if [ $? -eq 0 ]; then
            echo "âœ… å¤‡ä»½æ¢å¤æˆåŠŸï¼æ•°æ®ä¸ä¸Šä¸€æ¬¡ç¯å¢ƒå®Œå…¨ä¸€è‡´"
            # é‡å¯Dockerå’ŒCasaOS
            sudo systemctl start docker
            sleep 5 && sudo systemctl start casaos
          else
            echo "âŒ å¤‡ä»½æ¢å¤å¤±è´¥ï¼Œå¯åŠ¨å…¨æ–°ç¯å¢ƒ"
            echo "HAS_HISTORY_BACKUP=false" >> $GITHUB_ENV
            # é‡å¯æœåŠ¡
            sudo systemctl start docker
            sleep 5 && sudo systemctl start casaos
          fi

      ###########################################################################
      # ç¬¬å…­æ­¥ï¼šéƒ¨ç½²æ ¸å¿ƒæœåŠ¡ï¼ˆVNC + Tailscaleï¼‰
      ###########################################################################
      - name: 6. éƒ¨ç½²æ ¸å¿ƒæœåŠ¡ï¼ˆVNC + Tailscaleï¼‰
        id: deploy_core_services
        continue-on-error: false
        run: |
          echo "===== é…ç½® VNC æœåŠ¡ ====="
          # 1. åˆ›å»ºVNCé…ç½®ç›®å½•å¹¶è®¾ç½®å¯†ç 
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          
          # 2. ç¼–å†™VNCå¯åŠ¨è„šæœ¬ï¼ˆé€‚é…Ubuntuç¯å¢ƒï¼‰
          cat > $VNCDIR/xstartup << EOF
#!/bin/bash
export DISPLAY=:0
export XDG_RUNTIME_DIR=/tmp/runtime-runner
mkdir -p \$XDG_RUNTIME_DIR && chmod 700 \$XDG_RUNTIME_DIR
exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title "CasaOS æœåŠ¡æ§åˆ¶å°"
EOF
          chmod +x $VNCDIR/xstartup
          
          # 3. å¯åŠ¨VNCæœåŠ¡ï¼ˆå…ˆåœæ­¢æ—§è¿›ç¨‹ï¼‰
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth || { echo "âŒ VNCå¯åŠ¨å¤±è´¥"; exit 1; }
          echo "âœ… VNCæœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š$VNC_PORT"
          
          echo "===== é…ç½® Tailscale ç»„ç½‘ ====="
          # 1. å®‰è£…Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart" || { echo "âŒ Tailscaleå®‰è£…å¤±è´¥"; exit 1; }
          sudo systemctl enable --now tailscaled && sleep 3
          
          # 2. è¿æ¥Tailscaleï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          MAX_RETRIES=3
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "âœ… Tailscaleè¿æ¥æˆåŠŸï¼Œå†…ç½‘IPï¼š$TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            echo "âš ï¸ Tailscaleè¿æ¥å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$MAX_RETRIES"
            sleep 5
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscaleè¿æ¥å¤±è´¥ï¼Œæ— æ³•è·å–è®¿é—®IP"; exit 1;
          fi

      ###########################################################################
      # ç¬¬ä¸ƒæ­¥ï¼šè¾“å‡ºæœåŠ¡è®¿é—®ä¿¡æ¯ï¼ˆæ¸…æ™°å±•ç¤ºæ ¸å¿ƒé…ç½®ï¼‰
      ###########################################################################
      - name: 7. è¾“å‡ºæœåŠ¡è®¿é—®ä¿¡æ¯
        id: output_access_info
        continue-on-error: false
        run: |
          echo -e "\n=================================================="
          echo -e " ğŸš€ CasaOS+VNC+Tailscale æŒç»­æœåŠ¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"
          echo -e "=================================================="
          echo -e " ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯"
          echo -e "   - è¿è¡Œæ—¶é•¿ï¼š${MAX_RUN_MINUTES}åˆ†é’Ÿï¼ˆå‰©ä½™10åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½+ç»­è·‘ï¼‰"
          echo -e "   - å¯ç”¨ç©ºé—´ï¼š$(df -h / | awk 'NR==2{print $4}')"
          echo -e "   - Runnerç™»å½•å¯†ç ï¼š\033[1;32m${RUNNER_PASSWORD}\033[0m"
          echo -e " ğŸ“¦ å­˜å‚¨ä¿¡æ¯"
          echo -e "   - å­˜å‚¨ç±»å‹ï¼šBackblaze B2"
          echo -e "   - å­˜å‚¨çŠ¶æ€ï¼š${B2_CONNECT_STATUS}"
          echo -e "   - å¤‡ä»½ç­–ç•¥ï¼šä»…åˆ°æœŸå‰10åˆ†é’Ÿæ‰§è¡Œå…¨é‡å¤‡ä»½ï¼Œç»­è·‘è‡ªåŠ¨æ¢å¤"
          echo -e " ğŸ”— è®¿é—®åœ°å€"
          echo -e "   - VNCè¿œç¨‹æ¡Œé¢ï¼š\033[1;33m${TAILSCALE_IP}:${VNC_PORT}\033[0mï¼ˆå¯†ç ï¼š${FIXED_VNC_PWD}ï¼‰"
          echo -e "   - CasaOSç®¡ç†ç•Œé¢ï¼š\033[1;33mhttp://${TAILSCALE_IP}:${CASAOS_PORT}\033[0m"
          echo -e " ğŸ§¹ ç»´æŠ¤ä¿¡æ¯"
          echo -e "   - å®šæ—¶æ¸…ç†ï¼šæ¯1å°æ—¶è‡ªåŠ¨æ¸…ç†ç³»ç»Ÿåƒåœ¾"
          echo -e "   - æ•°æ®çŠ¶æ€ï¼š$(if [ $HAS_HISTORY_BACKUP == 'true' ]; then echo -e "\033[1;32må·²æ¢å¤ä¸Šä¸€æ¬¡ç¯å¢ƒæ•°æ®\033[0m"; else echo -e "\033[1;34mé¦–æ¬¡éƒ¨ç½²ï¼Œæ— å†å²æ•°æ®\033[0m"; fi)"
          echo -e "==================================================\n"

      ###########################################################################
      # ç¬¬å…«æ­¥ï¼šæ ¸å¿ƒé€»è¾‘ï¼ˆä¿æ´»+å®šæ—¶æ¸…ç†+åˆ°æœŸå¤‡ä»½+ç»­è·‘è§¦å‘ï¼‰
      ###########################################################################
      - name: 8. æ ¸å¿ƒé€»è¾‘ - ä¿æ´»+æ¸…ç†+å¤‡ä»½+ç»­è·‘
        id: core_logic
        continue-on-error: true
        run: |
          echo "===== å¯åŠ¨æ ¸å¿ƒç›‘æ§é€»è¾‘ ====="
          start_time=$(date +%s)
          last_clean_time=$start_time
          backup_executed=false # æ ‡è®°æ˜¯å¦å·²æ‰§è¡Œåˆ°æœŸå¤‡ä»½

          #######################################
          # å­å‡½æ•°1ï¼šæ¯å°æ—¶åƒåœ¾æ¸…ç†ï¼ˆæ·±åº¦æ¸…ç†ï¼‰
          #######################################
          auto_clean() {
            echo "===== æ‰§è¡Œæ¯å°æ—¶åƒåœ¾æ¸…ç† ====="
            BEFORE_CLEAN=$(df -h / | awk 'NR==2{print $4}')
            # 1. ç³»ç»Ÿç¼“å­˜æ¸…ç†
            sudo apt clean -y && sudo apt autoremove -y --purge
            # 2. Dockerå†—ä½™æ¸…ç†ï¼ˆé•œåƒã€å®¹å™¨ã€å·ï¼‰
            sudo docker system prune -af --volumes 2>/dev/null || true
            # 3. ä¸´æ—¶æ–‡ä»¶æ¸…ç†
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null
            AFTER_CLEAN=$(df -h / | awk 'NR==2{print $4}')
            echo "âœ… æ¸…ç†å®Œæˆï¼šæ¸…ç†å‰${BEFORE_CLEAN} â†’ æ¸…ç†å${AFTER_CLEAN}"
          }

          #######################################
          # å­å‡½æ•°2ï¼šåˆ°æœŸå¤‡ä»½ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰
          #######################################
          expire_full_backup() {
            echo "===== å‰©ä½™10åˆ†é’Ÿï¼Œæ‰§è¡Œå…¨é‡å¤‡ä»½ ====="
            # 1. ç”Ÿæˆå¤‡ä»½æ–‡ä»¶åï¼ˆæ—¶é—´æˆ³ï¼‰
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            FULL_BACKUP_NAME="casaos_full_${TIMESTAMP}.tar.gz"
            
            # 2. åœæ­¢æ ¸å¿ƒæœåŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
            sudo systemctl stop casaos
            sudo systemctl stop docker
            sleep 3
            
            # 3. æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼ˆå†…å­˜ç›´ä¼ è‡³B2ï¼Œä¸è½åœ°ï¼‰
            sudo tar -zcf - $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat b2_backend:${B2_BACKUP_BUCKET}/${FULL_BACKUP_NAME} --timeout 60s --retries 3
            
            # 4. éªŒè¯å¤‡ä»½ç»“æœå¹¶æ›´æ–°æ ‡è®°æ–‡ä»¶
            if [ $? -eq 0 ]; then
              echo "âœ… åˆ°æœŸå¤‡ä»½æˆåŠŸï¼šb2_backend:${B2_BACKUP_BUCKET}/${FULL_BACKUP_NAME}"
              # æ›´æ–°å¤‡ä»½æ ‡è®°æ–‡ä»¶ï¼ˆä¾›ç»­è·‘æ¢å¤ï¼‰
              echo "${FULL_BACKUP_NAME}" > $BACKUP_DIR/${BACKUP_MARKER}
              rclone copy $BACKUP_DIR/${BACKUP_MARKER} b2_backend:${B2_BACKUP_BUCKET}/ --timeout 30s
            else
              echo "âŒ åˆ°æœŸå¤‡ä»½å¤±è´¥"
            fi
            
            # 5. é‡å¯æ ¸å¿ƒæœåŠ¡
            sudo systemctl start docker
            sleep 5 && sudo systemctl start casaos
            backup_executed=true
          }

          #######################################
          # å­å‡½æ•°3ï¼šè§¦å‘ç»­è·‘ï¼ˆå¯åŠ¨æ–°å·¥ä½œæµï¼‰
          #######################################
          trigger_renew() {
            echo "===== è§¦å‘ç»­è·‘è¯·æ±‚ ====="
            curl -X POST https://api.github.com/repos/${{ github.repository }}/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.USER_GITHUB_PAT }}" \
              -d '{"event_type":"renew_vnc"}' \
              --connect-timeout 30s || echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥ï¼ˆè¯·æ£€æŸ¥USER_GITHUB_PATå¯†é’¥ï¼‰"
          }

          #######################################
          # ä¸»å¾ªç¯ï¼šä¿æ´»+å®šæ—¶æ¸…ç†+åˆ°æœŸå¤‡ä»½+ç»­è·‘
          #######################################
          while true; do
            current_time=$(date +%s)
            run_minutes=$(( (current_time - start_time) / 60 ))
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            # 1. æ¯å°æ—¶æ‰§è¡Œåƒåœ¾æ¸…ç†
            if [ $((current_time - last_clean_time)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean_time=$current_time
            fi

            # 2. ç©ºé—´åº”æ€¥æ¸…ç†ï¼ˆä¸è¶³1GBç«‹å³æ¸…ç†ï¼‰
            if (( $(echo "$FREE_SPACE < 1" | bc -l) )); then
              echo "âš ï¸  ç©ºé—´ä¸è¶³1GBï¼Œç´§æ€¥æ¸…ç†..."
              auto_clean
              last_clean_time=$current_time
            fi

            # 3. å‰©ä½™10åˆ†é’Ÿï¼šæ‰§è¡Œå¤‡ä»½+è§¦å‘ç»­è·‘ï¼ˆä»…ä¸€æ¬¡ï¼‰
            if [ $((MAX_RUN_MINUTES - run_minutes)) -eq 10 ] && [ "$backup_executed" = false ]; then
              expire_full_backup  # æ‰§è¡Œåˆ°æœŸå¤‡ä»½
              trigger_renew       # è§¦å‘ç»­è·‘
            fi

            # 4. æœåŠ¡å¥åº·æ£€æŸ¥ï¼ˆå¼‚å¸¸è‡ªåŠ¨é‡å¯ï¼‰
            pgrep -x Xvnc || { echo "âš ï¸ VNCå¼‚å¸¸ï¼Œé‡å¯"; vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth; }
            sudo systemctl is-active --quiet docker || { echo "âš ï¸ Dockerå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart docker; }
            sudo systemctl is-active --quiet casaos || { echo "âš ï¸ CasaOSå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart casaos; }
            sudo systemctl is-active --quiet tailscaled || { echo "âš ï¸ Tailscaleå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart tailscaled; }

            # 5. è¿è¡ŒçŠ¶æ€æ—¥å¿—
            echo "[$(date)] è¿è¡Œæ—¶é•¿ï¼š${run_minutes}åˆ†é’Ÿ | å‰©ä½™ç©ºé—´: $(df -h / | awk 'NR==2{print $4}') | ä¸‹æ¬¡æ¸…ç†ï¼š$(( (last_clean_time + CLEAN_INTERVAL - current_time) / 60 ))åˆ†é’Ÿå"
            sleep 300 # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
          done

      ###########################################################################
      # ç¬¬ä¹æ­¥ï¼šä¼˜é›…æ¸…ç†ç¯å¢ƒï¼ˆæ— è®ºæˆåŠŸ/å¤±è´¥éƒ½æ‰§è¡Œï¼‰
      ###########################################################################
      - name: 9. ä¼˜é›…æ¸…ç†ç¯å¢ƒ
        id: clean_env
        if: always()
        run: |
          echo "===== å¼€å§‹æ¸…ç†ç¯å¢ƒ ====="
          # 1. åœæ­¢VNCæœåŠ¡
          vncserver -kill $DISPLAY || true && pkill -9 Xvnc || true
          # 2. åœæ­¢æ ¸å¿ƒæœåŠ¡
          sudo systemctl stop docker casaos tailscaled || true
          sudo tailscale down || true
          # 3. æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼ˆå¤‡ä»½å·²å­˜B2ï¼‰
          rm -rf $BACKUP_DIR $VNCDIR $NETDISK_ROOT || true
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
