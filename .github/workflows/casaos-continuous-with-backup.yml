name: CasaOS-Tailscale-Full-Deploy

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_tailscale]  # ä»“åº“äº‹ä»¶è§¦å‘ç±»åž‹

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu"
      # æ ¸å¿ƒä¿®æ”¹ï¼šä»…å¤‡ä»½ /var/lib ç›®å½•
      CORE_BACKUP_DIR: /var/lib
      # ç®€åŒ–æŽ’é™¤ç›®å½•ï¼ˆä»…æŽ’é™¤ä¸´æ—¶/æŒ‚è½½ç›®å½•ï¼Œé¿å…å¾ªçŽ¯ï¼‰
      EXCLUDE_DIRS: "/tmp /var/tmp /home/runner $WEBDAV_MOUNT_POINT"
      MAX_MOUNT_RETRIES: 5
      RETRY_DELAY: 10
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»ŸçŽ¯å¢ƒåˆå§‹åŒ– ==========
      - name: Step 1 - Initialize System Environment
        run: |
          set -e
          echo "===== Step 1: Install rclone and dependencies ====="
          sudo apt update -y && sudo apt install -y rsync curl wget jq fuse3 || { echo "âŒ Dependency installation failed"; exit 1; }
          
          # å®‰è£…rcloneå¹¶éªŒè¯
          curl https://rclone.org/install.sh | sudo bash
          if ! command -v rclone &> /dev/null; then
            echo "âŒ rclone installation failed"
            exit 1
          fi
          
          # é…ç½®fuseå…è®¸éžrootç”¨æˆ·ä½¿ç”¨allow_other
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          
          # ä¿®å¤sudoå…å¯†
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          if ! sudo -n true; then
            echo "âŒ Sudo password-less configuration failed!"
            exit 1
          fi
          echo "âœ… Initialization completed"

      # ========== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ· ==========
      - name: Step 1.5 - Create roots User
        run: |
          set -e
          echo "===== Step 1.5: Create roots user ====="
          if id "roots" &>/dev/null; then
            echo "â„¹ï¸ roots user already exists"
          else
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
              echo "âœ… roots user created with custom password"
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots user created with random password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi
          echo "âœ… Debug user 'roots' is ready"

      # ========== æ­¥éª¤2ï¼šæŒ‚è½½ WebDAV ==========
      - name: Step 2 - Mount WebDAV with rclone
        run: |
          set -e
          echo "===== Step 2: Mount WebDAV via rclone ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets not configured"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          mkdir -p "$WEBDAV_MOUNT_POINT"
          
          # é…ç½®rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="other" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf

          # æŒ‚è½½WebDAV
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" --config /home/runner/.rclone.conf --vfs-cache-mode full --daemon-timeout 1h --allow-other --umask 022 --log-file /tmp/rclone.log --log-level DEBUG --retries 3 >/dev/null 2>&1 &

          # æ£€æŸ¥æŒ‚è½½
          MOUNT_SUCCESS=false
          for i in $(seq 1 $MAX_MOUNT_RETRIES); do
            echo "ðŸ” Checking mount attempt $i/$MAX_MOUNT_RETRIES..."
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              MOUNT_SUCCESS=true
              break
            fi
            sleep $RETRY_DELAY
          done

          if [ "$MOUNT_SUCCESS" = true ]; then
            echo "âœ… rclone WebDAV mount succeeded"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            # æ£€æŸ¥æ ¸å¿ƒå¤‡ä»½ç›®å½• /var/lib æ˜¯å¦å­˜åœ¨å¤‡ä»½æ•°æ®
            target_path="$WEBDAV_MOUNT_POINT$CORE_BACKUP_DIR"
            mkdir -p "$target_path"
            if [ -n "$(ls -A "$target_path" 2>/dev/null)" ]; then
              echo "âœ… Valid backup detected: $CORE_BACKUP_DIR"
              echo "HAS_CORE_BACKUP=true" >> "$GITHUB_ENV"
            else
              echo "âš ï¸ Empty backup directory: $CORE_BACKUP_DIR"
              echo "HAS_CORE_BACKUP=false" >> "$GITHUB_ENV"
            fi
          else
            echo "âŒ rclone mount failed after $MAX_MOUNT_RETRIES retries"
            cat /tmp/rclone.log || echo "No rclone log found"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      # ========== æ­¥éª¤3ï¼šæ¢å¤ /var/lib æ ¸å¿ƒæ•°æ® ==========
      - name: Step 3 - Restore /var/lib Core Data
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_CORE_BACKUP == 'true' }}
        run: |
          set -e
          echo "===== Step 3: Restore $CORE_BACKUP_DIR ====="
          RESTORE_DONE=false
          
          if ! command -v rsync &> /dev/null; then
            echo "âŒ rsync not found"
            echo "DATA_RESTORED=false" >> "$GITHUB_ENV"
            exit 0
          fi

          target_path="$WEBDAV_MOUNT_POINT$CORE_BACKUP_DIR"
          # æž„å»ºæŽ’é™¤å‚æ•°ï¼ˆä»…æŽ’é™¤ä¸´æ—¶/æŒ‚è½½ç›®å½•ï¼‰
          EXCLUDE_PARAMS=()
          for excl in $EXCLUDE_DIRS; do
            EXCLUDE_PARAMS+=("--exclude=$excl")
          done

          # æ¢å¤ /var/lib ç›®å½•
          echo "ðŸ”„ Restoring $CORE_BACKUP_DIR from backup..."
          sudo rsync -a --delete --copy-links --sparse --numeric-ids \
            "${EXCLUDE_PARAMS[@]}" "$target_path/" "$CORE_BACKUP_DIR/" \
            --log-file=/tmp/rsync_restore.log --log-file-format="%t %f %b"
          
          if [ $? -eq 0 ]; then
            RESTORE_DONE=true
            echo "âœ… Restore succeeded: $CORE_BACKUP_DIR"
          else
            echo "âš ï¸ Restore $CORE_BACKUP_DIR failed, log:"
            cat /tmp/rsync_restore.log || echo "No restore log"
          fi
          echo "DATA_RESTORED=$RESTORE_DONE" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤4ï¼šå®‰è£… CasaOSï¼ˆæœªæ¢å¤æ•°æ®æ—¶ï¼‰ ==========
      - name: Step 4 - Install or Skip CasaOS
        run: |
          set -e
          echo "===== Step 4: Install or Skip CasaOS ====="
          CASAOS_DATA_PATH="$CORE_BACKUP_DIR/casaos"
          if [ -d "$CASAOS_DATA_PATH" ] && [ "$DATA_RESTORED" = "true" ]; then
            echo "âœ… CasaOS data restored from $CASAOS_DATA_PATH, skip installation"
          else
            if ! curl -fsSL https://get.casaos.io >/dev/null; then
              echo "âŒ Cannot reach CasaOS install server"
              exit 1
            fi
            curl -fsSL https://get.casaos.io | sudo bash || { 
              echo "âŒ CasaOS installation failed"
              cat /var/log/casaos-install.log || echo "No CasaOS install log"
              exit 1
            }
            echo "âœ… CasaOS installation completed"
          fi

      # ========== æ­¥éª¤5ï¼šå¯åŠ¨æœåŠ¡ ==========
      - name: Step 5 - Start Services
        run: |
          set -e
          echo "===== Step 5: Start Docker + CasaOS ====="
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker casaos
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Services started successfully"
              break
            fi
            echo "âš ï¸ Service startup attempt $i failed, retrying..."
            sudo systemctl restart docker casaos
          done

          if ! sudo systemctl is-active --quiet docker || ! sudo systemctl is-active --quiet casaos; then
            echo "âŒ Service startup failed after retries"
            echo "Docker status: $(sudo systemctl status docker --no-pager)"
            echo "CasaOS status: $(sudo systemctl status casaos --no-pager)"
            exit 1
          fi

      # ========== æ­¥éª¤6ï¼šéƒ¨ç½² Tailscale ==========
      - name: Step 6 - Deploy Tailscale
        run: |
          set -e
          echo "===== Step 6: Deploy Tailscale ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ TAILSCALE_AUTH_KEY not configured, skip networking"
            exit 0
          fi

          curl -fsSL https://tailscale.com/install.sh | sudo bash
          if ! command -v tailscale &> /dev/null; then
            echo "âŒ Tailscale installation failed"
            exit 1
          fi

          for i in $(seq 1 3); do
            sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-runner-${{ github.run_id }}"
            sleep 5
            TAILSCALE_IP=$(sudo tailscale ip -4)
            if [ -n "$TAILSCALE_IP" ]; then
              break
            fi
            echo "âš ï¸ Tailscale connection attempt $i failed"
          done

          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscale connection failed"
            echo "Tailscale log: $(sudo tailscale status)"
            exit 1
          fi
          echo "âœ… Tailscale IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤7ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: Step 7 - Print Access Info
        run: |
          set -e
          echo "===== Step 7: Access Information ====="
          PUBLIC_IP=$(curl -s --max-time 10 ifconfig.me || curl -s --max-time 10 icanhazip.com || echo "Unknown")
          echo "ðŸ”— Public IP: http://$PUBLIC_IP"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "ðŸ”’ Tailscale IP: http://${{ env.TAILSCALE_IP }}"
          fi
          echo "ðŸ‘¤ Debug User: roots (password from secrets or random generated)"
          echo "âš ï¸ Please change CasaOS default password immediately!"

      # ========== æ­¥éª¤8ï¼šä¿æ´» + å¤‡ä»½ /var/lib + ç»­è·‘ ==========
      - name: Step 8 - Keep Alive + Backup /var/lib + Renew
        shell: bash
        run: |
          set -e
          echo "===== Step 8: Keep Alive + Backup $CORE_BACKUP_DIR + Renew ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # è§¦å‘ç»­è·‘å‡½æ•°
          trigger_renew() {
            if [ -n "$USER_PAT" ] && [ -n "$REPO" ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "ðŸ”„ Triggering renew workflow..."
              RESPONSE=$(curl -fsS -X POST -H "Authorization: token $USER_PAT" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/dispatches" \
                -d '{"event_type":"renew_casaos_tailscale"}' 2>&1)
              if [ $? -eq 0 ]; then
                echo "âœ… Renew workflow triggered"
                RENEW_TRIGGERED=true
              else
                echo "âŒ Failed to trigger renew: $RESPONSE"
              fi
            fi
          }
          
          # æ ¸å¿ƒä¿®æ”¹ï¼šä»…å¤‡ä»½ /var/lib ç›®å½•
          backup_core_dir() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAV not available, skip backup"
              return 1
            fi
            
            target_path="$WEBDAV_MOUNT_POINT$CORE_BACKUP_DIR"
            mkdir -p "$target_path"
            # æž„å»ºæŽ’é™¤å‚æ•°
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=$excl")
            done
            
            echo "ðŸ”„ Backing up $CORE_BACKUP_DIR..."
            if sudo rsync -a --delete --copy-links --sparse --numeric-ids \
                "${EXCLUDE_PARAMS[@]}" "$CORE_BACKUP_DIR/" "$target_path/" \
                --log-file=/tmp/rsync_backup.log --log-file-format="%t %f %b"; then
              # å†™å…¥å¤‡ä»½å…ƒä¿¡æ¯
              BACKUP_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              RUNNER_ID="${{ github.run_id }}"
              GITHUB_REPO="${{ github.repository }}"
              WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              
              sudo printf '%s\n' \
                "backup_time=$BACKUP_TIME" \
                "runner_id=$RUNNER_ID" \
                "github_repo=$GITHUB_REPO" \
                "workflow_run_url=$WORKFLOW_URL" \
                "backup_target=$CORE_BACKUP_DIR" \
                > "$WEBDAV_MOUNT_POINT/backup_info.txt"
              
              echo "âœ… $CORE_BACKUP_DIR backup completed"
              return 0
            else
              echo "âŒ $CORE_BACKUP_DIR backup failed, log:"
              cat /tmp/rsync_backup.log || echo "No backup log"
              return 1
            fi
          }
          
          # ä¿æ´»ä¸»å¾ªçŽ¯ï¼ˆ10åˆ†é’Ÿè§¦å‘å¤‡ä»½+ç»­è·‘ï¼‰
          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "ðŸ“Š Running for $run_mins/$MAX_RUN_MINUTES minutes"
            
            # è¿è¡Œ10åˆ†é’Ÿè§¦å‘å¤‡ä»½+ç»­è·‘
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Running for 10 minutes, starting $CORE_BACKUP_DIR backup and renew..."
              if backup_core_dir; then
                trigger_renew
              fi
            fi
            
            # è¾¾åˆ°æ—¶é—´é™åˆ¶é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Reached $MAX_RUN_MINUTES minutes limit, exiting"
              exit 0
            fi
            
            sleep 60
          done

      # ========== æ­¥éª¤9ï¼šæ¸…ç†çŽ¯å¢ƒ ==========
      - name: Step 9 - Cleanup Environment
        if: ${{ always() }}
        run: |
          set -e
          echo "===== Step 9: Cleanup ====="
          # å¸è½½WebDAV
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null
          fi
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* /var/tmp/* /home/runner/.rclone.conf 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/runner 2>/dev/null || true
          echo "âœ… Cleanup completed"
