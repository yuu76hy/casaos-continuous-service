name: 1Panel-Server-Backup-Restore
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_1panel_snapshot]

jobs:
  1panel_snapshot_operation:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu/1panel-backup"
      CORE_DIRS: "/etc/1panel /var/lib/1panel /usr/local/1panel /etc/systemd/system/1panel.service /usr/bin/1panel"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/1panel/logs/*
        --exclude=/var/lib/1panel/tmp/*
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.swp
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ github.repository }}
      WEBDAV_AVAILABLE: true
      SNAPSHOT_RESTORED: true

    steps:
      - name: Initialize System Environment
        run: |
          set -e
          echo "=================================================="
          echo "            ğŸš€ ç¯å¢ƒåˆå§‹åŒ–å¼€å§‹"
          echo "=================================================="
          echo "ğŸ“Œ å½“å‰ç³»ç»Ÿä¿¡æ¯ï¼š"
          cat /etc/os-release | grep -E "NAME|VERSION"
          echo "ğŸ“Œ å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          echo "ğŸ“Œ å½“å‰ç”¨æˆ·ï¼š$(whoami)"
          
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl
          echo "âœ… ä¾èµ–å·¥å…·å®‰è£…å®Œæˆï¼šcurl wget jq fuse3 tar gzip locales openssl"
          
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "âœ… è¯­è¨€ç¯å¢ƒé…ç½®å®Œæˆï¼šzh_CN.UTF-8"
          
          curl https://rclone.org/install.sh | sudo bash
          echo "âœ… Rclone å®‰è£…å®Œæˆï¼Œç‰ˆæœ¬ï¼š$(rclone version | head -n1)"
          
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          echo "âœ… Sudo å…å¯†æƒé™é…ç½®å®Œæˆ"
          
          echo "=================================================="
          echo "            ğŸ‰ ç¯å¢ƒåˆå§‹åŒ–ç»“æŸ"
          echo "=================================================="

      - name: Configure Rclone for WebDAV Storage
        run: |
          set -e
          echo "=================================================="
          echo "            ğŸš€ WebDAV é…ç½®å¼€å§‹"
          echo "=================================================="
          echo "ğŸ“Œ é…ç½®å‚æ•°æ£€æŸ¥ï¼š"
          echo "   - WEBDAV_URL: ${WEBDAV_URL:0:20}****"
          echo "   - WEBDAV_USER: ${WEBDAV_USER}"
          echo "   - å¤‡ä»½ç›®å½•: ${WEBDAV_SNAPSHOT_EN_DIR}"

          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ é”™è¯¯ï¼šWebDAV å¯†é’¥æœªé…ç½®å®Œæ•´"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          echo "âœ… Rclone é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼š/home/runner/.rclone.conf"

          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯ï¼šWebDAV è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥å’Œåœ°å€"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "âœ… WebDAV è¿æ¥æµ‹è¯•æˆåŠŸ"

          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          echo "âœ… è¿œç¨‹å¤‡ä»½ç›®å½•åˆ›å»ºæˆåŠŸï¼š${WEBDAV_SNAPSHOT_EN_DIR}"

          echo "ğŸ“Œ æŸ¥æ‰¾è¿œç¨‹æœ€æ–°å¿«ç…§ï¼š"
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "1panel-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "   - æ‰¾åˆ°æœ€æ–°å¿«ç…§ï¼š${LATEST_SNAPSHOT_FILENAME}"
            echo "   - å¿«ç…§å®Œæ•´è·¯å¾„ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "   - æœªæ‰¾åˆ°ä»»ä½•è¿œç¨‹å¿«ç…§ï¼Œæœ¬æ¬¡ä»…æ‰§è¡Œå¤‡ä»½"
          fi
          echo "=================================================="
          echo "            ğŸ‰ WebDAV é…ç½®ç»“æŸ"
          echo "=================================================="

      - name: Restore 1Panel from Snapshot (No Reinstall)
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "=================================================="
          echo "            ğŸš€ 1Panel å¿«ç…§æ¢å¤å¼€å§‹"
          echo "=================================================="
          echo "ğŸ“Œ æ¢å¤å‚æ•°ä¿¡æ¯ï¼š"
          echo "   - å¾…æ¢å¤å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
          echo "   - å¤‡ä»½ç›®å½•ï¼š${CORE_DIRS}"
          echo "   - æ’é™¤è§„åˆ™ï¼š${EXCLUDE_RULES}"

          echo "ğŸ“Œ åœæ­¢ 1Panel æœåŠ¡ï¼š"
          if sudo systemctl stop 1panel; then
            echo "   - 1Panel æœåŠ¡å·²åœæ­¢"
          else
            echo "   - 1Panel æœåŠ¡æœªè¿è¡Œï¼Œè·³è¿‡åœæ­¢"
          fi
          sudo systemctl mask 1panel || true
          sync && sleep 3
          echo "âœ… æœåŠ¡é”å®šå®Œæˆï¼Œé˜²æ­¢æ¢å¤è¿‡ç¨‹ä¸­å¯åŠ¨"

          echo "ğŸ“Œ éªŒè¯å¿«ç…§å®Œæ•´æ€§ï¼š"
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯ï¼šå¿«ç…§æ–‡ä»¶æŸåæˆ–æ— æ³•è¯»å–"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask 1panel
            exit 1
          fi
          echo "âœ… å¿«ç…§å®Œæ•´æ€§æ ¡éªŒé€šè¿‡"

          echo "ğŸ“Œ å¼€å§‹æ¢å¤å¿«ç…§åˆ°ç³»ç»Ÿæ ¹ç›®å½•ï¼š"
          echo "   - è§£å‹å‘½ä»¤ï¼šrclone cat | tar -xzf - -C / --overwrite"
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions --absolute-names $EXCLUDE_RULES

          if [ $? -eq 0 ]; then
            echo "âœ… 1Panel å¿«ç…§æ¢å¤æˆåŠŸï¼ˆæ— éœ€é‡æ–°å®‰è£…ï¼‰"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            
            echo "ğŸ“Œ åˆ é™¤å·²æ¢å¤çš„æ—§å¿«ç…§ï¼š"
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            echo "   - å·²åˆ é™¤å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
          else
            echo "âŒ é”™è¯¯ï¼šå¿«ç…§æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask 1panel
            exit 1
          fi
          sudo systemctl unmask 1panel
          echo "=================================================="
          echo "            ğŸ‰ 1Panel å¿«ç…§æ¢å¤ç»“æŸ"
          echo "=================================================="

      - name: Restart 1Panel Service (From Snapshot)
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          echo "=================================================="
          echo "            ğŸš€ 1Panel æœåŠ¡é‡å¯å¼€å§‹"
          echo "=================================================="
          echo "ğŸ“Œ é‡æ–°åŠ è½½ systemd é…ç½®ï¼š"
          sudo systemctl daemon-reload
          echo "âœ… systemd é…ç½®é‡è½½å®Œæˆ"

          echo "ğŸ“Œ è®¾ç½®å¼€æœºè‡ªå¯å¹¶å¯åŠ¨æœåŠ¡ï¼š"
          sudo systemctl enable --now 1panel
          sleep 10
          echo "âœ… æœåŠ¡å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"

          echo "ğŸ“Œ éªŒè¯æœåŠ¡è¿è¡ŒçŠ¶æ€ï¼š"
          if sudo systemctl is-active --quiet 1panel; then
            echo "   - æœåŠ¡çŠ¶æ€ï¼šè¿è¡Œä¸­ âœ…"
            echo "   - æœåŠ¡è¯¦ç»†çŠ¶æ€ï¼š"
            sudo systemctl status 1panel --no-pager | grep -E "Active|Loaded"
          else
            echo "âŒ é”™è¯¯ï¼š1Panel æœåŠ¡å¯åŠ¨å¤±è´¥"
            echo "ğŸ“œ æœåŠ¡é”™è¯¯æ—¥å¿—ï¼š"
            sudo systemctl status 1panel --no-pager
            exit 1
          fi

          echo "ğŸ“Œ éªŒè¯ 1Panel æ ¸å¿ƒåŠŸèƒ½ï¼š"
          if sudo 1panel status >/dev/null 2>&1; then
            echo "   - æ ¸å¿ƒåŠŸèƒ½ï¼šæ­£å¸¸ âœ…"
            # ä¿®æ­£ï¼šå…¼å®¹ä¸åŒç‰ˆæœ¬ 1Panelï¼Œæ”¹ç”¨ status æå–ç‰ˆæœ¬
            echo "   - ç‰ˆæœ¬ä¿¡æ¯ï¼š$(sudo 1panel status | grep -i version | head -n1)"
          else
            echo "âš ï¸ è­¦å‘Šï¼šæœåŠ¡è¿è¡Œä½†æ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸"
          fi
          echo "=================================================="
          echo "            ğŸ‰ 1Panel æœåŠ¡é‡å¯ç»“æŸ"
          echo "=================================================="

      - name: Create Full 1Panel Snapshot and Upload
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        shell: bash
        run: |
          set -e
          echo "=================================================="
          echo "            ğŸš€ 1Panel å…¨é‡å¤‡ä»½å¼€å§‹"
          echo "=================================================="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âš ï¸ è­¦å‘Šï¼šUSER_PAT æˆ– REPO æœªé…ç½®ï¼Œè·³è¿‡ç»­è·‘è§¦å‘"
              return 1
            fi
            echo "ğŸ“Œ è§¦å‘ç»­è·‘å·¥ä½œæµï¼š"
            # ä¿®æ­£ï¼šUSER_PAT è„±æ•è¾“å‡º
            echo "   - USER_PAT: ${USER_PAT:0:5}****"
            echo "   - REPO: ${REPO}"
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_1panel_snapshot"}'; then
              echo "âŒ é”™è¯¯ï¼šç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥"
              return 1
            fi
            echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true
            return 0
          }

          create_1panel_snapshot() {
            echo "ğŸ“Œ éªŒè¯ 1Panel å…³é”®æ–‡ä»¶ï¼š"
            CRITICAL_FILES=(
              "/usr/bin/1panel"
              "/etc/systemd/system/1panel.service"
              "/var/lib/1panel"
            )
            for file in "${CRITICAL_FILES[@]}"; do
              if [ -e "$file" ]; then
                echo "   - $file: å­˜åœ¨ âœ…"
              else
                echo "âŒ é”™è¯¯ï¼šå…³é”®æ–‡ä»¶ç¼ºå¤± $file"
                exit 1
              fi
            done

            SNAPSHOT_NAME="1panel-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ“Œ å¤‡ä»½å‚æ•°ä¿¡æ¯ï¼š"
            echo "   - å¿«ç…§åç§°ï¼š${SNAPSHOT_NAME}"
            echo "   - æœ¬åœ°ä¸´æ—¶è·¯å¾„ï¼š${TMP_SNAPSHOT}"
            echo "   - è¿œç¨‹å­˜å‚¨è·¯å¾„ï¼š${REMOTE_PATH}"

            echo "ğŸ“Œ åœæ­¢ 1Panel æœåŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š"
            sudo systemctl stop 1panel || true
            sudo systemctl mask 1panel || true
            sync && sleep 5
            echo "âœ… æœåŠ¡å·²åœæ­¢å¹¶é”å®š"

            echo "ğŸ“Œ æ‰“åŒ… 1Panel æ ¸å¿ƒç›®å½•ï¼š"
            echo "   - æ‰“åŒ…å‘½ä»¤ï¼štar -czf ${TMP_SNAPSHOT} ${CORE_DIRS} ${EXCLUDE_RULES}"
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              $EXCLUDE_RULES \
              $CORE_DIRS
            sudo chown runner:runner "${TMP_SNAPSHOT}"
            sudo chmod 644 "${TMP_SNAPSHOT}"
            echo "âœ… æ‰“åŒ…å®Œæˆï¼Œå¿«ç…§å¤§å°ï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            echo "ğŸ“Œ éªŒè¯å¿«ç…§æœ‰æ•ˆæ€§ï¼š"
            if [ ! -f "${TMP_SNAPSHOT}" ] || [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 1024 ]; then
              echo "âŒ é”™è¯¯ï¼šå¿«ç…§æ–‡ä»¶ä¸ºç©ºæˆ–æ— æ•ˆ"
              sudo systemctl unmask 1panel
              sudo systemctl start 1panel || true
              return 1
            fi
            echo "âœ… å¿«ç…§æœ‰æ•ˆæ€§æ ¡éªŒé€šè¿‡"

            echo "ğŸ“Œ ä¸Šä¼ å¿«ç…§åˆ° WebDAVï¼š"
            echo "   - ä¸Šä¼ å‘½ä»¤ï¼šrclone copy ${TMP_SNAPSHOT} ${REMOTE_PATH}"
            if ! sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --log-level INFO; then
              echo "âŒ é”™è¯¯ï¼šå¿«ç…§ä¸Šä¼ å¤±è´¥"
              rm -f "${TMP_SNAPSHOT}"
              sudo systemctl unmask 1panel
              sudo systemctl start 1panel || true
              return 1
            fi
            echo "âœ… å¿«ç…§ä¸Šä¼ æˆåŠŸ"

            echo "ğŸ“Œ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¹¶é‡å¯æœåŠ¡ï¼š"
            rm -f "${TMP_SNAPSHOT}"
            sudo systemctl unmask 1panel
            sudo systemctl start 1panel || true
            echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆï¼ŒæœåŠ¡å·²é‡å¯"
            return 0
          }

          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Œ å·¥ä½œæµè¿è¡Œæ—¶é•¿ï¼š${run_mins} åˆ†é’Ÿ"

            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è¾¾åˆ°å¤‡ä»½è§¦å‘æ—¶é—´ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œå¼€å§‹åˆ›å»ºå¿«ç…§"
              if create_1panel_snapshot; then
                trigger_renew
              else
                echo "âŒ å¿«ç…§åˆ›å»ºå¤±è´¥ï¼Œæœ¬æ¬¡è·³è¿‡ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•"
                # ä¿®æ­£ï¼šå°† break æ”¹ä¸º continueï¼Œä¸ç»ˆæ­¢å¾ªç¯
                continue
              fi
            fi

            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼ˆ${MAX_RUN_MINUTES} åˆ†é’Ÿï¼‰ï¼Œé€€å‡ºå¤‡ä»½å¾ªç¯"
              break
            fi

            sleep 60
          done
          echo "=================================================="
          echo "            ğŸ‰ 1Panel å…¨é‡å¤‡ä»½ç»“æŸ"
          echo "=================================================="

      - name: Cleanup Workflow Files
        if: ${{ always() }}
        run: |
          set -e
          echo "=================================================="
          echo "            ğŸš€ å·¥ä½œæµæ¸…ç†å¼€å§‹"
          echo "=================================================="
          echo "ğŸ“Œ è§£é” 1Panel æœåŠ¡ï¼š"
          sudo systemctl unmask 1panel || true
          echo "âœ… æœåŠ¡è§£é”å®Œæˆ"

          echo "ğŸ“Œ æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼š"
          sudo rm -rf /tmp/1panel-server-snapshot-*.tar.gz
          echo "   - å·²æ¸…ç†ï¼š/tmp/1panel-server-snapshot-*.tar.gz"
          
          echo "ğŸ“Œ æ¸…ç† Rclone é…ç½®ï¼š"
          sudo rm -rf /home/runner/.rclone.conf
          echo "   - å·²æ¸…ç†ï¼š/home/runner/.rclone.conf"
          
          echo "ğŸ“Œ æ¸…ç† Sudo æƒé™æ–‡ä»¶ï¼š"
          sudo rm -rf /etc/sudoers.d/runner
          echo "   - å·²æ¸…ç†ï¼š/etc/sudoers.d/runner"
          
          echo "ğŸ“Œ æœ€ç»ˆæœåŠ¡çŠ¶æ€æ£€æŸ¥ï¼š"
          if sudo systemctl is-active --quiet 1panel; then
            echo "   - 1Panel æœåŠ¡ï¼šè¿è¡Œä¸­ âœ…"
          else
            echo "   - 1Panel æœåŠ¡ï¼šæœªè¿è¡Œ âš ï¸"
          fi
          echo "=================================================="
          echo "            ğŸ‰ å·¥ä½œæµæ¸…ç†ç»“æŸ"
          echo "=================================================="
