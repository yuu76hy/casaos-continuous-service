name: Full-Featured CasaOS-Tailscale-Backup (Auto-Renew + Precision Backup)
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      # Ê†∏ÂøÉÈÖçÁΩÆ
      MAX_RUN_MINUTES: 330
      RUNNER_PASSWORD: "runner123"
      CASAOS_PORT: 80
      KEEP_BACKUP_COUNT: 3
      CLEAN_INTERVAL: 3600
      HEALTH_CHECK_TIMEOUT: 300
      # ÁõÆÂΩïÈÖçÁΩÆ
      BACKUP_DIR: /home/runner/backup
      LOG_DIR: /home/runner/logs
      LOCAL_MOUNT_POINT: /mnt/webdav_casaos
      WEBDAV_REMOTE_DIR: /z/Ubu
      RCLONE_CACHE_DIR: /tmp/rclone_cache
      NEW_RUN_ID_FILE: /home/runner/new_run_id.txt
      # Â§á‰ªΩÊéíÈô§ËßÑÂàô
      BACKUP_EXCLUDE: >-
        --exclude=/proc
        --exclude=/sys
        --exclude=/tmp
        --exclude=/dev
        --exclude=/run
        --exclude=/var/run
        --exclude=/home/runner/actions-runner
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/logs
        --exclude=/var/lib/docker/build
        --exclude=/var/lib/docker/tmpfs
        --exclude=/var/lib/docker/overlay2/tmp
        --exclude=/var/lib/docker/*-tmp
      # ÂÖ∂‰ªñÈÖçÁΩÆ
      BACKUP_MARKER: latest_backup.txt
      LOG_FILE: casaos_service_${{ github.run_id }}_$(date +%Y%m%d_%H%M%S).log

    steps:
      - name: "Step 0: Pre-Check - Shell Env & Log Dir Init"
        id: pre_check
        continue-on-error: false
        run: |
          set -euo pipefail
          mkdir -p $LOG_DIR $RCLONE_CACHE_DIR
          chmod 755 $LOG_DIR $RCLONE_CACHE_DIR
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Pre-Check Completed ===="
          echo "===================================== WORKFLOW BASIC INFO ====================================="
          echo "üîß Workflow Run ID: ${{ github.run_id }}"
          echo "üîß WebDAV Remote Target: $WEBDAV_REMOTE_DIR"
          echo "üîß Local Mount Point: $LOCAL_MOUNT_POINT"
          echo "üîß Backup Retention: Keep Latest $KEEP_BACKUP_COUNT Backups"
          echo "üîß Max Runtime: $MAX_RUN_MINUTES Minutes | Renew Trigger: 30 Mins Remaining"
          echo "=============================================================================================="

      - name: "Step 1: System Env Initialization"
        id: sys_init
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 1 Start: System Initialization ===="
          echo "üìä Initial System Free Space: $(df -h / | awk 'NR==2{print $4}')"
          sudo apt update -y && sudo apt upgrade -y -qq
          REQUIRED_PACKAGES="tar gzip rsync rclone fuse3 netcat-openbsd psmisc curl git wget jq bc"
          sudo apt install -y $REQUIRED_PACKAGES
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          sudo mkdir -p $BACKUP_DIR $LOCAL_MOUNT_POINT /DATA
          sudo chown -R runner:runner $BACKUP_DIR $LOCAL_MOUNT_POINT /DATA
          sudo chmod -R 755 $BACKUP_DIR $LOCAL_MOUNT_POINT /DATA
          echo "‚úÖ Dependencies Installed: $REQUIRED_PACKAGES"
          echo "‚úÖ Core Directories Created: $BACKUP_DIR | $LOCAL_MOUNT_POINT | /DATA"
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 1 Completed ===="

      - name: "Step 2: WebDAV Mount (Remote Dir: /z/Ubu) With Retry"
        id: webdav_setup
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 2 Start: WebDAV Configuration ===="
          # ËØªÂèñSecretsÔºà‰∏•Ê†ºÂåπÈÖçWEBDAV_USERNAMEÔºâ
          WEBDAV_URL=${{ secrets.WEBDAV_URL }}
          WEBDAV_USER=${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASS=${{ secrets.WEBDAV_PASSWORD }}
          
          # ËÑ±ÊïèË∞ÉËØïÔºà‰ªÖÊòæÁ§∫Ââç2Â≠óÁ¨¶ÔºåÁ°ÆËÆ§ËØªÂèñÊàêÂäüÔºâ
          echo "üîç È™åËØÅSecretsËØªÂèñ - WEBDAV_URL: [${WEBDAV_URL:0:2}]***"
          echo "üîç È™åËØÅSecretsËØªÂèñ - WEBDAV_USER: [${WEBDAV_USER:0:2}]***"
          echo "üîç È™åËØÅSecretsËØªÂèñ - WEBDAV_PASS: [${WEBDAV_PASS:0:2}]***"
          
          # ÈùûÁ©∫Ê†°È™åÔºàËã±ÊñáÁ¨¶Âè∑ÔºåÊó†ËØ≠Ê≥ïÈîôËØØÔºâ
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASS" ]; then
            echo "ERROR: WebDAV Secrets Not Configured! Exit."
            exit 1
          fi

          # ÈÖçÁΩÆRcloneÔºàÁ∫ØËã±ÊñáÈÖçÁΩÆÔºåÊó†‰∏≠ÊñáÔºâ
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [webdav_remote]
          type = webdav
          url = $WEBDAV_URL
          vendor = generic
          user = $WEBDAV_USER
          pass = $WEBDAV_PASS
          timeout = 30s
          retries = 3
          EOF
          chmod 600 ~/.config/rclone/rclone.conf
          echo "üîó Rclone Configured (URL: ${WEBDAV_URL%%/*}, User: $WEBDAV_USER)"

          # WebDAVÊåÇËΩΩÔºà3Ê¨°ÈáçËØïÔºâ
          MOUNT_RETRY=0
          while [ $MOUNT_RETRY -lt 3 ]; do
            rclone mount webdav_remote:$WEBDAV_REMOTE_DIR $LOCAL_MOUNT_POINT \
              --daemon --allow-other --vfs-cache-mode writes --cache-dir $RCLONE_CACHE_DIR --timeout 1h --retries 2
            sleep 5
            if mount | grep -q $LOCAL_MOUNT_POINT; then
              echo "‚úÖ WebDAV Mount Success: WebDAV($WEBDAV_REMOTE_DIR) ‚Üí Local($LOCAL_MOUNT_POINT)"
              echo "üìä WebDAV Mount Point Free Space: $(df -h $LOCAL_MOUNT_POINT | awk 'NR==2{print $4}')"
              break
            fi
            MOUNT_RETRY=$((MOUNT_RETRY + 1))
            echo "‚ö†Ô∏è WebDAV Mount Retry $MOUNT_RETRY Failed"
            sudo fusermount -u $LOCAL_MOUNT_POINT 2>/dev/null || true
          done

          if [ $MOUNT_RETRY -eq 3 ]; then
            echo "ERROR: WebDAV Mount Failed After 3 Retries! Exit."
            exit 1
          fi

          mkdir -p $LOCAL_MOUNT_POINT/logs
          echo "WEBDAV_STATUS=success" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 2 Completed ===="

      - name: "Step 3: Backup Restore & Validation (CasaOS+Docker+/DATA)"
        id: backup_restore
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 3 Start: Backup Restore ===="
          BACKUP_MARKER_FILE="$LOCAL_MOUNT_POINT/$BACKUP_MARKER"
          HAS_BACKUP="false"
          if [ -f "$BACKUP_MARKER_FILE" ]; then
            LATEST_BACKUP=$(cat "$BACKUP_MARKER_FILE")
            echo "üîç Found Backup Marker: $BACKUP_MARKER_FILE"
            echo "üîç Latest Backup File: $LATEST_BACKUP | Size: $(du -h $LOCAL_MOUNT_POINT/$LATEST_BACKUP 2>/dev/null | awk '{print $1}')"
            echo "$BACKUP_EXCLUDE" | tr ' ' '\n' > $BACKUP_DIR/exclude-list.txt
            sudo systemctl stop docker containerd 2>/dev/null || true
            sleep 3
            echo "üìå Start Restore From WebDAV: $LOCAL_MOUNT_POINT/$LATEST_BACKUP"
            if sudo tar -zxf "$LOCAL_MOUNT_POINT/$LATEST_BACKUP" -C / --exclude-from=$BACKUP_DIR/exclude-list.txt; then
              if [ -d "/etc/casaos" ] && [ -d "/var/lib/docker/containers" ] && [ -d "/DATA" ]; then
                echo "‚úÖ Restore Success - Critical Directories Exist: /etc/casaos | /var/lib/docker/containers | /DATA"
                HAS_BACKUP="true"
              else
                echo "WARNING: Restore Validation Failed - Critical Directories Missing"
              fi
            else
              echo "WARNING: Restore Command Failed - Use Fresh Env"
            fi
            sudo systemctl start docker containerd 2>/dev/null || true
            echo "‚úÖ Docker Service Restarted After Restore"
          else
            echo "‚ÑπÔ∏è No Backup Marker Found - Use Fresh Environment"
          fi
          echo "HAS_BACKUP=$HAS_BACKUP" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 3 Completed ===="

      - name: "Step 4: CasaOS Installation & Startup"
        id: casaos_install
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 4 Start: CasaOS Install ===="
          curl -fsSL https://get.casaos.io | sudo bash -s -- --debug 2>&1 | grep -v "restart" || { echo "WARNING: CasaOS Install Has Warnings"; }
          sudo systemctl daemon-reload
          sudo systemctl enable --now casaos
          sleep 10
          if sudo systemctl is-active --quiet casaos; then
            echo "‚úÖ CasaOS Service Status: Running"
            echo "üîó CasaOS Core Paths: /etc/casaos (Config) | /var/lib/casaos (Data)"
          else
            echo "WARNING: CasaOS Service Status: Not Running - Check Logs Later"
          fi
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 4 Completed ===="

      - name: "Step 5: Tailscale Deployment (5 Retries)"
        id: tailscale_deploy
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 5 Start: Tailscale Deploy ===="
          if ! curl -fsSL https://tailscale.com/install.sh | sudo sh -s -- -q; then
            echo "‚ö†Ô∏è Script Install Failed - Fallback to APT"
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
            sudo apt update && sudo apt install -y tailscale
          fi
          sudo systemctl enable --now tailscaled
          sleep 5
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          if [ -z "$TS_AUTH_KEY" ]; then
            echo "ERROR: Tailscale Auth Key Not Configured! Exit."
            exit 1
          fi
          TS_RETRY=0
          TAILSCALE_IP=""
          while [ $TS_RETRY -lt 5 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-${{ github.run_id }} --accept-routes=false --accept-dns=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              if [ -n "$TAILSCALE_IP" ]; then
                echo "‚úÖ Tailscale Joined - Internal IP: $TAILSCALE_IP"
                echo "‚úÖ Tailscale Hostname: casaos-${{ github.run_id }}"
                break
              fi
            fi
            TS_RETRY=$((TS_RETRY + 1))
            echo "‚ö†Ô∏è Tailscale Retry $TS_RETRY Failed"
            sleep 5
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "ERROR: Tailscale Join Failed After 5 Retries! Exit."
            exit 1
          fi
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 5 Completed ===="

      - name: "Step 6: Output Service Access Info"
        id: output_info
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 6 Start: Access Info Output ===="
          echo "===================================== SERVICE ACCESS INFO ====================================="
          echo "‚úÖ Total Runtime: 360 Minutes (6 Hours)"
          echo "‚úÖ Renew Trigger: When Remaining Time = 30 Minutes"
          echo "‚úÖ System Free Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "‚úÖ Runner Password: $RUNNER_PASSWORD"
          echo "‚úÖ WebDAV Status: $WEBDAV_STATUS | Remote Dir: $WEBDAV_REMOTE_DIR"
          echo "‚úÖ CasaOS Panel: http://$TAILSCALE_IP:$CASAOS_PORT"
          echo "‚úÖ Data Source: $(if [ $HAS_BACKUP = 'true' ]; then echo "Restored From Backup"; else echo "Fresh Install"; fi)"
          echo "‚úÖ Backup Scope: CasaOS Core + Docker Core + /DATA | Exclude: Logs/Temp/Junk"
          echo "‚úÖ Log File: $LOG_DIR/$LOG_FILE | WebDAV Log Dir: $LOCAL_MOUNT_POINT/logs"
          echo "=============================================================================================="
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 6 Completed ===="

      - name: "Step 7: Core Keepalive + Hourly Clean + Full Stop Backup + Auto Renew"
        id: core_keepalive
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 7 Start: Core Keepalive Logic ===="
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}
          CURRENT_RUN_ID=${{ github.run_id }}

          # ÊØèÂ∞èÊó∂Ê∑±Â∫¶Ê∏ÖÁêÜ
          auto_clean() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [HOURLY CLEAN] Start Deep Cleanup"
            BEFORE=$(df -h / | awk 'NR==2{print $4}')
            BEFORE_SIZE=$(df -B1 / | awk 'NR==2{print $4}')
            sudo apt clean -y && sudo apt autoremove -y --purge -qq
            DOCKER_DANGLING=$(sudo docker images -f "dangling=true" -q | wc -l)
            sudo docker system prune -af --volumes 2>/dev/null || true
            sudo docker rmi $(sudo docker images -f "dangling=true" -q) 2>/dev/null || true
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null || true
            OLD_LOGS=$(find $LOG_DIR -name "*.log" ! -name "$LOG_FILE" | wc -l)
            find $LOG_DIR -name "*.log" ! -name "$LOG_FILE" -delete 2>/dev/null || true
            WEBDAV_OLD_LOGS=$(find $LOCAL_MOUNT_POINT/logs -name "*.log" -type f -mtime +7 | wc -l)
            find $LOCAL_MOUNT_POINT/logs -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true
            AFTER=$(df -h / | awk 'NR==2{print $4}')
            AFTER_SIZE=$(df -B1 / | awk 'NR==2{print $4}')
            FREED_SIZE=$(( (BEFORE_SIZE - AFTER_SIZE) / 1024 / 1024 ))
            echo "üìä Cleanup Result: $BEFORE ‚Üí $AFTER (Freed ~${FREED_SIZE}MB)"
            echo "üóëÔ∏è Cleaned: $DOCKER_DANGLING Dangling Images | $OLD_LOGS Local Logs | $WEBDAV_OLD_LOGS WebDAV Logs"
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [HOURLY CLEAN] Completed"
          }

          # ÂÖ®ËøõÁ®ãÂÅúÊ≠¢Â§á‰ªΩ
          do_backup() {
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}')
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [BACKUP] Triggered - Free Space: $FREE_SPACE"
            if (( $(echo "$FREE_SPACE < 5" | bc -l) )); then
              echo "‚ö†Ô∏è Free Space <5G - Run Emergency Cleanup First"
              auto_clean
            fi
            TS=$(date +%Y%m%d_%H%M%S)
            BK_NAME="casaos_${CURRENT_RUN_ID}_$TS.tar.gz"
            BK_PATH="$LOCAL_MOUNT_POINT/$BK_NAME"
            DOCKER_CONTAINERS=$(sudo docker ps -q | wc -l)
            sudo docker stop $(sudo docker ps -q) 2>/dev/null || true
            sudo systemctl stop docker containerd casaos tailscaled 2>/dev/null || true
            sleep 5
            echo "üõë Stopped $DOCKER_CONTAINERS Containers + All Services"
            echo "üì• Start Backup - Target: $BK_PATH"
            echo "üì• Backup Includes: /etc/casaos | /var/lib/casaos | /var/lib/docker/{image,containers,volumes,networks} | /DATA"
            sudo tar -z -cf $BK_PATH $BACKUP_EXCLUDE \
              /etc/casaos \
              /var/lib/casaos \
              /var/lib/docker/image \
              /var/lib/docker/containers \
              /var/lib/docker/volumes \
              /var/lib/docker/networks \
              /DATA \
              --warning=no-file-changed
            if [ -f "$BK_PATH" ] && [ $(stat -c%s "$BK_PATH") -gt 1024 ]; then
              BK_SIZE=$(du -h $BK_PATH | awk '{print $1}')
              echo "‚úÖ Backup Valid - Name: $BK_NAME | Size: $BK_SIZE"
              echo "‚úÖ Stored in WebDAV: $WEBDAV_REMOTE_DIR/$BK_NAME"
              echo "$BK_NAME" > "$LOCAL_MOUNT_POINT/$BACKUP_MARKER"
              cp $LOG_DIR/$LOG_FILE "$LOCAL_MOUNT_POINT/logs/"
              echo "‚úÖ Backup Marker Updated: $LOCAL_MOUNT_POINT/$BACKUP_MARKER"
              BACKUP_FILES=$(ls -t $LOCAL_MOUNT_POINT/casaos_*.tar.gz 2>/dev/null | grep -v "tmp")
              BACKUP_COUNT=$(echo "$BACKUP_FILES" | wc -l)
              if [ $BACKUP_COUNT -gt $KEEP_BACKUP_COUNT ]; then
                FILES_TO_DELETE=$(echo "$BACKUP_FILES" | tail -n +$((KEEP_BACKUP_COUNT + 1)))
                DELETE_COUNT=$(echo "$FILES_TO_DELETE" | wc -l)
                for FILE in $FILES_TO_DELETE; do
                  sudo rm -f "$FILE" || true
                done
                echo "üóëÔ∏è Cleaned $DELETE_COUNT Old Backups | Retained $KEEP_BACKUP_COUNT Latest"
              else
                echo "‚ÑπÔ∏è Backup Count ($BACKUP_COUNT) ‚â§ Retention - No Cleanup"
              fi
            else
              echo "‚ùå Backup Invalid - Delete Corrupted File"
              sudo rm -f "$BK_PATH" 2>/dev/null || true
            fi
            echo "üîÑ Restart Services (Dependency Order)"
            sudo systemctl start docker containerd 2>/dev/null || true
            sleep 3
            sudo systemctl start casaos tailscaled 2>/dev/null || true
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} 2>/dev/null || true
            echo "‚úÖ All Services Restarted"
            backup_done=true
          }

          # Ëß¶ÂèëÁª≠Ë∑ë
          trigger_renew() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [RENEW] Trigger New Workflow"
            if [ -z "$GITHUB_PAT" ] || [ -z "$REPO" ]; then
              echo "‚ùå Failed - PAT/Repo Not Configured"
              return 1
            fi
            RESPONSE=$(curl -s -X POST https://api.github.com/repos/$REPO/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_PAT" \
              -d '{"event_type":"renew_vnc"}' \
              -w "%{http_code}" -o /dev/null --connect-timeout 30s)
            if [ "$RESPONSE" -eq 204 ]; then
              echo "‚úÖ Trigger Success - HTTP Code: $RESPONSE"
              return 0
            else
              echo "‚ùå Trigger Failed - HTTP Code: $RESPONSE"
              return 1
            fi
          }

          # Ê£ÄÊü•Êñ∞ÂÆπÂô®ÂÅ•Â∫∑
          check_new_container() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [HEALTH CHECK] Check New Container - Timeout: $HEALTH_CHECK_TIMEOUTs"
            start_check=$(date +%s)
            while [ $(( $(date +%s) - start_check )) -lt $HEALTH_CHECK_TIMEOUT ]; do
              RUNS=$(curl -s -H "Authorization: Bearer $GITHUB_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&event=repository_dispatch" \
                | jq -r '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID') | .id')
              if [ -n "$RUNS" ]; then
                NEW_RUN_ID=$(echo "$RUNS" | head -n 1)
                echo "‚úÖ New Container Found - Run ID: $NEW_RUN_ID"
                echo $NEW_RUN_ID > $NEW_RUN_ID_FILE
                sleep 120
                echo "‚úÖ New Container Healthy"
                return 0
              fi
              echo "‚è≥ New Container Not Ready - Wait 10s"
              sleep 10
            done
            echo "‚ùå Timeout - No Valid New Container"
            return 1
          }

          # Ê†∏ÂøÉ‰øùÊ¥ªÂæ™ÁéØ
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] [KEEPALIVE] Monitoring Loop Started - Interval: 60s"
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            remaining_mins=$((MAX_RUN_MINUTES - run_mins))
            free_space=$(df -h / | awk 'NR==2{print $4}')
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [KEEPALIVE] Status - Running: $run_mins Mins | Remaining: $remaining_mins Mins | Free Space: $free_space"
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi
            if (( $(echo "$free_space < 1" | bc -l) )); then
              echo "‚ö†Ô∏è Emergency Cleanup Triggered - Free Space <1G"
              auto_clean
              last_clean=$now
            fi
            if [ $remaining_mins -eq 30 ] && [ "$backup_done" = false ]; then
              do_backup
              if trigger_renew; then
                if check_new_container; then
                  echo "‚úÖ New Container Ready - Old Container Exit Safely"
                  sudo systemctl stop casaos tailscaled docker containerd
                  sudo tailscale down
                  exit 0
                else
                  echo "‚ö†Ô∏è New Container Unhealthy - Old Container Continue"
                fi
              else
                echo "‚ö†Ô∏è Renew Trigger Failed - Old Container Continue"
              fi
            fi
            # ÊúçÂä°‰øùÊ¥ªÁõëÊéß
            if ! sudo systemctl is-active --quiet casaos; then
              echo "‚ö†Ô∏è CasaOS Down - Restarting"
              sudo systemctl restart casaos
            fi
            if ! sudo systemctl is-active --quiet tailscaled; then
              echo "‚ö†Ô∏è Tailscale Down - Restarting"
              sudo systemctl restart tailscaled
            fi
            if ! sudo systemctl is-active --quiet docker; then
              echo "‚ö†Ô∏è Docker Down - Restarting"
              sudo systemctl restart docker containerd
            fi
            sleep 60
          done

      - name: "Step 8: Post-Service Cleanup & WebDAV Unmount"
        id: post_cleanup
        if: always()
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 8 Start: Post Cleanup ===="
          echo "üõë Stop All Services"
          sudo systemctl stop casaos tailscaled docker containerd 2>/dev/null || true
          sudo tailscale down 2>/dev/null || true
          echo "‚úÖ Services Stopped"
          echo "üì§ Sync Final Log to WebDAV"
          cp $LOG_DIR/$LOG_FILE "$LOCAL_MOUNT_POINT/logs/final_$LOG_FILE" 2>/dev/null || echo "‚ö†Ô∏è Log Sync Failed"
          if mount | grep -q $LOCAL_MOUNT_POINT; then
            echo "üîì Unmount WebDAV: $LOCAL_MOUNT_POINT"
            sudo fusermount -u $LOCAL_MOUNT_POINT 2>/dev/null || sudo umount -l $LOCAL_MOUNT_POINT 2>/dev/null || true
            echo "‚úÖ WebDAV Unmounted"
          fi
          echo "üóëÔ∏è Clean Local Temp Directories"
          sudo rm -rf $BACKUP_DIR $RCLONE_CACHE_DIR /tmp/* 2>/dev/null || true
          echo "‚úÖ Cleaned: $BACKUP_DIR | $RCLONE_CACHE_DIR | /tmp"
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 8 Completed ===="
          echo "===================================== WORKFLOW EXECUTION COMPLETED ==================================="
