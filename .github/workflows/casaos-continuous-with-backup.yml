name: CasaOS ç²¾ç®€å¤‡ä»½ï¼ˆæ— Dockeré•œåƒÂ·ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-backup:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      # æ ¸å¿ƒSecretsï¼ˆå¿…é¡»åœ¨ä»“åº“Settingsä¸­é…ç½®ï¼‰
      WEBDAV_URL:          ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER:         ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD:     ${{ secrets.WEBDAV_PASSWORD }}
      TAILSCALE_AUTH_KEY:  ${{ secrets.TAILSCALE_AUTH_KEY }}
      ROOTS_PASSWORD:      ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT:            ${{ secrets.USER_PAT }}
      REPO:                ${{ secrets.REPO }}

      # å›ºå®šé…ç½®ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œå·²ä¼˜åŒ–ï¼‰
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS:  "/var/lib/docker/containers /var/lib/docker/volumes /var/lib/docker/overlay2 /etc/casaos /var/lib/casaos /DATA /root/.config"
      KEEP_BACKUPS:        2
      TARGET_RUN_MINUTES:  1
      RCLONE_CONFIG:       "/etc/rclone.conf"
      PARALLEL_CORE:       4
      ZSTD_LEVEL:          19
      RCLONE_TRANSFERS:    1
      RCLONE_BUFFER:       "512M"
      WEBDAV_CHUNK_SIZE:   "64M"
      MAX_REDIRECT:        20
      TIMEOUT:             "60m"
      CONTIMEOUT:          "10m"
      WEBDAV_EXTRA_FLAGS:  "--no-check-certificate --disable-http2"
      CASAOS_PORT:         80

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–é”å®šï¼ˆåŸºç¡€ç¯å¢ƒï¼‰
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 1-ç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–é”å®šï¼ˆåŸºç¡€ç¯å¢ƒï¼‰ =====\033[0m"
          sudo apt update -y -qq || (echo -e "\033[1;31mâŒ aptæ›´æ–°å¤±è´¥\033[0m" && exit 1)
          sudo apt install -y -qq curl wget jq tar gzip lsof ca-certificates gnupg pigz zstd psmisc procps language-pack-zh-hans openssl net-tools iputils-ping || (echo -e "\033[1;31mâŒ ä¾èµ–å®‰è£…å¤±è´¥\033[0m" && exit 1)
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… åŸºç¡€ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ\033[0m"

      - name: 2-é”å®šrcloneç‰ˆæœ¬ï¼ˆ1.60.0ç¨³å®šç‰ˆï¼‰
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 2-é”å®šrcloneç‰ˆæœ¬ï¼ˆ1.60.0ç¨³å®šç‰ˆï¼‰ =====\033[0m"
          curl -fSL -o rclone.zip https://downloads.rclone.org/v1.60.0/rclone-v1.60.0-linux-amd64.zip || (echo -e "\033[1;31mâŒ rcloneä¸‹è½½å¤±è´¥\033[0m" && exit 1)
          unzip -q rclone.zip
          sudo cp rclone-v1.60.0-linux-amd64/rclone /usr/bin/
          sudo chmod +x /usr/bin/rclone
          rm -rf rclone.zip rclone-v1.60.0-linux-amd64
          RCLONE_VER=$(rclone version | head -1 | awk '{print $2}')
          if [ "$RCLONE_VER" != "v1.60.0" ]; then
            echo -e "\033[1;31mâŒ rcloneç‰ˆæœ¬é”™è¯¯ï¼ˆéœ€v1.60.0ï¼Œå½“å‰$RCLONE_VERï¼‰\033[0m" && exit 1
          fi
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… rclone 1.60.0å®‰è£…å®Œæˆ\033[0m"

      - name: 3-æ¸…ç†ç³»ç»Ÿæ®‹ç•™ï¼ˆé¿å…å†²çªï¼‰
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 3-æ¸…ç†ç³»ç»Ÿæ®‹ç•™ï¼ˆé¿å…å†²çªï¼‰ =====\033[0m"
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sudo systemctl disable casaos docker containerd 2>/dev/null || true
          [ -f /etc/systemd/system/casaos.service ] && sudo rm -f /etc/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… ç³»ç»Ÿæ®‹ç•™æ¸…ç†å®Œæˆ\033[0m"

      - name: 4-å®‰è£…Tailscaleå®¢æˆ·ç«¯
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 4-å®‰è£…Tailscaleå®¢æˆ·ç«¯ =====\033[0m"
          curl -fsSL https://tailscale.com/install.sh | sh || (echo -e "\033[1;31mâŒ Tailscaleå®‰è£…å¤±è´¥\033[0m" && exit 1)
          sleep 3
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… Tailscaleå®¢æˆ·ç«¯å®‰è£…å®Œæˆ\033[0m"

      - name: 5-Tailscaleå®‰å…¨ç»„ç½‘+IPæ ¡éªŒ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 5-Tailscaleå®‰å…¨ç»„ç½‘+IPæ ¡éªŒ =====\033[0m"
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then echo -e "\033[1;31mâŒ TAILSCALE_AUTH_KEYä¸ºç©º\033[0m" && exit 1; fi
          sudo tailscale up --auth-key="$TAILSCALE_AUTH_KEY" --login-server="https://controlplane.tailscale.com" --accept-routes --accept-dns || (echo -e "\033[1;31mâŒ Tailscaleç»„ç½‘å¤±è´¥\033[0m" && exit 1)
          sleep 8
          # ä¿®å¤ï¼šæ£€æŸ¥TailscaleæœåŠ¡çŠ¶æ€è€Œépingè‡ªèº«IP
          if ! tailscale status >/dev/null 2>&1; then
            echo -e "\033[1;31mâŒ TailscaleæœåŠ¡æœªæ­£å¸¸è¿è¡Œ\033[0m" && exit 1
          fi
          TAILSCALE_IP=$(tailscale ip -4 2>/dev/null)
          if [ -z "$TAILSCALE_IP" ]; then echo -e "\033[1;31mâŒ Tailscaleæœªè·å–IP\033[0m" && exit 1; fi
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… Tailscaleç»„ç½‘æˆåŠŸï¼ŒIPï¼š$TAILSCALE_IP\033[0m"

      - name: 6-å®‰è£…Dockerï¼ˆé˜¿é‡Œäº‘é•œåƒåŠ é€Ÿï¼‰
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 6-å®‰è£…Dockerï¼ˆé˜¿é‡Œäº‘é•œåƒåŠ é€Ÿï¼‰ =====\033[0m"
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun || (echo -e "\033[1;31mâŒ Dockerå®‰è£…å¤±è´¥\033[0m" && exit 1)
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… Dockerå®‰è£…å®Œæˆ\033[0m"

      - name: 7-DockeræœåŠ¡å¯åŠ¨+æƒé™é…ç½®
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 7-DockeræœåŠ¡å¯åŠ¨+æƒé™é…ç½® =====\033[0m"
          sudo systemctl enable --now docker containerd || (echo -e "\033[1;31mâŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥\033[0m" && exit 1)
          sleep 8
          if ! docker --version; then echo -e "\033[1;31mâŒ Dockeræœªå®‰è£…æˆåŠŸ\033[0m" && exit 1; fi
          sudo usermod -aG docker runner
          newgrp docker || true
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… Dockerå®‰è£…å®Œæˆï¼š$(docker --version)\033[0m"

      - name: 8-å®‰è£…CasaOSç¨³å®šç‰ˆ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 8-å®‰è£…CasaOSç¨³å®šç‰ˆ =====\033[0m"
          curl -fsSL https://get.casaos.io | sudo bash || (echo -e "\033[1;31mâŒ CasaOSå®‰è£…å¤±è´¥\033[0m" && exit 1)
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… CasaOSå®‰è£…å®Œæˆ\033[0m"

      - name: 9-CasaOSè‡ªå¯ç¦ç”¨+å®‰è£…æ ¡éªŒ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 9-CasaOSè‡ªå¯ç¦ç”¨+å®‰è£…æ ¡éªŒ =====\033[0m"
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos || (echo -e "\033[1;31mâŒ CasaOSç¦ç”¨è‡ªå¯å¤±è´¥\033[0m" && exit 1)
          if ! command -v casaos &>/dev/null; then echo -e "\033[1;31mâŒ CasaOSæœªå®‰è£…æˆåŠŸ\033[0m" && exit 1; fi
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… CasaOSå®‰è£…å®Œæˆï¼ˆå·²ç¦ç”¨è‡ªå¯ï¼‰\033[0m"

      - name: 10-rootsç”¨æˆ·åˆ›å»º+åŸºç¡€é…ç½®
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 10-rootsç”¨æˆ·åˆ›å»º+åŸºç¡€é…ç½® =====\033[0m"
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME" || (echo -e "\033[1;31mâŒ rootsç”¨æˆ·åˆ›å»ºå¤±è´¥\033[0m" && exit 1)
          if [ -n "$ROOTS_PASSWORD" ]; then
            printf "%s:%s\n" "$USER_NAME" "$ROOTS_PASSWORD" | sudo chpasswd || (echo -e "\033[1;31mâŒ rootså¯†ç è®¾ç½®å¤±è´¥\033[0m" && exit 1)
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            printf "%s:%s\n" "$USER_NAME" "$RANDOM_PASS" | sudo chpasswd
            echo "::add-mask::$RANDOM_PASS"
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ”‘ rootséšæœºå¯†ç å·²ç”Ÿæˆå¹¶æ·»åŠ æ©ç \033[0m"
          fi
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… rootsç”¨æˆ·åŸºç¡€é…ç½®å®Œæˆ\033[0m"

      - name: 11-rootsç”¨æˆ·æƒé™å¼ºåŒ–ï¼ˆå…å¯†sudo+Dockerï¼‰
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 11-rootsç”¨æˆ·æƒé™å¼ºåŒ–ï¼ˆå…å¯†sudo+Dockerï¼‰ =====\033[0m"
          USER_NAME="roots"
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… rootsç®¡ç†å‘˜é…ç½®å®Œæˆ\033[0m"

      - name: 12-WebDAVæ ¸å¿ƒå‚æ•°æ ¡éªŒ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 12-WebDAVæ ¸å¿ƒå‚æ•°æ ¡éªŒ =====\033[0m"
          if [ -z "$WEBDAV_URL" ]; then echo -e "\033[1;31mâŒ WEBDAV_URLä¸ºç©º\033[0m" && exit 1; fi
          if [ -z "$WEBDAV_USER" ]; then echo -e "\033[1;31mâŒ WEBDAV_USERä¸ºç©º\033[0m" && exit 1; fi
          if [ -z "$WEBDAV_PASSWORD" ]; then echo -e "\033[1;31mâŒ WEBDAV_PASSWORDä¸ºç©º\033[0m" && exit 1; fi
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… WebDAVæ ¸å¿ƒå‚æ•°æ ¡éªŒé€šè¿‡\033[0m"

      - name: 13-rcloneé…ç½®+å¯†ç åŠ å¯†
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 13-rcloneé…ç½®+å¯†ç åŠ å¯† =====\033[0m"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          if [ -z "$ENCRYPTED_PASS" ]; then echo -e "\033[1;31mâŒ å¯†ç åŠ å¯†å¤±è´¥\033[0m" && exit 1; fi
          sudo rclone config create mywebdav webdav \
            url "$WEBDAV_URL" \
            user "$WEBDAV_USER" \
            pass "$ENCRYPTED_PASS" \
            vendor "onedrive" \
            chunk_size "$WEBDAV_CHUNK_SIZE" \
            --config "$RCLONE_CONFIG" || (echo -e "\033[1;31mâŒ rcloneé…ç½®å¤±è´¥\033[0m" && exit 1)
          sudo chmod 600 "$RCLONE_CONFIG"
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… rcloneé…ç½®å®Œæˆ\033[0m"

      - name: 14-WebDAVè¿é€šæ€§æµ‹è¯•+å†å²å¤‡ä»½æ£€æµ‹
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 14-WebDAVè¿é€šæ€§æµ‹è¯•+å†å²å¤‡ä»½æ£€æµ‹ =====\033[0m"
          sudo rclone mkdir mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" 2>/dev/null || true
          TEST_FILE="test-webdav-$(date +%s).txt"
          echo "test" > /tmp/$TEST_FILE
          sudo rclone copy /tmp/$TEST_FILE mywebdav:"$WEBDAV_SNAPSHOT_DIR/" --config "$RCLONE_CONFIG" $WEBDAV_EXTRA_FLAGS || (echo -e "\033[1;31mâŒ WebDAVè¿æ¥å¤±è´¥\033[0m" && exit 1)
          sudo rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$TEST_FILE" --config "$RCLONE_CONFIG"
          rm -f /tmp/$TEST_FILE
          LATEST_SNAPSHOT=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" | grep "casaos-full-snapshot.*\.tar\.zst$" | sed 's/^[0-9]\+ //' | sort -r | head -1 | tr -d '\n')
          echo "HAS_SNAPSHOT=$(if [ -n "$LATEST_SNAPSHOT" ]; then echo "true"; else echo "false"; fi)" >> "$GITHUB_ENV"
          echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… WebDAVé…ç½®å®Œæˆ\033[0m"

      - name: 15-æ¢å¤å†å²å¤‡ä»½ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
        if: ${{ env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 15-æ¢å¤å†å²å¤‡ä»½ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰ =====\033[0m"
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -f "docker|containerd|casaos" 2>/dev/null || true
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          sync && sleep 3
          echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ”½ ä¸‹è½½å¤‡ä»½ï¼š$LATEST_SNAPSHOT\033[0m"
          sudo rclone copy mywebdav:"$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" /tmp/ --config "$RCLONE_CONFIG" $WEBDAV_EXTRA_FLAGS --progress || (echo -e "\033[1;31mâŒ å¤‡ä»½ä¸‹è½½å¤±è´¥\033[0m" && exit 1)
          # ä¿®å¤ï¼šç§»é™¤-På‚æ•°ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„æ¢å¤æ›´å®‰å…¨
          zstd -d -c /tmp/$LATEST_SNAPSHOT | sudo tar -x --preserve-permissions --preserve-acls --selinux -f - -C / --overwrite --ignore-failed-read $PERSONAL_DATA_DIRS || (echo -e "\033[1;31mâŒ å¤‡ä»½è§£å‹å¤±è´¥\033[0m" && exit 1)
          sudo rm -f /tmp/$LATEST_SNAPSHOT
          [ -d /var/lib/docker ] && sudo chown -R root:docker /var/lib/docker || true
          [ -d /etc/casaos ] && sudo chown -R root:root /etc/casaos /var/lib/casaos || true
          [ -d /DATA ] && sudo chown -R roots:roots /DATA /root/.config || true
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… å¤‡ä»½æ¢å¤å®Œæˆ\033[0m"

      - name: 16-Dockerå¯åŠ¨+é•œåƒæ‹‰å–
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 16-Dockerå¯åŠ¨+é•œåƒæ‹‰å– =====\033[0m"
          sudo systemctl restart docker containerd || (echo -e "\033[1;31mâŒ Dockeré‡å¯å¤±è´¥\033[0m" && exit 1)
          sleep 18
          # ä¼˜åŒ–ï¼šå¢åŠ é•œåƒæœ‰æ•ˆæ€§æ ¡éªŒ
          IMAGES=$(docker ps -a --format "{{.Image}}" | grep -v "^$" | grep -v "^none$" | sort | uniq)
          if [ -n "$IMAGES" ]; then
            for IMG in $IMAGES; do
              for i in {1..3}; do
                if docker pull --timeout 300s "$IMG"; then break; fi
                if [ $i -eq 3 ]; then echo -e "\033[1;31mâŒ é•œåƒ$IMGæ‹‰å–å¤±è´¥\033[0m" && exit 1; fi
                sleep 15
              done
            done
          else
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  æ— Dockeré•œåƒéœ€è¦æ‹‰å–\033[0m"
          fi
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… Dockeré•œåƒæ‹‰å–å®Œæˆ\033[0m"

      - name: 17-å®¹å™¨æ¢å¤+å¥åº·æ£€æŸ¥
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 17-å®¹å™¨æ¢å¤+å¥åº·æ£€æŸ¥ =====\033[0m"
          CONTAINER_IDS=$(docker ps -a -q | grep -v "^$")
          if [ -n "$CONTAINER_IDS" ]; then
            docker start $CONTAINER_IDS || (echo -e "\033[1;31mâŒ å®¹å™¨å¯åŠ¨å¤±è´¥\033[0m" && exit 1)
            sleep 45
          else
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  æ— Dockerå®¹å™¨éœ€è¦å¯åŠ¨\033[0m"
          fi
          RUNNING_COUNT=$(docker ps | wc -l)
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… Dockerå°±ç»ªï¼Œè¿è¡Œå®¹å™¨æ•°ï¼š$RUNNING_COUNT\033[0m"

      - name: 18-CasaOSå¯åŠ¨+å¥åº·æ£€æŸ¥
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 18-CasaOSå¯åŠ¨+å¥åº·æ£€æŸ¥ =====\033[0m"
          sudo systemctl enable --now casaos || (echo -e "\033[1;31mâŒ CasaOSå¯åŠ¨å¤±è´¥\033[0m" && exit 1)
          sleep 20
          for i in {1..3}; do
            if systemctl is-active --quiet casaos && curl -s --connect-timeout 10 http://localhost:$CASAOS_PORT >/dev/null; then
              echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… CasaOSå¯åŠ¨æˆåŠŸï¼ˆç«¯å£$CASAOS_PORTæ­£å¸¸ï¼‰\033[0m"
              exit 0
            fi
            echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  ç¬¬$iæ¬¡é‡è¯•å¯åŠ¨CasaOS..."
            sleep 12
          done
          echo -e "\033[1;31mâŒ CasaOSå¯åŠ¨å¤±è´¥æˆ–ç«¯å£æœªé€š\033[0m" && exit 1

      - name: 19-ç³»ç»Ÿç¨³å®šå»¶æ—¶ï¼ˆ$TARGET_RUN_MINUTESåˆ†é’Ÿï¼‰
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 19-ç³»ç»Ÿç¨³å®šå»¶æ—¶$TARGET_RUN_MINUTESåˆ†é’Ÿ =====\033[0m"
          if [ "$TARGET_RUN_MINUTES" -gt 0 ]; then
            sleep $((TARGET_RUN_MINUTES * 60))
          else
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  å»¶æ—¶æ—¶é—´ä¸º0ï¼Œè·³è¿‡ä¼‘çœ \033[0m"
          fi
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… ç³»ç»Ÿç¨³å®šè¿è¡Œå®Œæˆ\033[0m"

      - name: 20-å®Œæ•´å¤‡ä»½æµç¨‹ï¼ˆæ‰“åŒ…+ä¸Šä¼ +æ¸…ç†+è§¦å‘ç»­è·‘ï¼‰
        run: |
          set -euo pipefail
          echo -e "\033[1;34m[$(date '+%Y-%m-%d %H:%M:%S')] ===== 20-å®Œæ•´å¤‡ä»½æµç¨‹ï¼ˆæ‰“åŒ…+ä¸Šä¼ +æ¸…ç†+è§¦å‘ç»­è·‘ï¼‰ =====\033[0m"
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -f "docker|containerd|casaos" 2>/dev/null || true
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          sync && sleep 3
          for DIR in $PERSONAL_DATA_DIRS; do
            [ -d "$DIR" ] || sudo mkdir -p "$DIR" && echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  åˆ›å»ºç¼ºå¤±ç›®å½•ï¼š$DIR\033[0m"
          done
          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ—œï¸  ç”Ÿæˆå¤‡ä»½ï¼š$SNAPSHOT_NAME\033[0m"
          # ä¿®å¤ï¼šç§»é™¤-På‚æ•°ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„æ‰“åŒ…æ›´å®‰å…¨
          sudo tar -c --warning=no-file-changed --ignore-failed-read --exclude="*/tmp/*" --exclude="*/cache/*" $PERSONAL_DATA_DIRS | zstd -$ZSTD_LEVEL -T$PARALLEL_CORE > /tmp/$SNAPSHOT_NAME || (echo -e "\033[1;31mâŒ å¤‡ä»½æ‰“åŒ…å¤±è´¥\033[0m" && exit 1)
          # ä¼˜åŒ–ï¼šä½¿ç”¨zstdéªŒè¯å‹ç¼©åŒ…å®Œæ•´æ€§
          if [ ! -f "/tmp/$SNAPSHOT_NAME" ] || [ $(stat -c %s "/tmp/$SNAPSHOT_NAME") -lt 1024 ] || ! zstd -t "/tmp/$SNAPSHOT_NAME"; then
            echo -e "\033[1;31mâŒ å¤‡ä»½æ–‡ä»¶æ— æ•ˆï¼ˆç©º/æŸå/å®Œæ•´æ€§æ ¡éªŒå¤±è´¥ï¼‰\033[0m" && exit 1
          fi
          echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] â¬†ï¸  ä¸Šä¼ å¤‡ä»½ï¼š$SNAPSHOT_NAME\033[0m"
          sudo rclone copy /tmp/$SNAPSHOT_NAME mywebdav:"$WEBDAV_SNAPSHOT_DIR/" \
            --config "$RCLONE_CONFIG" \
            --transfers $RCLONE_TRANSFERS \
            --buffer-size $RCLONE_BUFFER \
            --max-redirect $MAX_REDIRECT \
            --timeout $TIMEOUT \
            --contimeout $CONTIMEOUT \
            $WEBDAV_EXTRA_FLAGS \
            --retries 10 \
            --retries-sleep 60s \
            --stats 30s \
            --progress || (echo -e "\033[1;31mâŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥\033[0m" && exit 1)
          if ! sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR/$SNAPSHOT_NAME" --config "$RCLONE_CONFIG" >/dev/null; then
            echo -e "\033[1;31mâŒ å¤‡ä»½ä¸Šä¼ æœªéªŒè¯æˆåŠŸ\033[0m" && exit 1
          fi
          [ -f "/tmp/$SNAPSHOT_NAME" ] && sudo rm -f /tmp/$SNAPSHOT_NAME || true
          echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ—‘ï¸  æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™$KEEP_BACKUPSä¸ªï¼‰\033[0m"
          OLD_SNAPSHOTS=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" \
            | grep "casaos-full-snapshot.*\.tar\.zst$" \
            | sed 's/^[0-9]\+ //' \
            | sort -r \
            | tail -n +$((KEEP_BACKUPS + 1)))
          if [ -n "$OLD_SNAPSHOTS" ]; then
            for snap in $OLD_SNAPSHOTS; do
              sudo rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$snap" --config "$RCLONE_CONFIG" || echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  æ¸…ç†$snapå¤±è´¥"
            done
          else
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… æ— éœ€æ¸…ç†ï¼ˆå¤‡ä»½æ•°â‰¤$KEEP_BACKUPSï¼‰\033[0m"
          fi
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ”„  è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½ï¼ˆç»­è·‘ï¼‰\033[0m"
            RESPONSE=$(curl -s -w "%{http_code}" -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}')
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            if [ "$HTTP_CODE" -eq 204 ]; then
              echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] âœ… ä¸‹ä¸€è½®å¤‡ä»½å·²è§¦å‘ï¼ˆç»­è·‘æˆåŠŸï¼‰\033[0m"
            else
              echo -e "\033[1;31mâŒ ç»­è·‘è§¦å‘å¤±è´¥ï¼ŒHTTPç ï¼š$HTTP_CODE\033[0m" && exit 1
            fi
          else
            echo -e "\033[1;33m[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸  æœªé…ç½®PAT/REPOï¼Œè·³è¿‡ç»­è·‘\033[0m"
          fi
          # å®‰å…¨æ¸…ç†
          sudo tailscale down 2>/dev/null || true
          sudo systemctl stop tailscaled 2>/dev/null || true
          [ -f "$RCLONE_CONFIG" ] && sudo shred -u "$RCLONE_CONFIG" 2>/dev/null || true  # å®‰å…¨åˆ é™¤é…ç½®æ–‡ä»¶
          [ -f /etc/sudoers.d/roots ] && sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo rm -rf /tmp/casaos-full-snapshot-* 2>/dev/null || true
          echo -e "\033[1;32m[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ‰ å…¨æµç¨‹å®Œæˆï¼ˆèŠ‚ç‚¹IPï¼š${{ env.TAILSCALE_IP }}ï¼‰\033[0m"