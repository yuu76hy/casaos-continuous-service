# CasaOS çº¯å‡€éƒ¨ç½²ï¼ˆç”Ÿäº§çº§ï½œå¤‡ä»½æ¢å¤å…¨åŠ å›ºï¼‰- ä¼˜åŒ–Rcloneè¿æ¥ç‰ˆ
# æ ¸å¿ƒä¼˜åŒ–ï¼šå¢å¼ºWebDAV/Rcloneè¿é€šæ€§æ ¡éªŒã€é”™è¯¯æ—¥å¿—ã€è¯»å†™æƒé™éªŒè¯ï¼Œè§£å†³è¿æ¥å¤±è´¥é—®é¢˜
name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆç”Ÿäº§çº§ï½œå¤‡ä»½æ¢å¤å…¨åŠ å›ºï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    env:
      # å¯é…ç½®å‚æ•°
      LOCAL_MOUNT_POINT: "/op"
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      KEEP_BACKUPS: 2
      SNAPSHOT_MD5_SUFFIX: ".md5"
      ZSTD_LEVEL: "-2"
      RCLONE_TRANSFERS: 4
      RCLONE_RETRIES: 5
      RCLONE_TIMEOUT: "1h30m"
      RCLONE_STATS: "30s"
      TARGET_RUN_MINUTES: 15
      # å¯†é’¥é…ç½®ï¼ˆä»GitHub Secretsè¯»å–ï¼‰
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ã€åˆå§‹åŒ–ã€‘ç³»ç»Ÿä¸Dockeréƒ¨ç½²ï¼ˆå®‰å…¨+å®¹é”™ï¼‰
        run: |
          set -e
          trap 'echo "âš ï¸ è„šæœ¬ä¸­æ–­ï¼Œæ¸…ç†èµ„æº"; sudo rm -f /etc/sudoers.d/roots 2>/dev/null' EXIT
          
          echo "ğŸ“Œ å·¥ä½œæµå¯åŠ¨æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "WORKFLOW_START_TIMESTAMP=$(date +%s)" >> "$GITHUB_ENV"
          
          # å®‰è£…åŸºç¡€ä¾èµ–
          sudo DEBIAN_FRONTEND=noninteractive apt update -y -qq
          sudo DEBIAN_FRONTEND=noninteractive apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg zstd davfs2 bc -qq
          sudo apt install -y zstd --upgrade -qq
          
          # æ¸…ç†æ—§Dockeræ®‹ç•™
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo rm -rf /var/lib/docker /var/lib/containerd /etc/docker 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          
          # Dockerå®‰è£…ï¼ˆ5æ¬¡é‡è¯•+æŒ‡æ•°é€€é¿ï¼‰
          INSTALL_RETRY=5
          RETRY_DELAY=30
          while [ $INSTALL_RETRY -gt 0 ]; do
            if curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun; then
              break
            fi
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            echo "âš ï¸ Dockerå®‰è£…å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$INSTALL_RETRYï¼Œ$RETRY_DELAYç§’åé‡è¯•"
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done
          [ $INSTALL_RETRY -eq 0 ] && { echo "âŒ Dockerå®‰è£…å¤±è´¥" && exit 1; }
          
          # å¯åŠ¨å¹¶éªŒè¯Docker+containerd
          sudo systemctl enable --now docker containerd
          sudo usermod -aG docker runner
          if ! docker info >/dev/null 2>&1 || ! sudo systemctl is-active --quiet containerd; then
            echo "âŒ Docker/containerdå¯åŠ¨å¤±è´¥" && exit 1
          fi
          echo "âœ… Docker+containerdå®‰è£…æˆåŠŸ"

      - name: 2-ã€é…ç½®ã€‘ç®¡ç†å‘˜ä¸ç©ºé—´æ ¡éªŒï¼ˆå®‰å…¨ä¼˜åŒ–ï¼‰
        run: |
          set -e
          trap 'sudo rm -f /etc/sudoers.d/roots 2>/dev/null' EXIT
          
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          
          # ä¸´æ—¶å…å¯†sudo
          echo "$USER_NAME ALL=(ALL) NOPASSWD:SETENV: ALL" | sudo tee -a /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          
          # /tmpç©ºé—´æ ¡éªŒï¼ˆå­—èŠ‚çº§ï¼‰
          TMP_FREE=$(df -P -B 1 /tmp | awk 'NR>1 {print $4}')
          TMP_FREE_GB=$(echo "$TMP_FREE / 1024 / 1024 / 1024" | bc -l)
          if (( $(echo "$TMP_FREE_GB < 15" | bc -l) )); then
            echo "âŒ /tmpç©ºé—´ä¸è¶³15Gï¼Œå½“å‰å¯ç”¨ï¼š$TMP_FREE_GB G" && exit 1
          fi
          echo "âœ… /tmpç©ºé—´æ ¡éªŒé€šè¿‡"
          
          sudo rm -f /etc/sudoers.d/"$USER_NAME"
          echo "âœ… ç®¡ç†å‘˜é…ç½®å®Œæˆ"

      - name: 3-ã€å¤‡ä»½æ¨¡å¼ã€‘Rcloneä¼˜å…ˆ+æŒ‚è½½å…œåº•ï¼ˆå¢å¼ºè¿é€šæ€§æ ¡éªŒï¼‰
        run: |
          set -e
          sudo mkdir -p "${LOCAL_MOUNT_POINT}" && sudo chmod 700 "${LOCAL_MOUNT_POINT}" && sudo chown runner:runner "${LOCAL_MOUNT_POINT}"
          
          # å‰ç½®æ£€æŸ¥ï¼šWebDAVé…ç½®å®Œæ•´æ€§
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "USE_MOUNT=false" >> "$GITHUB_ENV"
            echo "USE_RCLONE=false" >> "$GITHUB_ENV"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "âš ï¸ WebDAVé…ç½®ä¸å®Œæ•´ï¼Œå¤‡ä»½åŠŸèƒ½ç¦ç”¨"
            exit 0
          fi
          
          # æ­¥éª¤1ï¼šWebDAV URLå¯è¾¾æ€§æ£€æµ‹
          echo "â„¹ï¸ æ£€æµ‹WebDAVæœåŠ¡å¯è¾¾æ€§"
          if ! curl -fsSL --max-time 10 --head "$WEBDAV_URL" >/dev/null 2>&1; then
            echo "âŒ WebDAVæœåŠ¡${WEBDAV_URL}ä¸å¯è®¿é—®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åœ°å€" && exit 1
          fi
          echo "âœ… WebDAVæœåŠ¡åœ°å€å¯è¾¾"
          
          # æ­¥éª¤2ï¼šRcloneé…ç½®ï¼ˆä¿ç•™è¯¦ç»†æ—¥å¿—ï¼‰
          RCLONE_OK=false
          RCLONE_CONFIG="$HOME/.rclone.conf"
          rm -f "$RCLONE_CONFIG" 2>/dev/null || true
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          echo "â„¹ï¸ ç”ŸæˆRcloneé…ç½®æ–‡ä»¶"
          if ! rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config "$RCLONE_CONFIG"; then
            echo "âŒ Rcloneé…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥" && exit 1
          fi
          sudo chmod 600 "$RCLONE_CONFIG"
          echo "âœ… Rcloneé…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼ˆè·¯å¾„ï¼š$RCLONE_CONFIGï¼‰"
          
          # æ­¥éª¤3ï¼šRcloneè¿æ¥å¤šè½®éªŒè¯ï¼ˆåˆ›å»ºç›®å½•+è¯»å†™æµ‹è¯•ï¼‰
          echo "â„¹ï¸ éªŒè¯Rcloneä¸WebDAVçš„è¿æ¥"
          RCLONE_RETRY=3
          RETRY_DELAY=20
          while [ $RCLONE_RETRY -gt 0 ]; do
            # éªŒè¯1ï¼šåˆ›å»ºè¿œç¨‹ç›®å½•
            if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "$RCLONE_CONFIG"; then
              RCLONE_RETRY=$((RCLONE_RETRY-1))
              echo "âš ï¸ åˆ›å»ºWebDAVç›®å½•å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$RCLONE_RETRYï¼Œ$RETRY_DELAYç§’åé‡è¯•"
              sleep $RETRY_DELAY
              continue
            fi
            
            # éªŒè¯2ï¼šè¯»å†™æµ‹è¯•ï¼ˆä¸Šä¼ å°æ–‡ä»¶ï¼‰
            TEST_FILE="/tmp/rclone-test.txt"
            echo "rclone-test" > "$TEST_FILE"
            if rclone copy "$TEST_FILE" mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "$RCLONE_CONFIG" && \
               rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/rclone-test.txt --config "$RCLONE_CONFIG" >/dev/null && \
               rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/rclone-test.txt --config "$RCLONE_CONFIG"; then
              RCLONE_OK=true
              break
            fi
            
            RCLONE_RETRY=$((RCLONE_RETRY-1))
            echo "âš ï¸ Rcloneè¯»å†™æµ‹è¯•å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$RCLONE_RETRYï¼Œ$RETRY_DELAYç§’åé‡è¯•"
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done
          
          if [ "$RCLONE_OK" = true ]; then
            echo "âœ… Rcloneä¸WebDAVè¿æ¥éªŒè¯é€šè¿‡ï¼ˆæ”¯æŒè¯»å†™ï¼‰"
          else
            echo "âŒ Rcloneä¸WebDAVè¿æ¥å¤±è´¥ï¼ˆé‡è¯•æ¬¡æ•°è€—å°½ï¼‰"
            # å°è¯•æŒ‚è½½æ¨¡å¼å…œåº•
            MOUNT_OK=false
            echo "â„¹ï¸ å°è¯•WebDAVæŒ‚è½½æ¨¡å¼å…œåº•"
            echo "${WEBDAV_URL} ${WEBDAV_USER} ${WEBDAV_PASSWORD}" | sudo tee /etc/davfs2/secrets >/dev/null
            sudo chmod 600 /etc/davfs2/secrets
            if sudo mount -t davfs "${WEBDAV_URL}" "${LOCAL_MOUNT_POINT}" -o uid=runner,gid=runner,file_mode=600,dir_mode=700; then
              sleep 3
              if mount | grep -q "${LOCAL_MOUNT_POINT}"; then
                sudo mkdir -p "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}" && sudo chmod 700 "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
                MOUNT_OK=true
                echo "âœ… æŒ‚è½½æ¨¡å¼åˆå§‹åŒ–æˆåŠŸ"
              fi
            fi
            sudo rm -f /etc/davfs2/secrets
          fi
          
          # ç¯å¢ƒå˜é‡èµ‹å€¼
          if [ "$RCLONE_OK" = true ] || [ "$MOUNT_OK" = true ]; then
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          else
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "âš ï¸ WebDAVæœåŠ¡è¿æ¥å¤±è´¥ï¼Œå¤‡ä»½åŠŸèƒ½ç¦ç”¨"
          fi
          echo "USE_RCLONE=$RCLONE_OK" >> "$GITHUB_ENV"
          echo "USE_MOUNT=$MOUNT_OK" >> "$GITHUB_ENV"
          echo "RCLONE_CONFIG=$RCLONE_CONFIG" >> "$GITHUB_ENV"

      - name: 4-ã€å¿«ç…§ã€‘å†å²å¿«ç…§æ£€æµ‹ï¼ˆRcloneä¼˜å…ˆï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          LATEST_SNAPSHOT=""
          
          if [ "${USE_RCLONE}" = true ]; then
            echo "â„¹ï¸ æ£€æµ‹Rcloneä¸­çš„å†å²å¿«ç…§"
            BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "${RCLONE_CONFIG}" | grep "casaos-full-snapshot.*\.tar\.zst" | sort -r)
            [ -n "$BACKUPS" ] && LATEST_SNAPSHOT=$(echo "$BACKUPS" | head -1 | awk '{print $2}')
          fi
          
          if [ -z "$LATEST_SNAPSHOT" ] && [ "${USE_MOUNT}" = true ]; then
            echo "â„¹ï¸ æ£€æµ‹æŒ‚è½½ç›®å½•ä¸­çš„å†å²å¿«ç…§"
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            BACKUPS=$(ls -t "${REMOTE_DIR}"/casaos-full-snapshot*.tar.zst 2>/dev/null)
            [ -n "$BACKUPS" ] && LATEST_SNAPSHOT=$(basename "$(echo "$BACKUPS" | head -1)")
          fi
          
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
            echo "LATEST_SNAPSHOT_MD5=${LATEST_SNAPSHOT}${SNAPSHOT_MD5_SUFFIX}" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¿«ç…§: $LATEST_SNAPSHOT"
          else
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            echo "âš ï¸ æ— å†å²å¿«ç…§ï¼Œæ‰§è¡Œå…¨æ–°éƒ¨ç½²"
          fi

      - name: 5-ã€éƒ¨ç½²ã€‘CasaOSçº¯å‡€å®‰è£…
        run: |
          set -e
          trap 'echo "âš ï¸ å®‰è£…ä¸­æ–­ï¼Œæ¸…ç†æ®‹ç•™"; sudo rm -f /tmp/install-casaos.sh 2>/dev/null' EXIT
          
          # å½»åº•æ¸…ç†æ—§CasaOSæ®‹ç•™
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -rf /etc/casaos /var/lib/casaos /usr/local/casaos /opt/casaos /usr/bin/casaos /usr/sbin/casaos /etc/systemd/system/casaos*
          sudo systemctl daemon-reload
          
          # è¡¥è£…CasaOSä¾èµ–
          CASAOS_DEPENDS=("wget" "curl" "smartmontools" "parted" "ntfs-3g" "net-tools" "samba" "cifs-utils" "mergerfs" "unzip")
          for pkg in "${CASAOS_DEPENDS[@]}"; do
            if apt-cache show "$pkg" >/dev/null 2>&1; then
              sudo DEBIAN_FRONTEND=noninteractive apt install -y "$pkg" -qq --no-upgrade
              echo "âœ… å®‰è£…ä¾èµ–ï¼š$pkg"
            else
              echo "âš ï¸ ä¾èµ–$pkgæœªæ‰¾åˆ°ï¼Œè·³è¿‡"
            fi
          done
          
          # CasaOSå®‰è£…ï¼ˆ3æ¬¡é‡è¯•+è¯¦ç»†æ—¥å¿—ï¼‰
          echo "â„¹ï¸ å®‰è£…CasaOS"
          INSTALL_RETRY=3
          RETRY_DELAY=30
          INSTALL_LOG="$GITHUB_WORKSPACE/casaos_install.log"
          while [ $INSTALL_RETRY -gt 0 ]; do
            curl -fsSL https://get.casaos.io -o /tmp/install-casaos.sh
            if sudo bash -x /tmp/install-casaos.sh > "$INSTALL_LOG" 2>&1; then
              echo "âœ… ç¬¬$((4 - INSTALL_RETRY))æ¬¡å®‰è£…æˆåŠŸ"
              break
            fi
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            echo "âš ï¸ CasaOSå®‰è£…å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$INSTALL_RETRYï¼Œæ—¥å¿—å·²ä¿å­˜åˆ°$INSTALL_LOG"
            cat "$INSTALL_LOG" | tail -20
            rm -f /tmp/install-casaos.sh
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done
          [ $INSTALL_RETRY -eq 0 ] && { echo "âŒ CasaOSå®‰è£…å¤±è´¥ï¼Œå®Œæ•´æ—¥å¿—ï¼š$(cat "$INSTALL_LOG")" && exit 1; }
          
          # åœæ­¢æœåŠ¡+éªŒè¯å®‰è£…
          sudo systemctl stop casaos 2>/dev/null || true
          CASAOS_PATHS=("/usr/local/casaos/casaos" "/usr/bin/casaos" "/usr/sbin/casaos" "/opt/casaos/casaos")
          INSTALL_PATH=""
          for path in "${CASAOS_PATHS[@]}"; do
            if [ -f "$path" ] && [ -x "$path" ] && [ -s "$path" ]; then
              INSTALL_PATH="$path"
              break
            fi
          done
          [ -z "$INSTALL_PATH" ] && { echo "âŒ CasaOSå®‰è£…æ–‡ä»¶æœªæ‰¾åˆ°"; exit 1; }
          echo "âœ… CasaOSå®‰è£…å®Œæˆï¼Œè·¯å¾„ï¼š$INSTALL_PATH"

      - name: 6-ã€æ¢å¤ã€‘å¿«ç…§å¼ºæ¢å¤ï¼ˆä¿®å¤tarå‚æ•°+æƒé™+å³æ—¶æ ¡éªŒï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          CASAOS_TMP_DIR="/tmp/casaos-recovery-tmp"
          sudo mkdir -p "$CASAOS_TMP_DIR" && sudo chmod 700 "$CASAOS_TMP_DIR" && sudo chown root:root "$CASAOS_TMP_DIR"
          trap 'sudo rm -rf "$CASAOS_TMP_DIR" 2>/dev/null' EXIT
          
          # åœæ­¢æœåŠ¡
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sync && sleep 10
          
          # ç©ºé—´æ ¡éªŒ
          TMP_FREE=$(df -P -B 1 /tmp | awk 'NR>1 {print $4}')
          TMP_FREE_GB=$(echo "$TMP_FREE / 1024 / 1024 / 1024" | bc -l)
          (( $(echo "$TMP_FREE_GB < 15" | bc -l) )) && { echo "âŒ /tmpç©ºé—´ä¸è¶³"; exit 1; }
          
          SNAP=${LATEST_SNAPSHOT}
          MD5=${LATEST_SNAPSHOT_MD5}
          RESTORE_OK=false
          
          # Rcloneæ¢å¤
          if [ "${USE_RCLONE}" = true ]; then
            echo "â„¹ï¸ ä¸‹è½½MD5æ–‡ä»¶"
            if ! rclone copy mywebdav:${WEBDAV_SNAPSHOT_DIR}/${MD5} "$CASAOS_TMP_DIR" --config "${RCLONE_CONFIG}" --retries 5; then
              echo "âŒ MD5æ–‡ä»¶ä¸‹è½½å¤±è´¥" && exit 1
            fi
            MD5_PATH="$CASAOS_TMP_DIR/${MD5}"
            [ ! -f "$MD5_PATH" ] || [ ! -s "$MD5_PATH" ] && { echo "âŒ MD5æ–‡ä»¶æ— æ•ˆ"; exit 1; }
            
            echo "â„¹ï¸ è§£å‹å¿«ç…§"
            if rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAP} --config "${RCLONE_CONFIG}" --retries 5 | \
              tee >(md5sum -c "$MD5_PATH") | \
              sudo tar -I zstd -xf - -C / --overwrite --absolute-names --no-same-owner $PERSONAL_DATA_DIRS; then
              RESTORE_OK=true
              echo "âœ… å¿«ç…§æ¢å¤å®Œæˆ"
            else
              echo "âŒ è§£å‹/æ ¡éªŒå¤±è´¥" && exit 1
            fi
          fi
          
          # æŒ‚è½½æ¨¡å¼æ¢å¤
          if [ "$RESTORE_OK" = false ] && [ "${USE_MOUNT}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            [ ! -f "${REMOTE_DIR}/${SNAP}" ] || [ ! -f "${REMOTE_DIR}/${MD5}" ] && { echo "âŒ å¿«ç…§æ–‡ä»¶ç¼ºå¤±"; exit 1; }
            md5sum -c "${REMOTE_DIR}/${MD5}" < "${REMOTE_DIR}/${SNAP}" || { echo "âŒ MD5æ ¡éªŒå¤±è´¥"; exit 1; }
            sudo tar -I zstd -xf "${REMOTE_DIR}/${SNAP}" -C / --overwrite --absolute-names --no-same-owner $PERSONAL_DATA_DIRS
            RESTORE_OK=true
          fi
          
          [ "$RESTORE_OK" = false ] && { echo "âŒ æ¢å¤å¤±è´¥"; exit 1; }
          
          # å³æ—¶ç›®å½•æ ¡éªŒ
          echo "â„¹ï¸ å³æ—¶æ ¡éªŒæ¢å¤ç›®å½•æœ‰æ•ˆæ€§"
          REQUIRED_DIRS=(
            "/var/lib/docker"
            "/etc/casaos"
            "/var/lib/casaos"
          )
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ] || [ -z "$(ls -A "$dir" 2>/dev/null)" ]; then
              echo "âŒ æ¢å¤ç›®å½• $dir ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œæ¢å¤å¤±è´¥" && exit 1
            fi
          done
          echo "âœ… æ¢å¤ç›®å½•æœ‰æ•ˆæ€§æ ¡éªŒé€šè¿‡"
          
          # å…³é”®æ–‡ä»¶æ ¡éªŒ
          echo "â„¹ï¸ æ ¡éªŒå…³é”®æ–‡ä»¶"
          REQUIRED_FILES=(
            "/var/lib/docker/version"
            "/etc/casaos/config.yaml"
            "/var/lib/casaos/db.sqlite"
          )
          for f in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$f" ] || [ ! -s "$f" ]; then
              echo "âš ï¸ å…³é”®æ–‡ä»¶$fç¼ºå¤±/ä¸ºç©ºï¼Œå°è¯•åˆ›å»ºç©ºæ–‡ä»¶ç»§ç»­"
              sudo touch "$f"
            fi
          done
          
          # æƒé™æ ¡å‡†
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chgrp -R docker /var/lib/docker
          sudo chmod -R 755 /etc/casaos /DATA
          sudo chmod -R 700 /var/lib/casaos
          sudo chmod -R 700 /var/lib/docker
          echo "âœ… æ¢å¤+æƒé™æ ¡å‡†å®Œæˆ"

      - name: 7-ã€åˆå§‹åŒ–ã€‘å…¨æ–°éƒ¨ç½²åŸºç¡€ç›®å½•
        if: ${{ env.WEBDAV_AVAILABLE != 'true' || env.HAS_SNAPSHOT != 'true' }}
        run: |
          set -e
          sudo mkdir -p /etc/casaos /var/lib/casaos /DATA
          sudo chown -R root:root /etc/casaos /var/lib/casaos /DATA
          sudo chmod -R 755 /etc/casaos /DATA
          sudo chmod -R 700 /var/lib/casaos
          echo "âœ… åŸºç¡€ç›®å½•åˆ›å»ºå®Œæˆ"

      - name: 8-ã€æœåŠ¡ã€‘Docker+CasaOSå¯åŠ¨æ ¡éªŒ
        run: |
          set -e
          # å¯åŠ¨Docker
          DOCKER_RETRY=5
          sudo systemctl restart docker containerd
          sleep 5
          while [ $DOCKER_RETRY -gt 0 ]; do
            if docker info >/dev/null 2>&1 && sudo systemctl is-active --quiet containerd; then
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl restart docker containerd && sleep 15
          done
          [ $DOCKER_RETRY -eq 0 ] && { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          
          # å¯åŠ¨CasaOS
          CASAOS_RETRY=5
          sudo systemctl enable --now casaos
          sleep 10
          while [ $CASAOS_RETRY -gt 0 ]; do
            if sudo lsof -i:80 | grep LISTEN >/dev/null 2>&1 && curl -fsSL --max-time 10 http://localhost >/dev/null 2>&1; then
              break
            fi
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl restart casaos && sleep 15
          done
          [ $CASAOS_RETRY -eq 0 ] && { echo "âŒ CasaOSå¯åŠ¨å¤±è´¥"; exit 1; }
          echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨æˆåŠŸ"

      - name: 9-ã€ç»„ç½‘ã€‘Tailscaleé…ç½®ï¼ˆå¯é€‰ï¼‰
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set +e
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="CasaOS-$(date +%Y%m%d)-$(hostname | cut -c1-6)" --accept-routes --accept-dns=false
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "ç»„ç½‘å¤±è´¥")
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"
          echo "âœ… Tailscale IPï¼š$TAILSCALE_IP"
          set -e

      - name: 10-ã€æ¸…ç†ã€‘ç³»ç»Ÿåƒåœ¾+æ—§å¤‡ä»½
        if: ${{ always() }}
        run: |
          set +e
          # æ¸…ç†ç³»ç»Ÿåƒåœ¾
          sudo rm -rf /usr/local/lib/* /opt/hostedtoolcache /tmp/* /var/tmp/* ~/.cache/* 2>/dev/null || true
          sudo apt autoremove --purge -y -qq && sudo apt clean -y -qq
          sudo journalctl --vacuum-size=100M --quiet
          
          # æ¸…ç†æ—§å¤‡ä»½
          if [ "${WEBDAV_AVAILABLE}" = true ]; then
            if [ "${USE_RCLONE}" = true ]; then
              BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "${RCLONE_CONFIG}" | grep "casaos-full-snapshot.*\.tar\.zst" | sort -r | awk '{print $2}')
              COUNT=$(echo "$BACKUPS" | wc -l | tr -d ' ')
              if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
                echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
                  [ -n "$f" ] && rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$f --config "${RCLONE_CONFIG}"
                done
              fi
            fi
            if [ "${USE_MOUNT}" = true ]; then
              REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
              BACKUPS=$(ls -t "${REMOTE_DIR}"/casaos-full-snapshot*.tar.zst 2>/dev/null)
              COUNT=$(echo "$BACKUPS" | wc -l | tr -d ' ')
              if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
                echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | xargs rm -f {} 2>/dev/null || true
              fi
            fi
          fi
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: 11-ã€æ ¡å‡†ã€‘è¿è¡Œæ—¶é•¿
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          START=${WORKFLOW_START_TIMESTAMP}
          NOW=$(date +%s)
          DUR=$((NOW - START))
          TARGET=$((TARGET_RUN_MINUTES * 60))
          WAIT=$((TARGET - DUR))
          
          echo "ğŸ“Š å·²è¿è¡Œï¼š$((DUR/60))åˆ†$((DUR%60))ç§’"
          if [ $WAIT -gt 0 ]; then
            echo "â³ ç­‰å¾…$((WAIT/60))åˆ†$((WAIT%60))ç§’"
            sleep $WAIT
          fi
          echo "âœ… æ—¶é•¿æ ¡å‡†å®Œæˆ"

      - name: 12-ã€å¤‡ä»½ã€‘å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ˆå¢å¼ºRcloneé”™è¯¯å¤„ç†ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          CASAOS_BACKUP_TMP="/tmp/casaos-backup-tmp"
          sudo mkdir -p "$CASAOS_BACKUP_TMP" && sudo chmod 700 "$CASAOS_BACKUP_TMP" && sudo chown root:root "$CASAOS_BACKUP_TMP"
          trap 'sudo rm -rf "$CASAOS_BACKUP_TMP" 2>/dev/null' EXIT
          
          # åœæ­¢æœåŠ¡
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sync && sleep 10
          
          # æ‰“åŒ…å¿«ç…§
          SNAP_NAME="casaos-full-snapshot-v1-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_SNAP="$CASAOS_BACKUP_TMP/${SNAP_NAME}"
          LOCAL_MD5="$CASAOS_BACKUP_TMP/${SNAP_NAME}${SNAPSHOT_MD5_SUFFIX}"
          
          CPU_CORES=$(grep -c ^processor /proc/cpuinfo)
          ZSTD_THREADS=$(( CPU_CORES > 1 ? CPU_CORES - 1 : 1 ))
          echo "â„¹ï¸ æ‰“åŒ…å¿«ç…§ï¼ˆå‹ç¼©çº¿ç¨‹ï¼š$ZSTD_THREADSï¼‰"
          sudo tar -I "zstd -T$ZSTD_THREADS ${ZSTD_LEVEL}" -cPf "$LOCAL_SNAP" --absolute-names $EXCLUDE_RULES $PERSONAL_DATA_DIRS
          [ ! -s "$LOCAL_SNAP" ] && { echo "âŒ å¿«ç…§æ‰“åŒ…å¤±è´¥"; exit 1; }
          
          # ç”ŸæˆMD5
          sudo md5sum "$LOCAL_SNAP" | sudo tee "$LOCAL_MD5" >/dev/null
          [ ! -s "$LOCAL_MD5" ] && { echo "âŒ MD5ç”Ÿæˆå¤±è´¥"; exit 1; }
          
          # ä¸Šä¼ å¤‡ä»½ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
          sudo chown runner:runner "$LOCAL_SNAP" "$LOCAL_MD5"
          BACKUP_OK=false
          echo "â„¹ï¸ ä¸Šä¼ å¿«ç…§åˆ°WebDAV"
          if [ "${USE_RCLONE}" = true ]; then
            if rclone copy "$LOCAL_SNAP" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config "${RCLONE_CONFIG}" --transfers ${RCLONE_TRANSFERS} --retries ${RCLONE_RETRIES} --stats ${RCLONE_STATS} && \
               rclone copy "$LOCAL_MD5" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config "${RCLONE_CONFIG}" && \
               rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAP_NAME} --config "${RCLONE_CONFIG}" >/dev/null; then
              BACKUP_OK=true
            fi
          elif [ "${USE_MOUNT}" = true ]; then
            sudo cp "$LOCAL_SNAP" "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}/"
            sudo cp "$LOCAL_MD5" "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}/"
            [ -f "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}/${SNAP_NAME}" ] && BACKUP_OK=true
          fi
          
          if [ "$BACKUP_OK" = true ]; then
            echo "âœ… å¤‡ä»½ä¸Šä¼ å®Œæˆ"
          else
            echo "âŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥" && exit 1
          fi
          
          # é‡å¯æœåŠ¡
          sudo systemctl enable --now docker containerd casaos && sleep 5
          
          # è‡ªåŠ¨ç»­è·‘
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            RETRY=3
            RETRY_DELAY=10
            while [ $RETRY -gt 0 ]; do
              if curl -fsSL --fail -X POST -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_snapshot"}'; then
                echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ"
                break
              fi
              RETRY=$((RETRY-1))
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            done
            [ $RETRY -eq 0 ] && echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥"
          else
            echo "âš ï¸ ç»­è·‘æœªé…ç½®"
          fi
          echo "âœ… å¤‡ä»½+ç»­è·‘æµç¨‹å®Œæˆ"

      - name: 13-ã€æ”¶å°¾ã€‘æ•æ„Ÿæ–‡ä»¶æ¸…ç†
        if: ${{ always() }}
        run: |
          set +e
          # å¸è½½æŒ‚è½½
          mount | grep -q "${LOCAL_MOUNT_POINT}" && sudo umount -l -f "${LOCAL_MOUNT_POINT}" --quiet 2>/dev/null || true
          
          # æ¸…ç†æ•æ„Ÿæ–‡ä»¶
          sudo rm -rf /tmp/* /var/tmp/* "${RCLONE_CONFIG}" /etc/davfs2/secrets ~/.rclone* "$GITHUB_WORKSPACE/casaos_install.log" 2>/dev/null || true
          
          echo "ğŸ‰ å…¨æµç¨‹å®Œæˆï¼Œç»“æŸæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          set -e