name: CasaOS-å…¨é‡å¤‡ä»½æ¢å¤è¿ç§»ï¼ˆåŸæœºæœåŠ¡æ–‡ä»¶+æ— ç½‘ç»œä¾èµ–ï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # è‡ªåŠ¨ç»­è·‘è§¦å‘
  # schedule:
  #   - cron: '0 2 * * *'  # å¯é€‰ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½ï¼ˆå¯ç”¨è¯·å–æ¶ˆæ³¨é‡Šï¼‰

jobs:
  casaos-full-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360  # æœ€å¤§è¿è¡Œæ—¶é—´ï¼ˆ6å°æ—¶ï¼‰
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"  # æœåŠ¡ç«¯å®é™…å¤‡ä»½ç›®å½•
      # æ ¸å¿ƒå¤‡ä»½è·¯å¾„ï¼ˆå«åŸæœºcasaos.serviceåŒè·¯å¾„ï¼Œè¦†ç›–æ‰€æœ‰æƒ…å†µï¼‰
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /usr/lib/systemd/system/docker.service /etc/systemd/system/docker.service.d /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/lib/systemd/system/casaos.service /etc/systemd/system/casaos.service /DATA"
      # æ’é™¤å†—ä½™æ–‡ä»¶ï¼ˆå‡å°‘å¿«ç…§ä½“ç§¯ï¼‰
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=/var/lib/docker/volumes/*/_data/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
      # ä»GitHub Secretsè¯»å–é…ç½®ï¼ˆéœ€æå‰é…ç½®ï¼‰
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–&æ ¸å¿ƒä¾èµ–å®‰è£…
        run: |
          set -e
          echo "===== ç³»ç»Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          # å®‰è£…å¿…å¤‡ä¾èµ–ï¼ˆå«ä¸­æ–‡ç¼–ç ï¼‰
          sudo apt install -y curl wget jq fuse3 tar gzip bzip2 locales openssl ca-certificates apt-transport-https sshpass net-tools iputils-ping -qq
          sudo locale-gen zh_CN.UTF-8 && sudo update-locale LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          
          # å®‰è£…Rcloneï¼ˆæ–‡ä»¶ä¸Šä¼ å·¥å…·ï¼‰
          if ! command -v rclone &>/dev/null; then
            INSTALL_RETRY=3
            until curl -fsSL https://rclone.org/install.sh | sudo bash; do
              INSTALL_RETRY=$((INSTALL_RETRY-1))
              if [ $INSTALL_RETRY -eq 0 ]; then
                RCLONE_VER=$(curl -s https://api.github.com/repos/rclone/rclone/releases/latest | jq -r .tag_name | sed 's/v//')
                wget -q https://downloads.rclone.org/v${RCLONE_VER}/rclone-v${RCLONE_VER}-linux-amd64.deb -O /tmp/rclone.deb
                sudo dpkg -i /tmp/rclone.deb >/dev/null 2>&1
                sudo apt install -f -y -qq
                rm -f /tmp/rclone.deb
                break
              fi
              sleep 3
            done
          fi
          
          # å®‰è£…Dockerï¼ˆCasaOSä¾èµ–ï¼‰
          if ! command -v docker &>/dev/null; then
            sudo apt install -y docker.io docker-compose-plugin -qq
            sudo systemctl enable --now docker && sudo usermod -aG docker runner
          fi
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä¾èµ–å…¨éƒ¨å°±ç»ª"

      - name: 2-åˆ›å»ºæ ¹æƒé™ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå…å¯†sudoï¼‰
        run: |
          set -e
          echo "===== é…ç½®æ ¹æƒé™ç”¨æˆ· ====="
          USER_NAME="roots"
          if id -u "$USER_NAME" >/dev/null 2>&1; then
            echo "âœ… $USER_NAMEç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            sudo useradd -m -s /bin/bash "$USER_NAME"
            echo "âœ… $USER_NAMEç”¨æˆ·åˆ›å»ºæˆåŠŸ"
          fi
          
          # é…ç½®å¯†ç ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å¯†ç ï¼Œæ— åˆ™ç”Ÿæˆéšæœºå¯†ç ï¼‰
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
            echo "âœ… å¯†ç é…ç½®å®Œæˆï¼ˆè‡ªå®šä¹‰ï¼‰"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "âœ… å¯†ç é…ç½®å®Œæˆï¼ˆéšæœºï¼‰ï¼š$RANDOM_PASS"
          fi
          
          # æˆäºˆå…å¯†sudo+dockerç®¡ç†æƒé™
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          sudo chmod 755 /home/"$USER_NAME"
          echo "âœ… æ ¹æƒé™ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 3-Rcloneé…ç½®+WebDAVè¿é€šæ ¡éªŒï¼ˆé€‚é…/z/Uduï¼‰
        run: |
          set -e
          echo "===== WebDAVé…ç½®ä¸æ ¡éªŒ ====="
          # æ ¡éªŒå‡­è¯æ˜¯å¦å®Œæ•´
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œç¦ç”¨å¤‡ä»½æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # æ ¡éªŒURLåè®®å‰ç¼€
          if ! echo "$WEBDAV_URL" | grep -qE "^http://|^https://"; then
            echo "âŒ WebDAVåœ°å€ç¼ºå¤±http/httpså‰ç¼€"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # é…ç½®Rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf >/dev/null
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          
          # æ ¡éªŒæœåŠ¡ç«¯/z/Uduç›®å½•æƒé™ï¼ˆæ ¸å¿ƒé€‚é…ï¼‰
          echo "ğŸ” æ ¡éªŒ/z/Uduç›®å½•æƒé™..."
          rclone mkdir mywebdav:/z/Udu --config /home/runner/.rclone.conf 2>/dev/null || true
          if ! timeout 30 rclone ls mywebdav:/z/Udu --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ /z/Uduç›®å½•æ— è®¿é—®æƒé™"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null || true
          
          # æŸ¥æ‰¾æœ€æ–°å¿«ç…§ï¼ˆé˜²é‡å¤æ‹¼æ¥é€»è¾‘ï¼‰
          echo "ğŸ” æŸ¥æ‰¾æœ€æ–°å¤‡ä»½å¿«ç…§..."
          REMOTE_FILES=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null)
          if [ -n "$REMOTE_FILES" ]; then
            REMOTE_SNAPSHOTS=$(echo "$REMOTE_FILES" | \
              grep -E "casaos-full-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz" | \
              sed -E 's/^[0-9]+[[:space:]]+//' | \
              xargs -n1 basename | \
              sort -r | \
              uniq)
            LATEST_SNAPSHOT=$(echo "$REMOTE_SNAPSHOTS" | head -n1 | xargs)
            # å®‰å…¨æ¸…æ´—ï¼šé¿å…è·¯å¾„é‡å¤
            if echo "$LATEST_SNAPSHOT" | grep -q "/"; then
              LATEST_SNAPSHOT=$(basename "$LATEST_SNAPSHOT")
            fi
            echo "âœ… æœ€æ–°å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
            echo "FULL_SNAPSHOT_PATH=${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æ— å†å²å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…"
          fi
          
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "âœ… WebDAVé…ç½®å®Œæˆï¼Œå¯æ­£å¸¸å¤‡ä»½/æ¢å¤"

      - name: 4-è‡ªåŠ¨æ¢å¤ï¼ˆä½¿ç”¨åŸæœºå¤‡ä»½çš„serviceæ–‡ä»¶ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== å…¨é‡æ¢å¤ï¼š${{ env.LATEST_SNAPSHOT }} ====="
          # æ¸…æ´—è·¯å¾„ï¼ˆæœ€ç»ˆä¿éšœï¼‰
          CLEAN_FULL_PATH="${{ env.WEBDAV_SNAPSHOT_DIR }}/$(basename ${{ env.LATEST_SNAPSHOT }})"
          echo "ğŸ” æ¢å¤è·¯å¾„ï¼š${CLEAN_FULL_PATH}"
          
          # åœæ­¢æœåŠ¡+æ¸…ç†é”æ–‡ä»¶
          sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
          sudo systemctl mask docker.socket casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/casaos.pid 2>/dev/null || true
          sync && sleep 3
          echo "âœ… æœåŠ¡åœæ­¢ï¼Œé”æ–‡ä»¶æ¸…ç†å®Œæˆ"
          
          # æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
          echo "ğŸ” æ ¡éªŒå¿«ç…§å®Œæ•´æ€§..."
          if ! timeout 60 rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æŸåæˆ–è·¯å¾„é”™è¯¯"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos
            exit 1
          fi
          echo "âœ… å¿«ç…§å®Œæ•´æœ‰æ•ˆï¼Œå¼€å§‹æ¢å¤"
          
          # æ¢å¤æ•°æ®ï¼ˆç›´æ¥è¿˜åŸåŸæœºæ–‡ä»¶ï¼Œå«casaos.serviceï¼‰
          rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions $EXCLUDE_RULES
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼ŒåŸæœºserviceæ–‡ä»¶å·²è¿˜åŸ"
          
          # åˆ é™¤å·²æ¢å¤çš„å¿«ç…§ï¼ˆé¿å…é‡å¤æ¢å¤ï¼‰
          rclone delete mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf 2>/dev/null || true
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt --config /home/runner/.rclone.conf 2>/dev/null || true
          
          sudo systemctl unmask docker.socket casaos
          sudo systemctl daemon-reload
          echo "âœ… æ¢å¤å®Œæˆï¼ŒæœåŠ¡é…ç½®å°±ç»ª"
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"

      - name: 5-æ— å¿«ç…§æ—¶å…¨æ–°å®‰è£…CasaOS
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…CasaOS ====="
          # å¯åŠ¨Docker
          sudo systemctl enable --now docker
          sleep 3
          if ! sudo systemctl is-active --quiet docker; then
            sudo systemctl restart docker
            sleep 3
          fi
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œç»ˆæ­¢å®‰è£…"
            exit 1
          fi
          
          # å®‰è£…CasaOSï¼ˆå®˜æ–¹è„šæœ¬ï¼Œè‡ªåŠ¨ç”Ÿæˆserviceæ–‡ä»¶ï¼‰
          INSTALL_RETRY=3
          until curl -fsSL https://get.casaos.io | sudo bash; do
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            if [ $INSTALL_RETRY -eq 0 ]; then
              echo "âŒ CasaOSå®‰è£…å¤±è´¥"
              cat /var/log/casaos-install.log 2>/dev/null || true
              exit 1
            fi
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œå‰©ä½™${INSTALL_RETRY}æ¬¡é‡è¯•"
            sleep 10
          done
          echo "âœ… CasaOSå…¨æ–°å®‰è£…æˆåŠŸ"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"

      - name: 6-æœåŠ¡å¯åŠ¨+ç¯å¢ƒä¿®å¤ï¼ˆæ— ç½‘ç»œæ‹‰å–ï¼‰
        run: |
          set -e
          echo "===== æœåŠ¡å¯åŠ¨ä¸ç¯å¢ƒä¿®å¤ ====="
          sudo systemctl daemon-reload
          
          # å¯åŠ¨Dockerï¼ˆå®¹é”™é‡è¯•ï¼‰
          DOCKER_RETRY=5
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl start docker docker.socket
            sleep 5
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Dockerå¯åŠ¨æˆåŠŸ"
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl reset-failed docker
            sleep 3
          done
          if [ $DOCKER_RETRY -eq 0 ]; then
            echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œæ’æŸ¥ï¼šsudo journalctl -u docker"
            exit 1
          fi
          
          # ä¿®å¤ç›®å½•æƒé™ï¼ˆä¿éšœCasaOSè¿è¡Œï¼‰
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/casaos/appstore /DATA 2>/dev/null || true
          sudo chown -R root:root /etc/casaos /var/lib/casaos
          sudo chmod -R 755 /etc/casaos /var/lib/casaos
          sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock
          
          # å¯åŠ¨CasaOSï¼ˆä½¿ç”¨åŸæœºå¤‡ä»½/å®‰è£…ç”Ÿæˆçš„serviceæ–‡ä»¶ï¼‰
          sudo docker network create casaos 2>/dev/null || true
          CASAOS_RETRY=3
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo systemctl start casaos
            sleep 4
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… CasaOSå¯åŠ¨æˆåŠŸï¼Œå¯æ­£å¸¸è®¿é—®"
              break
            fi
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl reset-failed casaos
            sleep 2
          done
          
          # è¾“å‡ºæœåŠ¡çŠ¶æ€
          echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
          sudo systemctl status docker --no-pager 2>/dev/null || echo "DockerçŠ¶æ€æœªçŸ¥"
          sudo systemctl status casaos --no-pager 2>/dev/null || echo "CasaOSçŠ¶æ€æœªçŸ¥"
          echo "âœ… ç¯å¢ƒä¿®å¤å®Œæˆ"

      - name: 7-Tailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼Œéœ€é…ç½®å¯†é’¥ï¼‰
        run: |
          set -e
          echo "===== Tailscaleç»„ç½‘é…ç½® ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          
          # å®‰è£…Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq
          sudo apt install -y tailscale -qq --upgrade
          
          # å¯åŠ¨å¹¶ç»„ç½‘
          sudo systemctl stop tailscaled 2>/dev/null || true
          sudo systemctl start tailscaled
          sudo systemctl enable tailscaled
          sleep 5
          
          TS_HOSTNAME="CasaOS-Server-$(hostname | cut -c1-8)"
          if ! sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME"; then
            echo "âš ï¸ Tailscaleç»„ç½‘å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š"
            sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --verbose
            exit 1
          fi
          
          # è¾“å‡ºç»„ç½‘ä¿¡æ¯
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)
          if [ -n "$TS_IP" ]; then
            echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œè¿œç¨‹IPv4ï¼š$TS_IP"
            echo "âœ… ä¸»æœºåï¼š$TS_HOSTNAMEï¼Œå¼€æœºè‡ªåŠ¨é‡è¿"
          else
            echo "âš ï¸ ç»„ç½‘å®Œæˆä½†æœªè·å–åˆ°IPï¼ŒçŠ¶æ€ï¼š$(sudo tailscale status | head -3)"
          fi

      - name: 8-å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ˆå«åŸæœºserviceæ–‡ä»¶ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          echo "===== å¯åŠ¨å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ ====="
          
          # å®šä¹‰ç»­è·‘è§¦å‘å‡½æ•°
          trigger_workflow_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âš ï¸ ç»­è·‘é…ç½®ç¼ºå¤±ï¼Œè·³è¿‡"
              return 1
            fi
            if ! curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥ï¼Œä¸å½±å“å¤‡ä»½"
              return 1
            fi
            echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true
            return 0
          }
          
          # å®šä¹‰å…¨é‡å¤‡ä»½å‡½æ•°
          full_backup_and_upload() {
            echo "ğŸ” æ£€æŸ¥æ ¸å¿ƒå¤‡ä»½è·¯å¾„å®Œæ•´æ€§..."
            MISSING_DIRS=""
            for path in $CORE_BACKUP_DIRS; do
              if [ ! -e "$path" ]; then
                if echo "$path" | grep -q "\." && [ "${path: -1}" != "/" ]; then
                  echo "âš ï¸ è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼š$path"
                  continue
                fi
                echo "âš ï¸ æ ¸å¿ƒç›®å½• $path ä¸å­˜åœ¨ï¼Œrootæƒé™åˆ›å»º"
                sudo mkdir -p "$path" && sudo chown -R root:root "$path"
                MISSING_DIRS="$MISSING_DIRS $path"
              fi
            done
            [ -n "$MISSING_DIRS" ] && echo "âœ… å·²è¡¥å…¨ç¼ºå¤±ç›®å½•ï¼š$MISSING_DIRS" || echo "âœ… æ ¸å¿ƒè·¯å¾„å…¨éƒ¨å­˜åœ¨"
      
            echo "ğŸ” è¿‡æ»¤æ— æ•ˆå¤‡ä»½è·¯å¾„..."
            VALID_BACKUP_DIRS=""
            for path in $CORE_BACKUP_DIRS; do
              if [ -e "$path" ]; then
                VALID_BACKUP_DIRS="$VALID_BACKUP_DIRS $path"
              else
                echo "âš ï¸ è·³è¿‡æ— æ•ˆè·¯å¾„ï¼š$path"
              fi
            done
            if [ -z "$VALID_BACKUP_DIRS" ]; then
              echo "âŒ æ— æœ‰æ•ˆå¤‡ä»½è·¯å¾„ï¼Œç»ˆæ­¢æ‰“åŒ…"
              return 1
            fi
      
            # åˆ›å»ºä¸´æ—¶å¤‡ä»½ç›®å½•
            BACKUP_TMP_DIR="/home/runner/casaos-backup-tmp"
            sudo rm -rf "$BACKUP_TMP_DIR" && sudo mkdir -p "$BACKUP_TMP_DIR"
            sudo chown -R runner:runner "$BACKUP_TMP_DIR" && sudo chmod 777 "$BACKUP_TMP_DIR"
      
            # æ£€æŸ¥å¯ç”¨ç©ºé—´
            FREE_SPACE=$(df -k "$BACKUP_TMP_DIR" | awk 'NR==2{print $4}')
            FREE_SPACE_GB=$((FREE_SPACE/1024/1024))
            if [ $FREE_SPACE_GB -lt 5 ]; then
              echo "âŒ å¯ç”¨ç©ºé—´ä¸è¶³5GBï¼Œè·³è¿‡å¤‡ä»½"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "âœ… å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ç”¨ç©ºé—´ï¼š$FREE_SPACE_GB GB"
      
            # ç”Ÿæˆå¿«ç…§åç§°
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            LOCAL_SNAPSHOT="$BACKUP_TMP_DIR/$SNAPSHOT_NAME"
            REMOTE_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ å…¨é‡æ‰“åŒ…ä¸­ï¼ˆå«åŸæœºcasaos.serviceï¼‰..."
      
            # æ‰“åŒ…æ ¸å¿ƒæ–‡ä»¶ï¼ˆrootæƒé™ï¼Œç¡®ä¿èƒ½è¯»å–serviceæ–‡ä»¶ï¼‰
            sudo tar -czPf "$LOCAL_SNAPSHOT" \
              --ignore-failed-read \
              --preserve-permissions \
              --dereference \
              $EXCLUDE_RULES \
              $VALID_BACKUP_DIRS > "$BACKUP_TMP_DIR/tar_log.txt" 2>&1
              
            # æ ¡éªŒæ‰“åŒ…ç»“æœ
            if [ ! -f "$LOCAL_SNAPSHOT" ] || [ ! -s "$LOCAL_SNAPSHOT" ]; then
              echo "âŒ taræ‰“åŒ…å¤±è´¥ï¼Œæœªç”Ÿæˆæœ‰æ•ˆå¿«ç…§æ–‡ä»¶ï¼"
              echo "tarå‘½ä»¤æ—¥å¿—ï¼š"
              cat "$BACKUP_TMP_DIR/tar_log.txt"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
      
            # æ ¡éªŒtarç»“æ„å®Œæ•´æ€§
            sudo tar -tzf "$LOCAL_SNAPSHOT" 2>"$BACKUP_TMP_DIR/tar_error.txt" > "$BACKUP_TMP_DIR/tar_content.txt"
            if [ $? -ne 0 ]; then
              echo "âŒ å¿«ç…§tarç»“æ„æŸåï¼"
              echo "TaræŠ¥é”™ä¿¡æ¯ï¼š" && cat "$BACKUP_TMP_DIR/tar_error.txt"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
      
            # æ ¡éªŒæ ¸å¿ƒå†…å®¹ï¼ˆå«casaos.serviceï¼‰
            HAS_CASAOS_SERVICE=$(grep -c "casaos.service" "$BACKUP_TMP_DIR/tar_content.txt")
            HAS_DOCKER=$(grep -c "var/lib/docker" "$BACKUP_TMP_DIR/tar_content.txt")
            HAS_CASAOS=$(grep -c "var/lib/casaos" "$BACKUP_TMP_DIR/tar_content.txt")
            if [ $HAS_CASAOS_SERVICE -eq 0 ] || [ $HAS_DOCKER -eq 0 ] || [ $HAS_CASAOS -eq 0 ]; then
              echo "âŒ å¿«ç…§æ ¸å¿ƒå†…å®¹ç¼ºå¤±ï¼ˆå«casaos.serviceï¼‰ï¼"
              echo "æ‰“åŒ…å†…å®¹é¢„è§ˆï¼š" && head -25 "$BACKUP_TMP_DIR/tar_content.txt"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
      
            echo "âœ… å¿«ç…§å®Œæ•´æ€§æ ¡éªŒé€šè¿‡ï¼ˆå«åŸæœºcasaos.serviceï¼‰"
            SNAPSHOT_SIZE=$(du -sh "$LOCAL_SNAPSHOT" | awk '{print $1}')
            echo "âœ… æ‰“åŒ…å®Œæˆï¼Œå¿«ç…§å¤§å°ï¼š$SNAPSHOT_SIZE"
      
            # åœæ­¢æœåŠ¡åä¸Šä¼ 
            sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
            sync && sleep 2
            echo "ğŸ“¤ ä¸Šä¼ å¿«ç…§åˆ°WebDAVï¼ˆ/z/Udu/CasaOS-Backupï¼‰..."
            rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null || true
            rclone copy "$LOCAL_SNAPSHOT" "mywebdav:${REMOTE_SNAPSHOT}" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --fast-list \
              --progress \
              --log-level INFO
            if [ $? -ne 0 ]; then
              echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œæ’æŸ¥ï¼š1. WebDAV URLæ˜¯å¦æ­£ç¡®ï¼›2. /z/Udu/CasaOS-Backupå†™å…¥æƒé™"
              sudo rm -rf "$BACKUP_TMP_DIR"
              return 1
            fi
            echo "âœ… ä¸Šä¼ æˆåŠŸï¼Œè¿œç¨‹åœ°å€ï¼š${REMOTE_SNAPSHOT}"
      
            # ç”Ÿæˆå…ƒæ•°æ®
            META_FILE="$BACKUP_TMP_DIR/backup-meta.txt"
            echo "snapshot_name=$SNAPSHOT_NAME" > "$META_FILE"
            echo "backup_time=$(date '+%Y-%m-%d %H:%M:%S')" >> "$META_FILE"
            echo "backup_size=$SNAPSHOT_SIZE" >> "$META_FILE"
            echo "backup_content=å«åŸæœºcasaos.serviceçš„Docker+CasaOS+DATAå…¨é‡å¤‡ä»½" >> "$META_FILE"
            rclone copy "$META_FILE" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt" --config /home/runner/.rclone.conf 2>/dev/null || true
      
            # æ¸…ç†+é‡å¯æœåŠ¡
            sudo rm -rf "$BACKUP_TMP_DIR"
            sudo systemctl start docker docker.socket casaos 2>/dev/null || true
            sleep 3
            echo "âœ… å…¨é‡å¤‡ä»½å®Œæˆï¼ŒæœåŠ¡æ¢å¤æ­£å¸¸è¿è¡Œ"
            return 0
          }
          
          # ä¸»å¾ªç¯ï¼šå¤‡ä»½+è‡ªåŠ¨ç»­è·‘
          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "ğŸ“Š å·²è¿è¡Œ${run_mins}åˆ†é’Ÿï¼ŒçŠ¶æ€ç¨³å®š"
      
            # è¿è¡Œ2åˆ†é’Ÿåè§¦å‘å¤‡ä»½+ç»­è·‘
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è§¦å‘å…¨é‡å¤‡ä»½"
              if full_backup_and_upload; then
                trigger_workflow_renew
              else
                echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œ30åˆ†é’Ÿåé‡è¯•"
                sleep 1800
              fi
            fi
      
            # è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œæ­£å¸¸é€€å‡º"
              exit 0
            fi
            sleep 60
          done

      - name: 9-æ”¶å°¾æ¸…ç†ï¼ˆæ— è®ºæˆè´¥å¿…æ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç†ï¼Œé‡Šæ”¾èµ„æº ====="
          sudo systemctl unmask docker.socket casaos 2>/dev/null || true
          sudo rm -rf /home/runner/casaos-backup-tmp /tmp/* 2>/dev/null || true
          sudo rm -rf /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo chown -R runner:runner /home/runner 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… æ¸…ç†å®Œæˆï¼Œæ— æ®‹ç•™æ–‡ä»¶"
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ŒCasaOSæœåŠ¡æ­£å¸¸è¿è¡Œ"
