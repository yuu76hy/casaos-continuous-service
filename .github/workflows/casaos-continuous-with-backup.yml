name: CasaOS-Server-Snapshot-Backup-Restore

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount  # åŸºç¡€è·¯å¾„ç›´æ¥å†™æ­»ï¼Œé¿å…åµŒå¥—å¼•ç”¨
      CORE_DIRS: "/var/lib /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp --exclude=$WEBDAV_MOUNT_POINT
      # GitHub Secrets
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      # ========== 1. ç¯å¢ƒåˆå§‹åŒ– + åˆ›å»ºWebDAVå­ç›®å½• ==========
      - name: Env Init & Create Dirs
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip
          curl https://rclone.org/install.sh | sudo bash
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          
          # æ­¥éª¤å†…åŠ¨æ€æ‹¼æ¥å­ç›®å½•è·¯å¾„ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
          WEBDAV_SNAPSHOT_DIR="${WEBDAV_MOUNT_POINT}/z/Ubu"
          # åˆ›å»ºå¤šçº§ç›®å½•ï¼Œç¡®ä¿å­˜åœ¨
          sudo mkdir -p "$WEBDAV_SNAPSHOT_DIR"
          echo "âœ… Env init done, WebDAV snapshot dir: $WEBDAV_SNAPSHOT_DIR"
          # æŠŠè·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "WEBDAV_SNAPSHOT_DIR=$WEBDAV_SNAPSHOT_DIR" >> "$GITHUB_ENV"

      # ========== 2. åˆ›å»º roots ç”¨æˆ· ==========
      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            [ -n "$ROOTS_PASSWORD" ] && echo "roots:$ROOTS_PASSWORD" | sudo chpasswd || {
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots password: $RANDOM_PASS"
            }
            sudo usermod -aG sudo roots
          fi

      # ========== 3. æŒ‚è½½ WebDAV + æ£€æµ‹å­ç›®å½•å¿«ç…§ ==========
      - name: Mount WebDAV
        run: |
          set -e
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets missing"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          mkdir -p "$WEBDAV_MOUNT_POINT"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="other" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" --config /home/runner/.rclone.conf --vfs-cache-mode full --daemon-timeout 1h --allow-other --log-level ERROR >/dev/null 2>&1 &

          for i in $(seq 1 5); do
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              echo "âœ… WebDAV mounted"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              # ä»æ­¥éª¤1å®šä¹‰çš„å­ç›®å½•æ£€æµ‹å¿«ç…§
              if ls "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "âœ… Found latest snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ No historical snapshot in $WEBDAV_SNAPSHOT_DIR"
              fi
              exit 0
            fi
            sleep 10
          done
          echo "âŒ WebDAV mount failed"
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      # ========== 4. ä»å­ç›®å½•æ¢å¤å¿«ç…§ + åˆ é™¤å·²ç”¨æ–‡ä»¶ ==========
      - name: Restore Snapshot & Cleanup
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== Restore from: $LATEST_SNAPSHOT ====="
          # å½»åº•åœæ‰Docker/CasaOS
          sudo systemctl stop docker.service docker.socket casaos.service
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3

          # è§£å‹å¿«ç…§ï¼Œå¿½ç•¥æ‰€æœ‰é”™è¯¯
          sudo tar -xzf "$LATEST_SNAPSHOT" -C / --overwrite --ignore-failed-read --warning=no-all $EXCLUDE_RULES
          
          if [ $? -eq 0 ]; then
            echo "âœ… Restore success"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # åˆ é™¤å­ç›®å½•ä¸‹çš„å·²ç”¨å¿«ç…§å’Œå…ƒä¿¡æ¯
            sudo rm -f "$LATEST_SNAPSHOT" "$WEBDAV_SNAPSHOT_DIR/snapshot_meta.txt"
            sudo systemctl unmask docker.socket
          else
            echo "âŒ Restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          fi

      # ========== 5. å®‰è£… CasaOS ==========
      - name: Install CasaOS If No Snapshot
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed"

      # ========== 6. å¯åŠ¨æœåŠ¡ ==========
      - name: Start Services
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket casaos.service
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Services started"
              exit 0
            fi
            echo "âš ï¸ Start attempt $i failed"
          done
          echo "âŒ Service start failed"
          exit 1

      # ========== 7. éƒ¨ç½² Tailscale ==========
      - name: Deploy Tailscale
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscale key missing, skip"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"
          echo "âœ… Tailscale IP: $(sudo tailscale ip -4)"

      # ========== 8. æ ¸å¿ƒä¿®å¤ï¼šå¿«ç…§ä¿å­˜åˆ°/z/Ubuç›®å½• ==========
      - name: Create Snapshot & Upload & Renew
        shell: bash
        run: |
          set -e
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘å‡½æ•°
          trigger_renew() {
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && return 1
            curl -fsS -X POST -H "Authorization: token $USER_PAT" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/$REPO/dispatches" -d '{"event_type":"renew_casaos_snapshot"}'
            [ $? -eq 0 ] && echo "âœ… Renew triggered" && RENEW_TRIGGERED=true
          }

          # å¿«ç…§åˆ›å»ºå‡½æ•°
          create_snapshot() {
            [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1

            # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            # ä½¿ç”¨æ­¥éª¤1å®šä¹‰çš„å­ç›®å½•è·¯å¾„
            WEBDAV_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ Snapshot name: $SNAPSHOT_NAME (save to $WEBDAV_SNAPSHOT_DIR)"

            # å½»åº•åœæ­¢Docker
            sudo systemctl stop docker.service docker.socket casaos.service
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5

            # æ‰“åŒ…å¿«ç…§
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS

            # æ£€æŸ¥å¿«ç…§æ˜¯å¦ç”Ÿæˆ
            [ ! -f "${TMP_SNAPSHOT}" ] && echo "âŒ Snapshot file not found" && return 1
            echo "âœ… Snapshot created: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            # æ£€æŸ¥WebDAVå­ç›®å½•å¯å†™æ€§
            if ! sudo touch "${WEBDAV_SNAPSHOT_DIR}/.test-write" 2>/dev/null; then
              echo "âŒ WebDAV dir $WEBDAV_SNAPSHOT_DIR is read-only"
              return 1
            fi
            sudo rm -f "${WEBDAV_SNAPSHOT_DIR}/.test-write"

            # ä¸Šä¼ å¿«ç…§åˆ°å­ç›®å½•
            sudo cp "${TMP_SNAPSHOT}" "${WEBDAV_SNAPSHOT}"
            if [ $? -eq 0 ]; then
              echo "âœ… Snapshot uploaded to $WEBDAV_SNAPSHOT"
              # å…ƒä¿¡æ¯æ–‡ä»¶ä¹Ÿå­˜åˆ°å­ç›®å½•
              echo "snapshot_name=${SNAPSHOT_NAME}" | sudo tee "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
              echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" | sudo tee -a "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
            else
              echo "âŒ Upload failed"
              return 1
            fi

            # æ¢å¤æœåŠ¡
            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket casaos.service
            return 0
          }

          # ä¿æ´»å¾ªç¯ï¼ˆä¿®å¤ç®—æœ¯è¿ç®—è¯­æ³•ï¼‰
          while true; do
            run_mins=$(( ($(date +%s) - start_time) / 60 ))
            echo "ğŸ“Š Running for $run_mins minutes"

            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Start snapshot creation"
              create_snapshot && trigger_renew
            fi

            [ $run_mins -ge $MAX_RUN_MINUTES ] && echo "â¹ï¸ Timeout" && exit 0
            sleep 60
          done

      # ========== 9. ç¯å¢ƒæ¸…ç† ==========
      - name: Cleanup
        if: ${{ always() }}
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT"
          fi
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner
          echo "âœ… Cleanup done"
