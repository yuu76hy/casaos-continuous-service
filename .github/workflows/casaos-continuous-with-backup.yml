name: CasaOS-Tailscale-Service
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  run-service:
    runs-on: ubuntu-24.04
    timeout-minutes: 10  # 总运行时长10分钟
    env:
      MAX_RUN_MINUTES: 1  # 运行1分钟后触发备份，剩余9分钟执行后续逻辑
      RUNNER_PASSWORD: "runner123"
      CASAOS_PORT: 80
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      LOG_DIR: /home/runner/logs
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      CLEAN_INTERVAL: 300  # 5分钟清理一次空间
      B2_BACKUP_BUCKET: "casaos-backup"
      BACKUP_MARKER: "latest_backup.txt"
      LOG_FILE: "casaos_service_${{ github.run_id }}_$(date +%Y%m%d_%H%M%S).log"
      HEALTH_CHECK_TIMEOUT: 120  # 健康检查超时2分钟
      NEW_RUN_ID_FILE: "/home/runner/new_run_id.txt"

    steps:
      - name: 步骤1 - 系统环境初始化
        id: step1
        continue-on-error: false
        run: |
          mkdir -p $LOG_DIR
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤1：系统环境初始化"
          echo "====================================="
          echo "1. 正在更新系统软件包列表..."
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "系统更新失败！"; exit 1; }
          echo "2. 正在升级系统软件包..."
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "系统升级失败！"; exit 1; }
          echo "3. 正在安装核心依赖工具..."
          pkgs="tar gzip rsync rclone netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release bc jq"
          sudo apt install -y $pkgs || { echo "依赖工具安装失败！"; exit 1; }
          echo "4. 正在设置Runner用户密码..."
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          echo "5. 正在创建数据目录..."
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          echo "====================================="
          echo "步骤1：系统环境初始化 执行完成！"
          echo "====================================="

      - name: 步骤2 - 配置B2对象存储
        id: step2
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤2：配置B2对象存储"
          echo "====================================="
          B2_KEY_ID=${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY=${{ secrets.B2_APPLICATION_KEY }}
          if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
            echo "错误：B2密钥未配置！请检查GitHub Secrets。"; exit 1;
          fi
          mkdir -p ~/.config/rclone
          echo "[b2_backend]" > ~/.config/rclone/rclone.conf
          echo "type = b2" >> ~/.config/rclone/rclone.conf
          echo "account = $B2_KEY_ID" >> ~/.config/rclone/rclone.conf
          echo "key = $B2_APPLICATION_KEY" >> ~/.config/rclone/rclone.conf
          echo "hard_delete = true" >> ~/.config/rclone/rclone.conf
          echo "timeout = 30s" >> ~/.config/rclone/rclone.conf
          echo "retries = 3" >> ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          rclone mkdir b2_backend:${B2_BACKUP_BUCKET}/ || echo "存储桶已存在，跳过创建"
          if rclone lsd b2_backend:${B2_BACKUP_BUCKET}/ --verbose --retries 3; then
            echo "B2存储连接成功！"
            echo "B2_STATUS=success" >> $GITHUB_ENV
          else
            echo "错误：B2存储连接失败！"; exit 1;
          fi
          echo "====================================="
          echo "步骤2：配置B2对象存储 执行完成！"
          echo "====================================="

      - name: 步骤3 - 检查备份并恢复（带校验）
        id: step3
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤3：检查备份并恢复（如有）"
          echo "====================================="
          BACKUP_MARKER_FILE="$BACKUP_DIR/$BACKUP_MARKER"
          rclone copy b2_backend:${B2_BACKUP_BUCKET}/${BACKUP_MARKER} $BACKUP_DIR/ --timeout 30s || echo "未找到远程备份标记文件，跳过下载"
          
          if [ -f "$BACKUP_MARKER_FILE" ]; then
            LATEST_BACKUP=$(cat "$BACKUP_MARKER_FILE")
            echo "最新备份文件名称：$LATEST_BACKUP"
            echo "$BACKUP_EXCLUDE" | tr ' ' '\n' | sed 's/--exclude=//g' > $BACKUP_DIR/exclude-list.txt
            if rclone cat b2_backend:${B2_BACKUP_BUCKET}/${LATEST_BACKUP} --timeout 120s --retries 3 | sudo tar -zxf - -C / --exclude-from=$BACKUP_DIR/exclude-list.txt 2>/dev/null; then
              echo "备份数据恢复完成，开始校验关键目录..."
              if [ -d "/etc/casaos" ] && [ -d "/var/lib/docker" ]; then
                echo "恢复校验通过：关键目录存在"
                echo "HAS_BACKUP=true" >> $GITHUB_ENV
              else
                echo "警告：恢复校验失败！关键目录缺失，使用全新环境"
                echo "HAS_BACKUP=false" >> $GITHUB_ENV
              fi
            else
              echo "警告：备份数据恢复失败，使用全新环境！"
              echo "HAS_BACKUP=false" >> $GITHUB_ENV
            fi
          else
            echo "未找到备份标记文件，使用全新环境！"
            echo "HAS_BACKUP=false" >> $GITHUB_ENV
          fi
          echo "====================================="
          echo "步骤3：检查备份并恢复 执行完成！"
          echo "====================================="

      - name: 步骤4 - 安装CasaOS
        id: step4
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤4：安装CasaOS"
          echo "====================================="
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || { echo "CasaOS安装警告，继续执行"; }
          sudo systemctl start casaos
          if sudo systemctl is-active --quiet casaos; then
            echo "CasaOS服务启动成功！"
          else
            echo "警告：CasaOS服务启动异常，请检查日志！"
          fi
          echo "====================================="
          echo "步骤4：安装CasaOS 执行完成！"
          echo "====================================="

      - name: 步骤5 - 部署Tailscale组网
        id: step5
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤5：部署Tailscale组网"
          echo "====================================="
          if ! curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart"; then
            echo "Tailscale脚本安装失败，尝试APT方式安装..."
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
            sudo apt update && sudo apt install -y tailscale || { echo "错误：Tailscale安装失败！"; exit 1; }
          fi
          sudo systemctl enable --now tailscaled && sleep 5
          MAX_RETRIES=5
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          if [ -z "$TS_AUTH_KEY" ]; then
            echo "错误：Tailscale授权密钥未配置！"; exit 1;
          fi
          TAILSCALE_IP=""
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-${{ github.run_id }} --accept-routes=false --accept-dns=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "Tailscale组网成功！内网IP：$TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            echo "Tailscale组网重试中，剩余次数：$MAX_RETRIES"
            sleep 5
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "错误：Tailscale组网失败！"; exit 1;
          fi
          echo "====================================="
          echo "步骤5：部署Tailscale组网 执行完成！"
          echo "====================================="

      - name: 步骤6 - 输出服务访问信息
        id: step6
        continue-on-error: false
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "============= 服务访问信息 ============="
          echo "====================================="
          echo "服务总运行时长：10分钟"
          echo "备份续跑触发时机：剩余9分钟时"
          echo "系统剩余空间：$(df -h / | awk 'NR==2{print $4}')"
          echo "Runner用户密码：$RUNNER_PASSWORD"
          echo "B2存储连接状态：$B2_STATUS"
          echo "CasaOS管理面板地址：http://$TAILSCALE_IP:$CASAOS_PORT"
          echo "数据来源：$(if [ $HAS_BACKUP = 'true' ]; then echo "从B2备份恢复"; else echo "全新环境部署"; fi)"
          echo "日志文件路径：$LOG_DIR/$LOG_FILE"
          echo "====================================="
          echo "服务启动完成！"
          echo "====================================="

      - name: 步骤7 - 核心保活+备份续跑+健康检查
        id: step7
        continue-on-error: true
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤7：核心保活+备份续跑+健康检查"
          echo "====================================="
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}
          CURRENT_RUN_ID=${{ github.run_id }}

          auto_clean() {
            echo "[$(date)] 执行系统空间清理..."
            BEFORE=$(df -h / | awk 'NR==2{print $4}')
            sudo apt clean -y && sudo apt autoremove -y --purge
            sudo docker system prune -af --volumes 2>/dev/null
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null
            AFTER=$(df -h / | awk 'NR==2{print $4}')
            echo "[$(date)] 空间清理完成：$BEFORE → $AFTER"
          }

          do_backup() {
            echo "====================================="
            echo "[$(date)] 开始执行备份全流程 - 剩余9分钟"
            echo "====================================="
            TS=$(date +%Y%m%d_%H%M%S)
            BK_NAME="casaos_${CURRENT_RUN_ID}_$TS.tar.gz"
            BK_TEMP_LOG="/tmp/backup_${CURRENT_RUN_ID}.log"
            rm -f $BK_TEMP_LOG  # 清空临时日志

            # 步骤1: 停止CasaOS服务
            echo "[$(date)] 步骤1/6: 停止CasaOS服务..."
            sudo systemctl stop casaos
            stop_exit=$?
            if [ $stop_exit -ne 0 ]; then
              echo "[$(date)] ERROR: CasaOS停止失败，错误码: $stop_exit" | tee -a $BK_TEMP_LOG
            else
              echo "[$(date)] SUCCESS: CasaOS已停止" | tee -a $BK_TEMP_LOG
            fi
            sleep 3

            # 步骤2: 打包关键数据（修复tar参数顺序+移除通配符）
            echo "[$(date)] 步骤2/6: 开始打包数据，目标文件: $BK_NAME" | tee -a $BK_TEMP_LOG
            echo "[$(date)] 打包范围: /etc/casaos /var/lib/docker | 排除项: $BACKUP_EXCLUDE" | tee -a $BK_TEMP_LOG
            sudo tar -z1cf /tmp/$BK_NAME \
              $BACKUP_EXCLUDE \
              --directory=/ \
              etc/casaos \
              var/lib/docker 2>> $BK_TEMP_LOG
            tar_exit=$?
            if [ $tar_exit -ne 0 ]; then
              echo "[$(date)] ERROR: 数据打包失败，错误码: $tar_exit | 查看临时日志: $BK_TEMP_LOG"
              echo "[$(date)] 打包失败详情: $(cat $BK_TEMP_LOG | tail -5)"
              backup_done=true
              return 1
            else
              BK_SIZE_LOCAL=$(du -h /tmp/$BK_NAME | awk '{print $1}')
              echo "[$(date)] SUCCESS: 数据打包完成 | 本地文件大小: $BK_SIZE_LOCAL" | tee -a $BK_TEMP_LOG
            fi

            # 步骤3: 上传到B2存储
            echo "[$(date)] 步骤3/6: 开始上传到B2存储桶: ${B2_BACKUP_BUCKET}" | tee -a $BK_TEMP_LOG
            rclone rcat b2_backend:${B2_BACKUP_BUCKET}/$BK_NAME /tmp/$BK_NAME --timeout 60s --retries 3 --progress 2>> $BK_TEMP_LOG
            rclone_exit=$?
            if [ $rclone_exit -ne 0 ]; then
              echo "[$(date)] ERROR: B2上传失败，错误码: $rclone_exit | 查看临时日志: $BK_TEMP_LOG"
              echo "[$(date)] 上传失败详情: $(cat $BK_TEMP_LOG | tail -5)"
              rm -f /tmp/$BK_NAME
              backup_done=true
              return 1
            else
              echo "[$(date)] SUCCESS: B2上传完成" | tee -a $BK_TEMP_LOG
            fi

            # 步骤4: 校验B2上的备份文件
            echo "[$(date)] 步骤4/6: 校验B2上的备份文件..." | tee -a $BK_TEMP_LOG
            BK_SIZE_REMOTE=$(rclone size b2_backend:${B2_BACKUP_BUCKET}/$BK_NAME --json 2>> $BK_TEMP_LOG | jq -r '.size')
            size_exit=$?
            if [ $size_exit -ne 0 ] || [ "$BK_SIZE_REMOTE" -eq 0 ]; then
              echo "[$(date)] ERROR: 备份校验失败 | 远程文件大小: $BK_SIZE_REMOTE 字节 | 错误码: $size_exit" | tee -a $BK_TEMP_LOG
              rclone delete b2_backend:${B2_BACKUP_BUCKET}/$BK_NAME 2>/dev/null
              rm -f /tmp/$BK_NAME
              backup_done=true
              return 1
            else
              BK_SIZE_REMOTE_HUMAN=$(echo $BK_SIZE_REMOTE | awk '{printf "%.2f MB", $1/1024/1024}')
              echo "[$(date)] SUCCESS: 备份校验通过 | 远程文件大小: $BK_SIZE_REMOTE_HUMAN" | tee -a $BK_TEMP_LOG
            fi

            # 步骤5: 上传备份标记和日志
            echo "[$(date)] 步骤5/6: 上传备份标记文件和日志..." | tee -a $BK_TEMP_LOG
            echo "$BK_NAME" > $BACKUP_DIR/$BACKUP_MARKER
            rclone copy $BACKUP_DIR/$BACKUP_MARKER b2_backend:${B2_BACKUP_BUCKET}/ --timeout 30s 2>> $BK_TEMP_LOG
            rclone copy $LOG_DIR/$LOG_FILE b2_backend:${B2_BACKUP_BUCKET}/logs/ --timeout 30s 2>> $BK_TEMP_LOG
            marker_exit=$?
            if [ $marker_exit -ne 0 ]; then
              echo "[$(date)] WARNING: 标记文件上传失败，错误码: $marker_exit" | tee -a $BK_TEMP_LOG
            else
              echo "[$(date)] SUCCESS: 标记文件和日志已上传" | tee -a $BK_TEMP_LOG
            fi

            # 步骤6: 启动CasaOS服务
            echo "[$(date)] 步骤6/6: 启动CasaOS服务..." | tee -a $BK_TEMP_LOG
            sudo systemctl start casaos
            start_exit=$?
            if [ $start_exit -ne 0 ]; then
              echo "[$(date)] ERROR: CasaOS启动失败，错误码: $start_exit" | tee -a $BK_TEMP_LOG
            else
              echo "[$(date)] SUCCESS: CasaOS已启动" | tee -a $BK_TEMP_LOG
            fi

            # 清理临时文件
            rm -f /tmp/$BK_NAME
            echo "====================================="
            echo "[$(date)] 备份全流程执行完毕 | 临时日志: $BK_TEMP_LOG"
            echo "====================================="
            backup_done=true
          }

          # 触发续跑并获取新Run ID
          trigger_renew() {
            echo "[$(date)] 触发新的服务续跑..."
            if [ -z "$GITHUB_PAT" ] || [ -z "$REPO" ]; then
              echo "续跑失败：PAT或仓库信息未配置"
              return 1
            fi
            RESPONSE=$(curl -s -X POST https://api.github.com/repos/$REPO/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_PAT" \
              -d '{"event_type":"renew_vnc"}' \
              -w "%{http_code}" -o /dev/null --connect-timeout 30s)
            if [ "$RESPONSE" -eq 204 ]; then
              echo "续跑触发请求成功！等待新容器启动..."
              return 0
            else
              echo "续跑触发失败，HTTP状态码：$RESPONSE"
              return 1
            fi
          }

          # 检查新容器健康状态（精简轮询逻辑）
          check_new_container() {
            echo "[$(date)] 开始检查新容器健康状态，超时${HEALTH_CHECK_TIMEOUT}秒..."
            start_check=$(date +%s)
            while [ $(( $(date +%s) - start_check )) -lt $HEALTH_CHECK_TIMEOUT ]; do
              RUNS=$(curl -s -H "Authorization: Bearer $GITHUB_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&event=repository_dispatch&per_page=1" \
                | jq -r '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID') | .id')
              if [ -n "$RUNS" ]; then
                NEW_RUN_ID=$(echo "$RUNS" | head -n 1)
                echo "[$(date)] 发现新容器Run ID：$NEW_RUN_ID"
                echo $NEW_RUN_ID > $NEW_RUN_ID_FILE
                sleep 15  # 缩短新容器等待时间
                echo "[$(date)] 新容器验证通过！"
                return 0
              fi
              sleep 3  # 缩短轮询间隔
            done
            echo "[$(date)] 健康检查超时，未检测到正常新容器！"
            return 1
          }

          echo "核心保活逻辑启动..."
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            # 定时清理
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi

            # 空间不足紧急清理
            if (( $(echo "$free_space < 1" | bc -l) )); then
              echo "[$(date)] 剩余空间不足1G，紧急清理..."
              auto_clean
              last_clean=$now
            fi

            # 关键触发条件：运行1分钟后触发备份（剩余9分钟）
            if [ $((run_mins)) -eq $MAX_RUN_MINUTES ] && [ "$backup_done" = false ]; then
              echo "[$(date)] 触发备份条件满足，调用do_backup函数..."
              do_backup
              backup_exit=$?
              if [ $backup_exit -ne 0 ]; then
                echo "[$(date)] 备份函数执行失败，错误码: $backup_exit，跳过续跑逻辑"
              else
                if trigger_renew; then
                  if check_new_container; then
                    echo "[$(date)] 新容器健康检查通过，旧容器准备退出..."
                    sudo systemctl stop casaos tailscaled
                    sudo tailscale down
                    echo "[$(date)] 旧容器已安全退出！"
                    exit 0
                  else
                    echo "[$(date)] 新容器健康检查失败，旧容器继续运行..."
                  fi
                else
                  echo "[$(date)] 续跑触发失败，旧容器继续运行..."
                fi
              fi
            fi

            # 服务保活
            if ! sudo systemctl is-active --quiet casaos; then
              echo "[$(date)] CasaOS未运行，重启..."
              sudo systemctl restart casaos
            fi
            if ! sudo systemctl is-active --quiet tailscaled; then
              echo "[$(date)] Tailscale未运行，重启..."
              sudo systemctl restart tailscaled
            fi

            # 剩余时间兜底，避免超时被强制终止
            remaining_mins=$((10 - run_mins))
            if [ $remaining_mins -le 1 ]; then
              echo "[$(date)] 剩余时间不足1分钟，强制退出保活循环..."
              sudo systemctl stop casaos tailscaled
              exit 0
            fi

            echo "[$(date)] 已运行 $run_mins 分钟 | 剩余时间: $remaining_mins 分钟 | 剩余空间: $(df -h / | awk 'NR==2{print $4}')"
            sleep 10
          done

      - name: 步骤8 - 服务结束后清理环境
        id: step8
        if: always()
        run: |
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "====================================="
          echo "开始执行步骤8：服务结束后清理环境"
          echo "====================================="
          sudo systemctl stop casaos tailscaled || true
          sudo tailscale down || true
          rm -rf $BACKUP_DIR $NETDISK_ROOT /tmp/backup_*.log || true
          rclone copy $LOG_DIR/$LOG_FILE b2_backend:${B2_BACKUP_BUCKET}/logs/ --timeout 30s || echo "日志上传失败"
          echo "====================================="
          echo "步骤8：环境清理完成！"
          echo "====================================="
