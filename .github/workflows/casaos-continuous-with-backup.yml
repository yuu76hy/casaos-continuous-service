name: CasaOS-Server-å¿«ç…§-å¤‡ä»½-æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      CORE_DIRS: "/var/lib/docker /etc/docker /etc/casaos /var/lib/casaos /DATA"
      # ä¿®æ­£é‡å¤çš„æ’é™¤é¡¹ï¼Œç»Ÿä¸€è‹±æ–‡ç¬¦å·
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: Env Init & Install Dependencies
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ… Environment initialized"

      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi

      - name: Configure Rclone for WebDAV (No Mount)
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ Missing WebDAV secrets"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAV connection failed"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "âœ… WebDAV connected successfully (no mount mode)"
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          echo "âœ… Remote directory created: mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}"
          # ä¿®å¤è·¯å¾„æ‹¼æ¥é€»è¾‘ï¼šæå–æ–‡ä»¶åæ—¶å»æ‰å‰ç¼€ç›®å½•ï¼Œé¿å…é‡å¤
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "casaos-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")  # æ–°å¢basenameæå–çº¯æ–‡ä»¶å
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… Found latest remote snapshot: ${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ No remote snapshots in mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}"
          fi

      - name: Restore Snapshot Directly from WebDAV
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== ä»è¿œç¨‹å¿«ç…§æ¢å¤ï¼š$LATEST_SNAPSHOT ====="
          
          # ä¿®æ­£æ‰€æœ‰ä¸­æ–‡å‘½ä»¤/ç¬¦å·ï¼Œç»Ÿä¸€ä¸ºè‹±æ–‡Shellè¯­æ³•
          sudo systemctl stop docker.service docker.socket || echo "âš ï¸ Docker æœåŠ¡æœªè¿è¡Œï¼Œè·³è¿‡åœæ­¢"
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3
          
          if systemctl is-active --quiet casaos.service; then
            sudo systemctl stop casaos.service
            echo "âœ… åœæ­¢äº†casaos.service"
          else
            echo "âš ï¸ casaos.service æœªåŠ è½½ï¼Œè·³è¿‡åœæ­¢"
          fi
          
          # ä¿®æ­£rcloneå‘½ä»¤å¤§å°å†™ã€è·¯å¾„ç¬¦å·ã€/dev/nullæ‹¼å†™
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "âŒ è¿œç¨‹å¿«ç…§æ— æ•ˆæˆ–æ— æ³•è¯»å–"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
            exit 1
          fi
          
          # æ¢å¤æ—¶ä¿ç•™ç»å¯¹è·¯å¾„ï¼Œé¿å…tarå»é™¤å‰ç¼€å¯¼è‡´è·¯å¾„é”™è¯¯
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --warning=no-all --preserve-permissions $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "âœ… æˆåŠŸä»WebDAVæ¢å¤"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # åˆ é™¤å¿«ç…§æ—¶ä½¿ç”¨æ­£ç¡®çš„rcloneè·¯å¾„æ ¼å¼
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt --config /home/runner/.rclone.conf
            echo "âœ… å·²åˆ é™¤è¿˜åŸå¿«ç…§æ–‡ä»¶ï¼š${LATEST_SNAPSHOT}"
            sudo systemctl unmask docker.socket
          else
            echo "âŒ æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
          fi

      - name: Install CasaOS if No Snapshot Restored
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed successfully"

      - name: Start Services (New Install)
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet docker.socket; then
              echo "âœ… Docker service started successfully"
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl enable --now casaos.service
                sleep 5
                if sudo systemctl is-active --quiet casaos.service; then
                  echo "âœ… CasaOS service started successfully"
                fi
              fi
              exit 0
            fi
            echo "âš ï¸ Docker start attempt $i failed, retrying..."
          done
          echo "âŒ Docker service failed to start"
          exit 1

      - name: Restart Services (From Snapshot)
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker.service docker.socket
          sleep 10
          
          # æ£€æŸ¥DockerçŠ¶æ€
          if sudo systemctl is-active --quiet docker; then
            echo "âœ… Docker æœåŠ¡ä»å¿«ç…§é‡å¯"
          else
            echo "âŒ ä»å¿«ç…§ä¸­ Docker æœåŠ¡é‡å¯å¤±è´¥"
            exit 1
          fi
          
          # ä¼˜åŒ–CasaOSæœåŠ¡é‡å¯é€»è¾‘ï¼šå¢åŠ ç¼ºå¤±æ—¶çš„è¡¥æ•‘æªæ–½
          if systemctl list-unit-files | grep -q casaos.service; then
            sudo systemctl enable --now casaos.service
            sleep 5
            if sudo systemctl is-active --quiet casaos.service; then
              echo "âœ… CasaOS æœåŠ¡ä»å¿«ç…§é‡å¯"
            else
              echo "âš ï¸ CasaOS æœåŠ¡é‡å¯å¤±è´¥ï¼Œå°è¯•é‡å»ºserviceæ–‡ä»¶å¹¶å¯åŠ¨"
              # è¡¥æ•‘ï¼šé‡æ–°å®‰è£…CasaOSçš„serviceæ–‡ä»¶ï¼ˆä¸è¦†ç›–æ•°æ®ï¼‰
              curl -fsSL https://get.casaos.io | sudo bash -s -- --repair
              sudo systemctl daemon-reload
              sudo systemctl enable --now casaos.service
              sleep 5
              if sudo systemctl is-active --quiet casaos.service; then
                echo "âœ… CasaOS æœåŠ¡é€šè¿‡ä¿®å¤è„šæœ¬å¯åŠ¨æˆåŠŸ"
              else
                echo "âŒ CasaOS æœåŠ¡ä¿®å¤åä»æ— æ³•å¯åŠ¨ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
              fi
            fi
          else
            echo "âš ï¸ CasaOS serviceæ–‡ä»¶ç¼ºå¤±ï¼Œå°è¯•é‡å»º"
            curl -fsSL https://get.casaos.io | sudo bash -s -- --repair
            sudo systemctl daemon-reload
            sudo systemctl enable --now casaos.service
            sleep 5
            if sudo systemctl is-active --quiet casaos.service; then
              echo "âœ… CasaOS serviceæ–‡ä»¶é‡å»ºå¹¶å¯åŠ¨æˆåŠŸ"
            else
              echo "âŒ CasaOS serviceæ–‡ä»¶é‡å»ºåä»æ— æ³•å¯åŠ¨"
            fi
          fi

      - name: Deploy Tailscale
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Missing Tailscale auth key, skip deployment"
            exit 0
          fi
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 0644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo chmod 0644 /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y && sudo apt install -y tailscale
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ]; then
            echo "âŒ Tailscale installation failed, no executable found"
            exit 0
          fi
          echo "âœ… Tailscale installed at: $TAILSCALE_PATH"
          if ! sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"; then
            echo "âŒ Tailscale login failed"
            sudo "$TAILSCALE_PATH" status
            exit 0
          fi
          echo "âœ… Tailscale IP address: $(sudo "$TAILSCALE_PATH" ip -4)"
          echo "âœ… Tailscale deployed successfully (no service restart)"

      - name: Create Snapshot and Upload to WebDAV
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ USER_PATæˆ–REPOæ˜¯ç©ºçš„"
              return 1
            fi
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âŒæœªèƒ½è§¦å‘ç»­è®¢æµç¨‹"
              return 1
            fi
            echo "âœ…ç»­è®¢æµç¨‹å·²è§¦å‘"
            RENEW_TRIGGERED=true
            return 0
          }
          
          create_and_upload_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              return 1
            fi
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„åˆ›å»ºå¿«ç…§ï¼š$SNAPSHOT_NAME ï¼ˆä¸Šä¼ åˆ° WebDAVï¼š ${REMOTE_PATH}ï¼‰"
            
            sudo systemctl stop docker.service docker.socket || true
            if systemctl is-active --quiet casaos.service; then
              sudo systemctl stop casaos.service
            fi
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5
            
            for dir in $CORE_DIRS; do
              if [ ! -d "$dir" ]; then
                echo "âš ï¸ç›®å½•$dirä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
              fi
            done
            
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS
            
            sudo chown runner:runner "${TMP_SNAPSHOT}"
            sudo chmod 644 "${TMP_SNAPSHOT}"
            
            if [ ! -f "${TMP_SNAPSHOT}" ] || [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 1024 ]; then
              echo "âŒå¿«ç…§ä¸ºç©ºæˆ–æ— æ•ˆï¼ˆå¤§å°< 1KBï¼‰"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket || true
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl start casaos.service || true
              fi
              return 1
            fi
            
            echo "âœ…å¿«ç…§åˆ›å»ºï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"
            
            if ! sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --header "Content-Type: application/xml;charset=utf-8" \
              --log-level INFO \
              --log-file /tmp/rclone_upload.log; then
              echo "âŒä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼š/tmp/rclone_upload.log"
              cat /tmp/rclone_upload.log || true
              rm -f "${TMP_SNAPSHOT}"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket || true
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl start casaos.service || true
              fi
              return 1
            fi
            
            echo "âœ…å¿«ç…§ä¸Šä¼ è‡³WebDAVï¼š ${REMOTE_PATH}"
            META_FILE="/tmp/snapshot_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf
            rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
            
            echo "âœ…å¿«ç…§ä¸Šä¼ å®Œæˆï¼Œæ— åŸºäºæ—¶é—´çš„æ¸…ç†"
            
            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket || true
            if systemctl list-unit-files | grep -q casaos.service; then
              sudo systemctl start casaos.service || true
            fi
            return 0
          }
          
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Š Workflow running for $run_mins minutes"
            
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Time to create and upload snapshot"
              if create_and_upload_snapshot; then
                trigger_renew
              else
                echo "âŒ Snapshot creation failed, skip renewal"
              fi
            fi
            
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Reached maximum run time, exiting"
              exit 0
            fi
            
            sleep 60
          done

      - name: Cleanup
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket || true
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          echo "âœ… Cleanup completed successfully"
