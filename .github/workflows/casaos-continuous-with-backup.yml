name: CasaOS çº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: "--exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
      KEEP_BACKUPS: "2"
      TARGET_RUN_MINUTES: "60"
      CASA_SERVICES: "casaos-gateway casaos-message-bus casaos-user-service casaos-local-storage casaos-app-management rclone casaos"
      SNAPSHOT_NAME: "casaos-full-snapshot-$(date +%Y%m%d-%H%M%S)-$(hostname | cut -c1-8).tar.gz"

    steps:
      - name: ğŸ”’ å®‰å…¨åˆå§‹åŒ–&ç¯å¢ƒæ ¡éªŒ
        run: |
          set -euo pipefail
          echo "WORKFLOW_START_TIME=$(date +%s)" >> "$GITHUB_ENV"
          # æ•æ„Ÿä¿¡æ¯è„±æ•
          [ -n "${ROOTS_PASSWORD:-}" ] && echo "::add-mask::$ROOTS_PASSWORD"
          [ -n "${WEBDAV_PASSWORD:-}" ] && echo "::add-mask::$WEBDAV_PASSWORD"
          # ä¾èµ–å®‰è£…
          sudo apt update -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # ç£ç›˜ç©ºé—´é¢„æ£€
          echo "ğŸ—‚ï¸  ç£ç›˜ç©ºé—´æ£€æŸ¥"
          df -h / && [ $(df -P / | awk 'NR==2{print $4}' | sed 's/G//') -gt 10 ] || (echo "âŒ æ ¹ç›®å½•ç©ºé—´ä¸è¶³10G" && exit 1)
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ³ å®‰è£… Dockerï¼ˆé˜¿é‡Œäº‘é•œåƒï¼‰
        run: |
          set -euo pipefail
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd
          sudo usermod -aG docker "$USER"
          # æ ¡éªŒDockerçŠ¶æ€
          sudo systemctl is-active --quiet docker || (echo "âŒ Dockerå®‰è£…å¤±è´¥" && exit 1)
          echo "âœ… Docker å®‰è£…å®Œæˆ"

      - name: ğŸ‘¤ åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ· roots
        run: |
          set -euo pipefail
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "${ROOTS_PASSWORD:-}" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 16 | tr -dc 'A-Za-z0-9' | head -c12)
            echo "::add-mask::$RANDOM_PASS"
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ roots ä¸´æ—¶å¯†ç : *** (å·²å±è”½)"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: â˜ï¸ WebDAV é…ç½®ä¸å¿«ç…§æ£€æµ‹
        run: |
          set -euo pipefail
          if [ -z "${WEBDAV_URL:-}" ] || [ -z "${WEBDAV_USER:-}" ] || [ -z "${WEBDAV_PASSWORD:-}" ]; then
            echo "âš ï¸ WebDAV å‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤&è‡ªåŠ¨å¤‡ä»½"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /root/.rclone.conf 2>/dev/null || true
          sudo chmod 600 /root/.rclone.conf
          
          # é‡è¯•åˆ›å»ºè¿œç¨‹ç›®å½•
          for i in {1..3}; do
            if rclone mkdir "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null; then
              echo "âœ… è¿œç¨‹ç›®å½•å°±ç»ª"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾"
              echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
              exit 0
            fi
            sleep 2
          done
          
          # æ£€æµ‹æœ€æ–°å¿«ç…§ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
          LATEST=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | head -1)
          if [ -n "$LATEST" ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å¿«ç…§: $LATEST"
            echo "LATEST_SNAPSHOT=$LATEST" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "â„¹ï¸ æ— å†å²å¿«ç…§"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: ğŸ§¹ æ¸…ç†æ—§ç¯å¢ƒ
        run: |
          set -euo pipefail
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
            sudo systemctl disable "${svc}.service" 2>/dev/null || true
            sudo rm -f "/etc/systemd/system/${svc}.service" "/usr/lib/systemd/system/${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 -f "casaos\|rclone" 2>/dev/null || true
          sudo rm -rf /var/lib/casaos/* /etc/casaos/* 2>/dev/null || true
          sudo systemctl daemon-reload
          echo "âœ… æ—§ç¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: ğŸ“¦ å®‰è£… CasaOS
        run: |
          set -euo pipefail
          curl -fsSL https://get.casaos.io | sudo bash
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          # æ ¡éªŒå®‰è£…ç»“æœ
          [ -f /usr/bin/casaos ] || (echo "âŒ CasaOSå®‰è£…å¤±è´¥" && exit 1)
          echo "âœ… CasaOS å®‰è£…å®Œæˆ"

      - name: ğŸ”„ æ¢å¤æ•°æ®ï¼ˆä»…å½“å­˜åœ¨å¿«ç…§æ—¶ï¼Œä¸åˆ è¿œç¨‹å¿«ç…§ï¼‰
        if: env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true'
        run: |
          set -euo pipefail
          sudo systemctl stop docker containerd 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 docker containerd runc 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 3
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" 2>/dev/null || true
          done
          
          echo "ğŸ”„ æ­£åœ¨æ¢å¤å¿«ç…§: $LATEST_SNAPSHOT"
          # å¿«ç…§å®Œæ•´æ€§é¢„æ£€
          rclone size "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf || (echo "âŒ å¿«ç…§æ–‡ä»¶æŸå" && exit 1)
          # å®‰å…¨è§£å‹
          rclone cat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf | \
            sudo tar -xzf - -C / --overwrite --preserve-permissions --strip-components=0 $PERSONAL_DATA_DIRS 2>&1 | \
            grep -v "Removing leading" || true
          
          # ä¿®å¤æƒé™
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          echo "âœ… å¿«ç…§æ¢å¤å®Œæˆï¼Œè¿œç¨‹å¿«ç…§ä¿ç•™"

      - name: âš™ï¸ å¯åŠ¨æ ¸å¿ƒæœåŠ¡&çŠ¶æ€æ ¡éªŒ
        run: |
          set -euo pipefail
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          
          if [ "${HAS_SNAPSHOT:-false}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          else
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
          fi
          
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd
          sleep 5
          # æ ¡éªŒDockerå¯åŠ¨
          sudo systemctl is-active --quiet docker || (echo "âŒ Dockerå¯åŠ¨å¤±è´¥" && exit 1)
          
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 8
          # æ ¡éªŒCasaOSæ ¸å¿ƒæœåŠ¡
          sudo systemctl is-active --quiet casaos || (echo "âŒ CasaOSå¯åŠ¨å¤±è´¥" && exit 1)
          
          if [ "${HAS_SNAPSHOT:-false}" != "true" ]; then
            LOCAL_IP=$(hostname -I | awk '{print $1}')
            echo "âœ¨ é¦–æ¬¡éƒ¨ç½²å®Œæˆï¼è®¿é—®åœ°å€: http://$LOCAL_IP"
            echo "ğŸ“Œ è¯·é€šè¿‡ CasaOS ç•Œé¢å®Œæˆåˆå§‹åŒ–è®¾ç½®"
          fi
          echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ&æ ¡éªŒé€šè¿‡"

      - name: ğŸŒ Tailscale ç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        if: env.TAILSCALE_AUTH_KEY != ''
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo systemctl enable --now tailscaled
          sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" \
            --hostname="CasaOS-$(hostname | cut -c1-8)" \
            --accept-routes \
            --advertise-exit-node 2>/dev/null || echo "âš ï¸ Tailscale å¯åŠ¨éƒ¨åˆ†åŠŸèƒ½å¤±è´¥ï¼ˆå¯èƒ½éœ€æ‰‹åŠ¨ç¡®è®¤ï¼‰"
          TAIL_IP=$(sudo tailscale ip -4 2>/dev/null || echo "æœªè·å–")
          echo "âœ… Tailscale IP: $TAIL_IP"

      - name: ğŸŒ‰ Cloudflare Tunnelï¼ˆå®‰å…¨ä¿®æ­£ç‰ˆï¼‰
        if: env.CLOUDFLARED_TOKEN != ''
        run: |
          set -euo pipefail
          sudo mkdir -p /usr/local/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/local/share/keyrings/cloudflare.gpg >/dev/null
          echo "deb [signed-by=/usr/local/share/keyrings/cloudflare.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null
          sudo apt update -qq && sudo apt install -y cloudflared -qq
          
          echo "CLOUDFLARED_TOKEN=${CLOUDFLARED_TOKEN}" | sudo tee /etc/default/cloudflared > /dev/null
          sudo chmod 600 /etc/default/cloudflared
          sudo chown root:root /etc/default/cloudflared
          
          sudo tee /etc/systemd/system/cloudflared.service > /dev/null <<'EOF'
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
EnvironmentFile=/etc/default/cloudflared
ExecStart=/usr/bin/cloudflared tunnel run --token $CLOUDFLARED_TOKEN
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=cloudflared

[Install]
WantedBy=multi-user.target
EOF
          
          sudo systemctl daemon-reload
          sudo systemctl enable --now cloudflared
          sleep 8
          
          if sudo systemctl is-active --quiet cloudflared; then
            echo "âœ… Cloudflare Tunnel è¿è¡Œä¸­"
            sudo journalctl -u cloudflared -n 10 --no-pager
          else
            echo "âŒ Tunnel å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: journalctl -u cloudflared"
            exit 1
          fi

      - name: ğŸ“¤ ç”Ÿæˆå¿«ç…§+ä¸Šä¼ WebDAVï¼ˆå¤‡ä»½æ ¸å¿ƒæ­¥éª¤ï¼‰
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          set -euo pipefail
          echo "ğŸ“¦ æ­£åœ¨ç”Ÿæˆæœ€æ–°å¿«ç…§: $SNAPSHOT_NAME"
          # ä¸´æ—¶åœæ­¢éå¿…è¦æœåŠ¡ï¼Œä¿è¯å¿«ç…§å®Œæ•´æ€§
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo systemctl stop docker containerd 2>/dev/null || true
          sync && sleep 3
          
          # æ‰“åŒ…æ ¸å¿ƒç›®å½•ï¼Œæ’é™¤æ— ç”¨æ–‡ä»¶å‡å°ä½“ç§¯
          sudo tar -czf - $EXCLUDE_RULES $PERSONAL_DATA_DIRS 2>/dev/null | \
            rclone rcat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}" --config /root/.rclone.conf
          
          # æ ¡éªŒä¸Šä¼ ç»“æœ
          rclone ls "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}" --config /root/.rclone.conf || (echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥" && exit 1)
          echo "âœ… å¿«ç…§ä¸Šä¼ æˆåŠŸ"
          
          # é‡å¯æœåŠ¡
          sudo systemctl enable --now docker containerd
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 5
          echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"

      - name: ğŸ§¹ è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼ˆä»…ä¿ç•™æœ€æ–°2ä»½ï¼‰
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          set -euo pipefail
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ—§å¤‡ä»½ï¼Œä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
          # æŒ‰æ—¶é—´å€’åºæ’åºï¼Œç­›é€‰å‡ºéœ€åˆ é™¤çš„æ—§å¿«ç…§
          OLD_SNAPSHOTS=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | tail -n +$((KEEP_BACKUPS+1)))
          
          if [ -n "$OLD_SNAPSHOTS" ]; then
            for snap in $OLD_SNAPSHOTS; do
              echo "åˆ é™¤æ—§å¿«ç…§: $snap"
              rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${snap}" --config /root/.rclone.conf 2>/dev/null
            done
            echo "âœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
          else
            echo "â„¹ï¸ å¤‡ä»½æ•°é‡æœªè¶…é™åˆ¶ï¼Œæ— éœ€æ¸…ç†"
          fi

      - name: â±ï¸ å»¶æ—¶æ ¡å‡†ï¼ˆä»…é™è‡ªåŠ¨è§¦å‘ï¼‰
        if: env.WEBDAV_AVAILABLE == 'true' && github.event_name == 'repository_dispatch'
        run: |
          set -euo pipefail
          START_TIME="${WORKFLOW_START_TIME}"
          CURRENT_TIME=$(date +%s)
          CURRENT_DURATION=$((CURRENT_TIME - START_TIME))
          TARGET_DURATION=$((TARGET_RUN_MINUTES * 60))
          WAIT_TIME=$((TARGET_DURATION - CURRENT_DURATION))
          
          if [ $WAIT_TIME -gt 0 ]; then
            echo "â³ ä¸ºæ»¡è¶³æœ€å°è¿è¡Œæ—¶é•¿ï¼Œç­‰å¾… $((WAIT_TIME / 60)) åˆ†é’Ÿ..."
            sleep $WAIT_TIME
            echo "âœ… å»¶æ—¶å®Œæˆ"
          else
            echo "â„¹ï¸ å®é™…è¿è¡Œæ—¶é•¿å·²è¶…ç›®æ ‡ï¼Œè·³è¿‡å»¶æ—¶"
          fi

      - name: ğŸ“Š éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š
        run: |
          echo "========================================"
          echo "âœ… CasaOS éƒ¨ç½²+å¤‡ä»½å…¨æµç¨‹å®Œæˆï¼"
          echo "ğŸ“Œ æ ¸å¿ƒä¿¡æ¯ï¼š"
          echo "   â€¢ æœ¬åœ°è®¿é—®ï¼šhttp://$(hostname -I | awk '{print $1}')"
          echo "   â€¢ Tailscale IPï¼š$(sudo tailscale ip -4 2>/dev/null || echo 'æœªå¯ç”¨')"
          echo "   â€¢ Cloudflare Tunnelï¼š$(systemctl is-active cloudflared || echo 'æœªå¯ç”¨')"
          echo "   â€¢ WebDAVå¤‡ä»½ä¿ç•™ï¼š${KEEP_BACKUPS}ä»½"
          echo "   â€¢ æœ€æ–°å¿«ç…§ï¼š${SNAPSHOT_NAME:-æœªç”Ÿæˆ}"
          echo "========================================"