name: CasaOS-Tailscale-Full-Deploy

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu"
      CORE_BACKUP_DIRS: "/var/lib /DATA"
      # å…¨å±€è¿‡æ»¤æ—¥å¿—/æ— ç”¨æ–‡ä»¶è§„åˆ™ï¼ˆä¿ç•™ï¼‰
      EXCLUDE_DIRS: >-
        # 1. ç³»ç»Ÿçº§æ— ç”¨ç›®å½•
        /var/log /var/log/* /var/cache /var/cache/* /var/backups /var/backups/*
        /tmp/* /var/tmp/* /lost+found /proc /sys /dev /run /mnt /media
        /home/*/.cache /home/*/.bash_history /home/*/.ssh/known_hosts /home/*/.npm
        /home/*/.local/share/trash /home/*/.config/Code/Cache /home/*/.config/Code/CachedData
        # 2. Docker å†—ä½™æ–‡ä»¶
        /var/lib/docker/overlay2/*/home/dependabot /var/lib/docker/overlay2/*/vendor/ruby
        /var/lib/docker/overlay2/*/gems /var/lib/docker/overlay2/*/bundler /var/lib/docker/overlay2/*/faraday
        /var/lib/docker/overlay2/*/opentelemetry /var/lib/docker/tmp /var/lib/docker/buildkit
        /var/lib/docker/runtimes /var/lib/docker/swarm /var/lib/docker/plugins
        /var/lib/docker/containers/*/*.log /var/lib/docker/containers/*/*.log.*
        # 3. å¤‡ä»½/æŒ‚è½½ç›¸å…³
        $WEBDAV_MOUNT_POINT /home/runner /root
      # æ–‡ä»¶åŽç¼€è¿‡æ»¤è§„åˆ™ï¼ˆä¿ç•™ï¼‰
      EXCLUDE_FILES: "*.log *.log.* *.tmp *.swp *.bak *.old *.cache *.trash *.DS_Store"
      MAX_MOUNT_RETRIES: 5
      RETRY_DELAY: 10
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»ŸçŽ¯å¢ƒåˆå§‹åŒ– + åˆ›å»º/DATA ==========
      - name: Step 1 - Initialize System Environment
        run: |
          set -e
          echo "===== Step 1: Install rclone and dependencies ====="
          sudo apt update -y && sudo apt install -y rsync curl wget jq fuse3 || { echo "âŒ Dependency installation failed"; exit 1; }
          
          curl https://rclone.org/install.sh | sudo bash
          if ! command -v rclone &> /dev/null; then
            echo "âŒ rclone installation failed"
            exit 1
          fi
          
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          if ! sudo -n true; then
            echo "âŒ Sudo password-less configuration failed!"
            exit 1
          fi
          sudo mkdir -p /DATA
          sudo chmod 755 /DATA
          echo "âœ… Initialization completed (created /DATA directory)"

      # ========== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ· ==========
      - name: Step 1.5 - Create roots User
        run: |
          set -e
          echo "===== Step 1.5: Create roots user ====="
          if id "roots" &>/dev/null; then
            echo "â„¹ï¸ roots user already exists"
          else
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
              echo "âœ… roots user created with custom password"
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots user created with random password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi
          echo "âœ… Debug user 'roots' is ready"

      # ========== æ­¥éª¤2ï¼šæŒ‚è½½ WebDAV ==========
      - name: Step 2 - Mount WebDAV with rclone
        run: |
          set -e
          echo "===== Step 2: Mount WebDAV via rclone ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets not configured"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          mkdir -p "$WEBDAV_MOUNT_POINT"
          
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="other" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf

          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" --config /home/runner/.rclone.conf --vfs-cache-mode full --daemon-timeout 1h --allow-other --umask 022 --log-file /tmp/rclone.log --log-level ERROR --retries 3 >/dev/null 2>&1 &

          MOUNT_SUCCESS=false
          for i in $(seq 1 $MAX_MOUNT_RETRIES); do
            echo "ðŸ” Checking mount attempt $i/$MAX_MOUNT_RETRIES..."
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              MOUNT_SUCCESS=true
              break
            fi
            sleep $RETRY_DELAY
          done

          if [ "$MOUNT_SUCCESS" = true ]; then
            echo "âœ… rclone WebDAV mount succeeded"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            HAS_ANY_BACKUP=false
            for core_dir in $CORE_BACKUP_DIRS; do
              target_path="$WEBDAV_MOUNT_POINT$core_dir"
              mkdir -p "$target_path"
              if [ -n "$(ls -A "$target_path" 2>/dev/null)" ]; then
                echo "âœ… Valid backup detected: $core_dir"
                key="HAS_$(echo "$core_dir" | tr '/' '_' | tr -d '-')"
                echo "${key}=true" >> "$GITHUB_ENV"
                HAS_ANY_BACKUP=true
              else
                echo "âš ï¸ Empty backup directory: $core_dir"
                key="HAS_$(echo "$core_dir" | tr '/' '_' | tr -d '-')"
                echo "${key}=false" >> "$GITHUB_ENV"
              fi
            done
            echo "HAS_CORE_BACKUP=$HAS_ANY_BACKUP" >> "$GITHUB_ENV"
          else
            echo "âŒ rclone mount failed after $MAX_MOUNT_RETRIES retries"
            cat /tmp/rclone.log || echo "No rclone log found"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      # ========== æ­¥éª¤3ï¼šæ¢å¤æ ¸å¿ƒæ•°æ®ï¼ˆä¿®å¤rsyncæ—¥å¿—å‚æ•°ï¼‰ ==========
      - name: Step 3 - Restore Core Data (/var/lib + /DATA)
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_CORE_BACKUP == 'true' }}
        run: |
          set -e
          echo "===== Step 3: Restore core directories ($CORE_BACKUP_DIRS) ====="
          RESTORE_DONE=true
          
          if ! command -v rsync &> /dev/null; then
            echo "âŒ rsync not found"
            echo "DATA_RESTORED=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # æž„å»ºå…¨å±€æŽ’é™¤å‚æ•°ï¼ˆä¿ç•™ï¼‰
          EXCLUDE_PARAMS=()
          for excl in $EXCLUDE_DIRS; do
            EXCLUDE_PARAMS+=("--exclude=$excl")
          done
          for excl_file in $EXCLUDE_FILES; do
            EXCLUDE_PARAMS+=("--exclude=$excl_file")
          done

          for core_dir in $CORE_BACKUP_DIRS; do
            target_path="$WEBDAV_MOUNT_POINT$core_dir"
            env_key="HAS_$(echo "$core_dir" | tr '/' '_' | tr -d '-')"
            if [ "${!env_key}" = "true" ]; then
              echo "ðŸ”„ Restoring $core_dir from backup..."
              # ========== æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢--log-level=ERRORä¸ºå…¼å®¹æ–¹å¼ ==========
              # --quietï¼šä»…è¾“å‡ºé”™è¯¯ï¼›2>ï¼šå°†stderré‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶ï¼ˆä»…è®°å½•é”™è¯¯ï¼‰
              if ! sudo rsync -a --delete --copy-links --sparse --numeric-ids --quiet \
                  "${EXCLUDE_PARAMS[@]}" "$target_path/" "$core_dir/" \
                  --log-file=/tmp/rsync_restore_$(echo "$core_dir" | tr '/' '_').log 2>/tmp/rsync_restore_$(echo "$core_dir" | tr '/' '_').err.log; then
                echo "âš ï¸ Restore $core_dir failed"
                # è¾“å‡ºé”™è¯¯æ—¥å¿—
                cat /tmp/rsync_restore_$(echo "$core_dir" | tr '/' '_').err.log || echo "No restore error log"
                RESTORE_DONE=false
              else
                echo "âœ… Restore succeeded: $core_dir"
              fi
            fi
          done
          echo "DATA_RESTORED=$RESTORE_DONE" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤4ï¼šå®‰è£… CasaOS ==========
      - name: Step 4 - Install or Skip CasaOS
        run: |
          set -e
          echo "===== Step 4: Install or Skip CasaOS ====="
          CASAOS_DATA_PATH="/var/lib/casaos"
          if [ -d "$CASAOS_DATA_PATH" ] && [ "$DATA_RESTORED" = "true" ]; then
            echo "âœ… CasaOS data restored from $CASAOS_DATA_PATH, skip installation"
          else
            if ! curl -fsSL https://get.casaos.io >/dev/null; then
              echo "âŒ Cannot reach CasaOS install server"
              exit 1
            fi
            curl -fsSL https://get.casaos.io | sudo bash || { 
              echo "âŒ CasaOS installation failed"
              cat /var/log/casaos-install.log || echo "No CasaOS install log"
              exit 1
            }
            echo "âœ… CasaOS installation completed"
          fi

      # ========== æ­¥éª¤5ï¼šå¯åŠ¨æœåŠ¡ ==========
      - name: Step 5 - Start Services
        run: |
          set -e
          echo "===== Step 5: Start Docker + CasaOS ====="
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker casaos
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Services started successfully"
              break
            fi
            echo "âš ï¸ Service startup attempt $i failed, retrying..."
            sudo systemctl restart docker casaos
          done

          if ! sudo systemctl is-active --quiet docker || ! sudo systemctl is-active --quiet casaos; then
            echo "âŒ Service startup failed after retries"
            echo "Docker status: $(sudo systemctl status docker --no-pager)"
            echo "CasaOS status: $(sudo systemctl status casaos --no-pager)"
            exit 1
          fi

      # ========== æ­¥éª¤6ï¼šéƒ¨ç½² Tailscale ==========
      - name: Step 6 - Deploy Tailscale
        run: |
          set -e
          echo "===== Step 6: Deploy Tailscale ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ TAILSCALE_AUTH_KEY not configured, skip networking"
            exit 0
          fi

          curl -fsSL https://tailscale.com/install.sh | sudo bash
          if ! command -v tailscale &> /dev/null; then
            echo "âŒ Tailscale installation failed"
            exit 1
          fi

          for i in $(seq 1 3); do
            sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-runner-${{ github.run_id }}"
            sleep 5
            TAILSCALE_IP=$(sudo tailscale ip -4)
            if [ -n "$TAILSCALE_IP" ]; then
              break
            fi
            echo "âš ï¸ Tailscale connection attempt $i failed"
          done

          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscale connection failed"
            echo "Tailscale log: $(sudo tailscale status)"
            exit 1
          fi
          echo "âœ… Tailscale IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤7ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: Step 7 - Print Access Info
        run: |
          set -e
          echo "===== Step 7: Access Information ====="
          PUBLIC_IP=$(curl -s --max-time 10 ifconfig.me || curl -s --max-time 10 icanhazip.com || echo "Unknown")
          echo "ðŸ”— Public IP: http://$PUBLIC_IP"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "ðŸ”’ Tailscale IP: http://${{ env.TAILSCALE_IP }}"
          fi
          echo "ðŸ‘¤ Debug User: roots (password from secrets or random generated)"
          echo "âš ï¸ Please change CasaOS default password immediately!"

      # ========== æ­¥éª¤8ï¼šä¿æ´» + å¤‡ä»½ï¼ˆä¿®å¤rsyncæ—¥å¿—å‚æ•°ï¼‰ + ç»­è·‘ ==========
      - name: Step 8 - Keep Alive + Backup Core Dirs + Renew
        shell: bash
        run: |
          set -e
          echo "===== Step 8: Keep Alive + Backup $CORE_BACKUP_DIRS + Renew ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          trigger_renew() {
            if [ -n "$USER_PAT" ] && [ -n "$REPO" ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "ðŸ”„ Triggering renew workflow..."
              RESPONSE=$(curl -fsS -X POST -H "Authorization: token $USER_PAT" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/dispatches" \
                -d '{"event_type":"renew_casaos_tailscale"}' 2>&1)
              if [ $? -eq 0 ]; then
                echo "âœ… Renew workflow triggered"
                RENEW_TRIGGERED=true
              else
                echo "âŒ Failed to trigger renew: $RESPONSE"
              fi
            fi
          }
          
          backup_core_dirs() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAV not available, skip backup"
              return 1
            fi
            
            local backup_success=true
            # æž„å»ºå…¨å±€æŽ’é™¤å‚æ•°ï¼ˆä¿ç•™ï¼‰
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=$excl")
            done
            for excl_file in $EXCLUDE_FILES; do
              EXCLUDE_PARAMS+=("--exclude=$excl_file")
            done

            for core_dir in $CORE_BACKUP_DIRS; do
              target_path="$WEBDAV_MOUNT_POINT$core_dir"
              mkdir -p "$target_path"
              echo "ðŸ”„ Backing up $core_dir (filtered logs/temp files)..."
              
              # ========== æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢--log-level=ERRORä¸ºå…¼å®¹æ–¹å¼ ==========
              # --quietï¼šä»…è¾“å‡ºé”™è¯¯ï¼›2>ï¼šå°†é”™è¯¯ä¿¡æ¯é‡å®šå‘åˆ°ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶
              if ! sudo rsync -a --delete --copy-links --sparse --numeric-ids --quiet \
                  "${EXCLUDE_PARAMS[@]}" "$core_dir/" "$target_path/" \
                  --log-file=/tmp/rsync_backup_$(echo "$core_dir" | tr '/' '_').log 2>/tmp/rsync_backup_$(echo "$core_dir" | tr '/' '_').err.log; then
                echo "âŒ Backup failed: $core_dir"
                # ä»…è¾“å‡ºé”™è¯¯æ—¥å¿—
                cat /tmp/rsync_backup_$(echo "$core_dir" | tr '/' '_').err.log || echo "No backup error log"
                backup_success=false
              else
                echo "âœ… Backup completed: $core_dir (filtered useless files)"
              fi
            done

            if [ "$backup_success" = true ]; then
              BACKUP_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              RUNNER_ID="${{ github.run_id }}"
              GITHUB_REPO="${{ github.repository }}"
              WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              
              sudo printf '%s\n' \
                "backup_time=$BACKUP_TIME" \
                "runner_id=$RUNNER_ID" \
                "github_repo=$GITHUB_ENV" \
                "workflow_run_url=$WORKFLOW_URL" \
                "backup_targets=$CORE_BACKUP_DIRS" \
                "excluded_types=logs(*.log), temp(*.tmp), cache, docker redundant files, system garbage" \
                > "$WEBDAV_MOUNT_POINT/backup_info.txt"
              
              echo "âœ… All core directories backup completed (filtered useless files)"
              return 0
            else
              echo "âŒ Partial backup failed"
              return 1
            fi
          }
          
          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "ðŸ“Š Running for $run_mins/$MAX_RUN_MINUTES minutes"
            
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Running for 10 minutes, starting filtered backup and renew..."
              if backup_core_dirs; then
                trigger_renew
              fi
            fi
            
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Reached $MAX_RUN_MINUTES minutes limit, exiting"
              exit 0
            fi
            
            sleep 60
          done

      # ========== æ­¥éª¤9ï¼šæ¸…ç†çŽ¯å¢ƒ ==========
      - name: Step 9 - Cleanup Environment
        if: ${{ always() }}
        run: |
          set -e
          echo "===== Step 9: Cleanup ====="
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null
          fi
          sudo rm -rf /tmp/* /var/tmp/* /home/runner/.rclone.conf 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/runner 2>/dev/null || true
          echo "âœ… Cleanup completed"
