name: CasaOS-Tailscale-ç®€å•éƒ¨ç½²

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    
    env:
      # æ ¸å¿ƒé…ç½®
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /mnt/webdav
      WEBDAV_REMOTE_PATH: /z/Ubu
      
      # WebDAV é…ç½®
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      
      # GitHub é…ç½®
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ github.repository }}
      
      # Tailscale é…ç½®
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      
      # å¤‡ä»½é…ç½®
      BACKUP_COMPRESSION: zstd
      SNAPSHOT_RETENTION: 3
      
      # è°ƒè¯•ç”¨æˆ·
      DEBUG_USER: roots
      DEBUG_PASSWORD: roots1234
      
      # æŒ‚è½½é…ç½®
      MAX_MOUNT_RETRIES: 3
      RETRY_DELAY: 15

    steps:
      - name: æ­¥éª¤1 - ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        run: |
          echo "===== æ­¥éª¤1: ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ====="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          sudo apt update -y
          sudo apt install -y curl wget git jq tar gzip zstd rsync fuse3 psmisc net-tools iputils-ping ca-certificates lsb-release
          echo "å®‰è£… rclone..."
          curl -s https://rclone.org/install.sh | sudo bash
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo mkdir -p ${{ env.WEBDAV_MOUNT_POINT }}
          sudo chmod 777 ${{ env.WEBDAV_MOUNT_POINT }}
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      - name: æ­¥éª¤2 - åˆ›å»ºè°ƒè¯•ç”¨æˆ·
        run: |
          echo "===== æ­¥éª¤2: åˆ›å»ºè°ƒè¯•ç”¨æˆ· ====="
          if id "${{ env.DEBUG_USER }}" &>/dev/null; then
            echo "ç”¨æˆ·å·²å­˜åœ¨ï¼Œä¿®æ”¹å¯†ç "
            echo "${{ env.DEBUG_USER }}:${{ env.DEBUG_PASSWORD }}" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "${{ env.DEBUG_USER }}"
            echo "${{ env.DEBUG_USER }}:${{ env.DEBUG_PASSWORD }}" | sudo chpasswd
            sudo usermod -aG sudo "${{ env.DEBUG_USER }}"
          fi
          echo "âœ… è°ƒè¯•ç”¨æˆ·åˆ›å»ºå®Œæˆ"

      - name: æ­¥éª¤3 - æŒ‚è½½ WebDAV
        id: mount_webdav
        run: |
          echo "===== æ­¥éª¤3: æŒ‚è½½ WebDAV ====="
          if [ -z "${{ secrets.WEBDAV_URL }}" ] || [ -z "${{ secrets.WEBDAV_USER }}" ] || [ -z "${{ secrets.WEBDAV_PASSWORD }}" ]; then
            echo "âŒ WebDAV å‡­æ®æœªé…ç½®"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          # ä¿®æ­£ï¼šæ­£ç¡®æ‹¼æ¥URLè·¯å¾„
          WEBDAV_FULL_URL="${{ secrets.WEBDAV_URL }}${{ env.WEBDAV_REMOTE_PATH }}"
          echo "WebDAVå®Œæ•´URL: $WEBDAV_FULL_URL"
          
          cat > /tmp/rclone.conf <<EOF
[webdav]
type = webdav
url = $WEBDAV_FULL_URL
vendor = other
user = ${{ secrets.WEBDAV_USER }}
pass = ${{ secrets.WEBDAV_PASSWORD }}
EOF
          echo "æµ‹è¯• WebDAV è¿æ¥..."
          if rclone lsd webdav: --config=/tmp/rclone.conf; then
            echo "âœ… WebDAV è¿æ¥æˆåŠŸ"
          else
            echo "âŒ WebDAV è¿æ¥å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          echo "æŒ‚è½½ WebDAV..."
          rclone mount webdav: "${{ env.WEBDAV_MOUNT_POINT }}" \
            --config=/tmp/rclone.conf \
            --vfs-cache-mode writes \
            --allow-other \
            --daemon \
            --log-level INFO \
            --log-file /tmp/rclone.log
          sleep 5
          if mountpoint -q "${{ env.WEBDAV_MOUNT_POINT }}"; then
            echo "âœ… WebDAV æŒ‚è½½æˆåŠŸ"
            echo "WEBDAV_AVAILABLE=true" >> $GITHUB_ENV
            mkdir -p "${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
          else
            echo "âŒ WebDAV æŒ‚è½½å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: æ­¥éª¤4 - æ™ºèƒ½æ¢å¤ç³»ç»ŸçŠ¶æ€
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          echo "===== æ­¥éª¤4: æ™ºèƒ½æ¢å¤ç³»ç»ŸçŠ¶æ€ ====="
          find_snapshot() {
            local snapshot_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
            if [ -d "$snapshot_dir" ]; then
              find "$snapshot_dir" -maxdepth 1 -type d -name "2*" 2>/dev/null | sort -r | head -1
            fi
          }
          LATEST_SNAPSHOT=$(find_snapshot)
          if [ -n "$LATEST_SNAPSHOT" ] && [ -f "$LATEST_SNAPSHOT/snapshot_info.json" ]; then
            echo "æ‰¾åˆ°å¿«ç…§: $(basename $LATEST_SNAPSHOT)"
            SNAPSHOT_INFO=$(cat "$LATEST_SNAPSHOT/snapshot_info.json")
            SNAPSHOT_TIME=$(echo "$SNAPSHOT_INFO" | jq -r '.timestamp' 2>/dev/null || echo "æœªçŸ¥")
            echo "å¿«ç…§æ—¶é—´: $SNAPSHOT_TIME"
            sudo systemctl stop casaos docker 2>/dev/null || true
            restore_from_tar() {
              local tar_file="$1"
              local target_dir="$2"
              if [ -f "$tar_file" ]; then
                echo "æ¢å¤: $(basename $tar_file)"
                if [[ "$tar_file" == *.zst ]]; then
                  sudo tar -I 'zstd -d' -xf "$tar_file" -C "$target_dir" 2>/dev/null && return 0 || return 1
                elif [[ "$tar_file" == *.gz ]]; then
                  sudo tar -xzf "$tar_file" -C "$target_dir" 2>/dev/null && return 0 || return 1
                fi
              fi
              return 1
            }
            DOCKER_RESTORED=false
            if restore_from_tar "$LATEST_SNAPSHOT/docker_state.tar.${{ env.BACKUP_COMPRESSION }}" "/"; then
              echo "âœ… Docker æ•°æ®æ¢å¤æˆåŠŸ"
              DOCKER_RESTORED=true
            else
              echo "âŒ Docker æ•°æ®æ¢å¤å¤±è´¥"
            fi
            CASAOS_RESTORED=false
            if restore_from_tar "$LATEST_SNAPSHOT/casaos_state.tar.${{ env.BACKUP_COMPRESSION }}" "/"; then
              echo "âœ… CasaOS æ•°æ®æ¢å¤æˆåŠŸ"
              CASAOS_RESTORED=true
            else
              echo "âŒ CasaOS æ•°æ®æ¢å¤å¤±è´¥"
            fi
            # ä¿®æ­£ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
            if [ "$DOCKER_RESTORED" = "true" ] || [ "$CASAOS_RESTORED" = "true" ]; then
              echo "âœ… ç³»ç»ŸçŠ¶æ€æ¢å¤å®Œæˆ"
              echo "RESTORED_FROM_BACKUP=true" >> $GITHUB_ENV
            else
              echo "âŒ ç³»ç»ŸçŠ¶æ€æ¢å¤å¤±è´¥"
              echo "RESTORED_FROM_BACKUP=false" >> $GITHUB_ENV
            fi
          else
            echo "æœªæ‰¾åˆ°å¯ç”¨å¿«ç…§"
            echo "RESTORED_FROM_BACKUP=false" >> $GITHUB_ENV
          fi

      - name: æ­¥éª¤5 - å®‰è£… CasaOS
        run: |
          echo "===== æ­¥éª¤5: å®‰è£… CasaOS ====="
          if [ "$RESTORED_FROM_BACKUP" = "true" ]; then
            echo "âœ… å·²ä»å¤‡ä»½æ¢å¤ï¼ŒéªŒè¯ç»„ä»¶..."
            if ! command -v docker &>/dev/null; then
              echo "ğŸ³ å®‰è£… Docker..."
              curl -fsSL https://get.docker.com | sudo bash
            else
              echo "âœ… Docker å·²å®‰è£…"
            fi
            if [ ! -f "/usr/local/bin/casaos" ]; then
              echo "ğŸ  å®‰è£… CasaOS..."
              curl -fsSL https://get.casaos.io | sudo bash
            else
              echo "âœ… CasaOS å·²å®‰è£…"
            fi
          else
            echo "ğŸ†• æ‰§è¡Œå…¨æ–°å®‰è£…..."
            curl -fsSL https://get.docker.com | sudo bash
            curl -fsSL https://get.casaos.io | sudo bash
          fi
          sudo systemctl daemon-reload
          sudo systemctl enable docker casaos
          sudo systemctl start docker
          sleep 10
          sudo systemctl start casaos
          for i in $(seq 1 30); do
            if curl -s http://localhost:80 &>/dev/null; then
              echo "âœ… CasaOS Web ç•Œé¢å¯è®¿é—®"
              break
            fi
            sleep 2
          done
          echo "ğŸ“Š å®‰è£…éªŒè¯:"
          echo "  ğŸ³ Docker: $(docker --version 2>/dev/null || echo 'æœªå®‰è£…')"
          echo "  ğŸ  CasaOS: $(sudo casaos version 2>/dev/null || echo 'æœªå®‰è£…')"

      - name: æ­¥éª¤6 - éƒ¨ç½² Tailscale
        run: |
          echo "===== æ­¥éª¤6: éƒ¨ç½² Tailscale ====="
          if [ -z "${{ secrets.TAILSCALE_AUTH_KEY }}" ] || [ "${{ secrets.TAILSCALE_AUTH_KEY }}" = "" ]; then
            echo "âš ï¸ æœªé…ç½® TAILSCALE_AUTH_KEYï¼Œè·³è¿‡ç»„ç½‘"
            echo "TAILSCALE_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --accept-routes \
            --hostname="casaos-runner-${{ github.run_id }}" \
            --accept-dns=false \
            --reset
          sleep 5
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "")
          if [ -n "$TAILSCALE_IP" ]; then
            echo "âœ… Tailscale è¿æ¥æˆåŠŸ"
            echo "ğŸŒ Tailscale IP: $TAILSCALE_IP"
            echo "TAILSCALE_CONNECTED=true" >> $GITHUB_ENV
            echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          else
            echo "âŒ Tailscale è¿æ¥å¤±è´¥"
            echo "TAILSCALE_CONNECTED=false" >> $GITHUB_ENV
          fi

      - name: æ­¥éª¤7 - è®¿é—®ä¿¡æ¯
        run: |
          echo "===== æ­¥éª¤7: è®¿é—®ä¿¡æ¯ ====="
          PUBLIC_IP=$(curl -s --max-time 3 https://api.ipify.org || echo "æœªçŸ¥")
          LOCAL_IP=$(hostname -I | awk '{print $1}' 2>/dev/null || echo "æœªçŸ¥")
          echo "========================================"
          echo "ğŸ‰ CasaOS éƒ¨ç½²å®Œæˆ"
          echo "========================================"
          echo ""
          echo "ğŸŒ å…¬ç½‘è®¿é—®: http://$PUBLIC_IP"
          echo "ğŸ  æœ¬åœ°è®¿é—®: http://$LOCAL_IP"
          echo ""
          if [ "$TAILSCALE_CONNECTED" = "true" ]; then
            echo "ğŸ”’ Tailscale è®¿é—®:"
            echo "  http://$TAILSCALE_IP"
            echo "  http://casaos-runner-${{ github.run_id }}.tailscale"
            echo ""
          fi
          echo "ğŸ”§ ç®¡ç†è®¿é—®:"
          echo "  SSH: ssh ${{ env.DEBUG_USER }}@$LOCAL_IP"
          echo "  å¯†ç : ${{ env.DEBUG_PASSWORD }}"
          echo ""
          echo "ğŸ“Š ç³»ç»ŸçŠ¶æ€:"
          echo "  ğŸ³ Docker: $(systemctl is-active docker 2>/dev/null || echo 'unknown')"
          echo "  ğŸ  CasaOS: $(systemctl is-active casaos 2>/dev/null || echo 'unknown')"
          echo "  ğŸ’¾ æ•°æ®æ¥æº: $([ \"$RESTORED_FROM_BACKUP\" = \"true\" ] && echo 'ä»å¤‡ä»½æ¢å¤' || echo 'å…¨æ–°å®‰è£…')"
          echo "  â° å¤‡ä»½è®¡åˆ’: 300åˆ†é’Ÿæ—¶æ‰§è¡Œå®Œæ•´å¤‡ä»½"
          echo ""
          echo "âš ï¸ é‡è¦æç¤º:"
          echo "  1. ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
          echo "  2. é€šè¿‡ Tailscale è®¿é—®æ›´å®‰å…¨"
          echo "========================================"

      - name: æ­¥éª¤8 - å®Œæ•´å¤‡ä»½ä¸ç»­æœŸ
        run: |
          echo "===== æ­¥éª¤8: å®Œæ•´å¤‡ä»½ä¸ç»­æœŸ ====="
          START_TIME=$(date +%s)
          SNAPSHOT_RETENTION=${{ env.SNAPSHOT_RETENTION }}
          MAX_RUN_MINUTES=${{ env.MAX_RUN_MINUTES }}
          BACKUP_COMPRESSION=${{ env.BACKUP_COMPRESSION }}
          BACKUP_DONE=false
          
          full_backup() {
            local timestamp=$(date +%Y%m%d_%H%M%S)
            local backup_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots/$timestamp"
            echo "ğŸ’¾ æ‰§è¡Œå®Œæ•´å¤‡ä»½..."
            mkdir -p "$backup_dir"
            echo "â¸ï¸ åœæ­¢ Docker å’Œ CasaOS æœåŠ¡..."
            sudo systemctl stop casaos docker 2>/dev/null || true
            sleep 5
            echo "ğŸ³ å¤‡ä»½ Docker æ•°æ®..."
            # ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„æ’é™¤è·¯å¾„æ ¼å¼
            if [ "$BACKUP_COMPRESSION" = "zstd" ]; then
              sudo tar -I 'zstd -T0 -3' -cf "$backup_dir/docker_state.tar.zst" \
                /var/lib/docker /etc/docker \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" --exclude="/var/lib/docker/tmp" 2>/dev/null
            else
              sudo tar -czf "$backup_dir/docker_state.tar.gz" \
                /var/lib/docker /etc/docker \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" --exclude="/var/lib/docker/tmp" 2>/dev/null
            fi
            echo "ğŸ  å¤‡ä»½ CasaOS æ•°æ®..."
            if [ "$BACKUP_COMPRESSION" = "zstd" ]; then
              sudo tar -I 'zstd -T0 -3' -cf "$backup_dir/casaos_state.tar.zst" \
                /var/lib/casaos /etc/casaos /usr/local/bin/casaos* \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" 2>/dev/null
            else
              sudo tar -czf "$backup_dir/casaos_state.tar.gz" \
                /var/lib/casaos /etc/casaos /usr/local/bin/casaos* \
                --exclude="*.log" --exclude="*.tmp" --exclude="*.cache" 2>/dev/null
            fi
            echo "â–¶ï¸ é‡æ–°å¯åŠ¨æœåŠ¡..."
            sudo systemctl start docker
            sleep 5
            sudo systemctl start casaos
            # åˆ›å»ºæ¢å¤è„šæœ¬
            cat > "$backup_dir/restore.sh" <<'RESTORE_EOF'
#!/bin/bash
echo "æ¢å¤ CasaOS ç³»ç»Ÿ..."
if [ -f "casaos_state.tar.gz" ]; then
  tar -xzf casaos_state.tar.gz -C / 2>/dev/null
fi
if [ -f "docker_state.tar.gz" ]; then
  tar -xzf docker_state.tar.gz -C / 2>/dev/null
fi
if [ -f "casaos_state.tar.zst" ]; then
  tar -I 'zstd -d' -xf casaos_state.tar.zst -C / 2>/dev/null
fi
if [ -f "docker_state.tar.zst" ]; then
  tar -I 'zstd -d' -xf docker_state.tar.zst -C / 2>/dev/null
fi
echo "æ¢å¤å®Œæˆ"
RESTORE_EOF
            chmod +x "$backup_dir/restore.sh"
            # åˆ›å»ºå¿«ç…§ä¿¡æ¯æ–‡ä»¶
            cat > "$backup_dir/snapshot_info.json" <<'JSON_EOF'
{
  "timestamp": "TIMESTAMP_PLACEHOLDER",
  "type": "full_backup",
  "runner_id": "RUNNER_ID_PLACEHOLDER",
  "components": {
    "docker": true,
    "casaos": true
  },
  "system_info": {
    "distro": "DISTRO_PLACEHOLDER",
    "kernel": "KERNEL_PLACEHOLDER",
    "arch": "ARCH_PLACEHOLDER"
  }
}
JSON_EOF
            # æ›¿æ¢å ä½ç¬¦
            sed -i "s/TIMESTAMP_PLACEHOLDER/$(date -u +"%Y-%m-%dT%H:%M:%SZ")/g" "$backup_dir/snapshot_info.json"
            sed -i "s/RUNNER_ID_PLACEHOLDER/${{ github.run_id }}/g" "$backup_dir/snapshot_info.json"
            sed -i "s/DISTRO_PLACEHOLDER/$(lsb_release -ds 2>/dev/null | sed 's/"/\\"/g' || echo "unknown")/g" "$backup_dir/snapshot_info.json"
            sed -i "s/KERNEL_PLACEHOLDER/$(uname -r)/g" "$backup_dir/snapshot_info.json"
            sed -i "s/ARCH_PLACEHOLDER/$(uname -m)/g" "$backup_dir/snapshot_info.json"
            echo "âœ… å®Œæ•´å¤‡ä»½å®Œæˆ: $backup_dir"
            if [ -f "$backup_dir/docker_state.tar.$BACKUP_COMPRESSION" ] && [ -f "$backup_dir/casaos_state.tar.$BACKUP_COMPRESSION" ]; then
              echo "âœ… å¤‡ä»½æ–‡ä»¶éªŒè¯æˆåŠŸ"
              return 0
            else
              echo "âŒ å¤‡ä»½æ–‡ä»¶éªŒè¯å¤±è´¥"
              return 1
            fi
          }
          cleanup_old_backups() {
            local snapshot_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
            if [ -d "$snapshot_dir" ]; then
              echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼Œä¿ç•™æœ€è¿‘ $SNAPSHOT_RETENTION ä¸ª..."
              ls -1t "$snapshot_dir" 2>/dev/null | tail -n +$((SNAPSHOT_RETENTION + 1)) | while read old; do
                echo "åˆ é™¤æ—§å¤‡ä»½: $old"
                rm -rf "$snapshot_dir/$old"
              done
            fi
          }
          trigger_renewal() {
            if [ -z "${{ secrets.USER_PAT }}" ] || [ -z "${{ github.repository }}" ]; then
              echo "âŒ æœªé…ç½® USER_PATï¼Œæ— æ³•è§¦å‘ç»­æœŸ"
              return 1
            fi
            echo "ğŸ”„ è§¦å‘å·¥ä½œæµç»­æœŸ..."
            for i in 1 2 3; do
              echo "å°è¯• $i/3"
              response=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: token ${{ secrets.USER_PAT }}" \
                "https://api.github.com/repos/${{ github.repository }}/dispatches" \
                -d '{"event_type": "renew_casaos_tailscale"}')
              if [ "$response" = "204" ]; then
                echo "âœ… ç»­æœŸè§¦å‘æˆåŠŸ"
                return 0
              fi
              sleep 10
            done
            echo "âŒ ç»­æœŸè§¦å‘å¤±è´¥"
            return 1
          }
          echo "â° ç­‰å¾…300åˆ†é’Ÿåæ‰§è¡Œå¤‡ä»½..."
          echo "ğŸ“… å¤‡ä»½å°†åœ¨ $(date -d '+300 minutes' '+%H:%M:%S') æ‰§è¡Œ"
          
          # ä¿®æ­£ï¼šä¿®å¤æ— é™å¾ªç¯é€»è¾‘
          while [ $(( ($(date +%s) - START_TIME) / 60 )) -lt $MAX_RUN_MINUTES ]; do
            CURRENT_TIME=$(date +%s)
            RUN_MINUTES=$(( (CURRENT_TIME - START_TIME) / 60 ))
            RUN_SECONDS=$(( CURRENT_TIME - START_TIME ))
            REMAINING_MINUTES=$(( MAX_RUN_MINUTES - RUN_MINUTES ))
            
            echo "â±ï¸  è¿è¡Œ: ${RUN_MINUTES}åˆ†é’Ÿ | å‰©ä½™: ${REMAINING_MINUTES}åˆ†é’Ÿ"
            
            # æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å¤‡ä»½æ—¶é—´ä¸”æœªæ‰§è¡Œå¤‡ä»½
            if [ $RUN_MINUTES -ge 300 ] && [ "$BACKUP_DONE" = "false" ]; then
              echo "ğŸš¨ åˆ°è¾¾300åˆ†é’Ÿï¼Œæ‰§è¡Œå®Œæ•´å¤‡ä»½..."
              if full_backup; then
                echo "âœ… å¤‡ä»½å®Œæˆï¼Œè§¦å‘ç»­æœŸ..."
                BACKUP_DONE=true
                cleanup_old_backups
                if trigger_renewal; then
                  echo "ğŸ‰ æ–°å·¥ä½œæµå·²è§¦å‘"
                fi
              else
                echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œå°è¯•é‡è¯•..."
                sleep 30
                if full_backup; then
                  echo "âœ… é‡è¯•å¤‡ä»½æˆåŠŸï¼Œè§¦å‘ç»­æœŸ..."
                  BACKUP_DONE=true
                  cleanup_old_backups
                  trigger_renewal
                else
                  echo "âŒ é‡è¯•å¤‡ä»½å¤±è´¥ï¼Œè·³è¿‡ç»­æœŸ"
                  BACKUP_DONE=true
                fi
              fi
              echo "â³ å½“å‰å·¥ä½œæµå°†ç»§ç»­è¿è¡Œåˆ°360åˆ†é’Ÿè¶…æ—¶..."
            fi
            
            # æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if [ $RUN_MINUTES -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ å·¥ä½œæµè¶…æ—¶ï¼Œé€€å‡º"
              exit 0
            fi
            
            # ç­‰å¾…1åˆ†é’Ÿåå†æ¬¡æ£€æŸ¥
            sleep 60
          done

      - name: æ­¥éª¤9 - æ¸…ç†ç¯å¢ƒ
        if: always()
        run: |
          echo "===== æ­¥éª¤9: æ¸…ç†ç¯å¢ƒ ====="
          fusermount -u "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/*
          echo "æ¸…ç†å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"
