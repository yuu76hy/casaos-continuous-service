name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç†+è¿›åº¦æ¡+åœè¿›ç¨‹å¤‡ä»½ æé€Ÿå®Œæ•´ç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      # ã€ä¿®å¤1ã€‘ä¿®æ­£GitHub Actionså˜é‡å¼•ç”¨è¯­æ³•ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼ï¼Œè§„èŒƒä¸º${{ secrets.XXX }}ç´§å‡‘æ ¼å¼
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      BACKUP_TRIGGER_MINS: 10

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæç®€ç‰ˆï¼‰
        run: |
          set -e
          echo "===== ç³»ç»Ÿå¿«é€Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: 2-å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆå«composeï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          newgrp docker
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      - name: 3-åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆä¿®å¤sudoersæ ¡éªŒé—®é¢˜ï¼‰
        run: |
          set -e
          echo "===== åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          # ã€ä¿®å¤2ã€‘ä¿®æ­£Shellå˜é‡å¼•ç”¨ï¼Œç§»é™¤$ä¸{ä¹‹é—´å¤šä½™ç©ºæ ¼ï¼Œè§„èŒƒä¸º${USER_NAME}
          id -u "${USER_NAME}" &>/dev/null || sudo useradd -m -s /bin/bash "${USER_NAME}"
          if [ -n "${ROOTS_PASSWORD}" ];then
            echo "${USER_NAME}:${ROOTS_PASSWORD}" | sudo chpasswd
          else
            # ã€ä¿®å¤3ã€‘ä¿®æ­£å‘½ä»¤æ›¿æ¢è¯­æ³•ï¼Œç§»é™¤$ä¸(ä¹‹é—´å¤šä½™ç©ºæ ¼ï¼Œè§„èŒƒä¸º$(command)
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "${USER_NAME}:${RANDOM_PASS}" | sudo chpasswd
            echo "ğŸ”‘ rootséšæœºå¯†ç ï¼š${RANDOM_PASS}"
          fi
          echo "${USER_NAME} ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"${USER_NAME}" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"${USER_NAME}"
          # ã€å…³é”®ä¿®å¤ã€‘åªæ ¡éªŒè‡ªå®šä¹‰çš„rootsé…ç½®æ–‡ä»¶ï¼Œé¿å…å—è¿è¡Œå™¨é»˜è®¤runneræ–‡ä»¶æƒé™å¹²æ‰°
          # æ›¿æ¢åŸå…¨é‡æ ¡éªŒå‘½ä»¤sudo visudo -cï¼Œè§£å†³exit code 1é—®é¢˜
          sudo visudo -c -f /etc/sudoers.d/"${USER_NAME}"
          sudo usermod -aG docker "${USER_NAME}"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 4-WebDAVé…ç½®+å¿«ç…§æ£€æµ‹+ç›®å½•é¢„åˆ›å»º
        run: |
          set -e
          echo "===== WebDAVé…ç½®&å¿«ç…§æ£€æµ‹&ç›®å½•é¢„åˆ›å»º ====="
          if [ -z "${WEBDAV_URL}" ] || [ -z "${WEBDAV_USER}" ] || [ -z "${WEBDAV_PASSWORD}" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤"
            # ã€ä¿®å¤4ã€‘ä¿®æ­£$GITHUB_ENVå¼•ç”¨ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼å’Œå†—ä½™å¼•å·ï¼Œè§„èŒƒä¸º${GITHUB_ENV}
            echo "WEBDAV_AVAILABLE=false" >> "${GITHUB_ENV}"
            echo "HAS_SNAPSHOT=false" >> "${GITHUB_ENV}"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "${WEBDAV_PASSWORD}")
          rclone config create mywebdav webdav url="${WEBDAV_URL}" user="${WEBDAV_USER}" pass="${ENCRYPTED_PASS}" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          # ã€ä¿®å¤5ã€‘ä¿®æ­£è·¯å¾„æ‹¼æ¥ï¼Œç§»é™¤$ä¸{ä¹‹é—´å¤šä½™ç©ºæ ¼ï¼Œè§„èŒƒä¸º${WEBDAV_SNAPSHOT_DIR}
          if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf; then
            echo "âš ï¸ è¿œç¨‹ç›®å½•åˆ›å»ºå¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"
            if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf; then
              echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾ï¼Œè·³è¿‡å¤‡ä»½ç›¸å…³æ“ä½œ"
              echo "WEBDAV_AVAILABLE=false" >> "${GITHUB_ENV}"
              echo "HAS_SNAPSHOT=false" >> "${GITHUB_ENV}"
              exit 0
            fi
          fi
          echo "âœ… è¿œç¨‹å¤‡ä»½ç›®å½•å°±ç»ª"
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "${REMOTE_SNAPSHOTS}" ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å¿«ç…§ï¼š${REMOTE_SNAPSHOTS}"
            echo "LATEST_SNAPSHOT=${REMOTE_SNAPSHOTS}" >> "${GITHUB_ENV}"
            echo "HAS_SNAPSHOT=true" >> "${GITHUB_ENV}"
          else
            echo "âœ… é¦–æ¬¡éƒ¨ç½²ï¼Œæ— å†å²å¿«ç…§ï¼Œå°†çº¯å‡€å¯åŠ¨"
            echo "HAS_SNAPSHOT=false" >> "${GITHUB_ENV}"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "${GITHUB_ENV}"

      - name: 5-çº¯å‡€å®‰è£…CasaOSï¼ˆä»…ç¨‹åºæ— æ•°æ®ï¼‰
        run: |
          set -e
          echo "===== çº¯å‡€å®‰è£…CasaOS ====="
          sudo systemctl restart docker containerd && sleep 2
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOSçº¯å‡€å®‰è£…å®Œæˆï¼Œå¾…å¯åŠ¨é…ç½®"

      - name: 6-æ¢å¤ä¸ªäººæ•°æ®ï¼ˆæ— å¿«ç…§è‡ªåŠ¨è·³è¿‡ï¼Œæ¢å¤åæ— æ®‹ç•™ï¼‰
        # ã€ä¿®å¤6ã€‘ä¿®æ­£GitHub Actionsæ¡ä»¶è¡¨è¾¾å¼ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼ï¼Œä¿æŒ${{ ... }}ç´§å‡‘æ ¼å¼
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== ç²¾å‡†æ¢å¤ä¸ªäººæ•°æ®ï¼Œæ¢å¤åæ— æ®‹ç•™ ====="
          # ä¼˜é›…åœæœåŠ¡ï¼Œé¿å…æ–‡ä»¶å ç”¨
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sleep 3
          sudo pkill -9 casaos docker dockerd containerd containerd-shim 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          # é¢„åˆ›å»ºç›®å½•ï¼Œé˜²æ­¢è§£å‹æŠ¥é”™
          sudo mkdir -p ${PERSONAL_DATA_DIRS} 2>/dev/null || true
          echo "ğŸ“Œ æ¢å¤ç›®å½•æ¸…å•ï¼š${PERSONAL_DATA_DIRS}"
          # ä¸´æ—¶ä¸‹è½½å¿«ç…§åˆ°æœ¬åœ°ï¼Œè§£å‹åç«‹å³åˆ é™¤ï¼Œé¿å…æ®‹ç•™
          TEMP_SNAPSHOT="/tmp/${LATEST_SNAPSHOT}"
          echo "ğŸ“Œ ä¸‹è½½è¿œç¨‹å¿«ç…§åˆ°æœ¬åœ°ä¸´æ—¶ç›®å½•"
          # ã€è¡¥å……ä¿®å¤ã€‘æ”¹ç”¨rclone copytoï¼ˆæ–‡ä»¶åˆ°æ–‡ä»¶å¤åˆ¶ï¼‰ï¼Œé¿å…è·¯å¾„è§£æé”™è¯¯ï¼Œæé«˜ä¸‹è½½æˆåŠŸç‡
          if ! rclone copyto mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} ${TEMP_SNAPSHOT} --config /home/runner/.rclone.conf --progress; then
            echo "âŒ å¿«ç…§ä¸‹è½½å¤±è´¥"
            sudo rm -f ${TEMP_SNAPSHOT} 2>/dev/null
            exit 1
          fi
          # è§£å‹æ¢å¤ï¼Œä¿ç•™æƒé™å¹¶è¦†ç›–
          # ã€ä¿®å¤7ã€‘ä¿®æ­£Tarå‘½ä»¤ï¼Œç§»é™¤PERSONAL_DATA_DIRSçš„å¤šä½™å¼•å·ï¼Œç¡®ä¿å¤šè·¯å¾„è§£ææ­£ç¡®
          if ! sudo tar -xzf ${TEMP_SNAPSHOT} -C / --overwrite --preserve-permissions ${PERSONAL_DATA_DIRS}; then
            echo "âŒ æ•°æ®æ¢å¤å¤±è´¥"
            sudo rm -f ${TEMP_SNAPSHOT} 2>/dev/null
            exit 1
          fi
          # æ¢å¤æˆåŠŸï¼Œç«‹å³åˆ é™¤æœ¬åœ°ä¸´æ—¶å¿«ç…§æ–‡ä»¶ï¼Œæ— æ®‹ç•™
          sudo rm -f ${TEMP_SNAPSHOT} 2>/dev/null
          echo "âœ… æœ¬åœ°ä¸´æ—¶å¿«ç…§å·²åˆ é™¤ï¼Œæ— æ®‹ç•™"
          # æƒé™æ ¡æ­£ï¼Œç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ
          sudo chown -R root:root ${PERSONAL_DATA_DIRS}
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼Œæƒé™æ ¡æ­£å®Œæ¯•ï¼Œæ— ä»»ä½•æ®‹ç•™æ–‡ä»¶"

      - name: 7-æƒé™æ ¡æ­£+æé€Ÿå¯åŠ¨æ‰€æœ‰æœåŠ¡
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£+å¯åŠ¨æœåŠ¡ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/docker /DATA 2>/dev/null || true
          sudo chown -R root:root ${PERSONAL_DATA_DIRS}
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ"
          echo "ğŸ“Œ è®¿é—®åœ°å€ï¼šæœåŠ¡å™¨IPï¼ˆ80ç«¯å£ï¼‰"

      - name: 8-Tailscaleè¿œç¨‹ç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          if [ -z "${TAILSCALE_AUTH_KEY}" ]; then
            echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          echo "===== å®‰è£…é…ç½®Tailscale ====="
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null)
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œå†…ç½‘IPï¼š${TAILSCALE_IP:-æœªè·å–}"

      - name: 9-è®¡æ—¶ç­‰å¾…+å¤‡ä»½æ¸…æ—§+è§¦å‘ç»­è·‘ï¼ˆæ ¸å¿ƒï¼‰
        # ã€ä¿®å¤8ã€‘ä¿®æ­£GitHub Actionsæ¡ä»¶è¡¨è¾¾å¼ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼ï¼Œä¿æŒ${{ ... }}ç´§å‡‘æ ¼å¼
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ»¡${BACKUP_TRIGGER_MINS}åˆ†é’Ÿè§¦å‘å¤‡ä»½+ç»­è·‘ ====="
          
          cleanup_old_backups(){
            echo "ğŸ“Œ å¼€å§‹æ¸…ç†æ—§å¤‡ä»½ï¼Œä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
            BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
            BACKUP_COUNT=$(echo "${BACKUPS}" | wc -l)
            if [ ${BACKUP_COUNT} -gt ${KEEP_BACKUPS} ];then
              DELETE_COUNT=$((BACKUP_COUNT - KEEP_BACKUPS))
              DELETE_LIST=$(echo "${BACKUPS}" | tail -n ${DELETE_COUNT})
              echo "âš ï¸ å½“å‰${BACKUP_COUNT}ä»½å¤‡ä»½ï¼Œéœ€åˆ é™¤${DELETE_COUNT}ä»½æ—§å¤‡ä»½"
              for FILE in ${DELETE_LIST};do
                if rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${FILE} --config /home/runner/.rclone.conf;then
                  echo "âœ… å·²åˆ é™¤æ—§å¤‡ä»½ï¼š${FILE}"
                else
                  echo "âš ï¸ æ—§å¤‡ä»½${FILE}åˆ é™¤å¤±è´¥ï¼Œè·³è¿‡"
                fi
              done
              echo "âœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
            else
              echo "âœ… å½“å‰å¤‡ä»½${BACKUP_COUNT}ä»½ï¼Œæ— éœ€æ¸…ç†"
            fi
          }
          
          stop_all_process(){
            echo "ğŸ“Œ åœæ­¢CasaOS+Dockeræ‰€æœ‰ç›¸å…³è¿›ç¨‹ï¼Œé¿å…æ–‡ä»¶å ç”¨"
            sudo systemctl stop casaos docker containerd 2>/dev/null || true
            sleep 3
            sudo pkill -9 casaos docker dockerd containerd containerd-shim 2>/dev/null || true
            sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
            sync && sleep 2
            echo "âœ… æ‰€æœ‰ç›¸å…³è¿›ç¨‹å·²åœæ­¢ï¼Œå¯å®‰å…¨å¤‡ä»½"
          }
          
          restart_all_service(){
            echo "ğŸ“Œ å¤‡ä»½å®Œæˆï¼Œé‡å¯æ‰€æœ‰æ ¸å¿ƒæœåŠ¡"
            sudo systemctl daemon-reload
            sudo systemctl enable --now docker containerd && sleep 3
            sudo systemctl enable --now casaos && sleep 4
            echo "âœ… æ‰€æœ‰æœåŠ¡é‡å¯å®Œæˆ"
          }
          
          full_backup(){
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            SNAPSHOT_PATH="/tmp/${SNAPSHOT_NAME}"
            
            stop_all_process
            
            echo "ğŸ“Œ å¼€å§‹æ‰“åŒ…æ•°æ®ï¼ˆå®æ—¶è¿›åº¦ï¼‰ï¼Œæ’é™¤å†—ä½™æ–‡ä»¶"
            # ã€ä¿®å¤9ã€‘ä¿®æ­£Tarå‘½ä»¤å‚æ•°é¡ºåºï¼Œæ’é™¤è§„åˆ™${EXCLUDE_RULES}åœ¨å‰ï¼Œå¾…æ‰“åŒ…ç›®å½•åœ¨åï¼Œç§»é™¤å¤šä½™å¼•å·
            if ! sudo tar -czf ${SNAPSHOT_PATH} ${EXCLUDE_RULES} \
              --checkpoint=1000 --checkpoint-action='echo -e "\ræ‰“åŒ…è¿›åº¦ï¼šå¤„ç†ä¸­ï¼Œå·²å®Œæˆæ–‡ä»¶æ•°:%u"' \
              ${PERSONAL_DATA_DIRS}; then
              echo -e "\nâŒ æ•°æ®æ‰“åŒ…å¤±è´¥ï¼Œå°è¯•é‡å¯æœåŠ¡"
              restart_all_service
              return 1
            fi
            # ã€è¡¥å……ä¿®å¤ã€‘å¢åŠ duå‘½ä»¤å®¹é”™ï¼Œé¿å…æ ¼å¼å¼‚å¸¸å¯¼è‡´è„šæœ¬ç»ˆæ­¢ï¼Œé»˜è®¤è¿”å›"æœªçŸ¥å¤§å°"
            SNAPSHOT_SIZE=$(du -sh ${SNAPSHOT_PATH} 2>/dev/null | awk '{print $1}' || echo "æœªçŸ¥å¤§å°")
            echo -e "\nâœ… æœ¬åœ°æ‰“åŒ…å®Œæˆï¼Œå¤‡ä»½å¤§å°ï¼š${SNAPSHOT_SIZE}"
            
            restart_all_service
            
            echo "ğŸ“Œ ä¸Šä¼ å¤‡ä»½è‡³WebDAVè¿œç¨‹ç›®å½•ï¼ˆå®æ—¶è¿›åº¦ï¼‰"
            if ! rclone copy ${SNAPSHOT_PATH} mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --transfers 8 --fast-list --retries 3 --progress;then
              echo "âŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥"
              sudo rm -f ${SNAPSHOT_PATH}
              return 1
            fi
            
            # ä¼˜åŒ–ï¼šæ›´ç¨³å¥çš„å¤§å°æ ¡éªŒæ–¹å¼
            LOCAL_SIZE=$(stat -c%s "${SNAPSHOT_PATH}" 2>/dev/null || echo 0)
            REMOTE_SIZE_INFO=$(rclone size mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME} --config /home/runner/.rclone.conf 2>/dev/null)
            REMOTE_SIZE=$(echo "${REMOTE_SIZE_INFO}" | grep "Size" | awk '{print $3}' | sed 's/[^0-9]//g')
            
            if [ "${LOCAL_SIZE}" -gt 0 ] && [ "${LOCAL_SIZE}" -eq "${REMOTE_SIZE}" ]; then
              echo "âœ… è¿œç¨‹å¤‡ä»½æ ¡éªŒæˆåŠŸï¼ˆå¤§å°ä¸€è‡´ï¼‰"
              sudo rm -f ${SNAPSHOT_PATH}
              return 0
            else
              echo "âŒ è¿œç¨‹å¤‡ä»½æ ¡éªŒå¤±è´¥ï¼ˆæœ¬åœ°:${LOCAL_SIZE}, è¿œç¨‹:${REMOTE_SIZE}ï¼‰"
              sudo rm -f ${SNAPSHOT_PATH}
              rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME} --config /home/runner/.rclone.conf 2>/dev/null
              return 1
            fi
          }
          
          # ã€ä¿®å¤10ã€‘è¡¥å……ç¼ºå¤±çš„trigger_renewå‡½æ•°ï¼Œå®ç°è‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ¬¡å·¥ä½œæµï¼Œå¢åŠ éç©ºåˆ¤æ–­æé«˜å¥å£®æ€§
          trigger_renew(){
            echo "ğŸ“Œ è§¦å‘ä¸‹ä¸€æ¬¡CasaOSå¿«ç…§ç»­è·‘"
            if [ -z "${USER_PAT}" ] || [ -z "${REPO}" ]; then
              echo "âš ï¸ USER_PATæˆ–REPOç¼ºå¤±ï¼Œè·³è¿‡è‡ªåŠ¨ç»­è·‘"
              return 0
            fi
            # å‘é€repository_dispatchäº‹ä»¶è§¦å‘ç»­è·‘ï¼Œå¢åŠ è¶…æ—¶å®¹é”™
            curl -X POST \
              -H "Authorization: token ${USER_PAT}" \
              -H "Accept: application/vnd.github.v3+json" \
              --connect-timeout 30 \
              --max-time 60 \
              https://api.github.com/repos/${REPO}/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}'
            if [ $? -eq 0 ]; then
              echo "âœ… è‡ªåŠ¨ç»­è·‘è§¦å‘æˆåŠŸ"
            else
              echo "âš ï¸ è‡ªåŠ¨ç»­è·‘è§¦å‘å¤±è´¥"
            fi
          }
          
          # ç›´æ¥è®¡æ—¶é€»è¾‘ï¼Œæ»¡æ—¶è§¦å‘å¤‡ä»½
          start_time=$(date +%s)
          echo "â° è®¡æ—¶å¼€å§‹ï¼Œæ»¡${BACKUP_TRIGGER_MINS}åˆ†é’Ÿè§¦å‘å¤‡ä»½ï¼Œå½“å‰æ—¶é—´ï¼š$(date)"
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            if [ ${run_mins} -ge ${BACKUP_TRIGGER_MINS} ] || [ ${run_mins} -ge 350 ];then
              echo "âœ… å·²è¿è¡Œæ»¡${run_mins}åˆ†é’Ÿï¼Œå¯åŠ¨å¤‡ä»½æµç¨‹"
              break
            fi
            echo "â³ å·²è¿è¡Œ${run_mins}åˆ†é’Ÿï¼Œè¿˜éœ€ç­‰å¾…$((BACKUP_TRIGGER_MINS - run_mins))åˆ†é’Ÿ"
            sleep 60
          done
          
          # å¤‡ä»½ä¸»æµç¨‹ï¼Œæ”¯æŒé‡è¯•ä¸€æ¬¡ï¼Œæé«˜æˆåŠŸç‡
          if full_backup;then
            echo "âœ… å¤‡ä»½æˆåŠŸ"
            cleanup_old_backups
            trigger_renew
          else
            echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œ1åˆ†é’Ÿåé‡è¯•1æ¬¡"
            sleep 60
            if full_backup;then
              echo "âœ… é‡è¯•å¤‡ä»½æˆåŠŸ"
              cleanup_old_backups
              trigger_renew
            else
              echo "âŒ ä¸¤æ¬¡å¤‡ä»½å‡å¤±è´¥"
            fi
          fi
          echo "âœ… å¤‡ä»½+ç»­è·‘æµç¨‹ç»“æŸï¼Œå‡†å¤‡æ”¶å°¾"

      - name: 10-æ”¶å°¾æ¸…ç†ï¼ˆæ— æ®‹ç•™ï¼Œå§‹ç»ˆæ‰§è¡Œï¼‰
        # ã€ä¿®å¤11ã€‘ä¿®æ­£GitHub Actionsæ¡ä»¶è¡¨è¾¾å¼ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼ï¼Œä¿æŒ${{ always() }}ç´§å‡‘æ ¼å¼
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç†ï¼Œä»»åŠ¡å®Œç»“ ====="
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "ğŸ“Œ æœ€ç»ˆæœåŠ¡çŠ¶æ€"
          sudo systemctl is-active --quiet docker && echo "âœ… Dockerè¿è¡Œæ­£å¸¸" || echo "âš ï¸ Dockeræœªè¿è¡Œ"
          sudo systemctl is-active --quiet casaos && echo "âœ… CasaOSè¿è¡Œæ­£å¸¸" || echo "âš ï¸ CasaOSæœªè¿è¡Œ"
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          echo "âœ… å¤‡ä»½ä¿ç•™2ä»½ï¼Œè®¿é—®æœåŠ¡å™¨IP:80å¯ç”¨"
