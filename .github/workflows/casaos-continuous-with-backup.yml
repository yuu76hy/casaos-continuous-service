name: 1Panel-å¿«ç…§-å¤‡ä»½-æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_1panel_snapshot]

jobs:
  onepanel_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # ğŸ”´ è·¨è®¾å¤‡ç›´æ¥å¯åŠ¨æ ¸å¿ƒï¼šæ–°å¢Docker/1Panelæ‰€æœ‰ä¾èµ–ç›®å½•ï¼ŒåŒ…å«ç”¨æˆ·ã€æƒé™ã€æœåŠ¡è‡ªå¯é…ç½®
      CORE_DIRS: |
        /var/lib/docker /etc/docker /opt/1panel /usr/bin/1panel /etc/systemd/system 
        /DATA /var/run/docker.sock /usr/lib/systemd/system/docker* /usr/lib/systemd/system/1panel*
        /etc/default/docker /var/log/docker /var/log/1panel /var/lib/docker/networks /var/lib/docker/plugins
        /opt/1panel/db /opt/1panel/cert /opt/1panel/conf /etc/passwd /etc/group /etc/sudoers.d
        /usr/lib/systemd/system/containerd.service /etc/containerd
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/ç¼“å­˜
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/opt/1panel/logs
        --exclude=/opt/1panel/tmp
        --exclude=/var/log/docker/*.log
        --exclude=/var/log/1panel/*.log
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: "true"
      RETRY_COUNT: 3
      TRANSFERS: 8
      # ğŸ”´ ä»…ä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½
      KEEP_LATEST_SNAPSHOTS: 2

    steps:
      - name: ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–å®‰è£…
        run: |
          set -e
          sudo mkdir -p /etc/systemd/system
          sudo rm -rf /est/systemd/system 2>/dev/null || true
          
          sudo rm -f /etc/resolv.conf
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
          echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf
          sudo chmod 644 /etc/resolv.conf
          
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl dnsutils
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          curl https://rclone.org/install.sh | sudo bash
          
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          
          echo "âœ…æ£€æŸ¥DNSè§£æ..."
          nslookup resource.fit2cloud.com || { echo "âŒ DNSè§£æå¤±è´¥"; exit 1; }
          echo "âœ…ç¯å¢ƒå·²æˆåŠŸåˆå§‹åŒ–"

      - name: åˆ›å»ºrootsç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
              echo "âœ… rootsç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ˆå¯†ç å·²é…ç½®ï¼‰"
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… rootsç”¨æˆ·åˆ›å»ºï¼Œå¯†ç ï¼š$RANDOM_PASS"
            fi
            sudo usermod -aG sudo,docker roots
          fi

      - name: é…ç½®Rclone for WebDAV
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒç¼ºå°‘WebDAVå‡­è¯"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav URL="$WEBDAV_URL" vendor="webdav" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          
          for i in $(seq 1 $RETRY_COUNT); do
            if rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
              echo "âœ…WebDAVå·²è¿æ¥"
              break
            else
              echo "âš ï¸WebDAVè¿æ¥å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              sleep 5
              if [ $i -eq $RETRY_COUNT ]; then
                echo "âŒWebDAVè¿æ¥å¤±è´¥ï¼ˆå·²é‡è¯•$RETRY_COUNTæ¬¡ï¼‰"
                echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
                exit 0
              fi
            fi
          done
          
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "1panel-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ…æœ€æ–°è¿œç¨‹å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸æœªæ‰¾åˆ°è¿œç¨‹å¿«ç…§"
          fi

      - name: ä»WebDAVæ¢å¤1Panel&Dockerå®Œæ•´å¿«ç…§
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== æ¢å¤å®Œæ•´å¿«ç…§ï¼š$LATEST_SNAPSHOT ====="
          
          sudo systemctl stop 1panel docker containerd docker.socket 2>/dev/null || true
          sudo systemctl unmask docker.socket 2>/dev/null || true
          sudo pkill -9 docker 1panel containerd 2>/dev/null || true
          sync && sleep 5
          
          # ğŸ”´ è·¨è®¾å¤‡æ ¡éªŒï¼šç¡®ä¿åŒ…å«ç”¨æˆ·ã€é…ç½®ã€è¯ä¹¦ç­‰æ ¸å¿ƒæ•°æ®
          CHECK_ITEMS=(
            "/opt/1panel/db" "/opt/1panel/cert" "/var/lib/docker/volumes"
            "/etc/passwd" "/usr/lib/systemd/system/docker.service"
          )
          for item in "${CHECK_ITEMS[@]}"; do
            if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | tar -tzf - | grep -q "$item"; then
              echo "âŒå¿«ç…§ä¸å®Œæ•´ï¼šç¼ºå¤± $item"
              echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
              exit 1
            fi
          done
          
          RESTORE_SUCCESS="false"
          for i in $(seq 1 $RETRY_COUNT); do
            echo "å¼€å§‹ç¬¬ $i æ¬¡æ¢å¤å°è¯•..."
            if rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / \
              --overwrite --ignore-failed-read --warning=no-all \
              --preserve-permissions --preserve-owner --preserve-links --absolute-names \
              --preserve-context --same-owner $EXCLUDE_RULES; then
              RESTORE_SUCCESS="true"
              break
            else
              echo "âš ï¸ç¬¬ $i æ¬¡æ¢å¤å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
              sleep 5
            fi
          done
          
          if [ "$RESTORE_SUCCESS" == "true" ]; then
            echo "âœ…1Panel&Dockerå¿«ç…§æ¢å¤æˆåŠŸ"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # ğŸ”´ è·¨è®¾å¤‡è‡ªå¯æ ¸å¿ƒï¼šä¿®å¤æœåŠ¡æƒé™+è®¾ç½®å¼€æœºè‡ªå¯
            sudo chown root:root /usr/lib/systemd/system/docker* /usr/lib/systemd/system/1panel* /usr/lib/systemd/system/containerd*
            sudo chmod 644 /usr/lib/systemd/system/docker* /usr/lib/systemd/system/1panel* /usr/lib/systemd/system/containerd*
            sudo systemctl enable docker.service containerd.service 1panel.service --now
          else
            echo "âŒå¿«ç…§æ¢å¤å¤±è´¥ï¼ˆå·²é‡è¯•$RETRY_COUNTæ¬¡ï¼‰"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          fi

      - name: æ¸…ç†æ®‹ç•™ï¼ˆæ¢å¤å¤±è´¥æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          sudo systemctl stop 1panel docker containerd 2>/dev/null || true
          sudo systemctl disable 1panel docker containerd 2>/dev/null || true
          sudo pkill -9 docker 1panel containerd 2>/dev/null || true
          sync && sleep 3
          
          if sudo docker info >/dev/null 2>&1; then
            sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true
            sudo docker rmi -f $(sudo docker images -aq) 2>/dev/null || true
            sudo docker volume rm -f $(sudo docker volume ls -q) 2>/dev/null || true
            sudo docker network rm $(sudo docker network ls -q) 2>/dev/null || true
          fi
          
          sudo rm -rf /opt/1panel /etc/1panel /var/log/1panel /usr/bin/1panel /usr/lib/systemd/system/1panel*
          sudo rm -rf /var/lib/docker /etc/docker /usr/lib/systemd/system/docker* /etc/default/docker /etc/containerd
          sudo rm -rf /DATA/1panel* /tmp/1panel*
          
          dpkg -l | grep -q docker && sudo apt purge -y docker* containerd* runc* || true
          sudo apt autoremove -y && sudo apt clean
          echo "âœ…æ®‹ç•™å·²æ¸…é™¤"

      - name: é‡è£…Docker&1Panelï¼ˆæ¢å¤å¤±è´¥æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          sudo apt update -y
          sudo apt install -y ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt update -y
          sudo apt install -y docker-ce=5:27.1.1-1~ubuntu.24.04~noble docker-ce-cli=5:27.1.1-1~ubuntu.24.04~noble containerd.io docker-buildx-plugin docker-compose-plugin
          
          sudo usermod -aG docker runner
          sudo chown root:docker /var/run/docker.sock
          sudo chmod 660 /var/run/docker.sock
          sudo systemctl enable --now docker.socket docker.service
          sleep 10
          
          if sudo systemctl is-active --quiet docker; then
            curl -fsSL https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash - || {
              cat /tmp/1panel-install.log 2>/dev/null || true
              exit 1
            }
            sudo systemctl enable --now 1panel.service
            sleep 5
            echo "âœ…Docker&1Panelé‡è£…æˆåŠŸ"
          else
            echo "âŒDockeræœªå¯åŠ¨ï¼Œå®‰è£…å¤±è´¥"
            exit 1
          fi

      - name: ä¸€é”®é‡å¯Docker&1Panelï¼ˆæ¢å¤æˆåŠŸæ—¶æ‰§è¡Œï¼‰
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          echo "===== ä¸€é”®é‡å¯Docker&1PanelæœåŠ¡ ====="
          sudo systemctl daemon-reload
          sudo systemctl reset-failed docker.service containerd.service 1panel.service
          
          # ğŸ”´ è·¨è®¾å¤‡å¯åŠ¨é¡ºåºï¼šcontainerd â†’ docker â†’ 1panel
          sudo systemctl enable --now containerd.service
          sleep 3
          sudo systemctl enable --now docker.socket docker.service
          sleep 5
          sudo systemctl enable --now 1panel.service
          sleep 5
          
          if sudo systemctl is-active --quiet docker.service && sudo systemctl is-active --quiet 1panel.service; then
            echo "âœ…âœ…Docker&1Panelå·²æ­£å¸¸å¯åŠ¨ï¼è·¨è®¾å¤‡æ— éœ€é¢å¤–é…ç½®"
            echo "DockerçŠ¶æ€: $(sudo systemctl status docker.service --no-pager | grep Active)"
            echo "1PanelçŠ¶æ€: $(sudo systemctl status 1panel.service --no-pager | grep Active)"
            echo "1Panelè®¿é—®åœ°å€å¯æ‰§è¡Œ: sudo 1panel status æŸ¥çœ‹"
          else
            echo "âŒå¯åŠ¨å¼‚å¸¸ï¼Œå°è¯•ä¿®å¤..."
            sudo 1panel repair
            sudo systemctl restart docker.service 1panel.service
          fi

      - name: éƒ¨ç½²Tailscale
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ç¼ºå°‘Tailscaleå¯†é’¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ]; then
            echo "âŒTailscaleå®‰è£…å¤±è´¥"
            exit 0
          fi
          if ! sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="1panel-snapshot-${{ github.run_id }}"; then
            echo "âŒTailscaleç™»å½•å¤±è´¥"
            sudo "$TAILSCALE_PATH" status
            exit 0
          fi
          echo "âœ…Tailscale IP: $(sudo "$TAILSCALE_PATH" ip -4)"

      - name: åˆ›å»ºDocker&1Panelå®Œæ•´å¤‡ä»½ï¼ˆè·¨è®¾å¤‡ç›´æ¥å¯åŠ¨ç‰ˆï¼‰
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ "${WEBDAV_AVAILABLE}" != "true" ]; then exit 0; fi
          
          sudo systemctl stop 1panel docker containerd docker.socket 2>/dev/null || true
          sudo pkill -9 docker 1panel containerd 2>/dev/null || true
          sync && sleep 5
          
          # è¿‡æ»¤æœ‰æ•ˆç›®å½•ï¼Œç¡®ä¿è·¨è®¾å¤‡å¤‡ä»½å®Œæ•´æ€§
          VALID_CORE_DIRS=""
          for dir in $CORE_DIRS; do
            if [ -d "$dir" ] || [ -f "$dir" ]; then
              VALID_CORE_DIRS="$VALID_CORE_DIRS $dir"
            else
              echo "âš ï¸è·³è¿‡ä¸å­˜åœ¨çš„è·¯å¾„ï¼š$dir"
            fi
          done
          if [ -z "$VALID_CORE_DIRS" ]; then
            echo "âŒæ— æœ‰æ•ˆç›®å½•å¯å¤‡ä»½"
            exit 1
          fi
          
          SNAPSHOT_NAME="1panel-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
          # ğŸ”´ è·¨è®¾å¤‡å¤‡ä»½æ ¸å¿ƒï¼šæ·»åŠ --same-owner --preserve-context ä¿ç•™æ‰€æœ‰æƒé™å’ŒSELinuxä¸Šä¸‹æ–‡
          sudo tar -czf "${TMP_SNAPSHOT}" \
            --absolute-names --ignore-failed-read --warning=no-all \
            --preserve-permissions --preserve-owner --preserve-links \
            --same-owner --preserve-context $EXCLUDE_RULES $VALID_CORE_DIRS
          sudo chown runner:runner "${TMP_SNAPSHOT}"
          sudo chmod 644 "${TMP_SNAPSHOT}"
          
          # è·¨è®¾å¤‡æ ¡éªŒï¼šç¡®ä¿å¤‡ä»½å¤§å°å’Œæ ¸å¿ƒæ•°æ®å­˜åœ¨
          if [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 10240 ]; then
            echo "âŒå¿«ç…§è¿‡å°ï¼Œå¤‡ä»½å¤±è´¥"
            sudo systemctl start docker 1panel 2>/dev/null || true
            exit 1
          fi
          if ! tar -tzf "${TMP_SNAPSHOT}" | grep -q "/opt/1panel/db" || ! tar -tzf "${TMP_SNAPSHOT}" | grep -q "/var/lib/docker/volumes"; then
            echo "âŒå¿«ç…§ç¼ºå¤±æ ¸å¿ƒæ•°æ®ï¼Œå¤‡ä»½å¤±è´¥"
            sudo systemctl start docker 1panel 2>/dev/null || true
            exit 1
          fi
          
          # æ–­ç‚¹ç»­ä¼ ä¸Šä¼ 
          UPLOAD_SUCCESS="false"
          REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
          for i in $(seq 1 $RETRY_COUNT); do
            echo "å¼€å§‹ç¬¬ $i æ¬¡ä¸Šä¼ å°è¯•..."
            if sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers ${TRANSFERS} \
              --progress \
              --checksum \
              --retries 3; then
              UPLOAD_SUCCESS="true"
              break
            else
              echo "âš ï¸ç¬¬ $i æ¬¡ä¸Šä¼ å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
              sleep 5
            fi
          done
          
          if [ "$UPLOAD_SUCCESS" != "true" ]; then
            echo "âŒå¤‡ä»½ä¸Šä¼ å¤±è´¥ï¼ˆå·²é‡è¯•$RETRY_COUNTæ¬¡ï¼‰"
            rm -f "${TMP_SNAPSHOT}"
            sudo systemctl start docker 1panel 2>/dev/null || true
            exit 1
          fi
          
          # ç”Ÿæˆè·¨è®¾å¤‡å¤‡ä»½å…ƒæ•°æ®
          META_FILE="/tmp/snapshot_meta.txt"
          echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
          echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
          echo "snapshot_size=$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')" >> "${META_FILE}"
          echo "docker_version=$(docker -v | awk '{print $3}' | sed 's/,//g')" >> "${META_FILE}"
          echo "1panel_version=$(1panel -v | awk '{print $3}')" >> "${META_FILE}"
          echo "cross_device_support=true" >> "${META_FILE}"
          sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf
          
          # ğŸ”´ ä»…ä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½ï¼Œè‡ªåŠ¨åˆ é™¤æ›´æ—©çš„
          echo "å¼€å§‹æ¸…ç†æ—§å¤‡ä»½ï¼Œä¿ç•™æœ€è¿‘${KEEP_LATEST_SNAPSHOTS}ä¸ª..."
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "1panel-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          SNAPSHOTS_TO_DELETE=$(echo "$REMOTE_SNAPSHOTS" | tail -n +$((KEEP_LATEST_SNAPSHOTS + 1)))
          if [ -n "$SNAPSHOTS_TO_DELETE" ]; then
            while IFS= read -r snap; do
              echo "åˆ é™¤æ—§å¤‡ä»½: $snap"
              rclone delete "mywebdav:$snap" --config /home/runner/.rclone.conf
            done <<< "$SNAPSHOTS_TO_DELETE"
          else
            echo "æ— æ—§å¤‡ä»½éœ€è¦æ¸…ç†"
          fi
          
          sudo systemctl start docker 1panel containerd 2>/dev/null || true
          rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
          echo "âœ…âœ…è·¨è®¾å¤‡å®Œæ•´å¤‡ä»½å·²åˆ›å»ºå¹¶ä¸Šä¼ ï¼š${SNAPSHOT_NAME}"

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: ${{ always() }}
        run: |
          set -e
          sudo systemctl unmask docker.socket 2>/dev/null || true
          sudo rm -rf /tmp/1panel-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner
          echo "âœ…ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
