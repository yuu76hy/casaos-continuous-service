name: CasaOS-Tailscale-Backup-Auto-Renew
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 330
      RUNNER_PASSWORD: "runner123"
      CASAOS_PORT: 80
      KEEP_BACKUP_COUNT: 3
      CLEAN_INTERVAL: 3600
      HEALTH_CHECK_TIMEOUT: 300
      BACKUP_DIR: /home/runner/backup
      LOG_DIR: /home/runner/logs
      WEBDAV_MOUNT_POINT: /mnt/webdav_casaos
      WEBDAV_REMOTE_DIR: /z/Ubu
      RCLONE_CACHE_DIR: /tmp/rclone_cache
      NEW_RUN_ID_FILE: /home/runner/new_run_id.txt
      BACKUP_EXCLUDE: >-
        --exclude=/proc
        --exclude=/sys
        --exclude=/tmp
        --exclude=/dev
        --exclude=/run
        --exclude=/var/run
        --exclude=/home/runner/actions-runner
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/logs
        --exclude=/var/lib/docker/build
        --exclude=/var/lib/docker/tmpfs
        --exclude=/var/lib/docker/overlay2/tmp
        --exclude=/var/lib/docker/*-tmp
      BACKUP_MARKER: latest_backup.txt
      LOG_FILE: casaos_service_${{ github.run_id }}_$(date +'%Y%m%d_%H%M%S')

    steps:
      - name: "Step 0: Pre-Check & Env Init"
        id: pre_check
        continue-on-error: false
        run: |
          set -euo pipefail
          mkdir -p $LOG_DIR $RCLONE_CACHE_DIR $WEBDAV_MOUNT_POINT
          chmod 755 $LOG_DIR $RCLONE_CACHE_DIR $WEBDAV_MOUNT_POINT
          exec > >(tee -a $LOG_DIR/$LOG_FILE.log) 2>&1
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Pre-Check Completed ===="
          echo "ðŸ”§ Workflow Run ID: ${{ github.run_id }}"
          echo "ðŸ”§ WebDAV Remote Dir: $WEBDAV_REMOTE_DIR"
          echo "ðŸ”§ Max Runtime: $MAX_RUN_MINUTES Minutes | Renew Trigger: 30 Mins Remaining"

      - name: "Step 1: System Dependencies Install"
        id: sys_init
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 1 Start: System Initialization ===="
          sudo apt update -y && sudo apt upgrade -y -qq
          REQUIRED_PACKAGES="tar gzip rsync rclone fuse3 netcat-openbsd psmisc curl git wget jq bc"
          sudo apt install -y $REQUIRED_PACKAGES
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          sudo mkdir -p $BACKUP_DIR /DATA
          sudo chown -R runner:runner $BACKUP_DIR /DATA $WEBDAV_MOUNT_POINT
          echo "âœ… Dependencies Installed: $REQUIRED_PACKAGES"
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 1 Completed ===="

      - name: "Step 2: WebDAV Mount (Plaintext Secrets Direct Reference)"
        id: webdav_setup
        continue-on-error: false
        run: |
          set -e
          # ç›´æŽ¥å¼•ç”¨ä»“åº“Secretsï¼Œæ— åŠ å¯†/æ— æ ¡éªŒ
          WEBDAV_URL="${{ secrets.WEBDAV_URL }}"
          WEBDAV_USER="${{ secrets.WEBDAV_USER }}"
          WEBDAV_PASSWORD="${{ secrets.WEBDAV_PASSWORD }}"
          
          # ä»…ä¿ç•™éžç©ºæ ¡éªŒï¼ˆç©ºå€¼æ— æ³•æŒ‚è½½ï¼Œå¿…é¡»ä¿ç•™ï¼‰
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV Secrets Empty"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # ç›´æŽ¥å†™å…¥æ˜Žæ–‡é…ç½®
          mkdir -p /home/runner/
          echo "[mywebdav]" > /home/runner/.rclone.conf
          echo "type = webdav" >> /home/runner/.rclone.conf
          echo "url = $WEBDAV_URL" >> /home/runner/.rclone.conf
          echo "user = $WEBDAV_USER" >> /home/runner/.rclone.conf
          echo "pass = $WEBDAV_PASSWORD" >> /home/runner/.rclone.conf
          
          # æƒé™é…ç½®
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          
          # å¸è½½æ®‹ç•™æŒ‚è½½ & åˆ›å»ºæŒ‚è½½ç‚¹
          fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || fusermount -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
          
          # åŽå°æŒ‚è½½WebDAV
          nohup sudo -u runner rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" \
            --config /home/runner/.rclone.conf \
            --uid $(id -u runner) \
            --gid $(id -g runner) \
            --vfs-cache-mode writes \
            --allow-other \
            --allow-non-empty \
            --log-file /tmp/rclone_mount.log >/dev/null 2>&1 &
          
          # 5æ¬¡æŒ‚è½½æ£€æŸ¥
          for i in $(seq 1 5); do
            if touch "$WEBDAV_MOUNT_POINT/.test-mount" 2>/dev/null; then
              rm -f "$WEBDAV_MOUNT_POINT/.test-mount"
              echo "âœ… WebDAV Mount Success (Plaintext Mode)"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              
              # æ£€æµ‹æœ€æ–°å¿«ç…§
              WEBDAV_SNAPSHOT_DIR="${WEBDAV_MOUNT_POINT}${WEBDAV_REMOTE_DIR}"
              if ls "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "âœ… Found Latest Snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              fi
              exit 0
            fi
            echo "âš ï¸ Mount Retry $i/5"
            sleep 5
          done
          
          # æŒ‚è½½å¤±è´¥å¤„ç†
          echo "âŒ WebDAV Mount Failed After 5 Retries"
          cat /tmp/rclone_mount.log || echo "âš ï¸ No Mount Log"
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          exit 1

      - name: "Step 3: Backup Restore (If Available)"
        id: backup_restore
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 3 Start: Backup Restore ===="
          HAS_BACKUP="false"
          if [ "${{ env.WEBDAV_AVAILABLE }}" = "true" ]; then
            BACKUP_MARKER_FILE="$WEBDAV_MOUNT_POINT/$BACKUP_MARKER"
            if [ -f "$BACKUP_MARKER_FILE" ]; then
              LATEST_BACKUP=$(cat "$BACKUP_MARKER_FILE")
              echo "ðŸ” Start Restore From: $LATEST_BACKUP"
              echo "$BACKUP_EXCLUDE" | tr ' ' '\n' > $BACKUP_DIR/exclude-list.txt
              sudo systemctl stop docker containerd 2>/dev/null || true
              sleep 3
              sudo tar -zxf "$LATEST_BACKUP" -C / --exclude-from=$BACKUP_DIR/exclude-list.txt
              if [ -d "/etc/casaos" ] && [ -d "/var/lib/docker/containers" ]; then
                echo "âœ… Restore Success"
                HAS_BACKUP="true"
              fi
              sudo systemctl start docker containerd 2>/dev/null || true
            fi
          fi
          echo "HAS_BACKUP=$HAS_BACKUP" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 3 Completed ===="

      - name: "Step 4: CasaOS Installation"
        id: casaos_install
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 4 Start: CasaOS Install ===="
          if [ "${{ env.HAS_BACKUP }}" = "false" ]; then
            curl -fsSL https://get.casaos.io | sudo bash -s -- --debug 2>&1 | grep -v "restart" || true
          fi
          sudo systemctl daemon-reload
          sudo systemctl enable --now casaos
          sleep 10
          if sudo systemctl is-active --quiet casaos; then
            echo "âœ… CasaOS Service Running"
          else
            echo "âš ï¸ CasaOS Service Not Running"
          fi
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 4 Completed ===="

      - name: "Step 5: Tailscale Deployment"
        id: tailscale_deploy
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 5 Start: Tailscale Deploy ===="
          # å®‰è£…Tailscale
          if ! curl -fsSL https://tailscale.com/install.sh | sudo sh -s -- -q; then
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
            sudo apt update && sudo apt install -y tailscale
          fi
          sudo systemctl enable --now tailscaled
          sleep 5
          # é…ç½®Tailscale
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          if [ -z "$TS_AUTH_KEY" ]; then
            echo "ERROR: Tailscale Auth Key Not Configured"
            exit 1
          fi
          TS_RETRY=0
          TAILSCALE_IP=""
          while [ $TS_RETRY -lt 5 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-${{ github.run_id }} --accept-routes=false --accept-dns=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              if [ -n "$TAILSCALE_IP" ]; then
                echo "âœ… Tailscale Joined - IP: $TAILSCALE_IP"
                break
              fi
            fi
            TS_RETRY=$((TS_RETRY + 1))
            sleep 5
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "ERROR: Tailscale Join Failed"
            exit 1
          fi
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 5 Completed ===="

      - name: "Step 6: Core Keepalive & Auto Renew & Backup"
        id: core_keepalive
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 6 Start: Keepalive Logic ===="
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}
          CURRENT_RUN_ID=${{ github.run_id }}

          # å®šæ—¶æ¸…ç†å‡½æ•°
          auto_clean() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [CLEAN] Start Hourly Cleanup"
            sudo apt clean -y && sudo apt autoremove -y --purge -qq
            sudo docker system prune -af --volumes 2>/dev/null || true
            sudo rm -rf /tmp/* /home/runner/.cache/* 2>/dev/null || true
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [CLEAN] Completed"
          }

          # å¤‡ä»½å‡½æ•°
          do_backup() {
            if [ "${{ env.WEBDAV_AVAILABLE }}" = "true" ]; then
              echo "[$(date +'%Y-%m-%d %H:%M:%S')] [BACKUP] Start Full Backup"
              TS=$(date +'%Y%m%d_%H%M%S')
              BK_NAME="casaos_${CURRENT_RUN_ID}_$TS.tar.gz"
              BK_PATH="$WEBDAV_MOUNT_POINT/$BK_NAME"
              sudo docker stop $(sudo docker ps -q) 2>/dev/null || true
              sudo systemctl stop docker containerd casaos tailscaled 2>/dev/null || true
              sleep 5
              sudo tar -zcf $BK_PATH $BACKUP_EXCLUDE /etc/casaos /var/lib/casaos /var/lib/docker /DATA --warning=no-file-changed
              if [ -f "$BK_PATH" ] && [ $(stat -c%s "$BK_PATH") -gt 1024 ]; then
                echo "$BK_NAME" > "$WEBDAV_MOUNT_POINT/$BACKUP_MARKER"
                cp $LOG_DIR/$LOG_FILE.log "$WEBDAV_MOUNT_POINT/logs/"
                # æ¸…ç†æ—§å¤‡ä»½
                BACKUP_FILES=$(ls -t $WEBDAV_MOUNT_POINT/casaos_*.tar.gz 2>/dev/null)
                BACKUP_COUNT=$(echo "$BACKUP_FILES" | wc -l)
                if [ $BACKUP_COUNT -gt $KEEP_BACKUP_COUNT ]; then
                  FILES_TO_DELETE=$(echo "$BACKUP_FILES" | tail -n +$((KEEP_BACKUP_COUNT + 1)))
                  for FILE in $FILES_TO_DELETE; do sudo rm -f "$FILE"; done
                fi
                echo "âœ… Backup Success: $BK_NAME"
              fi
              # é‡å¯æœåŠ¡
              sudo systemctl start docker containerd casaos tailscaled 2>/dev/null || true
              sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} 2>/dev/null || true
              backup_done=true
            fi
          }

          # è§¦å‘ç»­è·‘å‡½æ•°
          trigger_renew() {
            if [ -z "$GITHUB_PAT" ] || [ -z "$REPO" ]; then
              return 1
            fi
            RESPONSE=$(curl -s -X POST https://api.github.com/repos/$REPO/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_PAT" \
              -d '{"event_type":"renew_vnc"}' \
              -w "%{http_code}" -o /dev/null)
            [ "$RESPONSE" -eq 204 ] && return 0 || return 1
          }

          # æ£€æŸ¥æ–°å®¹å™¨å¥åº·
          check_new_container() {
            start_check=$(date +%s)
            while [ $(( $(date +%s) - start_check )) -lt $HEALTH_CHECK_TIMEOUT ]; do
              RUNS=$(curl -s -H "Authorization: Bearer $GITHUB_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&event=repository_dispatch" \
                | jq -r '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID') | .id')
              if [ -n "$RUNS" ]; then
                NEW_RUN_ID=$(echo "$RUNS" | head -n1)
                echo "âœ… New Container Ready: $NEW_RUN_ID"
                echo $NEW_RUN_ID > $NEW_RUN_ID_FILE
                return 0
              fi
              sleep 10
            done
            return 1
          }

          # æ ¸å¿ƒä¿æ´»å¾ªçŽ¯
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] [KEEPALIVE] Monitoring Started"
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            remaining_mins=$((MAX_RUN_MINUTES - run_mins))
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] Running: $run_mins Mins | Remaining: $remaining_mins Mins"
            
            # å®šæ—¶æ¸…ç†
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi

            # å‰©ä½™30åˆ†é’Ÿè§¦å‘å¤‡ä»½+ç»­è·‘
            if [ $remaining_mins -eq 30 ] && [ "$backup_done" = false ]; then
              do_backup
              if trigger_renew && check_new_container; then
                echo "âœ… New Container Healthy, Old Container Exit"
                sudo systemctl stop casaos tailscaled docker containerd
                sudo tailscale down
                exit 0
              fi
            fi

            # æœåŠ¡ä¿æ´»
            ! sudo systemctl is-active --quiet casaos && sudo systemctl restart casaos
            ! sudo systemctl is-active --quiet tailscaled && sudo systemctl restart tailscaled
            ! sudo systemctl is-active --quiet docker && sudo systemctl restart docker containerd
            
            sleep 60
          done

      - name: "Step 7: Post-Cleanup & Unmount"
        id: post_cleanup
        if: always()
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 7 Start: Post Cleanup ===="
          # åœæ­¢æ‰€æœ‰æœåŠ¡
          sudo systemctl stop casaos tailscaled docker containerd 2>/dev/null || true
          sudo tailscale down 2>/dev/null || true
          # å¸è½½WebDAV
          if [ "${{ env.WEBDAV_AVAILABLE }}" = "true" ]; then
            cp $LOG_DIR/$LOG_FILE.log "$WEBDAV_MOUNT_POINT/logs/final_$LOG_FILE.log" 2>/dev/null || true
            fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || fusermount -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
          fi
          # æ¸…ç†æœ¬åœ°ç›®å½•
          sudo rm -rf $BACKUP_DIR $RCLONE_CACHE_DIR /tmp/* 2>/dev/null || true
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Workflow Completed ===="
