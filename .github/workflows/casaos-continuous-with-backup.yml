name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch: []
  repository_dispatch:
    types:
      - renew_casaos_snapshot

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: "--exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 60
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
      CASA_SERVICES: "casaos-gateway casaos-message-bus casaos-user-service casaos-local-storage casaos-app-management rclone casaos"
    steps:
      - name: ğŸ”’ å®‰å…¨åˆå§‹åŒ–
        run: |
          set -e
          echo "WORKFLOW_START_TIME=$(date +%s)" >> "$GITHUB_ENV"
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "::add-mask::$ROOTS_PASSWORD"
          fi
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ³ å®‰è£…Docker
        run: |
          set -e
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      - name: ğŸ‘¤ åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 16 | tr -dc 'A-Za-z0-9' | head -c12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "::add-mask::$RANDOM_PASS"
            echo "ğŸ”‘ rootså¯†ç : $RANDOM_PASS"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: â˜ï¸ WebDAVé…ç½®
        run: |
          set -e
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "::add-mask::$WEBDAV_PASSWORD"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /root/.rclone.conf 2>/dev/null
          sudo chmod 600 /root/.rclone.conf
          for i in 1 2 3; do
            if rclone mkdir "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null; then
              echo "âœ… è¿œç¨‹ç›®å½•å°±ç»ª"
              break
            fi
            if [ $i -eq 3 ]; then
              echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾"
              echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
              exit 0
            fi
            sleep 2
          done
          LATEST=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | head -1)
          if [ -n "$LATEST" ]; then
            echo "âœ… æ£€æµ‹åˆ°å¿«ç…§: $LATEST"
            echo "LATEST_SNAPSHOT=$LATEST" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "â„¹ï¸ æ— å†å²å¿«ç…§"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: ğŸ§¹ æ¸…ç†æ—§ç¯å¢ƒ
        run: |
          set -e
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
            sudo systemctl disable "${svc}.service" 2>/dev/null || true
            sudo rm -f "/etc/systemd/system/${svc}.service" "/usr/lib/systemd/system/${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 -f "casaos\|rclone" 2>/dev/null || true
          sudo rm -rf /var/lib/casaos/* /etc/casaos/* 2>/dev/null || true
          sudo systemctl daemon-reload
          echo "âœ… æ—§ç¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: ğŸ“¦ å®‰è£…CasaOS
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          echo "âœ… CasaOSå®‰è£…å®Œæˆ"

      - name: ğŸ”„ æ¢å¤æ•°æ®
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 docker containerd runc 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 3
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" 2>/dev/null || true
          done
          echo "âš ï¸ æ¢å¤ä¸­..."
          rclone cat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS 2>&1 | grep -v "tar: Removing leading" || true
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf 2>/dev/null && echo "âœ… æ¢å¤å®Œæˆ" || echo "âš ï¸ å¿«ç…§æ¸…ç†å¤±è´¥"

      - name: âš™ï¸ å¯åŠ¨æœåŠ¡
        run: |
          set -e
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          else
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
          fi
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 5
          if [ "${{ env.HAS_SNAPSHOT }}" != "true" ]; then
            echo "âœ¨ è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}')"
          fi
          echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      - name: ğŸŒ Tailscaleç»„ç½‘
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-8)" --accept-routes --advertise-exit-node 2>/dev/null || true
          TAIL_IP=$(sudo tailscale ip -4 2>/dev/null || echo "æœªè·å–")
          echo "âœ… Tailscale IP: $TAIL_IP"

      - name: ğŸŒ‰ Cloudflare Tunnel
        if: ${{ env.CLOUDFLARED_TOKEN != '' }}
        run: |
          set -e
          # å®‰è£…Cloudflared
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared noble main" | sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y cloudflared -qq
          # é…ç½®systemdæœåŠ¡ï¼ˆæ— å¤æ‚åµŒå¥—ï¼Œè§„é¿YAMLè§£æé”™è¯¯ï¼‰
          sudo bash -c 'cat > /etc/systemd/system/cloudflared.service << EOF
[Unit]
Description=Cloudflare Tunnel
After=network.target
[Service]
Type=simple
ExecStart=/usr/bin/cloudflared tunnel run --token $CLOUDFLARED_TOKEN
Restart=always
RestartSec=10
[Install]
WantedBy=multi-user.target
EOF'
          # å¯åŠ¨æœåŠ¡
          sudo systemctl daemon-reload
          sudo systemctl enable --now cloudflared
          sleep 8
          if sudo systemctl is-active --quiet cloudflared; then
            echo "âœ… Tunnelè¿è¡Œä¸­"
          else
            echo "âŒ Tunnelå¯åŠ¨å¤±è´¥"
            exit 1
          fi

      - name: â±ï¸ å»¶æ—¶æ ¡å‡†
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && github.event_name == 'repository_dispatch' }}
        run: |
          set -e
          START_TIME="${{ env.WORKFLOW_START_TIME }}"
          CURRENT_TIME=$(date +%s)
          CURRENT_DURATION=$(( CURRENT_TIME - START_TIME ))
          TARGET_DURATION=$(( TARGET_RUN_MINUTES * 60 ))
          WAIT_TIME=$(( TARGET_DURATION - CURRENT_DURATION ))
          if [ $WAIT_TIME -gt 0 ]; then
            echo "â³ ç­‰å¾…$((WAIT_TIME/60))åˆ†é’Ÿ"
            sleep $WAIT_TIME
          else
            echo "âœ… ç›´æ¥å¤‡ä»½"
          fi

      - name: ğŸ’¾ å¤‡ä»½æ¸…ç†
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd tailscaled cloudflared 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 -f "docker\|containerd\|casaos\|tailscaled\|cloudflared\|runc" 2>/dev/null || true
          sudo sync && sleep 5
          SNAPSHOT="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "ğŸ“Œ æ‰“åŒ…: $SNAPSHOT"
          sudo tar -czf "/tmp/$SNAPSHOT" $EXCLUDE_RULES $PERSONAL_DATA_DIRS 2>&1 | grep -v "tar: Removing leading" || (echo "âŒ æ‰“åŒ…å¤±è´¥" && exit 1)
          echo "âœ… æ‰“åŒ…å®Œæˆ"
          rclone copy "/tmp/$SNAPSHOT" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/" --config /root/.rclone.conf --transfers=4 --fast-list --retries=3 || (echo "âŒ ä¸Šä¼ å¤±è´¥" && exit 1)
          rclone size "mywebdav:${WEBDAV_SNAPSHOT_DIR}/$SNAPSHOT" --config /root/.rclone.conf >/dev/null 2>&1 || (echo "âŒ æ ¡éªŒå¤±è´¥" && exit 1)
          sudo rm -f "/tmp/$SNAPSHOT"
          echo "âœ… å¤‡ä»½æˆåŠŸ"
          BACKUPS=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r)
          COUNT=$(echo "$BACKUPS" | wc -l)
          if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
            echo "$BACKUPS" | tail -n $((COUNT - KEEP_BACKUPS)) | while read file; do
              rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/$file" --config /root/.rclone.conf && echo "âœ… åˆ é™¤æ—§å¤‡ä»½: $file" || echo "âš ï¸ åˆ é™¤å¤±è´¥: $file"
            done
          fi
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ] && [[ "$REPO" =~ / ]]; then
            PAYLOAD=$(jq -n --arg et "renew_casaos_snapshot" '{"event_type": $et}')
            curl -fsSL -X POST --max-time 30 -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" -d "$PAYLOAD" "https://api.github.com/repos/$REPO/dispatches" 2>/dev/null && echo "âœ… è§¦å‘ç»­è·‘" || echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥"
          fi
          echo "ğŸ‰ å¤‡ä»½å®Œæˆ"

      - name: ğŸ§¹ æ”¶å°¾æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          sudo rm -rf /tmp/casaos-* /tmp/cloudflared* /root/.rclone.conf 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… æ¸…ç†å®Œæˆ"
