name: CasaOS ç²¾ç®€å¤‡ä»½ï¼ˆæ— Dockeré•œåƒÂ·Tailscaleç»„ç½‘Â·å…¬ç½‘OpenListæœ¬æœºä»£ç†Â·å¾®è½¯äº‘ç›˜Â·ä¸¥æ ¼é¡ºåºÂ·zstd-19ï¼‰

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy-backup:
    runs-on: ubuntu-24.04
    timeout-minutes: 1440
    env:
      # ====================== 1. å…¬ç½‘ OpenList æœ¬æœºä»£ç†Â·å¾®è½¯äº‘ç›˜ WebDAV ======================
      WEBDAV_URL:          ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER:         ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD:     ${{ secrets.WEBDAV_PASSWORD }}
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"

      # ====================== 2. ç²¾ç®€å¤‡ä»½ç›®å½•ï¼ˆæ—  Docker é•œåƒï¼‰ ======================
      PERSONAL_DATA_DIRS: "
        /var/lib/docker/containers
        /var/lib/docker/volumes
        /var/lib/docker/overlay2
        /etc/casaos
        /var/lib/casaos
        /DATA
        /root/.config
      "

      # ====================== 3. é€šç”¨é…ç½® ======================
      ROOTS_PASSWORD:      ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT:            ${{ secrets.USER_PAT }}
      REPO:                ${{ secrets.REPO }}
      KEEP_BACKUPS:        2
      TARGET_RUN_MINUTES:  10

      # ====================== 4. å‹ç¼© & ä¸Šä¼ å‚æ•° ======================
      RCLONE_CONFIG:       "/etc/rclone.conf"
      PARALLEL_CORE:       4
      ZSTD_LEVEL:          19
      RCLONE_TRANSFERS:    1
      RCLONE_BUFFER:       "512M"
      WEBDAV_CHUNK_SIZE:   "64M"
      MAX_REDIRECT:        20
      TIMEOUT:             "120m"
      CONTIMEOUT:          "10m"
      WEBDAV_EXTRA_FLAGS:  "--no-check-certificate --disable-http2"

    steps:
      # ====================================== Step 1ï¼šç³»ç»Ÿåˆå§‹åŒ– + æ·±åº¦æ¸…ç† ======================================
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ– + å…¨åŸŸæ·±åº¦æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 1-ç³»ç»Ÿåˆå§‹åŒ– + å…¨åŸŸæ·±åº¦æ¸…ç† ====="
          sudo apt update -y -qq
          sudo apt install -y -qq curl wget jq tar gzip rclone lsof ca-certificates gnupg pigz zstd psmisc procps language-pack-zh-hans
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.config/* /var/cache/apt/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      # ====================================== Step 2ï¼šTailscale ç»„ç½‘ï¼ˆç¡¬ç¼–ç  login serverï¼Œç›´æ¥å†™æ­»å®˜æ–¹åœ°å€ï¼‰ ======================================
      - name: 2-Tailscale ç»„ç½‘ï¼ˆç¡¬ç¼–ç å®˜æ–¹ login serverï¼Œæ— éœ€ secretsï¼‰
        run: |
          set -e
          echo "===== 2-Tailscale ç»„ç½‘ï¼ˆå®˜æ–¹ login server ç¡¬ç¼–ç ï¼‰ ====="
          # 2.1 å®‰è£… Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          sleep 2

          # 2.2 ğŸ”¥ ç›´æ¥ç¡¬ç¼–ç  login serverï¼Œä¸è¯» secretsã€ä¸æå˜é‡
          sudo tailscale up \
            --auth-key="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --login-server="https://controlplane.tailscale.com" \
            --accept-routes \
            --accept-dns \
            --reset

          sleep 5

          # 2.3 æŸ¥çœ‹ Tailscale çŠ¶æ€
          echo "âœ… Tailscale çŠ¶æ€ï¼š"
          tailscale status
          echo "âœ… è™šæ‹Ÿå†…ç½‘ç»„ç½‘å®Œæˆ"

      # ====================================== Step 3ï¼šå®‰è£… Docker ======================================
      - name: 3-å®‰è£… Dockerï¼ˆå®˜æ–¹æº + é˜¿é‡Œäº‘é•œåƒï¼‰
        run: |
          set -e
          echo "===== 3-å®‰è£… Docker ====="
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Docker å®‰è£…å®Œæˆ"

      # ====================================== Step 4ï¼šå®‰è£… CasaOSï¼ˆç¦ç”¨è‡ªå¯ï¼‰ ======================================
      - name: 4-å®‰è£… CasaOSï¼ˆå®‰è£…åç¦ç”¨è‡ªå¯ï¼Œä¸¥æ ¼é¡ºåºï¼‰
        run: |
          set -e
          echo "===== 4-å®‰è£… CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos
          echo "âœ… CasaOS å®‰è£…å®Œæˆï¼ˆå·²ç¦ç”¨è‡ªå¯ï¼‰"

      # ====================================== Step 5ï¼šé…ç½® roots ç®¡ç†å‘˜ ======================================
      - name: 5-é…ç½® roots ç®¡ç†å‘˜ï¼ˆå…å¯† + Docker æƒé™ï¼‰
        run: |
          set -e
          echo "===== 5-é…ç½® roots ç®¡ç†å‘˜ ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ]; then
            printf "%s:%s\n" "$USER_NAME" "$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            printf "%s:%s\n" "$USER_NAME" "$RANDOM_PASS" | sudo chpasswd
            echo "::add-mask::$RANDOM_PASS"
            echo "ğŸ”‘ roots éšæœºå¯†ç å·²ç”Ÿæˆ"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç®¡ç†å‘˜é…ç½®å®Œæˆ"

      # ====================================== Step 6ï¼šé…ç½® rclone è¿æ¥å…¬ç½‘ OpenListï¼ˆæœ¬æœºä»£ç†ï¼‰ ======================================
      - name: 6-é…ç½® rclone è¿æ¥å…¬ç½‘ OpenListï¼ˆæœ¬æœºä»£ç†Â·å¾®è½¯äº‘ç›˜ï¼‰
        run: |
          set -e
          echo "===== 6-é…ç½® rcloneï¼ˆå…¬ç½‘ OpenList æœ¬æœºä»£ç†ï¼‰ ====="
          if [ -z "$WEBDAV_URL$WEBDAV_USER$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV ä¿¡æ¯æœªé…ç½®"
            exit 1
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          sudo rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            vendor="onedrive" \
            --config "$RCLONE_CONFIG"
          sudo chmod 600 "$RCLONE_CONFIG"
          sudo rclone mkdir mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" 2>/dev/null || true

          TEST_FILE="test-openlist-$(date +%s).txt"
          echo "OpenList Native Proxy Test" | tee /tmp/"$TEST_FILE" >/dev/null
          if ! sudo rclone copy "/tmp/$TEST_FILE" mywebdav:"$WEBDAV_SNAPSHOT_DIR"/ --config "$RCLONE_CONFIG" -q; then
            echo "âŒ OpenList è¿æ¥å¤±è´¥"
            exit 1
          fi
          sudo rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$TEST_FILE" --config "$RCLONE_CONFIG" -q
          rm -f /tmp/$TEST_FILE
          echo "âœ… OpenList è¿æ¥æ­£å¸¸"

          REMOTE_SNAPSHOT=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" \
            | grep casaos-full-snapshot | grep -E "\.tar\.zst$" \
            | sed 's/^[0-9]\+ //' | sort -r | head -1 | tr -d '\n')
          if [ -n "$REMOTE_SNAPSHOT" ]; then
            echo "âœ… æ£€æµ‹åˆ°å†å²å¤‡ä»½ï¼š$REMOTE_SNAPSHOT"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOT" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… æ— å†å²å¤‡ä»½"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi

      # ====================================== Step 7ï¼šæ¢å¤å†å²å¤‡ä»½ ======================================
      - name: 7-æ¢å¤å†å²å¤‡ä»½ï¼ˆç²¾ç®€ç‰ˆÂ·æ—  Docker é•œåƒï¼‰
        if: ${{ env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== 7-æ¢å¤å†å²å¤‡ä»½ ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -f "docker|containerd|casaos" 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sync && sleep 2

          echo "ğŸ”½ ä¸‹è½½å¤‡ä»½ï¼š$LATEST_SNAPSHOT"
          sudo rclone copy mywebdav:"$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" /tmp/ \
            --config "$RCLONE_CONFIG" \
            --transfers $RCLONE_TRANSFERS \
            --buffer-size $RCLONE_BUFFER \
            --webdav-chunk-size $WEBDAV_CHUNK_SIZE \
            --max-redirect $MAX_REDIRECT \
            --timeout $TIMEOUT \
            --contimeout $CONTIMEOUT \
            $WEBDAV_EXTRA_FLAGS \
            --resume \
            --progress

          echo "ğŸ—‚ï¸ è§£å‹æ¢å¤ç³»ç»Ÿ"
          zstd -d -c "/tmp/$LATEST_SNAPSHOT" | sudo tar -xPf - -C / --overwrite $PERSONAL_DATA_DIRS
          sudo rm -f "/tmp/$LATEST_SNAPSHOT"

          sudo chown -R root:docker /var/lib/docker
          sudo chmod -R 750 /var/lib/docker
          sudo chown -R root:root /etc/casaos /var/lib/casaos
          sudo chmod -R 755 /etc/casaos /var/lib/casaos
          sudo chown -R roots:roots /DATA /root/.config
          sudo chmod -R 775 /DATA /root/.config
          echo "âœ… å¤‡ä»½æ¢å¤å®Œæˆ"

      # ====================================== Step 8ï¼šä¸¥æ ¼é¡ºåºå¯åŠ¨ Docker â†’ æ‹‰å–æ‰€æœ‰é•œåƒ â†’ è¿è¡Œæ‰€æœ‰å®¹å™¨ ======================================
      - name: 8-ã€ä¸¥æ ¼é¡ºåºã€‘å®Œæ•´å¯åŠ¨ Docker â†’ æ‹‰å–æ‰€æœ‰é•œåƒ â†’ è¿è¡Œæ‰€æœ‰å®¹å™¨
        run: |
          set -e
          echo "===== 8-ã€ä¸¥æ ¼é¡ºåºã€‘Docker å…¨é‡å¯åŠ¨ + é•œåƒæ‹‰å– + å®¹å™¨è¿è¡Œ ====="
          sudo systemctl daemon-reload
          sudo systemctl restart docker containerd
          sleep 15

          IMAGES=$(docker ps -a --format "{{.Image}}" | grep -v "^$" | sort | uniq)
          if [ -z "$IMAGES" ]; then
            echo "âœ… æ— å®¹å™¨ï¼Œè·³è¿‡æ‹‰å–é•œåƒ"
            exit 0
          fi

          echo "ğŸš€ æ‰¹é‡æ‹‰å–é•œåƒï¼š"
          for IMG in $IMAGES; do
            echo "Pulling: $IMG"
            docker pull "$IMG"
          done

          echo "ğŸ”„ é‡å¯æ‰€æœ‰å®¹å™¨"
          docker restart $(docker ps -a -q)
          sleep 40
          echo "âœ… Docker å®Œå…¨å°±ç»ª"
          docker ps

      # ====================================== Step 9ï¼šDocker å®Œå…¨å°±ç»ªåï¼Œæœ€åå¯åŠ¨ CasaOS ======================================
      - name: 9-ã€æœ€åå¯åŠ¨ã€‘Docker 100% å°±ç»ªåï¼Œå¯åŠ¨ CasaOS
        run: |
          set -e
          echo "===== 9-ã€æœ€åå¯åŠ¨ã€‘CasaOSï¼ˆDocker å·²å®Œå…¨å°±ç»ªï¼‰ ====="
          sudo systemctl enable --now casaos
          sleep 15
          echo "âœ… CasaOS å¯åŠ¨å®Œæˆï¼ˆæ— é•œåƒä¸å®Œæ•´æŠ¥é”™ï¼‰"

      # ====================================== Step 10ï¼šç³»ç»Ÿç¨³å®šå»¶æ—¶ ======================================
      - name: 10-ç³»ç»Ÿç¨³å®šå»¶æ—¶
        run: |
          set -e
          echo "===== 10-ç³»ç»Ÿç¨³å®šå»¶æ—¶ $TARGET_RUN_MINUTES åˆ†é’Ÿ ====="
          sleep $((TARGET_RUN_MINUTES * 60))
          echo "âœ… ç³»ç»Ÿç¨³å®š"

      # ====================================== Step 11ï¼šæ‰“åŒ…ç²¾ç®€å¤‡ä»½ï¼ˆzstd-19ï¼‰ ======================================
      - name: 11-æ‰“åŒ…ç²¾ç®€å¤‡ä»½ï¼ˆæ—  Docker é•œåƒÂ·zstd-19ï¼‰
        run: |
          set -e
          echo "===== 11-æ‰“åŒ…ç²¾ç®€å¤‡ä»½ï¼ˆzstd-19ï¼‰ ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -f "docker|containerd|casaos" 2>/dev/null || true
          sync && sleep 2

          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          echo "ğŸ—œï¸ ç”Ÿæˆå¤‡ä»½ï¼š$SNAPSHOT_NAME"

          sudo tar -cPf - --warning=no-file-changed $PERSONAL_DATA_DIRS \
            | zstd -$ZSTD_LEVEL -T$PARALLEL_CORE \
            > /tmp/$SNAPSHOT_NAME

          echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" >> "$GITHUB_ENV"
          echo "âœ… å¤‡ä»½å®Œæˆï¼š$(du -h /tmp/$SNAPSHOT_NAME)"

      # ====================================== Step 12ï¼šä¸Šä¼ å¤‡ä»½åˆ°å…¬ç½‘ OpenListï¼ˆæœ¬æœºä»£ç†ï¼‰ ======================================
      - name: 12-ä¸Šä¼ å¤‡ä»½åˆ°å…¬ç½‘ OpenListï¼ˆæœ¬æœºä»£ç†Â·å¾®è½¯äº‘ç›˜ï¼‰
        run: |
          set -e
          echo "===== 12-ä¸Šä¼ å¤‡ä»½åˆ° OpenList ====="
          SNAPSHOT_NAME="$SNAPSHOT_NAME"
          sudo rclone copy /tmp/$SNAPSHOT_NAME mywebdav:"$WEBDAV_SNAPSHOT_DIR"/ \
            --config "$RCLONE_CONFIG" \
            --transfers $RCLONE_TRANSFERS \
            --buffer-size $RCLONE_BUFFER \
            --webdav-chunk-size $WEBDAV_CHUNK_SIZE \
            --max-redirect $MAX_REDIRECT \
            --timeout $TIMEOUT \
            --contimeout $CONTIMEOUT \
            $WEBDAV_EXTRA_FLAGS \
            --resume \
            --retries 10 \
            --retries-sleep 60s \
            --stats 30s \
            --progress
          sudo rm -f /tmp/$SNAPSHOT_NAME
          echo "âœ… ä¸Šä¼ å®Œæˆ"

      # ====================================== Step 13ï¼šè‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ ======================================
      - name: 13-è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€æ–° 2 ä»½ï¼‰
        run: |
          set -e
          echo "===== 13-è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ ====="
          OLD_SNAPSHOTS=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" \
            | grep casaos-full-snapshot | grep -E "\.tar\.zst$" \
            | sed 's/^[0-9]\+ //' | sort -r | tail -n +$((KEEP_BACKUPS+1)) | tr '\n' ' ')
          if [ -n "$OLD_SNAPSHOTS" ]; then
            for snap in $OLD_SNAPSHOTS; do
              sudo rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$snap" --config "$RCLONE_CONFIG" -q
            done
            echo "âœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆ"
          fi

      # ====================================== Step 14ï¼šè‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½ ======================================
      - name: 14-è‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½
        run: |
          set -e
          echo "===== 14-è‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½ ====="
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            curl -s -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}' >/dev/null 2>&1
            echo "âœ… ä¸‹ä¸€è½®å¤‡ä»½å·²è§¦å‘"
          fi

      # ====================================== Step 15ï¼šæœ€ç»ˆæ¸…ç† ======================================
      - name: 15-æœ€ç»ˆæ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 15-æœ€ç»ˆæ¸…ç† ====="
          sudo rm -rf /tmp/casaos-full-snapshot-* "$RCLONE_CONFIG" /etc/sudoers.d/roots 2>/dev/null || true
          echo "âœ… å…¨éƒ¨æ¸…ç†å®Œæˆ"
          echo "ğŸ‰ CasaOS ç²¾ç®€å¤‡ä»½ï¼ˆTailscale ç¡¬ç¼–ç  login serverÂ·æœ¬æœºä»£ç†Â·ä¸¥æ ¼é¡ºåºÂ·zstd-19ï¼‰å…¨æµç¨‹å®Œæˆ"