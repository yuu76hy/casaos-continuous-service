name: 1Panel-Docker-å¿«ç…§å¤‡ä»½æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_1panel_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu"
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /opt/1panel /usr/bin/1panel /etc/systemd/system /DATA"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/var/lib/docker/tmp
        --exclude=/DATA/tmp --exclude=/DATA/ç¼“å­˜ --exclude=/DATA/logs
        --exclude=/opt/1panel/logs --exclude=/opt/1panel/tmp
        --exclude=/etc/systemd/system/*.wants
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: 1. ç¯å¢ƒåˆå§‹åŒ–ï¼ˆæµ·å¤–æœåŠ¡å™¨é€‚é…ï¼‰
        run: |
          set -e
          # ä¿®å¤systemdç›®å½•
          sudo mkdir -p /etc/systemd/system && sudo rm -rf /est/systemd/system 2>/dev/null || true
          
          # æµ·å¤–APTæºé…ç½®
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb http://archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-backports main restricted universe multiverse
          EOF
          
          # å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl dnsutils apt-transport-https ca-certificates gnupg lsb-release
          sudo locale-gen zh_CN.UTF-8 && export LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          
          # å®‰è£…rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # é…ç½®sudoå…å¯†
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner && sudo mkdir -p /DATA && sudo chmod 755 /DATA
          
          # ç½‘ç»œè¿é€šæ€§æ ¡éªŒ
          echo "âœ… æ ¡éªŒç½‘ç»œè¿é€šæ€§..."
          curl -fsSL https://github.com >/dev/null 2>&1 || { echo "âŒ æ— æ³•è¿æ¥GitHub"; exit 1; }
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºrootsç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            echo "roots:${ROOTS_PASSWORD:-$(openssl rand -base64 12)}" | sudo chpasswd
            sudo usermod -aG sudo,docker roots
            echo "âœ… rootsç”¨æˆ·åˆ›å»ºæˆåŠŸ"
          fi

      - name: 3. é…ç½®WebDAVï¼ˆRcloneï¼‰
        id: webdav-config
        run: |
          set -e
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ ç¼ºå°‘WebDAVå‡­è¯ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
            echo "webav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # é…ç½®Rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="webdav" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          
          # æ ¡éªŒWebDAVè¿æ¥
          rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1 || { echo "âŒ WebDAVè¿æ¥å¤±è´¥"; echo "webav_available=false" >> "$GITHUB_OUTPUT"; exit 0; }
          
          # è·å–æœ€æ–°å¿«ç…§
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep "1panel-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r | head -n1)
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "latest_snapshot=${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" >> "$GITHUB_OUTPUT"
            echo "âœ… æœ€æ–°å¿«ç…§ï¼š$LATEST_SNAPSHOT"
          fi
          echo "webav_available=true" >> "$GITHUB_OUTPUT"

      - name: 4. ä»WebDAVæ¢å¤å¿«ç…§
        if: ${{ steps.webdav-config.outputs.webav_available == 'true' && steps.webdav-config.outputs.latest_snapshot != '' }}
        id: restore
        run: |
          set -e
          SNAPSHOT_PATH=${{ steps.webdav-config.outputs.latest_snapshot }}
          echo "===== å¼€å§‹æ¢å¤å¿«ç…§ï¼š$SNAPSHOT_PATH ====="
          
          # åœæ­¢æœåŠ¡+æŸ¥æ€è¿›ç¨‹
          sudo systemctl stop 1panel docker containerd 2>/dev/null || true
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          sudo pkill -9 docker containerd 1panel 2>/dev/null || true
          sync && sleep 3
          
          # æ ¡éªŒå¿«ç…§æœ‰æ•ˆæ€§
          rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1 || { echo "âŒ å¿«ç…§æ— æ•ˆ"; echo "restore_success=false" >> "$GITHUB_OUTPUT"; exit 1; }
          
          # æ¢å¤å¿«ç…§ï¼šä¿ç•™æƒé™+ç»å¯¹è·¯å¾„
          rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions --preserve-owner --absolute-names $EXCLUDE_RULES
          
          # æ¸…ç†å†²çªçš„mobyåŒ…ï¼Œé‡è£…Dockerå®˜æ–¹å¥—ä»¶
          sudo apt purge -y moby* containerd* runc* -y || true
          sudo apt autoremove -y && sudo apt clean
          curl -fsSL https://get.docker.com | sudo bash
          
          # æ¸…ç†æ—§å¿«ç…§
          rclone delete mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt --config /home/runner/.rclone.conf
          
          echo "âœ… å¿«ç…§æ¢å¤æˆåŠŸ"
          echo "restore_success=true" >> "$GITHUB_OUTPUT"

      - name: 5. æ¸…ç†æ®‹ç•™ï¼ˆæ¢å¤å¤±è´¥æ—¶æ‰§è¡Œï¼‰
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== æ¸…ç†1Panel/Dockeræ®‹ç•™ ====="
          sudo systemctl stop 1panel docker containerd 2>/dev/null || true
          sudo pkill -9 docker containerd 1panel 2>/dev/null || true
          sync && sleep 3
          
          # æ¸…ç†å®¹å™¨/é•œåƒ/å·
          if sudo docker info >/dev/null 2>&1; then
            sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true
            sudo docker rmi -f $(sudo docker images -aq) 2>/dev/null || true
            sudo docker volume rm -f $(sudo docker volume ls -q) 2>/dev/null || true
          fi
          
          # æ¸…ç†å†²çªåŒ…+æ–‡ä»¶
          sudo apt purge -y docker* moby* containerd* runc* -y || true
          sudo apt autoremove -y && sudo apt clean
          sudo rm -rf /opt/1panel /etc/1panel /var/lib/docker /etc/docker /var/lib/containerd /DATA/1panel*
          echo "âœ… æ®‹ç•™æ¸…ç†å®Œæˆ"

      - name: 6. å®‰è£…Docker+1Panelï¼ˆæ¢å¤å¤±è´¥æ—¶æ‰§è¡Œï¼‰
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== å®‰è£…Dockerç¯å¢ƒï¼ˆå®˜æ–¹è„šæœ¬ï¼‰ ====="
          # å½»åº•æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œè§£å†³ä¾èµ–å†²çª
          sudo apt purge -y docker* moby* containerd* runc* -y || true
          sudo apt autoremove -y && sudo apt clean
          
          # ä½¿ç”¨Dockerå®˜æ–¹ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆè‡ªåŠ¨é€‚é…Ubuntu 24.04ï¼‰
          curl -fsSL https://get.docker.com | sudo bash
          
          # é…ç½®Dockeræƒé™+è‡ªå¯
          sudo usermod -aG docker runner
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          sudo systemctl enable --now docker.service containerd.service
          sleep 10
          
          # éªŒè¯Dockerå¯åŠ¨
          sudo systemctl is-active --quiet docker || { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          echo "âœ… Dockerå®‰è£…å®Œæˆ"
          
          # å®‰è£…1Panel
          echo "===== å®‰è£…1Panel ====="
          curl -fsSL https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash - || { cat /tmp/1panel-install.log; exit 1; }
          sudo systemctl enable --now 1panel.service && sleep 5
          sudo systemctl is-active --quiet 1panel || sudo 1panel repair
          echo "âœ… 1Panelå®‰è£…å®Œæˆ"

      - name: 7. é‡å¯æœåŠ¡ï¼ˆæ¢å¤æˆåŠŸæ—¶æ‰§è¡Œï¼‰
        if: ${{ steps.restore.outputs.restore_success == 'true' }}
        run: |
          set -e
          echo "===== é‡å¯1Panel/DockeræœåŠ¡ ====="
          sudo systemctl reset-failed docker.service containerd.service 1panel.service
          sudo systemctl daemon-reload && sleep 15
          
          # æŒ‰ä¾èµ–é¡ºåºå¯åŠ¨
          sudo systemctl enable --now containerd.service && sleep 3
          sudo systemctl enable --now docker.service && sleep 10
          sudo systemctl enable --now 1panel.service && sleep 5
          
          # éªŒè¯æœåŠ¡çŠ¶æ€
          sudo systemctl is-active --quiet docker || { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; sudo journalctl -xeu docker.service --no-pager | head -50; exit 1; }
          sudo systemctl is-active --quiet 1panel || { echo "âŒ 1Panelå¯åŠ¨å¤±è´¥"; sudo 1panel repair; }
          echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ"

      - name: 8. éƒ¨ç½²Tailscale
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then echo "âš ï¸ ç¼ºå°‘Tailscaleå¯†é’¥ï¼Œè·³è¿‡"; exit 0; fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y && sudo apt install -y tailscale
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="1panel-snapshot-${{ github.run_id }}"
          echo "âœ… Tailscale IP: $(sudo tailscale ip -4)"

      - name: 9. åˆ›å»ºå¿«ç…§+ä¸Šä¼ WebDAV+ç»­è·‘è§¦å‘
        if: ${{ steps.webdav-config.outputs.webav_available == 'true' }}
        run: |
          set -e
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # åœæ­¢æ—§å®¹å™¨å‡½æ•°
          stop_old_containers() {
            if sudo docker info >/dev/null 2>&1; then
              OLD_CONTAINERS=$(sudo docker ps -aq)
              [ -n "$OLD_CONTAINERS" ] && sudo docker rm -f $OLD_CONTAINERS && echo "âœ… æ—§å®¹å™¨å·²æ¸…ç†" || echo "âš ï¸ æ— æ—§å®¹å™¨"
            fi
          }
          
          # è§¦å‘ç»­è·‘å‡½æ•°
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then echo "âŒ ç¼ºå°‘PAT/ä»“åº“ä¿¡æ¯"; return 1; fi
            stop_old_containers
            curl -fsSL --fail -X POST -H "Authorization: token $USER_PAT" -H "Accept: application/vnd.github.v3+json" -H "Content-Type: application/json" "https://api.github.com/repos/$REPO/dispatches" -d '{"event_type":"renew_1panel_snapshot"}' && echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ" || return 1
            RENEW_TRIGGERED=true
          }
          
          # åˆ›å»ºå¿«ç…§å‡½æ•°
          create_snapshot() {
            # è¿‡æ»¤æœ‰æ•ˆç›®å½•
            VALID_DIRS=""
            for dir in $CORE_BACKUP_DIRS; do [ -d "$dir" ] && VALID_DIRS="$VALID_DIRS $dir"; done
            [ -z "$VALID_DIRS" ] && echo "âŒ æ— æœ‰æ•ˆå¤‡ä»½ç›®å½•" && return 1
            
            # ç”Ÿæˆå¿«ç…§åç§°
            SNAPSHOT_NAME="1panel-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/$SNAPSHOT_NAME"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_DIR}/$SNAPSHOT_NAME"
            
            # åœæ­¢æœåŠ¡+åˆ›å»ºå¿«ç…§
            sudo systemctl stop 1panel docker containerd 2>/dev/null || true
            sudo pkill -9 docker containerd 1panel 2>/dev/null || true
            sync && sleep 5
            sudo tar -czf "$TMP_SNAPSHOT" --absolute-names --ignore-failed-read --preserve-permissions --preserve-owner --acls --xattrs $EXCLUDE_RULES $VALID_DIRS
            sudo chown runner:runner "$TMP_SNAPSHOT"
            
            # æ ¡éªŒå¿«ç…§+ä¸Šä¼ 
            [ $(stat -c%s "$TMP_SNAPSHOT") -lt 1024 ] && echo "âŒ å¿«ç…§æ— æ•ˆ" && return 1
            sudo -u runner rclone copy "$TMP_SNAPSHOT" "$REMOTE_PATH" --config /home/runner/.rclone.conf --transfers 4 || { echo "âŒ ä¸Šä¼ å¤±è´¥"; return 1; }
            
            # ç”Ÿæˆå…ƒæ•°æ®ï¼ˆä¿®å¤YAMLè¯­æ³•é”™è¯¯ï¼šæ”¹ç”¨printfï¼Œé¿å…æ¢è¡Œç¬¦é—®é¢˜ï¼‰
            printf "snapshot_name=%s\ncreate_time=%s\nsnapshot_size=%s\ndocker_version=%s\n1panel_version=%s\n" \
              "$SNAPSHOT_NAME" \
              "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              "$(du -sh $TMP_SNAPSHOT | awk '{print $1}')" \
              "$(docker -v | awk '{print $3}' | sed 's/,//g')" \
              "$(1panel -v 2>/dev/null | awk '{print $3}' || echo 'unknown')" | sudo tee /tmp/snapshot_meta.txt
            
            sudo -u runner rclone copy /tmp/snapshot_meta.txt "mywebdav:${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶+å¯åŠ¨æœåŠ¡
            rm -f "$TMP_SNAPSHOT" /tmp/snapshot_meta.txt
            sudo systemctl start docker containerd 1panel 2>/dev/null || true
            echo "âœ… å¿«ç…§åˆ›å»º+ä¸Šä¼ æˆåŠŸ"
            return 0
          }
          
          # å¾ªç¯æ‰§è¡Œï¼šåˆ›å»ºå¿«ç…§+è§¦å‘ç»­è·‘
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Š è¿è¡Œæ—¶é•¿ï¼š$run_mins åˆ†é’Ÿ"
            
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              create_snapshot && trigger_renew
            fi
            
            [ $run_mins -ge $MAX_RUN_MINUTES ] && { echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œé€€å‡º"; exit 0; }
            sleep 60
          done

      - name: 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          sudo rm -rf /tmp/1panel-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
