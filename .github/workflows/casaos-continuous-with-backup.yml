name: CasaOS Cloud Instance

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'
  workflow_call:

env:
  SOURCE_DIRS: "/var/lib/casaos /var/lib/docker /DATA"
  BACKUP_BUCKET: "/z/Ubu"
  WEBDAV_MOUNT_POINT: "/home/runner/webdav_mount"
  WEBDAV_REMOTE_NAME: "mywebdav"
  RCLONE_CACHE_DIR: "/home/runner/rclone_cache"
  EXCLUDE_LIST: >
    /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
    /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
    /usr/share/doc /usr/share/man /usr/share/locale
    /etc/ssl/certs /etc/fstab /etc/mtab /etc/hostname /etc/machine-id
    /var/lib/docker/tmp /var/lib/docker/overlay2 "/var/lib/docker/containers/*/mounts"
    /var/lib/docker/network/files /var/lib/docker/buildkit /var/lib/docker/runtimes
    /var/lib/docker/swarm /var/lib/docker/trust

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ðŸ“¦ Prepare Environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rclone rsync curl wget fuse
          echo 'user_allow_other' | sudo tee -a /etc/fuse.conf > /dev/null
          mkdir -p "${{ env.WEBDAV_MOUNT_POINT }}" "${{ env.RCLONE_CACHE_DIR }}"
          mkdir -p ~/.config/rclone
          FREE_SPACE=$(df -BM / | awk 'NR==2 {gsub(/M/,""); print $4}')
          if [ "$FREE_SPACE" -lt 10240 ]; then
            echo "å‰©ä½™ç£ç›˜ç©ºé—´ä¸è¶³10GBï¼ˆå½“å‰ï¼š${FREE_SPACE}MBï¼‰ï¼Œé€€å‡º"
            exit 1
          fi
          rclone --version || { echo "rcloneå®‰è£…å¤±è´¥"; exit 1; }
          rsync --version || { echo "rsyncå®‰è£…å¤±è´¥"; exit 1; }

      - name: ðŸŒ Mount WebDAV
        if: ${{ secrets.WEBDAV_URL != '' }}
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        uses: nick-fields/retry@v2
        with:
          max_attempts: 3
          retry_delay_seconds: 10
          command: |
            ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
            cat > ~/.config/rclone/rclone.conf << EOF
[${{ env.WEBDAV_REMOTE_NAME }}]
type = webdav
url = $WEBDAV_URL
vendor = other
user = $WEBDAV_USER
pass = $ENCRYPTED_PASS
EOF
            cat ~/.config/rclone/rclone.conf | grep -v 'pass ='
            rclone mount "${{ env.WEBDAV_REMOTE_NAME }}:${{ env.BACKUP_BUCKET }}" "${{ env.WEBDAV_MOUNT_POINT }}" \
              --allow-other --vfs-cache-mode full --vfs-cache-dir "${{ env.RCLONE_CACHE_DIR }}" \
              --daemon --timeout 5m --dir-cache-time 10m --poll-interval 10s \
              --log-level INFO --log-file /tmp/rclone_mount.log
            sleep 10
            mountpoint -q "${{ env.WEBDAV_MOUNT_POINT }}" || { 
              echo "WebDAVæŒ‚è½½å¤±è´¥ï¼Œæ—¥å¿—ï¼š"; 
              cat /tmp/rclone_mount.log; 
              exit 1; 
            }
            echo "WebDAVæŒ‚è½½æˆåŠŸï¼ŒæŒ‚è½½ç‚¹ï¼š${{ env.WEBDAV_MOUNT_POINT }}"

      - name: ðŸ“¥ Restore Data
        if: ${{ secrets.WEBDAV_URL != '' }}
        uses: nick-fields/retry@v2
        with:
          max_attempts: 2
          retry_delay_seconds: 15
          command: |
            echo "å¼€å§‹æ¢å¤æ•°æ®ï¼Œæºç›®å½•ï¼š${{ env.SOURCE_DIRS }}"
            readarray -t EXCLUDE_DIRS < <(echo "${{ env.EXCLUDE_LIST }}" | tr ' ' '\n' | grep -v '^$')
            
            while IFS= read -r dir; do
              webdav_src="${{ env.WEBDAV_MOUNT_POINT }}$dir"
              if [ -d "$webdav_src" ]; then
                echo "æ¢å¤ç›®å½•ï¼š$dir ä»Ž $webdav_src"
                sudo mkdir -p "$dir"
                exclude_params=()
                for excl in "${EXCLUDE_DIRS[@]}"; do
                  if [[ "$excl" == "$dir"* ]]; then
                    exclude_params+=("--exclude=$excl")
                    echo "æŽ’é™¤è·¯å¾„ï¼š$excl"
                  fi
                done
                sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                  "${exclude_params[@]}" \
                  --log-file=/tmp/rsync_restore_$(echo $dir | tr '/' '_').log \
                  "$webdav_src/" "$dir/"
              else
                echo "æºç›®å½•ä¸å­˜åœ¨ï¼š$webdav_srcï¼Œè·³è¿‡æ¢å¤"
              fi
            done < <(echo "${{ env.SOURCE_DIRS }}" | tr ' ' '\n' | grep -v '^$')

      - name: ðŸ  Install CasaOS
        if: ${{ secrets.WEBDAV_URL == '' || github.event_name != 'schedule' }}
        run: |
          echo "æ£€æŸ¥å¹¶å®‰è£…CasaOS..."
          if ! command -v casaos-service &> /dev/null; then
            curl -fsSL https://get.casaos.io | sudo bash -x
          fi
          sudo mkdir -p /DATA
          sudo chown -R root:root /DATA
          sudo chmod 775 /DATA
          casaos-service --version || { echo "CasaOSå®‰è£…å¤±è´¥"; exit 1; }

      - name: â–¶ï¸ Start Services
        run: |
          echo "å¯åŠ¨Dockerå’ŒCasaOSæœåŠ¡..."
          sudo systemctl daemon-reload
          sudo systemctl enable docker casaos
          sudo systemctl start docker casaos
          sleep 15
          sudo systemctl status docker --no-pager || { echo "Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          sudo systemctl status casaos --no-pager || { echo "CasaOSå¯åŠ¨å¤±è´¥"; exit 1; }

      - name: ðŸ” Connect Tailscale
        if: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "å®‰è£…å¹¶è¿žæŽ¥Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="$TS_AUTH_KEY" --hostname=CasaOS-Cloud --accept-routes
          tailscale status || { echo "Tailscaleè¿žæŽ¥å¤±è´¥"; exit 1; }

      - name: ðŸ”„ Run & Backup Loop
        if: ${{ secrets.WEBDAV_URL != '' }}
        run: |
          echo "å¼€å§‹å¤‡ä»½å¾ªçŽ¯ï¼ˆæ¯5å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰..."
          MAX_LOOPS=1
          CURRENT_LOOP=0
          
          while [ $CURRENT_LOOP -lt $MAX_LOOPS ]; do
            echo "æ‰§è¡Œå¤‡ä»½ï¼ˆç¬¬$((CURRENT_LOOP+1))æ¬¡ï¼‰ - $(date)"
            sudo docker pause $(sudo docker ps -q) 2>/dev/null || true
            
            while IFS= read -r dir; do
              backup_dst="${{ env.WEBDAV_MOUNT_POINT }}$dir"
              if [ -d "$dir" ]; then
                echo "å¤‡ä»½ç›®å½•ï¼š$dir åˆ° $backup_dst"
                sudo mkdir -p "$backup_dst"
                exclude_params=()
                readarray -t EXCLUDE_DIRS < <(echo "${{ env.EXCLUDE_LIST }}" | tr ' ' '\n' | grep -v '^$')
                for excl in "${EXCLUDE_DIRS[@]}"; do
                  if [[ "$excl" == "$dir"* ]]; then
                    exclude_params+=("--exclude=$excl")
                  fi
                done
                sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                  "${exclude_params[@]}" \
                  --log-file=/tmp/rsync_backup_$(echo $dir | tr '/' '_').log \
                  "$dir/" "$backup_dst/"
              else
                echo "å¾…å¤‡ä»½ç›®å½•ä¸å­˜åœ¨ï¼š$dirï¼Œè·³è¿‡"
              fi
            done < <(echo "${{ env.SOURCE_DIRS }}" | tr ' ' '\n' | grep -v '^$')
            
            sudo docker unpause $(sudo docker ps -q) 2>/dev/null || true
            echo "æœ¬æ¬¡å¤‡ä»½å®Œæˆ - $(date)"
            
            CURRENT_LOOP=$((CURRENT_LOOP+1))
            if [ $CURRENT_LOOP -lt $MAX_LOOPS ]; then
              sleep 18000
            fi
          done

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ‰§è¡Œæ¸…ç†æ“ä½œ..."
          pkill -f "while true; do echo æ‰§è¡Œå¤‡ä»½" || true
          sudo docker unpause $(sudo docker ps -q) 2>/dev/null || true
          fusermount -u "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null || sudo umount -l "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null
          rm -rf /tmp/rclone_*.log /tmp/rsync_*.log "${{ env.RCLONE_CACHE_DIR }}"
          echo "æ¸…ç†å®Œæˆ"
          
          echo "=== æœ€åŽ10è¡Œrcloneæ—¥å¿— ==="
          tail -10 /tmp/rclone_mount.log 2>/dev/null || echo "æ— rcloneæ—¥å¿—"
          echo "=== æœ€åŽ10è¡Œrsyncå¤‡ä»½æ—¥å¿— ==="
          tail -10 /tmp/rsync_backup_var_lib_casaos.log 2>/dev/null || echo "æ— rsyncå¤‡ä»½æ—¥å¿—"
