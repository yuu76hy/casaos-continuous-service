name: CasaOS纯净部署（Tailscale内网版 /aaa拉取即删·自动切节点·续跑）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    env:
      # 核心目录
      DOCKER_DIR: "var/lib/docker"
      CASAOS_ETC: "etc/casaos"
      CASAOS_LIB: "var/lib/casaos"
      DATA_DIR: "DATA"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA"
      # 密钥信息
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      # ========== 新增：Tailscale 自动切换节点配置（可自行改节点名） ==========
      TAILSCALE_EXIT_NODE_US: "us"          # 美国出口节点（us/us-nyc/us-lax 都可）
      TAILSCALE_EXIT_NODE_SG: "sg"          # 新加坡出口节点（sg/sg-sin 都可）
      # ======================================================================
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"
      # 时间与重试
      TARGET_RUN_MINUTES: ${TARGET_RUN_MINUTES:-1}
      RETRY_TIMES: ${RETRY_TIMES:-3}
      MAX_POLL_TIMES: ${MAX_POLL_TIMES:-30}
      POLL_INTERVAL: 60
      ZSTD_LEVEL: 10

    steps:
      - name: 1-系统初始化+全域深度清理
        if: ${{ always() }}
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 1-系统初始化+全域深度清理 ====="
          sudo apt update -y -qq || echo "❌ apt更新失败"
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server zstd sha256sum -qq || echo "❌ 安装依赖失败"

          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload || true

          sudo rm -rf \
            /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n \
            /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google \
            2>/dev/null || true

          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true

          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          sudo systemctl enable --now ssh || true
          echo "✅ 1-系统初始化完成"

      - name: 2-官方纯净安装 Docker
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 2-安装 Docker（官方源） ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash || echo "❌ Docker安装失败"
          sudo systemctl enable docker containerd || true
          sudo systemctl stop docker containerd 2>/dev/null || true
          docker --version || echo "❌ Docker未就绪"
          sudo usermod -aG docker runner || true
          echo "✅ 2-Docker安装完成"

      - name: 3-官方纯净安装 CasaOS
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 3-安装 CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash || echo "❌ CasaOS安装失败"
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          echo "✅ 3-CasaOS安装完成"

      - name: 4-创建 roots 管理员+SSH密码登录
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 4-配置管理员用户 roots ====="
          [[ -z "${SSH_PASS}" ]] && echo "❌ ROOTS_PASSWORD 未配置" && exit 1

          USER_NAME="roots"
          if ! id -u "${USER_NAME}" &>/dev/null; then
            sudo useradd -m -s /bin/bash "${USER_NAME}" || true
          fi
          echo "${USER_NAME}:${SSH_PASS}" | sudo chpasswd || true
          echo "${USER_NAME} ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"${USER_NAME}" >/dev/null || true
          sudo chmod 0440 /etc/sudoers.d/"${USER_NAME}" || true
          sudo usermod -aG docker "${USER_NAME}" || true

          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || true
          sudo systemctl restart ssh || true
          echo "✅ 4-管理员配置完成"

      - name: 5-Tailscale 组网+上线+显示本机IP
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 5-Tailscale组网 ====="
          [[ -z "${TAILSCALE_AUTH_KEY}" ]] && echo "⚠️ Tailscale 未配置，跳过" && exit 0

          curl -fsSL https://tailscale.com/install.sh | sudo bash || echo "❌ Tailscale安装失败"
          sudo systemctl enable --now tailscaled && sleep 2 || true

          TS_SUFFIX=$((RANDOM % 10000))
          TS_HOSTNAME="CasaOS-${TS_SUFFIX}"
          echo "🔖 主机名：${TS_HOSTNAME}"

          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${TS_HOSTNAME}" --accept-routes || echo "❌ 组网失败"

          LOCAL_IP=$(hostname -I | awk '{print $1}')
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "获取失败")
          echo -e "\n=== 🖥️ IP信息 ==="
          echo "✅ 内网IP: ${LOCAL_IP}"
          echo "✅ TailscaleIP: ${TAILSCALE_IP}"
          echo "==================================="
          echo "✅ 5-Tailscale 基础组网完成"

      # ====================== 【需求1】拉取内网备份前 → 强制切换美国中继节点 ======================
      - name: 6-切换Tailscale为美国节点（拉备份专用）
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 6-切换至美国Tailscale节点（中继） ====="
          [[ -z "${TAILSCALE_AUTH_KEY}" ]] && echo "⚠️ 无Tailscale，跳过切换" && exit 0
          sudo tailscale up \
            --exit-node="${TAILSCALE_EXIT_NODE_US}" \
            --force-relay \
            --accept-routes || echo "⚠️ 切换美国节点失败，继续执行"
          sleep 3
          echo "✅ 已切换美国节点完成，准备拉取内网备份"

      - name: 7-从内网/aaa拉备份→多节点尝试→拉取即删→覆盖恢复
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 7-拉取备份+恢复 ====="
          [[ -z "${TAILSCALE_AUTH_KEY}" || -z "${SSH_PASS}" ]] && echo "⚠️ 配置不足，跳过拉取" && exit 0

          TS_STATUS_JSON=$(sudo tailscale status --json || echo "{}")
          SELF_ID=$(echo "${TS_STATUS_JSON}" | jq -r '.Self.ID' || echo "")

          echo -e "\n🔍 筛选在线CasaOS节点"
          TARGET_LIST=$(echo "${TS_STATUS_JSON}" | jq -r --arg self "${SELF_ID}" '
            .Peer[] | select(.Online==true and .ID!=$self) |
            select(.HostName|ascii_downcase|contains("casaos")) |
            "\(.HostName)//unknown|\(.TailscaleIPs[0]//no-ip)"
          ' || true)

          [[ -z "${TARGET_LIST}" ]] && echo "ℹ️ 无可用节点" && exit 0

          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl stop docker containerd 2>/dev/null || true
          sync && sleep 2

          sudo mkdir -p "${LOCAL_BACKUP_DIR}" || true
          RESTORE_SUCCESS=0

          while IFS='|' read -r TARGET_HOST TARGET_IP; do
            echo -e "\n==========================================================="
            echo "🎯 尝试节点：${TARGET_HOST} | ${TARGET_IP}"
            echo "==========================================================="

            LATEST_FILE=""
            for ((i=1; i<=RETRY_TIMES; i++)); do
              LATEST_FILE=$(sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
                "${SSH_USER}@${TARGET_IP}" "ls -t \"${REMOTE_BACKUP_BASE}\"/casaos-*.tar.zst 2>/dev/null | head -1" || true)
              [[ -n "${LATEST_FILE}" ]] && break
              sleep 2
            done
            [[ -z "${LATEST_FILE}" ]] && echo "⚠️ 无备份" && continue

            LOCAL_FILE="${LOCAL_BACKUP_DIR}/$(basename "${LATEST_FILE}")"
            pull_success=0
            for ((i=1; i<=RETRY_TIMES; i++)); do
              sudo sshpass -p "${SSH_PASS}" scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
                "${SSH_USER}@${TARGET_IP}:${LATEST_FILE}" "${LOCAL_FILE}" && pull_success=1 && break
              sleep 2
            done
            [[ ${pull_success} -ne 1 || ! -s "${LOCAL_FILE}" ]] && rm -f "${LOCAL_FILE}" && continue

            echo -e "\n🗑️ 拉取成功，删除远程源文件"
            sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              "${SSH_USER}@${TARGET_IP}" "sudo rm -f '${LATEST_FILE}'" || true

            echo -e "\n🔧 安全恢复（相对路径）"
            sudo tar --zstd -xf "${LOCAL_FILE}" -C / \
              ${DOCKER_DIR} ${CASAOS_ETC} ${CASAOS_LIB} ${DATA_DIR} \
              --overwrite --preserve-permissions || echo "❌ 解压失败"

            echo -e "\n🔐 修复权限"
            for dir in ${PERSONAL_DATA_DIRS}; do
              [[ -d "${dir}" ]] && sudo chown -R root:root "${dir}" || true
            done
            [[ -d "/etc/casaos" ]]     && sudo chmod -R 755 /etc/casaos || true
            [[ -d "/DATA" ]]           && sudo chmod -R 755 /DATA || true
            [[ -d "/var/lib/casaos" ]] && sudo chmod -R 700 /var/lib/casaos || true
            [[ -d "/var/lib/docker" ]] && sudo chmod -R 700 /var/lib/docker || true

            RESTORE_SUCCESS=1
            break
          done < <(echo "${TARGET_LIST}")

          [[ ${RESTORE_SUCCESS} -ne 1 ]] && echo -e "\n❌ 所有节点恢复失败"
          echo "✅ 7-恢复流程完成"

      - name: 8-启动 Docker & CasaOS（健康检查）
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 8-启动核心服务 ====="

          for port in 80 443; do
            if sudo lsof -i :${port} -s TCP:LISTEN &>/dev/null; then
              p=$(sudo lsof -i :${port} | grep LISTEN | awk '{print $2}' | head -1)
              [[ -n "${p}" ]] && sudo kill -TERM "${p}" 2>/dev/null || true
            fi
          done

          sudo mkdir -p /run/docker || true
          sudo systemctl daemon-reload || true

          sudo systemctl enable --now docker containerd
          for i in {1..20}; do
            docker info &>/dev/null && echo "✅ Docker 就绪" && break
            sleep 2
          done

          sudo systemctl enable --now casaos
          for i in {1..30}; do
            systemctl is-active --quiet casaos && echo "✅ CasaOS 就绪" && break
            sleep 2
          done

          echo "✅ 8-服务启动完成"

      # ====================== 【需求2】启动后 → 切换新加坡节点 ======================
      - name: 9-切换Tailscale为新加坡节点
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 9-切换至新加坡Tailscale节点 ====="
          [[ -z "${TAILSCALE_AUTH_KEY}" ]] && echo "⚠️ 无Tailscale，跳过切换" && exit 0
          sudo tailscale up \
            --exit-node="${TAILSCALE_EXIT_NODE_SG}" \
            --accept-routes || echo "⚠️ 切换新加坡节点失败，继续执行"
          sleep 3
          echo "✅ 已切换新加坡节点完成"

      - name: 10-稳定运行1分钟
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 10-稳定运行 ${TARGET_RUN_MINUTES} 分钟 ====="
          sleep $((TARGET_RUN_MINUTES * 60))
          echo "✅ 10-稳定运行完成"

      - name: 11-安全停止业务服务
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 11-停止业务服务 ====="
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sudo umount /var/lib/docker/overlay2/*/merged 2>/dev/null || true
          sudo docker system prune -a -f --volumes 2>/dev/null || true
          sync && sleep 3
          echo "✅ 11-服务已安全停止"

      - name: 12-本地全量备份（相对路径+sha256校验）
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 12-生成本地全量备份 ====="
          sudo mkdir -p "${LOCAL_BACKUP_DIR}" || true

          FREE=$(df -m / | awk 'NR==2{print $4}')
          if [[ ${FREE} -lt 2048 ]]; then
            echo "❌ 磁盘空间不足（<2GB），跳过备份"
            exit 0
          fi

          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_FILE="${LOCAL_BACKUP_DIR}/${SNAP_NAME}"

          sudo tar -cf - -C / \
            ${DOCKER_DIR} ${CASAOS_ETC} ${CASAOS_LIB} ${DATA_DIR} \
            --ignore-failed-read | sudo zstd -${ZSTD_LEVEL} -o "${LOCAL_FILE}" || echo "❌ 备份失败"

          if [[ -f "${LOCAL_FILE}" && -s "${LOCAL_FILE}" ]]; then
            sudo sha256sum "${LOCAL_FILE}" | sudo tee "${LOCAL_FILE}.sha256" >/dev/null
            echo "✅ 备份完成：${SNAP_NAME}"
            echo "BACKUP_FILE=${LOCAL_FILE}" >> "${GITHUB_ENV}"
            echo "SNAP_NAME=${SNAP_NAME}" >> "${GITHUB_ENV}"
          else
            echo "❌ 备份无效"
          fi
          echo "✅ 12-备份完成"

      # ====================== 【需求3】触发续跑后 → 切回美国节点 ======================
      - name: 13-触发下一轮续跑（仅成功时）
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 13-触发续跑 ====="
          [[ -z "${BACKUP_FILE}" || -z "${USER_PAT}" || -z "${REPO}" ]] && echo "⚠️ 跳过续跑" && exit 0

          for ((i=1; i<=2; i++)); do
            response=$(curl -s -w "%{http_code}" -o /dev/null -X POST \
              --connect-timeout 10 --max-time 15 \
              -H "Authorization: token ${USER_PAT}" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/${REPO}/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}')
            [[ "${response}" == "204" ]] && echo "✅ 续跑触发成功" && exit 0
            sleep 3
          done
          echo "❌ 续跑触发失败"

      - name: 14-触发续跑后 → 切回美国Tailscale节点
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 14-切回美国Tailscale节点 ====="
          [[ -z "${TAILSCALE_AUTH_KEY}" ]] && echo "⚠️ 无Tailscale，跳过切换" && exit 0
          sudo tailscale up \
            --exit-node="${TAILSCALE_EXIT_NODE_US}" \
            --force-relay \
            --accept-routes || echo "⚠️ 切回美国节点失败"
          sleep 3
          echo "✅ 已切回美国节点"

      - name: 15-移入/aaa并合规轮询删除
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 15-移入/aaa + 轮询检测 ====="
          [[ -z "${BACKUP_FILE}" || -z "${SNAP_NAME}" ]] && echo "ℹ️ 无备份，跳过" && exit 0

          LOCAL_AAA="/aaa"
          sudo mkdir -p "${LOCAL_AAA}" || true
          sudo chmod 775 "${LOCAL_AAA}" || true
          TARGET_FILE="${LOCAL_AAA}/${SNAP_NAME}"
          TARGET_HASH="${TARGET_FILE}.sha256"

          sudo mv -v "${BACKUP_FILE}" "${TARGET_FILE}" || true
          sudo mv -v "${BACKUP_FILE}.sha256" "${TARGET_HASH}" || true

          echo -e "\n⌛ 轮询检测：每${POLL_INTERVAL}s，最多${MAX_POLL_TIMES}次"
          poll_count=0
          while true; do
            [[ ! -f "${TARGET_FILE}" ]] && echo "🎉 文件已删除，退出轮询" && break
            ((poll_count++))
            [[ ${poll_count} -ge ${MAX_POLL_TIMES} ]] && echo "⚠️ 达到最大轮询次数，自动退出" && break
            echo "→ ${poll_count}/${MAX_POLL_TIMES} 文件存在，等待 ${POLL_INTERVAL}s"
            sleep ${POLL_INTERVAL}
          done
          echo "✅ 15-轮询完成"

      - name: 16-最终清理+Tailscale注销
        if: ${{ always() }}
        run: |
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 16-最终清理 ====="
          sudo tailscale logout 2>/dev/null || true
          sudo systemctl stop tailscaled 2>/dev/null || true

          sudo rm -rf "${LOCAL_BACKUP_DIR}" /tmp/* 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq || true
          sudo apt clean -y -qq || true
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "✅ 16-全部清理完成"
          echo -e "\n🎉 全流程安全结束"