name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è¿è¡Œ300åˆ†é’Ÿå¤‡ä»½ç»­è·‘+è‡ªåŠ¨å…³é—­ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360  # 300åˆ†é’Ÿè®¡æ—¶+60åˆ†é’Ÿå¤‡ä»½æ”¶å°¾ï¼Œé˜²è¶…æ—¶ä¸­æ–­
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 300  # ç›®æ ‡è¿è¡Œæ—¶é•¿300åˆ†é’Ÿè§¦å‘å¤‡ä»½

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+è®°å½•å¯åŠ¨æ—¶é—´æˆ³ï¼ˆè®¡æ—¶åŸºå‡†ï¼‰
        run: |
          set -e
          echo "===== ç³»ç»Ÿå¿«é€Ÿåˆå§‹åŒ–+è®°å½•å·¥ä½œæµå¯åŠ¨æ—¶é—´ ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # è®°å½•å¯åŠ¨æ—¶é—´æˆ³ï¼Œè®¡æ—¶æ ¸å¿ƒåŸºå‡†
          START_TIMESTAMP=$(date +%s)
          START_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          echo "START_TIMESTAMP=${START_TIMESTAMP}" >> "$GITHUB_ENV"
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"
          echo "ğŸ“Œ å·¥ä½œæµå¯åŠ¨æ—¶é—´ï¼š${START_TIME}"
          echo "ğŸ“Œ å¯åŠ¨æ—¶é—´æˆ³ï¼š${START_TIMESTAMP}"
          echo "ğŸ¯ æ ¸å¿ƒè§„åˆ™ï¼šè¿è¡Œæ»¡${TARGET_RUN_MINUTES}åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½ï¼Œä»…ä¿ç•™æœ€æ–°2ä»½å¤‡ä»½"

      - name: 2-å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆå«composeï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      - name: 3-åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          echo "===== åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ];then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ rootséšæœºå¯†ç ï¼š$RANDOM_PASS"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 4-WebDAVé…ç½®+å¿«ç…§æ£€æµ‹+ç›®å½•é¢„åˆ›å»º
        run: |
          set -e
          echo "===== WebDAVé…ç½®&å¿«ç…§æ£€æµ‹&ç›®å½•é¢„åˆ›å»º ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡æ‰€æœ‰å¤‡ä»½ç›¸å…³æ“ä½œ"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf; then
            echo "âš ï¸ è¿œç¨‹ç›®å½•åˆ›å»ºå¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"
            if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf; then
              echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾ï¼Œè·³è¿‡æ‰€æœ‰å¤‡ä»½ç›¸å…³æ“ä½œ"
              echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
              echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
              exit 0
            fi
          fi
          echo "âœ… è¿œç¨‹å¤‡ä»½ç›®å½•å°±ç»ª"
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å†å²å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… é¦–æ¬¡éƒ¨ç½²ï¼Œæ— å†å²å¿«ç…§ï¼Œå°†çº¯å‡€å¯åŠ¨"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: 5-çº¯å‡€å®‰è£…CasaOSï¼ˆä»…ç¨‹åºæ— æ•°æ®ï¼‰
        run: |
          set -e
          echo "===== çº¯å‡€å®‰è£…CasaOS ====="
          sudo systemctl restart docker containerd && sleep 2
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOSçº¯å‡€å®‰è£…å®Œæˆï¼Œå¾…å¯åŠ¨é…ç½®"

      - name: 6-æ¢å¤ä¸ªäººæ•°æ®ï¼ˆæ— å¿«ç…§è‡ªåŠ¨è·³è¿‡ï¼Œå·²ç§»é™¤åˆ è¿œç¨‹å¿«ç…§ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== ç²¾å‡†æ¢å¤ä¸ªäººæ•°æ® ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          echo "ğŸ“Œ æ¢å¤ç›®å½•æ¸…å•ï¼š$PERSONAL_DATA_DIRS"
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼Œæƒé™æ ¡æ­£å®Œæ¯•ã€å†å²å¿«ç…§ä¿ç•™è¿œç¨‹ï¼Œåç»­è‡ªåŠ¨æŒ‰è§„åˆ™æ¸…ç†ã€‘"

      - name: 7-æƒé™æ ¡æ­£+æé€Ÿå¯åŠ¨æ‰€æœ‰æœåŠ¡
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£+å¯åŠ¨æœåŠ¡ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          else
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          fi
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆï¼Œå…¨ç¨‹æ­£å¸¸è¿è¡Œ"
          echo "ğŸ“Œ è®¿é—®åœ°å€ï¼šæœåŠ¡å™¨å…¬ç½‘IP:80 | Tailscaleå†…ç½‘IPï¼ˆé…ç½®å³ç”Ÿæ•ˆï¼‰"
          # å®æ—¶è¾“å‡ºå½“å‰è®¡æ—¶ï¼Œè¡”æ¥åç»­ç›‘æµ‹
          CURRENT_TIMESTAMP=$(date +%s)
          RUN_SECONDS=$((CURRENT_TIMESTAMP - START_TIMESTAMP))
          RUN_MINUTES=$((RUN_SECONDS / 60))
          RUN_SECONDS_REMAIN=$((RUN_SECONDS % 60))
          REMAIN_SECONDS=$((TARGET_RUN_MINUTES*60 - RUN_SECONDS))
          REMAIN_MINUTES=$((REMAIN_SECONDS / 60))
          REMAIN_SECONDS_LAST=$((REMAIN_SECONDS % 60))
          echo "â° å½“å‰è®¡æ—¶ï¼šå·²è¿è¡Œ${RUN_MINUTES}åˆ†${RUN_SECONDS_REMAIN}ç§’ | è·ç¦»å¤‡ä»½è§¦å‘å‰©ä½™ï¼š${REMAIN_MINUTES}åˆ†${REMAIN_SECONDS_LAST}ç§’"

      - name: 8-Tailscaleè¿œç¨‹ç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          echo "===== å®‰è£…é…ç½®Tailscale ====="
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null)
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œå†…ç½‘IPï¼š${TAILSCALE_IP:-æœªè·å–}"
          # ç»„ç½‘ååŒæ­¥è®¡æ—¶æ—¥å¿—
          CURRENT_TIMESTAMP=$(date +%s)
          RUN_SECONDS=$((CURRENT_TIMESTAMP - START_TIMESTAMP))
          RUN_MINUTES=$((RUN_SECONDS / 60))
          RUN_SECONDS_REMAIN=$((RUN_SECONDS % 60))
          REMAIN_SECONDS=$((TARGET_RUN_MINUTES*60 - RUN_SECONDS))
          REMAIN_MINUTES=$((REMAIN_SECONDS / 60))
          REMAIN_SECONDS_LAST=$((REMAIN_SECONDS % 60))
          echo "â° ç»„ç½‘åè®¡æ—¶ï¼šå·²è¿è¡Œ${RUN_MINUTES}åˆ†${RUN_SECONDS_REMAIN}ç§’ | å‰©ä½™${REMAIN_MINUTES}åˆ†${REMAIN_SECONDS_LAST}ç§’è§¦å‘å¤‡ä»½"

      - name: 9-å®æ—¶ç›‘æµ‹è¿è¡Œæ—¶é•¿ï¼ˆæ¯åˆ†é’Ÿæ›´æ–°æ—¥å¿—ï¼‰æ»¡300åˆ†é’Ÿè§¦å‘å¤‡ä»½
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== å®æ—¶ç›‘æµ‹å·¥ä½œæµè¿è¡Œæ—¶é•¿ã€æ¯1åˆ†é’Ÿæ›´æ–°1æ¬¡ã€‘====="
          echo "ğŸ¯ ç›‘æµ‹ç›®æ ‡ï¼šè¿è¡Œæ»¡${TARGET_RUN_MINUTES}åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½ï¼Œä»…ä¿ç•™æœ€æ–°2ä»½å¤‡ä»½"
          echo "ğŸ“Œ å¯åŠ¨åŸºå‡†æ—¶é—´ï¼š$(date -d @"${START_TIMESTAMP}" "+%Y-%m-%d %H:%M:%S")"
          echo "====================================================="
          TARGET_SECONDS=$((TARGET_RUN_MINUTES * 60))
          
          while true; do
            # å®æ—¶è®¡ç®—æ—¶é•¿ï¼Œç²¾ç¡®åˆ°ç§’
            CURRENT_TIMESTAMP=$(date +%s)
            RUN_SECONDS=$((CURRENT_TIMESTAMP - START_TIMESTAMP))
            RUN_MINUTES=$((RUN_SECONDS / 60))
            RUN_SECONDS_REMAIN=$((RUN_SECONDS % 60))
            
            # è®¡ç®—å‰©ä½™æ—¶é•¿ï¼Œç²¾ç¡®åˆ°ç§’
            REMAIN_SECONDS=$((TARGET_SECONDS - RUN_SECONDS))
            REMAIN_MINUTES=$((REMAIN_SECONDS / 60))
            REMAIN_SECONDS_LAST=$((REMAIN_SECONDS % 60))
            
            # å®æ—¶è¾“å‡ºæ¸…æ™°æ—¥å¿—
            echo "â° å®æ—¶è¿›åº¦ | å·²è¿è¡Œï¼š${RUN_MINUTES}åˆ†${RUN_SECONDS_REMAIN}ç§’ | å‰©ä½™ï¼š${REMAIN_MINUTES}åˆ†${REMAIN_SECONDS_LAST}ç§’ | è¾¾æ ‡è‡ªåŠ¨è§¦å‘å¤‡ä»½"
            
            # æ»¡300åˆ†é’Ÿï¼Œç«‹å³è§¦å‘å¤‡ä»½
            if [ $RUN_SECONDS -ge $TARGET_SECONDS ]; then
              echo -e "\nâœ… è®¡æ—¶è¾¾æ ‡ï¼å·¥ä½œæµå·²è¿è¡Œæ»¡${TARGET_RUN_MINUTES}åˆ†é’Ÿï¼Œå³åˆ»å¯åŠ¨å¤‡ä»½+æ¸…æ—§æµç¨‹"
              echo "====================================================="
              break
            fi
            # æ¯åˆ†é’Ÿæ£€æµ‹1æ¬¡ï¼Œæ—¥å¿—å®æ—¶æ›´æ–°
            sleep 60
          done

      - name: 10-æ•°æ®å¤‡ä»½+æ¸…æ—§å¤‡ä»½ï¼ˆä»…ç•™2ä»½ï¼‰+è§¦å‘ç»­è·‘ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== è®¡æ—¶è¾¾æ ‡ï¼æ‰§è¡Œå…¨é‡å¤‡ä»½+ä»…ä¿ç•™2ä»½+è§¦å‘ç»­è·‘ ====="
          
          # æ¸…ç†æ—§å¤‡ä»½ï¼Œä¸¥æ ¼ä¿ç•™æœ€æ–°2ä»½ï¼ˆæ ¸å¿ƒè§„åˆ™ï¼‰
          cleanup_old_backups(){
            echo "ğŸ“Œ æ‰§è¡Œå¤‡ä»½æ¸…ç†è§„åˆ™ï¼šä»…ä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½å¤‡ä»½"
            BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
            BACKUP_COUNT=$(echo "$BACKUPS" | wc -l)
            if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ];then
              DELETE_COUNT=$((BACKUP_COUNT - KEEP_BACKUPS))
              DELETE_LIST=$(echo "$BACKUPS" | tail -n $DELETE_COUNT)
              echo "âš ï¸ å½“å‰å¤‡ä»½${BACKUP_COUNT}ä»½ï¼Œéœ€æ¸…ç†${DELETE_COUNT}ä»½æ—§å¤‡ä»½"
              for FILE in $DELETE_LIST;do
                rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$FILE --config /home/runner/.rclone.conf && echo "âœ… å·²åˆ é™¤æ—§å¤‡ä»½ï¼š$FILE" || echo "âš ï¸ æ—§å¤‡ä»½$FILEåˆ é™¤å¤±è´¥ï¼Œè·³è¿‡"
              done
              echo "âœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆï¼Œè¿œç¨‹ä»…ä¿ç•™æœ€æ–°2ä»½å¤‡ä»½"
            else
              echo "âœ… å½“å‰å¤‡ä»½${BACKUP_COUNT}ä»½ï¼Œæœªè¶…ä¿ç•™ä¸Šé™ï¼Œæ— éœ€æ¸…ç†"
            fi
          }
          
          # å…¨é‡å¤‡ä»½æ ¸å¿ƒæ•°æ®ï¼Œæ’é™¤å†—ä½™æ–‡ä»¶
          full_backup(){
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
            echo "ğŸ“Œ å¼€å§‹æ‰“åŒ…æ ¸å¿ƒæ•°æ®ï¼Œè‡ªåŠ¨æ’é™¤æ—¥å¿—/ç¼“å­˜/ä¸´æ—¶æ–‡ä»¶"
            if ! sudo tar -czPf $SNAPSHOT_PATH $EXCLUDE_RULES $PERSONAL_DATA_DIRS;then
              echo "âŒ æ•°æ®æ‰“åŒ…å¤±è´¥" && return 1
            fi
            SNAPSHOT_SIZE=$(du -sh $SNAPSHOT_PATH | awk '{print $1}')
            echo "âœ… æœ¬åœ°æ‰“åŒ…å®Œæˆ | æ–‡ä»¶åï¼š${SNAPSHOT_NAME} | å¤§å°ï¼š${SNAPSHOT_SIZE}"
            
            echo "ğŸ“Œ å¼€å§‹ä¸Šä¼ å¤‡ä»½è‡³WebDAVè¿œç¨‹ç›®å½•"
            if ! rclone copy $SNAPSHOT_PATH mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --transfers 4 --fast-list --retries 3;then
              echo "âŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥" && sudo rm -f $SNAPSHOT_PATH && return 1
            fi
            
            # æ ¡éªŒè¿œç¨‹å¤‡ä»½æœ‰æ•ˆæ€§
            if rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/$SNAPSHOT_NAME --config /home/runner/.rclone.conf >/dev/null;then
              echo "âœ… è¿œç¨‹å¤‡ä»½æ ¡éªŒæˆåŠŸï¼Œæœ¬åœ°ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
              sudo rm -f $SNAPSHOT_PATH && return 0
            else
              echo "âŒ è¿œç¨‹å¤‡ä»½æ ¡éªŒå¤±è´¥ï¼Œæœ¬åœ°ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
              sudo rm -f $SNAPSHOT_PATH && return 1
            fi
          }
          
          # è§¦å‘è‡ªåŠ¨ç»­è·‘äº‹ä»¶
          trigger_renew(){
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ];then
              echo "âš ï¸ USER_PAT/REPOæœªé…ç½®ï¼Œè·³è¿‡è‡ªåŠ¨ç»­è·‘è§¦å‘" && return 0
            fi
            echo "ğŸ“Œ å¼€å§‹è§¦å‘è‡ªåŠ¨ç»­è·‘äº‹ä»¶"
            if curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}';then
              echo "âœ… è‡ªåŠ¨ç»­è·‘è§¦å‘æˆåŠŸï¼Œåç»­å°†å¾ªç¯æ‰§è¡Œå¤‡ä»½ä»»åŠ¡"
            else
              echo "âš ï¸ è‡ªåŠ¨ç»­è·‘è§¦å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥PATæƒé™å’ŒREPOåœ°å€"
            fi
          }
          
          # å¤‡ä»½ä¸»æµç¨‹ï¼Œå¤±è´¥è‡ªåŠ¨é‡è¯•1æ¬¡
          echo "â° å¯åŠ¨å¤‡ä»½æµç¨‹ï¼Œå¤±è´¥å°†10åˆ†é’Ÿåé‡è¯•1æ¬¡"
          if full_backup;then
            echo "âœ… é¦–æ¬¡å¤‡ä»½ä¸Šä¼ æˆåŠŸ"
            cleanup_old_backups
            trigger_renew
          else
            echo "âŒ é¦–æ¬¡å¤‡ä»½å¤±è´¥ï¼Œ10åˆ†é’Ÿåé‡è¯•"
            sleep 600
            if full_backup;then
              echo "âœ… é‡è¯•å¤‡ä»½æˆåŠŸ"
              cleanup_old_backups
              trigger_renew
            else
              echo "âŒ ä¸¤æ¬¡å¤‡ä»½å‡å¤±è´¥ï¼Œç»ˆæ­¢å¤‡ä»½æµç¨‹"
            fi
          fi
          echo -e "\nâœ… å¤‡ä»½+æ¸…æ—§ï¼ˆç•™2ä»½ï¼‰+ç»­è·‘ å…¨æµç¨‹å®Œæˆ"

      - name: 11-å¼ºåˆ¶å…³é—­å·¥ä½œæµ+æ”¶å°¾æ¸…ç†ï¼ˆå½»åº•æ— æ®‹ç•™ï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç†+å¼ºåˆ¶å…³é—­å·¥ä½œæµï¼ˆæœ€ç»ˆæ­¥éª¤ï¼‰====="
          # æ·±åº¦æ¸…ç†æ®‹ç•™æ–‡ä»¶ï¼Œä¸ç•™ç—•è¿¹
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* /var/tmp/* 2>/dev/null || true
          
          # æœ€ç»ˆæœåŠ¡çŠ¶æ€æ ¡éªŒ
          echo -e "\nğŸ“Œ æœ€ç»ˆæœåŠ¡è¿è¡ŒçŠ¶æ€æ ¡éªŒ"
          sudo systemctl is-active --quiet docker && echo "âœ… DockeræœåŠ¡ï¼šè¿è¡Œæ­£å¸¸" || echo "âš ï¸ DockeræœåŠ¡ï¼šæœªè¿è¡Œ"
          sudo systemctl is-active --quiet casaos && echo "âœ… CasaOSæœåŠ¡ï¼šè¿è¡Œæ­£å¸¸" || echo "âš ï¸ CasaOSæœåŠ¡ï¼šæœªè¿è¡Œ"
          sudo systemctl is-active --quiet tailscaled && echo "âœ… TailscaleæœåŠ¡ï¼šè¿è¡Œæ­£å¸¸" || echo "âš ï¸ TailscaleæœåŠ¡ï¼šæœªè¿è¡Œ/æœªé…ç½®"
          
          # å¼ºåˆ¶å…³é—­å½“å‰å·¥ä½œæµï¼Œæ‰§è¡Œå³ç»ˆæ­¢
          echo -e "\nğŸ”š å¼€å§‹å¼ºåˆ¶å…³é—­å½“å‰å·¥ä½œæµ"
          if [ -n "${{ github.run_id }}" ] && [ -n "${{ secrets.USER_PAT }}" ] && [ -n "${{ secrets.REPO }}" ]; then
            CLOSE_RESP=$(curl -fsSL -w "%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.USER_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ secrets.REPO }}/actions/runs/${{ github.run_id }}/cancel)
            if echo "$CLOSE_RESP" | grep -q "202"; then
              echo "âœ… å½“å‰å·¥ä½œæµå·²å¼ºåˆ¶å…³é—­"
            else
              echo "âœ… å·¥ä½œæµå…³é—­è¯·æ±‚å·²å‘é€ï¼Œå°†æ­£å¸¸å®Œç»“"
            fi
          else
            echo "âœ… å·¥ä½œæµå°†æ­£å¸¸å®Œç»“"
          fi
          
          echo -e "\nğŸ‰ å…¨æµç¨‹åœ†æ»¡ç»“æŸï¼"
          echo "âœ… æ ¸å¿ƒæˆæœï¼šCasaOSçº¯å‡€éƒ¨ç½²+è¿è¡Œ300åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½+ä»…ä¿ç•™2ä»½å¤‡ä»½"
          echo "âœ… å®‰å…¨ä¿éšœï¼šæ¢å¤ä¸åˆ å†å²å¿«ç…§ï¼Œå¤‡ä»½æ¸…ç†ä»…ä¿ç•™æœ€æ–°2ä»½ï¼ŒåŒé‡å…œåº•"
          echo "âœ… è®¿é—®æŒ‡å¼•ï¼šæœåŠ¡å™¨å…¬ç½‘IP:80 æˆ– Tailscaleå†…ç½‘IPï¼Œç›´æ¥ä½¿ç”¨"
          exit 0
