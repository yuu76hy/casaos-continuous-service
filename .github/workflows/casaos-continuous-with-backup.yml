name: CasaOS-Server-å…¨é‡å¿«ç…§-å®Œæ•´å¤‡ä»½æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos_full_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç§»é™¤/etc/profileï¼ˆæ–‡ä»¶ï¼‰ï¼Œæ›¿æ¢ä¸º/etc/profile.dï¼ˆç›®å½•ï¼‰ï¼›ç§»é™¤å…¶ä»–éç›®å½•æ–‡ä»¶è·¯å¾„
      CORE_DIRS: "/var/lib/docker /etc/docker /etc/casaos /var/lib/casaos /DATA /etc/systemd/system /usr/bin/casaos /usr/lib/systemd/system /usr/local/bin /usr/local/lib /usr/lib /usr/share /etc/apt /etc/profile.d /etc/environment /var/lib/apt /var/cache/apt /usr/sbin /bin /sbin /etc/ld.so.conf.d /lib/x86_64-linux-gnu /lib64"
      # æç®€æ’é™¤è§„åˆ™ã€åªåˆ æ— ç”¨åƒåœ¾ã€‘ï¼šä¸ç¢°ä»»ä½•ä¾èµ–/é…ç½®/æ•°æ®ï¼Œæœç»è¯¯åˆ æ ¸å¿ƒæ–‡ä»¶
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/logs
        --exclude=/var/lib/docker/buildx
        --exclude=/var/lib/docker/plugins
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=*.swp
        --exclude=/tmp/*
        --exclude=/var/tmp/*
        --exclude=/var/log/*
        --exclude=/var/cache/apt/archives/*
        --exclude=/DATA/tmp
        --exclude=/DATA/logs
        --exclude=/DATA/cache
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
        --exclude=/usr/share/doc
        --exclude=/usr/share/man
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true
      # å…¨é‡å¤‡ä»½å…³é”®æ ‡è¯†ï¼šç¡®ä¿æ¢å¤å®Œæ•´æ€§
      BACKUP_MARK: "CASAOS_FULL_BACKUP_FULLY"

    steps:
      - name: å…¨é‡ç¯å¢ƒåˆå§‹åŒ–ï¼ˆå«ä¾èµ–é¢„å®‰è£…ï¼‰
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl rsync ca-certificates apt-transport-https
          sudo locale-gen zh_CN.UTF-8 en_US.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          # æƒé™å…œåº•ï¼šé¿å…å¤‡ä»½æ¢å¤æƒé™ä¸è¶³
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          # ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ä¼˜åŒ–ç›®å½•åˆ›å»ºé€»è¾‘ï¼šåªåˆ›å»ºç›®å½•ï¼Œè·³è¿‡æ–‡ä»¶
          for path in $CORE_DIRS; do
            # å¦‚æœæ˜¯æ–‡ä»¶ï¼Œç›´æ¥è·³è¿‡ï¼›å¦‚æœæ˜¯ç›®å½•ä¸”ä¸å­˜åœ¨ï¼Œæ‰åˆ›å»º
            if [ -f "$path" ]; then
              echo "âš ï¸ $path æ˜¯æ–‡ä»¶ï¼Œè·³è¿‡åˆ›å»º"
              continue
            fi
            if [ ! -d "$path" ]; then
              sudo mkdir -p "$path"
              echo "âœ… åˆ›å»ºç›®å½•ï¼š$path"
            else
              echo "âœ… ç›®å½•å·²å­˜åœ¨ï¼š$path"
            fi
          done
          echo "âœ…å…¨é‡ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼Œå…³é”®ç›®å½•å·²é¢„åˆ›å»º"

      - name: åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼ˆæƒé™å…œåº•ï¼‰
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… rootsç”¨æˆ·åˆ›å»ºå®Œæˆï¼Œå¯†ç ï¼š$RANDOM_PASS"
            fi
            sudo usermod -aG sudo,root,docker roots
          fi

      - name: é…ç½®Rclone WebDAVï¼ˆå…¨é‡ä¼ è¾“ä¼˜åŒ–ï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒWebDAVå‡­è¯ç¼ºå¤±"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          # å¼ºæ ¡éªŒWebDAVè¿é€šæ€§
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒWebDAVè¿æ¥å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          # ç²¾å‡†ç­›é€‰å…¨é‡å¿«ç…§ï¼Œæ’é™¤æ®‹ç¼ºæ–‡ä»¶
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "casaos-full-snapshot-.*.tar.gz" | awk '{if($1>10485760)print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ…æ‰¾åˆ°å®Œæ•´è¿œç¨‹å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸æ— å®Œæ•´è¿œç¨‹å¿«ç…§ï¼Œå°†å…¨æ–°å®‰è£…CasaOS"
          fi
          echo "âœ…WebDAVé…ç½®å®Œæˆï¼Œè¿é€šæ€§æ ¡éªŒé€šè¿‡"

      - name: å…¨é‡å¿«ç…§æ¢å¤ï¼ˆå¼ºä¸€è‡´æ€§+å®Œæ•´æ€§æ ¡éªŒï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹å…¨é‡æ¢å¤å¿«ç…§ï¼š$LATEST_SNAPSHOT ====="
          
          # å¼ºåˆ¶åœæ­¢æ‰€æœ‰å…³è”æœåŠ¡ï¼Œæœç»æ–‡ä»¶å ç”¨
          sudo systemctl stop docker.service docker.socket casaos.service 2>/dev/null || true
          sudo systemctl mask docker.socket casaos.service
          sudo pkill -9 docker casaos 2>/dev/null || true
          sudo fuser -k /var/lib/docker /var/lib/casaos /DATA 2>/dev/null || true
          sync && sleep 5
          echo "âœ…æ‰€æœ‰å…³è”æœåŠ¡å·²å¼ºåˆ¶åœæ­¢ï¼Œæ— æ–‡ä»¶å ç”¨"
          
          # åŒé‡æ ¡éªŒå¿«ç…§æœ‰æ•ˆæ€§ï¼ˆå¤§å°+æ–‡ä»¶å¤´ï¼‰
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 10240 >/dev/null 2>&1; then
            echo "âŒå¿«ç…§æ–‡ä»¶æŸåæˆ–æ®‹ç¼ºï¼Œæ¢å¤ç»ˆæ­¢"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          echo "âœ…å¿«ç…§æœ‰æ•ˆæ€§æ ¡éªŒé€šè¿‡"
          
          # å…¨é‡æ¢å¤ï¼šä¿ç•™æ‰€æœ‰æƒé™/å±æ€§/é“¾æ¥ï¼Œå¼ºåˆ¶è¦†ç›–ï¼Œä¸å¿½ç•¥å…³é”®é”™è¯¯
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / \
            --overwrite --preserve-permissions --preserve-owner --preserve-links \
            --absolute-names --warning=no-file-changed --no-ignore-failed-read \
            $EXCLUDE_RULES
          if [ $? -ne 0 ]; then
            echo "âŒå…¨é‡æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          
          # æ¢å¤åå…³é”®æ ‡è¯†æ ¡éªŒï¼Œç¡®è®¤å¤‡ä»½å®Œæ•´æ€§
          if [ ! -f "/var/lib/casaos/${BACKUP_MARK}.flag" ]; then
            echo "âŒå¿«ç…§ä¸å®Œæ•´ï¼Œç¼ºå¤±å…¨é‡å¤‡ä»½æ ‡è¯†"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          
          # æƒé™ä¿®å¤å…œåº•ï¼Œé¿å…æ¢å¤åæƒé™é”™è¯¯
          sudo chown -R root:root /etc /usr /bin /sbin /lib /lib64
          sudo chown -R root:docker /var/lib/docker /etc/docker
          sudo chown -R casaos:casaos /var/lib/casaos /etc/casaos
          sudo chmod -R 755 /usr/bin /usr/sbin /bin /sbin
          sudo chmod -R 775 /DATA
          sync && sleep 3
          
          echo "âœ…å…¨é‡å¿«ç…§æ¢å¤å®Œæˆï¼Œæƒé™å·²ä¿®å¤å…œåº•"
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
          # åˆ é™¤å·²æ¢å¤å¿«ç…§ï¼Œé¿å…é‡å¤æ¢å¤
          rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_full_meta.txt --config /home/runner/.rclone.conf
          echo "âœ…å·²åˆ é™¤å·²æ¢å¤å¿«ç…§æ–‡ä»¶"
          sudo systemctl unmask docker.socket casaos.service

      - name: å…¨æ–°å®‰è£…CasaOSï¼ˆæ— å¿«ç…§å…œåº•ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          # é¢„è£…æ‰€æœ‰ä¾èµ–ï¼Œé¿å…å®‰è£…CasaOSæ—¶ç¼ºå¤±
          sudo apt install -y cgroupfs-mount fuse3 dbus avahi-daemon libssl-dev libcurl4-openssl-dev
          curl -fsSL https://get.casaos.io | sudo bash -s -- --force
          if [ $? -ne 0 ]; then
            cat /var/log/casaos-install.log
            exit 1
          fi
          # å®‰è£…åè¡¥å…¨ä¾èµ–ï¼Œç¡®ä¿ç¯å¢ƒå®Œæ•´
          sudo apt install -y --fix-missing
          echo "âœ…CasaOSå…¨æ–°å®‰è£…å®Œæˆï¼Œä¾èµ–è¡¥å…¨å®Œæ¯•"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"

      - name: å…¨æ–°å®‰è£…-æœåŠ¡å¼ºåˆ¶å¯åŠ¨ï¼ˆå…œåº•æ— æŠ¥é”™ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          sudo systemctl unmask docker.socket casaos.service
          sudo systemctl daemon-reload
          # Dockerå¼ºåˆ¶å¯åŠ¨+é‡è¯•å…œåº•
          for i in $(seq 1 5); do
            sudo systemctl enable --now docker.service docker.socket
            sleep 8
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet docker.socket; then
              echo "âœ…DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            sudo systemctl reset-failed docker.service docker.socket
            echo "âš ï¸Dockerå¯åŠ¨ç¬¬$iæ¬¡é‡è¯•"
            if [ $i -eq 5 ]; then
              echo "âŒDockerå¯åŠ¨å¤±è´¥ï¼Œå¼ºåˆ¶ä¿®å¤åé‡è¯•"
              sudo apt reinstall -y docker-ce docker-ce-cli containerd.io
              sudo systemctl enable --now docker.service docker.socket
            fi
          done
          # CasaOSå¼ºåˆ¶å¯åŠ¨+ä¾èµ–æ ¡éªŒ
          sudo systemctl enable --now casaos.service
          sleep 5
          if sudo systemctl is-active --quiet casaos.service; then
            echo "âœ…CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸ"
          else
            sudo journalctl -u casaos.service -n 50
            sudo systemctl reset-failed casaos.service
            sudo systemctl start casaos.service
          fi
          # åˆ›å»ºå…¨é‡å¤‡ä»½æ ‡è¯†
          sudo touch /var/lib/casaos/${BACKUP_MARK}.flag
          echo "âœ…å…¨æ–°å®‰è£…æœåŠ¡å¯åŠ¨å®Œæˆï¼Œå…¨é‡æ ‡è¯†å·²åˆ›å»º"

      - name: å¿«ç…§æ¢å¤-æœåŠ¡å¼ºåˆ¶å¯åŠ¨ï¼ˆ1:1è¿˜åŸå³å¯ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          sudo systemctl unmask docker.socket casaos.service
          # æ ¸å¿ƒï¼šæ¢å¤åé‡æ–°åŠ è½½ç³»ç»Ÿé…ç½®ï¼Œé¿å…ä¾èµ–ç¼ºå¤±
          sudo ldconfig
          sudo systemctl daemon-reload
          sudo update-ca-certificates
          sudo apt install -y --fix-missing 2>/dev/null || true
          echo "âœ…ç³»ç»Ÿé…ç½®é‡è½½å®Œæˆï¼Œä¾èµ–è‡ªåŠ¨è¡¥å…¨"
          
          # Dockerå¼ºåˆ¶å¯åŠ¨ï¼Œç¡®ä¿å®¹å™¨ç½‘ç»œ/å­˜å‚¨1:1è¿˜åŸ
          sudo systemctl enable --now docker.service docker.socket
          sleep 10
          if ! sudo systemctl is-active --quiet docker; then
            echo "âš ï¸Dockerå¯åŠ¨å¼‚å¸¸ï¼Œå¼ºåˆ¶ä¿®å¤"
            sudo systemctl reset-failed docker.service
            sudo /usr/bin/dockerd --debug &
            sleep 8
            sudo pkill dockerd
            sudo systemctl start docker.service
          fi
          echo "âœ…DockeræœåŠ¡1:1è¿˜åŸå¯åŠ¨æˆåŠŸ"
          
          # CasaOSå¼ºåˆ¶å¯åŠ¨ï¼Œæ ¡éªŒæ ¸å¿ƒè¿›ç¨‹
          sudo systemctl enable --now casaos.service
          sleep 8
          if sudo systemctl is-active --quiet casaos.service; then
            echo "âœ…CasaOSæœåŠ¡1:1è¿˜åŸå¯åŠ¨æˆåŠŸ"
          else
            sudo journalctl -u casaos.service -n 80
            sudo systemctl reset-failed casaos.service
            sudo systemctl start casaos.service
          fi
          
          # æ ¡éªŒæ ¸å¿ƒæœåŠ¡å¯ç”¨æ€§ï¼Œç¡®ä¿æ— æŠ¥é”™
          sleep 5
          if sudo docker ps | grep -q casaos; then
            echo "âœ…CasaOSå®¹å™¨è¿è¡Œæ­£å¸¸ï¼Œè¿˜åŸæ— å¼‚å¸¸"
          else
            sudo docker start $(sudo docker ps -a | grep casaos | awk '{print $1}')
          fi
          echo "âœ…å…¨é‡å¿«ç…§æ¢å¤åï¼Œæ‰€æœ‰æœåŠ¡å¯åŠ¨æ­£å¸¸ï¼Œå¯ç›´æ¥ä½¿ç”¨"

      - name: Tailscaleéƒ¨ç½²ï¼ˆè¿ç§»åç›´æ¥è¿é€šï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸æ— Tailscaleå¯†é’¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          TAILSCALE_PATH=$(which tailscale)
          [ -z "$TAILSCALE_PATH" ] && echo "âŒTailscaleå®‰è£…å¤±è´¥" && exit 0
          # å¼ºåˆ¶å¯åŠ¨Tailscaleï¼Œç¡®ä¿è¿ç§»åç›´æ¥è¿é€š
          sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --accept-dns --hostname="casaos-full-snap-${{ github.run_id }}"
          echo "âœ…Tailscaleéƒ¨ç½²å®Œæˆï¼ŒIPï¼š$(sudo "$TAILSCALE_PATH" ip -4)"

      - name: å…¨é‡å¿«ç…§å¤‡ä»½ï¼ˆå®Œæ•´æ— é—æ¼+ä¸€è‡´æ€§é”ï¼‰
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # ç»­è·‘è§¦å‘å‡½æ•°ï¼ˆç¡®ä¿å¤‡ä»½ä¸ä¸­æ–­ï¼‰
          trigger_renew() {
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && echo "âŒç»­è·‘å‡­è¯ç¼ºå¤±" && return 1
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âŒç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥" && return 1
            fi
            echo "âœ…ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true && return 0
          }
          
          # å…¨é‡å¤‡ä»½æ ¸å¿ƒå‡½æ•°ï¼ˆ1:1å®Œæ•´å¤‡ä»½ï¼Œæ— ä»»ä½•é—æ¼ï¼‰
          full_backup_snapshot() {
            [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1
            
            # å¤‡ä»½å‰å¼ºåˆ¶æ ¡éªŒæ ¸å¿ƒæœåŠ¡å®Œæ•´æ€§
            if [ ! -f "/usr/bin/casaos" ] || [ ! -f "/var/lib/casaos/${BACKUP_MARK}.flag" ]; then
              echo "âŒCasaOSç¯å¢ƒä¸å®Œæ•´ï¼Œæ‹’ç»å¤‡ä»½" && exit 1
            fi
            echo "âœ…å¤‡ä»½å‰ç¯å¢ƒå®Œæ•´æ€§æ ¡éªŒé€šè¿‡"
            
            # å¿«ç…§å‘½åï¼šåŒºåˆ†å…¨é‡å¤‡ä»½ï¼Œä¾¿äºç­›é€‰
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„å¼€å§‹åˆ›å»ºå…¨é‡å¿«ç…§ï¼š${SNAPSHOT_NAME}"
            
            # ä¸€è‡´æ€§é”ï¼šåœæ­¢æœåŠ¡+å†»ç»“æ–‡ä»¶ç³»ç»Ÿï¼Œæœç»å¤‡ä»½è„æ•°æ®
            sudo systemctl stop docker.service docker.socket casaos.service
            sudo systemctl mask docker.socket casaos.service
            sudo pkill -9 docker casaos || true
            sync && sleep 3
            echo "âœ…æœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®ä¸€è‡´æ€§é”å®šå®Œæˆ"
            
            # å…¨é‡æ‰“åŒ…ï¼šåŒ…å«æ‰€æœ‰æƒé™/é“¾æ¥/å±æ€§ï¼Œä¸å‹ç¼©ç³»ç»Ÿæ–‡ä»¶é¿å…æŸåï¼Œåªç­›æ— ç”¨åƒåœ¾
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names --preserve-permissions --preserve-owner --preserve-links \
              --preserve-time --ignore-failed-read --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS
            # å¤‡ä»½åç«‹å³åˆ›å»ºæ ‡è¯†æ–‡ä»¶ï¼Œç”¨äºæ¢å¤æ ¡éªŒ
            sudo touch /var/lib/casaos/${BACKUP_MARK}.flag
            
            # è§£é”æœåŠ¡ï¼Œå¿«é€Ÿæ¢å¤è¿è¡Œ
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl start docker.service docker.socket casaos.service
            echo "âœ…æœåŠ¡å·²é‡å¯ï¼Œä¸€è‡´æ€§é”å·²è§£é™¤"
            
            # ä¸‰é‡æ ¡éªŒå¿«ç…§å®Œæ•´æ€§ï¼ˆå­˜åœ¨æ€§+å¤§å°+è§£å‹æµ‹è¯•ï¼‰
            [ ! -f "${TMP_SNAPSHOT}" ] && echo "âŒå¿«ç…§æœªç”Ÿæˆ" && return 1
            [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 104857600 ] && echo "âŒå¿«ç…§å°äº100Mï¼Œåˆ¤å®šæ®‹ç¼º" && return 1
            tar -tzf "${TMP_SNAPSHOT}" | grep -q "/var/lib/casaos" && echo "âœ…å¿«ç…§è§£å‹æµ‹è¯•é€šè¿‡" || { echo "âŒå¿«ç…§è§£å‹å¤±è´¥"; return 1; }
            echo "âœ…å…¨é‡å¿«ç…§åˆ›å»ºå®Œæˆï¼Œå¤§å°ï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"
            
            # å…¨é‡ä¸Šä¼ ï¼šå¤šçº¿ç¨‹+æ–­ç‚¹ç»­ä¼ ï¼Œç¡®ä¿ä¸ä¸¢åŒ…
            sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 8 --checkers 16 --fast-list --retries 5 \
              --ignore-existing --progress --log-level INFO --log-file /tmp/rclone_full_upload.log
            [ $? -ne 0 ] && { echo "âŒä¸Šä¼ å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š/tmp/rclone_full_upload.log"; cat /tmp/rclone_full_upload.log; return 1; }
            
            # ä¸Šä¼ å…¨é‡å…ƒæ•°æ®ï¼Œå«æ ¡éªŒä¿¡æ¯
            META_FILE="/tmp/snapshot_full_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            echo "backup_size=$(du -sb ${TMP_SNAPSHOT} | awk '{print $1}')" >> "${META_FILE}"
            echo "backup_mark=${BACKUP_MARK}" >> "${META_FILE}"
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_full_meta.txt" --config /home/runner/.rclone.conf
            
            # æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼Œé‡Šæ”¾ç©ºé—´
            rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
            echo "âœ…å…¨é‡å¿«ç…§å·²ä¸Šä¼ è‡³WebDAVï¼š${REMOTE_PATH}"
            return 0
          }
          
          # ä¸»é€»è¾‘ï¼šç«‹å³å¤‡ä»½+è§¦å‘ç»­è·‘ï¼Œç¡®ä¿å¤‡ä»½è¿ç»­æ€§
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Šå·¥ä½œæµè¿è¡Œæ—¶é•¿ï¼š$run_mins åˆ†é’Ÿ"
            
            # ç«‹å³æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼Œæ— éœ€ç­‰å¾…
            if [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â°ç«‹å³æ‰§è¡Œå…¨é‡å¤‡ä»½"
              if full_backup_snapshot; then
                trigger_renew
              else
                echo "âŒå…¨é‡å¤‡ä»½å¤±è´¥ï¼Œ1åˆ†é’Ÿåé‡è¯•"
                sleep 60
                full_backup_snapshot
              fi
            fi
            
            # è¾¾åˆ°æœ€å¤§æ—¶é•¿è‡ªåŠ¨é€€å‡ºï¼Œé¿å…èµ„æºå ç”¨
            [ $run_mins -ge $MAX_RUN_MINUTES ] && { echo "â¹ï¸è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é•¿ï¼Œæ­£å¸¸é€€å‡º"; exit 0; }
            sleep 60
          done

      - name: ç»ˆææ¸…ç†ï¼ˆå…œåº•æ— æ®‹ç•™ï¼‰
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket casaos.service 2>/dev/null || true
          sudo rm -rf /tmp/casaos-* /tmp/rclone_*.log /home/runner/.rclone.conf /etc/sudoers.d/runner
          sudo apt autoremove -y && sudo apt clean
          echo "âœ…æ¸…ç†å®Œæˆï¼Œæ— æ®‹ç•™æ–‡ä»¶"
