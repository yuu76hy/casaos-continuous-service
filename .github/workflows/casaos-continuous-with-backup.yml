#!/bin/bash
set -euo pipefail
trap 'echo -e "\nâŒ æµç¨‹åœ¨ç¬¬ ${STEP} æ­¥å¼‚å¸¸ç»ˆæ­¢ï¼" >&2' ERR

# ==================== ã€å…¨å±€é…ç½®ã€‘ä½ åªéœ€è¦æ”¹è¿™é‡Œ ====================
export STEP="0"

# Tailscale åŒ¹é…è§„åˆ™ï¼šcasaos + ä¸¤ä½æ•°å­—
DEVICE_PATTERN="^casaos[0-9]{2}$"

# å¹¶å‘ ping é…ç½®
PING_TIMEOUT=1
MAX_PARALLEL=10

# è¿œç¨‹è¦ä¸‹è½½çš„å¤‡ä»½æ–‡ä»¶
SSH_USER="root"
REMOTE_BACKUP_FILE="/var/lib/casaos/backup/latest.tar.gz"

# æœ¬åœ°å­˜æ”¾ç›®å½•
LOCAL_BASE_DIR="./casaos_recovery"
LOCAL_BACKUP_DIR="${LOCAL_BASE_DIR}/files"
LOCAL_TMP_DIR="${LOCAL_BASE_DIR}/tmp"

# æœ¬æœºæ¢å¤ç›®æ ‡ç›®å½•ï¼ˆæ ¹æ®ä½ çš„å®é™…æ¢å¤è·¯å¾„æ”¹ï¼‰
LOCAL_RESTORE_DIR="/var/lib/casaos"

# æœåŠ¡åï¼ˆCasaOS ä¸»æœåŠ¡ï¼ŒæŒ‰å®é™…ä¿®æ”¹ï¼‰
CASAOS_SERVICE="casaos"

# =====================================================================

# ------------------------------
# æ­¥éª¤1ï¼šåˆå§‹åŒ–ç¯å¢ƒä¸æ—¥å¿—
# ------------------------------
step1_init_env() {
    STEP="1"
    echo -e "\n===== ã€æ­¥éª¤1/12ã€‘åˆå§‹åŒ–ç¯å¢ƒ & æ—¥å¿— ====="
    mkdir -p "${LOCAL_BACKUP_DIR}" "${LOCAL_TMP_DIR}"
    echo "å·¥ä½œç›®å½•ï¼š${LOCAL_BASE_DIR}"
    echo "å¤‡ä»½ç›®å½•ï¼š${LOCAL_BACKUP_DIR}"
    echo "ä¸´æ—¶ç›®å½•ï¼š${LOCAL_TMP_DIR}"
}

# ------------------------------
# æ­¥éª¤2ï¼šæ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…
# ------------------------------
step2_check_deps() {
    STEP="2"
    echo -e "\n===== ã€æ­¥éª¤2/12ã€‘æ£€æŸ¥å¿…å¤‡å·¥å…· ====="
    local deps=("tailscale" "jq" "ping" "scp" "curl" "tar")
    for dep in "${deps[@]}"; do
        if ! command -v "${dep}" &> /dev/null; then
            echo "âŒ ç¼ºå°‘å·¥å…·ï¼š${dep}ï¼Œè¯·å…ˆå®‰è£…" >&2
            exit 1
        fi
    done
    echo "âœ… æ‰€æœ‰ä¾èµ–æ­£å¸¸"
}

# ------------------------------
# æ­¥éª¤3ï¼šæ£€æŸ¥æœ¬æœºå·²æ¥å…¥ Tailscale
# ------------------------------
step3_check_tailscale_online() {
    STEP="3"
    echo -e "\n===== ã€æ­¥éª¤3/12ã€‘æ£€æŸ¥ Tailscale åœ¨çº¿çŠ¶æ€ ====="
    if ! tailscale status &> /dev/null; then
        echo "âŒ Tailscale æœªç™»å½•æˆ–æœªå¯åŠ¨" >&2
        exit 1
    fi
    echo "âœ… Tailscale å·²å°±ç»ª"
}

# ------------------------------
# æ­¥éª¤4ï¼šåˆ›å»ºç›®å½•ç»“æ„
# ------------------------------
step4_make_dirs() {
    STEP="4"
    echo -e "\n===== ã€æ­¥éª¤4/12ã€‘åˆ›å»ºç›®å½•ç»“æ„ ====="
    # æ­¤æ­¥éª¤ä¸ step1_init_env åŠŸèƒ½é‡å¤ï¼Œå¯ä¿ç•™æˆ–åˆ é™¤
    mkdir -p "${LOCAL_BACKUP_DIR}" "${LOCAL_TMP_DIR}"
    echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
}

# ------------------------------
# æ­¥éª¤5ï¼šæ¸…ç†ä¸Šä¸€æ¬¡æ®‹ç•™æ–‡ä»¶
# ------------------------------
step5_clean_old_tmp() {
    STEP="5"
    echo -e "\n===== ã€æ­¥éª¤5/12ã€‘æ¸…ç†æ—§ä¸´æ—¶/æ®‹ç•™æ–‡ä»¶ ====="
    rm -rf "${LOCAL_TMP_DIR}"/*
    find "${LOCAL_BACKUP_DIR}" -type f -mtime +7 -delete  # æ¸…ç†7å¤©å‰å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
    echo "âœ… æ¸…ç†å®Œæˆ"
}

# ------------------------------
# æ­¥éª¤6ï¼šã€æ ¸å¿ƒã€‘ä»Tailscaleå–casaosåˆ—è¡¨ â†’ å¹¶è¡Œping â†’ å–é€šçš„IP â†’ ä¸‹è½½å¤‡ä»½
# ------------------------------
step6_tailscale_ping_download() {
    STEP="6"
    echo -e "\n===== ã€æ­¥éª¤6/12ã€‘Tailscale è®¾å¤‡æ¢æµ‹ + Ping + ä¸‹è½½å¤‡ä»½ ====="

    # 6.1 ä» tailscale å–è®¾å¤‡å¹¶ç­›é€‰ casaosXX
    echo "ğŸ“¶ ä» Tailscale è·å–è®¾å¤‡åˆ—è¡¨..."
    ts_json=$(tailscale status --json)

    # å–å‡º HostName åŒ¹é… casaosXX + å–ç¬¬ä¸€ä¸ª Tailscale IP
    # ä¿®å¤ï¼šç§»é™¤äº†æ— æ•ˆçš„ --expr é€‰é¡¹
    devices=$(echo "${ts_json}" | jq -r "
        .Peer | to_entries[]
        | select(.value.HostName | test(\"${DEVICE_PATTERN}\"))
        | {name: .value.HostName, ip: .value.TailscaleIPs[0]}
        | @base64
    ")

    if [[ -z "${devices}" ]]; then
        echo "âŒ æœªæ‰¾åˆ°ä»»ä½• casaosXX è®¾å¤‡" >&2
        exit 1
    fi

    # 6.2 å¹¶è¡Œ pingï¼Œå–ç¬¬ä¸€ä¸ªé€šçš„IP
    echo "ğŸ” å¹¶è¡Œ ping æ¢æµ‹ä¸­..."
    success_ip_file="${LOCAL_TMP_DIR}/ping_success_ip.txt"
    > "${success_ip_file}"

    for dev_b64 in ${devices}; do
        dev=$(echo "${dev_b64}" | base64 -d)
        name=$(echo "${dev}" | jq -r '.name')
        ip=$(echo "${dev}" | jq -r '.ip')

        # åå° ping
        (
            if ping -c 1 -W "${PING_TIMEOUT}" "${ip}" >/dev/null 2>&1; then
                echo "${ip}" >> "${success_ip_file}"
                echo "âœ… ${name} (${ip}) å¯é€š"
            fi
        ) &

        # æ§åˆ¶å¹¶å‘
        while [[ $(jobs -r | wc -l) -ge ${MAX_PARALLEL} ]]; do
            sleep 0.1
        done
    done
    wait

    target_ip=$(head -n1 "${success_ip_file}")
    if [[ -z "${target_ip}" ]]; then
        echo "âŒ æ‰€æœ‰ casaosXX è®¾å¤‡å‡ ping ä¸é€š" >&2
        exit 1
    fi
    echo -e "\nğŸ¯ é€‰å®šå¯ç”¨IPï¼š${target_ip}"

    # 6.3 ä¸‹è½½å¤‡ä»½æ–‡ä»¶
    local_backup_path="${LOCAL_BACKUP_DIR}/casaos_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    echo "ğŸ“¥ ä» ${target_ip} ä¸‹è½½ï¼š${REMOTE_BACKUP_FILE}"
    scp -o ConnectTimeout=15 "${SSH_USER}@${target_ip}:${REMOTE_BACKUP_FILE}" "${local_backup_path}"

    if [[ ! -f "${local_backup_path}" ]]; then
        echo "âŒ å¤‡ä»½æ–‡ä»¶ä¸‹è½½å¤±è´¥" >&2
        exit 1
    fi

    # æŠŠæœ€ç»ˆæ–‡ä»¶è·¯å¾„å¯¼å‡ºç»™åç»­æ­¥éª¤ç”¨
    export RECOVERY_FILE="${local_backup_path}"
    echo "âœ… å¤‡ä»½ä¸‹è½½å®Œæˆï¼š${RECOVERY_FILE}"
}

# ------------------------------
# æ­¥éª¤7ï¼šæ ¡éªŒå¤‡ä»½æ–‡ä»¶ï¼ˆå­˜åœ¨ & å¤§å°ï¼‰
# ------------------------------
step7_verify_backup() {
    STEP="7"
    echo -e "\n===== ã€æ­¥éª¤7/12ã€‘æ ¡éªŒå¤‡ä»½æ–‡ä»¶ ====="
    if [[ ! -s "${RECOVERY_FILE}" ]]; then
        echo "âŒ å¤‡ä»½æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨" >&2
        exit 1
    fi
    size=$(du -h "${RECOVERY_FILE}" | cut -f1)
    echo "âœ… å¤‡ä»½æœ‰æ•ˆï¼Œå¤§å°ï¼š${size}"
}

# ------------------------------
# æ­¥éª¤8ï¼šåœæ­¢æœ¬æœº CasaOS æœåŠ¡
# ------------------------------
step8_stop_service() {
    STEP="8"
    echo -e "\n===== ã€æ­¥éª¤8/12ã€‘åœæ­¢ CasaOS æœåŠ¡ ====="
    if systemctl is-active --quiet "${CASAOS_SERVICE}"; then
        systemctl stop "${CASAOS_SERVICE}"
        echo "âœ… ${CASAOS_SERVICE} å·²åœæ­¢"
    else
        echo "â„¹ï¸ ${CASAOS_SERVICE} å·²å¤„äºåœæ­¢çŠ¶æ€"
    fi
}

# ------------------------------
# æ­¥éª¤9ï¼šæ¢å¤æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
# ------------------------------
step9_restore_files() {
    STEP="9"
    echo -e "\n===== ã€æ­¥éª¤9/12ã€‘è§£å‹æ¢å¤æ–‡ä»¶ ====="
    tar -zxf "${RECOVERY_FILE}" -C "${LOCAL_RESTORE_DIR}" --overwrite
    echo "âœ… æ–‡ä»¶æ¢å¤å®Œæˆï¼š${LOCAL_RESTORE_DIR}"
}

# ------------------------------
# æ­¥éª¤10ï¼šå¯åŠ¨ CasaOS æœåŠ¡
# ------------------------------
step10_start_service() {
    STEP="10"
    echo -e "\n===== ã€æ­¥éª¤10/12ã€‘å¯åŠ¨ CasaOS æœåŠ¡ ====="
    systemctl start "${CASAOS_SERVICE}"
    sleep 3
    echo "âœ… æœåŠ¡å·²å¯åŠ¨"
}

# ------------------------------
# æ­¥éª¤11ï¼šéªŒè¯æœåŠ¡ & ç½‘ç»œæ­£å¸¸
# ------------------------------
step11_verify_running() {
    STEP="11"
    echo -e "\n===== ã€æ­¥éª¤11/12ã€‘éªŒè¯æœåŠ¡è¿è¡ŒçŠ¶æ€ ====="
    if systemctl is-active --quiet "${CASAOS_SERVICE}"; then
        echo "âœ… ${CASAOS_SERVICE} è¿è¡Œæ­£å¸¸"
    else
        echo "âŒ ${CASAOS_SERVICE} å¯åŠ¨å¤±è´¥" >&2
        exit 1
    fi

    if tailscale ping "$(hostname)" -c 1 >/dev/null 2>&1; then
        echo "âœ… æœ¬æœº Tailscale æ­£å¸¸"
    fi
}

# ------------------------------
# æ­¥éª¤12ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶ & å®Œæˆæ€»ç»“
# ------------------------------
step12_final_clean() {
    STEP="12"
    echo -e "\n===== ã€æ­¥éª¤12/12ã€‘æœ€ç»ˆæ¸…ç† & æµç¨‹ç»“æŸ ====="
    rm -rf "${LOCAL_TMP_DIR}"
    echo -e "\nğŸ‰ ã€å…¨éƒ¨12æ­¥æ‰§è¡Œå®Œæˆã€‘"
    echo "å¤‡ä»½æ–‡ä»¶ï¼š${RECOVERY_FILE}"
    echo "æ¢å¤ç›®å½•ï¼š${LOCAL_RESTORE_DIR}"
}

# ==================== ä¸»æµç¨‹ï¼šæŒ‰ 1ï½12 é¡ºåºæ‰§è¡Œ ====================
main() {
    step1_init_env
    step2_check_deps
    step3_check_tailscale_online
    step4_make_dirs
    step5_clean_old_tmp
    step6_tailscale_ping_download
    step7_verify_backup
    step8_stop_service
    step9_restore_files
    step10_start_service
    step11_verify_running
    step12_final_clean

    echo -e "\nâœ… å…¨æµç¨‹æˆåŠŸç»“æŸï¼"
}

# æ‰§è¡Œä¸»æµç¨‹
main