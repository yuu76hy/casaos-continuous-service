name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆåŒæ¨¡å¼ï½œæŒ‚è½½+Rcloneè‡ªåŠ¨åˆ‡æ¢ï½œ5åˆ†é’Ÿå»¶æ—¶ç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    env:
      # ====================== å¯é…ç½®å‚æ•°ï¼ˆå·²ä¿®æ”¹ï¼š15åˆ†â†’5åˆ†ï¼‰ ======================
      LOCAL_MOUNT_POINT: "/op"
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs --exclude=*/socket
      KEEP_BACKUPS: 2
      SNAPSHOT_MD5_SUFFIX: ".md5"
      ZSTD_LEVEL: "-2"
      RCLONE_TRANSFERS: 4
      RCLONE_RETRIES: 5
      RCLONE_TIMEOUT: "1h30m"
      RCLONE_STATS: "30s"
      TARGET_RUN_MINUTES: 5  # æ ¸å¿ƒä¿®æ”¹ï¼šä»15æ”¹ä¸º5
      # ====================== å¯†é’¥é…ç½®ï¼ˆä»secretså–ï¼Œä¸æš´éœ²ï¼‰ ======================
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      # ==============================================================================
      # é˜¶æ®µ1ï¼šåˆå§‹åŒ–ä¸åŸºç¡€é…ç½®ï¼ˆæ­¥éª¤1-3ï¼‰
      # ==============================================================================
      - name: 1-ã€åˆå§‹åŒ–ã€‘ç³»ç»Ÿä¸Dockeréƒ¨ç½²
        run: |
          set -e
          echo "â„¹ï¸ [ä¿¡æ¯] è®°å½•å·¥ä½œæµå¼€å§‹æ—¶é—´"
          echo "WORKFLOW_START_TIMESTAMP=$(date +%s)" >> "$GITHUB_ENV"
          
          sudo DEBIAN_FRONTEND=noninteractive apt update -y -qq
          sudo DEBIAN_FRONTEND=noninteractive apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg zstd davfs2 -qq
          
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y -qq && sudo apt clean -y -qq
          
          INSTALL_RETRY=3
          while [ $INSTALL_RETRY -gt 0 ]; do
            curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun && break
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            sleep 30
          done
          [ $INSTALL_RETRY -eq 0 ] && { echo "âŒ [é”™è¯¯] Dockerå®‰è£…å¤±è´¥" && exit 1; }
          
          sudo systemctl enable --now docker containerd
          sudo usermod -aG docker runner
          echo "âœ… [æˆåŠŸ] ç³»ç»Ÿåˆå§‹åŒ–ä¸Dockeréƒ¨ç½²å®Œæˆ"

      - name: 2-ã€é…ç½®ã€‘ç®¡ç†å‘˜ä¸ç©ºé—´æ ¡éªŒ
        run: |
          set -e
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          
          # æå‰ä¼˜åŒ–ç©ºé—´è·å–é€»è¾‘ï¼Œé¿å…åç»­é—®é¢˜
          TMP_FREE=$(df -P /tmp | awk 'NR>1 {print $4}' | tail -1)
          if [ -z "$TMP_FREE" ] || ! [[ "$TMP_FREE" =~ ^[0-9]+$ ]]; then
            TMP_FREE=0
          fi
          [ "$TMP_FREE" -lt 5242880 ] && [ "$TMP_FREE" -ne 0 ] && { echo "âŒ [é”™è¯¯] /tmpç©ºé—´ä¸è¶³5G" && exit 1; }
          
          sudo rm -f /etc/sudoers.d/"$USER_NAME" 2>/dev/null || true
          echo "âœ… [æˆåŠŸ] ç®¡ç†å‘˜é…ç½®ä¸ç©ºé—´æ ¡éªŒé€šè¿‡"

      - name: 3-ã€å¤‡ä»½æ¨¡å¼ã€‘åŒæ¨¡å¼åˆå§‹åŒ–ï¼ˆRcloneé…ç½®ç¨³å®šåŠ å›ºï¼‰
        run: |
          set -e
          sudo mkdir -p "${LOCAL_MOUNT_POINT}" && sudo chmod 700 "${LOCAL_MOUNT_POINT}"
          
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "USE_MOUNT=false" >> "$GITHUB_ENV"
            echo "USE_RCLONE=false" >> "$GITHUB_ENV"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "âš ï¸ [è­¦å‘Š] WebDAVä¿¡æ¯ä¸ºç©ºï¼Œå¤‡ä»½æ¨¡å¼ä¸å¯ç”¨"
            exit 0
          fi
          
          # åˆå§‹åŒ–WebDAVæŒ‚è½½æ¨¡å¼
          MOUNT_OK=false
          echo "${WEBDAV_URL} ${WEBDAV_USER} ${WEBDAV_PASSWORD}" | sudo tee /etc/davfs2/secrets >/dev/null
          sudo chmod 600 /etc/davfs2/secrets
          if sudo mount -t davfs "${WEBDAV_URL}" "${LOCAL_MOUNT_POINT}" -o uid=runner,gid=runner,file_mode=600,dir_mode=700 --quiet; then
            sleep 2
            mount | grep -q "${LOCAL_MOUNT_POINT}" && {
              MOUNT_OK=true
              sudo mkdir -p "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}" && sudo chmod 700 "${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            }
          fi
          sudo rm -f /etc/davfs2/secrets 2>/dev/null || true
          
          # åˆå§‹åŒ–Rcloneæ¨¡å¼ï¼ˆä½¿ç”¨ç”¨æˆ·ç›®å½•é…ç½®æ–‡ä»¶ï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶ä¸¢å¤±ï¼‰
          RCLONE_OK=false
          RCLONE_CONFIG="$HOME/.rclone.conf"
          rm -f "$RCLONE_CONFIG" 2>/dev/null || true
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config "$RCLONE_CONFIG" --quiet >/dev/null
          sudo chmod 600 "$RCLONE_CONFIG"
          
          # Rcloneè¿æ¥é¢„æ ¡éªŒï¼Œæå‰å‘ç°é”™è¯¯
          if rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "$RCLONE_CONFIG" --quiet; then
            rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "$RCLONE_CONFIG" --quiet >/dev/null && RCLONE_OK=true
          fi
          
          echo "USE_MOUNT=$MOUNT_OK" >> "$GITHUB_ENV"
          echo "USE_RCLONE=$RCLONE_OK" >> "$GITHUB_ENV"
          echo "RCLONE_CONFIG=$RCLONE_CONFIG" >> "$GITHUB_ENV"
          [ "$MOUNT_OK" = true ] || [ "$RCLONE_OK" = true ] && echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV" || echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          echo "âœ… [æˆåŠŸ] åŒæ¨¡å¼åˆå§‹åŒ–å®Œæˆ"

      # ==============================================================================
      # é˜¶æ®µ2ï¼šéƒ¨ç½²ä¸æ¢å¤ï¼ˆæ­¥éª¤4-7ï¼‰
      # ==============================================================================
      - name: 4-ã€å¿«ç…§ã€‘å†å²å¿«ç…§æ£€æµ‹
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          LATEST_SNAPSHOT=""
          
          if [ "${USE_MOUNT:-false}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            LATEST=$(ls -t "${REMOTE_DIR}"/casaos-full-snapshot*.tar.zst 2>/dev/null | head -1 || true)
            [ -n "$LATEST" ] && LATEST_SNAPSHOT=$(basename "$LATEST")
          fi
          
          if [ -z "$LATEST_SNAPSHOT" ] && [ "${USE_RCLONE:-false}" = true ]; then
            LATEST=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "${RCLONE_CONFIG}" --quiet 2>/dev/null | grep casaos-full-snapshot | grep tar.zst | sort -r | head -1 | awk '{print $2}' || true)
            [ -n "$LATEST" ] && LATEST_SNAPSHOT="$LATEST"
          fi
          
          [ -n "$LATEST_SNAPSHOT" ] && {
            echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
            echo "LATEST_SNAPSHOT_MD5=${LATEST_SNAPSHOT}${SNAPSHOT_MD5_SUFFIX}" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
            echo "âœ… [æˆåŠŸ] æ‰¾åˆ°å†å²å¿«ç…§ï¼š$LATEST_SNAPSHOT"
          } || {
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            echo "âš ï¸ [è­¦å‘Š] æœªæ‰¾åˆ°å†å²å¿«ç…§ï¼Œå…¨æ–°éƒ¨ç½²"
          }

      - name: 5-ã€éƒ¨ç½²ã€‘CasaOSå®‰è£…ä¸æ—§ç‰ˆæ¸…ç†
        run: |
          set -e
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          
          CASAOS_RETRY=2
          while [ $CASAOS_RETRY -gt 0 ]; do
            curl -fsSL https://get.casaos.io | sudo bash && break
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sleep 30
          done
          [ $CASAOS_RETRY -eq 0 ] && { echo "âŒ [é”™è¯¯] CasaOSå®‰è£…å¤±è´¥" && exit 1; }
          
          sudo systemctl stop casaos
          echo "âœ… [æˆåŠŸ] CasaOSå®‰è£…å®Œæˆï¼Œå·²åœæ­¢æœåŠ¡"

      - name: 6-ã€æ¢å¤ã€‘å¿«ç…§æ¢å¤
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sync && sleep 3
          
          SNAP=${LATEST_SNAPSHOT}
          MD5=${LATEST_SNAPSHOT_MD5}
          RESTORE_OK=false
          
          if [ "${USE_MOUNT:-false}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            SNAP_PATH="${REMOTE_DIR}/${SNAP}"
            MD5_PATH="${REMOTE_DIR}/${MD5}"
            if [ -f "$SNAP_PATH" ] && [ -f "$MD5_PATH" ]; then
              cd /tmp && cp "$MD5_PATH" .
              if [ -f "/tmp/$(basename "$MD5_PATH")" ]; then
                md5sum -c "$(basename "$MD5_PATH")" < "$SNAP_PATH" 2>/dev/null && {
                  sudo mkdir -p $PERSONAL_DATA_DIRS
                  sudo tar -I zstd -xf "$SNAP_PATH" -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS 2>/dev/null
                  RESTORE_OK=true
                }
              fi
            fi
          fi
          
          if [ "$RESTORE_OK" = false ] && [ "${USE_RCLONE:-false}" = true ]; then
            rclone copy mywebdav:${WEBDAV_SNAPSHOT_DIR}/${MD5} /tmp --config "${RCLONE_CONFIG}" --quiet
            if [ -f "/tmp/${MD5}" ]; then
              rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAP} --config "${RCLONE_CONFIG}" 2>/dev/null | tee >(md5sum -c /tmp/${MD5} 2>/dev/null) >/dev/null && {
                sudo mkdir -p $PERSONAL_DATA_DIRS
                rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAP} --config "${RCLONE_CONFIG}" 2>/dev/null | sudo tar -I zstd -xf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS 2>/dev/null
                RESTORE_OK=true
              }
            fi
          fi
          
          [ "$RESTORE_OK" = false ] && { echo "âŒ [é”™è¯¯] å¿«ç…§æ¢å¤å¤±è´¥" && exit 1; }
          
          if [ ! -f "/var/lib/docker/version" ] || [ ! -d "/etc/casaos" ]; then
            echo "âŒ [é”™è¯¯] æ¢å¤åå…³é”®æ–‡ä»¶ç¼ºå¤±ï¼Œç³»ç»Ÿä¸ºã€Œç©ºå£³ã€ï¼Œå¼ºåˆ¶ç»ˆæ­¢"
            exit 1
          fi
          
          sudo rm -f /var/lib/docker/*.lock 2>/dev/null || true
          sudo rm -f /var/lib/containerd/io.containerd.metadata.v1.bolt/meta.db.lock 2>/dev/null || true
          sudo rm -f /run/docker/*.pid /run/containerd/*.pid 2>/dev/null || true
          
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "âœ… [æˆåŠŸ] å¿«ç…§æ¢å¤å®Œæˆ"

      - name: 7-ã€åˆå§‹åŒ–ã€‘æ— å¿«ç…§æ—¶åˆ›å»ºåŸºç¡€ç›®å½•
        if: ${{ env.WEBDAV_AVAILABLE != 'true' || env.HAS_SNAPSHOT != 'true' }}
        run: |
          set -e
          sudo mkdir -p /etc/casaos /var/lib/casaos /DATA
          echo "âœ… [æˆåŠŸ] åŸºç¡€ç›®å½•åˆ›å»ºå®Œæˆ"

      # ==============================================================================
      # é˜¶æ®µ3ï¼šæœåŠ¡å¯åŠ¨ä¸ç»„ç½‘ï¼ˆæ­¥éª¤8-9ï¼‰
      # ==============================================================================
      - name: 8-ã€æœåŠ¡ã€‘Dockerä¸CasaOSå¯åŠ¨æ ¡éªŒ
        run: |
          set -e
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          
          DOCKER_RETRY=3
          sudo systemctl restart docker containerd
          sleep 3
          while [ $DOCKER_RETRY -gt 0 ]; do
            docker ps >/dev/null 2>&1 && break
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl restart docker containerd && sleep 10
          done
          [ $DOCKER_RETRY -eq 0 ] && { echo "âŒ [é”™è¯¯] Dockerå¯åŠ¨å¤±è´¥" && exit 1; }
          
          CASAOS_RETRY=3
          sudo systemctl enable --now casaos
          sleep 5
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo lsof -i:80 | grep LISTEN >/dev/null 2>&1 && break
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl restart casaos && sleep 10
          done
          [ $CASAOS_RETRY -eq 0 ] && { echo "âŒ [é”™è¯¯] CasaOSå¯åŠ¨å¤±è´¥" && exit 1; }
          
          echo "âœ… [æˆåŠŸ] Dockerä¸CasaOSå¯åŠ¨å®Œæˆ"

      - name: 9-ã€ç»„ç½‘ã€‘Tailscaleå†…ç½‘ç»„ç½‘ï¼ˆå®¹é”™å¢å¼ºï¼‰
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set +e
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo DEBIAN_FRONTEND=noninteractive apt update -y -qq && sudo DEBIAN_FRONTEND=noninteractive apt install -y tailscale -qq
          
          sudo systemctl enable --now tailscaled
          sudo tailscale up \
            --authkey="${TAILSCALE_AUTH_KEY}" \
            --hostname="CasaOS-$(hostname | cut -c1-6 | tr -d '[:punct:]')" \
            --accept-routes \
            --accept-dns=false \
            --login-server=https://controlplane.tailscale.com
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || true)
          echo "TAILSCALE_IP=${TAILSCALE_IP:-ç»„ç½‘å¤±è´¥}" >> "$GITHUB_ENV"
          echo "â„¹ï¸ [ä¿¡æ¯] Tailscale ç»„ç½‘å°è¯•å®Œæˆï¼ŒIPï¼š${TAILSCALE_IP:-ç»„ç½‘å¤±è´¥}"
          set -e

      # ==============================================================================
      # é˜¶æ®µ4ï¼šæ¸…ç†ï¼ˆæ­¥éª¤10ï¼‰
      # ==============================================================================
      - name: 10-ã€æ¸…ç†ã€‘ç³»ç»Ÿåƒåœ¾+æ—§å¤‡ä»½ç»Ÿä¸€æ¸…ç†
        if: ${{ always() }}
        run: |
          set +e
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y --quiet 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean --quiet 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoclean -y --quiet 2>/dev/null || true
          sudo journalctl --vacuum-size=100M --vacuum-time=7d --quiet 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          sudo sync
          sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null || true
          
          if [ "${WEBDAV_AVAILABLE:-false}" = true ]; then
            if [ "${USE_MOUNT:-false}" = true ]; then
              REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
              sudo mkdir -p "$REMOTE_DIR" 2>/dev/null || true
              BACKUPS=$(ls -t "${REMOTE_DIR}"/casaos-full-snapshot*.tar.zst 2>/dev/null)
              COUNT=$(printf "%s" "$BACKUPS" | wc -l | tr -d ' ')
              COUNT=${COUNT:-0}
              
              if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
                echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
                  if [ -n "$f" ] && [ -f "$f" ]; then
                    rm -f "$f" "${f}${SNAPSHOT_MD5_SUFFIX}" 2>/dev/null || true
                    echo "ğŸ—‘ï¸ [æ¸…ç†] æŒ‚è½½æ¨¡å¼åˆ é™¤æ—§å¤‡ä»½ï¼š$(basename "$f")"
                  fi
                done
              fi
            fi
            
            if [ "${USE_RCLONE:-false}" = true ]; then
              BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config "${RCLONE_CONFIG}" --quiet 2>/dev/null | grep casaos-full-snapshot | grep tar.zst | sort -r | awk '{print $2}' 2>/dev/null)
              COUNT=$(printf "%s" "$BACKUPS" | wc -l | tr -d ' ')
              COUNT=${COUNT:-0}
              
              if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
                echo "$BACKUPS" | tail -n +$((KEEP_BACKUPS+1)) | while read f; do
                  if [ -n "$f" ]; then
                    rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$f --config "${RCLONE_CONFIG}" --quiet 2>/dev/null || true
                    rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${f}${SNAPSHOT_MD5_SUFFIX} --config "${RCLONE_CONFIG}" --quiet 2>/dev/null || true
                    echo "ğŸ—‘ï¸ [æ¸…ç†] Rcloneæ¨¡å¼åˆ é™¤æ—§å¤‡ä»½ï¼š$f"
                  fi
                done
              fi
            fi
          fi
          set -e
          echo "âœ… [æˆåŠŸ] ç³»ç»Ÿåƒåœ¾+æ—§å¤‡ä»½ç»Ÿä¸€æ¸…ç†å®Œæˆ"

      # ==============================================================================
      # é˜¶æ®µ5ï¼šå»¶æ—¶ä¸å¤‡ä»½ï¼ˆæ­¥éª¤11-12ï¼‰
      # ==============================================================================
      - name: 11-ã€æ ¡å‡†ã€‘å»¶æ—¶æ ¡å‡†ä¸å…³é”®ä¿¡æ¯æ±‡æ€»ï¼ˆæ‰‹åŠ¨/è‡ªåŠ¨éƒ½å»¶æ—¶ï¼Œ5åˆ†é’Ÿç‰ˆï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          START=${WORKFLOW_START_TIMESTAMP}
          NOW=$(date +%s)
          DUR=$((NOW - START))
          TARGET=$((TARGET_RUN_MINUTES * 60))
          WAIT=$((TARGET - DUR))
          
          echo "=================================================="
          echo "ğŸ“Š [æ±‡æ€»] æ ¸å¿ƒçŠ¶æ€ä¿¡æ¯"
          echo "=================================================="
          echo "ğŸ”Œ å¤‡ä»½æ¨¡å¼ï¼šæŒ‚è½½=${USE_MOUNT} | Rclone=${USE_RCLONE}"
          echo "ğŸ³ Dockerï¼š$(sudo systemctl is-active docker)"
          echo "ğŸ  CasaOSï¼š$(sudo systemctl is-active casaos)"
          echo "ğŸŒ Tailscale IPï¼š${TAILSCALE_IP:-æœªé…ç½®}"
          echo "â±ï¸ å·²è¿è¡Œï¼š$((DUR/60))åˆ†$((DUR%60))ç§’"
          if [ $WAIT -gt 0 ]; then
            echo "â³ éœ€ç­‰å¾…ï¼š$((WAIT/60))åˆ†$((WAIT%60))ç§’ï¼ˆæ€»æ—¶é•¿æ»¡5åˆ†é’Ÿï¼‰"  # åŒæ­¥ä¿®æ”¹æç¤ºæ–‡å­—
            sleep $WAIT
          else
            echo "âœ… å·²æ»¡è¶³æ—¶é•¿è¦æ±‚ï¼Œç›´æ¥è¿›å…¥å¤‡ä»½"
          fi
          echo "=================================================="
          echo "âœ… [æˆåŠŸ] å»¶æ—¶æ ¡å‡†å®Œæˆ"

      - name: 12-ã€å¤‡ä»½ã€‘æ•°æ®æ‰“åŒ…ä¸è¿œç¨‹å¤‡ä»½ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šTMP_FREE ç©ºå€¼é—®é¢˜ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sync && sleep 3
          
          # æ ¸å¿ƒä¿®å¤ï¼šä¼˜åŒ–TMP_FREEè·å–é€»è¾‘ï¼Œé¿å…ç©ºå€¼å¯¼è‡´æ•´æ•°æ¯”è¾ƒé”™è¯¯
          echo "â„¹ï¸ [ä¿¡æ¯] æ ¡éªŒ/tmpç£ç›˜ç©ºé—´ï¼ˆâ‰¥10Gï¼‰"
          TMP_FREE=$(df -P /tmp | awk 'NR>1 {print $4}' | tail -1)
          # å®¹é”™ï¼šç©ºå€¼æˆ–éæ•°å­—èµ‹å€¼ä¸º0
          if [ -z "$TMP_FREE" ] || ! [[ "$TMP_FREE" =~ ^[0-9]+$ ]]; then
            TMP_FREE=0
            echo "âš ï¸ [è­¦å‘Š] æ— æ³•æ­£å¸¸è·å–/tmpç©ºé—´ï¼Œé»˜è®¤èµ‹å€¼ä¸º0ï¼Œè·³è¿‡ä¸¥æ ¼æ ¡éªŒ"
          fi
          
          # å®‰å…¨æ¯”è¾ƒï¼šä»…å¯¹æœ‰æ•ˆéé›¶æ•°å€¼æŠ¥é”™
          if [ "$TMP_FREE" -lt 10485760 ] && [ "$TMP_FREE" -ne 0 ]; then
            echo "âŒ [é”™è¯¯] /tmpç©ºé—´ä¸è¶³10Gï¼Œå½“å‰å¯ç”¨ï¼š$((TMP_FREE/1024))Mï¼ˆéœ€è¦10240Mï¼‰"
            exit 1
          elif [ "$TMP_FREE" -ne 0 ]; then
            echo "âœ… [ä¿¡æ¯] /tmpç©ºé—´æ ¡éªŒé€šè¿‡ï¼Œå¯ç”¨ï¼š$((TMP_FREE/1024))M"
          fi
          
          SNAP_NAME="casaos-full-snapshot-v1-$(date +%Y%m%d-%H%M%S).tar.zst"
          MD5_NAME="${SNAP_NAME}${SNAPSHOT_MD5_SUFFIX}"
          LOCAL_SNAP="/tmp/${SNAP_NAME}"
          LOCAL_MD5="/tmp/${MD5_NAME}"
          
          sudo tar -I "zstd -T0 ${ZSTD_LEVEL}" -cPf "$LOCAL_SNAP" $EXCLUDE_RULES --warning=no-file-changed $PERSONAL_DATA_DIRS 2>/dev/null
          sudo md5sum "$LOCAL_SNAP" > "$LOCAL_MD5"
          
          BACKUP_OK=false
          if [ "${USE_MOUNT:-false}" = true ]; then
            REMOTE_DIR="${LOCAL_MOUNT_POINT}${WEBDAV_SNAPSHOT_DIR}"
            # å®¹é”™ï¼šç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            sudo mkdir -p "$REMOTE_DIR" 2>/dev/null || true
            sudo cp "$LOCAL_SNAP" "$REMOTE_DIR/" && sudo cp "$LOCAL_MD5" "$REMOTE_DIR/" && BACKUP_OK=true
            echo "âœ… [æˆåŠŸ] æŒ‚è½½æ¨¡å¼ä¸Šä¼ å®Œæˆ"
          fi
          
          if [ "$BACKUP_OK" = false ] && [ "${USE_RCLONE:-false}" = true ]; then
            # å®¹é”™ï¼šæ ¡éªŒRcloneé…ç½®æ–‡ä»¶å­˜åœ¨æ€§
            if [ ! -f "${RCLONE_CONFIG}" ]; then
              echo "âŒ [é”™è¯¯] Rcloneé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š${RCLONE_CONFIG}"
              exit 1
            fi
            rclone copy "$LOCAL_SNAP" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config "${RCLONE_CONFIG}" --transfers ${RCLONE_TRANSFERS} --retries ${RCLONE_RETRIES} --timeout ${RCLONE_TIMEOUT} --stats ${RCLONE_STATS} --stats-log-level NOTICE
            rclone copy "$LOCAL_MD5" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config "${RCLONE_CONFIG}" --retries ${RCLONE_RETRIES} --stats ${RCLONE_STATS} --stats-log-level NOTICE
            BACKUP_OK=true
            echo "âœ… [æˆåŠŸ] Rcloneæ¨¡å¼ä¸Šä¼ å®Œæˆ"
          fi
          
          [ "$BACKUP_OK" = false ] && { echo "âŒ [é”™è¯¯] å¤‡ä»½ä¸Šä¼ å¤±è´¥" && exit 1; }
          
          sudo rm -f "$LOCAL_SNAP" "$LOCAL_MD5"
          
          sudo systemctl enable --now docker containerd casaos && sleep 3
          
          if [ "${GITHUB_EVENT_NAME}" = "repository_dispatch" ] && [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            curl -fsSL --fail -X POST -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_snapshot"}' --quiet || echo "âš ï¸ [è­¦å‘Š] è‡ªåŠ¨ç»­è·‘è§¦å‘å¤±è´¥"
          fi
          
          echo "âœ… [æˆåŠŸ] å…¨é‡å¤‡ä»½å®Œæˆï¼ŒæœåŠ¡å·²é‡å¯"

      # ==============================================================================
      # é˜¶æ®µ6ï¼šæ”¶å°¾ï¼ˆæ­¥éª¤13ï¼‰
      # ==============================================================================
      - name: 13-ã€æ”¶å°¾ã€‘ç¯å¢ƒè¿˜åŸä¸æ•æ„Ÿæ–‡ä»¶æ¸…ç†
        if: ${{ always() }}
        run: |
          set +e
          # å¼ºåˆ¶å¸è½½æŒ‚è½½
          mount | grep -q "${LOCAL_MOUNT_POINT}" && sudo umount -l -f "${LOCAL_MOUNT_POINT}" --quiet 2>/dev/null || true
          # æ¸…ç†æ‰€æœ‰æ•æ„Ÿæ–‡ä»¶
          sudo rm -rf /tmp/* /var/tmp/* "${RCLONE_CONFIG}" /etc/davfs2/secrets 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y --quiet && sudo DEBIAN_FRONTEND=noninteractive apt clean --quiet 2>/dev/null || true
          set -e
          echo "ğŸ‰ [å®Œæˆ] å…¨æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œç¯å¢ƒå·²è¿˜åŸ"