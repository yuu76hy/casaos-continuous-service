name: CasaOSå¤‡ä»½æ¢å¤ï¼ˆå…ˆè£…åæ¢ ä»…ä¸ªäººæ•°æ® ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:                # æ‰‹åŠ¨è§¦å‘ï¼ˆä¼˜å…ˆæ¨èï¼‰
  repository_dispatch:
    types: [renew_casaos_snapshot]  # è‡ªåŠ¨ç»­è·‘è§¦å‘

jobs:
  casaos-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      # ä»…ä¸ªäººæ ¸å¿ƒæ•°æ®/é…ç½®ï¼Œæ— ä»»ä½•ç¨‹åºæœ¬ä½“ï¼Œå…¨è¦†ç›–ä¸ªäººæ‰€æœ‰å†…å®¹
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      # æ’é™¤åƒåœ¾æ–‡ä»¶ï¼Œåªä¿ç•™æœ‰æ•ˆä¸ªäººæ•°æ®
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–å‡†å¤‡
        run: |
          set -e
          echo "===== ç³»ç»Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          # å®‰è£…åŸºç¡€ä¾èµ–ï¼Œä¸è£…Dockerç›¸å…³ï¼ˆåç»­å®˜æ–¹ä¸€é”®è£…ï¼‰
          sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ŒåŸºç¡€ä¾èµ–å°±ç»ª"

      - name: 2-å®˜æ–¹ä¸€é”®å®‰è£…Dockerï¼ˆå«composeï¼Œæ— å…¼å®¹é—®é¢˜ï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          # å¸è½½æ—§ç‰ˆæœ¬æ®‹ç•™ï¼Œé¿å…å†²çª
          sudo apt remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
          # å®˜æ–¹ä¸€é”®å®‰è£…è„šæœ¬ï¼Œè‡ªå¸¦composeï¼Œå…¼å®¹æ‰€æœ‰ç³»ç»Ÿ
          curl -fsSL https://get.docker.com | sudo bash
          # å¯ç”¨Dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯
          sudo systemctl enable docker containerd && sudo systemctl start docker containerd
          sleep 3
          # éªŒè¯å®‰è£…
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®˜æ–¹ç‰ˆå®‰è£…å®Œæˆï¼Œå«composeåŠŸèƒ½ï¼Œè¿è¡Œæ­£å¸¸"

      - name: 3-åˆ›å»ºå…å¯†rootæƒé™ç”¨æˆ·
        run: |
          set -e
          echo "===== åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          # è‡ªå®šä¹‰/éšæœºå¯†ç é€‚é…
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
            echo "âœ… ç”¨æˆ·å¯†ç ï¼šè‡ªå®šä¹‰é…ç½®"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "âœ… ç”¨æˆ·éšæœºå¯†ç ï¼š$RANDOM_PASSï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼‰"
          fi
          # å…å¯†sudo+Dockeræƒé™
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          echo "âœ… rootsç”¨æˆ·é…ç½®å®Œæˆï¼Œå…å¯†sudo+Dockeræƒé™"

      - name: 4-Rcloneé…ç½®+WebDAVæ ¡éªŒ+æŸ¥æ‰¾ä¸ªäººæ•°æ®å¿«ç…§
        run: |
          set -e
          echo "===== WebDAVé…ç½®ä¸å¿«ç…§æ£€æŸ¥ ====="
          # å‡­è¯ç¼ºå¤±ç›´æ¥è·³è¿‡å¤‡ä»½æ¢å¤ï¼Œä¸æŠ¥é”™
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤ç›¸å…³æ“ä½œ"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # é…ç½®Rcloneï¼Œå¯†ç åŠ å¯†æ›´å®‰å…¨
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          # åˆ›å»ºå¿«ç…§ç›®å½•ï¼Œæ— åˆ™è‡ªåŠ¨åˆ›å»º
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null || true
          # ç²¾å‡†æŸ¥æ‰¾æœ€æ–°ä¸ªäººæ•°æ®å¿«ç…§ï¼Œæ— å¿«ç…§ç›´æ¥æ ‡æ³¨
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ‰¾åˆ°æœ€æ–°ä¸ªäººæ•°æ®å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æ— ä¸ªäººæ•°æ®å¤‡ä»½å¿«ç…§ï¼Œè·³è¿‡æ¢å¤ï¼Œç›´æ¥çº¯å‡€å¯åŠ¨"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      # æ ¸å¿ƒæ­¥éª¤1ï¼šå…ˆè£…çº¯å‡€CasaOSç¨‹åºï¼Œä»…ç¨‹åºæœ¬ä½“ï¼Œæ— ä¸ªäººæ•°æ®
      - name: 5-å…¨æ–°å®‰è£…çº¯å‡€CasaOSï¼ˆä»…ç¨‹åºï¼Œæ— ä¸ªäººæ•°æ®ï¼‰
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…çº¯å‡€CasaOSç¨‹åº ====="
          # ç¡®ä¿Dockeræ­£å¸¸è¿è¡Œï¼ˆCasaOSæ ¸å¿ƒä¾èµ–ï¼‰
          sudo systemctl restart docker containerd && sleep 3
          if ! sudo systemctl is-active --quiet docker; then
            echo "âš ï¸ Dockerå¯åŠ¨å¼‚å¸¸ï¼Œé‡è¯•ä¸€æ¬¡"
            sudo systemctl restart docker containerd && sleep 3
          fi
          # å½»åº•æ¸…ç†æ—§ç‰ˆæœ¬æ®‹ç•™ï¼Œä¿è¯çº¯å‡€æ— æ®‹ç•™
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo rm -rf /usr/bin/casaos 2>/dev/null || true
          sudo systemctl daemon-reload
          # å®˜æ–¹çº¯å‡€å®‰è£…ï¼Œä»…éƒ¨ç½²ç¨‹åºæœ¬ä½“ï¼Œæ— ä»»ä½•ä¸ªäººé…ç½®
          curl -fsSL https://get.casaos.io | sudo bash
          # è£…å®Œç«‹å³å…³åœï¼Œç­‰å¾…æ¢å¤ä¸ªäººæ•°æ®ï¼ˆæœ‰åˆ™æ¢ï¼Œæ— åˆ™åç»­ç›´æ¥å¯åŠ¨ï¼‰
          sudo systemctl stop casaos && sudo systemctl stop docker 2>/dev/null || true
          echo "âœ… çº¯å‡€CasaOSç¨‹åºå®‰è£…å®Œæˆï¼Œå·²å…³åœå¾…æ•°æ®æ¢å¤"

      # æ ¸å¿ƒæ­¥éª¤2ï¼šä»…æ¢å¤ä¸ªäººæ ¸å¿ƒæ•°æ®ï¼Œæ— å¿«ç…§è‡ªåŠ¨è·³è¿‡ï¼Œä¸ç¢°ä»»ä½•ç¨‹åºæœ¬ä½“
      - name: 6-æ¢å¤ä¸ªäººæ ¸å¿ƒæ•°æ®ï¼ˆé…ç½®/åº”ç”¨/æ–‡ä»¶ï¼Œæ— å¿«ç…§è·³è¿‡ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== æ¢å¤ä¸ªäººæ ¸å¿ƒæ•°æ®ï¼ˆä¸ç¢°ç¨‹åºæœ¬ä½“ï¼‰====="
          # è¦†ç›–å‰å¿…å…³æ‰€æœ‰ç›¸å…³æœåŠ¡+æ€æ®‹ç•™è¿›ç¨‹ï¼Œé¿å…æ–‡ä»¶å ç”¨æŸåï¼Œå…³é”®æ“ä½œ
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          # æå‰åˆ›å»ºä¸ªäººæ•°æ®ç›®å½•ï¼Œé¿å…æ¢å¤æ—¶ç›®å½•ç¼ºå¤±æŠ¥é”™
          sudo mkdir -p /var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config 2>/dev/null || true
          # ç²¾å‡†æ¢å¤ä¸ªäººæ•°æ®ï¼Œä»…æŒ‡å®š5ä¸ªç›®å½•ï¼Œç»ä¸æ¶‰åŠç¨‹åºæ–‡ä»¶
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions \
            /var/lib/docker \
            /etc/casaos \
            /var/lib/casaos \
            /DATA \
            /root/.config
          # åˆ é™¤å·²æ¢å¤å¿«ç…§ï¼Œé¿å…é‡å¤æ¢å¤å ç”¨ç©ºé—´
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "âœ… ä¸ªäººæ ¸å¿ƒæ•°æ®æ¢å¤å®Œæˆï¼ˆDockeråº”ç”¨+CasaOSé…ç½®+ä¸ªäººæ–‡ä»¶ï¼‰"

      # æ ¸å¿ƒè¡”æ¥ï¼šæƒé™æ ¡æ­£+å¯åŠ¨æœåŠ¡ï¼Œæœ‰æ— æ•°æ®éƒ½å®Œç¾é€‚é…
      - name: 7-æƒé™æ ¡æ­£+å¯åŠ¨Docker+CasaOSï¼ˆé€šç”¨é€‚é…ï¼‰
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£+å¯åŠ¨æœåŠ¡ ====="
          # ä»…æ ¡æ­£ä¸ªäººæ•°æ®ç›®å½•æƒé™ï¼Œä¸è§¦ç¢°ç¨‹åºç›®å½•ï¼Œé¿å…æƒé™é”™ä¹±
          sudo chown -R root:root /etc/casaos /var/lib/casaos /DATA /var/lib/docker /root/.config
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          # ä¿®å¤Docker sockæƒé™ï¼Œé¿å…CasaOSè¿æ¥Dockerå¤±è´¥
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo chmod 660 /run/docker.sock 2>/dev/null || true
          sudo chown root:docker /run/docker.sock 2>/dev/null || true
          # é‡Šæ”¾80/443ç«¯å£ï¼Œé¿å…ç¬¬ä¸‰æ–¹ç¨‹åºå ç”¨å¯¼è‡´CasaOSæ— æ³•è®¿é—®
          sudo lsof -t -i:80 -i:443 | xargs sudo kill -9 2>/dev/null || true
          # åˆ›å»ºCasaOSä¸“å±ç½‘ç»œï¼Œä¿è¯åº”ç”¨ç½‘ç»œæ­£å¸¸
          sudo docker network create casaos 2>/dev/null || true
          # å¯åŠ¨é¡ºåºï¼šå…ˆDockeråCasaOSï¼Œä¾èµ–å…³ç³»æ­£ç¡®ï¼Œå¯åŠ¨æ›´ç¨³å®š
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 4
          sudo systemctl enable --now casaos && sleep 6
          # çŠ¶æ€æ ¡éªŒï¼Œå¼‚å¸¸è‡ªåŠ¨é‡è¯•ï¼Œæé«˜æˆåŠŸç‡
          if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
            echo "âœ… Docker+CasaOSå‡å¯åŠ¨æˆåŠŸï¼çº¯å‡€ç¨‹åº+ä¸ªäººæ•°æ®å®Œç¾èåˆ"
          else
            echo "âš ï¸ æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œè‡ªåŠ¨é‡è¯•ä¸€æ¬¡"
            sudo systemctl restart docker containerd casaos && sleep 3
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… é‡è¯•å¯åŠ¨æˆåŠŸï¼"
            fi
          fi

      - name: 8-Tailscaleè¿œç¨‹ç»„ç½‘ï¼ˆå¯é€‰ï¼Œæ— å¯†é’¥è‡ªåŠ¨è·³è¿‡ï¼‰
        run: |
          set -e
          echo "===== Tailscaleè¿œç¨‹ç»„ç½‘é…ç½® ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æ— Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘æ“ä½œ"
            exit 0
          fi
          # å®˜æ–¹å®‰è£…Tailscaleï¼Œå…¼å®¹Ubuntu 24.04
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq --upgrade
          sudo systemctl enable --now tailscaled && sleep 2
          # ç»„ç½‘é…ç½®ï¼Œè‡ªåŠ¨è·å–è¿œç¨‹è®¿é—®IP
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes --accept-dns
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)
          if [ -n "$TS_IP" ]; then
            echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œè¿œç¨‹è®¿é—®IPï¼š${TS_IP}"
          else
            echo "âœ… Tailscaleç»„ç½‘å®Œæˆï¼Œæš‚æœªè·å–IPv4åœ°å€"
          fi

      - name: 9-å…¨é‡å¤‡ä»½ï¼ˆä»…ä¸ªäººæ•°æ®ï¼‰+è‡ªåŠ¨ç»­è·‘ï¼ˆæŒä¹…åŒ–ä¿éšœï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== å¤‡ä»½ä¸ªäººæ•°æ®+è‡ªåŠ¨ç»­è·‘ ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          # å¤‡ä»½å‡½æ•°ï¼šä»…å¤‡ä»½ä¸ªäººæ•°æ®ï¼Œæ— ä»»ä½•ç¨‹åºæœ¬ä½“ï¼Œä½“ç§¯æ›´å°
          full_backup(){
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            sudo tar -czPf /tmp/$SNAPSHOT_NAME --exclude=${EXCLUDE_RULES} ${PERSONAL_DATA_DIRS}
            # ä¸Šä¼ åˆ°WebDAVï¼Œä¿éšœæ•°æ®å®‰å…¨
            rclone copy /tmp/$SNAPSHOT_NAME mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --transfers 4 --fast-list
            # æ¸…ç†æœ¬åœ°ä¸´æ—¶å¤‡ä»½æ–‡ä»¶
            sudo rm -f /tmp/$SNAPSHOT_NAME
            echo "âœ… ä¸ªäººæ•°æ®å¤‡ä»½å®Œæˆï¼Œæ–‡ä»¶åï¼š$SNAPSHOT_NAME"
          }
          # è‡ªåŠ¨ç»­è·‘å‡½æ•°ï¼šè§¦å‘æ–°æµç¨‹ï¼Œå®ç°å¾ªç¯å¤‡ä»½
          trigger_renew(){
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âš ï¸ USER_PAT/REPOæœªé…ç½®ï¼Œè·³è¿‡è‡ªåŠ¨ç»­è·‘"
              return 1
            fi
            curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}'
            echo "âœ… è‡ªåŠ¨ç»­è·‘è§¦å‘æˆåŠŸï¼Œæ–°å¤‡ä»½æµç¨‹å·²å¯åŠ¨"
          }
          # å¾ªç¯é€»è¾‘ï¼š2åˆ†é’Ÿåé¦–æ¬¡å¤‡ä»½ï¼Œä¹‹åæŒç»­è¿è¡Œè‡³ä¸Šé™æ—¶é—´
          while true; do
            run_mins=$(( (date +%s - start_time)/60 ))
            echo "ğŸ“Š æµç¨‹å·²è¿è¡Œ${run_mins}åˆ†é’Ÿï¼ˆä¸Šé™${MAX_RUN_MINUTES}åˆ†é’Ÿï¼‰"
            # è¿è¡Œ2åˆ†é’Ÿåè§¦å‘å¤‡ä»½ï¼Œä»…æ‰§è¡Œä¸€æ¬¡
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è¾¾åˆ°å¤‡ä»½æ¡ä»¶ï¼Œå¼€å§‹æ‰§è¡Œä¸ªäººæ•°æ®å¤‡ä»½"
              if full_backup; then
                trigger_renew && RENEW_TRIGGERED=true
              else
                echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œ30åˆ†é’Ÿåè‡ªåŠ¨é‡è¯•"
                sleep 1800
              fi
            fi
            # è¾¾åˆ°è¿è¡Œä¸Šé™ï¼Œè‡ªåŠ¨é€€å‡ºï¼Œé¿å…èµ„æºå ç”¨
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "âœ… è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œå¤‡ä»½ç»­è·‘æµç¨‹æ­£å¸¸ç»“æŸ"
              exit 0
            fi
            sleep 60
          done

      - name: 10-æ”¶å°¾æ¸…ç†ï¼ˆå…¨ç¨‹å¿…æ‰§è¡Œï¼Œæ— æ®‹ç•™æ— æ±¡æŸ“ï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç† ====="
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€Rcloneé…ç½®ã€ç”¨æˆ·æƒé™é…ç½®
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          # æ¸…ç†ç³»ç»Ÿæ— ç”¨ä¾èµ–ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´
          sudo apt autoremove -y -qq && sudo apt clean -y -qq && sudo apt autoclean -y -qq
          # æœ€ç»ˆè¿è¡ŒçŠ¶æ€æç¤ºï¼Œä¸€ç›®äº†ç„¶
          if sudo systemctl is-active --quiet casaos; then
            echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼CasaOSç¨³å®šè¿è¡Œâœ…"
            echo "ğŸ“Œ çŠ¶æ€ï¼šçº¯å‡€ç¨‹åº+ä¸ªäººæ•°æ®å·²åŒæ­¥ï¼ˆæœ‰å¤‡ä»½ï¼‰/çº¯å‡€å¯åŠ¨ï¼ˆæ— å¤‡ä»½ï¼‰"
          else
            echo "âš ï¸ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ŒCasaOSè¿è¡Œå¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ’æŸ¥"
          fi
