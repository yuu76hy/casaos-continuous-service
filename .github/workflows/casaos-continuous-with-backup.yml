name: CasaOS ç²¾ç®€å¤‡ä»½ï¼ˆæ— Dockeré•œåƒÂ·Tailscaleç»„ç½‘Â·å…¬ç½‘OpenListæœ¬æœºä»£ç†Â·å¾®è½¯äº‘ç›˜Â·ä¸¥æ ¼é¡ºåºÂ·zstd-19ï¼‰

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy-backup:
    runs-on: ubuntu-24.04
    timeout-minutes: 1440
    concurrency:
      group: casaos-backup
      cancel-in-progress: true
    env:
      # ====================== 1. æ ¸å¿ƒé…ç½®ï¼ˆSecretså·²éšè—ï¼‰ ======================
      WEBDAV_URL:          ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER:         ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD:     ${{ secrets.WEBDAV_PASSWORD }}
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS:  "/var/lib/docker/containers /var/lib/docker/volumes /var/lib/docker/overlay2 /etc/casaos /var/lib/casaos /DATA /root/.config"
      ROOTS_PASSWORD:      ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT:            ${{ secrets.USER_PAT }}
      REPO:                ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY:  ${{ secrets.TAILSCALE_AUTH_KEY }}

      # ====================== 2. é€šç”¨å‚æ•°ï¼ˆæ— å…¼å®¹æ€§é—®é¢˜ï¼‰ ======================
      KEEP_BACKUPS:        2
      TARGET_RUN_MINUTES:  1  # ç¨³å®šå»¶æ—¶1åˆ†é’Ÿ
      RCLONE_CONFIG:       "/etc/rclone.conf"
      PARALLEL_CORE:       4
      ZSTD_LEVEL:          19
      RCLONE_TRANSFERS:    1
      RCLONE_BUFFER:       "512M"
      WEBDAV_CHUNK_SIZE:   "64M"  # WebDAVåˆ†å—å¤§å°ï¼ˆå†™å…¥é…ç½®ï¼Œå…¼å®¹ä½ç‰ˆæœ¬rcloneï¼‰
      MAX_REDIRECT:        20
      TIMEOUT:             "120m"
      CONTIMEOUT:          "10m"
      WEBDAV_EXTRA_FLAGS:  "--no-check-certificate --disable-http2"  # é€‚é…OpenListä»£ç†


    steps:
      # ====================================== Step 1ï¼šç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–å¼ºæ ¡éªŒ ======================================
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–å¼ºæ ¡éªŒ
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 1-ç³»ç»Ÿåˆå§‹åŒ–+ä¾èµ–å¼ºæ ¡éªŒ =====\033[0m"
          
          # 1. å¼ºåˆ¶æ›´æ–°aptæº+å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå«opensslã€rcloneä¾èµ–ï¼‰
          sudo apt update -y -qq || (echo -e "\033[1;31mâŒ aptæ›´æ–°å¤±è´¥\033[0m" && exit 1)
          sudo apt install -y -qq curl wget jq tar gzip lsof ca-certificates gnupg pigz zstd psmisc procps language-pack-zh-hans openssl || (echo -e "\033[1;31mâŒ ä¾èµ–å®‰è£…å¤±è´¥\033[0m" && exit 1)
          
          # 2. å¼ºåˆ¶å‡çº§rcloneè‡³â‰¥1.60ï¼ˆè§£å†³å‚æ•°å…¼å®¹æ€§ï¼‰
          echo -e "\033[1;33mğŸ”§ å‡çº§rcloneè‡³æœ€æ–°ç¨³å®šç‰ˆ\033[0m"
          curl -fSL -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip || (echo -e "\033[1;31mâŒ rcloneä¸‹è½½å¤±è´¥\033[0m" && exit 1)
          unzip -q rclone.zip
          sudo cp rclone-*-linux-amd64/rclone /usr/bin/
          sudo chmod +x /usr/bin/rclone
          rm -rf rclone.zip rclone-*-linux-amd64
          
          # æ ¡éªŒrcloneç‰ˆæœ¬â‰¥1.58
          RCLONE_VER=$(rclone version | head -1 | awk '{print $2}' | cut -d'.' -f1-2)
          if [ $(echo "$RCLONE_VER < 1.58" | bc -l) -eq 1 ]; then
            echo -e "\033[1;31mâŒ rcloneç‰ˆæœ¬è¿‡ä½ï¼ˆå½“å‰$RCLONE_VERï¼Œéœ€â‰¥1.58ï¼‰\033[0m"
            exit 1
          fi
          echo -e "\033[1;32mâœ… rcloneç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼š$RCLONE_VER\033[0m"
          
          # 3. æ¸…ç†æ—§æ®‹ç•™+é‡Šæ”¾èµ„æº
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sudo systemctl disable casaos docker containerd 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /var/cache/apt/* /var/lib/docker/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          
          echo -e "\033[1;32mâœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\033[0m"


      # ====================================== Step 2ï¼šTailscaleç»„ç½‘+çŠ¶æ€å¼ºæ ¡éªŒ ======================================
      - name: 2-Tailscaleç»„ç½‘+çŠ¶æ€å¼ºæ ¡éªŒ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 2-Tailscaleç»„ç½‘+çŠ¶æ€å¼ºæ ¡éªŒ =====\033[0m"
          
          # 1. å®‰è£…Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh || (echo -e "\033[1;31mâŒ Tailscaleå®‰è£…å¤±è´¥\033[0m" && exit 1)
          sleep 2
          
          # 2. ç»„ç½‘+å‚æ•°å¼ºæ ¡éªŒ
          sudo tailscale up \
            --auth-key="$TAILSCALE_AUTH_KEY" \
            --login-server="https://controlplane.tailscale.com" \
            --accept-routes \
            --accept-dns || (echo -e "\033[1;31mâŒ Tailscaleç»„ç½‘å¤±è´¥\033[0m" && exit 1)
          sleep 5
          
          # 3. æ ¡éªŒç»„ç½‘çŠ¶æ€
          TS_IP=$(tailscale ip -4 2>/dev/null)
          if [ -z "$TS_IP" ]; then
            echo -e "\033[1;31mâŒ Tailscaleæœªè·å–åˆ°IP\033[0m"
            exit 1
          fi
          echo -e "\033[1;32mâœ… Tailscaleç»„ç½‘æˆåŠŸï¼ŒèŠ‚ç‚¹IPï¼š$TS_IP\033[0m"
          echo "TAILSCALE_IP=$TS_IP" >> "$GITHUB_ENV"


      # ====================================== Step 3ï¼šDockerå®‰è£…+æœåŠ¡å¼ºæ ¡éªŒ ======================================
      - name: 3-Dockerå®‰è£…+æœåŠ¡å¼ºæ ¡éªŒ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 3-Dockerå®‰è£…+æœåŠ¡å¼ºæ ¡éªŒ =====\033[0m"
          
          # 1. å®‰è£…Dockerï¼ˆé˜¿é‡Œäº‘é•œåƒåŠ é€Ÿï¼‰
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun || (echo -e "\033[1;31mâŒ Dockerå®‰è£…å¤±è´¥\033[0m" && exit 1)
          sudo systemctl enable --now docker containerd || (echo -e "\033[1;31mâŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥\033[0m" && exit 1)
          sleep 5
          
          # 2. æ ¡éªŒDockerå¯ç”¨æ€§
          if ! docker --version; then
            echo -e "\033[1;31mâŒ Dockeræœªå®‰è£…æˆåŠŸ\033[0m"
            exit 1
          fi
          sudo usermod -aG docker runner || true
          echo -e "\033[1;32mâœ… Dockerå®‰è£…å®Œæˆï¼š$(docker --version)\033[0m"


      # ====================================== Step 4ï¼šCasaOSå®‰è£…+è‡ªå¯ç¦ç”¨ ======================================
      - name: 4-CasaOSå®‰è£…+è‡ªå¯ç¦ç”¨
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 4-CasaOSå®‰è£…+è‡ªå¯ç¦ç”¨ =====\033[0m"
          
          # 1. å®‰è£…CasaOS
          curl -fsSL https://get.casaos.io | sudo bash || (echo -e "\033[1;31mâŒ CasaOSå®‰è£…å¤±è´¥\033[0m" && exit 1)
          
          # 2. ç¦ç”¨è‡ªå¯ï¼ˆä¸¥æ ¼é¡ºåºå¯åŠ¨ï¼‰
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos || (echo -e "\033[1;31mâŒ CasaOSç¦ç”¨è‡ªå¯å¤±è´¥\033[0m" && exit 1)
          
          # 3. æ ¡éªŒå®‰è£…
          if ! command -v casaos &>/dev/null; then
            echo -e "\033[1;31mâŒ CasaOSæœªå®‰è£…æˆåŠŸ\033[0m"
            exit 1
          fi
          echo -e "\033[1;32mâœ… CasaOSå®‰è£…å®Œæˆï¼ˆå·²ç¦ç”¨è‡ªå¯ï¼‰\033[0m"


      # ====================================== Step 5ï¼šrootsç®¡ç†å‘˜é…ç½®+æƒé™å¼ºæ ¡éªŒ ======================================
      - name: 5-rootsç®¡ç†å‘˜é…ç½®+æƒé™å¼ºæ ¡éªŒ
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 5-rootsç®¡ç†å‘˜é…ç½®+æƒé™å¼ºæ ¡éªŒ =====\033[0m"
          
          USER_NAME="roots"
          # 1. åˆ›å»ºç”¨æˆ·ï¼ˆå«å®¶ç›®å½•ï¼‰
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME" || (echo -e "\033[1;31mâŒ rootsç”¨æˆ·åˆ›å»ºå¤±è´¥\033[0m" && exit 1)
          
          # 2. è®¾ç½®å¯†ç 
          if [ -n "$ROOTS_PASSWORD" ]; then
            printf "%s:%s\n" "$USER_NAME" "$ROOTS_PASSWORD" | sudo chpasswd || (echo -e "\033[1;31mâŒ rootså¯†ç è®¾ç½®å¤±è´¥\033[0m" && exit 1)
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            printf "%s:%s\n" "$USER_NAME" "$RANDOM_PASS" | sudo chpasswd
            echo "::add-mask::$RANDOM_PASS"
            echo -e "\033[1;33mğŸ”‘ rootséšæœºå¯†ç ï¼š$RANDOM_PASS\033[0m"
          fi
          
          # 3. å…å¯†sudo+Dockeræƒé™
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null || true
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME" || (echo -e "\033[1;31mâŒ rootsç”¨æˆ·Dockeræƒé™é…ç½®å¤±è´¥\033[0m" && exit 1)
          
          echo -e "\033[1;32mâœ… rootsç®¡ç†å‘˜é…ç½®å®Œæˆ\033[0m"


      # ====================================== Step 6ï¼šrcloneé…ç½®+WebDAVå¼ºè¿é€šæ€§ ======================================
      - name: 6-rcloneé…ç½®+WebDAVå¼ºè¿é€šæ€§
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 6-rcloneé…ç½®+WebDAVå¼ºè¿é€šæ€§ =====\033[0m"
          
          # 1. æ ¡éªŒWebDAVé…ç½®å®Œæ•´æ€§
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo -e "\033[1;31mâŒ WebDAVé…ç½®ä¸å®Œæ•´\033[0m"
            exit 1
          fi
          
          # 2. åˆ›å»ºrcloneé…ç½®ï¼ˆå«WebDAVåˆ†å—å¤§å°ï¼‰
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          sudo rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            vendor="onedrive" \
            chunk_size="$WEBDAV_CHUNK_SIZE" \  # åˆ†å—å¤§å°å†™å…¥é…ç½®ï¼ˆå…¼å®¹æ‰€æœ‰ç‰ˆæœ¬ï¼‰
            --config "$RCLONE_CONFIG" || (echo -e "\033[1;31mâŒ rcloneé…ç½®åˆ›å»ºå¤±è´¥\033[0m" && exit 1)
          sudo chmod 600 "$RCLONE_CONFIG"
          
          # 3. åˆ›å»ºå¤‡ä»½ç›®å½•
          sudo rclone mkdir mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" 2>/dev/null || true
          
          # 4. å¼ºè¿é€šæ€§æµ‹è¯•
          TEST_FILE="test-webdav-$(date +%s).txt"
          echo "test" > /tmp/$TEST_FILE
          sudo rclone copy /tmp/$TEST_FILE mywebdav:"$WEBDAV_SNAPSHOT_DIR/" --config "$RCLONE_CONFIG" $WEBDAV_EXTRA_FLAGS || (echo -e "\033[1;31mâŒ WebDAVè¿æ¥å¤±è´¥\033[0m" && exit 1)
          sudo rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$TEST_FILE" --config "$RCLONE_CONFIG"
          rm -f /tmp/$TEST_FILE
          
          # 5. æ£€æµ‹å†å²å¤‡ä»½
          REMOTE_SNAPSHOTS=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" | grep "casaos-full-snapshot.*\.tar\.zst$" | sed 's/^[0-9]\+ //')
          LATEST_SNAPSHOT=$(echo "$REMOTE_SNAPSHOTS" | sort -r | head -1 | tr -d '\n')
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo -e "\033[1;32mâœ… æ£€æµ‹åˆ°å†å²å¤‡ä»½ï¼š$LATEST_SNAPSHOT\033[0m"
            echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo -e "\033[1;33mâœ… æ— å†å²å¤‡ä»½\033[0m"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          
          echo -e "\033[1;32mâœ… rclone+WebDAVé…ç½®å®Œæˆ\033[0m"


      # ====================================== Step 7ï¼šæ¢å¤å†å²å¤‡ä»½ï¼ˆè‹¥å­˜åœ¨ï¼‰ ======================================
      - name: 7-æ¢å¤å†å²å¤‡ä»½ï¼ˆè‹¥å­˜åœ¨ï¼‰
        if: ${{ env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 7-æ¢å¤å†å²å¤‡ä»½ =====\033[0m"
          
          # 1. åœæ­¢æœåŠ¡+é‡Šæ”¾é”
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -f "docker|containerd|casaos" 2>/dev/null || true
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          sync && sleep 2
          
          # 2. ä¸‹è½½å¤‡ä»½
          echo -e "\033[1;33mğŸ”½ ä¸‹è½½å†å²å¤‡ä»½ï¼š$LATEST_SNAPSHOT\033[0m"
          sudo rclone copy mywebdav:"$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" /tmp/ --config "$RCLONE_CONFIG" $WEBDAV_EXTRA_FLAGS --progress || (echo -e "\033[1;31mâŒ å¤‡ä»½ä¸‹è½½å¤±è´¥\033[0m" && exit 1)
          
          # 3. è§£å‹æ¢å¤ï¼ˆä¿ç•™æƒé™ï¼‰
          echo -e "\033[1;33mğŸ—œï¸ è§£å‹æ¢å¤\033[0m"
          zstd -d -c /tmp/$LATEST_SNAPSHOT | sudo tar -xP --preserve-permissions --preserve-acls --selinux -f - -C / --overwrite --ignore-failed-read $PERSONAL_DATA_DIRS || (echo -e "\033[1;31mâŒ å¤‡ä»½è§£å‹å¤±è´¥\033[0m" && exit 1)
          sudo rm -f /tmp/$LATEST_SNAPSHOT
          
          # 4. ä¿®å¤æƒé™
          sudo chown -R root:docker /var/lib/docker
          sudo chown -R root:root /etc/casaos /var/lib/casaos
          sudo chown -R roots:roots /DATA /root/.config
          
          echo -e "\033[1;32mâœ… å†å²å¤‡ä»½æ¢å¤å®Œæˆ\033[0m"


      # ====================================== Step 8ï¼šDockerå¯åŠ¨+å®¹å™¨æ¢å¤ ======================================
      - name: 8-Dockerå¯åŠ¨+å®¹å™¨æ¢å¤
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 8-Dockerå¯åŠ¨+å®¹å™¨æ¢å¤ =====\033[0m"
          
          # 1. å¯åŠ¨DockeræœåŠ¡
          sudo systemctl restart docker containerd || (echo -e "\033[1;31mâŒ DockeræœåŠ¡é‡å¯å¤±è´¥\033[0m" && exit 1)
          sleep 15
          
          # 2. æ‹‰å–å®¹å™¨é•œåƒï¼ˆé‡è¯•3æ¬¡ï¼‰
          IMAGES=$(docker ps -a --format "{{.Image}}" | grep -v "^$" | sort | uniq)
          if [ -n "$IMAGES" ]; then
            echo -e "\033[1;33mğŸš€ æ‹‰å–å®¹å™¨é•œåƒ\033[0m"
            for IMG in $IMAGES; do
              for i in {1..3}; do
                if docker pull "$IMG"; then break; fi
                if [ $i -eq 3 ]; then
                  echo -e "\033[1;31mâŒ é•œåƒ$IMGæ‹‰å–å¤±è´¥\033[0m"
                  exit 1
                fi
                sleep 10
              done
            done
          fi
          
          # 3. å¯åŠ¨æ‰€æœ‰å®¹å™¨
          CONTAINER_IDS=$(docker ps -a -q)
          if [ -n "$CONTAINER_IDS" ]; then
            echo -e "\033[1;33mğŸ”„ å¯åŠ¨æ‰€æœ‰å®¹å™¨\033[0m"
            docker start $CONTAINER_IDS || (echo -e "\033[1;31mâŒ å®¹å™¨å¯åŠ¨å¤±è´¥\033[0m" && exit 1)
            sleep 40
          fi
          
          echo -e "\033[1;32mâœ… Dockerå°±ç»ªï¼Œè¿è¡Œä¸­å®¹å™¨ï¼š$(docker ps | wc -l)\033[0m"


      # ====================================== Step 9ï¼šCasaOSæœ€ç»ˆå¯åŠ¨ ======================================
      - name: 9-CasaOSæœ€ç»ˆå¯åŠ¨
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 9-CasaOSæœ€ç»ˆå¯åŠ¨ =====\033[0m"
          
          # 1. å¯åŠ¨CasaOSï¼ˆDockerå°±ç»ªåï¼‰
          sudo systemctl enable --now casaos || (echo -e "\033[1;31mâŒ CasaOSå¯åŠ¨å¤±è´¥\033[0m" && exit 1)
          sleep 15
          
          # 2. å¥åº·æ£€æŸ¥ï¼ˆé‡è¯•3æ¬¡ï¼‰
          for i in {1..3}; do
            if systemctl is-active --quiet casaos; then
              echo -e "\033[1;32mâœ… CasaOSå¯åŠ¨æˆåŠŸ\033[0m"
              exit 0
            fi
            echo -e "âš ï¸ CasaOSå¯åŠ¨ä¸­ï¼Œç¬¬$iæ¬¡é‡è¯•..."
            sleep 10
          done
          echo -e "\033[1;31mâŒ CasaOSå¯åŠ¨å¤±è´¥\033[0m"
          exit 1


      # ====================================== Step 10ï¼šç³»ç»Ÿç¨³å®šå»¶æ—¶ ======================================
      - name: 10-ç³»ç»Ÿç¨³å®šå»¶æ—¶
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 10-ç³»ç»Ÿç¨³å®šå»¶æ—¶$TARGET_RUN_MINUTESåˆ†é’Ÿ =====\033[0m"
          sleep $((TARGET_RUN_MINUTES * 60))
          echo -e "\033[1;32mâœ… ç³»ç»Ÿç¨³å®šè¿è¡Œå®Œæˆ\033[0m"


      # ====================================== Step 11ï¼šæ‰“åŒ…ç²¾ç®€å¤‡ä»½ ======================================
      - name: 11-æ‰“åŒ…ç²¾ç®€å¤‡ä»½ï¼ˆzstd-19ï¼‰
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 11-æ‰“åŒ…ç²¾ç®€å¤‡ä»½ =====\033[0m"
          
          # 1. åœæ­¢æœåŠ¡+é‡Šæ”¾é”
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -f "docker|containerd|casaos" 2>/dev/null || true
          sudo fuser -k /var/lib/docker /var/lib/casaos 2>/dev/null || true
          sync && sleep 2
          
          # 2. ç”Ÿæˆå¤‡ä»½æ–‡ä»¶ï¼ˆå«æ—¶é—´æˆ³ï¼‰
          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          echo -e "\033[1;33mğŸ—œï¸ ç”Ÿæˆå¤‡ä»½ï¼š$SNAPSHOT_NAME\033[0m"
          
          # 3. æ‰“åŒ…ï¼ˆä»…æ ¸å¿ƒæ•°æ®+é«˜å‹ç¼©ï¼‰
          sudo tar -cPf - --one-file-system --warning=no-file-changed --ignore-failed-read $PERSONAL_DATA_DIRS \
            | zstd -$ZSTD_LEVEL -T$PARALLEL_CORE > /tmp/$SNAPSHOT_NAME || (echo -e "\033[1;31mâŒ å¤‡ä»½æ‰“åŒ…å¤±è´¥\033[0m" && exit 1)
          
          # 4. æ ¡éªŒå¤‡ä»½æœ‰æ•ˆæ€§
          if [ ! -f "/tmp/$SNAPSHOT_NAME" ] || [ $(du -b "/tmp/$SNAPSHOT_NAME" | cut -f1) -lt 1024 ]; then
            echo -e "\033[1;31mâŒ å¤‡ä»½æ–‡ä»¶æ— æ•ˆ\033[0m"
            exit 1
          fi
          
          echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" >> "$GITHUB_ENV"
          echo -e "\033[1;32mâœ… å¤‡ä»½å®Œæˆï¼š$(du -h /tmp/$SNAPSHOT_NAME)\033[0m"


      # ====================================== Step 12ï¼šä¸Šä¼ å¤‡ä»½è‡³WebDAV ======================================
      - name: 12-ä¸Šä¼ å¤‡ä»½è‡³WebDAV
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 12-ä¸Šä¼ å¤‡ä»½è‡³WebDAV =====\033[0m"
          
          # 1. æ–­ç‚¹ç»­ä¼ ä¸Šä¼ ï¼ˆé‡è¯•10æ¬¡ï¼‰
          echo -e "\033[1;33mğŸ“¤ ä¸Šä¼ å¤‡ä»½ï¼š$SNAPSHOT_NAME\033[0m"
          sudo rclone copy /tmp/$SNAPSHOT_NAME mywebdav:"$WEBDAV_SNAPSHOT_DIR/" \
            --config "$RCLONE_CONFIG" \
            --transfers $RCLONE_TRANSFERS \
            --buffer-size $RCLONE_BUFFER \
            --max-redirect $MAX_REDIRECT \
            --timeout $TIMEOUT \
            --contimeout $CONTIMEOUT \
            $WEBDAV_EXTRA_FLAGS \
            --resume \
            --retries 10 \
            --retries-sleep 60s \
            --stats 30s \
            --progress || (echo -e "\033[1;31mâŒ å¤‡ä»½ä¸Šä¼ å¤±è´¥\033[0m" && exit 1)
          
          # 2. æ ¡éªŒä¸Šä¼ ç»“æœ
          if ! sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR/$SNAPSHOT_NAME" --config "$RCLONE_CONFIG" >/dev/null; then
            echo -e "\033[1;31mâŒ å¤‡ä»½ä¸Šä¼ æœªéªŒè¯æˆåŠŸ\033[0m"
            exit 1
          fi
          
          sudo rm -f /tmp/$SNAPSHOT_NAME
          echo -e "\033[1;32mâœ… å¤‡ä»½ä¸Šä¼ å®Œæˆ\033[0m"


      # ====================================== Step 13ï¼šæ¸…ç†æ—§å¤‡ä»½ ======================================
      - name: 13-æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€æ–°$KEEP_BACKUPSä»½ï¼‰
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 13-æ¸…ç†æ—§å¤‡ä»½ =====\033[0m"
          
          # 1. è·å–æ—§å¤‡ä»½åˆ—è¡¨
          OLD_SNAPSHOTS=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config "$RCLONE_CONFIG" \
            | grep "casaos-full-snapshot.*\.tar\.zst$" \
            | sed 's/^[0-9]\+ //' \
            | sort -r \
            | tail -n +$((KEEP_BACKUPS + 1)))
          
          # 2. æ¸…ç†æ—§å¤‡ä»½
          if [ -n "$OLD_SNAPSHOTS" ]; then
            echo -e "\033[1;33mğŸ—‘ï¸ æ¸…ç†æ—§å¤‡ä»½ï¼š\n$OLD_SNAPSHOTS\033[0m"
            for snap in $OLD_SNAPSHOTS; do
              sudo rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$snap" --config "$RCLONE_CONFIG" || echo -e "âš ï¸ æ¸…ç†$snapå¤±è´¥"
            done
          else
            echo -e "\033[1;33mâœ… æ— éœ€æ¸…ç†ï¼ˆå¤‡ä»½æ•°â‰¤$KEEP_BACKUPSï¼‰\033[0m"
          fi
          
          echo -e "\033[1;32mâœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆ\033[0m"


      # ====================================== Step 14ï¼šè‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½ ======================================
      - name: 14-è‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 14-è‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®å¤‡ä»½ =====\033[0m"
          
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
            echo -e "\033[1;33mâš ï¸ æœªé…ç½®PAT/REPOï¼Œè·³è¿‡è§¦å‘\033[0m"
            exit 0
          fi
          
          # è§¦å‘repository dispatch
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: token $USER_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"renew_casaos_snapshot"}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" -eq 204 ]; then
            echo -e "\033[1;32mâœ… ä¸‹ä¸€è½®å¤‡ä»½å·²è§¦å‘\033[0m"
          else
            echo -e "\033[1;31mâŒ è§¦å‘å¤±è´¥ï¼ŒHTTPç ï¼š$HTTP_CODEï¼Œå“åº”ï¼š$RESPONSE\033[0m"
            exit 1
          fi


      # ====================================== Step 15ï¼šæœ€ç»ˆæ¸…ç† ======================================
      - name: 15-æœ€ç»ˆæ¸…ç†
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo -e "\033[1;34m===== 15-æœ€ç»ˆæ¸…ç† =====\033[0m"
          
          # 1. é€€å‡ºTailscale
          sudo tailscale down 2>/dev/null || true
          sudo systemctl stop tailscaled 2>/dev/null || true
          
          # 2. æ¸…ç†æ•æ„Ÿæ–‡ä»¶
          sudo rm -rf /tmp/casaos-full-snapshot-* "$RCLONE_CONFIG" /etc/sudoers.d/roots 2>/dev/null || true
          sudo chmod 0644 /etc/sudoers.d/* 2>/dev/null || true
          
          echo -e "\033[1;32mâœ… æ‰€æœ‰æ¸…ç†å®Œæˆ\033[0m"
          echo -e "\033[1;32mğŸ‰ å¤‡ä»½å…¨æµç¨‹å®Œæˆï¼ˆèŠ‚ç‚¹IPï¼š${{ env.TAILSCALE_IP }}ï¼‰\033[0m"