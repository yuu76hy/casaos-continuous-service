name: CasaOS-Server-Snapshot-Backup-Restore

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      WEBDAV_SNAPSHOT_EN_DIR: "object-storage/ubuntu"
      CORE_DIRS: "/var/lib /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp --exclude=$WEBDAV_MOUNT_POINT
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: Env Init & Fix Mount Permission
        run: |
          set -e
          # å®‰è£…ä¾èµ–
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          # å®‰è£…rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # ========== æ ¸å¿ƒä¿®å¤1ï¼šé…ç½®FUSEæƒé™ + æŒ‚è½½ç‚¹æƒé™ ==========
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo chmod 644 /etc/fuse.conf  # ç¡®ä¿fuseé…ç½®å¯è¯»å–
          
          # ä¿®å¤sudoersé…ç½®
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          
          # åˆ›å»ºæ•°æ®ç›®å½•
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          
          # ========== å…³é”®ï¼šä¿®å¤æŒ‚è½½ç‚¹æƒé™ ==========
          # 1. åˆ›å»ºæŒ‚è½½ç‚¹å¹¶è®¾ç½®runnerç”¨æˆ·ä¸ºæ‰€æœ‰è€…
          mkdir -p "$WEBDAV_MOUNT_POINT"
          sudo chown -R runner:runner "$WEBDAV_MOUNT_POINT"
          sudo chmod -R 775 "$WEBDAV_MOUNT_POINT"  # ç¡®ä¿å¯è¯»å†™æ‰§è¡Œ
          
          # 2. åˆ›å»ºå¿«ç…§å­ç›®å½•ï¼ˆè‹±æ–‡ï¼‰å¹¶è®¾ç½®æƒé™
          WEBDAV_SNAPSHOT_DIR="${WEBDAV_MOUNT_POINT}/${WEBDAV_SNAPSHOT_EN_DIR}"
          mkdir -p "$WEBDAV_SNAPSHOT_DIR"
          sudo chown -R runner:runner "$WEBDAV_SNAPSHOT_DIR"
          sudo chmod -R 775 "$WEBDAV_SNAPSHOT_DIR"
          
          echo "âœ… Env init done, mount point permission fixed: $WEBDAV_SNAPSHOT_DIR"
          echo "WEBDAV_SNAPSHOT_DIR=$WEBDAV_SNAPSHOT_DIR" >> "$GITHUB_ENV"

      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            [ -n "$ROOTS_PASSWORD" ] && echo "roots:$ROOTS_PASSWORD" | sudo chpasswd || {
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots password: $RANDOM_PASS"
            }
            sudo usermod -aG sudo roots
          fi

      - name: Mount WebDAV (Fix Permission & Simplify Config)
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8

          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets missing"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # ========== æ ¸å¿ƒä¿®å¤2ï¼šç®€åŒ–rcloneé…ç½®ï¼ˆé¿å…å…¼å®¹é—®é¢˜ï¼‰ ==========
          # ç”Ÿæˆrcloneé…ç½®ï¼ˆä¸æŒ‡å®švendorï¼Œé€šç”¨é€‚é…æ‰€æœ‰WebDAVï¼‰
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          cat > /home/runner/.rclone.conf << EOF
[mywebdav]
type = webdav
url = $WEBDAV_URL
user = $WEBDAV_USER
pass = $ENCRYPTED_PASS
EOF
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf  # å®‰å…¨æƒé™

          # ========== æ ¸å¿ƒä¿®å¤3ï¼šæŒ‚è½½å‘½ä»¤æ·»åŠ UID/GIDï¼Œå¼ºåˆ¶runneræƒé™ ==========
          # å…ˆå¸è½½å¯èƒ½æ®‹ç•™çš„æŒ‚è½½
          fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
          
          # æŒ‚è½½WebDAVï¼ˆæŒ‡å®šrunnerç”¨æˆ·IDï¼Œè§£å†³å†™å…¥æƒé™ï¼‰
          nohup sudo -u runner rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" \
            --config /home/runner/.rclone.conf \
            --uid $(id -u runner) \
            --gid $(id -g runner) \
            --vfs-cache-mode writes \
            --vfs-write-back 0s \
            --transfers 4 \
            --daemon-timeout 1h \
            --allow-other \
            --allow-non-empty \
            --no-modtime \
            --log-level INFO \
            --log-file /tmp/rclone_mount.log >/dev/null 2>&1 &
          
          # æ£€æŸ¥æŒ‚è½½çŠ¶æ€ï¼ˆé‡è¯•5æ¬¡ï¼Œæ¯æ¬¡ç­‰å¾…5ç§’ï¼‰
          for i in $(seq 1 5); do
            # éªŒè¯æŒ‚è½½ç‚¹å¯è¯»å†™
            if touch "$WEBDAV_MOUNT_POINT/.test-mount" 2>/dev/null; then
              rm -f "$WEBDAV_MOUNT_POINT/.test-mount"
              echo "âœ… WebDAV mounted successfully (permission: runner)"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              
              # æ£€æµ‹å†å²å¿«ç…§
              if ls "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "âœ… Found latest snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ No historical snapshot in $WEBDAV_SNAPSHOT_DIR"
              fi
              exit 0
            fi
            echo "âš ï¸ Mount attempt $i failed, retrying..."
            sleep 5
          done
          
          # æŒ‚è½½å¤±è´¥ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—
          echo "âŒ WebDAV mount failed after 5 attempts"
          cat /tmp/rclone_mount.log || echo "âš ï¸ No mount log file"
          # æ£€æŸ¥æŒ‚è½½ç‚¹æƒé™è¯¦æƒ…
          ls -ld "$WEBDAV_MOUNT_POINT"
          id runner
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      - name: Restore Snapshot & Cleanup
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== Restore from: $LATEST_SNAPSHOT ====="
          sudo systemctl stop docker.service docker.socket casaos.service
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3
          sudo tar -xzf "$LATEST_SNAPSHOT" -C / --overwrite --ignore-failed-read --warning=no-all $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "âœ… Restore success"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            sudo rm -f "$LATEST_SNAPSHOT" "$WEBDAV_SNAPSHOT_DIR/snapshot_meta.txt"
            sudo systemctl unmask docker.socket
          else
            echo "âŒ Restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
          fi

      - name: Install CasaOS If No Snapshot
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed"

      - name: Start Services
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket casaos.service
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Services started"
              exit 0
            fi
            echo "âš ï¸ Start attempt $i failed"
          done
          echo "âŒ Service start failed"
          exit 1

      - name: Create Snapshot & Sync (Fix All Permission)
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘å‡½æ•°
          trigger_renew() {
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && return 1
            curl -fsS -X POST -H "Authorization: token $USER_PAT" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/$REPO/dispatches" -d '{"event_type":"renew_casaos_snapshot"}'
            [ $? -eq 0 ] && echo "âœ… Renew triggered" && RENEW_TRIGGERED=true
          }

          # å¿«ç…§åˆ›å»º+åŒæ­¥å‡½æ•°
          create_snapshot() {
            [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1
            
            # ç”Ÿæˆå¿«ç…§æ–‡ä»¶å
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            WEBDAV_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ Creating snapshot: $SNAPSHOT_NAME (dir: $WEBDAV_SNAPSHOT_DIR)"

            # å½»åº•åœæ­¢Docker/CasaOS
            sudo systemctl stop docker.service docker.socket casaos.service
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5

            # æ‰“åŒ…å¿«ç…§
            sudo tar -czf "${TMP_SNAPSHOT}" --absolute-names --ignore-failed-read --warning=no-all $EXCLUDE_RULES $CORE_DIRS
            if [ ! -f "${TMP_SNAPSHOT}" ]; then
              echo "âŒ Snapshot file not found: $TMP_SNAPSHOT"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi
            echo "âœ… Snapshot created: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            # ========== æ ¸å¿ƒä¿®å¤4ï¼šåŒæ­¥å‰éªŒè¯æŒ‚è½½ç‚¹æƒé™ ==========
            # éªŒè¯å¿«ç…§ç›®å½•å¯å†™
            if ! touch "$WEBDAV_SNAPSHOT_DIR/.test-write" 2>/dev/null; then
              echo "âŒ WebDAV dir read-only: $WEBDAV_SNAPSHOT_DIR"
              echo "Permission detail: $(ls -ld "$WEBDAV_SNAPSHOT_DIR")"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi
            rm -f "$WEBDAV_SNAPSHOT_DIR/.test-write"

            # å¤åˆ¶å¿«ç…§åˆ°æŒ‚è½½ç›®å½•ï¼ˆç”¨runneræƒé™ï¼‰
            sudo -u runner cp "${TMP_SNAPSHOT}" "${WEBDAV_SNAPSHOT}"
            if [ $? -eq 0 ]; then
              echo "âœ… Copied to mount dir with runner permission"
              
              # ========== æ ¸å¿ƒä¿®å¤5ï¼šä¸ç”¨syncï¼Œç›´æ¥ç”¨copyï¼ˆæ›´ç¨³å®šï¼‰ ==========
              # ç›´æ¥å¤åˆ¶åˆ°WebDAVæœåŠ¡ç«¯ï¼ˆé¿å…mountåŒæ­¥å»¶è¿Ÿï¼‰
              sudo -u runner rclone copy "${WEBDAV_SNAPSHOT}" "mywebdav:/${WEBDAV_SNAPSHOT_EN_DIR}/" \
                --config /home/runner/.rclone.conf \
                --transfers 4 \
                --log-level INFO \
                --log-file /tmp/rclone_copy.log
              
              if [ $? -eq 0 ]; then
                echo "âœ… Snapshot copied to WebDAV server: mywebdav:/${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
                # å†™å…¥å…ƒä¿¡æ¯
                echo "snapshot_name=${SNAPSHOT_NAME}" | sudo -u runner tee "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" | sudo -u runner tee -a "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                # åŒæ­¥å…ƒä¿¡æ¯
                sudo -u runner rclone copy "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" "mywebdav:/${WEBDAV_SNAPSHOT_EN_DIR}/" --config /home/runner/.rclone.conf
              else
                echo "âŒ Rclone copy failed, log:"
                cat /tmp/rclone_copy.log || echo "âš ï¸ No copy log"
                sudo systemctl unmask docker.socket
                sudo systemctl start docker.service docker.socket casaos.service
                return 1
              fi
            else
              echo "âŒ Copy to mount dir failed"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi

            # æ¢å¤æœåŠ¡+æ¸…ç†æ—§å¿«ç…§
            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket casaos.service
            # æ¸…ç†7å¤©å‰æ—§å¿«ç…§ï¼ˆrunneræƒé™ï¼‰
            sudo -u runner find "$WEBDAV_SNAPSHOT_DIR" -name "casaos-server-snapshot-*.tar.gz" -mtime +7 -delete && echo "âœ… Old snapshots cleaned" || echo "âš ï¸ No old snapshots"
            return 0
          }

          # ä¿æ´»å¾ªç¯
          while true; do
            run_mins=$(( ($(date +%s) - start_time) / 60 ))
            echo "ğŸ“Š Running for $run_mins minutes"
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Time to create snapshot"
              create_snapshot && trigger_renew
            fi
            [ $run_mins -ge $MAX_RUN_MINUTES ] && echo "â¹ï¸ Timeout" && exit 0
            sleep 60
          done

      - name: Cleanup
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # å¸è½½æŒ‚è½½
          fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null
          # æ¸…ç†æ–‡ä»¶
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          # æ¢å¤æƒé™
          sudo systemctl unmask docker.socket || true
          echo "âœ… Cleanup done"
