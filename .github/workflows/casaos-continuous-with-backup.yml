name: CasaOS-å…¨é‡å¤‡ä»½æ¢å¤ï¼ˆå…ˆè£…åè¦† é«˜æˆåŠŸç‡ç‰ˆï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # è‡ªåŠ¨ç»­è·‘è§¦å‘
  # schedule:
  #   - cron: '0 2 * * *'  # å®šæ—¶å¤‡ä»½å–æ¶ˆæ³¨é‡Šå¯ç”¨

jobs:
  casaos-full-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      # å¤‡ä»½ç›®å½•ä¸å˜ï¼Œæ¢å¤æ—¶åªå–æ•°æ®ç›®å½•ï¼Œç¨‹åºæ–‡ä»¶é å…¨æ–°å®‰è£…
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /usr/lib/systemd/system/docker.service /etc/systemd/system/docker.service.d /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/lib/systemd/system/casaos.service /etc/systemd/system/casaos.service /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=/var/lib/docker/volumes/*/_data/tmp
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–&æ ¸å¿ƒä¾èµ–å®‰è£…
        run: |
          set -e
          echo "===== ç³»ç»Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq --no-install-recommends
          sudo apt install -y curl wget jq fuse3 tar gzip bzip2 locales openssl ca-certificates apt-transport-https sshpass net-tools iputils-ping lsof -qq
          sudo locale-gen zh_CN.UTF-8 && sudo update-locale LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          
          # å®‰è£…Rclone
          if ! command -v rclone &>/dev/null; then
            INSTALL_RETRY=3
            until curl -fsSL https://rclone.org/install.sh | sudo bash; do
              INSTALL_RETRY=$((INSTALL_RETRY-1))
              [ $INSTALL_RETRY -eq 0 ] && { RCLONE_VER=$(curl -s https://api.github.com/repos/rclone/rclone/releases/latest | jq -r .tag_name | sed 's/v//'); wget -q https://downloads.rclone.org/v${RCLONE_VER}/rclone-v${RCLONE_VER}-linux-amd64.deb -O /tmp/rclone.deb; sudo dpkg -i /tmp/rclone.deb; sudo apt install -f -y; break; }
              sleep 3
            done
          fi
          
          # å®‰è£…Docker
          if ! command -v docker &>/dev/null; then
            sudo apt install -y docker.io docker-compose-plugin -qq
            sudo systemctl enable --now docker && sudo usermod -aG docker runner
          fi
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä¾èµ–å…¨éƒ¨å°±ç»ª"

      - name: 2-åˆ›å»ºæ ¹æƒé™ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå…å¯†sudoï¼‰
        run: |
          set -e
          echo "===== é…ç½®æ ¹æƒé™ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd || { RANDOM_PASS=$(openssl rand -base64 12); echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd; echo "âœ… éšæœºå¯†ç ï¼š$RANDOM_PASS"; }
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME" && sudo chown -R "$USER_NAME:$USER_NAME" /home/"$USER_NAME"
          echo "âœ… æ ¹æƒé™ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 3-Rcloneé…ç½®+WebDAVè¿é€šæ ¡éªŒï¼ˆé€‚é…/z/Uduï¼‰
        run: |
          set -e
          echo "===== WebDAVé…ç½®ä¸æ ¡éªŒ ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œç¦ç”¨å¤‡ä»½æ¢å¤" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
          fi
          if ! echo "$WEBDAV_URL" | grep -qE "^http://|^https://"; then
            echo "âŒ WebDAVåœ°å€ç¼ºå¤±http/httpså‰ç¼€" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
          fi
          
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="webdav" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          
          echo "ğŸ” æ ¡éªŒ/z/Uduç›®å½•æƒé™..."
          rclone mkdir mywebdav:/z/Udu --config /home/runner/.rclone.conf 2>/dev/null || true
          if ! timeout 30 rclone ls mywebdav:/z/Udu --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ /z/Uduç›®å½•æ— è®¿é—®æƒé™" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
          fi
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null || true
          
          echo "ğŸ” æŸ¥æ‰¾æœ€æ–°å¤‡ä»½å¿«ç…§..."
          REMOTE_FILES=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf 2>/dev/null)
          if [ -n "$REMOTE_FILES" ]; then
            REMOTE_SNAPSHOTS=$(echo "$REMOTE_FILES" | grep -E "casaos-full-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz" | sed -E 's/^[0-9]+[[:space:]]+//' | xargs -n1 basename | sort -r | uniq)
            LATEST_SNAPSHOT=$(echo "$REMOTE_SNAPSHOTS" | head -n1 | xargs)
            [ $(echo "$LATEST_SNAPSHOT" | grep -c "/") -gt 0 ] && LATEST_SNAPSHOT=$(basename "$LATEST_SNAPSHOT")
            echo "âœ… æœ€æ–°å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
            echo "FULL_SNAPSHOT_PATH=${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æ— å†å²å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "âœ… WebDAVé…ç½®å®Œæˆï¼Œå¯æ­£å¸¸å¤‡ä»½/æ¢å¤"

      - name: 4-å…ˆæ¢å¤æ ¸å¿ƒæ•°æ®ï¼ˆä»…æ•°æ®ç›®å½•ï¼Œä¸è¦†ç¨‹åº/serviceï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== æ¢å¤æ ¸å¿ƒæ•°æ®ï¼ˆä¸è¦†ç›–ç¨‹åºæ–‡ä»¶ï¼‰====="
          CLEAN_FULL_PATH="${{ env.WEBDAV_SNAPSHOT_DIR }}/$(basename ${{ env.LATEST_SNAPSHOT }})"
          echo "ğŸ” æ¢å¤è·¯å¾„ï¼š${CLEAN_FULL_PATH}"
          
          # åœæ­¢ç›¸å…³æœåŠ¡ï¼Œæ¸…ç†æ®‹ç•™
          sudo systemctl stop docker docker.socket casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 3
          
          # æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
          if ! timeout 60 rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æŸåæˆ–è·¯å¾„é”™è¯¯" && echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV" && exit 1
          fi
          
          # å…³é”®ï¼šåªæ¢å¤æ•°æ®ç›®å½•ï¼Œè·³è¿‡ç¨‹åºå’Œserviceæ–‡ä»¶ï¼Œé¿å…æ±¡æŸ“
          sudo mkdir -p /var/lib/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          rclone cat mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --preserve-permissions \
            /var/lib/docker \
            /etc/casaos \
            /var/lib/casaos \
            /DATA \
            /etc/docker
          echo "âœ… æ ¸å¿ƒæ•°æ®æ¢å¤å®Œæˆï¼ˆDockeræ•°æ®+CasaOSé…ç½®+DATAï¼‰"
          
          # åˆ é™¤å·²æ¢å¤å¿«ç…§ï¼Œé¿å…é‡å¤æ¢å¤
          rclone delete mywebdav:${CLEAN_FULL_PATH} --config /home/runner/.rclone.conf 2>/dev/null || true
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/backup-meta.txt --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼Œç­‰å¾…å®‰è£…çº¯å‡€CasaOS"

      - name: 5-å…¨æ–°å®‰è£…çº¯å‡€CasaOSï¼ˆå…³é”®æ­¥éª¤ï¼Œä¿è¯ç¨‹åºå®Œæ•´æ€§ï¼‰
        run: |
          set -e
          echo "===== å…¨æ–°å®‰è£…çº¯å‡€CasaOS ====="
          # å…ˆå¯åŠ¨Dockerï¼Œå®‰è£…ä¾èµ–
          sudo systemctl enable --now docker && sleep 3
          if ! sudo systemctl is-active --quiet docker; then
            sudo systemctl restart docker && sleep 3
          fi
          [ ! $(sudo systemctl is-active --quiet docker) ] && echo "âŒ Dockerå¯åŠ¨å¤±è´¥" && exit 1
          
          # å¸è½½æ®‹ç•™æ—§ç‰ˆæœ¬ï¼Œç¡®ä¿çº¯å‡€
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          
          # å…¨æ–°å®‰è£…CasaOSï¼Œæ‹¿åˆ°å¹²å‡€ç¨‹åº+æ ‡å‡†serviceé…ç½®
          INSTALL_RETRY=3
          until curl -fsSL https://get.casaos.io | sudo bash; do
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            [ $INSTALL_RETRY -eq 0 ] && { echo "âŒ CasaOSå®‰è£…å¤±è´¥"; cat /var/log/casaos-install.log 2>/dev/null; exit 1; }
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œå‰©ä½™${INSTALL_RETRY}æ¬¡é‡è¯•" && sleep 10
          done
          # å®‰è£…åå…ˆåœæ­¢ï¼Œç­‰å¾…è¦†ç›–æ•°æ®
          sudo systemctl stop casaos && sudo systemctl daemon-reload
          echo "âœ… çº¯å‡€CasaOSå®‰è£…å®Œæˆï¼Œç­‰å¾…è¦†ç›–æ•°æ®"
          [ ${{ env.SNAPSHOT_RESTORED }} ] && echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV" || echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"

      - name: 6-æ•°æ®è¦†ç›–+æƒé™æ ¡æ­£+å…œåº•å¯åŠ¨ï¼ˆæ ¸å¿ƒè¡”æ¥æ­¥éª¤ï¼‰
        run: |
          set -e
          echo "===== æ•°æ®è¦†ç›–+æƒé™æ ¡æ­£+æœåŠ¡å¯åŠ¨ ====="
          sudo systemctl daemon-reload
          
          # 1 Dockerå…œåº•å¯åŠ¨
          DOCKER_RETRY=5
          while [ $DOCKER_RETRY -gt 0 ]; do
            sudo systemctl start docker docker.socket
            sleep 5
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… Dockerå¯åŠ¨æˆåŠŸ"
              break
            fi
            DOCKER_RETRY=$((DOCKER_RETRY-1))
            sudo systemctl reset-failed docker && sleep 3
          done
          [ $DOCKER_RETRY -eq 0 ] && { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          
          # 2 å¼ºåˆ¶æƒé™æ ¡æ­£ï¼ˆå…ˆè£…åè¦†æ ¸å¿ƒä¿éšœï¼‰
          echo "ğŸ”§ å…¨æƒæ ¡æ­£æ‰€æœ‰ç›®å½•æƒé™"
          sudo mkdir -p /etc/casaos /var/lib/casaos /var/lib/casaos/appstore /DATA 2>/dev/null || true
          sudo chown -R root:root /etc/casaos /var/lib/casaos /DATA /var/lib/docker
          sudo chmod -R 755 /etc/casaos /DATA
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          sudo chmod 755 /usr/bin/casaos
          sudo chmod 644 /etc/systemd/system/casaos.service
          sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock
          sudo usermod -aG docker root 2>/dev/null || true
          echo "âœ… æƒé™æ ¡æ­£å®Œæˆï¼Œæ— è®¿é—®ç“¶é¢ˆ"
          
          # 3 é‡Šæ”¾80/443é»˜è®¤ç«¯å£
          echo "ğŸ”§ é‡Šæ”¾CasaOSé»˜è®¤ç«¯å£"
          sudo lsof -t -i:80 | xargs sudo kill -9 2>/dev/null || true
          sudo lsof -t -i:443 | xargs sudo kill -9 2>/dev/null || true
          sleep 2 && sudo docker network create casaos 2>/dev/null || true
          echo "âœ… ç«¯å£é‡Šæ”¾+ç½‘ç»œåˆ›å»ºå®Œæˆ"
          
          # 4 CasaOSå…œåº•å¯åŠ¨ï¼ˆå¤šé‡è¯•+æ—¥å¿—æ’æŸ¥ï¼‰
          CASAOS_RETRY=5
          CASAOS_STARTED=false
          while [ $CASAOS_RETRY -gt 0 ]; do
            sudo systemctl start casaos
            sleep 5
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… CasaOSå¯åŠ¨æˆåŠŸï¼å…ˆè£…åè¦†æ–¹æ¡ˆç”Ÿæ•ˆ"
              CASAOS_STARTED=true
              break
            fi
            echo "âš ï¸ å¯åŠ¨å¤±è´¥ï¼Œå‰©ä½™é‡è¯•$((CASAOS_RETRY-1))æ¬¡ï¼Œé”™è¯¯æ—¥å¿—ï¼š"
            sudo systemctl status casaos.service -l | head -20
            sudo journalctl -xeu casaos.service --no-pager | head -25
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            sudo systemctl reset-failed casaos && sleep 3
          done
          
          # ç»ˆæå…œåº•ï¼šä»å¤±è´¥åˆ™é‡è£…è¡¥é…ç½®
          if [ "$CASAOS_STARTED" = "false" ]; then
            echo "âŒ å¯åŠ¨å¤±è´¥ï¼Œæ‰§è¡Œå…œåº•é‡è£…"
            curl -fsSL https://get.casaos.io | sudo bash -s -- --force-reinstall
            sudo systemctl daemon-reload && sudo systemctl start casaos && sleep 5
            if sudo systemctl is-active --quiet casaos; then
              echo "âœ… å…œåº•é‡è£…åå¯åŠ¨æˆåŠŸ"
              CASAOS_STARTED=true
            else
              echo "âŒ æœ€ç»ˆå¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
              sudo systemctl status casaos.service -l
              exit 1
            fi
          fi
          
          # æœ€ç»ˆçŠ¶æ€è¾“å‡º
          echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€ï¼š"
          sudo systemctl status docker --no-pager 2>/dev/null || true
          sudo systemctl status casaos --no-pager 2>/dev/null || true
          echo "âœ… å…ˆè£…åè¦†å…¨æµç¨‹å®Œæˆï¼ŒCasaOSæ­£å¸¸è¿è¡Œ"

      - name: 7-Tailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          echo "===== Tailscaleç»„ç½‘é…ç½® ====="
          [ -z "$TAILSCALE_AUTH_KEY" ] && echo "âš ï¸ æœªé…ç½®å¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘" && exit 0
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq --upgrade
          sudo systemctl restart tailscaled && sudo systemctl enable tailscaled && sleep 5
          TS_HOSTNAME="CasaOS-Server-$(hostname | cut -c1-8)"
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME"
          TS_IP=$(sudo tailscale ip -4 2>/dev/null)
          [ -n "$TS_IP" ] && echo "âœ… ç»„ç½‘æˆåŠŸï¼ŒIPv4ï¼š$TS_IP" || echo "âš ï¸ ç»„ç½‘å®Œæˆæœªè·å–IP"

      - name: 8-å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ï¼ˆå¤‡ä»½å®Œæ•´æ•°æ®ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          echo "===== å…¨é‡å¤‡ä»½+è‡ªåŠ¨ç»­è·‘ ====="
          
          trigger_workflow_renew() {
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && { echo "âš ï¸ ç»­è·‘é…ç½®ç¼ºå¤±"; return 1; }
            curl -fsSL --fail --connect-timeout 30 -X POST -H "Authorization: token $USER_PAT" -H "Accept: application/vnd.github.v3+json" -H "Content-Type: application/json" "https://api.github.com/repos/$REPO/dispatches" -d '{"event_type":"renew_casaos_snapshot"}' || { echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥"; return 1; }
            echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ" && RENEW_TRIGGERED=true && return 0
          }
          
          full_backup_and_upload() {
            echo "ğŸ” æ£€æŸ¥å¤‡ä»½è·¯å¾„..."
            VALID_BACKUP_DIRS=""
            for path in $CORE_BACKUP_DIRS; do [ -e "$path" ] && VALID_BACKUP_DIRS="$VALID_BACKUP_DIRS $path"; done
            [ -z "$VALID_BACKUP_DIRS" ] && { echo "âŒ æ— æœ‰æ•ˆè·¯å¾„"; return 1; }
            
            BACKUP_TMP_DIR="/home/runner/casaos-backup-tmp"
            sudo rm -rf "$BACKUP_TMP_DIR" && sudo mkdir -p "$BACKUP_TMP_DIR" && sudo chown runner:runner "$BACKUP_TMP_DIR"
            FREE_SPACE_GB=$(( $(df -k "$BACKUP_TMP_DIR" | awk 'NR==2{print $4}') /1024/1024 ))
            [ $FREE_SPACE_GB -lt 5 ] && { echo "âŒ ç©ºé—´ä¸è¶³5GB"; sudo rm -rf "$BACKUP_TMP_DIR"; return 1; }
            
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            LOCAL_SNAPSHOT="$BACKUP_TMP_DIR/$SNAPSHOT_NAME"
            echo "ğŸ”„ å…¨é‡æ‰“åŒ…ä¸­..."
            sudo tar -czPf "$LOCAL_SNAPSHOT" --ignore-failed-read --preserve-permissions --dereference $EXCLUDE_RULES $VALID_BACKUP_DIRS > "$BACKUP_TMP_DIR/tar_log.txt" 2>&1
            
            [ ! -s "$LOCAL_SNAPSHOT" ] && { echo "âŒ æ‰“åŒ…å¤±è´¥"; cat "$BACKUP_TMP_DIR/tar_log.txt"; sudo rm -rf "$BACKUP_TMP_DIR"; return 1; }
            SNAPSHOT_SIZE=$(du -sh "$LOCAL_SNAPSHOT" | awk '{print $1}')
            echo "âœ… æ‰“åŒ…å®Œæˆï¼Œå¤§å°ï¼š$SNAPSHOT_SIZE"
            
            sudo systemctl stop docker docker.socket casaos 2>/dev/null || true && sync && sleep 2
            echo "ğŸ“¤ ä¸Šä¼ åˆ°WebDAV..."
            rclone copy "$LOCAL_SNAPSHOT" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}" --config /home/runner/.rclone.conf --transfers 4 --fast-list --progress
            [ $? -ne 0 ] && { echo "âŒ ä¸Šä¼ å¤±è´¥"; sudo rm -rf "$BACKUP_TMP_DIR"; return 1; }
            
            echo "snapshot_name=$SNAPSHOT_NAME" > "$BACKUP_TMP_DIR/backup-meta.txt" && echo "backup_time=$(date '+%Y-%m-%d %H:%M:%S')" >> "$_" && echo "backup_size=$SNAPSHOT_SIZE" >> "$_"
            rclone copy "$BACKUP_TMP_DIR/backup-meta.txt" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/" --config /home/runner/.rclone.conf 2>/dev/null || true
            sudo rm -rf "$BACKUP_TMP_DIR"
            sudo systemctl start docker docker.socket casaos 2>/dev/null || true && sleep 3
            echo "âœ… å¤‡ä»½å®Œæˆï¼ŒæœåŠ¡æ¢å¤è¿è¡Œ" && return 0
          }
          
          while true; do
            run_mins=$(( (date +%s - start_time)/60 ))
            echo "ğŸ“Š å·²è¿è¡Œ${run_mins}åˆ†é’Ÿ"
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è§¦å‘å…¨é‡å¤‡ä»½"
              full_backup_and_upload && trigger_workflow_renew || { echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œ30åˆ†é’Ÿåé‡è¯•"; sleep 1800; }
            fi
            [ $run_mins -ge $MAX_RUN_MINUTES ] && { echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´é€€å‡º"; exit 0; }
            sleep 60
          done

      - name: 9-æ”¶å°¾æ¸…ç†ï¼ˆå¿…æ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç† ====="
          sudo systemctl unmask docker.socket casaos 2>/dev/null || true
          sudo rm -rf /home/runner/casaos-backup-tmp /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… æ¸…ç†å®Œæˆï¼Œæ— æ®‹ç•™"
          echo "ğŸ‰ å…ˆè£…åè¦†å…¨æµç¨‹æ‰§è¡Œå®Œæˆ"
