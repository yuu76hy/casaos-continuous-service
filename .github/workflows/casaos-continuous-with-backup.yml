name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_GITHUB_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      CURRENT_WORKFLOW_NAME: "CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰"

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæç®€ç‰ˆï¼‰
        run: |
          set -e
          echo "===== ç³»ç»Ÿå¿«é€Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: 2-å…³é—­å…¶ä»–è¿è¡Œä¸­çš„å·¥ä½œæµ
        run: |
          set -e
          echo "===== å…³é—­å…¶ä»–è¿è¡Œä¸­çš„å·¥ä½œæµ ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
            echo "âš ï¸ ç¼ºå°‘USER_GITHUB_PATæˆ–REPOé…ç½®ï¼Œè·³è¿‡å…³é—­å…¶ä»–å·¥ä½œæµ"
            exit 0
          fi

          # è·å–å½“å‰å·¥ä½œæµçš„run ID
          CURRENT_RUN_ID="${{ github.run_id }}"

          # è·å–æ‰€æœ‰è¿è¡Œä¸­çš„å·¥ä½œæµ
          RUNNING_WORKFLOWS=$(curl -s -H "Authorization: token $USER_PAT" \
            "https://api.github.com/repos/$REPO/actions/runs?status=in_progress" | jq -r '.workflow_runs[] | "\(.id) \(.name) \(.run_id)"')

          echo "ğŸ“Œ å½“å‰è¿è¡Œä¸­çš„å·¥ä½œæµï¼š"
          echo "$RUNNING_WORKFLOWS"

          # éå†å¹¶å…³é—­å…¶ä»–å·¥ä½œæµ
          while read -r WORKFLOW_ID WORKFLOW_NAME RUN_ID; do
            if [ "$RUN_ID" != "$CURRENT_RUN_ID" ] && [ "$WORKFLOW_NAME" != "$CURRENT_WORKFLOW_NAME" ]; then
              echo "âš ï¸ å‘ç°å…¶ä»–è¿è¡Œä¸­çš„å·¥ä½œæµï¼š$WORKFLOW_NAME (Run ID: $RUN_ID)ï¼Œæ­£åœ¨å…³é—­..."
              curl -s -X POST -H "Authorization: token $USER_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/cancel"
              echo "âœ… å·²å…³é—­å·¥ä½œæµï¼š$WORKFLOW_NAME"
            fi
          done <<< "$RUNNING_WORKFLOWS"

          echo "âœ… å…¶ä»–è¿è¡Œä¸­çš„å·¥ä½œæµå·²å…¨éƒ¨å…³é—­ï¼Œä»…ä¿ç•™å½“å‰å·¥ä½œæµè¿è¡Œ"

      - name: 3-å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆå«composeï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      # ï¼ˆåç»­æ­¥éª¤ä¿æŒä¸å˜ï¼Œæ­¤å¤„çœç•¥ï¼‰
