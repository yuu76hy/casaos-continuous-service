name: Dockerå…¨é‡å¤‡ä»½-æ¢å¤ï¼ˆä¸€é”®å®‰è£…ç‰ˆï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_docker_snapshot]  # ç»­è·‘è§¦å‘

jobs:
  docker_full_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu"
      # å…¨é‡å¤‡ä»½ç›®å½•ï¼šè¦†ç›–Dockeræ‰€æœ‰ä¾èµ–/é…ç½®/æ•°æ®/å®¹å™¨
      CORE_BACKUP_DIRS: >-
        /var/lib/docker 
        /etc/docker 
        /var/lib/containerd 
        /etc/containerd 
        /usr/bin/docker* 
        /usr/lib/docker 
        /usr/libexec/docker 
        /etc/systemd/system/docker* 
        /etc/systemd/system/containerd* 
        /etc/default/docker 
        /etc/group 
        /etc/passwd 
        /etc/sudoers.d/runner 
        /DATA 
        /opt/dpanel 
        /var/run/docker.sock 
        /var/run/containerd
      # æœ€å°åŒ–æ’é™¤ï¼šä»…æ’é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œä¸é—æ¼å…³é”®æ•°æ®
      EXCLUDE_RULES: >-
        --exclude=*.tmp 
        --exclude=/var/lib/docker/tmp 
        --exclude=/var/lib/containerd/tmp 
        --exclude=/tmp/* 
        --exclude=/var/run/docker.sock.lock 
        --exclude=/var/run/containerd/containerd.sock.lock
      TARGET_DOCKER_VERSION: "29.1.5"  # ç›®æ ‡Dockerç‰ˆæœ¬
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      # dpanelå®¹å™¨å›ºåŒ–å¯åŠ¨å‘½ä»¤ï¼ˆå…œåº•é‡å»ºï¼‰
      DPANEL_START_CMD: >-
        docker run -d --name dpanel --restart always
        -p 80:80 -p 443:443
        -v /opt/dpanel/config:/etc/dpanel
        -v /opt/dpanel/data:/var/lib/dpanel
        -v /opt/dpanel/log:/var/log/dpanel
        -v /var/run/docker.sock:/var/run/docker.sock
        docker.io/dpanel/dpanel:latest

    steps:
      - name: 1. ç¯å¢ƒåˆå§‹åŒ–ï¼ˆä¸€é”®å®‰è£…Dockerï¼‰
        run: |
          set -e
          sudo mkdir -p /etc/systemd/system 2>/dev/null || true
          
          # é…ç½®Ubuntuå®˜æ–¹æºï¼ˆç¡®ä¿åŸºç¡€ä¾èµ–å¯ç”¨ï¼‰
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak 2>/dev/null || true
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb http://archive.ubuntu.com/ubuntu/ noble main universe
          deb http://archive.ubuntu.com/ubuntu/ noble-updates main universe
          deb http://archive.ubuntu.com/ubuntu/ noble-security main universe
          deb http://archive.ubuntu.com/ubuntu/ noble-backports main universe
          EOF
          
          # å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆDockerä¸€é”®è„šæœ¬å¯èƒ½éœ€è¦ï¼‰
          sudo apt update -y && sudo apt install -y \
            curl wget jq fuse3 tar gzip locales openssl dnsutils \
            apt-transport-https ca-certificates gnupg lsb-release file lsof \
            libseccomp2 apparmor iptables bridge-utils iproute2
          sudo locale-gen zh_CN.UTF-8 && export LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          
          # æ£€æµ‹Dockerç‰ˆæœ¬ï¼ŒæŒ‰éœ€å®‰è£…/é‡è£…
          echo "===== æ£€æµ‹Dockerç‰ˆæœ¬ ====="
          DOCKER_INSTALLED=false
          if command -v docker &>/dev/null; then
            INSTALLED_VERSION=$(docker -v | awk '{print $3}' | sed 's/,//g')
            if [ "$INSTALLED_VERSION" = "${{ env.TARGET_DOCKER_VERSION }}" ]; then
              echo "âœ… Docker $INSTALLED_VERSION å·²å®‰è£…ä¸”åŒ¹é…ï¼Œè·³è¿‡é‡è£…"
              DOCKER_INSTALLED=true
            else
              echo "âš ï¸ å·²å®‰è£…ç‰ˆæœ¬ $INSTALLED_VERSION ä¸åŒ¹é…ç›®æ ‡ç‰ˆæœ¬ ${{ env.TARGET_DOCKER_VERSION }}ï¼Œå°†é‡æ–°å®‰è£…"
              # å½»åº•å¸è½½æ—§Docker/mobyç›¸å…³åŒ…
              sudo apt purge -y docker* moby* containerd* runc* -y || true
              sudo rm -rf /var/lib/docker /etc/docker /var/lib/containerd /etc/containerd
            fi
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°Dockerï¼Œå°†é€šè¿‡ä¸€é”®è„šæœ¬å®‰è£…"
          fi
          
          # ğŸ”¥æ ¸å¿ƒä¿®æ”¹ï¼šç”¨Dockerå®˜æ–¹ä¸€é”®è„šæœ¬å®‰è£…ï¼ˆæ— éœ€æºé…ç½®ï¼‰
          if [ "$DOCKER_INSTALLED" = "false" ]; then
            echo "===== æ‰§è¡ŒDockerå®˜æ–¹ä¸€é”®å®‰è£…è„šæœ¬ ====="
            curl -fsSL https://get.docker.com | sudo bash
            sleep 5
            
            # æ ¡éªŒå®‰è£…ç‰ˆæœ¬ï¼ˆç¡®ä¿æ˜¯ç›®æ ‡ç‰ˆæœ¬ï¼‰
            INSTALLED_VERSION=$(docker -v | awk '{print $3}' | sed 's/,//g')
            if [ "$INSTALLED_VERSION" != "${{ env.TARGET_DOCKER_VERSION }}" ]; then
              echo "âš ï¸ ä¸€é”®å®‰è£…é»˜è®¤ç‰ˆæœ¬ $INSTALLED_VERSION ä¸åŒ¹é…ï¼Œå°è¯•å®‰è£…ç›®æ ‡ç‰ˆæœ¬"
              # æ‰‹åŠ¨å®‰è£…ç›®æ ‡ç‰ˆæœ¬ï¼ˆä¸€é”®è„šæœ¬å·²é…ç½®å¥½æºï¼Œç›´æ¥aptå®‰è£…ï¼‰
              sudo apt install -y \
                docker-ce=${{ env.TARGET_DOCKER_VERSION }} \
                docker-ce-cli=${{ env.TARGET_DOCKER_VERSION }} \
                containerd.io docker-buildx-plugin docker-compose-plugin runc
              # å†æ¬¡æ ¡éªŒ
              INSTALLED_VERSION=$(docker -v | awk '{print $3}' | sed 's/,//g')
              if [ "$INSTALLED_VERSION" != "${{ env.TARGET_DOCKER_VERSION }}" ]; then
                echo "âŒ Dockerç‰ˆæœ¬å®‰è£…å¤±è´¥ï¼Œå®é™…ï¼š$INSTALLED_VERSIONï¼Œç›®æ ‡ï¼š${{ env.TARGET_DOCKER_VERSION }}"
                exit 1
              fi
            fi
            echo "âœ… Docker ${{ env.TARGET_DOCKER_VERSION }} ä¸€é”®å®‰è£…å®Œæˆ"
          fi
          
          # å®‰è£…rclone+é…ç½®sudoå…å¯†
          curl -fsSL https://rclone.org/install.sh | sudo bash
          grep -q "requiretty" /etc/sudoers 2>/dev/null && sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner && sudo mkdir -p /DATA /opt/dpanel/{config,data,log} && sudo chmod -R 775 /DATA /opt/dpanel
          
          # æ ¡éªŒDockerä¾èµ–å’ŒæœåŠ¡çŠ¶æ€
          if ldd $(which docker) | grep -q "not found"; then
            echo "âŒ Dockerä¾èµ–ç¼ºå¤±ï¼š"
            ldd $(which docker) | grep "not found"
            exit 1
          fi
          sudo systemctl enable --now docker containerd
          sleep 5
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥"
            sudo systemctl status docker --no-pager
            exit 1
          fi
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºrootsç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            echo "roots:${ROOTS_PASSWORD:-$(openssl rand -base64 12)}" | sudo chpasswd
            sudo usermod -aG sudo,docker roots
            echo "âœ… rootsç”¨æˆ·åˆ›å»ºæˆåŠŸ"
          else
            echo "â„¹ï¸ rootsç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: 3. é…ç½®WebDAVï¼ˆRcloneï¼‰
        id: webdav-config
        run: |
          set -e
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ ç¼ºå°‘WebDAVå‡­è¯ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # é…ç½®rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="generic" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          # æµ‹è¯•è¿æ¥
          rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1 || { echo "âŒ WebDAVè¿æ¥å¤±è´¥"; echo "webdav_available=false" >> "$GITHUB_OUTPUT"; exit 0; }
          # è·å–æœ€æ–°å¿«ç…§
          WEBDAV_SNAPSHOT_DIR_CLEAN=$(echo "$WEBDAV_SNAPSHOT_DIR" | sed 's/\/$//')
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN} --config /home/runner/.rclone.conf | grep "docker-full-snapshot-.*.tar.gz" | awk -F '/' '{print $NF}' | sort -r | head -n1)
          [ -n "$LATEST_SNAPSHOT" ] && echo "latest_snapshot=${WEBDAV_SNAPSHOT_DIR_CLEAN}/${LATEST_SNAPSHOT}" >> "$GITHUB_OUTPUT" && echo "âœ… æœ€æ–°å¿«ç…§ï¼š$LATEST_SNAPSHOT"
          echo "webdav_available=true" >> "$GITHUB_OUTPUT"
          echo "WEBDAV_SNAPSHOT_DIR_CLEAN=${WEBDAV_SNAPSHOT_DIR_CLEAN}" >> "$GITHUB_ENV"

      - name: 4. å…¨é‡æ¢å¤Docker+dpanelï¼ˆæ— ç¼è¿ç§»ï¼‰
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' && steps.webdav-config.outputs.latest_snapshot != '' }}
        id: restore
        run: |
          set -e
          SNAPSHOT_PATH=${{ steps.webdav-config.outputs.latest_snapshot }}
          echo "===== å…¨é‡æ¢å¤å¿«ç…§ï¼š$SNAPSHOT_PATH ====="
          
          # åœæ­¢æœåŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo pkill -9 docker containerd runc 2>/dev/null || true
          sync && sleep 10
          
          # æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
          rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf | head -c 1024 >/dev/null 2>&1 || { echo "âŒ å¿«ç…§æŸå"; echo "restore_success=false" >> "$GITHUB_OUTPUT"; exit 1; }
          
          # å…¨é‡æ¢å¤æ•°æ®
          TEMP_SNAPSHOT="/tmp/snapshot.tar.gz"
          rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf > "$TEMP_SNAPSHOT"
          sudo tar -xzf "$TEMP_SNAPSHOT" -C / --overwrite --ignore-failed-read -p --same-owner --acls --xattrs
          rm -f "$TEMP_SNAPSHOT"
          
          # ä¿®å¤æƒé™+é‡å¯æœåŠ¡
          sudo chown -R root:root /var/lib/docker /etc/docker /var/lib/containerd /etc/containerd
          sudo chmod -R 755 /usr/bin/docker* /usr/lib/docker /usr/libexec/docker
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          sudo systemctl daemon-reload && sudo systemctl enable --now docker containerd 2>/dev/null || true
          sleep 15
          
          # æ ¡éªŒæœåŠ¡çŠ¶æ€
          if ! sudo systemctl is-active --quiet docker || ! sudo systemctl is-active --quiet containerd; then
            echo "âŒ Docker/containerdå¯åŠ¨å¤±è´¥"
            sudo systemctl status docker --no-pager && sudo journalctl -u docker --no-pager | tail -30
            echo "restore_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          # å…œåº•å¯åŠ¨dpanelå®¹å™¨
          if ! sudo docker ps | grep -q "dpanel"; then
            sudo docker start dpanel || { sudo docker rm -f dpanel; sudo bash -c "${{ env.DPANEL_START_CMD }}"; }
          fi
          [ ! "$(sudo docker ps | grep dpanel)" ] && { echo "âŒ dpanelå®¹å™¨å¯åŠ¨å¤±è´¥"; echo "restore_success=false" >> "$GITHUB_OUTPUT"; exit 1; }
          
          # åˆ é™¤æ—§å¿«ç…§
          rclone delete mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/snapshot_meta.txt --config /home/runner/.rclone.conf
          
          echo "âœ… å…¨é‡æ¢å¤æˆåŠŸï¼Œæ— ç¼è¡”æ¥å®Œæˆ"
          echo "restore_success=true" >> "$GITHUB_OUTPUT"

      - name: 5. æ¸…ç†æ®‹ç•™ç‰©ï¼ˆæ¢å¤å¤±è´¥ï¼‰
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo pkill -9 docker containerd 2>/dev/null || true
          sync && sleep 3
          [ "$(sudo docker info 2>/dev/null)" ] && { sudo docker rm -f $(sudo docker ps -aq); sudo docker rmi -f $(sudo docker images -aq); }
          sudo rm -rf /var/lib/docker /etc/docker /var/lib/containerd /etc/containerd /DATA/* /opt/dpanel/*
          echo "âœ… æ®‹ç•™ç‰©æ¸…ç†å®Œæˆ"

      - name: 6. å…¨æ–°éƒ¨ç½²Docker+dpanelï¼ˆæ— å¿«ç…§/æ¢å¤å¤±è´¥ï¼‰
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== å…¨æ–°éƒ¨ç½²Dockerï¼ˆä¸€é”®å®‰è£…ï¼‰ ====="
          # å…œåº•å®‰è£…Dockerï¼ˆè‹¥æ­¥éª¤1æœªå®‰è£…æˆåŠŸï¼‰
          if ! command -v docker &>/dev/null; then
            curl -fsSL https://get.docker.com | sudo bash
            sleep 5
            # ç¡®ä¿ç‰ˆæœ¬åŒ¹é…
            sudo apt install -y \
              docker-ce=${{ env.TARGET_DOCKER_VERSION }} \
              docker-ce-cli=${{ env.TARGET_DOCKER_VERSION }} \
              containerd.io runc
          fi
          
          sudo usermod -aG docker runner
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          sudo systemctl enable --now docker containerd && sleep 10
          
          # æ ¡éªŒDockerçŠ¶æ€
          INSTALLED_VERSION=$(docker -v | awk '{print $3}' | sed 's/,//g')
          [ "$INSTALLED_VERSION" != "${{ env.TARGET_DOCKER_VERSION }}" ] && { echo "âŒ Dockerç‰ˆæœ¬é”™è¯¯ï¼Œå®é™…ï¼š$INSTALLED_VERSION"; exit 1; }
          ! sudo systemctl is-active --quiet docker && { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          
          # éƒ¨ç½²dpanelå®¹å™¨
          sudo mkdir -p /opt/dpanel/{config,data,log} && sudo chmod -R 775 /opt/dpanel
          sudo bash -c "${{ env.DPANEL_START_CMD }}" && sleep 5
          [ ! "$(sudo docker ps | grep dpanel)" ] && { echo "âŒ dpanelå®¹å™¨éƒ¨ç½²å¤±è´¥"; sudo docker logs dpanel; exit 1; }
          echo "âœ… å…¨æ–°éƒ¨ç½²å®Œæˆ"

      - name: 7. é‡å¯æœåŠ¡ï¼ˆæ¢å¤æˆåŠŸåå…œåº•ï¼‰
        if: ${{ steps.restore.outputs.restore_success == 'true' }}
        run: |
          set -e
          # æ¸…ç†å ç”¨ç«¯å£
          for port in 80 443 2375 2376 7946 4789; do
            sudo lsof -i:$port -t >/dev/null && { echo "âš ï¸ ç»ˆæ­¢$portç«¯å£å ç”¨è¿›ç¨‹"; sudo kill -9 $(sudo lsof -i:$port -t); }
          done
          # é‡å¯æœåŠ¡+å®¹å™¨
          sudo systemctl restart docker containerd && sleep 10
          ! sudo docker ps | grep -q "dpanel" && { sudo docker start dpanel || { sudo docker rm -f dpanel; sudo bash -c "${{ env.DPANEL_START_CMD }}"; }; }
          # æœ€ç»ˆæ ¡éªŒ
          ! sudo systemctl is-active --quiet docker && { echo "âŒ Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          ! sudo docker ps | grep -q "dpanel" && { echo "âŒ dpanelå®¹å™¨å¯åŠ¨å¤±è´¥"; exit 1; }
          echo "âœ… æœåŠ¡é‡å¯å®Œæˆï¼Œå¯ç›´æ¥ä½¿ç”¨"

      - name: 8. éƒ¨ç½²Tailscaleï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          [ -z "$TAILSCALE_AUTH_KEY" ] && { echo "âš ï¸ ç¼ºå°‘Tailscaleå¯†é’¥ï¼Œè·³è¿‡"; exit 0; }
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y && sudo apt install -y tailscale
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="docker-snapshot-${{ github.run_id }}"
          echo "âœ… Tailscale IPï¼š$(sudo tailscale ip -4)"

      - name: 9. å…¨é‡å¤‡ä»½+ä¸Šä¼ +è§¦å‘ç»­è·‘
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' }}
        run: |
          set -e
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # æ¸…ç†æ—§å®¹å™¨å‡½æ•°
          stop_old_containers() {
            [ "$(sudo docker info 2>/dev/null)" ] && {
              OLD_CONTAINERS=$(sudo docker ps -aq)
              [ -n "$OLD_CONTAINERS" ] && sudo docker rm -f $OLD_CONTAINERS && echo "âœ… æ—§å®¹å™¨å·²æ¸…ç†" || echo "â„¹ï¸ æ— æ—§å®¹å™¨å¯æ¸…ç†"
            }
          }
          
          # è§¦å‘ç»­è·‘å‡½æ•°
          trigger_renew() {
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && { echo "âŒ ç¼ºå°‘PAT/ä»“åº“ä¿¡æ¯"; return 1; }
            curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -d '{"event_type":"renew_docker_snapshot"}' \
              "https://api.github.com/repos/$REPO/dispatches" && {
              echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ"
              RENEW_TRIGGERED=true
              stop_old_containers
            } || { echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥"; return 1; }
          }
          
          # å…¨é‡å¤‡ä»½å‡½æ•°
          create_full_snapshot() {
            # ç­›é€‰æœ‰æ•ˆç›®å½•
            VALID_DIRS=""
            for dir in $CORE_BACKUP_DIRS; do
              [ -d "$dir" ] || [ -f "$dir" ] && VALID_DIRS="$VALID_DIRS $dir" || echo "â„¹ï¸ è·³è¿‡ä¸å­˜åœ¨è·¯å¾„ï¼š$dir"
            done
            [ -z "$VALID_DIRS" ] && { echo "âŒ æ— æœ‰æ•ˆå¤‡ä»½è·¯å¾„"; return 1; }
            # å¤‡ä»½é…ç½®
            SNAPSHOT_NAME="docker-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/$SNAPSHOT_NAME"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/${SNAPSHOT_NAME}"
            # åœæ­¢æœåŠ¡
            sudo docker stop $(sudo docker ps -q) 2>/dev/null || true
            sleep 5
            sudo systemctl stop docker containerd 2>/dev/null || true
            sudo pkill -9 docker containerd runc 2>/dev/null || true
            sync && sleep 10
            # å‹ç¼©å¤‡ä»½
            sudo tar -czpf "$TMP_SNAPSHOT" \
              --ignore-failed-read -p --same-owner --acls --xattrs --exclude-caches-all \
              $EXCLUDE_RULES $VALID_DIRS || { echo "âŒ å‹ç¼©å¤±è´¥"; return 1; }
            # æ ¡éªŒå¿«ç…§å¤§å°ï¼ˆæœ€å°100MBï¼‰
            [ $(stat -c%s "$TMP_SNAPSHOT") -lt $((100 * 1024 * 1024)) ] && { echo "âŒ å¿«ç…§è¿‡å°"; rm -f "$TMP_SNAPSHOT"; return 1; }
            # ä¸Šä¼ å¿«ç…§
            sudo chown runner:runner "$TMP_SNAPSHOT"
            sudo -u runner rclone copy "$TMP_SNAPSHOT" "$REMOTE_PATH" --config /home/runner/.rclone.conf --transfers 8 --checkers 8 || { echo "âŒ ä¸Šä¼ å¤±è´¥"; rm -f "$TMP_SNAPSHOT"; return 1; }
            # é‡å¯æœåŠ¡
            sudo systemctl start docker containerd 2>/dev/null || true
            sleep 10
            sudo docker start $(sudo docker ps -aq) 2>/dev/null || true
            # ä¸Šä¼ å…ƒæ•°æ®
            printf "snapshot_name=%s\ncreate_time=%s\nsnapshot_size=%s\ndocker_version=%s\ncontainerd_version=%s\n" \
              "$SNAPSHOT_NAME" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$(du -sh "$TMP_SNAPSHOT" | awk '{print $1}')" \
              "$(docker -v 2>/dev/null | awk '{print $3}' | sed 's/,//g')" \
              "$(containerd -v 2>/dev/null | awk '{print $3}' | sed 's/,//g')" | sudo tee /tmp/snapshot_meta.txt
            sudo -u runner rclone copy /tmp/snapshot_meta.txt "mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/snapshot_meta.txt" --config /home/runner/.rclone.conf
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "$TMP_SNAPSHOT" /tmp/snapshot_meta.txt
            echo "âœ… å…¨é‡å¤‡ä»½ä¸Šä¼ æˆåŠŸ"
            return 0
          }
          
          # ä¸»å¾ªç¯ï¼š10åˆ†é’Ÿåæ‰§è¡Œå¤‡ä»½+ç»­è·‘
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "â±ï¸ è¿è¡Œæ—¶é—´ï¼š$run_mins / $MAX_RUN_MINUTES åˆ†é’Ÿ"
            # 10åˆ†é’Ÿåè§¦å‘å¤‡ä»½+ç»­è·‘
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° å¼€å§‹å…¨é‡å¤‡ä»½+ç»­è·‘"
              create_full_snapshot && trigger_renew
            fi
            # è¶…æ—¶é€€å‡º
            [ $run_mins -ge $MAX_RUN_MINUTES ] && { echo "â¹ï¸ è¶…æ—¶é€€å‡º"; exit 0; }
            sleep 60
          done

      - name: 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          sudo rm -rf /tmp/docker-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
