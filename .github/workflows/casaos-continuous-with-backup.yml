name: CasaOS Cloud Instance

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'
  workflow_call:

env:
  SOURCE_DIRS: "/var/lib/casaos /var/lib/docker /DATA"
  BACKUP_BUCKET: "/z/Ubu"
  WEBDAV_MOUNT_POINT: "/home/runner/webdav_mount"
  WEBDAV_REMOTE_NAME: "mywebdav"
  # æ–°å¢ï¼šæ’é™¤åˆ—è¡¨ç”¨æ•°ç»„å½¢å¼å®šä¹‰ï¼Œé¿å…ç©ºæ ¼æ‹†åˆ†é—®é¢˜
  EXCLUDE_LIST: >
    /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
    /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
    /usr/share/doc /usr/share/man /usr/share/locale
    /etc/ssl/certs /etc/fstab /etc/mtab /etc/hostname /etc/machine-id
    /var/lib/docker/tmp /var/lib/docker/overlay2 "/var/lib/docker/containers/*/mounts"
    /var/lib/docker/network/files /var/lib/docker/buildkit /var/lib/docker/runtimes
    /var/lib/docker/swarm /var/lib/docker/trust

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    # æ–°å¢ï¼šå…è®¸å¤±è´¥åé‡è¯•
    strategy:
      fail-fast: false
      matrix:
        attempt: [1, 2, 3]
    steps:
      - name: ğŸ“¦ Prepare Environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rclone rsync curl wget fuse
          echo 'user_allow_other' | sudo tee -a /etc/fuse.conf > /dev/null
          mkdir -p "${{ env.WEBDAV_MOUNT_POINT }}"
          # ä¿®å¤ï¼šä½¿ç”¨åŠè§’æ³¢æµªå·ï¼Œåˆ›å»ºæ­£ç¡®çš„rcloneé…ç½®ç›®å½•
          mkdir -p ~/.config/rclone
          # æ–°å¢ï¼šæ£€æŸ¥ä¾èµ–å®‰è£…çŠ¶æ€
          rclone --version || { echo "rcloneå®‰è£…å¤±è´¥"; exit 1; }
          rsync --version || { echo "rsyncå®‰è£…å¤±è´¥"; exit 1; }

      - name: ğŸŒ Mount WebDAV
        if: ${{ secrets.WEBDAV_URL != '' }}
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        # æ–°å¢ï¼šé‡è¯•æœºåˆ¶
        uses: nick-fields/retry@v2
        with:
          max_attempts: 3
          retry_delay_seconds: 10
          command: |
            # ä¿®å¤ï¼šåŠè§’æ³¢æµªå·ï¼Œç”Ÿæˆæ­£ç¡®çš„rcloneé…ç½®æ–‡ä»¶
            cat > ~/.config/rclone/rclone.conf << EOF
[${{ env.WEBDAV_REMOTE_NAME }}]
type = webdav
url = $WEBDAV_URL
vendor = other
user = $WEBDAV_USER
pass = $WEBDAV_PASSWORD
EOF
            # éªŒè¯é…ç½®æ–‡ä»¶
            cat ~/.config/rclone/rclone.conf
            # æŒ‚è½½WebDAVï¼Œä¼˜åŒ–æŒ‚è½½å‚æ•°
            rclone mount "${{ env.WEBDAV_REMOTE_NAME }}:${{ env.BACKUP_BUCKET }}" "${{ env.WEBDAV_MOUNT_POINT }}" \
              --allow-other --vfs-cache-mode full --daemon \
              --timeout 5m --dir-cache-time 10m --poll-interval 10s \
              --log-level INFO --log-file /tmp/rclone_mount.log
            sleep 10
            # æ£€æŸ¥æŒ‚è½½çŠ¶æ€
            mountpoint -q "${{ env.WEBDAV_MOUNT_POINT }}" || { 
              echo "WebDAVæŒ‚è½½å¤±è´¥ï¼Œæ—¥å¿—ï¼š"; 
              cat /tmp/rclone_mount.log; 
              exit 1; 
            }
            echo "WebDAVæŒ‚è½½æˆåŠŸï¼ŒæŒ‚è½½ç‚¹ï¼š${{ env.WEBDAV_MOUNT_POINT }}"

      - name: ğŸ“¥ Restore Data
        if: ${{ secrets.WEBDAV_URL != '' }}
        uses: nick-fields/retry@v2
        with:
          max_attempts: 2
          retry_delay_seconds: 15
          command: |
            echo "å¼€å§‹æ¢å¤æ•°æ®ï¼Œæºç›®å½•ï¼š${{ env.SOURCE_DIRS }}"
            # ä¿®å¤ï¼šæ­£ç¡®å¤„ç†æ’é™¤åˆ—è¡¨ï¼ˆç”¨readarrayé¿å…ç©ºæ ¼æ‹†åˆ†ï¼‰
            readarray -t EXCLUDE_DIRS < <(echo "${{ env.EXCLUDE_LIST }}" | tr ' ' '\n' | grep -v '^$')
            
            # éå†éœ€è¦æ¢å¤çš„ç›®å½•
            while IFS= read -r dir; do
              # ä¿®å¤ï¼šè·¯å¾„æ‹¼æ¥é€»è¾‘ï¼ˆæŒ‚è½½ç‚¹å·²åŒ…å«BACKUP_BUCKETï¼Œæ— éœ€é‡å¤æ‹¼æ¥ï¼‰
              webdav_src="${{ env.WEBDAV_MOUNT_POINT }}$dir"
              if [ -d "$webdav_src" ]; then
                echo "æ¢å¤ç›®å½•ï¼š$dir ä» $webdav_src"
                sudo mkdir -p "$dir"
                # æ„å»ºæ’é™¤å‚æ•°
                exclude_params=()
                for excl in "${EXCLUDE_DIRS[@]}"; do
                  if [[ "$excl" == "$dir"* ]]; then
                    exclude_params+=("--exclude=$excl")
                    echo "æ’é™¤è·¯å¾„ï¼š$excl"
                  fi
                done
                # æ‰§è¡ŒrsyncåŒæ­¥ï¼ˆå¢åŠ æ—¥å¿—è¾“å‡ºï¼‰
                sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                  "${exclude_params[@]}" \
                  --log-file=/tmp/rsync_restore_$(echo $dir | tr '/' '_').log \
                  "$webdav_src/" "$dir/"
              else
                echo "æºç›®å½•ä¸å­˜åœ¨ï¼š$webdav_srcï¼Œè·³è¿‡æ¢å¤"
              fi
            done < <(echo "${{ env.SOURCE_DIRS }}" | tr ' ' '\n' | grep -v '^$')

      - name: ğŸ  Install CasaOS
        if: ${{ secrets.WEBDAV_URL == '' || github.event_name != 'schedule' }}
        run: |
          echo "æ£€æŸ¥å¹¶å®‰è£…CasaOS..."
          if ! command -v casaos-service &> /dev/null; then
            # å¢åŠ å®‰è£…æ—¥å¿—
            curl -fsSL https://get.casaos.io | sudo bash -x
          fi
          sudo mkdir -p /DATA
          # ä¿®å¤ï¼šæƒé™é…ç½®ï¼ˆä½¿ç”¨rootç”¨æˆ·ï¼Œé¿å…æœåŠ¡è¿è¡Œæƒé™ä¸è¶³ï¼‰
          sudo chown -R root:root /DATA
          sudo chmod 775 /DATA
          # éªŒè¯CasaOSå®‰è£…
          casaos-service --version || { echo "CasaOSå®‰è£…å¤±è´¥"; exit 1; }

      - name: â–¶ï¸ Start Services
        run: |
          echo "å¯åŠ¨Dockerå’ŒCasaOSæœåŠ¡..."
          sudo systemctl daemon-reload
          sudo systemctl enable docker casaos
          sudo systemctl start docker casaos
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 15
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          sudo systemctl status docker --no-pager || { echo "Dockerå¯åŠ¨å¤±è´¥"; exit 1; }
          sudo systemctl status casaos --no-pager || { echo "CasaOSå¯åŠ¨å¤±è´¥"; exit 1; }

      - name: ğŸ” Connect Tailscale
        if: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "å®‰è£…å¹¶è¿æ¥Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="$TS_AUTH_KEY" --hostname=CasaOS-Cloud --accept-routes
          # éªŒè¯è¿æ¥
          tailscale status || { echo "Tailscaleè¿æ¥å¤±è´¥"; exit 1; }

      - name: ğŸ”„ Run & Backup Loop
        if: ${{ secrets.WEBDAV_URL != '' }}
        run: |
          echo "å¼€å§‹å¤‡ä»½å¾ªç¯ï¼ˆæ¯5å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰..."
          # å®ç°æ ¸å¿ƒå¤‡ä»½é€»è¾‘
          while true; do
            echo "æ‰§è¡Œå¤‡ä»½ - $(date)"
            # éå†éœ€è¦å¤‡ä»½çš„ç›®å½•
            while IFS= read -r dir; do
              backup_dst="${{ env.WEBDAV_MOUNT_POINT }}$dir"
              if [ -d "$dir" ]; then
                echo "å¤‡ä»½ç›®å½•ï¼š$dir åˆ° $backup_dst"
                sudo mkdir -p "$backup_dst"
                # æ„å»ºæ’é™¤å‚æ•°
                exclude_params=()
                readarray -t EXCLUDE_DIRS < <(echo "${{ env.EXCLUDE_LIST }}" | tr ' ' '\n' | grep -v '^$')
                for excl in "${EXCLUDE_DIRS[@]}"; do
                  if [[ "$excl" == "$dir"* ]]; then
                    exclude_params+=("--exclude=$excl")
                  fi
                done
                # æ‰§è¡Œå¤‡ä»½ï¼ˆå¢é‡åŒæ­¥ï¼‰
                sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                  "${exclude_params[@]}" \
                  --log-file=/tmp/rsync_backup_$(echo $dir | tr '/' '_').log \
                  "$dir/" "$backup_dst/"
              else
                echo "å¾…å¤‡ä»½ç›®å½•ä¸å­˜åœ¨ï¼š$dirï¼Œè·³"
              fi
            done < <(echo "${{ env.SOURCE_DIRS }}" | tr ' ' '\n' | grep -v '^$')
            
            echo "æœ¬æ¬¡å¤‡ä»½å®Œæˆ - $(date)"
            # ç­‰å¾…5å°æ—¶ï¼ˆ3600*5ç§’ï¼‰ï¼Œç¬¦åˆå®šæ—¶è§¦å‘é¢‘ç‡
            sleep 18000
          done

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ‰§è¡Œæ¸…ç†æ“ä½œ..."
          # åœæ­¢å¤‡ä»½å¾ªç¯è¿›ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          pkill -f "rsync -av --delete" || true
          # å¸è½½WebDAVæŒ‚è½½ç‚¹
          fusermount -u "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null || sudo umount "${{ env.WEBDAV_MOUNT_POINT }}" 2>/dev/null
          # æ¸…ç†ä¸´æ—¶æ—¥å¿—
          rm -rf /tmp/rclone_*.log /tmp/rsync_*.log
          echo "æ¸…ç†å®Œæˆ"
