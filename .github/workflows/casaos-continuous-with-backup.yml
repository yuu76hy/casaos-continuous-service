name: CasaOS-Tailscale-Full-Deploy

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu"
      CASAOS_DATA: /var/lib/casaos
      DOCKER_DATA: /var/lib/docker
      # ðŸ‘‡ æ–°å¢žæŽ’é™¤ fstab/mtabï¼Œé¿å…æ¢å¤åŽç³»ç»ŸæŒ‚è½½å¼‚å¸¸
      EXCLUDE_DIRS: >-
        /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
        /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
        /usr/share/doc /usr/share/man /usr/share/locale /etc/ssl/certs
        /etc/fstab /etc/mtab /etc/hostname /etc/machine-id
      MAX_MOUNT_RETRIES: 3          # ðŸ‘ˆ å¢žåŠ é‡è¯•æ¬¡æ•°
      RETRY_DELAY: 15               # ðŸ‘ˆ å»¶é•¿é‡è¯•é—´éš”
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»ŸçŽ¯å¢ƒåˆå§‹åŒ– ==========
      - name: æ­¥éª¤1 - ç³»ç»ŸçŽ¯å¢ƒåˆå§‹åŒ–
        run: |
          echo "===== æ­¥éª¤1ï¼šç³»ç»ŸçŽ¯å¢ƒåˆå§‹åŒ– ====="
          sudo apt update -y && sudo apt install -y rsync davfs2 curl wget jq iptables || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }

          # ðŸ‘‡ é…ç½® davfs2ï¼šç¦ç”¨æ–‡ä»¶é”ï¼ˆWebDAV ä¸æ”¯æŒï¼‰ï¼Œå¿½ç•¥ SSL è¯ä¹¦ï¼ˆå…¼å®¹è‡ªç­¾åï¼‰
          echo "use_locks 0" | sudo tee -a /etc/davfs2/davfs2.conf
          echo "trust_server_cert 1" | sudo tee -a /etc/davfs2/davfs2.conf

          echo "runner ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      # ========== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ· ==========
      - name: æ­¥éª¤1.5 - åˆ›å»º roots ç”¨æˆ·
        run: |
          echo "===== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ· ====="
          sudo useradd -m -s /bin/bash roots
          echo "roots:roots1234" | sudo chpasswd
          sudo usermod -aG sudo roots
          echo "âœ… è°ƒè¯•ç”¨æˆ· 'roots' å·²å°±ç»ª"

      # ========== æ­¥éª¤2ï¼šæŒ‚è½½å¹¶éªŒè¯ WebDAV ==========
      - name: æ­¥éª¤2 - æŒ‚è½½å¹¶éªŒè¯ WebDAV
        run: |
          echo "===== æ­¥éª¤2ï¼šæŒ‚è½½å¹¶éªŒè¯ WebDAV ====="
          mkdir -p "$WEBDAV_MOUNT_POINT"
          echo "$WEBDAV_URL $WEBDAV_USER $WEBDAV_PASSWORD" | sudo tee -a /etc/davfs2/secrets >/dev/null
          sudo chmod 600 /etc/davfs2/secrets

          mount_success=false
          for retry in $(seq 1 $MAX_MOUNT_RETRIES); do
            sudo umount "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
            echo "ðŸ”„ å°è¯•æŒ‚è½½ WebDAV (ç¬¬ $retry/$MAX_MOUNT_RETRIES æ¬¡)"
            if timeout 60 sudo mount -t davfs -o uid=runner,gid=runner,soft "$WEBDAV_URL" "$WEBDAV_MOUNT_POINT"; then
              mount_success=true
              break
            fi
            sleep $RETRY_DELAY
          done

          if [ "$mount_success" = "true" ]; then
            # ðŸ‘‡ å…³é”®ï¼šéªŒè¯ WebDAV æ˜¯å¦å¯å†™ï¼
            if timeout 10 touch "$WEBDAV_MOUNT_POINT/.write_test" 2>/dev/null && rm -f "$WEBDAV_MOUNT_POINT/.write_test"; then
              echo "âœ… WebDAV æŒ‚è½½æˆåŠŸä¸”å¯å†™"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              
              for dir in $BACKUP_DIRS; do
                target_path="$WEBDAV_MOUNT_POINT$dir"
                if [ -d "$target_path" ] && [ -n "$(ls -A "$target_path" 2>/dev/null)" ]; then
                  echo "âœ… æ£€æµ‹åˆ°æœ‰æ•ˆå¤‡ä»½: $dir"
                  key="HAS_${dir//\//_}"
                  echo "${key}=true" >> "$GITHUB_ENV"
                else
                  echo "âš ï¸ åˆå§‹åŒ–å¤‡ä»½ç›®å½•: $dir"
                  sudo mkdir -p "$target_path"
                  key="HAS_${dir//\//_}"
                  echo "${key}=false" >> "$GITHUB_ENV"
                fi
              done
            else
              echo "âŒ WebDAV æŒ‚è½½æˆåŠŸä½†ä¸å¯å†™ï¼ˆå¯èƒ½æ˜¯åªè¯»å…±äº«ï¼‰"
              echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            fi
          else
            echo "âŒ WebDAV æŒ‚è½½å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      # ========== æ­¥éª¤3ï¼šæ•°æ®æ¢å¤ ==========
      - name: æ­¥éª¤3 - æ•°æ®æ¢å¤
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== æ­¥éª¤3ï¼šæ•°æ®æ¢å¤ ====="
          RESTORE_DONE=false
          for dir in $BACKUP_DIRS; do
            env_key="HAS_${dir//\//_}"
            if [ "${!env_key}" = "true" ]; then
              echo "ðŸ”„ ä»Ž $dir æ¢å¤ç³»ç»ŸçŠ¶æ€..."
              EXCLUDE_PARAMS=()
              for excl in $EXCLUDE_DIRS; do
                EXCLUDE_PARAMS+=("--exclude=$excl")
              done
              target_path="$WEBDAV_MOUNT_POINT$dir"
              
              # ðŸ‘‡ ä¼˜åŒ– rsync å‚æ•°
              sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                "${EXCLUDE_PARAMS[@]}" "$target_path/" /
              if [ $? -eq 0 ]; then
                RESTORE_DONE=true
                echo "âœ… æ¢å¤æˆåŠŸ ($dir)"
                break
              else
                echo "âš ï¸ æ¢å¤ $dir å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªï¼ˆå¦‚æœ‰ï¼‰"
              fi
            fi
          done
          echo "DATA_RESTORED=$RESTORE_DONE" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤4ï¼šå®‰è£… CasaOS ==========
      - name: æ­¥éª¤4 - å®‰è£…æˆ–è·³è¿‡ CasaOS
        run: |
          echo "===== æ­¥éª¤4ï¼šå®‰è£… CasaOS ====="
          if [ -d "$CASAOS_DATA" ] && [ "${{ env.DATA_RESTORED }}" = "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°å·²æ¢å¤ CasaOS æ•°æ®ï¼Œè·³è¿‡å®‰è£…"
          else
            curl -fsSL https://get.casaos.io | sudo bash || { echo "âŒ CasaOS å®‰è£…å¤±è´¥"; exit 1; }
            echo "âœ… CasaOS å®‰è£…å®Œæˆ"
          fi

      # ========== æ­¥éª¤5ï¼šå¯åŠ¨æœåŠ¡ ==========
      - name: æ­¥éª¤5 - å¯åŠ¨æœåŠ¡
        run: |
          echo "===== æ­¥éª¤5ï¼šå¯åŠ¨ Docker + CasaOS ====="
          sudo systemctl enable --now docker casaos
          sleep 30
          if ! sudo systemctl is-active --quiet docker || ! sudo systemctl is-active --quiet casaos; then
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          echo "âœ… æœåŠ¡è¿è¡Œä¸­"

      # ========== æ­¥éª¤6ï¼šéƒ¨ç½² Tailscale ==========
      - name: æ­¥éª¤6 - éƒ¨ç½² Tailscale
        run: |
          echo "===== æ­¥éª¤6ï¼šéƒ¨ç½² Tailscale ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æœªé…ç½® TAILSCALE_AUTH_KEYï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-runner-${{ github.run_id }}"
          TAILSCALE_IP=$(sudo tailscale ip -4)
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscale è¿žæŽ¥å¤±è´¥"
            exit 1
          fi
          echo "âœ… Tailscale IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤7ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: æ­¥éª¤7 - è®¿é—®ä¿¡æ¯
        run: |
          echo "===== æ­¥éª¤7ï¼šè®¿é—®ä¿¡æ¯ ====="
          PUBLIC_IP=$(curl -s --max-time 10 ifconfig.me)
          echo "ðŸ”— å…¬ç½‘: http://$PUBLIC_IP"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "ðŸ”’ å†…ç½‘: http://${{ env.TAILSCALE_IP }}"
          fi
          echo "ðŸ‘¤ è°ƒè¯•ç”¨æˆ·: roots / roots1234"
          echo "âš ï¸ è¯·ç«‹å³ä¿®æ”¹ CasaOS é»˜è®¤å¯†ç ï¼"

      # ========== æ­¥éª¤8ï¼šä¿æ´» + å¤‡ä»½ + ç»­è·‘ ==========
      - name: æ­¥éª¤8 - ä¿æ´»ä¸Žç»­è·‘
        shell: bash
        run: |
          echo "===== æ­¥éª¤8ï¼šä¿æ´»ä¸Žç»­è·‘ ====="
          start_time=$(date +%s)

          trigger_renew() {
            [ -n "$USER_PAT" ] && [ -n "$REPO" ] && \
            curl -fsS -X POST -H "Authorization: token $USER_PAT" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_tailscale"}' && \
            echo "âœ… ç»­è·‘ä»»åŠ¡å·²è§¦å‘"
          }

          backup_single_dir() {
            [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1
            local dir="$1"
            local target_path="$WEBDAV_MOUNT_POINT$dir"
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=$excl")
            done
            EXCLUDE_PARAMS+=("--exclude=$WEBDAV_MOUNT_POINT")

            echo "ðŸ”„ å¼€å§‹å¤‡ä»½åˆ° $dir ..."
            if sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                "${EXCLUDE_PARAMS[@]}" / "$target_path/"; then
              # ðŸ‘‡ å¢žå¼ºæ ‡è®°æ–‡ä»¶ä¿¡æ¯
              cat > /tmp/backup_meta.txt <<EOF
backup_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
runner_id=${{ github.run_id }}
github_repo=${{ github.repository }}
workflow_run_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
EOF
              sudo cp /tmp/backup_meta.txt "$target_path/backup_info.txt"
              echo "âœ… å¤‡ä»½å®Œæˆ ($dir)"
              return 0
            fi
            return 1
          }

          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "ðŸ“Š è¿è¡Œ $run_mins/360 åˆ†é’Ÿ"

            if [ $run_mins -eq 300 ]; then
              echo "â° è§¦å‘å¤‡ä»½ä¸Žç»­è·‘ï¼ˆå‰©ä½™ 60 åˆ†é’Ÿï¼‰"
              for dir in $BACKUP_DIRS; do
                if backup_single_dir "$dir"; then
                  trigger_renew
                  break
                fi
              done
            fi

            if [ $run_mins -ge 360 ]; then
              echo "â¹ï¸ è¾¾åˆ° 360 åˆ†é’Ÿä¸Šé™ï¼Œé€€å‡º"
              exit 0
            fi

            sleep 60
          done

      # ========== æ­¥éª¤9ï¼šæ¸…ç† ==========
      - name: æ­¥éª¤9 - æ¸…ç†çŽ¯å¢ƒ
        if: ${{ always() }}
        run: |
          echo "===== æ­¥éª¤9ï¼šæ¸…ç† ====="
          sudo umount "$WEBDAV_MOUNT_POINT" 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* || true
