name: CasaOS-Tailscale-简单部署

on:
  workflow_dispatch:  # 手动触发
  repository_dispatch:  # 自动续期触发
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    
    env:
      # 核心配置
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /mnt/webdav
      WEBDAV_REMOTE_PATH: /z/Ubu
      
      # WebDAV 配置
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      
      # GitHub 配置
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ github.repository }}
      
      # Tailscale 配置
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      
      # 备份配置
      BACKUP_COMPRESSION: zstd
      SNAPSHOT_RETENTION: 3
      
      # 调试用户
      DEBUG_USER: roots
      DEBUG_PASSWORD: roots1234
      
      # 挂载配置
      MAX_MOUNT_RETRIES: 3
      RETRY_DELAY: 15

    steps:
      # ========== 步骤1: 系统初始化 ==========
      - name: 步骤1 - 系统环境初始化
        run: |
          echo "===== 步骤1: 系统环境初始化 ====="
          echo "开始时间: $(date)"
          
          sudo apt update -y
          sudo apt install -y \
            curl wget git jq tar gzip zstd \
            rsync fuse3 psmisc \
            net-tools iputils-ping \
            ca-certificates lsb-release
          
          echo "安装 rclone..."
          curl -s https://rclone.org/install.sh | sudo bash
          
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          
          sudo mkdir -p ${{ env.WEBDAV_MOUNT_POINT }}
          sudo chmod 777 ${{ env.WEBDAV_MOUNT_POINT }}
          
          echo "✅ 系统初始化完成"

      # ========== 步骤2: 创建调试用户 ==========
      - name: 步骤2 - 创建调试用户
        run: |
          echo "===== 步骤2: 创建调试用户 ====="
          
          if id "${{ env.DEBUG_USER }}" &>/dev/null; then
            echo "用户已存在，修改密码"
            echo "${{ env.DEBUG_USER }}:${{ env.DEBUG_PASSWORD }}" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "${{ env.DEBUG_USER }}"
            echo "${{ env.DEBUG_USER }}:${{ env.DEBUG_PASSWORD }}" | sudo chpasswd
            sudo usermod -aG sudo "${{ env.DEBUG_USER }}"
          fi
          
          echo "✅ 调试用户创建完成"

      # ========== 步骤3: 挂载 WebDAV 存储 ==========
      - name: 步骤3 - 挂载 WebDAV
        id: mount_webdav
        run: |
          echo "===== 步骤3: 挂载 WebDAV ====="
          
          if [ -z "${{ secrets.WEBDAV_URL }}" ] || [ -z "${{ secrets.WEBDAV_USER }}" ] || [ -z "${{ secrets.WEBDAV_PASSWORD }}" ]; then
            echo "❌ WebDAV 凭据未配置"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          
          cat > /tmp/rclone.conf << EOF
[webdav]
type = webdav
url = ${{ secrets.WEBDAV_URL }}${{ env.WEBDAV_REMOTE_PATH }}
vendor = other
user = ${{ secrets.WEBDAV_USER }}
pass = ${{ secrets.WEBDAV_PASSWORD }}
EOF
          
          echo "测试 WebDAV 连接..."
          if rclone lsd webdav: --config=/tmp/rclone.conf; then
            echo "✅ WebDAV 连接成功"
          else
            echo "❌ WebDAV 连接失败"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "挂载 WebDAV..."
          rclone mount webdav: "${{ env.WEBDAV_MOUNT_POINT }}" \
            --config=/tmp/rclone.conf \
            --vfs-cache-mode writes \
            --allow-other \
            --daemon \
            --log-level INFO \
            --log-file /tmp/rclone.log
          
          sleep 5
          if mountpoint -q "${{ env.WEBDAV_MOUNT_POINT }}"; then
            echo "✅ WebDAV 挂载成功"
            echo "WEBDAV_AVAILABLE=true" >> $GITHUB_ENV
            
            mkdir -p "${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
            
          else
            echo "❌ WebDAV 挂载失败"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
          fi

      # ========== 步骤4: 智能恢复 ==========
      - name: 步骤4 - 智能恢复系统状态
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          echo "===== 步骤4: 智能恢复系统状态 ====="
          
          find_snapshot() {
            local snapshot_dir="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots"
            if [ -d "$snapshot_dir" ]; then
              find "$snapshot_dir" -maxdepth 1 -type d -name "2*" 2>/dev/null | sort -r | head -1
            fi
          }
          
          LATEST_SNAPSHOT=$(find_snapshot)
          
          if [ -n "$LATEST_SNAPSHOT" ] && [ -f "$LATEST_SNAPSHOT/snapshot_info.json" ]; then
            echo "找到快照: $(basename $LATEST_SNAPSHOT)"
            
            SNAPSHOT_INFO=$(cat "$LATEST_SNAPSHOT/snapshot_info.json")
            SNAPSHOT_TIME=$(echo "$SNAPSHOT_INFO" | jq -r '.timestamp' 2>/dev/null || echo "未知")
            echo "快照时间: $SNAPSHOT_TIME"
            
            sudo systemctl stop casaos docker 2>/dev/null || true
            
            restore_from_tar() {
              local tar_file="$1"
              local target_dir="$2"
              
              if [ -f "$tar_file" ]; then
                echo "恢复: $(basename $tar_file)"
                
                if [[ "$tar_file" == *.zst ]]; then
                  sudo tar -I 'zstd -d' -xf "$tar_file" -C "$target_dir" 2>/dev/null && return 0 || return 1
                elif [[ "$tar_file" == *.gz ]]; then
                  sudo tar -xzf "$tar_file" -C "$target_dir" 2>/dev/null && return 0 || return 1
                fi
              fi
              return 1
            }
            
            DOCKER_RESTORED=false
            if restore_from_tar "$LATEST_SNAPSHOT/docker_state.tar.${{ env.BACKUP_COMPRESSION }}" "/"; then
              echo "✅ Docker 数据恢复成功"
              DOCKER_RESTORED=true
            else
              echo "❌ Docker 数据恢复失败"
            fi
            
            CASAOS_RESTORED=false
            if restore_from_tar "$LATEST_SNAPSHOT/casaos_state.tar.${{ env.BACKUP_COMPRESSION }}" "/"; then
              echo "✅ CasaOS 数据恢复成功"
              CASAOS_RESTORED=true
            else
              echo "❌ CasaOS 数据恢复失败"
            fi
            
            if [ "$DOCKER_RESTORED" = true ] || [ "$CASAOS_RESTORED" = true ]; then
              echo "✅ 系统状态恢复完成"
              echo "RESTORED_FROM_BACKUP=true" >> $GITHUB_ENV
            else
              echo "❌ 系统状态恢复失败"
              echo "RESTORED_FROM_BACKUP=false" >> $GITHUB_ENV
            fi
            
          else
            echo "未找到可用快照"
            echo "RESTORED_FROM_BACKUP=false" >> $GITHUB_ENV
          fi

      # ========== 步骤5: 安装 CasaOS 和 Docker ==========
      - name: 步骤5 - 安装 CasaOS
        run: |
          echo "===== 步骤5: 安装 CasaOS ====="
          
          if [ "$RESTORED_FROM_BACKUP" = "true" ]; then
            echo "✅ 已从备份恢复，验证组件..."
            
            if ! command -v docker &>/dev/null; then
              echo "🐳 安装 Docker..."
              curl -fsSL https://get.docker.com | sudo bash
            else
              echo "✅ Docker 已安装"
            fi
            
            if [ ! -f "/usr/local/bin/casaos" ]; then
              echo "🏠 安装 CasaOS..."
              curl -fsSL https://get.casaos.io | sudo bash
            else
              echo "✅ CasaOS 已安装"
            fi
            
          else
            echo "🆕 执行全新安装..."
            
            curl -fsSL https://get.docker.com | sudo bash
            curl -fsSL https://get.casaos.io | sudo bash
          fi
          
          sudo systemctl daemon-reload
          sudo systemctl enable docker casaos
          sudo systemctl start docker
          sleep 10
          sudo systemctl start casaos
          
          for i in $(seq 1 30); do
            if curl -s http://localhost:80 &>/dev/null; then
              echo "✅ CasaOS Web 界面可访问"
              break
            fi
            sleep 2
          done
          
          echo "📊 安装验证:"
          echo "  🐳 Docker: $(docker --version 2>/dev/null || echo '未安装')"
          echo "  🏠 CasaOS: $(sudo casaos version 2>/dev/null || echo '未安装')"

      # ========== 步骤6: 部署 Tailscale ==========
      - name: 步骤6 - 部署 Tailscale
        run: |
          echo "===== 步骤6: 部署 Tailscale ====="
          
          if [ -z "${{ secrets.TAILSCALE_AUTH_KEY }}" ] || [ "${{ secrets.TAILSCALE_AUTH_KEY }}" = "" ]; then
            echo "⚠️ 未配置 TAILSCALE_AUTH_KEY，跳过组网"
            echo "TAILSCALE_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --accept-routes \
            --hostname="casaos-runner-${{ github.run_id }}" \
            --accept-dns=false \
            --reset
          
          sleep 5
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "")
          
          if [ -n "$TAILSCALE_IP" ]; then
            echo "✅ Tailscale 连接成功"
            echo "🌐 Tailscale IP: $TAILSCALE_IP"
            echo "TAILSCALE_CONNECTED=true" >> $GITHUB_ENV
            echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          else
            echo "❌ Tailscale 连接失败"
            echo "TAILSCALE_CONNECTED=false" >> $GITHUB_ENV
          fi

      # ========== 步骤7: 输出访问信息 ==========
      - name: 步骤7 - 访问信息
        run: |
          echo "===== 步骤7: 访问信息 ====="
          
          PUBLIC_IP=$(curl -s --max-time 3 https://api.ipify.org || echo "未知")
          LOCAL_IP=$(hostname -I | awk '{print $1}' 2>/dev/null || echo "未知")
          
          echo "========================================"
          echo "🎉 CasaOS 部署完成"
          echo "========================================"
          echo ""
          echo "🌍 公网访问: http://$PUBLIC_IP"
          echo "🏠 本地访问: http://$LOCAL_IP"
          echo ""
          
          if [ "$TAILSCALE_CONNECTED" = "true" ]; then
            echo "🔒 Tailscale 访问:"
            echo "  http://$TAILSCALE_IP"
            echo "  http://casaos-runner-${{ github.run_id }}.tailscale"
            echo ""
          fi
          
          echo "🔧 管理访问:"
          echo "  用户名: admin"
          echo "  初始密码: admin123 (请首次登录后立即修改)"
          echo ""
          echo "🔑 SSH调试访问:"
          echo "  用户名: ${{ env.DEBUG_USER }}"
          echo "  密码: ${{ env.DEBUG_PASSWORD }}"
          echo ""
          
          if [ "$RESTORED_FROM_BACKUP" = "true" ]; then
            echo "📂 恢复状态: 已从最新备份恢复系统状态"
          else
            echo "📂 恢复状态: 未找到备份，执行全新安装"
          fi
          
          if [ "$WEBDAV_AVAILABLE" = "true" ]; then
            echo "☁️  WebDAV存储: 已挂载到 ${{ env.WEBDAV_MOUNT_POINT }}"
          else
            echo "⚠️  WebDAV存储: 未配置或挂载失败"
          fi
          
          echo ""
          echo "🕒 部署完成时间: $(date)"
          echo "========================================"

      # ========== 步骤8: 创建系统快照 ==========
      - name: 步骤8 - 创建系统快照
        if: env.WEBDAV_AVAILABLE == 'true' && env.RESTORED_FROM_BACKUP == 'false'
        run: |
          echo "===== 步骤8: 创建系统快照 ====="
          
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          SNAPSHOT_DIR="${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots/$TIMESTAMP"
          
          echo "创建快照目录: $SNAPSHOT_DIR"
          mkdir -p "$SNAPSHOT_DIR"
          
          echo "备份 Docker 状态..."
          sudo docker system info > "$SNAPSHOT_DIR/docker_info.txt" 2>/dev/null || true
          sudo docker ps -a > "$SNAPSHOT_DIR/docker_containers.txt" 2>/dev/null || true
          sudo docker images > "$SNAPSHOT_DIR/docker_images.txt" 2>/dev/null || true
          sudo docker volume ls > "$SNAPSHOT_DIR/docker_volumes.txt" 2>/dev/null || true
          
          echo "打包 Docker 数据..."
          if sudo tar -c -I 'zstd' -f "$SNAPSHOT_DIR/docker_state.tar.${{ env.BACKUP_COMPRESSION }}" \
            /var/lib/docker/volumes /var/lib/docker/overlay2 2>/dev/null; then
            echo "✅ Docker 数据备份成功"
          else
            echo "⚠️ Docker 数据备份部分失败"
          fi
          
          echo "备份 CasaOS 状态..."
          sudo casaos version > "$SNAPSHOT_DIR/casaos_version.txt" 2>/dev/null || true
          sudo cp -r /etc/casaos "$SNAPSHOT_DIR/casaos_config" 2>/dev/null || true
          sudo cp -r /var/lib/casaos "$SNAPSHOT_DIR/casaos_data" 2>/dev/null || true
          
          echo "打包 CasaOS 数据..."
          if sudo tar -c -I 'zstd' -f "$SNAPSHOT_DIR/casaos_state.tar.${{ env.BACKUP_COMPRESSION }}" \
            /etc/casaos /var/lib/casaos 2>/dev/null; then
            echo "✅ CasaOS 数据备份成功"
          else
            echo "⚠️ CasaOS 数据备份部分失败"
          fi
          
          # 创建快照信息文件
          cat > "$SNAPSHOT_DIR/snapshot_info.json" << EOF
{
  "timestamp": "$(date -Iseconds)",
  "github_run_id": "${{ github.run_id }}",
  "github_run_number": "${{ github.run_number }}",
  "github_sha": "${{ github.sha }}",
  "github_ref": "${{ github.ref }}",
  "restored_from_backup": false,
  "tailscale_connected": "${{ env.TAILSCALE_CONNECTED }}",
  "tailscale_ip": "${{ env.TAILSCALE_IP }}",
  "backup_compression": "${{ env.BACKUP_COMPRESSION }}"
}
EOF
          
          echo "清理旧快照（保留最新的 ${{ env.SNAPSHOT_RETENTION }} 个）..."
          find "${{ env.WEBDAV_MOUNT_POINT }}/backups/snapshots" -maxdepth 1 -type d -name "2*" 2>/dev/null | \
            sort -r | tail -n +$(({{ env.SNAPSHOT_RETENTION }} + 1)) | xargs -r rm -rf
          
          echo "✅ 快照创建完成: $TIMESTAMP"
          
          echo "📊 快照内容:"
          ls -la "$SNAPSHOT_DIR/"
          echo ""
          echo "快照已保存到: $SNAPSHOT_DIR"
          echo "下次部署将自动从最新快照恢复"
