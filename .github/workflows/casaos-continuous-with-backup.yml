name: 1Panel-Docker-Snapshot-Backup-Restore
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_1panel_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu"
      CORE_BACKUP_DIRS: "/var/lib/docker /etc/docker /opt/1panel /usr/local/bin/1panel /etc/1panel /etc/systemd/system /DATA"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/var/lib/docker/tmp
        --exclude=/DATA/tmp --exclude=/DATA/ç¼“å­˜ --exclude=/DATA/logs
        --exclude=/opt/1panel/logs --exclude=/opt/1panel/tmp
        --exclude=/var/log/1panel/* --exclude=/etc/systemd/system/*.wants
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      PANEL_BIN_PATH: "/usr/local/bin/1panel"
      PANEL_SERVICE_PATH: "/etc/systemd/system/1panel.service"

    steps:
      - name: 1. Env Initialization (SSH + Encoding Compat)
        run: |
          set -euo pipefail  # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºé”™è¯¯æ£€æµ‹ï¼Œç®¡é“å¤±è´¥ç«‹å³é€€å‡º
          # SSHå…å¯†é…ç½®
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/g' /etc/ssh/sshd_config 2>/dev/null || true
          sudo systemctl restart sshd 2>/dev/null || true
          
          # ç³»ç»Ÿç›®å½•å‡†å¤‡
          sudo mkdir -p /etc/systemd/system /DATA 2>/dev/null || true
          sudo chmod 755 /DATA
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak 2>/dev/null || true
          
          # å†™å…¥Ubuntuæºï¼ˆä¿®å¤EOFå†²çªï¼Œå¢å¼ºå®¹é”™ï¼‰
          cat << 'EOF' | sudo tee /etc/apt/sources.list > /dev/null
          deb http://archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-backports main restricted universe multiverse
          EOF
          
          # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå¢åŠ é‡è¯•å’Œè¶…æ—¶ï¼‰
          sudo apt update -y || sudo apt update -y  # ğŸ”§ ä¿®å¤ï¼šé‡è¯•æ›´æ–°æº
          sudo apt install -y --no-install-recommends curl wget jq fuse3 tar gzip locales openssl dnsutils apt-transport-https ca-certificates gnupg lsb-release file iconv
          sudo locale-gen zh_CN.UTF-8 && export LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          curl -fsSL --connect-timeout 30 https://rclone.org/install.sh | sudo bash
          
          # Sudoå…å¯†é…ç½®ï¼ˆå¢å¼ºå®‰å…¨æ€§å’Œå®¹é”™ï¼‰
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers 2>/dev/null || true
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner > /dev/null
          sudo chmod 0440 /etc/sudoers.d/runner
          
          echo "âœ… Env Initialization Completed"

      - name: 2. Create roots User (Passwordless Sudo)
        run: |
          set -euo pipefail
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            echo "roots ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/roots > /dev/null
            sudo chmod 0440 /etc/sudoers.d/roots
            # ğŸ”§ ä¿®å¤ï¼šè®¾ç½®rootså¯†ç ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
            if [ -n "${ROOTS_PASSWORD:-}" ]; then
              echo "roots:${ROOTS_PASSWORD}" | sudo chpasswd
            fi
            echo "âœ… roots User Created"
          else
            echo "â„¹ï¸ roots User Exists, Skip"
          fi

      - name: 3. Configure WebDAV (Rclone)
        id: webdav-config
        run: |
          set -euo pipefail
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºWebDAVå‚æ•°æ ¡éªŒ
          if [ -z "${WEBDAV_URL:-}" ] || [ -z "${WEBDAV_USER:-}" ] || [ -z "${WEBDAV_PASSWORD:-}" ]; then
            echo "âŒ Missing WebDAV Credentials, Skip"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # ğŸ”§ ä¿®å¤ï¼šRcloneé…ç½®å¢å¼ºï¼ˆæŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé¿å…æƒé™é—®é¢˜ï¼‰
          RCLONE_CONFIG="/home/runner/.rclone.conf"
          sudo rm -f "$RCLONE_CONFIG" 2>/dev/null || true
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="generic" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config "$RCLONE_CONFIG"
          sudo chown runner:runner "$RCLONE_CONFIG" && sudo chmod 600 "$RCLONE_CONFIG"
          
          # ğŸ”§ ä¿®å¤ï¼šWebDAVè¿æ¥æµ‹è¯•ï¼ˆå¢åŠ è¶…æ—¶å’Œé‡è¯•ï¼‰
          if ! rclone ls --timeout 30s --retries 2 mywebdav:/ --config "$RCLONE_CONFIG" >/dev/null 2>&1; then
            echo "âŒ WebDAV Connection Failed"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # ğŸ”§ ä¿®å¤ï¼šè·¯å¾„å¤„ç†ï¼ˆå…¼å®¹æœ«å°¾æœ‰æ— /çš„æƒ…å†µï¼‰
          WEBDAV_SNAPSHOT_DIR_CLEAN=$(echo "$WEBDAV_SNAPSHOT_DIR" | sed -e 's/\/$//' -e 's/^\/\+//')
          # æŸ¥æ‰¾æœ€æ–°å¿«ç…§ï¼ˆå¢å¼ºåŒ¹é…è§„åˆ™ï¼‰
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN} --config "$RCLONE_CONFIG" | \
            grep -E "1panel-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz" | \
            awk -F '/' '{print $NF}' | sort -r | head -n1)
          
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "latest_snapshot=${WEBDAV_SNAPSHOT_DIR_CLEAN}/${LATEST_SNAPSHOT}" >> "$GITHUB_OUTPUT"
            echo "âœ… Latest Snapshotï¼š$LATEST_SNAPSHOT"
          else
            echo "â„¹ï¸ No Snapshot in WebDAV"
          fi
          echo "webdav_available=true" >> "$GITHUB_OUTPUT"
          echo "WEBDAV_SNAPSHOT_DIR_CLEAN=${WEBDAV_SNAPSHOT_DIR_CLEAN}" >> "$GITHUB_ENV"
          echo "RCLONE_CONFIG=${RCLONE_CONFIG}" >> "$GITHUB_ENV"  # ğŸ”§ ä¿®å¤ï¼šå¯¼å‡ºé…ç½®æ–‡ä»¶è·¯å¾„

      - name: 4. Restore Snapshot from WebDAV
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' && steps.webdav-config.outputs.latest_snapshot != '' }}
        id: restore
        run: |
          set -euo pipefail
          SNAPSHOT_PATH=${{ steps.webdav-config.outputs.latest_snapshot }}
          echo "===== Restore Snapshotï¼š$SNAPSHOT_PATH ====="
          
          # åœæ­¢æ‰€æœ‰æœåŠ¡ï¼ˆå¢å¼ºåœæ­¢é€»è¾‘ï¼‰
          sudo systemctl stop 1panel docker containerd 2>/dev/null || true
          sudo systemctl kill 1panel docker containerd 2>/dev/null || true
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          sudo pkill -9 docker containerd 1panel 2>/dev/null || true
          sudo systemctl reset-failed 1panel docker containerd 2>/dev/null || true
          sync && sleep 5
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå¿«ç…§å®Œæ•´æ€§æ ¡éªŒ
          echo "ğŸ” Checking snapshot integrity..."
          if ! rclone cat --timeout 60s mywebdav:${SNAPSHOT_PATH} --config "$RCLONE_CONFIG" | gzip -t; then
            echo "âŒ Snapshot Corrupted (gzip check failed)"
            echo "restore_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          # æ¢å¤å¿«ç…§ï¼ˆå¢åŠ è¿›åº¦è¾“å‡ºï¼Œå¢å¼ºæƒé™ï¼‰
          TEMP_SNAPSHOT="/tmp/snapshot.tar.gz"
          echo "ğŸ“¥ Downloading snapshot..."
          rclone cat --progress mywebdav:${SNAPSHOT_PATH} --config "$RCLONE_CONFIG" > "$TEMP_SNAPSHOT"
          
          echo "ğŸ”§ Extracting snapshot..."
          # ğŸ”§ ä¿®å¤ï¼šè§£å‹æ—¶å¢åŠ å®¹é”™ï¼Œåˆ†é˜¶æ®µè§£å‹
          sudo tar -xzf "$TEMP_SNAPSHOT" -C / --overwrite --ignore-failed-read -p --same-owner --warning=no-unknown-keyword
          rm -f "$TEMP_SNAPSHOT"
          
          # é‡è£…Dockerï¼ˆå¢å¼ºå…¼å®¹æ€§ï¼‰
          echo "ğŸ³ Reinstalling Docker..."
          sudo apt purge -y moby* containerd* runc* docker* || true
          sudo apt autoremove -y && sudo apt clean
          curl -fsSL --connect-timeout 30 https://get.docker.com | sudo bash
          
          # åˆ é™¤æ—§å¿«ç…§ï¼ˆå¢åŠ ç¡®è®¤ï¼‰
          echo "ğŸ—‘ï¸ Deleting old snapshot..."
          if rclone delete mywebdav:${SNAPSHOT_PATH} --config "$RCLONE_CONFIG"; then
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/snapshot_meta.txt --config "$RCLONE_CONFIG" || true
          fi
          
          echo "âœ… Snapshot Restored Successfully"
          echo "restore_success=true" >> "$GITHUB_OUTPUT"

      - name: 5. Clean Residues (Restore Failed)
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -euo pipefail
          echo "===== Clean Residues ====="
          # åœæ­¢æœåŠ¡
          sudo systemctl stop 1panel docker containerd 2>/dev/null || true
          sudo pkill -9 docker containerd 1panel 2>/dev/null || true
          sudo systemctl reset-failed 1panel docker containerd 2>/dev/null || true
          sync && sleep 3
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºDockeræ¸…ç†
          if command -v docker &>/dev/null; then
            sudo docker rm -f $(sudo docker ps -aq 2>/dev/null) 2>/dev/null || true
            sudo docker rmi -f $(sudo docker images -aq 2>/dev/null) 2>/dev/null || true
            sudo docker volume rm -f $(sudo docker volume ls -q 2>/dev/null) 2>/dev/null || true
            sudo docker system prune -af 2>/dev/null || true
          fi
          
          # æ¸…ç†1Panelç›¸å…³æ–‡ä»¶ï¼ˆå¢å¼ºè·¯å¾„è¦†ç›–ï¼‰
          sudo rm -rf /opt/1panel /etc/1panel /usr/bin/1panel /usr/local/bin/1panel \
            /etc/systemd/system/1panel.service /var/lib/docker /etc/docker /var/lib/containerd /DATA/*
          sudo apt purge -y docker* moby* containerd* runc* 1panel* -y || true
          sudo apt autoremove -y && sudo apt clean
          echo "âœ… Residues Cleaned"

      - name: 6. Install Docker+1Panel (Fresh Install)
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -euo pipefail
          echo "===== Install Docker ====="
          # é‡è£…Dockerï¼ˆå¢åŠ é‡è¯•ï¼‰
          sudo apt purge -y docker* moby* containerd* runc* -y || true
          sudo apt autoremove -y && sudo apt clean
          curl -fsSL --connect-timeout 30 https://get.docker.com | sudo bash || curl -fsSL --connect-timeout 30 https://get.docker.com | sudo bash
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºDockeræƒé™é…ç½®
          sudo usermod -aG docker runner || true
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          sudo systemctl enable --now docker.service containerd.service
          sleep 10
          
          # æ ¡éªŒDockerå¯åŠ¨
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Docker Start Failed"
            sudo journalctl -xeu docker.service --no-pager | head -30
            exit 1
          fi
          echo "âœ… Docker Installedï¼š$(docker -v)"
          
          # å®‰è£…1Panelï¼ˆå¢åŠ é‡è¯•å’Œä¿®å¤ï¼‰
          echo "===== Install 1Panel ====="
          curl -fsSL --connect-timeout 30 https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash - || \
            curl -fsSL --connect-timeout 30 https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash -
          sleep 10
          
          # ç”Ÿæˆæ­£ç¡®çš„1panel.serviceæ–‡ä»¶
          cat << 'EOF' | sudo tee $PANEL_SERVICE_PATH > /dev/null
          [Unit]
          Description=1Panel, a modern open source linux panel
          Documentation=https://1panel.cn/
          After=network.target docker.service containerd.service

          [Service]
          Type=simple
          User=root
          Group=root
          ExecStart=/usr/local/bin/1panel
          Restart=on-failure
          RestartSec=5s
          WorkingDirectory=/opt/1panel
          StandardOutput=journal+console

          [Install]
          WantedBy=multi-user.target
          EOF
          
          # é‡è½½é…ç½®å¹¶å¯åŠ¨1Panel
          sudo systemctl daemon-reload && sudo 1panel repair 2>/dev/null || true
          sudo systemctl start 1panel || true
          echo "âœ… 1Panel Installed (Correct Exec Path)"

      - name: 7. Fix & Restart Services (Restore Success)
        if: ${{ steps.restore.outputs.restore_success == 'true' }}
        run: |
          set -euo pipefail
          echo "===== Fix 1Panel Core Issues ====="
          
          # ä¿®å¤Docker/containerdä¾èµ–
          for service in docker.service containerd.service; do
            sudo systemctl reset-failed "$service" 2>/dev/null || true
            sudo systemctl enable --now "$service" 2>/dev/null || true
            sleep 5
          done
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºserviceæ–‡ä»¶å¤„ç†
          if [ -f "$PANEL_SERVICE_PATH" ]; then
            sudo cp "$PANEL_SERVICE_PATH" "${PANEL_SERVICE_PATH}.bak" 2>/dev/null || true
          fi
          
          # ç”Ÿæˆæ­£ç¡®çš„serviceæ–‡ä»¶
          cat << 'EOF' | sudo tee $PANEL_SERVICE_PATH > /dev/null
          [Unit]
          Description=1Panel, a modern open source linux panel
          Documentation=https://1panel.cn/
          After=network.target docker.service containerd.service

          [Service]
          Type=simple
          User=root
          Group=root
          ExecStart=/usr/local/bin/1panel
          Restart=on-failure
          RestartSec=5s
          WorkingDirectory=/opt/1panel
          StandardOutput=journal+console

          [Install]
          WantedBy=multi-user.target
          EOF
          
          echo "âœ… Fixed 1panel.service Path: /usr/local/bin/1panel"
          
          # ä¿®å¤1Panelå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¢å¼ºæ£€æµ‹ï¼‰
          if [ ! -f "$PANEL_BIN_PATH" ] || [ ! -x "$PANEL_BIN_PATH" ]; then
            echo "âš ï¸ 1Panel Binary Missing/Not Executable, Reinstall"
            curl -fsSL --connect-timeout 30 https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash -s -- --repair
          else
            sudo chmod +x "$PANEL_BIN_PATH"
            # æ¶æ„æ£€æŸ¥ï¼ˆæ›´ç²¾å‡†ï¼‰
            if file "$PANEL_BIN_PATH" | grep -qi "arm\|aarch64" && [ "$(uname -m)" = "x86_64" ]; then
              echo "âš ï¸ ARM Binary on x86_64, Reinstall"
              sudo rm -f "$PANEL_BIN_PATH"
              curl -fsSL --connect-timeout 30 https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash -s -- --repair
            fi
          fi
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼º1Panelå¯åŠ¨é‡è¯•é€»è¾‘
          sudo systemctl stop 1panel 2>/dev/null || true
          sudo systemctl reset-failed 1panel 2>/dev/null || true
          sudo systemctl daemon-reload && sleep 5
          
          panel_active=false
          for retry in {1..5}; do  # ğŸ”§ ä¿®å¤ï¼šå¢åŠ é‡è¯•æ¬¡æ•°åˆ°5æ¬¡
            echo "â„¹ï¸ 1Panel Retry $retry/5..."
            sudo systemctl start 1panel
            sleep 8
            if sudo systemctl is-active --quiet 1panel; then
              panel_active=true
              break
            fi
          done
          
          # æœ€ç»ˆå…œåº•ä¿®å¤
          if [ "$panel_active" = "false" ]; then
            echo "âš ï¸ Final 1Panel Repair"
            curl -fsSL --connect-timeout 30 https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash -s -- --repair
            sudo systemctl daemon-reload && sleep 5
            sudo systemctl restart 1panel
            sleep 5
            if ! sudo systemctl is-active --quiet 1panel; then
              echo "âŒ 1Panel Failedï¼š"
              sudo journalctl -xeu 1panel.service --no-pager | head -30 | iconv -f utf-8 -t utf-8 -c 2>/dev/null
              exit 1
            fi
          fi
          
          # éªŒè¯æœ€ç»ˆçŠ¶æ€
          echo "===== Service Status ====="
          sudo systemctl status 1panel --no-pager | head -20
          sudo systemctl status docker --no-pager | head -20
          echo "âœ… All Services Restarted Successfully"

      - name: 8. Deploy Tailscale (Optional)
        run: |
          set -euo pipefail
          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "âš ï¸ Missing Tailscale Key, Skip"
            exit 0
          fi
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºTailscaleå®‰è£…
          curl -fsSL --connect-timeout 30 https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list > /dev/null
          sudo apt update -y && sudo apt install -y tailscale
          # å¯åŠ¨Tailscaleï¼ˆå¢åŠ å‚æ•°ï¼‰
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --accept-dns=false --hostname="1panel-snapshot-${{ github.run_id }}"
          TS_IP=$(sudo tailscale ip -4 2>/dev/null | head -n1)
          echo "âœ… Tailscale IPï¼š$TS_IP"

      - name: 9. Create & Upload Snapshot
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' }}
        run: |
          set -euo pipefail
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå®¹å™¨æ¸…ç†å‡½æ•°
          stop_old_containers() {
            if command -v docker &>/dev/null && sudo docker info >/dev/null 2>&1; then
              OLD_CONTAINERS=$(sudo docker ps -aq 2>/dev/null)
              if [ -n "$OLD_CONTAINERS" ]; then
                sudo docker rm -f $OLD_CONTAINERS && echo "âœ… Old Containers Cleaned"
              fi
            fi
          }
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºç»­è·‘è§¦å‘å‡½æ•°
          trigger_renew() {
            if [ -z "${USER_PAT:-}" ] || [ -z "${REPO:-}" ]; then
              echo "âŒ Missing PAT/Repo, Skip Renew"
              return 1
            fi
            stop_old_containers
            # è§¦å‘ä»“åº“äº‹ä»¶ï¼ˆå¢åŠ è¶…æ—¶å’Œé‡è¯•ï¼‰
            if curl -fsSL --connect-timeout 30 --retry 2 --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_1panel_snapshot"}'; then
              echo "âœ… Renew Triggered"
              RENEW_TRIGGERED=true
            else
              echo "âŒ Renew Trigger Failed"
            fi
          }
          
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå¿«ç…§åˆ›å»ºå‡½æ•°
          create_snapshot() {
            # ç­›é€‰å­˜åœ¨çš„ç›®å½•
            VALID_DIRS=""
            for dir in $CORE_BACKUP_DIRS; do
              if [ -d "$dir" ] || [ -f "$dir" ]; then
                VALID_DIRS="$VALID_DIRS $dir"
              fi
            done
            if [ -z "$VALID_DIRS" ]; then
              echo "âŒ No Valid Paths to Backup"
              return 1
            fi
            
            SNAPSHOT_NAME="1panel-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/$SNAPSHOT_NAME"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/$SNAPSHOT_NAME"
            
            # åœæ­¢æœåŠ¡ä¿è¯ä¸€è‡´æ€§
            echo "ğŸ›‘ Stopping services for snapshot..."
            sudo systemctl stop 1panel docker containerd 2>/dev/null || true
            sudo pkill -9 docker containerd 1panel 2>/dev/null || true
            sync && sleep 5
            
            # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºæ‰“åŒ…é€»è¾‘ï¼ˆå¢åŠ å‹ç¼©çº§åˆ«ï¼Œæ’é™¤ç©ºç›®å½•ï¼‰
            echo "ğŸ“¦ Creating snapshot: $SNAPSHOT_NAME"
            sudo tar -czpf "$TMP_SNAPSHOT" -z --level=6 \
              --ignore-failed-read -p --same-owner --acls --xattrs \
              $EXCLUDE_RULES $VALID_DIRS || {
              echo "âŒ Tar Failed"
              return 1
            }
            
            # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå¿«ç…§æ ¡éªŒï¼ˆå¤§å°+å®Œæ•´æ€§ï¼‰
            SNAPSHOT_SIZE=$(stat -c%s "$TMP_SNAPSHOT" 2>/dev/null || echo 0)
            if [ "$SNAPSHOT_SIZE" -lt 10240 ]; then  # æœ€å°10KB
              echo "âŒ Invalid Snapshot (Too Small: $SNAPSHOT_SIZE bytes)"
              rm -f "$TMP_SNAPSHOT"
              return 1
            fi
            # æ ¡éªŒgzipå®Œæ•´æ€§
            if ! gzip -t "$TMP_SNAPSHOT"; then
              echo "âŒ Snapshot Corrupted (gzip check failed)"
              rm -f "$TMP_SNAPSHOT"
              return 1
            fi
            
            sudo chown runner:runner "$TMP_SNAPSHOT"
            
            # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºä¸Šä¼ é€»è¾‘ï¼ˆå¢åŠ è¿›åº¦å’Œé‡è¯•ï¼‰
            echo "ğŸ“¤ Uploading snapshot to WebDAV..."
            if ! sudo -u runner rclone copy --progress --transfers 2 --retries 2 "$TMP_SNAPSHOT" "$REMOTE_PATH" --config "$RCLONE_CONFIG"; then
              echo "âŒ Upload Failed"
              rm -f "$TMP_SNAPSHOT"
              return 1
            fi
            
            # ç”Ÿæˆå…ƒæ•°æ®ï¼ˆå¢å¼ºä¿¡æ¯ï¼‰
            printf "snapshot_name=%s\ncreate_time=%s\nsnapshot_size_bytes=%s\nsnapshot_size_human=%s\ndocker_version=%s\n1panel_version=%s\nhostname=%s\narch=%s\n" \
              "$SNAPSHOT_NAME" \
              "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              "$SNAPSHOT_SIZE" \
              "$(du -sh "$TMP_SNAPSHOT" | awk '{print $1}')" \
              "$(docker -v 2>/dev/null | awk '{print $3}' | sed 's/,//g' || echo 'unknown')" \
              "$(1panel -v 2>/dev/null | awk '{print $3}' || echo 'unknown')" \
              "$(hostname)" \
              "$(uname -m)" | sudo tee /tmp/snapshot_meta.txt > /dev/null
            
            # ä¸Šä¼ å…ƒæ•°æ®
            sudo -u runner rclone copy /tmp/snapshot_meta.txt "mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/snapshot_meta.txt" --config "$RCLONE_CONFIG"
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¹¶é‡å¯æœåŠ¡
            rm -f "$TMP_SNAPSHOT" /tmp/snapshot_meta.txt
            echo "ğŸ”„ Restarting services..."
            sudo systemctl start docker containerd 2>/dev/null || true
            sleep 5
            sudo systemctl start 1panel 2>/dev/null || true
            
            echo "âœ… Snapshot Uploaded: $SNAPSHOT_NAME (Size: $(du -sh "$TMP_SNAPSHOT" 2>/dev/null | awk '{print $1}'))"
            return 0
          }
          
          # ä¸»å¾ªç¯ï¼ˆå¢å¼ºæ—¥å¿—ï¼‰
          echo "ğŸ”„ Starting snapshot loop (max $MAX_RUN_MINUTES mins)..."
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "â±ï¸ Running Timeï¼š$run_mins / $MAX_RUN_MINUTES Mins | Renew Triggered: $RENEW_TRIGGERED"
            
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              if create_snapshot; then
                trigger_renew
              else
                echo "âš ï¸ Snapshot creation failed, will retry in 5 mins"
                sleep 300  # 5åˆ†é’Ÿåé‡è¯•
              fi
            fi
            
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Timeout ($MAX_RUN_MINUTES mins), Exit"
              exit 0
            fi
            sleep 60
          done

      - name: 10. Clean Temp Files (Always Execute)
        if: ${{ always() }}
        run: |
          set -euo pipefail
          # ğŸ”§ ä¿®å¤ï¼šå¢å¼ºæ¸…ç†é€»è¾‘
          echo "ğŸ§¹ Cleaning temporary files..."
          sudo rm -rf /tmp/1panel-snapshot-*.tar.gz /tmp/snapshot_meta.txt "$RCLONE_CONFIG" /etc/sudoers.d/runner /etc/sudoers.d/roots
          sudo rm -rf /tmp/rclone* /tmp/tar*
          
          # æ¢å¤æœåŠ¡çŠ¶æ€
          sudo systemctl unmask docker.socket containerd.socket 2>/dev/null || true
          sudo systemctl reset-failed 1panel docker containerd 2>/dev/null || true
          
          # æ¢å¤SSHé…ç½®ï¼ˆæ›´ç²¾å‡†ï¼‰
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config 2>/dev/null || true
          sudo systemctl restart sshd 2>/dev/null || true
          
          # æ¸…ç†aptç¼“å­˜
          sudo apt clean || true
          
          echo "âœ… All Temp Files Cleaned"
          echo "âœ… SSH Config Restored"
