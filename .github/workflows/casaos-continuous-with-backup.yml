name: CasaOS-Server-Snapshot-Backup-Restore

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # ç»­è·‘è§¦å‘ç±»å‹

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      CORE_DIRS: "/var/lib /DATA"  # éœ€å¤‡ä»½çš„æ ¸å¿ƒç›®å½•
      SNAPSHOT_NAME: "casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"  # å¸¦æ—¶é—´æˆ³å¿«ç…§å
      # å…¨å±€è¿‡æ»¤è§„åˆ™ï¼šæ’é™¤æ—¥å¿—ã€ç¼“å­˜ã€Dockerå†—ä½™æ–‡ä»¶
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp --exclude=$WEBDAV_MOUNT_POINT
      # GitHub Secrets é…ç½®é¡¹
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      # ========== 1. ç¯å¢ƒåˆå§‹åŒ– & ä¾èµ–å®‰è£… ==========
      - name: Env Init & Create Required Dirs
        run: |
          set -e
          # å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip
          # å®‰è£… rclone ç”¨äº WebDAV ä¼ è¾“
          curl https://rclone.org/install.sh | sudo bash
          # é…ç½® fuse å’Œ sudo å…å¯†
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          # åˆ›å»º DATA ç›®å½•
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ… Environment initialized successfully"

      # ========== 2. åˆ›å»º roots è°ƒè¯•ç”¨æˆ· ==========
      - name: Create roots Debug User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots user created, password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi
          echo "âœ… roots user is ready"

      # ========== 3. æŒ‚è½½ WebDAV å­˜å‚¨ ==========
      - name: Mount WebDAV Storage
        run: |
          set -e
          # æ£€æŸ¥ WebDAV å¯†é’¥é…ç½®
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets not configured"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # é…ç½® rclone å¹¶æŒ‚è½½ WebDAV
          mkdir -p "$WEBDAV_MOUNT_POINT"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" vendor="other" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf

          # åå°æŒ‚è½½ WebDAVï¼Œä»…è®°å½•é”™è¯¯
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" \
            --config /home/runner/.rclone.conf --vfs-cache-mode full \
            --daemon-timeout 1h --allow-other --log-level ERROR >/dev/null 2>&1 &

          # æ£€æŸ¥æŒ‚è½½çŠ¶æ€ï¼ˆé‡è¯•5æ¬¡ï¼‰
          for i in $(seq 1 5); do
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              echo "âœ… WebDAV mounted successfully"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              # æ£€æµ‹æœ€æ–°å¿«ç…§
              if ls "$WEBDAV_MOUNT_POINT"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_MOUNT_POINT"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "âœ… Found latest snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ No historical snapshot found"
              fi
              exit 0
            fi
            sleep 10
          done
          echo "âŒ WebDAV mount failed after 5 attempts"
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      # ========== 4. å¿«ç…§æ¢å¤ & æ¢å¤åè‡ªåŠ¨åˆ é™¤å¿«ç…§ ==========
      - name: Restore Snapshot & Delete Used File
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== Start restoring from snapshot: $LATEST_SNAPSHOT ====="
          # åœæ­¢æœåŠ¡é¿å…æ–‡ä»¶å ç”¨
          sudo systemctl stop docker casaos || true
          # è§£å‹å¿«ç…§åˆ°æ ¹ç›®å½•ï¼Œå¼ºåˆ¶è¦†ç›–
          sudo tar -xzf "$LATEST_SNAPSHOT" -C / --overwrite --exclude-from=<(echo "$EXCLUDE_RULES" | tr ' ' '\n')
          
          if [ $? -eq 0 ]; then
            echo "âœ… Snapshot restored successfully"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # åˆ é™¤å·²ä½¿ç”¨çš„å¿«ç…§å’Œå…ƒä¿¡æ¯
            echo "ğŸ”„ Deleting used snapshot file..."
            sudo rm -f "$LATEST_SNAPSHOT" "$WEBDAV_MOUNT_POINT/snapshot_meta.txt"
            [ $? -eq 0 ] && echo "âœ… Used snapshot deleted" || echo "âš ï¸ Failed to delete snapshot"
          else
            echo "âŒ Snapshot restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          fi

      # ========== 5. å®‰è£… CasaOSï¼ˆæ— å¿«ç…§æ—¶æ‰§è¡Œï¼‰ ==========
      - name: Install CasaOS If No Snapshot
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          echo "===== Installing CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash || {
            echo "âŒ CasaOS installation failed"
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed successfully"

      # ========== 6. å¯åŠ¨ Docker & CasaOS æœåŠ¡ ==========
      - name: Start Docker & CasaOS Services
        run: |
          set -e
          echo "===== Starting services ====="
          # é‡è¯•3æ¬¡å¯åŠ¨æœåŠ¡
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker casaos
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Docker & CasaOS started successfully"
              exit 0
            fi
            echo "âš ï¸ Service start attempt $i failed, retrying..."
            sudo systemctl restart docker casaos
          done
          echo "âŒ Failed to start services after 3 attempts"
          exit 1

      # ========== 7. éƒ¨ç½² Tailscale ç½‘ç»œ ==========
      - name: Deploy Tailscale Network
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscale key not configured, skip deployment"
            exit 0
          fi
          # å®‰è£…å¹¶å¯åŠ¨ Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"
          TAILSCALE_IP=$(sudo tailscale ip -4)
          echo "âœ… Tailscale deployed successfully, IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== 8. åˆ›å»ºå¿«ç…§ + ä¸Šä¼  WebDAV + å®šæ—¶ç»­è·‘ ==========
      - name: Create Snapshot & Upload & Renew Workflow
        shell: bash
        run: |
          set -e
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘è§¦å‘å‡½æ•°
          trigger_renew() {
            if [ -n "$USER_PAT" ] && [ -n "$REPO" ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              curl -fsS -X POST -H "Authorization: token $USER_PAT" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/dispatches" \
                -d '{"event_type":"renew_casaos_snapshot"}'
              [ $? -eq 0 ] && echo "âœ… Workflow renew triggered" && RENEW_TRIGGERED=true
            fi
          }

          # å¿«ç…§åˆ›å»ºå‡½æ•°
          create_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAV not available, skip snapshot creation"
              return 1
            fi
            # åœæ­¢æœåŠ¡é¿å…æ–‡ä»¶é”å®š
            sudo systemctl stop docker casaos || true
            # æ‰“åŒ…å¹¶å‹ç¼©æ ¸å¿ƒç›®å½•
            echo "ğŸ”„ Creating snapshot: $SNAPSHOT_NAME"
            sudo tar -czf "/tmp/$SNAPSHOT_NAME" $EXCLUDE_RULES $CORE_DIRS
            
            if [ $? -eq 0 ]; then
              # ä¸Šä¼ åˆ° WebDAV
              echo "ğŸ”„ Uploading snapshot to WebDAV..."
              cp "/tmp/$SNAPSHOT_NAME" "$WEBDAV_MOUNT_POINT/"
              if [ $? -eq 0 ]; then
                echo "âœ… Snapshot uploaded: $(du -sh /tmp/$SNAPSHOT_NAME | awk '{print $1}')"
                # å†™å…¥å¿«ç…§å…ƒä¿¡æ¯
                echo "snapshot_name=$SNAPSHOT_NAME" > "$WEBDAV_MOUNT_POINT/snapshot_meta.txt"
                echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$WEBDAV_MOUNT_POINT/snapshot_meta.txt"
                echo "runner_id=${{ github.run_id }}" >> "$WEBDAV_MOUNT_POINT/snapshot_meta.txt"
              else
                echo "âŒ Snapshot upload failed"
                return 1
              fi
            else
              echo "âŒ Snapshot creation failed"
              return 1
            fi
            # é‡å¯æœåŠ¡
            sudo systemctl start docker casaos
            return 0
          }

          # ä¿æ´»é€»è¾‘ï¼šè¿è¡Œ10åˆ†é’Ÿååˆ›å»ºå¿«ç…§å¹¶ç»­è·‘
          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "ğŸ“Š Workflow running for $run_mins minutes"

            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Time to create snapshot and renew workflow"
              if create_snapshot; then
                trigger_renew
              fi
            fi

            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Workflow timeout reached, exiting"
              exit 0
            fi
            sleep 60
          done

      # ========== 9. ç¯å¢ƒæ¸…ç†ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰ ==========
      - name: Cleanup Workspace
        if: ${{ always() }}
        run: |
          set -e
          # å¸è½½ WebDAV
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT"
          fi
          # åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œé…ç½®
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner
          echo "âœ… Workspace cleaned up successfully"
