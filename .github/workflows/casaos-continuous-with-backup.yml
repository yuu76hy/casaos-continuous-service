name: Docker-TTA-Full-Snapshot-Backup-Restore
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_docker_tta_snapshot]

jobs:
  docker-tta-snapshot:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/z/Ubu"
      # ä»…å¤‡ä»½ï¼šDockerå…¨æ ¸å¿ƒç›®å½• + /TTA
      DOCKER_TTA_FULL_DIRS: |
        /var/lib/docker
        /etc/docker
        /usr/bin/docker
        /usr/bin/docker-compose
        /usr/bin/containerd
        /usr/bin/ctr
        /usr/lib/systemd/system/docker.service
        /usr/lib/systemd/system/docker.socket
        /usr/lib/systemd/system/containerd.service
        /etc/systemd/system/docker.service.d
        /etc/containerd
        /var/run/docker
        /var/run/containerd
        /etc/crictl.yaml
        /usr/share/keyrings/docker-archive-keyring.gpg
        /etc/apt/sources.list.d/docker.list
        /TTA
      # ä»…æ’é™¤Dockeræ— ç”¨æ—¥å¿—/ä¸´æ—¶æ–‡ä»¶ï¼Œ/TTAæ— æ’é™¤
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.swp
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
      DOCKER_HOST: unix:///var/run/docker.sock
      CONTAINERD_ADDRESS: /run/containerd/containerd.sock
    secrets:
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: 1. Env Init & Install Dependencies
        run: |
          set -e
          # æå‰åˆ›å»ºDockeræ ¸å¿ƒ+/TTAç›®å½•ï¼Œé˜²æ­¢ç¼ºå¤±
          sudo mkdir -p /etc/docker /etc/systemd/system/docker.service.d /etc/containerd /var/lib/docker /var/run/docker /var/run/containerd /TTA
          # æ›¿æ¢Ubuntuæºï¼Œæå‡å®‰è£…é€Ÿåº¦
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb http://archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ noble-backports main restricted universe multiverse
          EOF
          # å®‰è£…å…¨é‡åŸºç¡€ä¾èµ–
          sudo apt update -y && sudo apt install -y \
            curl wget jq fuse3 tar gzip locales openssl dnsutils apt-transport-https \
            ca-certificates gnupg lsb-release file lsof util-linux coreutils
          # é…ç½®ä¸­æ–‡+ä¸Šæµ·æ—¶åŒº
          sudo locale-gen zh_CN.UTF-8 && export LC_ALL=zh_CN.UTF-8 LANG=zh_CN.UTF-8
          sudo timedatectl set-timezone Asia/Shanghai
          # å®‰è£…rcloneï¼ˆWebDAVå¤§æ–‡ä»¶ä¼ è¾“ï¼‰
          curl -fsSL https://rclone.org/install.sh | sudo bash
          # é…ç½®sudoå…å¯†ï¼Œè‡ªåŠ¨åŒ–å¿…å¤‡
          if grep -q "requiretty" /etc/sudoers 2>/dev/null; then
            sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          fi
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          # ç½‘ç»œæ£€æµ‹
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼Œç½‘ç»œæ£€æµ‹ï¼š"
          curl -fsSL https://github.com >/dev/null 2>&1 && echo "âœ… GitHub è¿é€šæ­£å¸¸"
          curl -fsSL https://docker.com >/dev/null 2>&1 && echo "âœ… Docker å®˜ç½‘ è¿é€šæ­£å¸¸"

      - name: 2. Create Roots User (Optional)
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            echo "roots:${{ secrets.ROOTS_PASSWORD:-$(openssl rand -base64 16) }}" | sudo chpasswd
            sudo usermod -aG sudo,docker roots
            echo "âœ… roots ç”¨æˆ·åˆ›å»ºå®Œæˆ"
          else
            echo "â„¹ï¸ roots ç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: 3. Configure WebDAV (Rclone Full Config)
        id: webdav-config
        run: |
          set -e
          # æ£€æµ‹WebDAVå¯†é’¥å®Œæ•´æ€§
          if [ -z "${{ secrets.WEBDAV_URL }}" ] || [ -z "${{ secrets.WEBDAV_USER }}" ] || [ -z "${{ secrets.WEBDAV_PASSWORD }}" ]; then
            echo "âŒ WebDAV å¯†é’¥æœªé…ç½®ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # é…ç½®Rclone WebDAVï¼ˆå¤§æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–ï¼‰
          ENCRYPTED_PASS=$(rclone obscure "${{ secrets.WEBDAV_PASSWORD }}")
          cat <<EOF | sudo tee /home/runner/.rclone.conf
          [mywebdav]
          type = webdav
          url = ${{ secrets.WEBDAV_URL }}
          vendor = generic
          user = ${{ secrets.WEBDAV_USER }}
          pass = $ENCRYPTED_PASS
          buffer_size = 100M
          chunk_size = 50M
          EOF
          sudo chown runner:runner /home/runner/.rclone.conf && sudo chmod 600 /home/runner/.rclone.conf
          # æ£€æµ‹WebDAVè¿é€šæ€§+å¯å†™æ€§
          echo "âœ… æ£€æµ‹WebDAVè¿é€šæ€§..."
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAV è¿æ¥å¤±è´¥"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "âœ… æ£€æµ‹WebDAVå¯å†™æ€§..."
          echo "docker-tta-snapshot-test" | sudo tee /tmp/webdav-test.txt
          if ! rclone copy /tmp/webdav-test.txt mywebdav:/ --config /home/runner/.rclone.conf; then
            echo "âŒ WebDAV æ— å†™å…¥æƒé™"
            echo "webdav_available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          sudo rclone delete mywebdav:/webdav-test.txt --config /home/runner/.rclone.conf && rm -f /tmp/webdav-test.txt
          # æŸ¥æ‰¾æœ€æ–°Docker+TTAå¿«ç…§
          WEBDAV_SNAPSHOT_DIR_CLEAN=$(echo "$WEBDAV_SNAPSHOT_DIR" | sed 's/\/$//')
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN} --config /home/runner/.rclone.conf \
            | grep "docker-tta-full-snapshot-.*.tar.gz" | awk -F '/' '{print $NF}' | sort -r | head -n1)
          # ä¼ é€’å¿«ç…§ä¿¡æ¯
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "latest_snapshot=${WEBDAV_SNAPSHOT_DIR_CLEAN}/${LATEST_SNAPSHOT}" >> "$GITHUB_OUTPUT"
            echo "âœ… æ‰¾åˆ°æœ€æ–°Docker+TTAå®Œæ•´å¿«ç…§ï¼š$LATEST_SNAPSHOT"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°Docker+TTAå¿«ç…§ï¼Œå°†å®‰è£…å…¨æ–°å®˜æ–¹Docker"
          fi
          echo "webdav_available=true" >> "$GITHUB_OUTPUT"
          echo "WEBDAV_SNAPSHOT_DIR_CLEAN=${WEBDAV_SNAPSHOT_DIR_CLEAN}" >> "$GITHUB_ENV"

      - name: 4. Restore Docker+TTA Full Snapshot (1:1 å®Œæ•´æ¢å¤)
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' && steps.webdav-config.outputs.latest_snapshot != '' }}
        id: restore
        run: |
          set -e
          SNAPSHOT_PATH=${{ steps.webdav-config.outputs.latest_snapshot }}
          echo "===== å¼€å§‹1:1å®Œæ•´æ¢å¤Docker+TTAå¿«ç…§ï¼š$SNAPSHOT_PATH ====="
          # å¼ºåˆ¶åœæ­¢æ‰€æœ‰Dockerè¿›ç¨‹ï¼Œé¿å…æ¢å¤å†²çª
          sudo systemctl stop docker containerd docker.socket 2>/dev/null || true
          sudo pkill -9 docker containerd ctr dockerd 2>/dev/null || true
          sudo umount /var/lib/docker/* 2>/dev/null || true
          sync && sleep 5
          # æ£€æµ‹å¿«ç…§å®Œæ•´æ€§
          echo "âœ… æ£€æµ‹å¿«ç…§å®Œæ•´æ€§..."
          if ! rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf | head -c 1024 >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåï¼Œæ¢å¤å¤±è´¥"
            echo "restore_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          SNAPSHOT_SIZE=$(rclone size mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf | grep "Total size" | awk '{print $3$4}')
          echo "âœ… å¿«ç…§å¤§å°ï¼š$SNAPSHOT_SIZEï¼Œå¼€å§‹ä¸‹è½½å¹¶æ¢å¤..."
          # 1:1è§£å‹æ¢å¤ï¼ˆä¿ç•™æ‰€æœ‰æƒé™/è½¯é“¾æ¥/å±æ€§ï¼‰
          TEMP_SNAPSHOT="/tmp/docker-tta-full-snapshot.tar.gz"
          rclone cat mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf > "$TEMP_SNAPSHOT"
          sudo tar -xzf "$TEMP_SNAPSHOT" -C / \
            --overwrite \
            --ignore-failed-read \
            -p \
            --same-owner \
            --preserve-links \
            --acls \
            --xattrs
          rm -f "$TEMP_SNAPSHOT"
          # ä¿®å¤Docker+TTAå…¨ç›®å½•æƒé™/å±ä¸»
          echo "âœ… ä¿®å¤Docker+TTAå…¨ç›®å½•æƒé™..."
          sudo chown -R root:root \
            /var/lib/docker /etc/docker /etc/containerd /usr/bin/docker* /usr/bin/containerd* /usr/bin/ctr \
            /usr/lib/systemd/system/docker* /usr/lib/systemd/system/containerd.service /etc/systemd/system/docker.service.d \
            /TTA
          sudo chmod -R 755 \
            /var/lib/docker /etc/docker /etc/containerd /usr/bin/docker* /usr/bin/containerd* /usr/bin/ctr \
            /TTA
          sudo chmod 644 /usr/lib/systemd/system/docker* /usr/lib/systemd/system/containerd.service /etc/crictl.yaml
          sudo chmod 700 /var/lib/docker /var/run/docker /var/run/containerd
          # é‡æ–°åŠ è½½systemdé…ç½®
          sudo systemctl daemon-reload
          sudo systemctl reset-failed docker containerd docker.socket 2>/dev/null || true
          # æ£€æµ‹DockeräºŒè¿›åˆ¶å®Œæ•´æ€§
          if ! /usr/bin/docker --version >/dev/null 2>&1; then
            echo "âŒ DockeräºŒè¿›åˆ¶æ–‡ä»¶æŸåï¼Œæ¢å¤å¤±è´¥"
            echo "restore_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          # åˆ é™¤è¿œç«¯æ—§å¿«ç…§
          sudo rclone delete mywebdav:${SNAPSHOT_PATH} --config /home/runner/.rclone.conf
          sudo rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/docker-tta-snapshot-meta.txt --config /home/runner/.rclone.conf
          echo "âœ… Docker+TTAå¿«ç…§1:1æ¢å¤å®Œæˆï¼Œå¯ç›´æ¥å¯åŠ¨Docker"
          echo "restore_success=true" >> "$GITHUB_OUTPUT"

      - name: 5. Clean Docker Residues (Restore Failed)
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== æ¸…ç†Dockeræ‰€æœ‰æ®‹ç•™ ====="
          # å¼ºåˆ¶åœæ­¢+å½»åº•å¸è½½Docker
          sudo systemctl stop docker containerd docker.socket 2>/dev/null || true
          sudo pkill -9 docker containerd ctr dockerd 2>/dev/null || true
          sudo apt purge -y docker* moby* containerd* runc* docker-compose-plugin* -y || true
          sudo apt autoremove -y --purge && sudo apt clean
          # åˆ é™¤Dockerç›¸å…³ç›®å½•ï¼Œä¿ç•™/TTA
          sudo rm -rf /var/lib/docker /etc/docker /etc/containerd /usr/bin/docker* /usr/bin/containerd* \
            /usr/lib/systemd/system/docker* /usr/lib/systemd/system/containerd.service \
            /etc/systemd/system/docker.service.d /var/run/docker /var/run/containerd /etc/crictl.yaml \
            /usr/share/keyrings/docker-* /etc/apt/sources.list.d/docker.list /tmp/docker* 2>/dev/null || true
          echo "âœ… Dockeræ®‹ç•™æ¸…ç†å®Œæˆï¼Œ/TTAç›®å½•å·²ä¿ç•™"

      - name: 6. Install Official Docker (Full Version, No Snapshot)
        if: ${{ steps.restore.outputs.restore_success != 'true' }}
        run: |
          set -e
          echo "===== å®‰è£…å®˜æ–¹å®Œæ•´Dockerï¼ˆå«containerd+docker-composeï¼‰ ====="
          # é…ç½®Dockerå®˜æ–¹æº
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          # å…¨é‡å®‰è£…Dockerç»„ä»¶
          sudo apt update -y && sudo apt install -y \
            docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-buildx-plugin
          # é…ç½®å¼€æœºè‡ªå¯+æƒé™
          sudo systemctl enable --now docker containerd docker.socket
          sudo usermod -aG docker runner
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          # ä¼˜åŒ–Dockeré…ç½®
          sudo cat <<EOF | sudo tee /etc/docker/daemon.json
          {
            "log-driver": "json-file",
            "log-opts": {"max-size": "100m", "max-file": "3"},
            "registry-mirrors": ["https://docker.mirrors.ustc.edu.cn"],
            "insecure-registries": [],
            "storage-driver": "overlay2"
          }
          EOF
          sudo systemctl restart docker
          # éªŒè¯Dockerå®Œæ•´æ€§
          sleep 10
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ Dockerå®‰è£…å¤±è´¥ï¼ŒæœåŠ¡æ— æ³•å¯åŠ¨"
            sudo systemctl status docker --no-pager
            exit 1
          fi
          if ! docker compose version >/dev/null 2>&1 || ! containerd -v >/dev/null 2>&1; then
            echo "âŒ Dockerç»„ä»¶ç¼ºå¤±ï¼Œå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… å®˜æ–¹å®Œæ•´Dockerå®‰è£…å®Œæˆï¼š"
          echo "Docker ç‰ˆæœ¬ï¼š$(docker -v)"
          echo "Docker Compose ç‰ˆæœ¬ï¼š$(docker compose version | head -n1)"
          echo "Containerd ç‰ˆæœ¬ï¼š$(containerd -v)"
          echo "restore_success=true" >> "$GITHUB_OUTPUT"

      - name: 7. Start Docker & Full Verify (Docker+TTA å®Œæ•´æ€§éªŒè¯)
        if: ${{ steps.restore.outputs.restore_success == 'true' }}
        run: |
          set -e
          echo "===== å¯åŠ¨Dockerå¹¶éªŒè¯Docker+TTAå®Œæ•´æ€§ ====="
          # å¯åŠ¨Dockeræ ¸å¿ƒæœåŠ¡
          sudo systemctl enable --now docker containerd docker.socket
          sleep 8
          # éªŒè¯1ï¼šæœåŠ¡çŠ¶æ€
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè°ƒè¯•ä¿¡æ¯ï¼š"
            sudo systemctl status docker --no-pager
            sudo journalctl -u docker --no-pager | tail -30
            exit 1
          fi
          # éªŒè¯2ï¼šDockerå‘½ä»¤å¯ç”¨
          if ! docker info >/dev/null 2>&1; then
            echo "âŒ Dockerå‘½ä»¤æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
          # éªŒè¯3ï¼šåˆ›å»ºæµ‹è¯•å®¹å™¨ï¼ŒéªŒè¯è¿è¡Œèƒ½åŠ›
          echo "âœ… åˆ›å»ºæµ‹è¯•å®¹å™¨ï¼ŒéªŒè¯Dockerå®Œæ•´è¿è¡Œèƒ½åŠ›..."
          if ! docker run --rm -it alpine echo "Docker Test Success"; then
            echo "âŒ Dockeræ— æ³•åˆ›å»ºå®¹å™¨ï¼Œè¿è¡Œèƒ½åŠ›å¼‚å¸¸"
            docker ps -a
            docker system df
            exit 1
          fi
          # éªŒè¯4ï¼šç½‘ç»œ/å­˜å‚¨æ­£å¸¸
          sudo docker network ls >/dev/null 2>&1 && echo "âœ… Dockerç½‘ç»œæ­£å¸¸"
          sudo docker volume create test-volume >/dev/null 2>&1 && sudo docker volume rm test-volume >/dev/null 2>&1 && echo "âœ… Dockerå­˜å‚¨æ­£å¸¸"
          # éªŒè¯TTAç›®å½•
          [ -d "/TTA" ] && echo "âœ… /TTAç›®å½•å­˜åœ¨ä¸”å®Œæ•´" || (sudo mkdir -p /TTA && echo "âœ… /TTAç›®å½•å·²è‡ªåŠ¨åˆ›å»º")
          # æ¸…ç†æµ‹è¯•æ®‹ç•™
          sudo docker network prune -f 2>/dev/null || true
          echo "âœ… Dockerå¯åŠ¨å®Œæˆï¼ŒDocker+TTAå…¨é‡éªŒè¯é€šè¿‡ï¼"
          echo "âœ… å½“å‰DockerçŠ¶æ€ï¼š$(docker info | grep -E 'Server Version|Containers:|Images:|Storage Driver')"

      - name: 8. Deploy Tailscale (Optional)
        run: |
          set -e
          if [ -z "${{ secrets.TAILSCALE_AUTH_KEY }}" ]; then
            echo "â„¹ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          # å®‰è£…Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update -y && sudo apt install -y tailscale
          # å¯åŠ¨å¹¶é…ç½®Dockerç½‘æ®µè½¬å‘
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --accept-routes --hostname="docker-tta-snapshot-${{ github.run_id }}" \
            --advertise-routes=172.17.0.0/16,172.18.0.0/16
          echo "âœ… Tailscaleéƒ¨ç½²å®Œæˆï¼Œå†…ç½‘IPï¼š$(sudo tailscale ip -4)"

      - name: 9. Create Docker+TTA Full Snapshot + Upload WebDAV + Auto Renew
        if: ${{ steps.webdav-config.outputs.webdav_available == 'true' }}
        run: |
          set -e
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          echo "===== å¯åŠ¨Docker+TTAå…¨é‡å¿«ç…§è‡ªåŠ¨åŒ–æµç¨‹ ====="

          # ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šè§¦å‘ç»­è·‘æ—¶ï¼Œå…ˆå…³é—­å½“å‰æ—§çš„GitHub Actionså®¹å™¨ï¼Œå†å¯åŠ¨æ–°ç»­è·‘
          trigger_renew() {
            if [ -z "${{ secrets.USER_PAT }}" ]; then
              echo "âŒ æœªé…ç½®GitHub PATï¼Œæ— æ³•è§¦å‘ç»­è·‘"
              return 1
            fi
            echo "âœ… å¼€å§‹è§¦å‘æ–°ç»­è·‘ï¼Œå…ˆå…³é—­å½“å‰æ—§å®¹å™¨..."
            # 1. è·å–å½“å‰å·¥ä½œæµçš„RUN_IDï¼Œç”¨äºç»ˆæ­¢æ—§å®¹å™¨
            CURRENT_RUN_ID="${{ github.run_id }}"
            CURRENT_REPO="${{ github.repository }}"
            # 2. è°ƒç”¨GitHub APIç»ˆæ­¢å½“å‰æ—§çš„å·¥ä½œæµå®¹å™¨ï¼ˆå¼ºåˆ¶å…³é—­ï¼Œé‡Šæ”¾èµ„æºï¼‰
            if ! curl -fsSL -X POST \
              -H "Authorization: token ${{ secrets.USER_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$CURRENT_REPO/actions/runs/$CURRENT_RUN_ID/cancel"; then
              echo "âš ï¸ å…³é—­æ—§å®¹å™¨å¤±è´¥ï¼Œç»§ç»­è§¦å‘æ–°ç»­è·‘"
            else
              echo "âœ… æ—§çš„GitHub Actionså®¹å™¨å·²æˆåŠŸå…³é—­"
            fi
            # 3. è§¦å‘æ–°çš„è‡ªåŠ¨ç»­è·‘å·¥ä½œæµ
            echo "âœ… è§¦å‘æ–°çš„Docker+TTAå¿«ç…§ç»­è·‘..."
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token ${{ secrets.USER_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$CURRENT_REPO/dispatches" \
              -d '{"event_type":"renew_docker_tta_snapshot"}'; then
              echo "âŒ ç»­è·‘è§¦å‘å¤±è´¥"
              return 1
            fi
            RENEW_TRIGGERED=true
            echo "âœ… æ–°çš„è‡ªåŠ¨ç»­è·‘å·¥ä½œæµå·²æˆåŠŸå¯åŠ¨ï¼Œæ—§å®¹å™¨å·²å…³é—­"
          }

          # åˆ›å»ºDocker+TTA 1:1å®Œæ•´å¿«ç…§
          create_docker_tta_snapshot() {
            # è¿‡æ»¤æœ‰æ•ˆç›®å½•
            VALID_DIRS=""
            for dir in $DOCKER_TTA_FULL_DIRS; do
              if [ -d "$dir" ] || [ -f "$dir" ]; then
                VALID_DIRS="$VALID_DIRS $dir"
              else
                echo "â„¹ï¸ è·³è¿‡ä¸å­˜åœ¨çš„ç›®å½•ï¼š$dir"
              fi
            done
            if [ -z "$VALID_DIRS" ]; then
              echo "âŒ æ— æœ‰æ•ˆDocker+TTAç›®å½•å¯å¤‡ä»½"
              return 1
            fi
            # å¿«ç…§å‘½å
            SNAPSHOT_NAME="docker-tta-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/$SNAPSHOT_NAME"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/$SNAPSHOT_NAME"
            # åœæ­¢Dockerä¿è¯å¿«ç…§ä¸€è‡´æ€§
            echo "âœ… åœæ­¢DockeræœåŠ¡ï¼Œä¿è¯å¿«ç…§æ•°æ®ä¸€è‡´æ€§..."
            sudo systemctl stop docker containerd docker.socket 2>/dev/null || true
            sudo pkill -9 docker containerd ctr dockerd 2>/dev/null || true
            sync && sleep 5
            # æ‰“åŒ…å¿«ç…§ï¼ˆå…¨å‚æ•°ä¿è¯1:1å®Œæ•´æ€§ï¼‰
            echo "âœ… å¼€å§‹åˆ›å»ºDocker+TTAå®Œæ•´å¿«ç…§ï¼Œè¯·å‹¿ä¸­æ–­..."
            sudo tar -czpf "$TMP_SNAPSHOT" \
              --overwrite \
              -p \
              --same-owner \
              --preserve-links \
              --acls \
              --xattrs \
              --numeric-owner \
              $EXCLUDE_RULES \
              $VALID_DIRS || {
                echo "âŒ å¿«ç…§æ‰“åŒ…å¤±è´¥ï¼Œå·²é‡å¯Docker"
                sudo systemctl start docker containerd docker.socket
                return 1
              }
            # æ ¡éªŒå¿«ç…§æœ‰æ•ˆæ€§ï¼ˆæœ€å°100KBï¼‰
            if [ $(stat -c%s "$TMP_SNAPSHOT") -lt 102400 ]; then
              echo "âŒ å¿«ç…§æ–‡ä»¶è¿‡å°ï¼Œæ‰“åŒ…å¤±è´¥"
              rm -f "$TMP_SNAPSHOT"
              sudo systemctl start docker containerd docker.socket
              return 1
            fi
            # æ›´æ”¹å±ä¸»ï¼Œæ–¹ä¾¿rcloneä¸Šä¼ 
            sudo chown runner:runner "$TMP_SNAPSHOT"
            # å¤šçº¿ç¨‹ä¸Šä¼ WebDAV
            echo "âœ… å¿«ç…§åˆ›å»ºå®Œæˆï¼Œå¤§å°ï¼š$(du -sh "$TMP_SNAPSHOT" | awk '{print $1}')ï¼Œå¼€å§‹ä¸Šä¼ WebDAV..."
            if ! rclone copy "$TMP_SNAPSHOT" "$REMOTE_PATH" --config /home/runner/.rclone.conf --transfers 8 --multi-thread-streams 4; then
              echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥ï¼Œå·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
              rm -f "$TMP_SNAPSHOT"
              sudo systemctl start docker containerd docker.socket
              return 1
            fi
            # ç”Ÿæˆå…ƒæ•°æ®
            echo "âœ… ç”ŸæˆDocker+TTAå¿«ç…§å…ƒæ•°æ®..."
            printf "snapshot_name=%s\ncreate_time=%s\ncreate_host=%s\ndocker_version=%s\ncontainerd_version=%s\ndocker_compose_version=%s\nsnapshot_size=%s\nsnapshot_md5=%s\nbackup_dirs=Dockerå…¨æ ¸å¿ƒ+/TTA\nta_dir=/TTA\n" \
              "$SNAPSHOT_NAME" \
              "$(date +%Y-%m-%d\ %H:%M:%S\ %Z)" \
              "$(hostname -f)" \
              "$(docker -v 2>/dev/null | awk '{print $3}' | sed 's/,//g' || echo 'unknown')" \
              "$(containerd -v 2>/dev/null | awk '{print $3}' | sed 's/v//g' || echo 'unknown')" \
              "$(docker compose version 2>/dev/null | head -n1 | awk '{print $4}' | sed 's/,//g' || echo 'unknown')" \
              "$(du -sh "$TMP_SNAPSHOT" | awk '{print $1}')" \
              "$(md5sum "$TMP_SNAPSHOT" | awk '{print $1}')" | sudo tee /tmp/docker-tta-snapshot-meta.txt
            # ä¸Šä¼ å…ƒæ•°æ®
            rclone copy /tmp/docker-tta-snapshot-meta.txt mywebdav:${WEBDAV_SNAPSHOT_DIR_CLEAN}/ --config /home/runner/.rclone.conf
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶+é‡å¯Docker
            rm -f "$TMP_SNAPSHOT" /tmp/docker-tta-snapshot-meta.txt
            sudo systemctl start docker containerd docker.socket
            sleep 5
            # éªŒè¯Dockeré‡å¯çŠ¶æ€
            if ! sudo systemctl is-active --quiet docker; then
              echo "âš ï¸ Dockerå¿«ç…§åé‡å¯å¤±è´¥ï¼Œå·²å°è¯•ä¿®å¤"
              sudo systemctl restart docker
            fi
            echo "âœ… Docker+TTA 1:1å®Œæ•´å¿«ç…§åˆ›å»ºå¹¶ä¸Šä¼ å®Œæˆï¼š$SNAPSHOT_NAME"
            return 0
          }

          # ä¸»å¾ªç¯ï¼šè¿è¡Œ2åˆ†é’Ÿååˆ›å»ºå¿«ç…§+è§¦å‘ç»­è·‘
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "â±ï¸ è¿è¡Œæ—¶é—´ï¼š$run_mins / $MAX_RUN_MINUTES åˆ†é’Ÿ"
            # è¿è¡Œ2åˆ†é’Ÿåæ‰§è¡Œï¼Œä¿è¯ç¯å¢ƒç¨³å®š
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              create_docker_tta_snapshot && trigger_renew
            fi
            # è¶…æ—¶è‡ªåŠ¨é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Workflowè¶…æ—¶ï¼Œæ­£å¸¸é€€å‡º"
              exit 0
            fi
            sleep 60
          done

      - name: 10. Clean All Temp Files (Always Execute)
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ï¼Œä¿è¯ç¯å¢ƒå¹²å‡€ ====="
          # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/docker* /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log /tmp/webdav-test.txt 2>/dev/null || true
          # æ¸…ç†aptç¼“å­˜
          sudo apt clean && sudo apt autoremove -y 2>/dev/null || true
          # æœ€ç»ˆä¿è¯Dockerè¿è¡Œ+TTAç›®å½•å®Œæ•´
          sudo systemctl start docker containerd docker.socket 2>/dev/null || true
          sudo systemctl unmask docker.socket containerd.service 2>/dev/null || true
          [ ! -d "/TTA" ] && sudo mkdir -p /TTA
          # æœ€ç»ˆéªŒè¯
          if sudo systemctl is-active --quiet docker && [ -d "/TTA" ]; then
            echo "âœ… æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
            echo "âœ… DockeræœåŠ¡æ­£å¸¸è¿è¡Œï¼Œ/TTAç›®å½•å®Œæ•´ä¿ç•™"
          else
            echo "âš ï¸ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆï¼Œå·²å°è¯•ä¿®å¤Docker+/TTAç›®å½•"
            sudo systemctl restart docker
          fi
