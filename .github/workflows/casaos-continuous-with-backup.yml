name: CasaOS å…¨é‡å¤‡ä»½ä¸è‡ªåŠ¨æ¢å¤

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # ç»­è·‘è§¦å‘ç±»å‹

jobs:
  casaos_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # æ ¸å¿ƒå¤‡ä»½ç›®å½•ï¼ˆç²¾ç®€å¿…è¦ç›®å½•ï¼Œå‰”é™¤å†—ä½™ï¼Œé¿å…æ— æ•ˆæ‰“åŒ…ï¼‰
      CORE_DIRS: "/var/lib/docker /etc/docker /etc/casaos /var/lib/casaos /DATA /etc/systemd/system /usr/lib/systemd/system /usr/local/bin /etc/profile.d /etc/environment /var/lib/apt /etc/ld.so.conf.d /lib/x86_64-linux-gnu /lib64"
      # æ’é™¤è§„åˆ™ï¼ˆç²¾å‡†è¿‡æ»¤æ— ç”¨æ–‡ä»¶ï¼Œç¼©å‡å¤‡ä»½ä½“ç§¯ï¼‰
      EXCLUDE_RULES: "--exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/logs --exclude=/var/lib/docker/buildx --exclude=/var/lib/docker/plugins --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=*.swp --exclude=/tmp/* --exclude=/var/tmp/* --exclude=/var/log/* --exclude=/var/cache/apt/archives/* --exclude=/DATA/tmp --exclude=/DATA/logs --exclude=/DATA/cache --exclude=/etc/systemd/system/*.wants --exclude=/etc/systemd/system/*.requires --exclude=/usr/share/doc --exclude=/usr/share/man"
      # ç¯å¢ƒå˜é‡ï¼ˆè¯­æ³•ä¿®æ­£ï¼Œæ— å¤šä½™ç©ºæ ¼ï¼Œé¿å…è§£æå¤±è´¥ï¼‰
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true
      BACKUP_MARK: "CASAOS_FULL_BACKUP_FULLY"
      BACKUP_DELAY_SEC: 300  # å¤‡ä»½å»¶æ—¶5åˆ†é’Ÿï¼Œå¯ç›´æ¥ä¿®æ”¹æ•°å€¼è°ƒæ•´

    steps:
      - name: 1. ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–å®‰è£…
        run: |
          set -e
          # å¿«é€Ÿæ›´æ–°+å®‰è£…æ ¸å¿ƒä¾èµ–ï¼Œç²¾ç®€æ— ç”¨åŒ…
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl rsync ca-certificates apt-transport-https cgroupfs-mount dbus avahi-daemon
          # é…ç½®ç¼–ç ï¼Œå½»åº•è§£å†³ä¹±ç 
          sudo locale-gen zh_CN.UTF-8 en_US.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # å®‰è£…rcloneï¼ŒæŒ‡å®šç‰ˆæœ¬æ›´ç¨³å®š
          curl https://rclone.org/install.sh | sudo bash -s -- -q
          # æƒé™é…ç½®ï¼ˆå®‰å…¨åˆè§„ï¼Œé¿å…æƒé™æº¢å‡ºï¼‰
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner >/dev/null
          sudo chmod 0440 /etc/sudoers.d/runner
          # ç›®å½•é¢„å¤„ç†ï¼Œç¡®ä¿å­˜åœ¨ä¸”æƒé™æ­£ç¡®
          sudo mkdir -p /DATA /var/lib/casaos && sudo chmod 755 /DATA /var/lib/casaos
          # æ¸…ç†CasaOSæ®‹ç•™é”™è¯¯ç›®å½•ï¼ˆå…³é”®ä¿®å¤ï¼‰
          if [ -d "/usr/bin/casaos" ]; then
            sudo rm -rf /usr/bin/casaos && echo "âœ… æ¸…ç†æ®‹ç•™é”™è¯¯ç›®å½•ï¼š/usr/bin/casaos"
          fi
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·roots
        run: |
          set -e
          # å­˜åœ¨å³è·³è¿‡ï¼Œé¿å…é‡å¤åˆ›å»ºæŠ¥é”™
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            # å¯†ç é…ç½®ï¼Œå…¼å®¹å¯†é’¥ä¸éšæœºå¯†ç ï¼Œæ— ç©ºæ ¼è¯­æ³•é”™è¯¯
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… rootsç”¨æˆ·åˆ›å»ºå®Œæˆï¼Œéšæœºå¯†ç ï¼š$RANDOM_PASS"
            fi
            # æ·»åŠ å¿…è¦æƒé™ï¼Œæ— éœ€å†—ä½™rootç»„
            sudo usermod -aG sudo,docker roots
          fi
          echo "âœ… ç®¡ç†å‘˜ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 3. é…ç½®Rclone WebDAV & è¿é€šæ€§æ ¡éªŒ
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # æ ¡éªŒå‡­è¯å®Œæ•´æ€§ï¼Œç¼ºä¸€ä¸å¯
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤æµç¨‹"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # é…ç½®rclone WebDAVï¼ŒåŠ å¯†å¯†ç æ›´å®‰å…¨
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="other" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf --non-interactive
          # æƒé™é”æ­»ï¼Œé˜²æ­¢é…ç½®æ³„éœ²
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          # è¿é€šæ€§æ ¡éªŒï¼ˆé‡è¯•1æ¬¡ï¼Œé¿å…ç½‘ç»œæŠ–åŠ¨è¯¯åˆ¤ï¼‰
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âš ï¸ WebDAVé¦–æ¬¡è¿æ¥å¤±è´¥ï¼Œé‡è¯•1æ¬¡"
            sleep 3
            if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
              echo "âŒ WebDAVè¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
              echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
              exit 0
            fi
          fi
          # è¿œç¨‹ç›®å½•è‡ªåŠ¨åˆ›å»º
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf 2>/dev/null
          # ç²¾å‡†ç­›é€‰æœ€æ–°å¿«ç…§ï¼Œé¿å…åŒ¹é…å¼‚å¸¸
          REMOTE_SNAPSHOTS=$(rclone lsf mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --mode=time --reverse --config /home/runner/.rclone.conf | grep -E "^casaos-full-snapshot-[0-9]{8}-[0-9]{6}\.tar\.gz$")
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(echo "$REMOTE_SNAPSHOTS" | head -n1 | xargs)
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¤‡ä»½å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆå¤‡ä»½å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…CasaOS"
          fi
          echo "âœ… Rclone WebDAVé…ç½®å®Œæˆ"

      - name: 4. ä»WebDAVæ¢å¤CasaOSå¿«ç…§
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹æ¢å¤å¿«ç…§ï¼š${LATEST_SNAPSHOT} ====="
          
          # å¼ºåˆ¶åœæ­¢å ç”¨æœåŠ¡ï¼Œç¡®ä¿æ–‡ä»¶å¯å†™ï¼ˆé€»è¾‘ä¼˜åŒ–ï¼Œæ— æ®‹ç•™è¿›ç¨‹ï¼‰
          sudo systemctl stop docker casaos 2>/dev/null || true
          sudo pkill -9 docker casaos 2>/dev/null || true
          sudo fuser -km /var/lib/docker /var/lib/casaos /DATA 2>/dev/null || true
          sync && sleep 5
          echo "âœ… æ‰€æœ‰ç›¸å…³æœåŠ¡å·²åœæ­¢ï¼Œæ— æ–‡ä»¶å ç”¨"
          
          # å¿«ç…§å®Œæ•´æ€§åŒé‡æ ¡éªŒï¼ˆé¿å…æŸåæ–‡ä»¶æ¢å¤ï¼‰
          echo "ğŸ” æ ¡éªŒå¿«ç…§å®Œæ•´æ€§"
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | tar -tzf - >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯ï¼Œåœæ­¢æ¢å¤"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi
          
          # è§£å‹æ¢å¤ï¼ˆä¼˜åŒ–å‚æ•°ï¼Œæé€Ÿä¸”ä¿è¯æƒé™å®Œæ•´ï¼‰
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / \
            --overwrite --preserve-permissions --preserve-links --preserve-time \
            --warning=no-file-changed --no-ignore-failed-read \
            $EXCLUDE_RULES
          
          # è§£å‹ç»“æœæ ¡éªŒï¼Œé¿å…é™é»˜å¤±è´¥
          if [ $? -ne 0 ]; then
            echo "âŒ å¿«ç…§è§£å‹æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi
          
          # å¤‡ä»½æ ‡è¯†æ ¡éªŒï¼Œç¡®è®¤æ¢å¤å®Œæ•´
          if [ ! -f "/var/lib/casaos/${BACKUP_MARK}.flag" ]; then
            echo "âŒ å¿«ç…§æ¢å¤ä¸å®Œæ•´ï¼Œç¼ºå¤±å¤‡ä»½æ ‡è¯†æ–‡ä»¶"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            exit 1
          fi
          
          # æƒé™ä¿®å¤ï¼ˆç²¾å‡†æˆæƒï¼Œé¿å…æƒé™é”™ä¹±å¯¼è‡´æœåŠ¡å¯åŠ¨å¤±è´¥ï¼‰
          sudo chown -R root:root /etc /usr /bin /sbin /lib /lib64
          sudo chown -R root:docker /var/lib/docker /etc/docker
          sudo chown -R casaos:casaos /var/lib/casaos /etc/casaos
          sudo chmod -R 755 /usr/bin /usr/sbin /bin /sbin
          sudo chmod -R 775 /DATA && sudo chown -R root:root /DATA
          sudo systemctl daemon-reload  # é‡è½½ç³»ç»ŸæœåŠ¡é…ç½®ï¼Œå¿…åŠ 
          sync && sleep 3
          
          # åˆ é™¤å·²æ¢å¤å¿«ç…§ï¼Œé¿å…é‡å¤æ¢å¤ï¼ˆåŠ æ ¡éªŒï¼Œé˜²æ­¢è¯¯åˆ ï¼‰
          if rclone ls mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_full_meta.txt --config /home/runner/.rclone.conf
            echo "âœ… å·²åˆ é™¤å·²æ¢å¤çš„æ—§å¿«ç…§åŠå…ƒæ•°æ®"
          fi
          
          echo "âœ… CasaOSå¿«ç…§æ¢å¤å®Œæˆï¼Œç³»ç»Ÿé…ç½®å®Œæ•´"
          echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"

      - name: 5. å…¨æ–°å®‰è£…CasaOSï¼ˆæ— å¿«ç…§å…œåº•ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set +e  # å…³é—­å…¨å±€ä¸¥æ ¼æ¨¡å¼ï¼Œå…¼å®¹å®‰è£…é‡è¯•é€»è¾‘
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹å…¨æ–°å®‰è£…CasaOS ====="
          
          # å½»åº•æ¸…ç†æ®‹ç•™ï¼Œé¿å…å®‰è£…å†²çªï¼ˆé€»è¾‘ä¼˜åŒ–ï¼Œæ¸…ç†æ›´å½»åº•ï¼‰
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo systemctl reset-failed casaos docker 2>/dev/null || true
          sudo rm -rf /usr/bin/casaos /etc/casaos /var/lib/casaos /usr/lib/casaos ~/.casaos 2>/dev/null || true
          sudo apt autoremove -y 2>/dev/null || true
          
          # é¢„è£…æ ¸å¿ƒä¾èµ–ï¼Œé¿å…CasaOSå®‰è£…ç¼ºå¤±
          sudo apt install -y fuse3 libssl-dev libcurl4-openssl-dev libnss-mdns docker-ce docker-ce-cli containerd.io || true
          sudo systemctl enable --now docker && sleep 3
          
          # ä¸‹è½½å®˜æ–¹å®‰è£…è„šæœ¬ï¼Œæ ¡éªŒå®Œæ•´æ€§
          curl -fsSL https://get.casaos.io/ -o /tmp/casaos_install.sh
          if [ ! -f /tmp/casaos_install.sh ]; then
            echo "âŒ ä¸‹è½½CasaOSå®‰è£…è„šæœ¬å¤±è´¥"
            exit 1
          fi
          sudo chmod +x /tmp/casaos_install.sh
          
          # å®‰è£…é‡è¯•é€»è¾‘ï¼ˆä¼˜åŒ–é‡è¯•é—´éš”ï¼Œæé«˜æˆåŠŸç‡ï¼‰
          INSTALL_SUCCESS=false
          for i in 1 2 3; do
            echo "ğŸ“Œ ç¬¬$iæ¬¡å°è¯•å®‰è£…CasaOS"
            sudo /tmp/casaos_install.sh 2>&1 | tee /var/log/casaos-install-$i.log
            # åŒé‡æ ¡éªŒå®‰è£…æˆåŠŸï¼ˆå¯æ‰§è¡Œæ–‡ä»¶+æœåŠ¡è¿è¡Œï¼Œç²¾å‡†åˆ¤æ–­ï¼‰
            if [ -f "/usr/bin/casaos" ] && [ -x "/usr/bin/casaos" ] && sudo systemctl is-active --quiet casaos && sudo systemctl is-active --quiet docker; then
              INSTALL_SUCCESS=true
              echo "âœ… CasaOSå®‰è£…æˆåŠŸï¼ˆç¬¬$iæ¬¡å°è¯•ï¼‰"
              break
            else
              echo "âš ï¸ ç¬¬$iæ¬¡å®‰è£…å¤±è´¥ï¼Œæ¸…ç†æ®‹ç•™åé‡è¯•"
              sudo rm -rf /usr/bin/casaos /etc/casaos /var/lib/casaos 2>/dev/null || true
              sleep 8  # å»¶é•¿é‡è¯•é—´éš”ï¼Œé¿å…é¢‘ç¹é‡è¯•å†²çª
            fi
          done
          
          # æœ€ç»ˆæ ¡éªŒï¼Œå¤±è´¥åˆ™é€€å‡º
          if [ "$INSTALL_SUCCESS" = "false" ]; then
            echo "âŒ CasaOSå®‰è£…å¤±è´¥ï¼Œæœ€åä¸€æ¬¡æ—¥å¿—ï¼š"
            cat /var/log/casaos-install-3.log
            exit 1
          fi
          
          # è¡¥å…¨ä¾èµ–+åˆ›å»ºå¤‡ä»½æ ‡è¯†ï¼Œè¡”æ¥åç»­å¤‡ä»½æµç¨‹
          sudo apt install -y --fix-missing || true
          sudo mkdir -p /var/lib/casaos
          sudo touch /var/lib/casaos/${BACKUP_MARK}.flag
          sudo systemctl daemon-reload
          echo "âœ… CasaOSå…¨æ–°å®‰è£…å®Œæˆï¼ŒæœåŠ¡å·²å°±ç»ª"
          echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
          exit 0

      - name: 6. å¯åŠ¨å¹¶æ ¡éªŒCasaOSæœåŠ¡ï¼ˆæ¢å¤/å®‰è£…åå¿…åšï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¯åŠ¨å¹¶æ ¡éªŒCasaOS+DockeræœåŠ¡ ====="
          
          # Dockerå¯åŠ¨ä¼˜åŒ–ï¼ˆå¢åŠ ç­‰å¾…æ—¶é—´ï¼Œé‡è¯•é€»è¾‘æ›´åˆç†ï¼‰
          echo "ğŸ”§ å¯åŠ¨DockeræœåŠ¡"
          for i in 1 2 3 4 5; do
            sudo systemctl enable --now docker
            sleep 10  # å»¶é•¿ç­‰å¾…ï¼Œç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨
            if sudo systemctl is-active --quiet docker && sudo docker info >/dev/null 2>&1; then
              echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸï¼ŒçŠ¶æ€æ­£å¸¸"
              break
            fi
            sudo systemctl reset-failed docker
            echo "âš ï¸ Dockerå¯åŠ¨ç¬¬$iæ¬¡é‡è¯•"
            if [ $i -eq 5 ]; then
              echo "ğŸ“Œ é‡è£…Dockerä¿®å¤å¯åŠ¨é—®é¢˜"
              sudo apt reinstall -y docker-ce docker-ce-cli containerd.io -y
              sudo systemctl enable --now docker
            fi
          done
          
          # CasaOSæœåŠ¡å¯åŠ¨+å¼‚å¸¸ä¿®å¤
          echo "ğŸ”§ å¯åŠ¨CasaOSæœåŠ¡"
          sudo systemctl enable --now casaos
          sleep 8
          if ! sudo systemctl is-active --quiet casaos; then
            echo "âš ï¸ CasaOSæœåŠ¡æœªå¯åŠ¨ï¼Œæ’æŸ¥æ—¥å¿—å¹¶ä¿®å¤"
            sudo journalctl -u casaos -n 50 --no-pager
            sudo systemctl reset-failed casaos
            sudo systemctl start casaos
            sleep 5
          fi
          if sudo systemctl is-active --quiet casaos; then
            echo "âœ… CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸ"
          else
            echo "âŒ CasaOSæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          
          # å®¹å™¨+ç«¯å£åŒé‡æ ¡éªŒï¼Œç¡®ä¿æœåŠ¡å¯ç”¨
          sleep 5
          if sudo docker ps | grep -q casaos; then
            echo "âœ… CasaOSå®¹å™¨è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸ CasaOSå®¹å™¨æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨æ‰€æœ‰å…³è”å®¹å™¨"
            sudo docker start $(sudo docker ps -a | grep -E "casaos|CasaOS" | awk '{print $1}') 2>/dev/null || true
            sleep 3
          fi
          if sudo ss -tulpn | grep -q 80 || sudo ss -tulpn | grep -q 3000; then
            echo "âœ… CasaOSç«¯å£ç›‘å¬æ­£å¸¸"
          else
            echo "âš ï¸ CasaOSç«¯å£æœªç›‘å¬ï¼ŒæœåŠ¡å¯èƒ½å¼‚å¸¸"
          fi
          
          # è¾“å‡ºè®¿é—®åœ°å€ï¼Œæ–¹ä¾¿éªŒè¯
          CASAOS_IP=$(hostname -I | awk '{print $1}' | head -n1)
          echo "âœ… CasaOSæœåŠ¡å®Œå…¨å°±ç»ªï¼Œè®¿é—®åœ°å€ï¼šhttp://${CASAOS_IP}"

      - name: 7. éƒ¨ç½²Tailscaleï¼ˆå¯é€‰ï¼Œå®‰å…¨åŠ å›ºï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          # æ— å¯†é’¥ç›´æ¥è·³è¿‡ï¼Œä¸å½±å“ä¸»æµç¨‹
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          # å®‰è£…Tailscaleï¼Œé€‚é…Ubuntu24.04
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          # æ ¡éªŒå®‰è£…ç»“æœ
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ] || [ ! -x "$TAILSCALE_PATH" ]; then
            echo "âŒ Tailscaleå®‰è£…å¤±è´¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          # å¯åŠ¨è®¤è¯ï¼Œé…ç½®å›ºå®šä¸»æœºå
          sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --accept-dns --hostname="casaos-snap-${{ github.run_id }}" --advertise-exit-node=false
          sleep 3
          # è¾“å‡ºTailscale IPï¼ŒéªŒè¯è¿é€šæ€§
          TAILSCALE_IP=$(sudo "$TAILSCALE_PATH" ip -4 | head -n1)
          if [ -n "$TAILSCALE_IP" ]; then
            echo "âœ… Tailscaleéƒ¨ç½²å®Œæˆï¼Œå†…ç½‘IPï¼š${TAILSCALE_IP}"
          else
            echo "âš ï¸ Tailscaleéƒ¨ç½²æˆåŠŸï¼Œä½†æœªè·å–åˆ°IP"
          fi

      - name: 8. å»¶æ—¶5åˆ†é’Ÿåå…¨é‡å¤‡ä»½CasaOSåˆ°WebDAVï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹å¤‡ä»½å‰ç½®å‡†å¤‡ ====="
          # å»¶æ—¶5åˆ†é’Ÿï¼Œç¡®ä¿æœåŠ¡å®Œå…¨ç¨³å®šï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼ŒåŠ å€’è®¡æ—¶æç¤ºï¼‰
          echo "â³ ç­‰å¾…${BACKUP_DELAY_SEC}ç§’(5åˆ†é’Ÿ)ï¼Œè®©CasaOS+DockeræœåŠ¡ç¨³å®šè¿è¡Œåå†å¤‡ä»½"
          countdown=$BACKUP_DELAY_SEC
          while [ $countdown -gt 0 ]; do
            echo "å‰©ä½™ç­‰å¾…æ—¶é—´ï¼š${countdown}ç§’"
            sleep 10
            countdown=$((countdown - 10))
          done
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘è§¦å‘å‡½æ•°ï¼ˆé€»è¾‘åŠ å›ºï¼Œé¿å…é‡å¤è§¦å‘ï¼‰
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ ç»­è·‘å‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡ç»­è·‘"
              return 1
            fi
            if [ "$RENEW_TRIGGERED" = "true" ]; then
              echo "âœ… å·²è§¦å‘ç»­è·‘ï¼Œæ— éœ€é‡å¤æ‰§è¡Œ"
              return 0
            fi
            echo "ğŸ”§ è§¦å‘ç»­è·‘å·¥ä½œæµ"
            if ! curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âŒ ç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥"
              return 1
            fi
            echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true
            return 0
          }

          # æ ¸å¿ƒå¤‡ä»½å‡½æ•°ï¼ˆå…¨é“¾è·¯æ ¡éªŒï¼Œé¿å…æ— æ•ˆå¤‡ä»½ï¼‰
          full_backup_snapshot() {
            # å‰ç½®æ ¡éªŒ1ï¼šWebDAVå¯ç”¨
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAVä¸å¯ç”¨ï¼Œæ‹’ç»å¤‡ä»½"
              return 1
            fi
            # å‰ç½®æ ¡éªŒ2ï¼šCasaOSç¯å¢ƒå®Œæ•´
            if [ ! -f "/usr/bin/casaos" ] || [ ! -f "/var/lib/casaos/${BACKUP_MARK}.flag" ] || ! sudo systemctl is-active --quiet docker; then
              echo "âŒ CasaOSç¯å¢ƒä¸å®Œæ•´/æœåŠ¡æœªå°±ç»ªï¼Œæ‹’ç»å¤‡ä»½"
              exit 1
            fi
            echo "âœ… å¤‡ä»½å‰ç¯å¢ƒå…¨é‡æ ¡éªŒé€šè¿‡ï¼Œå¼€å§‹åˆ›å»ºå¿«ç…§"

            # ç”Ÿæˆå”¯ä¸€å¿«ç…§åï¼Œé¿å…å†²çª
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ å¿«ç…§åç§°ï¼š${SNAPSHOT_NAME}ï¼Œä¸´æ—¶å­˜å‚¨è·¯å¾„ï¼š${TMP_SNAPSHOT}"

            # å¤‡ä»½å‰å®‰å…¨åœæ­¢æœåŠ¡ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
            echo "ğŸ”§ åœæ­¢æœåŠ¡ï¼Œå‡†å¤‡æ‰“åŒ…"
            sudo systemctl stop docker casaos
            sudo pkill -9 docker casaos 2>/dev/null || true
            sync && sleep 5  # æ•°æ®è½ç›˜ï¼Œå¿…åŠ 
            echo "âœ… æœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®å·²è½ç›˜"

            # æ‰“åŒ…å¿«ç…§ï¼ˆä¼˜åŒ–å‚æ•°ï¼Œç¼©å‡ä½“ç§¯+æé€Ÿï¼‰
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --preserve-permissions --preserve-links --preserve-time \
              --ignore-failed-read --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS
            # æ‰“åŒ…å¤±è´¥ç›´æ¥ç»ˆæ­¢
            if [ $? -ne 0 ]; then
              echo "âŒ å¿«ç…§æ‰“åŒ…å¤±è´¥"
              sudo systemctl start docker casaos
              return 1
            fi

            # ç«‹å³é‡å¯æœåŠ¡ï¼Œå‡å°‘ä¸šåŠ¡ä¸­æ–­æ—¶é—´
            echo "ğŸ”§ å¿«ç…§æ‰“åŒ…å®Œæˆï¼Œç«‹å³é‡å¯æœåŠ¡"
            sudo systemctl start docker casaos
            sleep 8
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… æœåŠ¡é‡å¯æˆåŠŸï¼Œä¸šåŠ¡æ¢å¤æ­£å¸¸"
            else
              echo "âš ï¸ æœåŠ¡é‡å¯å¼‚å¸¸ï¼Œå·²ç»§ç»­å¤‡ä»½æµç¨‹"
            fi

            # å¿«ç…§å®Œæ•´æ€§ä¸‰é‡æ ¡éªŒ
            if [ ! -f "${TMP_SNAPSHOT}" ]; then
              echo "âŒ å¿«ç…§æ–‡ä»¶æœªç”Ÿæˆ"
              return 1
            fi
            SNAPSHOT_SIZE=$(stat -c%s "${TMP_SNAPSHOT}")
            if [ $SNAPSHOT_SIZE -lt 104857600 ]; then  # å°äº100MBåˆ¤å®šä¸ºæ®‹ç¼º
              echo "âŒ å¿«ç…§å¤§å°${SNAPSHOT_SIZE}å­—èŠ‚ï¼Œå°äº100MBï¼Œåˆ¤å®šä¸ºæ®‹ç¼º"
              return 1
            fi
            if ! tar -tzf "${TMP_SNAPSHOT}" | grep -q "/var/lib/casaos" || ! tar -tzf "${TMP_SNAPSHOT}" | grep -q "/var/lib/docker"; then
              echo "âŒ å¿«ç…§è§£å‹æ ¡éªŒå¤±è´¥ï¼Œç¼ºå¤±æ ¸å¿ƒç›®å½•"
              return 1
            fi
            echo "âœ… å¿«ç…§å®Œæ•´æ€§æ ¡éªŒé€šè¿‡ï¼Œå¤§å°ï¼š$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            # ä¸Šä¼ å¿«ç…§åˆ°WebDAVï¼ˆå¤šçº¿ç¨‹æé€Ÿï¼Œé‡è¯•åŠ å›ºï¼‰
            echo "ğŸ”„ ä¸Šä¼ å¿«ç…§åˆ°WebDAV"
            sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 8 --checkers 16 --fast-list --retries 5 --low-level-retries 10 \
              --ignore-existing --progress --log-level INFO --log-file /tmp/rclone_full_upload.log
            if [ $? -ne 0 ]; then
              echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š/tmp/rclone_full_upload.log"
              return 1
            fi
            echo "âœ… å¿«ç…§ä¸Šä¼ æˆåŠŸ"

            # ç”Ÿæˆ+ä¸Šä¼ å…ƒæ•°æ®ï¼ˆä¾¿äºè¿½æº¯å¤‡ä»½ä¿¡æ¯ï¼‰
            META_FILE="/tmp/snapshot_full_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            echo "file_size_bytes=${SNAPSHOT_SIZE}" >> "${META_FILE}"
            echo "file_size_human=$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')" >> "${META_FILE}"
            echo "github_run_id=${{ github.run_id }}" >> "${META_FILE}"
            echo "backup_mark=${BACKUP_MARK}" >> "${META_FILE}"
            echo "host_ip=${CASAOS_IP}" >> "${META_FILE}"
            # ä¸Šä¼ å…ƒæ•°æ®ï¼Œè¦†ç›–æ—§æ•°æ®
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_full_meta.txt" \
              --config /home/runner/.rclone.conf --overwrite
            echo "âœ… å¿«ç…§å…ƒæ•°æ®ä¸Šä¼ å®Œæˆ"

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œé‡Šæ”¾ç©ºé—´
            sudo rm -rf "${TMP_SNAPSHOT}" "${META_FILE}" /tmp/rclone_full_upload.log
            echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆï¼Œå¤‡ä»½æµç¨‹ç»“æŸ"
            return 0
          }

          # æ‰§è¡Œå¤‡ä»½+å¼‚å¸¸å…œåº•
          if ! full_backup_snapshot; then
            echo "âŒ å…¨é‡å¤‡ä»½å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi

          # ç»­è·‘é€»è¾‘ï¼ˆä¼˜åŒ–æ—¶é—´è®¡ç®—ï¼Œé¿å…è¯¯è§¦å‘ï¼‰
          current_time=$(date +%s)
          elapsed_minutes=$(( (current_time - start_time) / 60 ))
          remaining_minutes=$(( MAX_RUN_MINUTES - elapsed_minutes - 15 ))  # é¢„ç•™15åˆ†é’Ÿç¼“å†²ï¼Œæ›´å®‰å…¨
          echo "ğŸ“Š å¤‡ä»½è€—æ—¶ï¼š${elapsed_minutes}åˆ†é’Ÿï¼Œå‰©ä½™è¿è¡Œæ—¶é—´ï¼š${remaining_minutes}åˆ†é’Ÿ"

          # å‰©ä½™æ—¶é—´<30åˆ†é’Ÿè§¦å‘ç»­è·‘ï¼Œé˜²æ­¢å¤‡ä»½ä¸­æ–­
          if [ $remaining_minutes -lt 30 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
            echo "âš ï¸ å‰©ä½™è¿è¡Œæ—¶é—´ä¸è¶³30åˆ†é’Ÿï¼Œè§¦å‘ç»­è·‘å·¥ä½œæµä¿éšœå¤‡ä»½ä¸ä¸­æ–­"
            trigger_renew
          fi

          echo "===== CasaOSå…¨é‡å¤‡ä»½æµç¨‹å…¨éƒ¨å®Œæˆ ====="
