name: CasaOS+VNC+Tailscale æŒç»­æœåŠ¡ï¼ˆå¯¹è±¡å­˜å‚¨å¤‡ä»½ç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  casaos-vnc-server:
    runs-on: ubuntu-24.04
    timeout-minutes: 350
    env:
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340
      FIXED_VNC_PWD: "123456789"
      CASAOS_PORT: 80
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      INC_BACKUP_BASE: "casaos_base.tar.gz"
      KEEP_BACKUP_NUM: 2
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      RUNNER_PASSWORD: "runner123"
    steps:
      - name: ç´§æ€¥æ¸…ç†ç£ç›˜ç©ºé—´ï¼ˆä¼˜å…ˆæ‰§è¡Œï¼‰
        id: clean_disk
        continue-on-error: false
        run: |
          echo "===== æ¸…ç†å‰ç£ç›˜ç©ºé—´ ====="
          df -h
          
          # 1. åˆ é™¤ç³»ç»Ÿæ— ç”¨åŒ…å’Œç¼“å­˜ï¼ˆé‡Šæ”¾GBçº§ç©ºé—´ï¼‰
          sudo apt autoremove -y && sudo apt clean -y
          sudo rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/*
          
          # 2. åˆ é™¤GitHub Actionsç¼“å­˜å’Œæ—§æ—¥å¿—ï¼ˆæ ¸å¿ƒé‡Šæ”¾ç‚¹ï¼‰
          sudo rm -rf /home/runner/actions-runner/cached/_diag/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          sudo rm -rf /home/runner/actions-runner/_work/_artifact/*
          
          # 3. æ¸…ç†Dockeræ—§é•œåƒ/å®¹å™¨ï¼ˆå¦‚æœæœ‰æ®‹ç•™ï¼‰
          sudo docker system prune -af 2>/dev/null || true
          
          # 4. å‹ç¼©å¤‡ä»½ç›®å½•ï¼ˆå‡å°‘ç©ºé—´å ç”¨ï¼‰
          mkdir -p $BACKUP_DIR && sudo chmod 777 $BACKUP_DIR
          
          echo "===== æ¸…ç†åç£ç›˜ç©ºé—´ ====="
          df -h
          echo "===== ç£ç›˜æ¸…ç†å®Œæˆ ====="

      - name: ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–æ›´æ–°
        id: init_env
        continue-on-error: false
        run: |
          echo "===== åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ ====="
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿæ›´æ–°å¤±è´¥"; exit 1; }
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿå‡çº§å¤±è´¥"; exit 1; }
          # ä»…å®‰è£…æ ¸å¿ƒä¾èµ–ï¼Œå‡å°‘ç©ºé—´å ç”¨
          sudo apt install -y tar gzip rsync rclone tigervnc-standalone-server netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release || { echo "ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          
          # è®¾ç½® runner ç”¨æˆ·å¯†ç 
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          echo "===== runner ç”¨æˆ·å¯†ç å·²è®¾ç½® ====="
          
          # åˆ›å»ºç›®å½•å¹¶èµ‹æƒ
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          
          # è®°å½•ç³»ç»ŸåŸºç¡€ä¿¡æ¯
          echo "OS_VERSION=$(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '"')" >> $GITHUB_ENV
          echo "RUNNER_USER=$(whoami)" >> $GITHUB_ENV
          echo "===== ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ ====="

      - name: é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆrcloneï¼‰å¹¶æ£€æµ‹è¿é€šæ€§
        id: config_rclone
        continue-on-error: false
        env:
          OSS_CONFIG: ${{ secrets.OSS_CONFIG }}
        run: |
          echo "===== é…ç½®å¯¹è±¡å­˜å‚¨ ====="
          # è§£æ OSS é…ç½®
          export OSS_ENDPOINT=$(echo $OSS_CONFIG | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /endpoint:/){gsub("endpoint:","",$i);print $i}}}')
          export OSS_AK=$(echo $OSS_CONFIG | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /ak:/){gsub("ak:","",$i);print $i}}}')
          export OSS_SK=$(echo $OSS_CONFIG | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /sk:/){gsub("sk:","",$i);print $i}}}')
          
          # å†™å…¥ rclone é…ç½®
          mkdir -p ~/.config/rclone
          echo "[oss]" > ~/.config/rclone/rclone.conf
          echo "type = s3" >> ~/.config/rclone/rclone.conf
          echo "provider = Other" >> ~/.config/rclone/rclone.conf
          echo "endpoint = $OSS_ENDPOINT" >> ~/.config/rclone/rclone.conf
          echo "access_key_id = $OSS_AK" >> ~/.config/rclone/rclone.conf
          echo "secret_access_key = $OSS_SK" >> ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          
          # æ£€æµ‹å¯¹è±¡å­˜å‚¨è¿é€šæ€§
          echo "===== æ£€æµ‹å¯¹è±¡å­˜å‚¨è¿é€šæ€§ ====="
          if rclone lsd oss:; then
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥çŠ¶æ€ï¼šâœ… æˆåŠŸ"
            echo "OSS_ENDPOINT=$OSS_ENDPOINT" >> $GITHUB_ENV
            echo "OSS_CONNECT_STATUS=âœ… æˆåŠŸ" >> $GITHUB_ENV
          else
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥çŠ¶æ€ï¼šâŒ å¤±è´¥"
            echo "OSS_CONNECT_STATUS=âŒ å¤±è´¥" >> $GITHUB_ENV
            exit 1
          fi
          echo "===== å¯¹è±¡å­˜å‚¨é…ç½®å®Œæˆ ====="

      - name: æ¢å¤å†å²å¤‡ä»½ï¼ˆåŸºå‡†+å¢é‡ï¼‰
        id: restore_backup
        continue-on-error: true
        run: |
          echo "===== æ¢å¤å†å²å¤‡ä»½ ====="
          if [ "${OSS_CONNECT_STATUS}" = "âœ… æˆåŠŸ" ]; then
            # æ¢å¤å‰å…ˆæ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶ï¼Œé‡Šæ”¾ç©ºé—´
            rm -rf $BACKUP_DIR/* 2>/dev/null
            rclone copy oss:casaos-backup/ $BACKUP_DIR/ || { echo "å¤‡ä»½æ¢å¤çŠ¶æ€ï¼šâš ï¸  æ— å†å²å¤‡ä»½"; echo "BACKUP_RESTORE_STATUS=âš ï¸  æ— å†å²å¤‡ä»½"; exit 0; }
            if [ -f "$BACKUP_DIR/$INC_BACKUP_BASE" ]; then
              # åªæ¢å¤CasaOSç›¸å…³æ•°æ®ï¼Œä¸æ¢å¤ç³»ç»Ÿæ–‡ä»¶ï¼ˆå‡å°‘ç©ºé—´å ç”¨ï¼‰
              sudo tar -zxf $BACKUP_DIR/$INC_BACKUP_BASE -C / --preserve-permissions --wildcards "*/casaos/*" "*/docker/*" && echo "å…¨é‡å¤‡ä»½æ¢å¤çŠ¶æ€ï¼šâœ… æˆåŠŸ" || echo "å…¨é‡å¤‡ä»½æ¢å¤çŠ¶æ€ï¼šâŒ å¤±è´¥"
              LATEST_INC=$(ls -tp $BACKUP_DIR/inc_*.tar.gz 2>/dev/null | grep -v '/' | head -n1)
              if [ -n "$LATEST_INC" ]; then
                sudo tar -zxf $LATEST_INC -C / --preserve-permissions --wildcards "*/casaos/*" "*/docker/*" && echo "å¢é‡å¤‡ä»½æ¢å¤çŠ¶æ€ï¼šâœ… æˆåŠŸ" || echo "å¢é‡å¤‡ä»½æ¢å¤çŠ¶æ€ï¼šâŒ å¤±è´¥"
                echo "BACKUP_RESTORE_STATUS=âœ… å…¨é‡+å¢é‡å¤‡ä»½æ¢å¤å®Œæˆ" >> $GITHUB_ENV
              else
                echo "BACKUP_RESTORE_STATUS=âœ… ä»…å…¨é‡å¤‡ä»½æ¢å¤å®Œæˆ" >> $GITHUB_ENV
              fi
            else
              echo "BACKUP_RESTORE_STATUS=âš ï¸  æ— å…¨é‡å¤‡ä»½æ–‡ä»¶" >> $GITHUB_ENV
            fi
          else
            echo "BACKUP_RESTORE_STATUS=âŒ å¯¹è±¡å­˜å‚¨è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤" >> $GITHUB_ENV
          fi
          # æ¢å¤åå†æ¬¡æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* 2>/dev/null
          echo "===== å¤‡ä»½æ¢å¤å®Œæˆ ====="

      - name: å®‰è£… Docker + CasaOSï¼ˆè½»é‡åŒ–ï¼‰
        id: install_services
        continue-on-error: true
        run: |
          echo "===== å®‰è£… Docker å¼•æ“ï¼ˆè½»é‡åŒ–ï¼‰ ====="
          # å®‰è£…ç²¾ç®€ç‰ˆDockerï¼Œå‡å°‘ç©ºé—´å ç”¨
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          sudo apt update -y 2>&1 | grep -v "restart" && sudo apt install -y --no-install-recommends docker-ce docker-ce-cli containerd.io docker-compose-plugin
          sudo systemctl start docker && sudo systemctl enable docker
          
          # æ£€æµ‹ Docker çŠ¶æ€
          if sudo systemctl is-active --quiet docker; then
            echo "Docker æœåŠ¡çŠ¶æ€ï¼šâœ… è¿è¡Œä¸­"
            echo "DOCKER_STATUS=âœ… è¿è¡Œä¸­" >> $GITHUB_ENV
          else
            echo "Docker æœåŠ¡çŠ¶æ€ï¼šâŒ æœªå¯åŠ¨"
            echo "DOCKER_STATUS=âŒ æœªå¯åŠ¨" >> $GITHUB_ENV
          fi
          
          echo "===== å®‰è£… CasaOSï¼ˆè½»é‡åŒ–ï¼‰ ====="
          # è·³è¿‡å†—ä½™ä¾èµ–ï¼Œä»…å®‰è£…CasaOSæ ¸å¿ƒ
          curl -fsSL https://get.casaos.io | sudo bash -s -- --lite 2>&1 | grep -v "restart" || echo "CasaOS å®‰è£…è­¦å‘Šï¼šâš ï¸  å®‰è£…è¿‡ç¨‹æœ‰è­¦å‘Š"
          sleep 10 && sudo systemctl start casaos
          
          # æ£€æµ‹ CasaOS çŠ¶æ€
          if sudo systemctl is-active --quiet casaos; then
            echo "CasaOS æœåŠ¡çŠ¶æ€ï¼šâœ… è¿è¡Œä¸­"
            echo "CASAOS_STATUS=âœ… è¿è¡Œä¸­" >> $GITHUB_ENV
          else
            echo "CasaOS æœåŠ¡çŠ¶æ€ï¼šâŒ æœªå¯åŠ¨"
            echo "CASAOS_STATUS=âŒ æœªå¯åŠ¨" >> $GITHUB_ENV
          fi
          # å®‰è£…åæ¸…ç†å®‰è£…åŒ…
          sudo apt clean -y
          echo "===== æœåŠ¡å®‰è£…å®Œæˆ ====="

      - name: é…ç½® VNC + Tailscale
        id: deploy_core
        continue-on-error: true
        run: |
          echo "===== é…ç½® VNC æœåŠ¡ ====="
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          
          # å†™å…¥ VNC å¯åŠ¨è„šæœ¬
          echo "#!/bin/bash" > $VNCDIR/xstartup
          echo "export DISPLAY=:0" >> $VNCDIR/xstartup
          echo "export XDG_RUNTIME_DIR=/tmp/runtime-runner" >> $VNCDIR/xstartup
          echo "mkdir -p \$XDG_RUNTIME_DIR && chmod 700 \$XDG_RUNTIME_DIR" >> $VNCDIR/xstartup
          echo "exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title \"CasaOSæœåŠ¡\"" >> $VNCDIR/xstartup
          chmod +x $VNCDIR/xstartup
          
          # å¯åŠ¨ VNC å¹¶æ£€æµ‹çŠ¶æ€
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth
          if pgrep -x Xvnc > /dev/null; then
            echo "VNC æœåŠ¡çŠ¶æ€ï¼šâœ… è¿è¡Œä¸­ (ç«¯å£: $VNC_PORT)"
            echo "VNC_STATUS=âœ… è¿è¡Œä¸­ (ç«¯å£: $VNC_PORT)" >> $GITHUB_ENV
          else
            echo "VNC æœåŠ¡çŠ¶æ€ï¼šâŒ å¯åŠ¨å¤±è´¥"
            echo "VNC_STATUS=âŒ å¯åŠ¨å¤±è´¥" >> $GITHUB_ENV
          fi
          
          echo "===== é…ç½® Tailscale ç»„ç½‘ ====="
          # ç²¾ç®€å®‰è£…Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo sh -s -- --no-init 2>&1 | grep -v "restart" || echo "Tailscale å®‰è£…è­¦å‘Šï¼šâš ï¸  å®‰è£…è¿‡ç¨‹æœ‰è­¦å‘Š"
          sudo systemctl enable --now tailscaled && sleep 3
          MAX_RETRIES=3
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "Tailscale æœåŠ¡çŠ¶æ€ï¼šâœ… è¿è¡Œä¸­ (å†…ç½‘IP: $TAILSCALE_IP)"
              echo "TAILSCALE_STATUS=âœ… è¿è¡Œä¸­ (å†…ç½‘IP: $TAILSCALE_IP)" >> $GITHUB_ENV
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            sleep 5
          done
          if [ $MAX_RETRIES -eq 0 ]; then
            echo "Tailscale æœåŠ¡çŠ¶æ€ï¼šâŒ å¯åŠ¨å¤±è´¥ (æˆæƒå¯†é’¥å¯èƒ½æ— æ•ˆ)"
            echo "TAILSCALE_STATUS=âŒ å¯åŠ¨å¤±è´¥ (æˆæƒå¯†é’¥å¯èƒ½æ— æ•ˆ)" >> $GITHUB_ENV
          fi
          # å†æ¬¡æ¸…ç†ç£ç›˜
          df -h
          echo "===== æ ¸å¿ƒæœåŠ¡éƒ¨ç½²å®Œæˆ ====="

      - name: è¾“å‡ºè¯¦ç»†æœåŠ¡çŠ¶æ€ä¿¡æ¯
        id: output_info
        continue-on-error: false
        run: |
          echo -e "\n========================================"
          echo -e " ğŸš€ æœåŠ¡éƒ¨ç½²å®Œæˆ - è¯¦ç»†çŠ¶æ€æ±‡æ€»"
          echo -e "========================================"
          echo -e " ğŸ–¥ï¸  ç³»ç»ŸåŸºç¡€ä¿¡æ¯"
          echo -e "   - æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š${OS_VERSION}"
          echo -e "   - å½“å‰è¿è¡Œç”¨æˆ·ï¼š${RUNNER_USER}"
          echo -e "   - runner ç”¨æˆ·å¯†ç ï¼š\033[1;32m${RUNNER_PASSWORD}\033[0m"
          echo -e "   - å‰©ä½™ç£ç›˜ç©ºé—´ï¼š$(df -h / | awk 'NR==2{print $4}')"
          echo -e ""
          echo -e " ğŸ“¦ å¯¹è±¡å­˜å‚¨çŠ¶æ€"
          echo -e "   - è¿æ¥çŠ¶æ€ï¼š${OSS_CONNECT_STATUS}"
          echo -e "   - æœåŠ¡ç«¯ç‚¹ï¼š${OSS_ENDPOINT}"
          echo -e ""
          echo -e " ğŸ”§ å¤‡ä»½æ¢å¤çŠ¶æ€"
          echo -e "   - çŠ¶æ€è¯¦æƒ…ï¼š${BACKUP_RESTORE_STATUS:-âš ï¸  æœªæ£€æµ‹åˆ°å¤‡ä»½ä¿¡æ¯}"
          echo -e ""
          echo -e " ğŸ¯ æ ¸å¿ƒæœåŠ¡çŠ¶æ€"
          echo -e "   - Docker æœåŠ¡ï¼š${DOCKER_STATUS:-âŒ æœªæ£€æµ‹}"
          echo -e "   - CasaOS æœåŠ¡ï¼š${CASAOS_STATUS:-âŒ æœªæ£€æµ‹}"
          echo -e "   - VNC æœåŠ¡ï¼š${VNC_STATUS:-âŒ æœªæ£€æµ‹}"
          echo -e "   - Tailscale æœåŠ¡ï¼š${TAILSCALE_STATUS:-âŒ æœªæ£€æµ‹}"
          echo -e ""
          echo -e " ğŸ”— è¿œç¨‹è®¿é—®ä¿¡æ¯"
          echo -e "   - VNC è¿æ¥åœ°å€ï¼š\033[1;34m${TAILSCALE_IP:-æœªè·å–}:${VNC_PORT}\033[0m"
          echo -e "   - VNC è¿æ¥å¯†ç ï¼š\033[1;32m${FIXED_VNC_PWD}\033[0m"
          echo -e "   - CasaOS é¢æ¿åœ°å€ï¼š\033[1;34mhttp://${TAILSCALE_IP:-æœªè·å–}:${CASAOS_PORT}\033[0m"
          echo -e "   - CasaOS ç™»å½•è´¦å·ï¼š\033[1;32madmin\033[0m / å¯†ç ï¼š\033[1;32madmin\033[0m"
          echo -e ""
          echo -e " ğŸ“‹ è¿è¡Œé…ç½®ä¿¡æ¯"
          echo -e "   - æœ€å¤§è¿è¡Œæ—¶é•¿ï¼š${MAX_RUN_MINUTES} åˆ†é’Ÿ"
          echo -e "   - å¤‡ä»½ä¿ç•™æ•°é‡ï¼š${KEEP_BACKUP_NUM} ä»½"
          echo -e "   - è‡ªåŠ¨ç»­è·‘è§¦å‘ï¼šå‰©ä½™ 10 åˆ†é’Ÿæ—¶è‡ªåŠ¨è§¦å‘æ–°å®ä¾‹"
          echo -e "========================================\n"

      - name: ä¿æ´»+ç»­è·‘+è‡ªåŠ¨å¤‡ä»½æ ¸å¿ƒé€»è¾‘ï¼ˆç©ºé—´ä¼˜åŒ–ç‰ˆï¼‰
        id: core_logic
        continue-on-error: true
        run: |
          echo "===== å¯åŠ¨ä¿æ´»+å¤‡ä»½ç›‘æ§ ====="
          start_time=$(date +%s)
          last_backup_time=$start_time

          full_backup() {
            echo "===== åˆ›å»ºå…¨é‡åŸºå‡†å¤‡ä»½ï¼ˆè½»é‡åŒ–ï¼‰ ====="
            if [ "${OSS_CONNECT_STATUS}" = "âœ… æˆåŠŸ" ]; then
              # åªå¤‡ä»½CasaOSå’ŒDockeræ ¸å¿ƒæ•°æ®ï¼Œä¸å¤‡ä»½ç³»ç»Ÿæ–‡ä»¶ï¼ˆå‡å°‘å¤‡ä»½ä½“ç§¯ï¼‰
              sudo tar -zcf $BACKUP_DIR/$INC_BACKUP_BASE $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" && rclone copy $BACKUP_DIR/$INC_BACKUP_BASE oss:casaos-backup/ && echo "å…¨é‡å¤‡ä»½ä¸Šä¼ çŠ¶æ€ï¼šâœ… æˆåŠŸ" || echo "å…¨é‡å¤‡ä»½ä¸Šä¼ çŠ¶æ€ï¼šâŒ å¤±è´¥"
              # å¤‡ä»½ååˆ é™¤æœ¬åœ°å…¨é‡å¤‡ä»½æ–‡ä»¶ï¼Œä»…ä¿ç•™åœ¨å¯¹è±¡å­˜å‚¨
              rm -f $BACKUP_DIR/$INC_BACKUP_BASE
            else
              echo "å…¨é‡å¤‡ä»½ä¸Šä¼ çŠ¶æ€ï¼šâŒ å¯¹è±¡å­˜å‚¨è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
            fi
          }

          inc_backup() {
            echo "===== åˆ›å»ºå¢é‡å¤‡ä»½ï¼ˆè½»é‡åŒ–ï¼‰ ====="
            if [ "${OSS_CONNECT_STATUS}" = "âœ… æˆåŠŸ" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_NAME=$BACKUP_DIR/inc_$TIMESTAMP.tar.gz
              # åªå¢é‡å¤‡ä»½CasaOSå’ŒDockeræ•°æ®
              sudo tar -zcf $BACKUP_NAME $BACKUP_EXCLUDE / --listed-incremental=$BACKUP_DIR/backup.snar --wildcards "*/casaos/*" "*/docker/*" && rclone copy $BACKUP_NAME oss:casaos-backup/ && echo "å¢é‡å¤‡ä»½ä¸Šä¼ çŠ¶æ€ï¼šâœ… æˆåŠŸ" || echo "å¢é‡å¤‡ä»½ä¸Šä¼ çŠ¶æ€ï¼šâŒ å¤±è´¥"
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆåªä¿ç•™1ä»½æœ¬åœ°å¢é‡å¤‡ä»½ï¼‰
              ls -tp $BACKUP_DIR/inc_*.tar.gz 2>/dev/null | grep -v '/' | tail -n +2 | xargs -I {} sudo rm -f {} || true
              rclone delete oss:casaos-backup/ --include "inc_*.tar.gz" --min-age $((KEEP_BACKUP_NUM * 86400)) || true
              # å®šæœŸæ¸…ç†ç£ç›˜
              sudo apt autoremove -y && sudo apt clean -y
              sudo docker system prune -af 2>/dev/null || true
            else
              echo "å¢é‡å¤‡ä»½ä¸Šä¼ çŠ¶æ€ï¼šâŒ å¯¹è±¡å­˜å‚¨è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
            fi
          }

          [ ! -f "$BACKUP_DIR/$INC_BACKUP_BASE" ] && full_backup || inc_backup

          while true; do
            current_time=$(date +%s)
            run_minutes=$(( (current_time - start_time) / 60 ))

            # è‡ªåŠ¨ç»­è·‘è§¦å‘
            if [ $((MAX_RUN_MINUTES - run_minutes)) -eq 10 ]; then
              echo "===== å‰©ä½™10åˆ†é’Ÿï¼Œè§¦å‘ç»­è·‘ ====="
              full_backup
              curl -X POST https://api.github.com/repos/${{ github.repository }}/dispatches \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.USER_GITHUB_PAT }}" \
                -d '{"event_type":"renew_vnc"}' || echo "ç»­è·‘è§¦å‘å¤±è´¥"
            fi

            # å®šæ—¶å¢é‡å¤‡ä»½ï¼ˆæ”¹ä¸º2å°æ—¶ä¸€æ¬¡ï¼Œå‡å°‘ç©ºé—´å ç”¨ï¼‰
            if [ $((current_time - last_backup_time)) -ge 7200 ]; then
              inc_backup
              last_backup_time=$current_time
            fi

            # æ ¸å¿ƒæœåŠ¡å¥åº·æ£€æŸ¥
            pgrep -x Xvnc || { echo "VNC æœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."; vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth; }
            sudo systemctl is-active --quiet docker || { echo "Docker æœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."; sudo systemctl restart docker; }
            sudo systemctl is-active --quiet casaos || { echo "CasaOS æœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."; sudo systemctl restart casaos; }
            sudo systemctl is-active --quiet tailscaled || { echo "Tailscale æœåŠ¡å¼‚å¸¸ï¼Œé‡å¯ä¸­..."; sudo systemctl restart tailscaled; }

            # å®æ—¶ç›‘æ§ç£ç›˜ç©ºé—´
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}' | sed 's/[G|M]//g')
            if (( $(echo "$FREE_SPACE < 1" | bc -l) )); then
              echo "âš ï¸  ç£ç›˜ç©ºé—´ä¸è¶³1GBï¼Œç´§æ€¥æ¸…ç†..."
              sudo apt autoremove -y && sudo apt clean -y
              sudo docker system prune -af 2>/dev/null || true
              rm -rf /tmp/* $BACKUP_DIR/inc_*.tar.gz 2>/dev/null
            fi

            echo "[$(date)] è¿è¡Œæ—¶é•¿ï¼š${run_minutes}åˆ†é’Ÿ | Tailscale IPï¼š${TAILSCALE_IP:-æœªè·å–} | å‰©ä½™ç£ç›˜ï¼š$(df -h / | awk 'NR==2{print $4}')"
            sleep 300
          done

      - name: ä¼˜é›…æ¸…ç†ç¯å¢ƒ
        id: clean_env
        if: always()
        run: |
          echo "===== æ¸…ç†ç¯å¢ƒ ====="
          [ -f "$BACKUP_DIR/$INC_BACKUP_BASE" ] && [ "${OSS_CONNECT_STATUS}" = "âœ… æˆåŠŸ" ] && rclone copy $BACKUP_DIR/$INC_BACKUP_BASE oss:casaos-backup/ || true
          vncserver -kill $DISPLAY || true && pkill -9 Xvnc || true
          sudo systemctl stop docker casaos tailscaled || true
          sudo tailscale down || true
          # å½»åº•æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
          rm -rf $BACKUP_DIR $VNCDIR $NETDISK_ROOT /tmp/* /home/runner/actions-runner/cached/_diag/* || true
          echo "===== ç¯å¢ƒæ¸…ç†å®Œæˆ ====="
