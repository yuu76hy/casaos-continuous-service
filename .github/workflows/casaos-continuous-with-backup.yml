name: CasaOS-Server-Snapshot-Backup-Restore

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      CORE_DIRS: "/var/lib /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp --exclude=$WEBDAV_MOUNT_POINT
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      - name: Env Init & Create Dirs
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          WEBDAV_SNAPSHOT_DIR="${WEBDAV_MOUNT_POINT}/ÂØπË±°Â≠òÂÇ®/ubuntu"
          sudo mkdir -p "$WEBDAV_SNAPSHOT_DIR"
          echo "‚úÖ Env init done, WebDAV snapshot dir: $WEBDAV_SNAPSHOT_DIR"
          echo "WEBDAV_SNAPSHOT_DIR=$WEBDAV_SNAPSHOT_DIR" >> "$GITHUB_ENV"

      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "‚úÖ roots user created, password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi

      - name: Mount WebDAV
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8

          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "‚ùå WebDAV secrets missing, please configure in GitHub Secrets"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          mkdir -p "$WEBDAV_MOUNT_POINT"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="other" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          
          # ‰ªÖÂú®mountÊó∂‰ΩøÁî®--localeÂèÇÊï∞Ôºå‰∏îÁ°Æ‰øùÊó•ÂøóÊñá‰ª∂ÁîüÊàê
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" \
            --config /home/runner/.rclone.conf \
            --vfs-cache-mode writes \
            --vfs-write-back 0s \
            --transfers 4 \
            --daemon-timeout 1h \
            --allow-other \
            --allow-non-empty \
            --locale zh-CN \
            --log-level INFO \
            --log-file /tmp/rclone_mount.log >/dev/null 2>&1 &
          
          for i in $(seq 1 5); do
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              echo "‚úÖ WebDAV mounted successfully (UTF-8 encoding)"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              
              if ls "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "‚úÖ Found latest snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              else
                echo "‚ö†Ô∏è No historical snapshot found in $WEBDAV_SNAPSHOT_DIR"
              fi
              exit 0
            fi
            echo "‚ö†Ô∏è WebDAV mount attempt $i failed, retrying..."
            sleep 10
          done
          
          echo "‚ùå WebDAV mount failed after 5 attempts"
          cat /tmp/rclone_mount.log || echo "‚ö†Ô∏è No mount log file found"
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      - name: Restore Snapshot & Cleanup Used File
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          echo "===== Start restoring from snapshot: $LATEST_SNAPSHOT ====="
          
          sudo systemctl stop docker.service docker.socket casaos.service
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3
          
          sudo tar -xzf "$LATEST_SNAPSHOT" -C / \
            --overwrite \
            --ignore-failed-read \
            --warning=no-all \
            $EXCLUDE_RULES
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Snapshot restored successfully"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            sudo rm -f "$LATEST_SNAPSHOT" "$WEBDAV_SNAPSHOT_DIR/snapshot_meta.txt"
            sudo systemctl unmask docker.socket
          else
            echo "‚ùå Snapshot restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
          fi

      - name: Install CasaOS If No Snapshot Restored
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            echo "‚ùå CasaOS installation failed, check log below:"
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "‚úÖ CasaOS installed successfully"

      - name: Start Docker & CasaOS Services
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket casaos.service
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "‚úÖ Docker & CasaOS services started successfully"
              exit 0
            fi
            echo "‚ö†Ô∏è Service start attempt $i failed, retrying..."
          done
          
          echo "‚ùå Failed to start Docker & CasaOS services after 3 attempts"
          exit 1

      - name: Deploy Tailscale Network
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "‚ö†Ô∏è Tailscale auth key not configured, skipping deployment"
            exit 0
          fi
          
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up \
            --authkey="$TAILSCALE_AUTH_KEY" \
            --accept-routes \
            --hostname="casaos-snapshot-${{ github.run_id }}"
          
          echo "‚úÖ Tailscale deployed successfully, IP address: $(sudo tailscale ip -4)"

      - name: Create Snapshot & Upload & Auto Renew
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "‚ö†Ô∏è USER_PAT or REPO not configured, cannot trigger renew"
              return 1
            fi
            
            curl -fsS -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Workflow renew triggered successfully"
              RENEW_TRIGGERED=true
            else
              echo "‚ùå Failed to trigger workflow renew"
              return 1
            fi
          }

          create_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "‚ùå WebDAV not available, skipping snapshot creation"
              return 1
            fi

            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            WEBDAV_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "üîÑ Starting snapshot creation: $SNAPSHOT_NAME (target: $WEBDAV_SNAPSHOT_DIR)"

            sudo systemctl stop docker.service docker.socket casaos.service
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5

            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS

            if [ ! -f "${TMP_SNAPSHOT}" ]; then
              echo "‚ùå Snapshot file not found: $TMP_SNAPSHOT"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi
            echo "‚úÖ Snapshot created successfully, size: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            if ! sudo touch "${WEBDAV_SNAPSHOT_DIR}/.test-write" 2>/dev/null; then
              echo "‚ùå WebDAV directory $WEBDAV_SNAPSHOT_DIR is read-only"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi
            sudo rm -f "${WEBDAV_SNAPSHOT_DIR}/.test-write"

            sudo cp "${TMP_SNAPSHOT}" "${WEBDAV_SNAPSHOT}"
            if [ $? -eq 0 ]; then
              echo "‚úÖ Snapshot copied to local mount directory"
              
              # Ê†∏ÂøÉ‰øÆÂ§çÔºöÁßªÈô§syncÂëΩ‰ª§ÁöÑ--localeÂèÇÊï∞ÔºåÊñ∞Â¢ûsync‰∏ìÂ±ûÊó•Âøó
              rclone sync "$WEBDAV_SNAPSHOT_DIR" "mywebdav:/ÂØπË±°Â≠òÂÇ®/ubuntu" \
                --config /home/runner/.rclone.conf \
                --transfers 4 \
                --log-level INFO \
                --log-file /tmp/rclone_sync.log
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Snapshot synced to WebDAV server successfully: $WEBDAV_SNAPSHOT"
                
                echo "snapshot_name=${SNAPSHOT_NAME}" | sudo tee "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" | sudo tee -a "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                rclone sync "$WEBDAV_SNAPSHOT_DIR" "mywebdav:/ÂØπË±°Â≠òÂÇ®/ubuntu" \
                  --config /home/runner/.rclone.conf \
                  --log-level INFO \
                  --log-file /tmp/rclone_meta_sync.log
              else
                echo "‚ùå Failed to sync snapshot to WebDAV server, check logs below:"
                cat /tmp/rclone_sync.log || echo "‚ö†Ô∏è No sync log file found"
                cat /tmp/rclone_mount.log || echo "‚ö†Ô∏è No mount log file found"
                sudo systemctl unmask docker.socket
                sudo systemctl start docker.service docker.socket casaos.service
                return 1
              fi
            else
              echo "‚ùå Failed to copy snapshot to WebDAV mount directory"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi

            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket casaos.service

            echo "üîÑ Cleaning old snapshots (keeping last 7 days)..."
            find "$WEBDAV_SNAPSHOT_DIR" -name "casaos-server-snapshot-*.tar.gz" -mtime +7 -delete
            if [ $? -eq 0 ]; then
              echo "‚úÖ Old snapshots cleaned successfully"
            else
              echo "‚ö†Ô∏è No old snapshots to clean"
            fi

            return 0
          }

          while true; do
            run_mins=$(( ($(date +%s) - start_time) / 60 ))
            echo "üìä Workflow running for $run_mins minutes"

            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "‚è∞ Time to create snapshot (10 minutes reached)"
              create_snapshot && trigger_renew
            fi

            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "‚èπÔ∏è Workflow reached maximum run time ($MAX_RUN_MINUTES minutes), exiting"
              exit 0
            fi

            sleep 60
          done

      - name: Cleanup Environment
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          sudo systemctl unmask docker.socket || true
          
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT"
            echo "‚úÖ WebDAV unmounted successfully"
          fi
          
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          echo "‚úÖ Environment cleaned up successfully"
