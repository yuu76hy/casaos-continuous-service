name: CasaOSéƒ¨ç½²å¤‡ä»½æµè½¬ï¼ˆå¹¶è¡Œæ¢æµ‹IPÂ·Tailscaleå…¨ç¨‹åœ¨çº¿ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
  types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 1-ç³»ç»Ÿåˆå§‹åŒ–+æ·±åº¦æ¸…ç† ====="
          sudo apt update -y -qq
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server -qq
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          sudo systemctl enable --now ssh
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–+æ¸…ç†å®Œæˆ"

      - name: 2-å®˜æ–¹çº¯å‡€å®‰è£… Docker
        run: |
          set -e
          echo "===== 2-å®‰è£… Dockerï¼ˆå®˜æ–¹æºï¼‰ ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash
          sudo systemctl enable docker containerd
          sudo systemctl stop docker containerd 2>/dev/null || true
          docker --version || true
          sudo usermod -aG docker runner
          echo "âœ… Docker å®‰è£…å®Œæˆï¼Œå·²åœæ­¢"

      - name: 3-å®‰è£… CasaOSï¼ˆå…¼å®¹æ—§ç‰ˆè„šæœ¬ï¼‰
        run: |
          set -e
          echo "===== 3-å®‰è£… CasaOS ====="
          sudo touch /usr/bin/casaos
          sudo chmod +x /usr/bin/casaos
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          echo "âœ… CasaOS å®‰è£…å®Œæˆ"

      - name: 4-åˆ›å»º roots ç®¡ç†å‘˜+SSHå¯†ç ç™»å½•
        run: |
          set -e
          echo "===== 4-é…ç½®ç®¡ç†å‘˜ç”¨æˆ· SSH ====="
          if [ -z "$SSH_PASS" ]; then
            echo "âŒ é”™è¯¯ï¼šROOTS_PASSWORD æœªé…ç½®"
            exit 1
          fi
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          echo "$USER_NAME:$SSH_PASS" | sudo chpasswd
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          echo "âœ… SSH é…ç½®å®Œæˆ"

      - name: 5-Tailscale ç»„ç½‘+ä¸Šçº¿ï¼ˆåç§°ï¼šcasaos+ä¸¤ä½æ•°å­—ï¼Œå…¨ç¨‹ä¸åœæ­¢ï¼‰
        run: |
          set -e
          echo "===== 5-Tailscale ç»„ç½‘ä¸Šçº¿ ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscale æœªé…ç½®"
            exit 0
          fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq
          sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2

          RANDOM_TWO=$(printf "%02d" $((RANDOM % 100)))
          TS_HOSTNAME="casaos${RANDOM_TWO}"
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --accept-routes --accept-dns
          sleep 5

          LOCAL_IP=$(hostname -I | awk '{print $1}')
          TS_IP=$(sudo tailscale ip -4 2>/dev/null || echo "è·å–å¤±è´¥")
          echo -e "\n=== ğŸ–¥ï¸ æœ¬æœºä¿¡æ¯ ==="
          echo "ç‰©ç†IP: $LOCAL_IP"
          echo "Tailscale IP: $TS_IP"
          echo "æœ¬æœºåç§°: $TS_HOSTNAME"
          echo "âœ… Tailscale å·²å¯åŠ¨ï¼ˆå…¨ç¨‹ä¿æŒè¿è¡Œï¼‰"

      # ===================== ã€æ ¸å¿ƒï¼šç¬¬6æ­¥ å¹¶è¡Œæ¢æµ‹æ‰€æœ‰IPã€‘=====================
      - name: 6-å¹¶è¡Œæ¢æµ‹æ‰€æœ‰ casaos[0-9]{2} è®¾å¤‡ï¼Œç»Ÿä¸€ç­‰10ç§’å–å“åº”IP
        run: |
          set -e
          echo "===== 6-å¹¶è¡Œæ¢æµ‹ casaos+ä¸¤ä½æ•°å­— è®¾å¤‡ï¼ˆç»Ÿä¸€ç­‰å¾…10ç§’ï¼‰ ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "â„¹ï¸ Tailscale æœªé…ç½®ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi

          sleep 10
          sudo tailscale status --json

          # æå–æ‰€æœ‰ casaos+ä¸¤ä½æ•°å­—ï¼šåç§° IP
          sudo tailscale status --json | jq -r '
            (.Peer // [])[] |
            select(.HostName | test("^casaos[0-9]{2}$")) |
            "\(.HostName) \(.TailscaleIPs[0])"
          ' | grep -v '^$' | sort | uniq > /tmp/casaos_devices.txt

          if [ ! -s /tmp/casaos_devices.txt ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ° casaos+ä¸¤ä½æ•°å­— è®¾å¤‡ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi

          echo -e "\n=== ğŸ“‹ å¾…æ¢æµ‹è®¾å¤‡åˆ—è¡¨ ==="
          cat /tmp/casaos_devices.txt | awk '{print "ğŸ“Œ åç§°: " $1 " | IP: " $2}'

          # å¹¶è¡Œæ¢æµ‹ï¼šå…¨éƒ¨åå°åŒæ—¶å‘è¯·æ±‚
          rm -f /tmp/responded.txt /tmp/probe_*.log
          touch /tmp/responded.txt

          while IFS=' ' read -r name ip; do
            (
              # åå°æ¢æµ‹ï¼šçœ‹/aaaä¸‹æ˜¯å¦æœ‰å¤‡ä»½æ–‡ä»¶
              result=$(sshpass -p "$SSH_PASS" \
                ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -o ConnectTimeout=8 -o ConnectionAttempts=1 \
                "$SSH_USER@$ip" "ls -t $REMOTE_BACKUP_BASE/casaos-*.tar.gz 2>/dev/null | head -1" 2>/dev/null)
              if [ -n "$result" ] && [[ "$result" != /* ]]; then
                echo "$name $ip $result" >> /tmp/responded.txt
              fi
            ) &
          done < /tmp/casaos_devices.txt

          # ã€å…³é”®ï¼šç»Ÿä¸€ç­‰å¾…10ç§’ã€‘
          echo -e "\nâ³ å¹¶è¡Œæ¢æµ‹ä¸­ï¼Œç­‰å¾… 10 ç§’æ”¶é›†æ‰€æœ‰å“åº”..."
          sleep 10

          # æ”¶é›†ç»“æœ
          if [ ! -s /tmp/responded.txt ]; then
            echo "âŒ æ— ä»»ä½•è®¾å¤‡å“åº”ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi

          echo -e "\n=== âœ… æœ‰å“åº”çš„è®¾å¤‡ ==="
          cat /tmp/responded.txt | awk '{print "âœ… åç§°: " $1 " | IP: " $2 " | å¤‡ä»½æ–‡ä»¶: " $3}'

          # å–ç¬¬ä¸€ä¸ªå“åº”çš„IP
          TARGET_INFO=$(head -n1 /tmp/responded.txt)
          TARGET_NAME=$(echo "$TARGET_INFO" | awk '{print $1}')
          TARGET_IP=$(echo "$TARGET_INFO" | awk '{print $2}')
          REMOTE_FILE=$(echo "$TARGET_INFO" | awk '{print $3}')

          echo -e "\nğŸ‰ æœ€ç»ˆé€‰å®šï¼šåç§°=$TARGET_NAME | IP=$TARGET_IP"
          echo "ğŸš€ å¼€å§‹ä¸‹è½½å¤‡ä»½..."

          sudo mkdir -p "$LOCAL_BACKUP_DIR"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$(basename "$REMOTE_FILE")"

          sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=20 \
            "$SSH_USER@$TARGET_IP:$REMOTE_FILE" "$LOCAL_FILE"

          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
            "$SSH_USER@$TARGET_IP" "rm -f '$REMOTE_FILE'" || true

          sudo tar -xzf "$LOCAL_FILE" -C / --overwrite --preserve-permissions
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "âœ… æ¢å¤å®Œæˆ"

      - name: 7-å¯åŠ¨ Docker & CasaOS
        run: |
          set -e
          echo "===== 7-å¯åŠ¨æ ¸å¿ƒæœåŠ¡ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "âœ… CasaOS æ­£å¸¸å¯åŠ¨"

      - name: 8-ç¨³å®šè¿è¡Œ 1 åˆ†é’Ÿ
        run: |
          set -e
          echo "===== 8-å»¶æ—¶ 1 åˆ†é’Ÿ ====="
          sleep 60
          echo "âœ… å·²ç¨³å®šè¿è¡Œ 1 åˆ†é’Ÿ"

      - name: 9-ä»…åœæ­¢ä¸šåŠ¡æœåŠ¡ï¼ˆTailscale ä¿æŒåœ¨çº¿ï¼‰
        run: |
          set -e
          echo "===== 9-åœæ­¢ä¸šåŠ¡æœåŠ¡ï¼ˆä¿ç•™ Tailscaleï¼‰ ====="
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sudo pkill -9 -x "casaos" "docker" "containerd" 2>/dev/null || true
          sync && sleep 3
          echo "âœ… ä¸šåŠ¡æœåŠ¡å·²åœæ­¢ï¼ŒTailscale ä¿æŒåœ¨çº¿"

      - name: 10-æœ¬åœ°å…¨é‡å¤‡ä»½
        run: |
          set -e
          echo "===== 10-ç”Ÿæˆæœ¬åœ°å…¨é‡å¤‡ä»½ ====="
          sudo mkdir -p "$LOCAL_BACKUP_DIR"
          for dir in $PERSONAL_DATA_DIRS; do sudo mkdir -p "$dir"; done

          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.gz"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$SNAP_NAME"

          sudo tar -cz \
            --ignore-failed-read \
            --exclude='*.log' --exclude='*.tmp' --exclude='*.cache' \
            --exclude='/var/lib/docker/tmp' --exclude='/var/lib/docker/containers/*/*.log' \
            --exclude='/DATA/tmp' --exclude='/DATA/cache' --exclude='/DATA/logs' \
            -f "$LOCAL_FILE" $PERSONAL_DATA_DIRS

          if [ -f "$LOCAL_FILE" ] && [ -s "$LOCAL_FILE" ]; then
            echo "âœ… å¤‡ä»½å®Œæˆï¼š$SNAP_NAME"
            echo "BACKUP_FILE=$LOCAL_FILE" >> $GITHUB_ENV
            echo "SNAP_NAME=$SNAP_NAME" >> $GITHUB_ENV
          else
            echo "âŒ å¤‡ä»½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi

      - name: 11-è§¦å‘ä¸‹ä¸€è½®ç»­è·‘ï¼ˆå·²ä¿®å¤Secretåç§°ï¼‰
        run: |
          set -e
          echo "===== 11-è§¦å‘ç»­è·‘ ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
            echo "âŒ é”™è¯¯ï¼šUSER_PAT æˆ– REPO æœªé…ç½®"
            exit 0
          fi
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token $USER_PAT" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"renew_casaos_snapshot"}')
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -eq 204 ]; then
            echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ (HTTP 204)"
          else
            echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
          fi

      - name: 12-ç§»åŠ¨å¤‡ä»½åˆ° /aaaï¼Œ30ç§’è½®è¯¢åˆ é™¤ï¼ˆTailscale å…¨ç¨‹åœ¨çº¿ï¼‰
        run: |
          set -e
          echo "===== 12-æœ¬æœº /aaa å¤‡ä»½ + ç­‰å¾…åˆ é™¤ï¼ˆTailscale ä¿æŒè¿è¡Œï¼‰ ====="
          if [ -z "$BACKUP_FILE" ] || [ -z "$SNAP_NAME" ]; then
            echo "â„¹ï¸ æ— å¤‡ä»½æ–‡ä»¶ï¼Œè·³è¿‡"
            exit 0
          fi

          LOCAL_AAA="/aaa"
          sudo mkdir -p "$LOCAL_AAA"
          TARGET_FILE="$LOCAL_AAA/$SNAP_NAME"

          sudo mv -v "$BACKUP_FILE" "$TARGET_FILE"
          echo "ğŸ”„ å·²ç§»åŠ¨åˆ° $TARGET_FILE"

          while true; do
            if [ ! -f "$TARGET_FILE" ]; then
              echo -e "\nğŸ‰ æ–‡ä»¶å·²åˆ é™¤ï¼Œæ­¥éª¤ç»“æŸ"
              break
            fi
            echo "â†’ æ–‡ä»¶å­˜åœ¨ï¼Œ30ç§’åé‡è¯•ï¼ˆTailscale æ­£å¸¸åœ¨çº¿ï¼‰"
            sleep 30
          done

      - name: 13-æœ€ç»ˆæ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 13-æœ€ç»ˆæ¸…ç† ====="
          sudo rm -rf "$LOCAL_BACKUP_DIR" /tmp/* 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… å…¨éƒ¨æµç¨‹æ­£å¸¸ç»“æŸ"