name: CasaOS-Server-å¿«ç…§-å¤‡ä»½-æ¢å¤

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      # ç»ˆæå®Œæ•´ç‰ˆè·¯å¾„ï¼šDocker+CasaOSæ ¸å¿ƒå…¨è¦†ç›–ï¼Œæ— å†—ä½™æ— é—æ¼
      CORE_DIRS: "/var/lib/docker /etc/docker /etc/default/docker /run/docker.sock /etc/systemd/system/docker.service.d /usr/lib/systemd/system/docker.service /etc/casaos /var/lib/casaos /usr/bin/casaos /usr/local/bin/casaos /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service /DATA"
      # æ ‡å‡†åŒ–æ’é™¤è§„åˆ™ï¼šæ— ä¸­æ–‡ï¼Œç²¾å‡†è¿‡æ»¤æ— ç”¨æ–‡ä»¶ï¼Œä¸ç¢°æ ¸å¿ƒ
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/buildkit
        --exclude=*.log
        --exclude=*.tmp
        --exclude=*.cache
        --exclude=/DATA/tmp
        --exclude=/DATA/cache
        --exclude=/DATA/logs
        --exclude=/etc/systemd/system/*.wants
        --exclude=/etc/systemd/system/*.requires
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: yuu76hy/casaos-continuous-service
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true

    steps:
      - name: ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–å®‰è£…
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ…ç¯å¢ƒå·²æˆåŠŸåˆå§‹åŒ–"

      - name: åˆ›å»ºæ ¹ç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots ç”¨æˆ·åˆ›å»ºï¼Œå¯†ç ï¼š$RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi

      - name: é…ç½® Rclone for WebDAVï¼ˆæ— æŒ‚è½½æ¨¡å¼ï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒç¼ºå°‘WebDAVå‡­è¯"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAVè¿æ¥å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "âœ… WebDAVè¿æ¥æˆåŠŸ"
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf || true
          echo "âœ… è¿œç¨‹ç›®å½•å°±ç»ªï¼šmywebdav:${WEBDAV_SNAPSHOT_EN_DIR}"
          # è·å–æœ€æ–°å¿«ç…§ï¼Œå…¼å®¹è·¯å¾„æ ¼å¼
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "casaos-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(basename "$(echo "$REMOTE_SNAPSHOTS" | head -n1)")
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¿«ç…§ï¼š${LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ è¿œç¨‹ç›®å½•æ— å¿«ç…§æ–‡ä»¶"
          fi

      - name: ä»WebDAVæ¢å¤å¿«ç…§
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹æ¢å¤å¿«ç…§ï¼š${LATEST_SNAPSHOT} ====="
          
          # åœæ­¢ç›¸å…³æœåŠ¡ï¼Œæ¸…ç†æ®‹ç•™é”æ–‡ä»¶
          sudo systemctl stop docker.service docker.socket casaos.service || true
          sudo systemctl mask docker.socket casaos.service
          sudo pkill -9 docker containerd casaos || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock
          sync && sleep 5
          
          # æœåŠ¡çŠ¶æ€æ£€æŸ¥ï¼Œå‹å¥½æç¤º
          if systemctl is-active --quiet casaos.service; then
            sudo systemctl stop casaos.service
            echo "âœ… å·²åœæ­¢casaos.service"
          else
            echo "âš ï¸ casaos.serviceæœªåŠ è½½ï¼Œè·³è¿‡åœæ­¢"
          fi
          
          # å¿«ç…§æœ‰æ•ˆæ€§æ ¡éªŒï¼Œé¿å…æ— æ•ˆæ¢å¤
          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "âŒ è¿œç¨‹å¿«ç…§æ— æ•ˆæˆ–æ— æ³•è¯»å–"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            exit 1
          fi
          
          # æ¢å¤å¿«ç…§ï¼Œæ— ç»å¯¹è·¯å¾„å†²çªï¼Œå®Œæ•´è¿˜åŸ
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --warning=no-all --preserve-permissions ${EXCLUDE_RULES}
          if [ $? -eq 0 ]; then
            echo "âœ… å¿«ç…§æ¢å¤æˆåŠŸ"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            # åˆ é™¤å·²æ¢å¤å¿«ç…§ï¼ŒèŠ‚çœç©ºé—´
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf || true
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt --config /home/runner/.rclone.conf || true
            echo "âœ… å·²æ¸…ç†è¿œç¨‹å·²æ¢å¤å¿«ç…§æ–‡ä»¶"
            # ç«‹å³è§£é™¤æ©ç ï¼Œåˆ·æ–°é…ç½®
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl daemon-reload
          else
            echo "âŒ å¿«ç…§æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl daemon-reload
            exit 1
          fi

      - name: æ— å¿«ç…§æ—¶å®‰è£…CasaOS
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOSå…¨æ–°å®‰è£…æˆåŠŸ"

      - name: å¿«ç…§æ¢å¤åé‡å¯æœåŠ¡ï¼ˆå«è‡ªåŠ¨ä¿®å¤ï¼‰
        if: ${{ env.SNAPSHOT_RESTORED == 'true' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket casaos.service || true
          sudo systemctl daemon-reload
          
          # DockeræœåŠ¡å¯åŠ¨ï¼ˆ5æ¬¡é‡è¯•ï¼Œç¡®ä¿å¯åŠ¨æˆåŠŸï¼‰
          echo "ğŸ”„ å¯åŠ¨DockeræœåŠ¡ï¼ˆé‡è¯•æœºåˆ¶ï¼‰......"
          docker_start_success=false
          for i in $(seq 1 5); do
            sudo systemctl start docker.service docker.socket
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸï¼ˆç¬¬${i}æ¬¡å°è¯•ï¼‰"
              docker_start_success=true
              break
            else
              echo "âš ï¸ Dockerå¯åŠ¨å¤±è´¥ï¼ˆç¬¬${i}æ¬¡å°è¯•ï¼‰ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
              sudo journalctl -u docker --no-pager -n 20
              sudo systemctl reset-failed docker
              sleep 5
            fi
          done
          
          if [ "$docker_start_success" = "false" ]; then
            echo "âŒ DockeræœåŠ¡å¤šæ¬¡å¯åŠ¨å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi

          # æ ¸å¿ƒä¿®å¤ï¼šCasaOSæ–‡ä»¶+æƒé™+ä¾èµ–ä¸€ç«™å¼ä¿®å¤
          echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤CasaOSæ ¸å¿ƒä¾èµ–ä¸æƒé™......"
          sudo mkdir -p /etc/casaos /var/lib/casaos /usr/local/bin /var/lib/docker
          # è¡¥å…¨CasaOSå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒè·¯å¾„å…¼å®¹å…œåº•
          if [ ! -f "/usr/bin/casaos" ] && [ ! -f "/usr/local/bin/casaos" ]; then
            echo "âš ï¸ CasaOSå¯æ‰§è¡Œæ–‡ä»¶ç¼ºå¤±ï¼Œè‡ªåŠ¨è¡¥å…¨å®‰è£…"
            curl -fsSL https://get.casaos.io | sudo bash -s -- --skip-config
          fi
          [ -f "/usr/local/bin/casaos" ] && sudo ln -sf /usr/local/bin/casaos /usr/bin/casaos || true
          # æ›¿æ¢å®˜æ–¹æ ‡å‡†serviceæ–‡ä»¶ï¼Œè§£å†³é…ç½®é”™è¯¯
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service
          curl -fsSL https://raw.githubusercontent.com/IceWhaleTech/CasaOS/main/service/casaos.service -o /tmp/casaos.service
          sudo cp /tmp/casaos.service /etc/systemd/system/
          sudo cp /tmp/casaos.service /usr/lib/systemd/system/
          sudo chmod 644 /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service
          sudo chown root:root /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service
          # ä¿®å¤Dockerå¥—æ¥å­—æƒé™ï¼ŒCasaOSå¿…å¤‡
          sudo chmod 660 /run/docker.sock
          sudo chown root:docker /run/docker.sock
          # è¡¥å…¨CasaOSé»˜è®¤ç½‘ç»œ
          sudo docker network create casaos || true
          sudo systemctl daemon-reload

          # CasaOSæœåŠ¡å¯åŠ¨ï¼ˆ3æ¬¡é‡è¯•ï¼‰
          echo "ğŸ”„ å¯åŠ¨CasaOSæœåŠ¡ï¼ˆé‡è¯•æœºåˆ¶ï¼‰......"
          casaos_start_success=false
          for i in $(seq 1 3); do
            sudo systemctl start casaos.service
            sleep 5
            if sudo systemctl is-active --quiet casaos.service; then
              echo "âœ… CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸï¼ˆç¬¬${i}æ¬¡å°è¯•ï¼‰"
              casaos_start_success=true
              break
            else
              echo "âš ï¸ CasaOSå¯åŠ¨å¤±è´¥ï¼ˆç¬¬${i}æ¬¡å°è¯•ï¼‰ï¼Œè¯¦ç»†æ—¥å¿—ï¼š"
              sudo systemctl status casaos.service -l
              sudo journalctl -xeu casaos.service --no-pager | head -30
              sudo systemctl reset-failed casaos
              sleep 3
            fi
          done
          
          if [ "$casaos_start_success" = "false" ]; then
            echo "âš ï¸ CasaOSæœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒDockerå·²æ­£å¸¸è¿è¡Œï¼Œè¯·æ‰‹åŠ¨æ’æŸ¥"
            echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€æ±‡æ€»ï¼š"
            sudo systemctl status docker --no-pager
            sudo systemctl status casaos --no-pager
            exit 1
          fi
          
          # æœ€ç»ˆæœåŠ¡çŠ¶æ€è¾“å‡ºï¼Œä¾¿äºéªŒè¯
          echo "ğŸ“Š å¿«ç…§æ¢å¤å®Œæˆï¼ŒæœåŠ¡çŠ¶æ€æ­£å¸¸"
          sudo systemctl status docker --no-pager
          sudo systemctl status casaos --no-pager

      - name: å…¨æ–°å®‰è£…åå¯åŠ¨æœåŠ¡
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket || true
          
          # Dockerå¯åŠ¨é‡è¯•
          docker_start_success=false
          for i in $(seq 1 5); do
            sudo systemctl enable --now docker.service docker.socket
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo docker ps >/dev/null 2>&1; then
              echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸï¼ˆç¬¬${i}æ¬¡å°è¯•ï¼‰"
              docker_start_success=true
              break
            fi
            echo "âš ï¸ Dockerå¯åŠ¨å¤±è´¥ï¼ˆç¬¬${i}æ¬¡å°è¯•ï¼‰ï¼Œé‡è¯•ä¸­..."
            sudo systemctl reset-failed docker
          done
          
          if [ "$docker_start_success" = "false" ]; then
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          
          # CasaOSå¯åŠ¨
          if systemctl list-unit-files | grep -q casaos.service; then
            sudo systemctl enable --now casaos.service
            sleep 5
            if sudo systemctl is-active --quiet casaos.service; then
              echo "âœ… CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸ"
            else
              echo "âš ï¸ CasaOSå¯åŠ¨å¤±è´¥ï¼Œå¯æŸ¥çœ‹æ—¥å¿—æ’æŸ¥ï¼šsudo journalctl -u casaos"
            fi
          fi

      - name: éƒ¨ç½²Tailscaleï¼ˆè¿œç¨‹è®¿é—®ï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ]; then
            echo "âŒ Tailscaleå®‰è£…å¤±è´¥"
            exit 0
          fi
          # å¯åŠ¨Tailscaleå¹¶é…ç½®
          if ! sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"; then
            echo "âŒ Tailscaleç™»å½•å¤±è´¥"
            sudo "$TAILSCALE_PATH" status
            exit 0
          fi
          echo "âœ… Tailscaleéƒ¨ç½²æˆåŠŸï¼ŒIPv4åœ°å€ï¼š$(sudo "$TAILSCALE_PATH" ip -4)"

      - name: åˆ›å»ºå¿«ç…§å¹¶ä¸Šä¼ WebDAVï¼ˆæ ¸å¿ƒä¼˜åŒ–ç‰ˆï¼‰
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false
          
          # ç»­è·‘å·¥ä½œæµè§¦å‘å‡½æ•°ï¼ˆå®¹é”™å¤„ç†ï¼‰
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ USER_PATæˆ–ä»“åº“åœ°å€ä¸ºç©ºï¼Œæ— æ³•è§¦å‘ç»­è·‘"
              return 1
            fi
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${REPO}/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}' || true; then
              echo "âŒ ç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥"
              return 1
            fi
            echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true
            return 0
          }
          
          # å¿«ç…§åˆ›å»ºä¸Šä¼ æ ¸å¿ƒå‡½æ•°ï¼ˆæ ¹æ²»æ‰“åŒ…/æƒé™é—®é¢˜ï¼‰
          create_and_upload_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAVä¸å¯ç”¨ï¼Œè·³è¿‡å¤‡ä»½"
              return 1
            fi
            
            echo "ğŸ” å¤‡ä»½å‰ç½®æ£€æŸ¥ï¼šè¡¥å…¨è·¯å¾„+æ ¡éªŒç©ºé—´"
            # è¡¥å…¨Dockeræ ¸å¿ƒè·¯å¾„ï¼ˆä»…åˆ›å»ºä¸å­˜åœ¨çš„ç›®å½•ï¼‰
            docker_core_paths=("/var/lib/docker" "/etc/docker" "/run" "/etc/default/docker" "/etc/systemd/system/docker.service.d")
            for path in "${docker_core_paths[@]}"; do
              if [ ! -d "$path" ]; then
                sudo mkdir -p "$path"
                echo "âœ… åˆ›å»ºDockerè·¯å¾„ï¼š$path"
              fi
            done
            # è¡¥å…¨CasaOSæ ¸å¿ƒè·¯å¾„ï¼ˆé¿å…æ¼å¤‡ï¼‰
            casaos_core_paths=("/etc/casaos" "/var/lib/casaos" "/usr/local/bin")
            for path in "${casaos_core_paths[@]}"; do
              if [ ! -d "$path" ]; then
                sudo mkdir -p "$path"
                echo "âœ… åˆ›å»ºCasaOSè·¯å¾„ï¼š$path"
              fi
            done
            # ä¿®å¤docker.sockæƒé™ï¼Œç¡®ä¿å¤‡ä»½æƒé™æ­£ç¡®
            [ -S "/run/docker.sock" ] && sudo chmod 660 /run/docker.sock && sudo chown root:docker /run/docker.sock || true
            
            # ç£ç›˜ç©ºé—´æ£€æŸ¥ï¼Œé¿å…å†™æ»¡å¤±è´¥ï¼ˆå…³é”®ï¼‰
            SNAPSHOT_DIR="/home/runner/tmp/casaos_snapshot"
            sudo mkdir -p "${SNAPSHOT_DIR}"
            sudo chown runner:runner "${SNAPSHOT_DIR}"
            sudo chmod 777 "${SNAPSHOT_DIR}"
            FREE_SPACE=$(df -k "${SNAPSHOT_DIR}" | awk 'NR==2 {print $4}')
            FREE_SPACE_GB=$(( FREE_SPACE / 1024 / 1024 ))
            if [ "${FREE_SPACE_GB}" -lt 5 ]; then
              echo "âŒ ä¸´æ—¶ç›®å½•å¯ç”¨ç©ºé—´ä¸è¶³5GBï¼ˆå½“å‰${FREE_SPACE_GB}GBï¼‰ï¼Œæ— æ³•å¤‡ä»½"
              return 1
            fi
            echo "âœ… ä¸´æ—¶ç›®å½•å¯ç”¨ç©ºé—´ï¼š${FREE_SPACE_GB}GBï¼Œæ»¡è¶³å¤‡ä»½è¦æ±‚"
            
            # ç”Ÿæˆå¿«ç…§ä¿¡æ¯ï¼Œä¸“å±ç›®å½•å­˜å‚¨ï¼ˆé¿å…æƒé™å†²çªï¼‰
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="${SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ å¼€å§‹æ‰“åŒ…å¤‡ä»½ï¼ˆå…ˆå¤‡ååœï¼Œæ ¸å¿ƒæ— é—æ¼ï¼‰"
            
            # æ‰“åŒ…æ ¸å¿ƒä¼˜åŒ–ï¼šrunneræƒé™+æ— ç»å¯¹è·¯å¾„+è½¯é“¾å¤‡ä»½å®é™…æ–‡ä»¶
            sudo -u runner tar -czf "${TMP_SNAPSHOT}" \
              --ignore-failed-read \
              --warning=no-all \
              --preserve-permissions \
              --dereference \
              ${EXCLUDE_RULES} \
              ${CORE_DIRS}
            
            # å¼ºåˆ¶æ ¡éªŒï¼šCasaOSæ ¸å¿ƒæ–‡ä»¶å¿…é¡»å¤‡ä»½æˆåŠŸï¼ˆæœç»æ¼å¤‡ï¼‰
            echo "ğŸ” æ ¡éªŒå¤‡ä»½å®Œæ•´æ€§ï¼Œæ ¸å¿ƒæ–‡ä»¶å¿…æŸ¥"
            if ! tar -tzf "${TMP_SNAPSHOT}" 2>/dev/null | grep -q "var/lib/casaos" || ! tar -tzf "${TMP_SNAPSHOT}" 2>/dev/null | grep -q "usr/bin/casaos"; then
              echo "âŒ CasaOSæ ¸å¿ƒæ–‡ä»¶æœªå¤‡ä»½æˆåŠŸï¼Œæ‰“åŒ…å¤±è´¥"
              rm -f "${TMP_SNAPSHOT}"
              rm -rf "${SNAPSHOT_DIR}"
              return 1
            fi
            SNAPSHOT_SIZE=$(du -sh "${TMP_SNAPSHOT}" | awk '{print $1}' || true)
            echo "âœ… å¿«ç…§æ‰“åŒ…æˆåŠŸï¼Œå¤§å°ï¼š${SNAPSHOT_SIZE}"
            
            # å¤‡ä»½å®Œæˆååœæ­¢æœåŠ¡ï¼Œé¿å…æ–‡ä»¶å ç”¨ï¼ˆä¸å½±å“å·²å¤‡ä»½æ–‡ä»¶ï¼‰
            echo "ğŸ›‘ å¤‡ä»½å®Œæˆï¼Œåœæ­¢ç›¸å…³æœåŠ¡æ¸…ç†èµ„æº"
            sudo systemctl stop docker.service docker.socket casaos.service || true
            sudo systemctl mask docker.socket casaos.service
            sudo pkill -9 docker containerd casaos || true
            sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock
            sync && sleep 5
            
            # ä¸Šä¼ å¿«ç…§åˆ°WebDAVï¼Œrunneræƒé™ç›´æ¥ä¸Šä¼ 
            echo "ğŸ“¤ ä¸Šä¼ å¿«ç…§åˆ°WebDAV..."
            if ! rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --log-level INFO \
              --log-file "${SNAPSHOT_DIR}/rclone_upload.log"; then
              echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥ï¼Œæ—¥å¿—ï¼š${SNAPSHOT_DIR}/rclone_upload.log"
              cat "${SNAPSHOT_DIR}/rclone_upload.log" || true
              rm -f "${TMP_SNAPSHOT}"
              rm -rf "${SNAPSHOT_DIR}"
              return 1
            fi
            echo "âœ… å¿«ç…§ä¸Šä¼ æˆåŠŸï¼š${REMOTE_PATH}"
            
            # ä¸Šä¼ å¤‡ä»½å…ƒæ•°æ®ï¼Œä¾¿äºè¯†åˆ«
            META_FILE="${SNAPSHOT_DIR}/snapshot_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            echo "backup_size=${SNAPSHOT_SIZE}" >> "${META_FILE}"
            rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf || true
            
            # æ¸…ç†æœ¬åœ°æ–‡ä»¶+æ¢å¤æœåŠ¡è¿è¡Œ
            rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
            rm -rf "${SNAPSHOT_DIR}"
            sudo systemctl unmask docker.socket casaos.service
            sudo systemctl start docker.service docker.socket casaos.service || true
            echo "âœ… å¤‡ä»½å…¨æµç¨‹å®Œæˆï¼ŒæœåŠ¡å·²æ¢å¤è¿è¡Œ"
            return 0
          }
          
          # ä¸»å¾ªç¯ï¼šå®šæ—¶å¤‡ä»½+ç»­è·‘ï¼Œé¿å…è¶…æ—¶ä¸­æ–­
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "ğŸ“Š å·¥ä½œæµç¨‹å·²è¿è¡Œ${run_mins}åˆ†é’Ÿ"
            
            # è¿è¡Œ2åˆ†é’Ÿè§¦å‘å¤‡ä»½ï¼Œä»…è§¦å‘ä¸€æ¬¡
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è¾¾åˆ°è§¦å‘æ¡ä»¶ï¼Œå¯åŠ¨å¤‡ä»½æµç¨‹"
              if create_and_upload_snapshot; then
                trigger_renew
              else
                echo "âŒ å¿«ç…§åˆ›å»ºå¤±è´¥ï¼Œè·³è¿‡ç»­è·‘"
              fi
            fi
            
            # è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œæ­£å¸¸é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œå·¥ä½œæµæ­£å¸¸é€€å‡º"
              exit 0
            fi
            
            sleep 60
          done

      - name: æµç¨‹æ”¶å°¾æ¸…ç†ï¼ˆæ— è®ºæˆè´¥éƒ½æ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # è§£é™¤æœåŠ¡æ©ç ï¼Œæ¢å¤æ­£å¸¸çŠ¶æ€
          sudo systemctl unmask docker.socket casaos.service || true
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶+é…ç½®æ®‹ç•™
          sudo rm -rf /home/runner/tmp/casaos_snapshot /tmp/casaos-server-snapshot-*.tar.gz
          sudo rm -rf /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log /tmp/casaos.service
          echo "âœ… æ”¶å°¾æ¸…ç†å®Œæˆï¼Œæ— æ®‹ç•™æ–‡ä»¶"
