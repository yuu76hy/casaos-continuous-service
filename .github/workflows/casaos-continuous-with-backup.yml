name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆTailscaleå†…ç½‘ç‰ˆ /aaaç›®å½• æ‹‰å–å³åˆ  æ— é™æ£€æµ‹åˆ é™¤ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 480
    env:
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA"
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"
      TARGET_RUN_MINUTES: 300
      RETRY_TIMES: 3
      ZSTD_COMPRESS_LEVEL: 8

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç†ï¼ˆæ— Docker/CasaOSå¸è½½ï¼‰
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼ï¼Œå•ä¸ªå‘½ä»¤å¤±è´¥ä¸é€€å‡ºè„šæœ¬
          echo "===== [æ—¥å¿—] 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç† å¼€å§‹ ====="
          sudo apt update -y -qq || true
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server zstd -qq || true
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          sudo systemctl enable --now ssh || true
          echo "âœ… [æ—¥å¿—] 1-ç³»ç»Ÿåˆå§‹åŒ–+æ·±åº¦æ¸…ç†å®Œæˆ"
          echo "===== [æ—¥å¿—] 1-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 2-å®˜æ–¹çº¯å‡€å®‰è£… Docker
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 2-å®‰è£… Dockerï¼ˆå®˜æ–¹æºï¼‰ å¼€å§‹ ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash || true
          sudo systemctl enable docker containerd || true
          sudo systemctl stop docker containerd 2>/dev/null || true
          docker --version || true
          sudo usermod -aG docker runner || true
          echo "âœ… [æ—¥å¿—] 2-Docker å®‰è£…å®Œæˆ"
          echo "===== [æ—¥å¿—] 2-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 3-å®˜æ–¹çº¯å‡€å®‰è£… CasaOS
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 3-å®‰è£… CasaOS å¼€å§‹ ====="
          curl -fsSL https://get.casaos.io | sudo bash || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          echo "âœ… [æ—¥å¿—] 3-CasaOS å®‰è£…å®Œæˆ"
          echo "===== [æ—¥å¿—] 3-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 4-åˆ›å»º roots ç®¡ç†å‘˜+SSHå¯†ç ç™»å½•
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 4-é…ç½®ç®¡ç†å‘˜ç”¨æˆ· roots å¼€å§‹ ====="
          if [ -z "$SSH_PASS" ]; then
            echo "âŒ [æ—¥å¿—] é”™è¯¯ï¼šROOTS_PASSWORD æœªé…ç½®ï¼Œé€€å‡ºæœ¬æ­¥éª¤"
            exit 0
          fi
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME" || true
          echo "$USER_NAME:$SSH_PASS" | sudo chpasswd || true
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null || true
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME" || true
          sudo usermod -aG docker "$USER_NAME" || true
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config 2>/dev/null || true
          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null || true
          sudo systemctl restart ssh || true
          echo "âœ… [æ—¥å¿—] 4-ç®¡ç†å‘˜ç”¨æˆ· & SSH é…ç½®å®Œæˆ"
          echo "===== [æ—¥å¿—] 4-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 5-Tailscale ç»„ç½‘+ä¸Šçº¿+æ˜¾ç¤ºæœ¬æœºIPåœ°å€ï¼ˆå®˜æ–¹ä¸€é”®å®‰è£…ï¼‰
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 5-Tailscaleç»„ç½‘ + æ˜¾ç¤ºæœ¬æœºä¿¡æ¯ å¼€å§‹ ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ [æ—¥å¿—] Tailscale æœªé…ç½®ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash || true
          sudo systemctl enable --now tailscaled && sleep 2 || true
          TS_SUFFIX=$((RANDOM % 1000))
          TS_HOSTNAME="CasaOS-${TS_SUFFIX}"
          echo "[æ—¥å¿—] æœ¬æ¬¡ Tailscale ä¸»æœºåï¼š${TS_HOSTNAME}"
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --accept-routes --reset || true
          echo -e "\n[æ—¥å¿—] === ğŸ–¥ï¸ æœ¬æœº IP ä¿¡æ¯ ==="
          LOCAL_IP=$(hostname -I | awk '{print $1}')
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "è·å–å¤±è´¥")
          echo "[æ—¥å¿—] ç‰©ç†å†…ç½‘IP: $LOCAL_IP"
          echo "[æ—¥å¿—] Tailscaleå†…ç½‘IP: $TAILSCALE_IP"
          echo "===================================\n"
          echo "âœ… [æ—¥å¿—] 5-Tailscale ç»„ç½‘ä¸Šçº¿å®Œæˆ"
          echo "===== [æ—¥å¿—] 5-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 6-ä»å†…ç½‘/aaaæ‹‰å¤‡ä»½â†’å¤šèŠ‚ç‚¹é€ä¸ªå°è¯•â†’åˆ è¿œç¨‹â†’æœ¬åœ°æ¢å¤
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 6-å¤šèŠ‚ç‚¹å°è¯•æ‹‰å–å¤‡ä»½ï¼ˆæ‹‰å–å³åˆ ï¼‰ å¼€å§‹ ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ] || [ -z "$SSH_PASS" ]; then
            echo "â„¹ï¸ [æ—¥å¿—] æœªé…ç½® Tailscale/SSHï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi
          TS_STATUS_JSON=$(sudo tailscale status --json || true)
          SELF_ID=$(echo "$TS_STATUS_JSON" | jq -r '.Self.ID' || true)
          SELF_HOSTNAME=$(echo "$TS_STATUS_JSON" | jq -r '.Self.HostName' || true)
          echo "[æ—¥å¿—] æœ¬æœº Tailscale ID: $SELF_ID"
          echo "[æ—¥å¿—] æœ¬æœº Tailscale ä¸»æœºå: $SELF_HOSTNAME"
          TARGET_LIST=$(echo "$TS_STATUS_JSON" | jq -r --arg self "$SELF_ID" '
            .Peer[] |
            select(.Online == true) |
            select(.ID != $self) |
            select( (.HostName | tostring | ascii_downcase) | contains("casaos") ) |
            "\(.HostName // "unknown")|\(.TailscaleIPs[0] // "no-ip")|\(.Online)"
          ' || true)
          if [ -z "$TARGET_LIST" ]; then
            echo "â„¹ï¸ [æ—¥å¿—] æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶èŠ‚ç‚¹ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi
          echo -e "\n[æ—¥å¿—] ç¬¦åˆæ¡ä»¶èŠ‚ç‚¹ï¼š"
          echo "$TARGET_LIST" | while IFS='|' read -r h ip online; do
            echo "  - è®¾å¤‡ï¼š$h ï½œ IPï¼š$ip ï½œ åœ¨çº¿ï¼š$online"
          done
          echo -e "\n[æ—¥å¿—] åœæ­¢ Docker/CasaOS ä»¥å®‰å…¨æ¢å¤..."
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 "casaos" "docker" "containerd" 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sync && sleep 3 || true
          sudo mkdir -p "$LOCAL_BACKUP_DIR" || true
          sudo chmod 777 "$LOCAL_BACKUP_DIR" || true
          RESTORE_SUCCESS=0
          while IFS='|' read -r TARGET_HOST TARGET_IP TARGET_ONLINE; do
            echo -e "\n==========================================================="
            echo "[æ—¥å¿—] ğŸ¯ å°è¯•èŠ‚ç‚¹ï¼š$TARGET_HOST | $TARGET_IP"
            echo "==========================================================="
            LATEST_FILE=""
            for ((i=1; i<=RETRY_TIMES; i++)); do
              LATEST_FILE=$(sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
                "$SSH_USER@$TARGET_IP" "ls -t \"$REMOTE_BACKUP_BASE\"/casaos-*.tar.zst 2>/dev/null | head -1" || true)
              [ -n "$LATEST_FILE" ] && break
              sleep 3
            done
            if [ -z "$LATEST_FILE" ]; then
              echo "[æ—¥å¿—] âš ï¸ æ— å¤‡ä»½ï¼Œè·³è¿‡"
              continue
            fi
            LOCAL_FILE="$LOCAL_BACKUP_DIR/$(basename "$LATEST_FILE")"
            pull_success=0
            for ((i=1; i<=RETRY_TIMES; i++)); do
              if sudo sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
                "$SSH_USER@$TARGET_IP:$LATEST_FILE" "$LOCAL_FILE"; then
                pull_success=1
                break
              fi
              sleep 3
            done
            if [ $pull_success -ne 1 ] || [ ! -s "$LOCAL_FILE" ]; then
              echo "[æ—¥å¿—] âš ï¸ æ‹‰å–å¤±è´¥/æ–‡ä»¶æ— æ•ˆ"
              rm -f "$LOCAL_FILE" 2>/dev/null || true
              continue
            fi
            echo -e "\n[æ—¥å¿—] ğŸ—‘ï¸ æ‹‰å–æˆåŠŸï¼Œæ‰§è¡Œæ‹‰å–å³åˆ ï¼šåˆ é™¤è¿œç¨‹æ–‡ä»¶"
            sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              "$SSH_USER@$TARGET_IP" "sudo rm -f '$LATEST_FILE'" || echo "[æ—¥å¿—] âš ï¸ è¿œç¨‹åˆ é™¤å¤±è´¥ï¼Œç»§ç»­æ¢å¤"
            echo -e "\n[æ—¥å¿—] ğŸ”§ å¼€å§‹è§£å‹æ¢å¤ï¼ˆzstd æœ€é«˜å‹ç¼©ï¼‰"
            sudo tar --zstd -xf "$LOCAL_FILE" -C / --overwrite --preserve-permissions || true
            echo "[æ—¥å¿—] ä¿®å¤ç›®å½•æƒé™..."
            for dir in $PERSONAL_DATA_DIRS; do
              [ -d "$dir" ] && sudo chown -R root:root "$dir" || true
            done
            [ -d "/etc/casaos" ]     && sudo chmod -R 755 /etc/casaos || true
            [ -d "/DATA" ]           && sudo chmod -R 755 /DATA || true
            [ -d "/var/lib/casaos" ] && sudo chmod -R 700 /var/lib/casaos || true
            [ -d "/var/lib/docker" ] && sudo chmod -R 700 /var/lib/docker || true
            echo -e "\n[æ—¥å¿—] ğŸ‰ èŠ‚ç‚¹ $TARGET_HOST æ¢å¤æˆåŠŸï¼"
            RESTORE_SUCCESS=1
            break
          done < <(echo "$TARGET_LIST")
          if [ $RESTORE_SUCCESS -ne 1 ]; then
            echo -e "\n[æ—¥å¿—] âŒ æ‰€æœ‰èŠ‚ç‚¹å‡å¤±è´¥ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi
          echo -e "\nâœ… [æ—¥å¿—] 6-æ¢å¤æµç¨‹å®Œæˆ"
          echo "===== [æ—¥å¿—] 6-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 7-å¯åŠ¨ Docker & CasaOS
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 7-å¯åŠ¨ Docker & CasaOS å¼€å§‹ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo systemctl daemon-reload || true
          sudo systemctl enable --now docker containerd && sleep 5 || true
          sudo systemctl enable --now casaos && sleep 6 || true
          echo "âœ… [æ—¥å¿—] 7-Docker & CasaOS å¯åŠ¨å®Œæˆ"
          echo "===== [æ—¥å¿—] 7-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 8-ç¨³å®šè¿è¡ŒæŒ‡å®šåˆ†é’Ÿ
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 8-ç¨³å®šè¿è¡Œ $TARGET_RUN_MINUTES åˆ†é’Ÿ å¼€å§‹ ====="
          RUN_SECONDS=$((TARGET_RUN_MINUTES * 60))
          echo "[æ—¥å¿—] æ€»ç­‰å¾…ç§’æ•°ï¼š$RUN_SECONDS"
          sleep $RUN_SECONDS || true
          echo "âœ… [æ—¥å¿—] 8-ç¨³å®šè¿è¡Œå®Œæˆ"
          echo "===== [æ—¥å¿—] 8-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 9-åœæ­¢ä¸šåŠ¡æœåŠ¡ï¼ˆå®‰å…¨å¤‡ä»½ï¼Œä¿ç•™Tailscaleåœ¨çº¿ï¼‰
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 9-åœæ­¢ä¸šåŠ¡æœåŠ¡ï¼ˆä¿ç•™Tailscaleï¼‰ å¼€å§‹ ====="
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sudo pkill -9 "casaos" "docker" "containerd" 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sudo umount /var/lib/docker/overlay2/*/merged 2>/dev/null || true
          sync && sleep 5 || true
          echo "âœ… [æ—¥å¿—] 9-ä¸šåŠ¡æœåŠ¡å·²åœæ­¢"
          echo "===== [æ—¥å¿—] 9-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 10-æœ¬åœ°å…¨é‡å¤‡ä»½ï¼ˆtar.zst æœ€é«˜å‹ç¼© ä¸å«/root/.configï¼‰
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 10-ç”Ÿæˆæœ¬åœ°å…¨é‡å¤‡ä»½ å¼€å§‹ ====="
          sudo mkdir -p "$LOCAL_BACKUP_DIR" || true
          IFS=' ' read -r -a DIR_ARRAY <<< "$PERSONAL_DATA_DIRS"
          for dir in "${DIR_ARRAY[@]}"; do
            [ ! -d "$dir" ] && sudo mkdir -p "$dir" || true
          done
          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$SNAP_NAME"
          echo "[æ—¥å¿—] å¤‡ä»½æ–‡ä»¶ï¼š$SNAP_NAME"
          sudo tar -I"zstd -$ZSTD_COMPRESS_LEVEL" -cf "$LOCAL_FILE" \
            --ignore-failed-read --preserve-permissions \
            "${DIR_ARRAY[@]}" || true
          if [ -f "$LOCAL_FILE" ] && [ -s "$LOCAL_FILE" ]; then
            echo "[æ—¥å¿—] âœ… å¤‡ä»½æœ‰æ•ˆ"
            echo "BACKUP_FILE=$LOCAL_FILE" >> $GITHUB_ENV || true
            echo "SNAP_NAME=$SNAP_NAME" >> $GITHUB_ENV || true
          else
            echo "[æ—¥å¿—] âŒ å¤‡ä»½æ–‡ä»¶æ— æ•ˆ"
            exit 0
          fi
          echo "âœ… [æ—¥å¿—] 10-å¤‡ä»½å®Œæˆ"
          echo "===== [æ—¥å¿—] 10-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 11-è§¦å‘ä¸‹ä¸€è½®ç»­è·‘ã€å¸¦æ ¡éªŒ+å¤±è´¥é‡å‘ã€‘ç¡®ä¿ä¸€å®šæˆåŠŸ
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 11-å¸¦è‡ªåŠ¨æ ¡éªŒçš„ç»­è·‘è§¦å‘ å¼€å§‹ ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
            echo "âš ï¸ [æ—¥å¿—] æœªé…ç½® PAT/REPOï¼Œè·³è¿‡"
            exit 0
          fi
          RETRY_DISPATCH_TIMES=5
          DISPATCH_WAIT_SECONDS=10
          WORKFLOW_NAME="CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆTailscaleå†…ç½‘ç‰ˆ /aaaç›®å½• æ‹‰å–å³åˆ  æ— é™æ£€æµ‹åˆ é™¤ï¼‰"
          DISPATCH_SUCCESS=0
          for ((retry=1; retry<=RETRY_DISPATCH_TIMES; retry++)); do
            echo -e "\n[æ—¥å¿—] ç¬¬ $retry æ¬¡è§¦å‘ç»­è·‘..."
            curl -s -f -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}' >/dev/null 2>&1 || true
            sleep $DISPATCH_WAIT_SECONDS || true
            echo "[æ—¥å¿—] æ ¡éªŒæ˜¯å¦å·²æœ‰ä»»åŠ¡åœ¨æ’é˜Ÿ/è¿è¡Œ..."
            WF_ID=$(curl -s -H "Authorization: token $USER_PAT" \
              "https://api.github.com/repos/$REPO/actions/workflows?per_page=15" \
              | jq -r --arg name "$WORKFLOW_NAME" '
                .workflows[] | select(.name == $name) | .id
              ' | head -1 || true)
            if [ -n "$WF_ID" ]; then
              RUN_STATUS=$(curl -s -H "Authorization: token $USER_PAT" \
                "https://api.github.com/repos/$REPO/actions/workflows/$WF_ID/runs?per_page=5" \
                | jq -r '
                  .workflow_runs[] | select(.status == "queued" or .status == "in_progress") | .status
                ' | head -1 || true)
              if [ "$RUN_STATUS" = "queued" ] || [ "$RUN_STATUS" = "in_progress" ]; then
                echo "âœ… [æ—¥å¿—] ç»­è·‘æ ¡éªŒæˆåŠŸï¼å½“å‰ä»»åŠ¡çŠ¶æ€ï¼š$RUN_STATUS"
                DISPATCH_SUCCESS=1
                break
              fi
            fi
            echo "[æ—¥å¿—] ç¬¬ $retry æ¬¡æœªæ£€æµ‹åˆ°æœ‰æ•ˆä»»åŠ¡ï¼Œ${DISPATCH_WAIT_SECONDS}ç§’åé‡è¯•..."
          done
          if [ $DISPATCH_SUCCESS -eq 1 ]; then
            echo "ğŸ‰ [æ—¥å¿—] ç»­è·‘æœ€ç»ˆç¡®è®¤æˆåŠŸï¼"
          else
            echo "âŒ [æ—¥å¿—] é‡è¯• $RETRY_DISPATCH_TIMES æ¬¡ä»æœªæˆåŠŸ"
          fi
          echo "===== [æ—¥å¿—] 11-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 12-ç§»å…¥/aaaå¹¶æ— é™è½®è¯¢æ£€æµ‹åˆ é™¤ï¼ˆ1åˆ†é’Ÿ/æ¬¡ æ— ä¸Šé™ï¼‰
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 12-å¤‡ä»½ç§»å…¥/aaa + æ— é™è½®è¯¢åˆ é™¤ å¼€å§‹ ====="
          if [ -z "$BACKUP_FILE" ] || [ -z "$SNAP_NAME" ]; then
            echo "â„¹ï¸ [æ—¥å¿—] æ— å¤‡ä»½æ–‡ä»¶ï¼Œè·³è¿‡"
            exit 0
          fi
          LOCAL_AAA="/aaa"
          sudo mkdir -p "$LOCAL_AAA" || true
          TARGET_FILE="$LOCAL_AAA/$SNAP_NAME"
          sudo mv -v "$BACKUP_FILE" "$TARGET_FILE" || true
          echo -e "\n[æ—¥å¿—] âŒ› æ— é™è½®è¯¢ï¼šæ–‡ä»¶è¢«åˆ é™¤å³é€€å‡ºï¼Œè¿›å…¥ä¸‹ä¸€è½®"
          while true; do
            if [ ! -f "$TARGET_FILE" ]; then
              echo "[æ—¥å¿—] ğŸ‰ æ–‡ä»¶å·²è¢«æ‹‰å–åˆ é™¤ï¼Œé€€å‡ºè½®è¯¢"
              break
            fi
            echo "[æ—¥å¿—] æ–‡ä»¶æ­£å¸¸ï¼Œ1åˆ†é’Ÿåæ£€æŸ¥..."
            sleep 60 || true
          done
          echo "âœ… [æ—¥å¿—] 12-è½®è¯¢ç»“æŸ"
          echo "===== [æ—¥å¿—] 12-æ­¥éª¤ç»“æŸ =====\n"
      
      - name: 13-æœ€ç»ˆæ¸…ç†+å…³é—­Tailscaleä¸»ç½‘ç»œ
        if: ${{ always() }}  # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œï¼Œå¿½ç•¥å‰åºé”™è¯¯
        run: |
          set +e  # å¼€å¯å®¹é”™æ¨¡å¼
          echo "===== [æ—¥å¿—] 13-æœ€ç»ˆæ¸…ç† + å…³é—­Tailscale å¼€å§‹ ====="
          sudo systemctl stop tailscaled 2>/dev/null || true
          sudo pkill -9 "tailscaled" 2>/dev/null || true
          sudo rm -rf "$LOCAL_BACKUP_DIR" /tmp/* 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq || true
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "âœ… [æ—¥å¿—] 13-æ¸…ç†å®Œæˆï¼ŒTailscale å·²å…³é—­"
          echo "ğŸ‰ [æ—¥å¿—] å…¨æµç¨‹æ­£å¸¸ç»“æŸ"
          echo "===== [æ—¥å¿—] 13-æ­¥éª¤ç»“æŸ =====\n"