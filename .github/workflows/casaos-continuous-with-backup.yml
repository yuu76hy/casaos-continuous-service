name: CasaOS-Server-Snapshot-Backup-Restore

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  snapshot-backup-restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      CORE_DIRS: "/var/lib /DATA"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp --exclude=$WEBDAV_MOUNT_POINT
      # GitHub Secrets - éœ€åœ¨ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­é…ç½®
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}

    steps:
      # ========== 1. ç¯å¢ƒåˆå§‹åŒ– + åˆ›å»ºä¸­æ–‡ç›®å½• ==========
      - name: Env Init & Create Dirs
        run: |
          set -e
          # å®‰è£…ä¾èµ– + é…ç½®ä¸­æ–‡ç¼–ç 
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          # å®‰è£… rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # é…ç½®æƒé™
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          
          # åˆ›å»ºæ•°æ®ç›®å½•
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          
          # æ‹¼æ¥ WebDAV ä¸­æ–‡å­ç›®å½•è·¯å¾„
          WEBDAV_SNAPSHOT_DIR="${WEBDAV_MOUNT_POINT}/å¯¹è±¡å­˜å‚¨/ubuntu"
          sudo mkdir -p "$WEBDAV_SNAPSHOT_DIR"
          echo "âœ… Env init done, WebDAV snapshot dir: $WEBDAV_SNAPSHOT_DIR"
          echo "WEBDAV_SNAPSHOT_DIR=$WEBDAV_SNAPSHOT_DIR" >> "$GITHUB_ENV"

      # ========== 2. åˆ›å»º roots ç”¨æˆ· ==========
      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots user created, password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi

      # ========== 3. æŒ‚è½½ WebDAVï¼ˆä¼˜åŒ–å‚æ•°+å¼ºåˆ¶åŒæ­¥ï¼‰ ==========
      - name: Mount WebDAV
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8

          # æ£€æŸ¥å¯†é’¥æ˜¯å¦é…ç½®
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets missing, please configure in GitHub Secrets"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # åˆ›å»ºæŒ‚è½½ç‚¹
          mkdir -p "$WEBDAV_MOUNT_POINT"
          
          # é…ç½® rclone WebDAV è¿œç¨‹
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="other" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          
          # æŒ‚è½½ WebDAVï¼ˆå¼ºåˆ¶å®æ—¶åŒæ­¥å‚æ•°ï¼‰
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" \
            --config /home/runner/.rclone.conf \
            --vfs-cache-mode writes \
            --vfs-write-back 0s \
            --transfers 4 \
            --daemon-timeout 1h \
            --allow-other \
            --allow-non-empty \
            --locale zh-CN \
            --log-level INFO \
            --log-file /tmp/rclone.log >/dev/null 2>&1 &
          
          # æ£€æŸ¥æŒ‚è½½çŠ¶æ€ï¼ˆé‡è¯•5æ¬¡ï¼‰
          for i in $(seq 1 5); do
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              echo "âœ… WebDAV mounted successfully (UTF-8 encoding)"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              
              # æ£€æµ‹å†å²å¿«ç…§
              if ls "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz 1>/dev/null 2>&1; then
                LATEST_SNAPSHOT=$(ls -t "$WEBDAV_SNAPSHOT_DIR"/casaos-server-snapshot-*.tar.gz | head -n1)
                echo "âœ… Found latest snapshot: $LATEST_SNAPSHOT"
                echo "LATEST_SNAPSHOT=$LATEST_SNAPSHOT" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ No historical snapshot found in $WEBDAV_SNAPSHOT_DIR"
              fi
              exit 0
            fi
            echo "âš ï¸ WebDAV mount attempt $i failed, retrying..."
            sleep 10
          done
          
          # æŒ‚è½½å¤±è´¥ï¼Œè¾“å‡ºæ—¥å¿—æ’æŸ¥
          echo "âŒ WebDAV mount failed after 5 attempts"
          cat /tmp/rclone.log
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      # ========== 4. ä» WebDAV æ¢å¤å¿«ç…§ ==========
      - name: Restore Snapshot & Cleanup Used File
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          echo "===== Start restoring from snapshot: $LATEST_SNAPSHOT ====="
          
          # å½»åº•åœæ­¢ Docker & CasaOS
          sudo systemctl stop docker.service docker.socket casaos.service
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3
          
          # è§£å‹å¿«ç…§
          sudo tar -xzf "$LATEST_SNAPSHOT" -C / \
            --overwrite \
            --ignore-failed-read \
            --warning=no-all \
            $EXCLUDE_RULES
          
          if [ $? -eq 0 ]; then
            echo "âœ… Snapshot restored successfully"
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            
            # åˆ é™¤å·²ä½¿ç”¨çš„å¿«ç…§å’Œå…ƒä¿¡æ¯
            sudo rm -f "$LATEST_SNAPSHOT" "$WEBDAV_SNAPSHOT_DIR/snapshot_meta.txt"
            # æ¢å¤ Docker Socket
            sudo systemctl unmask docker.socket
          else
            echo "âŒ Snapshot restore failed"
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
          fi

      # ========== 5. å®‰è£… CasaOSï¼ˆæ— å¿«ç…§æ—¶æ‰§è¡Œï¼‰ ==========
      - name: Install CasaOS If No Snapshot Restored
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            echo "âŒ CasaOS installation failed, check log below:"
            cat /var/log/casaos-install.log || true
            exit 1
          }
          echo "âœ… CasaOS installed successfully"

      # ========== 6. å¯åŠ¨ Docker & CasaOS æœåŠ¡ ==========
      - name: Start Docker & CasaOS Services
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          
          # é‡è¯•å¯åŠ¨æœåŠ¡ï¼ˆ3æ¬¡ï¼‰
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket casaos.service
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Docker & CasaOS services started successfully"
              exit 0
            fi
            echo "âš ï¸ Service start attempt $i failed, retrying..."
          done
          
          echo "âŒ Failed to start Docker & CasaOS services after 3 attempts"
          exit 1

      # ========== 7. éƒ¨ç½² Tailscale ç½‘ç»œ ==========
      - name: Deploy Tailscale Network
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscale auth key not configured, skipping deployment"
            exit 0
          fi
          
          # å®‰è£… Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          # ç™»å½• Tailscale
          sudo tailscale up \
            --authkey="$TAILSCALE_AUTH_KEY" \
            --accept-routes \
            --hostname="casaos-snapshot-${{ github.run_id }}"
          
          echo "âœ… Tailscale deployed successfully, IP address: $(sudo tailscale ip -4)"

      # ========== 8. æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ›å»ºå¿«ç…§ + å¼ºåˆ¶åŒæ­¥ WebDAV + è‡ªåŠ¨ç»­è·‘ ==========
      - name: Create Snapshot & Upload & Auto Renew
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # ğŸ”§ å‡½æ•°1ï¼šè§¦å‘ Workflow ç»­è·‘
          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âš ï¸ USER_PAT or REPO not configured, cannot trigger renew"
              return 1
            fi
            
            curl -fsS -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'
            
            if [ $? -eq 0 ]; then
              echo "âœ… Workflow renew triggered successfully"
              RENEW_TRIGGERED=true
            else
              echo "âŒ Failed to trigger workflow renew"
              return 1
            fi
          }

          # ğŸ”§ å‡½æ•°2ï¼šåˆ›å»ºå¿«ç…§å¹¶å¼ºåˆ¶åŒæ­¥åˆ° WebDAV
          create_snapshot() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAV not available, skipping snapshot creation"
              return 1
            fi

            # 1. ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¿«ç…§æ–‡ä»¶å
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            WEBDAV_SNAPSHOT="${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            echo "ğŸ”„ Starting snapshot creation: $SNAPSHOT_NAME (target: $WEBDAV_SNAPSHOT_DIR)"

            # 2. å½»åº•åœæ­¢ Docker & CasaOS é¿å…æ–‡ä»¶å ç”¨
            sudo systemctl stop docker.service docker.socket casaos.service
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5

            # 3. æ‰“åŒ…æ ¸å¿ƒç›®å½•ï¼ˆå±è”½æ‰€æœ‰è­¦å‘Šï¼‰
            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS

            # 4. æ£€æŸ¥å¿«ç…§æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
            if [ ! -f "${TMP_SNAPSHOT}" ]; then
              echo "âŒ Snapshot file not found: $TMP_SNAPSHOT"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi
            echo "âœ… Snapshot created successfully, size: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')"

            # 5. æ£€æŸ¥ WebDAV ä¸­æ–‡ç›®å½•å¯å†™æ€§
            if ! sudo touch "${WEBDAV_SNAPSHOT_DIR}/.test-write" 2>/dev/null; then
              echo "âŒ WebDAV directory $WEBDAV_SNAPSHOT_DIR is read-only"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi
            sudo rm -f "${WEBDAV_SNAPSHOT_DIR}/.test-write"

            # 6. å¤åˆ¶å¿«ç…§åˆ°æŒ‚è½½ç›®å½• + å¼ºåˆ¶åŒæ­¥åˆ° WebDAV æœåŠ¡ç«¯
            sudo cp "${TMP_SNAPSHOT}" "${WEBDAV_SNAPSHOT}"
            if [ $? -eq 0 ]; then
              echo "âœ… Snapshot copied to local mount directory"
              
              # âš¡ å…³é”®æ­¥éª¤ï¼šå¼ºåˆ¶åŒæ­¥åˆ° WebDAV æœåŠ¡ç«¯
              rclone sync "$WEBDAV_SNAPSHOT_DIR" "mywebdav:/å¯¹è±¡å­˜å‚¨/ubuntu" \
                --config /home/runner/.rclone.conf \
                --locale zh-CN \
                --log-level INFO
              
              if [ $? -eq 0 ]; then
                echo "âœ… Snapshot synced to WebDAV server successfully: $WEBDAV_SNAPSHOT"
                
                # å†™å…¥å¿«ç…§å…ƒä¿¡æ¯
                echo "snapshot_name=${SNAPSHOT_NAME}" | sudo tee "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" | sudo tee -a "${WEBDAV_SNAPSHOT_DIR}/snapshot_meta.txt" >/dev/null
                # åŒæ­¥å…ƒä¿¡æ¯æ–‡ä»¶
                rclone sync "$WEBDAV_SNAPSHOT_DIR" "mywebdav:/å¯¹è±¡å­˜å‚¨/ubuntu" --config /home/runner/.rclone.conf
              else
                echo "âŒ Failed to sync snapshot to WebDAV server, check log: /tmp/rclone.log"
                cat /tmp/rclone.log
                sudo systemctl unmask docker.socket
                sudo systemctl start docker.service docker.socket casaos.service
                return 1
              fi
            else
              echo "âŒ Failed to copy snapshot to WebDAV mount directory"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket casaos.service
              return 1
            fi

            # 7. æ¢å¤ Docker & CasaOS æœåŠ¡
            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket casaos.service

            # 8. æ¸…ç†7å¤©å‰çš„æ—§å¿«ç…§
            echo "ğŸ”„ Cleaning old snapshots (keeping last 7 days)..."
            find "$WEBDAV_SNAPSHOT_DIR" -name "casaos-server-snapshot-*.tar.gz" -mtime +7 -delete
            if [ $? -eq 0 ]; then
              echo "âœ… Old snapshots cleaned successfully"
            else
              echo "âš ï¸ No old snapshots to clean"
            fi

            return 0
          }

          # ğŸ¯ ä¸»å¾ªç¯ï¼šå®šæ—¶åˆ›å»ºå¿«ç…§ + è‡ªåŠ¨ç»­è·‘
          while true; do
            run_mins=$(( ($(date +%s) - start_time) / 60 ))
            echo "ğŸ“Š Workflow running for $run_mins minutes"

            # æ¯10åˆ†é’Ÿåˆ›å»ºä¸€æ¬¡å¿«ç…§å¹¶è§¦å‘ç»­è·‘ï¼ˆä»…ä¸€æ¬¡ï¼‰
            if [ $run_mins -ge 10 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° Time to create snapshot (10 minutes reached)"
              create_snapshot && trigger_renew
            fi

            # è¾¾åˆ°æœ€å¤§è¿è¡Œæ—¶é—´æ—¶é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Workflow reached maximum run time ($MAX_RUN_MINUTES minutes), exiting"
              exit 0
            fi

            sleep 60
          done

      # ========== 9. ç¯å¢ƒæ¸…ç†ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œï¼‰ ==========
      - name: Cleanup Environment
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          # æ¢å¤ Docker Socket
          sudo systemctl unmask docker.socket || true
          
          # å¸è½½ WebDAV
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT"
            echo "âœ… WebDAV unmounted successfully"
          fi
          
          # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone.log
          echo "âœ… Environment cleaned up successfully"
