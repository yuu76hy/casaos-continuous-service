name: CasaOS纯净部署（300分钟备份+先续跑再关流+停进程保完整）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360  # 360分钟冗余，防流程中途中断
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      DELAY_TOTAL_MIN: 300  # 固定300分钟延时，直观好改
      CORE_SERVICES: "docker containerd casaos" # 核心进程统一管控

    steps:
      - name: 1-系统初始化（极简版）
        run: |
          set -e
          echo "===== 系统快速初始化 ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "✅ 初始化完成"

      - name: 2-官方一键装Docker（含compose）
        run: |
          set -e
          echo "===== 官方一键安装Docker ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "✅ Docker安装完成"

      - name: 3-创建免密管理员用户
        run: |
          set -e
          echo "===== 创建免密管理员用户 ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ];then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "🔑 roots随机密码：$RANDOM_PASS"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "✅ 用户配置完成"

      - name: 4-WebDAV配置+快照检测+目录预创建
        run: |
          set -e
          echo "===== WebDAV配置&快照检测&目录预创建 ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "⚠️ WebDAV凭证缺失，跳过备份恢复"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" && sudo chmod 755 "$dir"
          done
          if rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep -q ".tar.gz"; then
            echo "✅ 检测到WebDAV备份快照"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "ℹ️ 无备份快照，全新部署"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "✅ WebDAV配置完成"

      - name: 5-Tailscale组网配置
        run: |
          set -e
          echo "===== Tailscale组网配置 ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "⚠️ Tailscale密钥缺失，跳过组网"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-dns=false --accept-routes=false
          sleep 3
          echo "✅ Tailscale组网成功，IP：$(tailscale ip -4)"

      - name: 6-CasaOS部署+快照恢复（不删备份）
        run: |
          set -e
          echo "===== CasaOS部署&快照恢复 ====="
          if [ "$HAS_SNAPSHOT" = "false" ]; then
            curl -fsSL https://get.casaos.io | sudo bash
            sudo systemctl enable --now casaos && sleep 5
            echo "✅ CasaOS全新部署完成"
            exit 0
          fi
          LATEST_SNAPSHOT=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep .tar.gz | sort -r | head -n1 | awk '{print $2}')
          rclone copy mywebdav:"$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" /tmp/ --config /home/runner/.rclone.conf
          sudo tar -zxf /tmp/"$LATEST_SNAPSHOT" -C / --preserve-permissions --exclude=proc --exclude=sys --exclude=dev --exclude=tmp
          sudo rm -f /tmp/"$LATEST_SNAPSHOT"
          sudo systemctl restart $CORE_SERVICES && sleep 5
          echo "✅ CasaOS快照恢复完成，备份保留完整"

      - name: 7-系统基础优化
        run: |
          set -e
          echo "===== 系统基础优化 ====="
          sudo apt update -y -qq && sudo apt upgrade -y -qq
          sudo systemctl disable --now apt-daily.service apt-daily-upgrade.service
          sudo timedatectl set-timezone Asia/Shanghai
          echo "✅ 系统优化完成"

      - name: 8-300分钟倒计时+停进程备份+先续跑再关当前流
        run: |
          set -e
          echo "⏳ 开始${DELAY_TOTAL_MIN}分钟倒计时，每分钟更新剩余时间"
          # 实时倒计时可视化，进度清晰
          for ((i=${DELAY_TOTAL_MIN};i>0;i--)); do
            echo "⌛ 剩余延时：${i}分钟（总计${DELAY_TOTAL_MIN}分钟）"
            sleep 60
          done
          echo "🎉 300分钟倒计时结束，启动备份（先停进程保数据完整）"
          
          # 1 关停所有进程，杜绝读写，保障备份纯净
          echo "🛑 关停所有核心进程及残留进程"
          sudo systemctl stop $CORE_SERVICES 2>/dev/null
          sudo pkill -f docker 2>/dev/null && sudo pkill -f casaos 2>/dev/null
          echo "✅ 所有进程已关停，可安全备份"
          
          # 2 完整备份流程，分步进度可视化
          SNAPSHOT_NAME="casaos-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "📥 【备份1/4】创建本地备份包：${SNAPSHOT_NAME}"
          sudo tar -zcvf /tmp/"$SNAPSHOT_NAME" $EXCLUDE_RULES $PERSONAL_DATA_DIRS --preserve-permissions
          echo "✅ 【备份2/4】本地备份完成：/tmp/${SNAPSHOT_NAME}"
          
          echo "📤 【备份3/4】上传WebDAV（实时进度条）"
          rclone copy -P /tmp/"$SNAPSHOT_NAME" mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf
          echo "✅ 【备份4/4】上传完成，存储路径：${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
          
          # 3 清理旧备份，保留最新2份
          echo "🧹 清理旧备份，保留最新${KEEP_BACKUPS}份"
          BACKUPS_LIST=$(rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /home/runner/.rclone.conf | grep .tar.gz | sort -r | awk '{print $2}')
          BACKUPS_COUNT=$(echo "$BACKUPS_LIST" | wc -l)
          if [ "$BACKUPS_COUNT" -gt "$KEEP_BACKUPS" ]; then
            DELETE_LIST=$(echo "$BACKUPS_LIST" | tail -n $((BACKUPS_COUNT - KEEP_BACKUPS)))
            echo "🗑️ 待删旧备份：${DELETE_LIST}"
            for backup in $DELETE_LIST; do rclone delete mywebdav:"$WEBDAV_SNAPSHOT_DIR/$backup" --config /home/runner/.rclone.conf; done
            echo "✅ 旧备份清理完成"
          else
            echo "ℹ️ 当前备份${BACKUPS_COUNT}份，无需清理"
          fi
          sudo rm -f /tmp/"$SNAPSHOT_NAME"
          
          # 4 重启进程，恢复服务正常运行
          echo "🔄 重启核心进程，恢复CasaOS服务"
          sudo systemctl restart $CORE_SERVICES && sleep 8
          sudo systemctl is-active --quiet $CORE_SERVICES && echo "✅ 所有进程重启成功，服务正常" || echo "⚠️ 进程重启异常，请核查"
          
          # 核心顺序：备份完成 ✔️→ 先触发续跑 ✔️→ 再关闭当前工作流 ✔️ 顺序绝不颠倒
          echo "====================================="
          echo "📌 备份全流程完成，开始执行续跑+关流"
          # 第一步：触发续跑工作流，确保新实例启动
          echo "🔄 第一步：触发备份续跑工作流"
          curl -X POST https://api.github.com/repos/${REPO}/dispatches \
          -H "Authorization: token ${USER_PAT}" \
          -H "Accept: application/vnd.github+json" \
          -d '{"event_type":"renew_casaos_snapshot"}'
          echo "✅ 续跑工作流触发成功，新实例已启动"
          
          # 第二步：续跑触发成功后，关闭当前运行的旧工作流
          echo "🔚 第二步：关闭当前工作流实例"
          gh auth login --with-token <<< "${USER_PAT}"
          RUN_ID=$(jq -r ".run_id" "$GITHUB_EVENT_PATH")
          gh api -X POST repos/${REPO}/actions/runs/${RUN_ID}/cancel
          echo "✅ 当前工作流（ID:${RUN_ID}）已成功关闭"
          echo "📌 全流程结束：续跑已触发，当前流已关闭"
          echo "====================================="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
