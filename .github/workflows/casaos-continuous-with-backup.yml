name: 1Panel-Docker-å¤‡ä»½æ¢å¤-è‡ªåŠ¨å®‰è£…-Tailscale

on:
  workflow_dispatch:
  repository_dispatch:
    types: [full_backup_restore_tailscale]

jobs:
  backup_restore_install_tailscale_job:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/1panel_docker_full_backup"
      # ğŸ”´ ä»…å¤‡ä»½1Panel+Dockeræ ¸å¿ƒç›®å½•ï¼Œå‰”é™¤Tailscaleç›¸å…³æ–‡ä»¶
      FULL_CORE_DIRS: |
        /opt/1panel
        /usr/bin/1panel
        /etc/1panel
        /var/lib/docker
        /etc/docker
        /usr/bin/docker
        /usr/bin/dockerd
        /usr/bin/docker-compose
        /usr/lib/systemd/system/1panel.service
        /usr/lib/systemd/system/docker.service
        /usr/lib/systemd/system/docker.socket
        /DATA
      # è¿‡æ»¤ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/opt/1panel/logs
        --exclude=/opt/1panel/tmp
        --exclude=/DATA/tmp
        --exclude=/DATA/logs
        --exclude=*.cache
        --exclude=*.tmp
      # GitHub Secrets é…ç½®é¡¹
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ github.repository }}
      WEBDAV_AVAILABLE: true

    steps:
      - name: ç¯å¢ƒåˆå§‹åŒ–ï¼ˆå…³é—­å¹²æ‰°æœåŠ¡ï¼‰
        run: |
          set -e
          # å…³é—­ apt è‡ªåŠ¨æ›´æ–°æœåŠ¡
          sudo systemctl stop apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
          sudo systemctl mask apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
          
          # å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt update -y && sudo apt install -y curl wget jq tar gzip rclone openssl locales ca-certificates gnupg lsb-release
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          # é…ç½® sudo å…å¯†æƒé™
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          
          # åˆ›å»º DATA ç›®å½•
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "âœ… åŸºç¡€ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: é…ç½® WebDAV å­˜å‚¨
        run: |
          set -e
          # æ£€æŸ¥ WebDAV å‡­è¯
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ ç¼ºå°‘ WebDAV é…ç½®å‡­è¯"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # é…ç½® rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="generic" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          
          # éªŒè¯ WebDAV è¿æ¥
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAV è¿æ¥å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # åˆ›å»ºè¿œç¨‹å¤‡ä»½ç›®å½•
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf
          
          # æŸ¥æ‰¾æœ€æ–°å…¨é‡å¿«ç…§
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep "full-backup-.*.tar.gz" | awk '{print $2}' | sort -r | head -n1)
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "âœ… æ‰¾åˆ°æœ€æ–°å…¨é‡å¿«ç…§ï¼š$LATEST_SNAPSHOT"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å†å²å…¨é‡å¿«ç…§ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…"
          fi

      - name: å…¨é‡æ¢å¤ 1Panel + Dockerï¼ˆæœ‰å¿«ç…§æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== å¼€å§‹å…¨é‡æ¢å¤ 1Panel + Docker ====="
          
          # åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡
          sudo systemctl stop 1panel docker docker.socket tailscaled 2>/dev/null || true
          sudo pkill -9 1panel docker dockerd tailscaled 2>/dev/null || true
          sync && sleep 5
          
          # è§£å‹å¿«ç…§åˆ°æ ¹ç›®å½•ï¼Œä¿ç•™æƒé™
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions --absolute-names --warning=no-all
          
          # ä¿®å¤æ–‡ä»¶æƒé™
          sudo chmod +x /usr/bin/1panel /usr/bin/docker /usr/bin/dockerd /usr/bin/docker-compose 2>/dev/null || true
          sudo chown -R root:root /opt/1panel /etc/1panel /var/lib/docker /etc/docker 2>/dev/null || true
          
          # é‡æ–°åŠ è½½ systemd
          sudo systemctl daemon-reload
          
          # å¯åŠ¨1Panel+DockeræœåŠ¡
          sudo systemctl enable --now docker.socket docker.service 1panel.service
          sleep 10
          
          # éªŒè¯æœåŠ¡çŠ¶æ€
          if sudo systemctl is-active --quiet docker.service && sudo systemctl is-active --quiet 1panel.service; then
            echo "âœ… 1Panel + Docker æ¢å¤æˆåŠŸï¼æœåŠ¡å·²å¯åŠ¨"
            echo "DEPLOY_STATUS=restored" >> "$GITHUB_ENV"
            # åˆ é™¤æ—§å¿«ç…§ï¼ˆå¯é€‰ï¼‰
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
          else
            echo "âŒ æ¢å¤åå¯åŠ¨å¤±è´¥ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…å…œåº•"
            echo "DEPLOY_STATUS=restore_failed" >> "$GITHUB_ENV"
          fi

      - name: å…¨æ–°å®‰è£… Dockerï¼ˆæ¢å¤å¤±è´¥/æ— å¿«ç…§æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.DEPLOY_STATUS != 'restored' }}
        run: |
          set -e
          echo "===== å¼€å§‹å…¨æ–°å®‰è£… Docker ====="
          
          # å¸è½½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœ‰ï¼‰
          sudo apt remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
          sudo rm -rf /var/lib/docker /etc/docker 2>/dev/null || true
          
          # é…ç½® Docker æº
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          # å®‰è£… Docker æœ€æ–°ç¨³å®šç‰ˆ
          sudo apt update -y
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          
          # é…ç½®æƒé™
          sudo usermod -aG docker runner
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          
          # å¯åŠ¨ Docker
          sudo systemctl enable --now docker.socket docker.service
          sleep 5
          
          if sudo systemctl is-active --quiet docker.service; then
            echo "âœ… Docker å…¨æ–°å®‰è£…æˆåŠŸ"
          else
            echo "âŒ Docker å®‰è£…å¤±è´¥"
            exit 1
          fi

      - name: å…¨æ–°å®‰è£… 1Panelï¼ˆæ¢å¤å¤±è´¥/æ— å¿«ç…§æ—¶æ‰§è¡Œï¼‰
        if: ${{ env.DEPLOY_STATUS != 'restored' }}
        run: |
          set -e
          echo "===== å¼€å§‹å…¨æ–°å®‰è£… 1Panel ====="
          
          # ç¡®ä¿ Docker å·²è¿è¡Œ
          if ! sudo systemctl is-active --quiet docker.service; then
            echo "âŒ Docker æœªè¿è¡Œï¼Œæ— æ³•å®‰è£… 1Panel"
            exit 1
          fi
          
          # å®‰è£… 1Panel
          curl -fsSL https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash - || {
            echo "âŒ 1Panel å®‰è£…å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—"
            cat /tmp/1panel-install.log 2>/dev/null || true
            exit 1
          }
          
          # å¯åŠ¨ 1Panel
          sleep 5
          sudo systemctl enable --now 1panel.service
          sleep 5
          
          if sudo systemctl is-active --quiet 1panel.service; then
            echo "âœ… 1Panel å…¨æ–°å®‰è£…æˆåŠŸ"
            echo "DEPLOY_STATUS=installed" >> "$GITHUB_ENV"
          else
            echo "âŒ 1Panel å¯åŠ¨å¤±è´¥"
            sudo 1panel repair || true
          fi

      - name: éƒ¨ç½² Tailscaleï¼ˆæ‰€æœ‰æƒ…å†µéƒ½æ‰§è¡Œï¼Œä¸ä¾èµ–å¤‡ä»½ï¼‰
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          echo "===== å¼€å§‹éƒ¨ç½² Tailscale ====="
          
          # å¸è½½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœ‰ï¼‰ï¼Œé¿å…æ®‹ç•™é…ç½®å¹²æ‰°
          sudo apt remove -y tailscale 2>/dev/null || true
          sudo rm -rf /etc/tailscale /var/lib/tailscale 2>/dev/null || true
          
          # å…¨æ–°å®‰è£… Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo bash -
          
          # å¯åŠ¨ Tailscaled æœåŠ¡
          sudo systemctl enable --now tailscaled.service
          sleep 3
          
          # è®¤è¯å¹¶å¯åŠ¨ Tailscaleï¼Œç”Ÿæˆæ–°é…ç½®
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --accept-routes --advertise-routes=192.168.1.0/24
          TAILSCALE_IP=$(sudo tailscale ip -4)
          echo "âœ… Tailscale éƒ¨ç½²æˆåŠŸï¼Œæœ¬æœº Tailscale IP: ${TAILSCALE_IP}"

      - name: å…¨é‡å¤‡ä»½ 1Panel + Dockerï¼ˆæ¢å¤/å®‰è£…æˆåŠŸåæ‰§è¡Œï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && (env.DEPLOY_STATUS == 'restored' || env.DEPLOY_STATUS == 'installed') }}
        run: |
          set -e
          echo "===== å¼€å§‹å…¨é‡å¤‡ä»½ 1Panel + Docker ====="
          
          # åœæ­¢æœåŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
          sudo systemctl stop 1panel docker docker.socket tailscaled 2>/dev/null || true
          sudo pkill -9 1panel docker dockerd tailscaled 2>/dev/null || true
          sync && sleep 5
          
          # ç”Ÿæˆå¿«ç…§åç§°
          SNAPSHOT_NAME="full-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
          TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
          
          # æ‰“åŒ…1Panel+Dockeræ ¸å¿ƒç›®å½•ï¼Œä¸åŒ…å«Tailscaleæ–‡ä»¶
          sudo tar -czf "${TMP_SNAPSHOT}" --absolute-names --preserve-permissions --warning=no-all $EXCLUDE_RULES $FULL_CORE_DIRS
          
          # æ ¡éªŒå¿«ç…§
          if [ -f "${TMP_SNAPSHOT}" ] && [ $(stat -c%s "${TMP_SNAPSHOT}") -gt 1024 ]; then
            SNAPSHOT_SIZE=$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')
            echo "âœ… å…¨é‡å¿«ç…§åˆ›å»ºæˆåŠŸï¼Œå¤§å°ï¼š${SNAPSHOT_SIZE}"
            
            # ä¸Šä¼ åˆ° WebDAV
            if rclone copy "${TMP_SNAPSHOT}" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf; then
              echo "âœ… å¿«ç…§å·²ä¸Šä¼ è‡³ WebDAV: ${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            fi
          fi
          
          # é‡å¯æ‰€æœ‰æœåŠ¡
          sudo systemctl enable --now docker.socket docker.service 1panel.service tailscaled.service
          sleep 5
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "${TMP_SNAPSHOT}"

      - name: ç¯å¢ƒæ¸…ç†ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰
        if: ${{ always() }}
        run: |
          set -e
          # è§£é™¤ apt æœåŠ¡ mask
          sudo systemctl unmask apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
          # åˆ é™¤ä¸´æ—¶é…ç½®
          sudo rm -f /etc/sudoers.d/runner /home/runner/.rclone.conf
          echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæ¯•ï¼Œç¯å¢ƒæ¸…ç†å®Œæˆ"
