name: CasaOS-Server-Âø´ÁÖß-Â§á‰ªΩ-ÊÅ¢Â§ç

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos_snapshot_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      CORE_DIRS: "/var/lib /DATA /etc/casaos"
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/overlay2/*/home/dependabot
        --exclude=/var/lib/docker/overlay2/*/vendor/ruby
        --exclude=/var/lib/docker/overlay2/*/gems
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/log --exclude=/var/cache
        --exclude=*.log --exclude=*.tmp --exclude=*.cache
        --exclude=/tmp --exclude=/var/tmp
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      # Êñ∞Â¢ûÔºöTailscaleÊ∫êÈÖçÁΩÆÔºàÈÄÇÈÖçUbuntu 24.04 nobleÔºâ
      TAILSCALE_GPG_URL: "https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg"
      TAILSCALE_LIST_URL: "https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list"
      # Êñ∞Â¢ûÔºöÊó•ÂøóÊñá‰ª∂Ë∑ØÂæÑ
      FIX_LOG_FILE: "/tmp/tailscale_fix_after_backup.log"

    steps:
      - name: Env Init & Install Dependencies
        run: |
          set -e
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          curl https://rclone.org/install.sh | sudo bash
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          # ÂàùÂßãÂåñ‰øÆÂ§çÊó•Âøó
          sudo touch $FIX_LOG_FILE && sudo chmod 666 $FIX_LOG_FILE
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ===== ÁéØÂ¢ÉÂàùÂßãÂåñÂÆåÊàê =====" | tee -a $FIX_LOG_FILE
          echo "‚úÖ Env init completed"

      - name: Create roots User
        run: |
          set -e
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            [ -n "$ROOTS_PASSWORD" ] && echo "roots:$ROOTS_PASSWORD" | sudo chpasswd || {
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "‚úÖ roots password: $RANDOM_PASS"
            }
            sudo usermod -aG sudo roots
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ===== rootsÁî®Êà∑ÂàõÂª∫ÂÆåÊàê =====" | tee -a $FIX_LOG_FILE
          fi
          echo "‚úÖ Roots user created/verified"

      - name: Configure Rclone for WebDAV (No Mount)
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "‚ùå WebDAV secrets missing" | tee -a $FIX_LOG_FILE
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="webdav" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf

          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "‚ùå WebDAV connection failed" | tee -a $FIX_LOG_FILE
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "‚úÖ WebDAV connected successfully (no mount mode)" | tee -a $FIX_LOG_FILE
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          echo "‚úÖ Created remote directory: mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}" | tee -a $FIX_LOG_FILE

          # ========== ÂΩªÂ∫ï‰øÆÂ§çË∑ØÂæÑÈáçÂ§çÈóÆÈ¢ò ==========
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf | grep "casaos-server-snapshot-.*.tar.gz" | awk '{print $2}' | sort -r)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME=$(echo "$REMOTE_SNAPSHOTS" | head -n1)
            # Âº∫Âà∂ÊãºÊé•Ê≠£Á°ÆË∑ØÂæÑÔºöÁõÆÂΩï+Êñá‰ª∂ÂêçÔºåÊó†ÈáçÂ§ç
            LATEST_SNAPSHOT="${WEBDAV_SNAPSHOT_EN_DIR}/${LATEST_SNAPSHOT_FILENAME}"
            echo "‚úÖ Found latest remote snapshot: ${LATEST_SNAPSHOT}" | tee -a $FIX_LOG_FILE
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "‚ö†Ô∏è No remote snapshot in mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}" | tee -a $FIX_LOG_FILE
          fi

      - name: Restore Snapshot Directly from WebDAV
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== Áõ¥Êé•‰ªéËøúÁ®ãÊÅ¢Â§çÔºö$LATEST_SNAPSHOT =====" | tee -a $FIX_LOG_FILE
          
          sudo systemctl stop docker.service docker.socket || echo "‚ö†Ô∏è dockerÊúçÂä°Êú™ËøêË°å/‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÂÅúÊ≠¢" | tee -a $FIX_LOG_FILE
          sudo systemctl mask docker.socket
          sudo pkill -9 docker || true
          sync && sleep 3
          
          if systemctl is-active --quiet casaos.service; then
            sudo systemctl stop casaos.service
            echo "‚úÖ Â∑≤ÂÅúÊ≠¢casaos.service" | tee -a $FIX_LOG_FILE
          else
            echo "‚ö†Ô∏è casaos.serviceÊú™Âä†ËΩΩ/‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÂÅúÊ≠¢" | tee -a $FIX_LOG_FILE
          fi

          if ! rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 100 >/dev/null 2>&1; then
            echo "‚ùå ËøúÁ®ãÂø´ÁÖßÊó†ÊïàÊàñÊó†Ê≥ïËØªÂèñ" | tee -a $FIX_LOG_FILE
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
            exit 1
          fi

          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --ignore-failed-read --warning=no-all $EXCLUDE_RULES
          if [ $? -eq 0 ]; then
            echo "‚úÖ ÊÅ¢Â§çWebDAVÁöÑÊàêÂäü" | tee -a $FIX_LOG_FILE
            echo "SNAPSHOT_RESTORED=true" >> "$GITHUB_ENV"
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
            rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt --config /home/runner/.rclone.conf
            sudo systemctl unmask docker.socket
          else
            echo "‚ùå ÊÅ¢Â§çÂ§±Ë¥•" | tee -a $FIX_LOG_FILE
            echo "SNAPSHOT_RESTORED=false" >> "$GITHUB_ENV"
            sudo systemctl unmask docker.socket
          fi

      - name: Install CasaOS If No Snapshot
        if: ${{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          set -e
          curl -fsSL https://get.casaos.io | sudo bash || {
            cat /var/log/casaos-install.log || true
            echo "‚ùå CasaOSÂÆâË£ÖÂ§±Ë¥•" | tee -a $FIX_LOG_FILE
            exit 1
          }
          echo "‚úÖ CasaOS installed" | tee -a $FIX_LOG_FILE

      - name: Start Services
        run: |
          set -e
          sudo systemctl unmask docker.socket || true
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker.service docker.socket
            sleep 10
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet docker.socket; then
              echo "‚úÖ DockerÊúçÂä°ÂêØÂä®ÊàêÂäü" | tee -a $FIX_LOG_FILE
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl enable --now casaos.service
                sleep 5
                if sudo systemctl is-active --quiet casaos.service; then
                  echo "‚úÖ CasaOSÊúçÂä°ÂêØÂä®ÊàêÂäü" | tee -a $FIX_LOG_FILE
                fi
              fi
              exit 0
            fi
            echo "‚ö†Ô∏è DockerÂêØÂä®Â∞ùËØï $i Â§±Ë¥•ÔºåÈáçËØï..." | tee -a $FIX_LOG_FILE
          done
          echo "‚ùå DockerÊúçÂä°ÂêØÂä®Â§±Ë¥•" | tee -a $FIX_LOG_FILE
          exit 1

      - name: Fix APT/Dpkg Environment After Backup (ÂÖ≥ÈîÆ‰øÆÂ§çÊ≠•È™§)
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ===== ÂºÄÂßã‰øÆÂ§çAPT/DpkgÁéØÂ¢É =====" | tee -a $FIX_LOG_FILE
          
          # 1. ‰øÆÂ§çdpkgÊï∞ÊçÆÂ∫ì
          sudo dpkg --configure -a 2>&1 | tee -a $FIX_LOG_FILE
          # 2. ‰øÆÂ§ç‰æùËµñÂÖ≥Á≥ª
          sudo apt --fix-broken install -y 2>&1 | tee -a $FIX_LOG_FILE
          # 3. Âº∫Âà∂Êõ¥Êñ∞ËΩØ‰ª∂ÂåÖÂàóË°®
          sudo apt update --fix-missing -y 2>&1 | tee -a $FIX_LOG_FILE
          # 4. Ê∏ÖÁêÜÁºìÂ≠ò
          sudo apt clean && sudo apt autoclean 2>&1 | tee -a $FIX_LOG_FILE
          
          # 5. ÈáçÁΩÆAPT/DpkgÁõÆÂΩïÊùÉÈôêÔºàÂ§á‰ªΩÊÅ¢Â§çÊúÄÊòìÂá∫ÈóÆÈ¢òÁöÑÁÇπÔºâ
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ===== ÈáçÁΩÆÁõÆÂΩïÊùÉÈôê =====" | tee -a $FIX_LOG_FILE
          sudo chown -R root:root /var/lib/apt /var/lib/dpkg
          sudo chmod -R 755 /var/lib/apt/lists/
          sudo chmod 644 /etc/apt/sources.list.d/* || true
          
          echo "‚úÖ APT/DpkgÁéØÂ¢É‰øÆÂ§çÂÆåÊàê" | tee -a $FIX_LOG_FILE

      - name: Deploy Tailscale (Êï¥Âêà‰øÆÂ§çÈÄªËæë)
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8  # ÂàáÊç¢Ëã±ÊñáÈÅøÂÖçÊ∫êÂàóË°®‰π±Á†Å
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "‚ö†Ô∏è Tailscale key missing, skip" | tee -a $FIX_LOG_FILE
            exit 0
          fi

          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ===== ÂºÄÂßãÂÆâË£ÖTailscale =====" | tee -a $FIX_LOG_FILE
          # 1. ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates 2>&1 | tee -a $FIX_LOG_FILE
          
          # 2. ÈáçÊñ∞Ê∑ªÂä†Tailscale GPGÂØÜÈí•ÔºàÈÅøÂÖçÂ§á‰ªΩË¶ÜÁõñÔºâ
          sudo rm -f /usr/share/keyrings/tailscale-archive-keyring.gpg
          curl -fsSL $TAILSCALE_GPG_URL | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          sudo chmod 0644 /usr/share/keyrings/tailscale-archive-keyring.gpg
          
          # 3. ÈáçÊñ∞Ê∑ªÂä†TailscaleÊ∫êÂàóË°®ÔºàÈÄÇÈÖçUbuntu 24.04 nobleÔºâ
          sudo rm -f /etc/apt/sources.list.d/tailscale.list
          curl -fsSL $TAILSCALE_LIST_URL | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo chmod 0644 /etc/apt/sources.list.d/tailscale.list
          
          # 4. Êõ¥Êñ∞Âπ∂ÂÆâË£ÖTailscale
          sudo apt update -y 2>&1 | tee -a $FIX_LOG_FILE
          sudo apt install -y tailscale 2>&1 | tee -a $FIX_LOG_FILE
          
          # 5. Êü•ÊâætailscaleÁªùÂØπË∑ØÂæÑÔºàËß£ÂÜ≥sudoÊâæ‰∏çÂà∞ÂëΩ‰ª§ÈóÆÈ¢òÔºâ
          TAILSCALE_PATH=$(which tailscale)
          if [ -z "$TAILSCALE_PATH" ]; then
            echo "‚ùå Tailscale ÂÆâË£ÖÂ§±Ë¥•ÔºåÊú™ÊâæÂà∞ÂèØÊâßË°åÊñá‰ª∂" | tee -a $FIX_LOG_FILE
            exit 0
          fi
          echo "‚úÖ Tailscale ÂÆâË£ÖË∑ØÂæÑÔºö$TAILSCALE_PATH" | tee -a $FIX_LOG_FILE

          # 6. Áî®ÁªùÂØπË∑ØÂæÑÊâßË°åÁôªÂΩïÔºàÈÅøÂÖçsudo PATHÈóÆÈ¢òÔºâ
          if ! sudo "$TAILSCALE_PATH" up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-snapshot-${{ github.run_id }}"; then
            echo "‚ùå Tailscale login failed" | tee -a $FIX_LOG_FILE
            sudo "$TAILSCALE_PATH" status 2>&1 | tee -a $FIX_LOG_FILE
            exit 0
          fi
          TAILSCALE_IP=$(sudo "$TAILSCALE_PATH" ip -4)
          echo "‚úÖ Tailscale IP: $TAILSCALE_IP" | tee -a $FIX_LOG_FILE

      - name: Create Snapshot & Direct Upload to WebDAV
        shell: bash
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          trigger_renew() {
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "‚ùå USER_PAT or REPO is empty" | tee -a $FIX_LOG_FILE
              return 1
            fi
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "‚ùå Failed to trigger renew workflow" | tee -a $FIX_LOG_FILE
              return 1
            fi
            echo "‚úÖ Renew triggered" | tee -a $FIX_LOG_FILE
            RENEW_TRIGGERED=true
            return 0
          }

          create_and_upload_snapshot() {
            [ "${WEBDAV_AVAILABLE}" != "true" ] && return 1
            SNAPSHOT_NAME="casaos-server-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/${SNAPSHOT_NAME}"
            echo "üîÑ Creating snapshot: $SNAPSHOT_NAME (direct upload to WebDAV: ${REMOTE_PATH})" | tee -a $FIX_LOG_FILE

            sudo systemctl stop docker.service docker.socket || true
            if systemctl is-active --quiet casaos.service; then
              sudo systemctl stop casaos.service
            fi
            sudo systemctl mask docker.socket
            sudo pkill -9 docker || true
            sync && sleep 5

            for dir in $CORE_DIRS; do
              if [ ! -d "$dir" ]; then
                echo "‚ö†Ô∏è Directory $dir does not exist, skip backup for it" | tee -a $FIX_LOG_FILE
              fi
            done

            sudo tar -czf "${TMP_SNAPSHOT}" \
              --absolute-names \
              --ignore-failed-read \
              --warning=no-all \
              $EXCLUDE_RULES \
              $CORE_DIRS
            sudo chown runner:runner "${TMP_SNAPSHOT}"
            sudo chmod 644 "${TMP_SNAPSHOT}"

            if [ ! -f "${TMP_SNAPSHOT}" ] || [ $(stat -c%s "${TMP_SNAPSHOT}") -lt 1024 ]; then
              echo "‚ùå Snapshot is empty or invalid (size < 1KB)" | tee -a $FIX_LOG_FILE
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket || true
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl start casaos.service || true
              fi
              return 1
            fi
            echo "‚úÖ Snapshot created: $(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')" | tee -a $FIX_LOG_FILE

            if ! sudo -u runner rclone copy "${TMP_SNAPSHOT}" "${REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 4 \
              --header "Content-Type: application/xml; charset=utf-8" \
              --log-level INFO \
              --log-file /tmp/rclone_upload.log; then
              echo "‚ùå Upload failed, check log: /tmp/rclone_upload.log" | tee -a $FIX_LOG_FILE
              cat /tmp/rclone_upload.log || true
              rm -f "${TMP_SNAPSHOT}"
              sudo systemctl unmask docker.socket
              sudo systemctl start docker.service docker.socket || true
              if systemctl list-unit-files | grep -q casaos.service; then
                sudo systemctl start casaos.service || true
              fi
              return 1
            fi

            echo "‚úÖ Snapshot uploaded to WebDAV: ${REMOTE_PATH}" | tee -a $FIX_LOG_FILE
            META_FILE="/tmp/snapshot_meta.txt"
            echo "snapshot_name=${SNAPSHOT_NAME}" > "${META_FILE}"
            echo "create_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "${META_FILE}"
            sudo -u runner rclone copy "${META_FILE}" "mywebdav:${WEBDAV_SNAPSHOT_EN_DIR}/snapshot_meta.txt" --config /home/runner/.rclone.conf

            rm -f "${TMP_SNAPSHOT}" "${META_FILE}"
            
            echo "üîç Dry run: cleaning snapshots older than 1 day..." | tee -a $FIX_LOG_FILE
            sudo -u runner rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} \
              --config /home/runner/.rclone.conf \
              --min-age 1d \
              --include "casaos-server-snapshot-*.tar.gz" \
              --dry-run
            echo "‚úÖ Executing cleanup..." | tee -a $FIX_LOG_FILE
            sudo -u runner rclone delete mywebdav:${WEBDAV_SNAPSHOT_EN_DIR} \
              --config /home/runner/.rclone.conf \
              --min-age 1d \
              --include "casaos-server-snapshot-*.tar.gz"
            echo "‚úÖ Remote snapshots older than 1 day cleaned up in ${WEBDAV_SNAPSHOT_EN_DIR}" | tee -a $FIX_LOG_FILE

            sudo systemctl unmask docker.socket
            sudo systemctl start docker.service docker.socket || true
            if systemctl list-unit-files | grep -q casaos.service; then
              sudo systemctl start casaos.service || true
            fi
            return 0
          }

          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            echo "üìä Running for $run_mins minutes" | tee -a $FIX_LOG_FILE
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "‚è∞ Time to create and upload snapshot" | tee -a $FIX_LOG_FILE
              if create_and_upload_snapshot; then
                trigger_renew
              else
                echo "‚ùå Snapshot creation failed, skip renew" | tee -a $FIX_LOG_FILE
              fi
            fi
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "‚èπÔ∏è Reached max run time, exiting" | tee -a $FIX_LOG_FILE
              exit 0
            fi
            sleep 60
          done

      - name: Cleanup & Upload Log
        if: ${{ always() }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          sudo systemctl unmask docker.socket || true
          sudo rm -rf /tmp/casaos-server-snapshot-*.tar.gz /home/runner/.rclone.conf /etc/sudoers.d/runner /tmp/rclone_*.log
          # ‰∏ä‰º†‰øÆÂ§çÊó•Âøó‰æõÊéíÊü•
          cp $FIX_LOG_FILE /tmp/tailscale_fix_log_${{ github.run_id }}.log
          echo "‚úÖ Cleanup completed"
          
      - name: Upload Fix Log Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-fix-log-${{ github.run_id }}
          path: /tmp/tailscale_fix_log_${{ github.run_id }}.log
          retention-days: 7
