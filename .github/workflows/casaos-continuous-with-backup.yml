name: CasaOS纯净部署（精简版｜纯清理+备份恢复）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 15  # 已改为15分钟延时
      SNAPSHOT_MD5_SUFFIX: ".md5"

    steps:
      # 大类1：系统基础初始化（Docker+管理员配置）
      - name: 1-系统基础初始化（Docker+管理员配置）
        run: |
          set -e
          echo "===== 大类1：系统基础初始化 ====="
          # 安装必备依赖+清理旧组件
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # 安装Docker+Compose（阿里云镜像，3次重试）
          INSTALL_RETRY=3
          while [ $INSTALL_RETRY -gt 0 ];do
            curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun && break
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            echo "⚠️ Docker安装失败，剩余重试次数：$INSTALL_RETRY" && sleep 30
          done
          [ $INSTALL_RETRY -eq 0 ] && echo "❌ Docker安装失败" && exit 1
          # 启动Docker+配置权限
          sudo systemctl enable --now docker containerd && sleep 2
          sudo systemctl is-active --quiet docker || (echo "❌ Docker启动失败" && exit 1)
          sudo usermod -aG docker runner
          # 创建roots用户+密码+免密sudo+Docker权限
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" || echo "$USER_NAME:$(openssl rand -base64 12)" | sudo chpasswd
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null && sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          # 检查/tmp空间（≥5G）
          TMP_FREE=$(df -h /tmp | grep /tmp | awk '{print $4}' | sed 's/G//')
          [ "$TMP_FREE" -lt 5 ] && echo "❌ /tmp仅剩余${TMP_FREE}G，需至少5G" && exit 1
          echo "✅ 大类1完成：系统基础+Docker+roots用户配置完毕"

      # 大类2：WebDAV备份环境配置+快照检测
      - name: 2-WebDAV备份环境配置+快照检测
        run: |
          set -e
          echo "===== 大类2：WebDAV备份环境配置 ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "⚠️ WebDAV凭证缺失，跳过备份恢复相关操作"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            echo "✅ 大类2完成：WebDAV不可用，跳过配置" && exit 0
          fi
          # 配置rclone WebDAV连接
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          # 创建远程备份目录（3次重试）
          MKDIR_RETRY=3
          while [ $MKDIR_RETRY -gt 0 ];do
            rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf && break
            MKDIR_RETRY=$((MKDIR_RETRY-1)) && echo "⚠️ 远程目录创建失败，剩余重试：$MKDIR_RETRY" && sleep 30
          done
          [ $MKDIR_RETRY -eq 0 ] && echo "❌ WebDAV不可达" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV" && exit 0
          # 检测最新历史快照
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "✅ 检测到最新快照：$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "LATEST_SNAPSHOT_MD5=${REMOTE_SNAPSHOTS}${SNAPSHOT_MD5_SUFFIX}" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "✅ 无历史快照，将纯净部署" && echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "✅ 大类2完成：WebDAV配置+快照检测完毕"

      # 大类3：CasaOS部署+历史快照恢复
      - name: 3-CasaOS部署+历史快照恢复（有快照则恢复，无则纯净安装）
        run: |
          set -e
          echo "===== 大类3：CasaOS部署+数据恢复 ====="
          # 清理旧CasaOS残留+纯净安装（2次重试）
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          CASAOS_RETRY=2
          while [ $CASAOS_RETRY -gt 0 ];do
            curl -fsSL https://get.casaos.io | sudo bash && break
            CASAOS_RETRY=$((CASAOS_RETRY-1)) && echo "⚠️ CasaOS安装失败，剩余重试：$CASAOS_RETRY" && sleep 30
          done
          [ $CASAOS_RETRY -eq 0 ] && echo "❌ CasaOS安装失败" && exit 1
          sudo systemctl stop casaos 2>/dev/null || true
          # 无快照则直接完成安装，有快照则执行恢复流程
          if [ "${{ env.WEBDAV_AVAILABLE }}" != "true" ] || [ "${{ env.HAS_SNAPSHOT }}" != "true" ]; then
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
            echo "✅ 大类3完成：CasaOS纯净安装完毕，无快照恢复" && exit 0
          fi
          # 有快照：关停进程+检查根目录空间+下载MD5+快照校验+解压恢复+权限校准
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          TARGET_FREE=$(df -h / | grep / | awk '{print $4}' | sed 's/G//')
          [ "$TARGET_FREE" -lt 5 ] && echo "❌ 根目录仅剩余${TARGET_FREE}G，需至少5G" && exit 1
          # 下载MD5+快照，流式校验+解压恢复
          rclone copy mywebdav:${WEBDAV_SNAPSHOT_DIR}/${{ env.LATEST_SNAPSHOT_MD5 }} /tmp/ --config /home/runner/.rclone.conf --retries 5 --timeout 1h --contimeout 5m
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf --retries 5 --timeout 1h --contimeout 5m --fast-list | tee >(md5sum -c /tmp/${{ env.LATEST_SNAPSHOT_MD5 }}) >/dev/null
          [ $? -ne 0 ] && echo "❌ MD5校验失败" && exit 1
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${{ env.LATEST_SNAPSHOT }} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          # 校正目录权限
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "✅ 大类3完成：CasaOS部署+快照恢复+权限校准完毕"

      # 大类4：核心服务启动+健康校验
      - name: 4-核心服务启动+健康校验（Docker+CasaOS必保正常）
        run: |
          set -e
          echo "===== 大类4：核心服务启动+健康校验 ====="
          # 释放80/443端口+创建必要目录+权限校准
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          else
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          fi
          # 重启Docker+3次重试健康检测
          sudo systemctl daemon-reload
          sudo systemctl restart docker containerd && sleep 3
          DOCKER_HEALTH_RETRY=3
          while [ $DOCKER_HEALTH_RETRY -gt 0 ];do
            docker ps >/dev/null 2>&1 && break
            DOCKER_HEALTH_RETRY=$((DOCKER_HEALTH_RETRY-1))
            echo "⚠️ Docker未就绪，剩余重试：$DOCKER_HEALTH_RETRY" && sudo systemctl restart docker containerd && sleep 10
          done
          [ $DOCKER_HEALTH_RETRY -eq 0 ] && echo "❌ Docker健康检测失败" && exit 1
          # 启动CasaOS+3次重试健康检测
          sudo systemctl enable --now casaos && sleep 5
          CASAOS_HEALTH_RETRY=3
          while [ $CASAOS_HEALTH_RETRY -gt 0 ];do
            sudo lsof -i:80 | grep LISTEN >/dev/null 2>&1 && break
            CASAOS_HEALTH_RETRY=$((CASAOS_HEALTH_RETRY-1))
            echo "⚠️ CasaOS未就绪，剩余重试：$CASAOS_HEALTH_RETRY" && sudo systemctl restart casaos && sleep 10
          done
          [ $CASAOS_HEALTH_RETRY -eq 0 ] && echo "❌ CasaOS健康检测失败" && exit 1
          echo "📌 CasaOS访问地址：服务器公网IP:80"
          echo "✅ 大类4完成：Docker+CasaOS启动成功，健康校验通过"

      # 大类5：Tailscale组网配置
      - name: 5-Tailscale组网配置（配置密钥则自动组网，无则跳过）
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          echo "===== 大类5：Tailscale组网配置 ====="
          # 安装Tailscale客户端
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          # 启动服务+组网配置
          sudo systemctl enable --now tailscaled && sleep 2
          sudo systemctl is-active --quiet tailscaled || (echo "❌ tailscaled启动失败" && exit 1)
          sudo tailscale up --authkey="${{ env.TAILSCALE_AUTH_KEY }}" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null)
          echo "✅ 大类5完成：Tailscale组网成功，内网IP：${TAILSCALE_IP:-未获取}"

      # 大类6：纯系统垃圾清理（释放20+G｜仅删除无优化）
      - name: 6-纯系统垃圾清理（释放20+G｜仅删除无优化）
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 大类6：纯系统垃圾清理（仅删除无优化） ====="
          # 核心：删除19G无用第三方工具（Haskell/Julia/AWS+配套依赖）
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n 2>/dev/null || true
          # 删除GitHub Runner残留大缓存（/opt下所有无用缓存）
          sudo rm -rf /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google 2>/dev/null || true
          # 系统通用冗余清理：旧内核+apt缓存+过期日志
          sudo apt autoremove --purge -y && sudo apt clean && sudo apt autoclean -y
          sudo journalctl --vacuum-size=100M --vacuum-time=7d
          # 清理所有临时文件+用户/系统缓存
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          # 刷新系统缓存，确保删除的文件彻底释放空间
          sudo sync && sudo echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || true
          echo "✅ 大类6完成：纯垃圾清理完毕，释放20+G空间（19G工具+日志+缓存）"

      # 大类7：核心数据备份+自动续跑触发
      - name: 7-核心数据备份+自动续跑触发（WebDAV可用则执行）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 大类7：核心数据备份+自动续跑 ====="
          # 清理旧备份（保留2份）
          BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
          BACKUP_COUNT=$(echo "$BACKUPS" | wc -l)
          if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ];then
            DELETE_LIST=$(echo "$BACKUPS" | tail -n $((BACKUP_COUNT - KEEP_BACKUPS)))
            for FILE in $DELETE_LIST;do
              rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$FILE --config /home/runner/.rclone.conf
              rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${FILE}${SNAPSHOT_MD5_SUFFIX} --config /home/runner/.rclone.conf
              echo "✅ 已删除旧备份：$FILE"
            done
          fi
          # 精准延时校准（满15分钟）
          START_TIME_JOB=$( [ -n "$GITHUB_RUN_STARTED_AT" ] && date -d "$GITHUB_RUN_STARTED_AT" +%s || date +%s )
          WAIT_TIME=$(( TARGET_RUN_MINUTES*60 - ( $(date +%s) - START_TIME_JOB ) ))
          [ $WAIT_TIME -gt 0 ] && echo "已运行$(( ( $(date +%s) - START_TIME_JOB ) / 60 ))分，需再等$((WAIT_TIME/60))分后备份（总时长满15分）" && sleep $WAIT_TIME
          # 关停进程+打包核心数据+生成MD5
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 casaos docker dockerd containerd runc docker-proxy 2>/dev/null || true
          sudo fuser -k 2375/tcp 2376/tcp 80/tcp 443/tcp /var/lib/docker 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd/*.lock 2>/dev/null || true
          sync && sudo sync && sleep 5
          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
          sudo tar -czPf $SNAPSHOT_PATH $EXCLUDE_RULES --warning=no-file-changed --exclude=*/socket --one-file-system $PERSONAL_DATA_DIRS
          sudo md5sum $SNAPSHOT_PATH > "${SNAPSHOT_PATH}${SNAPSHOT_MD5_SUFFIX}"
          # 上传快照+MD5+远程校验（修改核心：移除无效flag，保留稳定传输参数）
          rclone copy $SNAPSHOT_PATH mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf \
            --transfers 2 --retries 5 --retries-sleep 30s --timeout 1h --contimeout 5m --resume-support
          rclone copy "${SNAPSHOT_PATH}${SNAPSHOT_MD5_SUFFIX}" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf \
            --retries 5 --timeout 1h --contimeout 5m
          rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/$SNAPSHOT_NAME --config /home/runner/.rclone.conf >/dev/null
          rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}${SNAPSHOT_MD5_SUFFIX} --config /home/runner/.rclone.conf >/dev/null
          # 启动服务+触发自动续跑
          sudo rm -f $SNAPSHOT_PATH "${SNAPSHOT_PATH}${SNAPSHOT_MD5_SUFFIX}"
          sudo systemctl enable --now docker containerd casaos && sleep 3
          if [ -n "${{ env.USER_PAT }}" ] && [ -n "${{ env.REPO }}" ];then
            curl -fsSL --fail --connect-timeout 30 -X POST -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_snapshot"}' && echo "✅ 自动续跑触发成功" || echo "⚠️ 自动续跑触发失败"
          fi
          echo "✅ 大类7完成：数据备份+上传校验+续跑触发完毕"

      # 大类8：收尾安全清理+全流程最终总结
      - name: 8-收尾安全清理+全流程最终总结
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 大类8：收尾清理+最终总结 ====="
          # 清理临时文件+敏感配置+残留缓存
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo rm -f /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq 2>/dev/null || true
          # 最终状态输出
          echo "📌 磁盘占用情况（已释放20+G可用空间）：" && du -sh / 2>/dev/null
          echo "📌 核心服务最终状态："
          sudo systemctl is-active --quiet docker && echo "✅ Docker：正常运行" || echo "⚠️ Docker：未运行"
          sudo systemctl is-active --quiet casaos && echo "✅ CasaOS：正常运行" || echo "⚠️ CasaOS：未运行"
          [ -n "${{ env.TAILSCALE_AUTH_KEY }}" ] && sudo systemctl is-active --quiet tailscaled && echo "✅ Tailscale：正常运行" || echo "ℹ️ Tailscale：未配置/运行正常"
          echo "🎉 全流程执行完毕！"
          echo "✅ 核心成果：CasaOS部署完成+纯垃圾清理释放20+G+数据备份恢复，可正常使用"
          echo "🔚 访问入口：服务器公网IP:80  管理员账号：roots"
          echo "✅ 大类8完成：收尾清理完毕，全流程结束"