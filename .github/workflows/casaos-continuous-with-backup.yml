name: CasaOS+VNC+Tailscale 持续服务（到期备份+续跑恢复最终版）
on:
  workflow_dispatch:        # 手动触发
  repository_dispatch:
    types: [renew_vnc]     # 续跑触发

jobs:
  casaos-vnc-continuous:
    runs-on: ubuntu-24.04
    timeout-minutes: 350   # 总运行时长（预留10分钟备份+续跑）
    env:
      # 基础环境配置
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340 # 实际运行时长（剩余10分钟执行备份+续跑）
      # 认证配置
      FIXED_VNC_PWD: "123456789"
      RUNNER_PASSWORD: "runner123"
      # 服务端口配置
      CASAOS_PORT: 80
      # 目录配置
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      # 备份排除规则（避免系统目录冲突）
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      # 维护配置
      CLEAN_INTERVAL: 3600 # 每1小时清理一次
      # Backblaze B2 存储配置（核心密钥）
      B2_KEY_ID: "87dbd01ad00c"
      B2_APPLICATION_KEY: "005199ce79f1bd581cbfc54b2fb12ba6b5fd7d0fb6"
      B2_BACKUP_BUCKET: "casaos-backup"
      BACKUP_MARKER: "latest_backup.txt" # 标记最新备份文件名（用于续跑恢复）

    steps:
      ###########################################################################
      # 第一步：系统环境初始化（基础依赖+权限配置）
      ###########################################################################
      - name: 1. 系统环境初始化
        id: init_system
        continue-on-error: false
        run: |
          echo "===== 开始系统环境初始化 ====="
          # 1. 更新系统包索引并升级
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "ERROR: 系统更新失败"; exit 1; }
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "ERROR: 系统升级失败"; exit 1; }
          
          # 2. 安装核心依赖（含备份、VNC、存储等工具）
          required_packages="tar gzip rsync rclone tigervnc-standalone-server netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release bc"
          sudo apt install -y $required_packages || { echo "ERROR: 核心依赖安装失败"; exit 1; }
          
          # 3. 配置runner用户密码（远程登录用）
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          
          # 4. 创建必要目录并授权
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          
          echo "INFO: 系统环境初始化完成"

      ###########################################################################
      # 第二步：对象存储配置（Backblaze B2 + rclone）
      ###########################################################################
      - name: 2. 配置 Backblaze B2 存储（rclone）
        id: config_b2_storage
        continue-on-error: false
        run: |
          echo "===== 开始配置 B2 存储 ====="
          # 1. 验证B2密钥完整性
          if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
            echo "ERROR: B2存储密钥未配置（KEY_ID/APPLICATION_KEY缺失）"; exit 1;
          fi
          
          # 2. 创建rclone配置目录并写入配置
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
[b2_backend]
type = b2
account = $B2_KEY_ID
key = $B2_APPLICATION_KEY
hard_delete = true
timeout = 30s
retries = 3
EOF
          # 3. 配置文件权限（安全限制，仅当前用户可读）
          chmod 600 ~/.config/rclone/rclone.conf
          
          # 4. 测试B2存储连接并创建备份桶
          echo "===== 测试 B2 存储连接 ====="
          rclone mkdir b2_backend:${B2_BACKUP_BUCKET}/ || echo "INFO: 备份桶已存在，跳过创建"
          if rclone lsd b2_backend:${B2_BACKUP_BUCKET}/ --verbose --retries 3; then
            echo "INFO: B2存储连接成功"
            echo "B2_CONNECT_STATUS=success" >> $GITHUB_ENV
          else
            echo "ERROR: B2存储连接失败，请检查：1. 密钥是否正确 2. 网络是否可达"
            exit 1
          fi
          
          echo "INFO: B2存储配置完成"

      ###########################################################################
      # 第三步：检查历史备份（用于续跑恢复判断）
      ###########################################################################
      - name: 3. 检查历史备份（续跑恢复用）
        id: check_history_backup
        continue-on-error: false
        run: |
          echo "===== 检查历史备份 ====="
          # 1. 尝试下载备份标记文件（记录最新备份文件名）
          if rclone copy b2_backend:${B2_BACKUP_BUCKET}/${BACKUP_MARKER} $BACKUP_DIR/ --timeout 30s; then
            LATEST_BACKUP=$(cat $BACKUP_DIR/${BACKUP_MARKER})
            echo "INFO: 找到最新备份：$LATEST_BACKUP"
            echo "LATEST_BACKUP=$LATEST_BACKUP" >> $GITHUB_ENV
            echo "HAS_HISTORY_BACKUP=true" >> $GITHUB_ENV
          else
            echo "INFO: 未找到历史备份（首次部署或无有效备份）"
            echo "HAS_HISTORY_BACKUP=false" >> $GITHUB_ENV
          fi

      ###########################################################################
      # 第四步：安装基础服务（Docker + CasaOS）
      ###########################################################################
      - name: 4. 安装基础服务（Docker + CasaOS）
        id: install_base_services
        continue-on-error: false
        run: |
          echo "===== 安装 Docker 引擎 ====="
          # 1. 配置Docker官方源
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          # 2. 安装Docker并启动
          sudo apt update -y 2>&1 | grep -v "restart"
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin || { echo "ERROR: Docker安装失败"; exit 1; }
          sudo systemctl enable docker && sudo systemctl start docker
          echo "INFO: Docker安装并启动成功"
          
          echo "===== 安装 CasaOS ====="
          # 1. 安装CasaOS（官方脚本）
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || { echo "WARNING: CasaOS安装警告（可能不影响使用）"; }
          # 2. 先停止CasaOS（若后续需要恢复备份，避免数据冲突）
          sudo systemctl stop casaos
          sudo systemctl stop docker
          echo "INFO: CasaOS安装完成（已停止，待恢复/直接启动）"

      ###########################################################################
      # 第五步：续跑恢复（仅当有历史备份时执行）
      ###########################################################################
      - name: 5. 续跑恢复 - 从B2恢复最新备份
        id: restore_from_backup
        if: env.HAS_HISTORY_BACKUP == 'true'
        continue-on-error: false
        run: |
          echo "===== 开始恢复最新备份：${LATEST_BACKUP} ====="
          # 1. 生成排除文件（修复YAML语法冲突，替代进程替换）
          echo "$BACKUP_EXCLUDE" | tr ' ' '\n' | sed 's/--exclude=//g' > $BACKUP_DIR/exclude-list.txt
          
          # 2. 从B2下载备份并解压恢复（内存直传，不落地大文件）
          rclone cat b2_backend:${B2_BACKUP_BUCKET}/${LATEST_BACKUP} --timeout 120s --retries 3 | sudo tar -zxf - -C / --exclude-from=$BACKUP_DIR/exclude-list.txt 2>/dev/null
          
          # 3. 验证恢复结果并重启服务
          if [ $? -eq 0 ]; then
            echo "INFO: 备份恢复成功！数据与上一次环境完全一致"
            # 重启Docker和CasaOS
            sudo systemctl start docker
            sleep 5 && sudo systemctl start casaos
          else
            echo "ERROR: 备份恢复失败，启动全新环境"
            echo "HAS_HISTORY_BACKUP=false" >> $GITHUB_ENV
            # 重启服务
            sudo systemctl start docker
            sleep 5 && sudo systemctl start casaos
          fi

      ###########################################################################
      # 第六步：部署核心服务（VNC + Tailscale）
      ###########################################################################
      - name: 6. 部署核心服务（VNC + Tailscale）
        id: deploy_core_services
        continue-on-error: false
        run: |
          echo "===== 配置 VNC 服务 ====="
          # 1. 创建VNC配置目录并设置密码
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          
          # 2. 编写VNC启动脚本（适配Ubuntu环境）
          cat > $VNCDIR/xstartup << EOF
#!/bin/bash
export DISPLAY=:0
export XDG_RUNTIME_DIR=/tmp/runtime-runner
mkdir -p \$XDG_RUNTIME_DIR && chmod 700 \$XDG_RUNTIME_DIR
exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title "CasaOS 服务控制台"
EOF
          chmod +x $VNCDIR/xstartup
          
          # 3. 启动VNC服务（先停止旧进程）
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth || { echo "ERROR: VNC启动失败"; exit 1; }
          echo "INFO: VNC服务启动成功，端口：$VNC_PORT"
          
          echo "===== 配置 Tailscale 组网 ====="
          # 1. 安装Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart" || { echo "ERROR: Tailscale安装失败"; exit 1; }
          sudo systemctl enable --now tailscaled && sleep 3
          
          # 2. 连接Tailscale（带重试机制）
          MAX_RETRIES=3
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "INFO: Tailscale连接成功，内网IP：$TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            echo "WARNING: Tailscale连接失败，剩余重试次数：$MAX_RETRIES"
            sleep 5
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
            echo "ERROR: Tailscale连接失败，无法获取访问IP"; exit 1;
          fi

      ###########################################################################
      # 第七步：输出服务访问信息（清晰展示核心配置）
      ###########################################################################
      - name: 7. 输出服务访问信息
        id: output_access_info
        continue-on-error: false
        run: |
          echo -e "\n=================================================="
          echo -e " CasaOS+VNC+Tailscale 持续服务（优化版）"
          echo -e "=================================================="
          echo -e " 系统信息"
          echo -e "   - 运行时长：${MAX_RUN_MINUTES}分钟（剩余10分钟自动备份+续跑）"
          echo -e "   - 可用空间：$(df -h / | awk 'NR==2{print $4}')"
          echo -e "   - Runner登录密码：${RUNNER_PASSWORD}"
          echo -e " 存储信息"
          echo -e "   - 存储类型：Backblaze B2"
          echo -e "   - 存储状态：$(if [ $B2_CONNECT_STATUS = 'success' ]; then echo '成功'; else echo '失败'; fi)"
          echo -e "   - 备份策略：仅到期前10分钟执行全量备份，续跑自动恢复"
          echo -e " 访问地址"
          echo -e "   - VNC远程桌面：${TAILSCALE_IP}:${VNC_PORT}（密码：${FIXED_VNC_PWD}）"
          echo -e "   - CasaOS管理界面：http://${TAILSCALE_IP}:${CASAOS_PORT}"
          echo -e " 维护信息"
          echo -e "   - 定时清理：每1小时自动清理系统垃圾"
          echo -e "   - 数据状态：$(if [ $HAS_HISTORY_BACKUP == 'true' ]; then echo '已恢复上一次环境数据'; else echo '首次部署，无历史数据'; fi)"
          echo -e "==================================================\n"

      ###########################################################################
      # 第八步：核心逻辑（保活+定时清理+到期备份+续跑触发）
      ###########################################################################
      - name: 8. 核心逻辑 - 保活+清理+备份+续跑
        id: core_logic
        continue-on-error: true
        run: |
          echo "===== 启动核心监控逻辑 ====="
          start_time=$(date +%s)
          last_clean_time=$start_time
          backup_executed=false # 标记是否已执行到期备份

          #######################################
          # 子函数1：每小时垃圾清理（深度清理）
          #######################################
          auto_clean() {
            echo "===== 执行每小时垃圾清理 ====="
            BEFORE_CLEAN=$(df -h / | awk 'NR==2{print $4}')
            # 1. 系统缓存清理
            sudo apt clean -y && sudo apt autoremove -y --purge
            # 2. Docker冗余清理（镜像、容器、卷）
            sudo docker system prune -af --volumes 2>/dev/null || true
            # 3. 临时文件清理
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null
            AFTER_CLEAN=$(df -h / | awk 'NR==2{print $4}')
            echo "INFO: 清理完成：清理前${BEFORE_CLEAN} → 清理后${AFTER_CLEAN}"
          }

          #######################################
          # 子函数2：到期备份（仅执行一次）
          #######################################
          expire_full_backup() {
            echo "===== 剩余10分钟，执行全量备份 ====="
            # 1. 生成备份文件名（时间戳）
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            FULL_BACKUP_NAME="casaos_full_${TIMESTAMP}.tar.gz"
            
            # 2. 停止核心服务确保数据一致性
            sudo systemctl stop casaos
            sudo systemctl stop docker
            sleep 3
            
            # 3. 执行全量备份（内存直传至B2，不落地）
            sudo tar -zcf - $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat b2_backend:${B2_BACKUP_BUCKET}/${FULL_BACKUP_NAME} --timeout 60s --retries 3
            
            # 4. 验证备份结果并更新标记文件
            if [ $? -eq 0 ]; then
              echo "INFO: 到期备份成功：b2_backend:${B2_BACKUP_BUCKET}/${FULL_BACKUP_NAME}"
              # 更新备份标记文件（供续跑恢复）
              echo "${FULL_BACKUP_NAME}" > $BACKUP_DIR/${BACKUP_MARKER}
              rclone copy $BACKUP_DIR/${BACKUP_MARKER} b2_backend:${B2_BACKUP_BUCKET}/ --timeout 30s
            else
              echo "ERROR: 到期备份失败"
            fi
            
            # 5. 重启核心服务
            sudo systemctl start docker
            sleep 5 && sudo systemctl start casaos
            backup_executed=true
          }

          #######################################
          # 子函数3：触发续跑（启动新工作流）
          #######################################
          trigger_renew() {
            echo "===== 触发续跑请求 ====="
            curl -X POST https://api.github.com/repos/${{ github.repository }}/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.USER_GITHUB_PAT }}" \
              -d '{"event_type":"renew_vnc"}' \
              --connect-timeout 30s || echo "ERROR: 续跑触发失败（请检查USER_GITHUB_PAT密钥）"
          }

          #######################################
          # 主循环：保活+定时清理+到期备份+续跑
          #######################################
          while true; do
            current_time=$(date +%s)
            run_minutes=$(( (current_time - start_time) / 60 ))
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            # 1. 每小时执行垃圾清理
            if [ $((current_time - last_clean_time)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean_time=$current_time
            fi

            # 2. 空间应急清理（不足1GB立即清理）
            if (( $(echo "$FREE_SPACE < 1" | bc -l) )); then
              echo "WARNING: 空间不足1GB，紧急清理..."
              auto_clean
              last_clean_time=$current_time
            fi

            # 3. 剩余10分钟：执行备份+触发续跑（仅一次）
            if [ $((MAX_RUN_MINUTES - run_minutes)) -eq 10 ] && [ "$backup_executed" = false ]; then
              expire_full_backup  # 执行到期备份
              trigger_renew       # 触发续跑
            fi

            # 4. 服务健康检查（异常自动重启）
            pgrep -x Xvnc || { echo "WARNING: VNC异常，重启"; vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth; }
            sudo systemctl is-active --quiet docker || { echo "WARNING: Docker异常，重启"; sudo systemctl restart docker; }
            sudo systemctl is-active --quiet casaos || { echo "WARNING: CasaOS异常，重启"; sudo systemctl restart casaos; }
            sudo systemctl is-active --quiet tailscaled || { echo "WARNING: Tailscale异常，重启"; sudo systemctl restart tailscaled; }

            # 5. 运行状态日志
            echo "[$(date)] 运行时长：${run_minutes}分钟 | 剩余空间: $(df -h / | awk 'NR==2{print $4}') | 下次清理：$(( (last_clean_time + CLEAN_INTERVAL - current_time) / 60 ))分钟后"
            sleep 300 # 每5分钟检查一次
          done

      ###########################################################################
      # 第九步：优雅清理环境（无论成功/失败都执行）
      ###########################################################################
      - name: 9. 优雅清理环境
        id: clean_env
        if: always()
        run: |
          echo "===== 开始清理环境 ====="
          # 1. 停止VNC服务
          vncserver -kill $DISPLAY || true && pkill -9 Xvnc || true
          # 2. 停止核心服务
          sudo systemctl stop docker casaos tailscaled || true
          sudo tailscale down || true
          # 3. 清理本地临时文件（备份已存B2）
          rm -rf $BACKUP_DIR $VNCDIR $NETDISK_ROOT || true
          echo "INFO: 环境清理完成"
