name: CasaOS-Tailscale-Full-Deploy
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_tailscale]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      # æ ¸å¿ƒé…ç½®
      MAX_RUN_MINUTES: 330
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu /a/Ubu"
      CASAOS_DATA: /var/lib/casaos
      DOCKER_DATA: /var/lib/docker
      EXCLUDE_DIRS: "/bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp"
      # é‡è¯•é…ç½®
      MAX_MOUNT_RETRIES: 2
      RETRY_DELAY: 10
      # Secrets å¼•ç”¨
      WEBDAV_URL: "${{ secrets.WEBDAV_URL }}"
      WEBDAV_USER: "${{ secrets.WEBDAV_USER }}"
      WEBDAV_PASSWORD: "${{ secrets.WEBDAV_PASSWORD }}"
      USER_PAT: "${{ secrets.USER_PAT }}"
      TAILSCALE_AUTH_KEY: "${{ secrets.TAILSCALE_AUTH_KEY }}"
      REPO: "${{ github.repository }}"

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ==========
      - name: æ­¥éª¤1 - ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–
        id: step1
        run: |
          echo "===== æ­¥éª¤1ï¼šç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ– ====="
          mkdir -p /home/runner/logs $WEBDAV_MOUNT_POINT
          LOG_FILE=/home/runner/logs/casaos-tailscale-${{ github.run_id }}.log
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
          exec > >(tee -a $LOG_FILE) 2>&1
          
          # å®‰è£…ä¾èµ–
          sudo apt update -y && sudo apt upgrade -y -q
          sudo apt install -y rsync davfs2 curl wget jq iptables || { echo "ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          
          # é…ç½®sudoå…å¯†
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee -a /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      # ========== æ­¥éª¤2ï¼šæŒ‚è½½WebDAVï¼ˆå¤±è´¥ç›´æ¥è·³è¿‡å¤‡ä»½æ¢å¤ï¼Œä¸ç»ˆæ­¢ï¼‰ ==========
      - name: æ­¥éª¤2 - æŒ‚è½½WebDAVå¹¶æ ‡è®°çŠ¶æ€
        id: step2
        run: |
          echo "===== æ­¥éª¤2ï¼šæŒ‚è½½WebDAVå¹¶æ ‡è®°çŠ¶æ€ ====="
          # é…ç½®å…å¯†æŒ‚è½½
          echo "$WEBDAV_URL $WEBDAV_USER $WEBDAV_PASSWORD" | sudo tee -a /etc/davfs2/secrets
          sudo chmod 600 /etc/davfs2/secrets
          
          # æŒ‚è½½é‡è¯•é€»è¾‘
          mount_success=false
          retry_count=0
          while [ $retry_count -le $MAX_MOUNT_RETRIES ]; do
            sudo umount $WEBDAV_MOUNT_POINT 2>/dev/null || true
            echo "ğŸ”„ æŒ‚è½½WebDAVï¼ˆç¬¬ $((retry_count+1)) æ¬¡ï¼‰"
            if sudo mount -t davfs -o uid=runner,gid=runner $WEBDAV_URL $WEBDAV_MOUNT_POINT; then
              mount_success=true
              break
            fi
            retry_count=$((retry_count+1))
            if [ $retry_count -le $MAX_MOUNT_RETRIES ]; then
              echo "â³ ç­‰å¾… $RETRY_DELAY ç§’é‡è¯•..."
              sleep $RETRY_DELAY
            fi
          done
          
          # å…³é”®ï¼šæŒ‚è½½å¤±è´¥ä¸ç»ˆæ­¢ï¼Œåªæ ‡è®°çŠ¶æ€
          if [ "$mount_success" = "true" ]; then
            echo "âœ… WebDAVæŒ‚è½½æˆåŠŸ"
            echo "WEBDAV_AVAILABLE=true" >> $GITHUB_ENV
            # æ£€æµ‹å¤‡ä»½ç›®å½•ï¼ˆä»…æŒ‚è½½æˆåŠŸæ—¶æ‰§è¡Œï¼‰
            for dir in $BACKUP_DIRS; do
              target_path=$WEBDAV_MOUNT_POINT$dir
              if [ -d "$target_path" ] && [ "$(ls -A $target_path)" ]; then
                echo "âœ… æ£€æµ‹åˆ° $dir æœ‰å¤‡ä»½æ•°æ®"
                echo "HAS_${dir//\//_}=true" >> $GITHUB_ENV
              else
                sudo mkdir -p "$target_path"
                echo "HAS_${dir//\//_}=false" >> $GITHUB_ENV
              fi
            done
          else
            echo "âŒ WebDAVæŒ‚è½½å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤æµç¨‹"
            echo "WEBDAV_AVAILABLE=false" >> $GITHUB_ENV
          fi
          echo "âœ… æ­¥éª¤2å®Œæˆï¼ˆæŒ‚è½½çŠ¶æ€å·²æ ‡è®°ï¼‰"

      # ========== æ­¥éª¤3ï¼šæ•°æ®æ¢å¤ï¼ˆä»…WebDAVå¯ç”¨æ—¶æ‰§è¡Œï¼‰ ==========
      - name: æ­¥éª¤3 - ä»WebDAVæ¢å¤æ•°æ®
        id: step3
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== æ­¥éª¤3ï¼šä»WebDAVæ¢å¤æ•°æ® ====="
          RESTORE_DONE=false
          for dir in $BACKUP_DIRS; do
            env_key="HAS_${dir//\//_}"
            target_path=$WEBDAV_MOUNT_POINT$dir
            if [ "${!env_key}" = "true" ] && [ "$RESTORE_DONE" = "false" ]; then
              echo "ğŸ”„ ä» $dir æ¢å¤æ•°æ®"
              EXCLUDE_PARAMS=()
              for excl in $EXCLUDE_DIRS; do
                EXCLUDE_PARAMS+=("--exclude=${excl}/*")
              done
              sudo rsync -av --delete --ignore-errors "${EXCLUDE_PARAMS[@]}" "$target_path/" /
              RESTORE_DONE=true
              echo "âœ… æ•°æ®æ¢å¤å®Œæˆ"
            fi
          done
          if [ "$RESTORE_DONE" = "false" ]; then
            echo "âš ï¸ æ— å¯ç”¨å¤‡ä»½æ•°æ®ï¼Œè·³è¿‡æ¢å¤"
          fi
          echo "DATA_RESTORED=$RESTORE_DONE" >> $GITHUB_ENV

      # ========== æ­¥éª¤4ï¼šæ¸…ç©ºæ—§å¤‡ä»½ï¼ˆä»…WebDAVå¯ç”¨æ—¶æ‰§è¡Œï¼‰ ==========
      - name: æ­¥éª¤4 - æ¸…ç©ºWebDAVæ—§å¤‡ä»½
        id: step4
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          echo "===== æ­¥éª¤4ï¼šæ¸…ç©ºWebDAVæ—§å¤‡ä»½ ====="
          for dir in $BACKUP_DIRS; do
            target_path=$WEBDAV_MOUNT_POINT$dir
            sudo rm -rf "$target_path"/*
            echo "âœ… $dir æ—§æ•°æ®å·²æ¸…ç©º"
          done

      # ========== æ­¥éª¤5ï¼šå®‰è£…CasaOSï¼ˆæœ‰å¤‡ä»½è·³è¿‡ï¼Œæ— å¤‡ä»½å®‰è£…ï¼‰ ==========
      - name: æ­¥éª¤5 - å®‰è£…CasaOS
        id: step5
        run: |
          echo "===== æ­¥éª¤5ï¼šå®‰è£…CasaOS ====="
          if [ "${{ env.DATA_RESTORED }}" = "true" ] && [ -d "$CASAOS_DATA" ]; then
            echo "âœ… æ£€æµ‹åˆ°å¤‡ä»½æ•°æ®ï¼Œè·³è¿‡å®‰è£…"
            exit 0
          fi
          echo "ğŸ”„ å®‰è£…CasaOS"
          curl -fsSL https://get.casaos.io | sudo bash || { echo "CasaOSå®‰è£…å¤±è´¥"; exit 1; }
          echo "âœ… CasaOSå®‰è£…å®Œæˆ"

      # ========== æ­¥éª¤6ï¼šå¯åŠ¨æœåŠ¡ ==========
      - name: æ­¥éª¤6 - å¯åŠ¨CasaOS+Docker
        id: step6
        run: |
          echo "===== æ­¥éª¤6ï¼šå¯åŠ¨CasaOS+Docker ====="
          sudo systemctl enable --now docker casaos
          sleep 30
          echo "DockerçŠ¶æ€: $(sudo systemctl is-active docker)"
          echo "CasaOSçŠ¶æ€: $(sudo systemctl is-active casaos)"
          echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      # ========== æ­¥éª¤7ï¼šéƒ¨ç½²Tailscale ==========
      - name: æ­¥éª¤7 - éƒ¨ç½²Tailscaleç»„ç½‘
        id: step7
        run: |
          echo "===== æ­¥éª¤7ï¼šéƒ¨ç½²Tailscaleç»„ç½‘ ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âŒ æœªé…ç½®Tailscaleå¯†é’¥ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-github-runner"
          TAILSCALE_IP=$(sudo tailscale ip -4)
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸï¼Œå†…ç½‘IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      # ========== æ­¥éª¤8ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: æ­¥éª¤8 - è¾“å‡ºè®¿é—®ä¿¡æ¯
        id: step8
        run: |
          echo "===== æ­¥éª¤8ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ====="
          RUNNER_PUBLIC_IP=$(curl -s ifconfig.me)
          echo "====================================="
          echo "ğŸ”— å…¬ç½‘è®¿é—®: http://$RUNNER_PUBLIC_IP:80"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "ğŸ”’ å†…ç½‘è®¿é—®: http://${{ env.TAILSCALE_IP }}:80"
          fi
          echo "ğŸ”‘ é»˜è®¤è´¦å·: admin / password"
          echo "âš ï¸ ç™»å½•åè¯·ä¿®æ”¹é»˜è®¤å¯†ç "
          echo "====================================="

      # ========== æ­¥éª¤9ï¼šä¿æ´»+å¤‡ä»½+ç»­è·‘ï¼ˆä»…WebDAVå¯ç”¨æ—¶æ‰§è¡Œå¤‡ä»½ï¼‰ ==========
      - name: æ­¥éª¤9 - ä¿æ´»+å¤‡ä»½+ç»­è·‘è§¦å‘
        id: step9
        run: |
          echo "===== æ­¥éª¤9ï¼šä¿æ´»+å¤‡ä»½+ç»­è·‘è§¦å‘ ====="
          start_time=$(date +%s)
          backup_done=false
          trigger_done=false

          # ç»­è·‘è§¦å‘å‡½æ•°
          trigger_renew() {
            if [ "$trigger_done" = "true" ] || [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then return 1; fi
            RESPONSE=$(curl -s -X POST -H "Authorization: token $USER_PAT" \
              https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_tailscale"}' -w "%{http_code}" -o /dev/null)
            if [ $RESPONSE -eq 204 ]; then
              trigger_done=true
              echo "âœ… ç»­è·‘ä»»åŠ¡è§¦å‘æˆåŠŸ"
              return 0
            fi
            return 1
          }

          # å¤‡ä»½å‡½æ•°ï¼ˆä»…WebDAVå¯ç”¨æ—¶æ‰§è¡Œï¼‰
          backup_single_dir() {
            if [ "${{ env.WEBDAV_AVAILABLE }}" != "true" ]; then return 1; fi
            local dir=$1
            local target_path=$WEBDAV_MOUNT_POINT$dir
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=${excl}/*")
            done
            sudo rsync -av --delete --ignore-errors "${EXCLUDE_PARAMS[@]}" / "$target_path/"
            if [ $? -eq 0 ]; then
              echo "âœ… $dir å¤‡ä»½å®Œæˆ"
              echo "backup_time=$(date +%Y%m%d_%H%M%S) runner_id=${{ github.run_id }}" | sudo tee "$target_path/backup_marker.txt" >/dev/null
              return 0
            fi
            return 1
          }

          # ä¿æ´»ä¸»å¾ªç¯
          while true; do
            run_mins=$(( (date +%s - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2{print $4}')
            echo "ğŸ“Š è¿è¡ŒçŠ¶æ€ï¼šå·²è¿è¡Œ $run_mins åˆ†é’Ÿ | å‰©ä½™ $((MAX_RUN_MINUTES-run_mins)) åˆ†é’Ÿ | å¯ç”¨ç©ºé—´ $free_space"

            # å‰©ä½™30åˆ†é’Ÿæ‰§è¡Œå¤‡ä»½+ç»­è·‘
            if [ $((MAX_RUN_MINUTES - run_mins)) -eq 30 ] && [ "$backup_done" = "false" ]; then
              echo "âš ï¸ å‰©ä½™30åˆ†é’Ÿï¼Œæ‰§è¡Œå¤‡ä»½+ç»­è·‘"
              for dir in $BACKUP_DIRS; do
                if backup_single_dir $dir; then
                  trigger_renew
                  backup_done=true
                  break
                fi
              done
              if [ "$backup_done" = "false" ]; then
                echo "âš ï¸ å¤‡ä»½å¤±è´¥ï¼Œå°è¯•ç›´æ¥è§¦å‘ç»­è·‘"
                trigger_renew
              fi
            fi

            sleep 60
          done

      # ========== æ­¥éª¤10ï¼šç¯å¢ƒæ¸…ç† ==========
      - name: æ­¥éª¤10 - æ¸…ç†ç¯å¢ƒ
        id: step10
        if: ${{ always() }}
        run: |
          echo "===== æ­¥éª¤10ï¼šç¯å¢ƒæ¸…ç† ====="
          sudo umount $WEBDAV_MOUNT_POINT 2>/dev/null || true
          sudo rm -rf /tmp/* /home/runner/*.log
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
