name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆä¼˜åŒ–ä¿®å¤ç‰ˆÂ·zstd19å‹ç¼©ï¼‰

on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /var/app /DATA /root/.config"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 5
      BACKUP_RETRY_INTERVAL: 600
      MAX_RETRY_COUNT: 1

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+æ·±åº¦æ¸…ç†
        run: |
          set -e
          echo "===== 1-ç³»ç»Ÿåˆå§‹åŒ–+æ·±åº¦æ¸…ç† ====="
          sudo apt update -y
          sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg zstd
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null
          sudo systemctl daemon-reload
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y
          sudo DEBIAN_FRONTEND=noninteractive apt clean
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/*
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      - name: 2-å®‰è£…Docker
        run: |
          set -e
          echo "===== 2-å®‰è£… Docker ====="
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd
          sleep 3
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Docker å®‰è£…å®Œæˆ"

      - name: 3-å®‰è£…CasaOS
        run: |
          set -e
          echo "===== 3-å®‰è£… CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOS å®‰è£…å®Œæˆ"

      - name: 4-åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          echo "===== 4-é…ç½®ç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          if ! id -u "$USER_NAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash "$USER_NAME"
          fi
          
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ roots éšæœºå¯†ç ï¼š$RANDOM_PASS"
          fi
          
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME"
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç®¡ç†å‘˜é…ç½®å®Œæˆ"

      - name: 5-WebDAVé…ç½®ä¸å¿«ç…§æ£€æµ‹
        run: |
          set -e
          echo "===== 5-WebDAVç¯å¢ƒåˆå§‹åŒ– ====="
          
          # æ£€æŸ¥WebDAVé…ç½®
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡å¤‡ä»½åŠŸèƒ½"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # åˆ›å»ºrcloneé…ç½®
          ENCRYPTED_PASS=$(echo -n "$WEBDAV_PASSWORD" | rclone obscure -)
          sudo tee /root/.rclone.conf > /dev/null <<EOF
[mywebdav]
type = webdav
url = $WEBDAV_URL
user = $WEBDAV_USER
pass = $ENCRYPTED_PASS
EOF
          
          sudo chmod 600 /root/.rclone.conf
          
          # æµ‹è¯•WebDAVè¿æ¥
          if ! sudo rclone lsd mywebdav: --config /root/.rclone.conf 2>/dev/null; then
            echo "âŒ WebDAVè¿æ¥å¤±è´¥"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 1
          fi
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          sudo rclone mkdir mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /root/.rclone.conf 2>/dev/null || true
          
          # æŸ¥æ‰¾æœ€æ–°å¿«ç…§
          REMOTE_SNAPSHOTS=$(sudo rclone ls mywebdav:"$WEBDAV_SNAPSHOT_DIR" --config /root/.rclone.conf 2>/dev/null | \
            grep -E "casaos-full-snapshot.*\.tar\.zst$" | \
            sort -r | \
            head -1 | \
            awk '{$1=""; print substr($0,2)}')
          
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ£€æµ‹åˆ°å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=\"$REMOTE_SNAPSHOTS\"" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… æ— å¿«ç…§ï¼Œçº¯å‡€å¯åŠ¨"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          echo "âœ… WebDAVåˆå§‹åŒ–å®Œæˆ"

      - name: 6-æ¢å¤å¿«ç…§æ•°æ®
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== 6-æ¢å¤å†å²å¿«ç…§æ•°æ® ====="
          
          # åœæ­¢æœåŠ¡
          sudo systemctl stop casaos docker containerd 2>/dev/null || true
          sleep 3
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" 2>/dev/null || true
          done
          
          # ä¸‹è½½å¹¶è§£å‹å¿«ç…§ï¼ˆä¿®å¤å‚æ•°è§£æé—®é¢˜ï¼‰
          echo "æ­£åœ¨ä¸‹è½½å¹¶è§£å‹å¿«ç…§: $LATEST_SNAPSHOT"
          
          # æ–¹æ³•1ï¼šç›´æ¥æµå¼è§£å‹ï¼ˆæ¨èï¼‰
          sudo rclone cat mywebdav:"$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" --config /root/.rclone.conf 2>/dev/null | \
            sudo zstd -d -T4 2>/dev/null | \
            sudo tar -xf - -C / --overwrite --preserve-permissions 2>/dev/null
          
          # æ–¹æ³•2ï¼šå…ˆä¸‹è½½åè§£å‹ï¼ˆå¤‡ç”¨ï¼Œæ›´ç¨³å®šï¼‰
          # DOWNLOAD_PATH="/tmp/snapshot.tar.zst"
          # sudo rclone copy mywebdav:"$WEBDAV_SNAPSHOT_DIR/$LATEST_SNAPSHOT" /tmp --config /root/.rclone.conf
          # sudo zstd -d -T4 "$DOWNLOAD_PATH" -o "/tmp/snapshot.tar"
          # sudo tar -xf "/tmp/snapshot.tar" -C / --overwrite --preserve-permissions
          # sudo rm -f "/tmp/snapshot.tar" "$DOWNLOAD_PATH"
          
          # æƒé™æ ¡æ­£
          echo "æ­£åœ¨æ ¡æ­£æƒé™..."
          sudo chown -R root:root /etc/casaos /var/lib/casaos /root/.config 2>/dev/null || true
          sudo chmod -R 755 /etc/casaos /DATA 2>/dev/null || true
          sudo chmod -R 700 /var/lib/casaos 2>/dev/null || true
          
          echo "âœ… å¿«ç…§æ¢å¤å®Œæˆ"

      - name: 7-å¯åŠ¨æ ¸å¿ƒæœåŠ¡
        run: |
          set -e
          echo "===== 7-å¯åŠ¨æ ¸å¿ƒæœåŠ¡ ====="
          
          # ç¡®ä¿docker socketå¯ç”¨
          sudo rm -f /var/run/docker.sock 2>/dev/null || true
          sudo systemctl daemon-reload
          
          # å¯åŠ¨docker
          sudo systemctl enable --now docker containerd
          sleep 5
          
          # æ£€æŸ¥dockerçŠ¶æ€
          if ! sudo docker info >/dev/null 2>&1; then
            echo "âŒ Dockerå¯åŠ¨å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
            sudo systemctl restart docker
            sleep 3
          fi
          
          # å¯åŠ¨CasaOS
          sudo systemctl enable --now casaos
          sleep 5
          
          # æœåŠ¡å¥åº·æ£€æŸ¥
          if ! systemctl is-active --quiet docker; then
            echo "âŒ DockeræœåŠ¡æœªè¿è¡Œ"
            exit 1
          fi
          
          if ! systemctl is-active --quiet casaos; then
            echo "âš ï¸ CasaOSæœåŠ¡æœªè¿è¡Œï¼Œå°è¯•é‡å¯..."
            sudo systemctl restart casaos
            sleep 3
          fi
          
          echo "âœ… æ ¸å¿ƒæœåŠ¡å¯åŠ¨å®Œæˆ"
          echo "ğŸŒ CasaOSè®¿é—®åœ°å€ï¼šhttp://$(curl -s ifconfig.me):80"

      - name: 8-Tailscaleç»„ç½‘
        run: |
          set -e
          echo "===== 8-Tailscaleç»„ç½‘ ====="
          
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscaleæœªé…ç½®ï¼Œè·³è¿‡"
            exit 0
          fi
          
          # å®‰è£…Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y
          sudo apt install -y tailscale
          
          # å¯åŠ¨å¹¶åŠ å…¥ç½‘ç»œ
          sudo systemctl enable --now tailscaled
          sleep 2
          
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="casaos-$(hostname | cut -c1-8)" --accept-routes --accept-dns
          
          # è·å–IP
          sleep 3
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "æœªè·å–")
          echo "âœ… Tailscaleç»„ç½‘å®Œæˆ"
          echo "ğŸ“¡ å†…ç½‘IPï¼š$TAILSCALE_IP"

      - name: 9-ç­‰å¾…æœåŠ¡ç¨³å®š
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 9-ç­‰å¾…æœåŠ¡ç¨³å®šè¿è¡Œ ====="
          
          START_TIME=$(date +%s)
          ELAPSED=$(( $(date +%s) - START_TIME ))
          TARGET_SECONDS=$(( TARGET_RUN_MINUTES * 60 ))
          
          if [ $ELAPSED -lt $TARGET_SECONDS ]; then
            REMAINING=$(( TARGET_SECONDS - ELAPSED ))
            echo "ç­‰å¾… ${REMAINING} ç§’ä½¿æœåŠ¡ç¨³å®š..."
            sleep $REMAINING
          fi
          
          echo "âœ… æœåŠ¡å·²ç¨³å®šè¿è¡Œ"

      - name: 10-åœæ­¢æœåŠ¡å‡†å¤‡å¤‡ä»½
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 10-åœæ­¢æœåŠ¡å‡†å¤‡å¤‡ä»½ ====="
          
          # ä¼˜é›…åœæ­¢æœåŠ¡
          sudo systemctl stop casaos 2>/dev/null || true
          sleep 2
          sudo systemctl stop docker 2>/dev/null || true
          sleep 3
          
          # ç¡®ä¿è¿›ç¨‹åœæ­¢
          sudo pkill -9 -f "casaos" 2>/dev/null || true
          sudo pkill -9 -f "docker" 2>/dev/null || true
          
          # æ¸…ç†é”æ–‡ä»¶
          sudo rm -f /var/run/docker.pid /var/run/docker.sock /var/run/containerd/containerd.pid 2>/dev/null || true
          
          # ç­‰å¾…æ–‡ä»¶é‡Šæ”¾
          sync
          sleep 5
          
          echo "âœ… æœåŠ¡å·²å®Œå…¨åœæ­¢ï¼Œå¯å®‰å…¨å¤‡ä»½"

      - name: 11-åˆ›å»ºå¿«ç…§å¤‡ä»½
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        id: create_backup
        run: |
          set -e
          echo "===== 11-åˆ›å»ºé«˜å‹ç¼©ç‡å¿«ç…§ ====="
          
          # ç”Ÿæˆå¿«ç…§åç§°
          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.zst"
          SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
          
          echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" >> "$GITHUB_ENV"
          echo "SNAPSHOT_PATH=$SNAPSHOT_PATH" >> "$GITHUB_ENV"
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          TMP_FREE_GB=$(df -BG /tmp | awk 'NR==2 {gsub("G","",$4); print $4}')
          if [ "$TMP_FREE_GB" -lt 10 ]; then
            echo "âŒ /tmpç©ºé—´ä¸è¶³10Gï¼Œå½“å‰ä»…å‰©${TMP_FREE_GB}G"
            exit 1
          fi
          
          # å®šä¹‰æ’é™¤è§„åˆ™ï¼ˆé¿å…å‚æ•°è§£æé—®é¢˜ï¼‰
          create_exclude_list() {
            cat <<'EOF'
*.log
*.logs
*.tmp
*.temp
*.cache
*.pid
*.lock
*.swp
*.bak
*.old
/var/lib/docker/tmp
/var/lib/docker/containers/*/*.log
/var/lib/docker/overlay2/*/tmp
/var/lib/docker/buildkit
/var/lib/docker/image/*/layerdb/cache
/var/lib/docker/volumes/*/_data/tmp
/var/lib/docker/volumes/*/_data/cache
/DATA/tmp
/DATA/cache
/DATA/æ—¥å¿—
/DATA/.DS_Store
/root/.cache
/root/.local/share/Trash
/root/.npm
/root/.yarn
/var/tmp/*
/var/log/*
/var/run/*
/var/spool/*
EOF
          }
          
          # åˆ›å»ºæ‰“åŒ…å‡½æ•°
          pack_snapshot() {
            echo "å¼€å§‹æ‰“åŒ…æ•°æ®..."
            
            # åˆ›å»ºæ’é™¤æ–‡ä»¶
            EXCLUDE_FILE="/tmp/exclude.list"
            create_exclude_list > "$EXCLUDE_FILE"
            
            # ä½¿ç”¨tarçš„--exclude-fromé€‰é¡¹ï¼Œé¿å…å‘½ä»¤è¡Œå‚æ•°è¿‡é•¿
            if sudo tar -c \
              --one-file-system \
              --exclude-from="$EXCLUDE_FILE" \
              $PERSONAL_DATA_DIRS 2>/dev/null | \
              sudo zstd -19 -T4 -o "$SNAPSHOT_PATH" 2>/dev/null; then
              
              # éªŒè¯æ–‡ä»¶
              if [ -f "$SNAPSHOT_PATH" ] && sudo zstd -t "$SNAPSHOT_PATH" 2>/dev/null; then
                SNAPSHOT_SIZE=$(sudo du -h "$SNAPSHOT_PATH" | cut -f1)
                echo "âœ… å¿«ç…§åˆ›å»ºæˆåŠŸ: $SNAPSHOT_NAME ($SNAPSHOT_SIZE)"
                rm -f "$EXCLUDE_FILE"
                return 0
              fi
            fi
            
            rm -f "$EXCLUDE_FILE" "$SNAPSHOT_PATH" 2>/dev/null
            return 1
          }
          
          # å°è¯•æ‰“åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰
          ATTEMPT=1
          while [ $ATTEMPT -le $((MAX_RETRY_COUNT + 1)) ]; do
            echo "æ‰“åŒ…å°è¯• #$ATTEMPT"
            if pack_snapshot; then
              echo "backup_created=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            
            if [ $ATTEMPT -lt $((MAX_RETRY_COUNT + 1)) ]; then
              echo "âš ï¸ æ‰“åŒ…å¤±è´¥ï¼Œ${BACKUP_RETRY_INTERVAL}ç§’åé‡è¯•..."
              sleep $BACKUP_RETRY_INTERVAL
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "âŒ æ‰“åŒ…å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
          exit 1

      - name: 12-ä¸Šä¼ å¿«ç…§åˆ°WebDAV
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && steps.create_backup.outputs.backup_created == 'true' }}
        id: upload_backup
        run: |
          set -e
          echo "===== 12-ä¸Šä¼ å¿«ç…§åˆ°WebDAV ====="
          
          upload_snapshot() {
            echo "ä¸Šä¼ å¿«ç…§: $SNAPSHOT_NAME"
            
            # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
            FILE_SIZE=$(sudo du -h "$SNAPSHOT_PATH" | cut -f1)
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE"
            
            # ä½¿ç”¨rcloneä¸Šä¼ 
            if sudo rclone copy "$SNAPSHOT_PATH" \
              "mywebdav:$WEBDAV_SNAPSHOT_DIR/" \
              --config /root/.rclone.conf \
              --progress \
              --transfers 4 \
              --checkers 8 \
              --retries 3 \
              --low-level-retries 10 \
              --stats-one-line \
              --stats 5s; then
              
              # éªŒè¯ä¸Šä¼ 
              if sudo rclone lsf "mywebdav:$WEBDAV_SNAPSHOT_DIR/$SNAPSHOT_NAME" --config /root/.rclone.conf >/dev/null 2>&1; then
                echo "âœ… ä¸Šä¼ éªŒè¯æˆåŠŸ"
                return 0
              fi
            fi
            return 1
          }
          
          # å°è¯•ä¸Šä¼ ï¼ˆå¸¦é‡è¯•ï¼‰
          ATTEMPT=1
          while [ $ATTEMPT -le $((MAX_RETRY_COUNT + 1)) ]; do
            echo "ä¸Šä¼ å°è¯• #$ATTEMPT"
            if upload_snapshot; then
              # æ¸…ç†æœ¬åœ°æ–‡ä»¶
              sudo rm -f "$SNAPSHOT_PATH"
              echo "upload_success=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            
            if [ $ATTEMPT -lt $((MAX_RETRY_COUNT + 1)) ]; then
              echo "âš ï¸ ä¸Šä¼ å¤±è´¥ï¼Œ${BACKUP_RETRY_INTERVAL}ç§’åé‡è¯•..."
              sleep $BACKUP_RETRY_INTERVAL
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
          # æ¸…ç†å¤±è´¥çš„æœ¬åœ°æ–‡ä»¶
          sudo rm -f "$SNAPSHOT_PATH" 2>/dev/null || true
          exit 1

      - name: 13-æ¸…ç†æ—§å¤‡ä»½å’Œè§¦å‘ç»­è·‘
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && steps.upload_backup.outputs.upload_success == 'true' }}
        run: |
          set -e
          echo "===== 13-å¤‡ä»½åå¤„ç† ====="
          
          # è·å–æ‰€æœ‰å¤‡ä»½åˆ—è¡¨
          BACKUP_LIST=$(sudo rclone lsf "mywebdav:$WEBDAV_SNAPSHOT_DIR" --config /root/.rclone.conf 2>/dev/null | \
            grep -E "^casaos-full-snapshot.*\.tar\.zst$" | \
            sort -r)
          
          # è®¡ç®—å¤‡ä»½æ•°é‡
          BACKUP_COUNT=$(echo "$BACKUP_LIST" | wc -l)
          echo "å½“å‰å¤‡ä»½æ•°é‡: $BACKUP_COUNT (ä¿ç•™æœ€æ–° $KEEP_BACKUPS ä»½)"
          
          # æ¸…ç†æ—§å¤‡ä»½
          if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ]; then
            echo "æ¸…ç†æ—§å¤‡ä»½:"
            echo "$BACKUP_LIST" | tail -n +$((KEEP_BACKUPS + 1)) | while read -r backup; do
              echo "åˆ é™¤: $backup"
              sudo rclone delete "mywebdav:$WEBDAV_SNAPSHOT_DIR/$backup" --config /root/.rclone.conf 2>/dev/null
            done
            echo "âœ… æ—§å¤‡ä»½æ¸…ç†å®Œæˆ"
          else
            echo "âœ… å¤‡ä»½æ•°é‡æœªè¶…è¿‡é™åˆ¶ï¼Œæ— éœ€æ¸…ç†"
          fi
          
          # è§¦å‘è‡ªåŠ¨ç»­è·‘
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            echo "è§¦å‘è‡ªåŠ¨ç»­è·‘..."
            if curl -s -f -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/dispatches" \
              -d '{"event_type": "renew_casaos_snapshot"}'; then
              echo "âœ… è‡ªåŠ¨ç»­è·‘è§¦å‘æˆåŠŸ"
            else
              echo "âš ï¸ è‡ªåŠ¨ç»­è·‘è§¦å‘å¤±è´¥"
            fi
          fi

      - name: 14-æœ€ç»ˆæ¸…ç†
        if: always()
        run: |
          echo "===== 14-æœ€ç»ˆæ¸…ç† ====="
          
          # æ¸…ç†æ•æ„Ÿæ–‡ä»¶
          sudo rm -f /root/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          
          # æ¸…ç†APTç¼“å­˜
          sudo apt clean -y
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "ğŸ‰ CasaOSéƒ¨ç½²æµç¨‹å®Œæˆ"
          
          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          echo "æœåŠ¡çŠ¶æ€:"
          sudo systemctl is-active docker casaos tailscaled 2>/dev/null || echo "éƒ¨åˆ†æœåŠ¡æœªè¿è¡Œ"