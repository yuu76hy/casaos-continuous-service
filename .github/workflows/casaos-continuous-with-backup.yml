name: 1Panel-Docker-备份恢复-自动安装兜底

on:
  workflow_dispatch:
  repository_dispatch:
    types: [full_backup_restore_install]

jobs:
  backup_restore_install_job:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_DIR: "/1panel_docker_full_backup"
      # 1Panel + Docker 全量核心备份目录
      FULL_CORE_DIRS: |
        /opt/1panel
        /usr/bin/1panel
        /etc/1panel
        /var/lib/docker
        /etc/docker
        /usr/bin/docker
        /usr/bin/dockerd
        /usr/bin/docker-compose
        /usr/lib/systemd/system/1panel.service
        /usr/lib/systemd/system/docker.service
        /usr/lib/systemd/system/docker.socket
        /DATA
      # 仅过滤临时文件和日志
      EXCLUDE_RULES: >-
        --exclude=/var/lib/docker/containers/*/*.log
        --exclude=/var/lib/docker/overlay2/*/tmp
        --exclude=/var/lib/docker/tmp
        --exclude=/opt/1panel/logs
        --exclude=/opt/1panel/tmp
        --exclude=/DATA/tmp
        --exclude=/DATA/logs
        --exclude=*.cache
        --exclude=*.tmp
      # GitHub Secrets 配置项
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ github.repository }}
      WEBDAV_AVAILABLE: true

    steps:
      - name: 环境初始化（关闭干扰服务）
        run: |
          set -e
          # 关闭 apt 自动更新服务
          sudo systemctl stop apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
          sudo systemctl mask apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
          
          # 安装基础依赖
          sudo apt update -y && sudo apt install -y curl wget jq tar gzip rclone openssl locales ca-certificates gnupg lsb-release
          sudo locale-gen zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          # 配置 sudo 免密权限
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          
          # 创建 DATA 目录
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          echo "✅ 基础环境初始化完成"

      - name: 配置 WebDAV 存储
        run: |
          set -e
          # 检查 WebDAV 凭证
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "❌ 缺少 WebDAV 配置凭证"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # 配置 rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" vendor="generic" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          
          # 验证 WebDAV 连接
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "❌ WebDAV 连接失败"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # 创建远程备份目录
          rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf
          
          # 查找最新全量快照
          LATEST_SNAPSHOT=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep "full-backup-.*.tar.gz" | awk '{print $2}' | sort -r | head -n1)
          if [ -n "$LATEST_SNAPSHOT" ]; then
            echo "✅ 找到最新全量快照：$LATEST_SNAPSHOT"
            echo "LATEST_SNAPSHOT=${LATEST_SNAPSHOT}" >> "$GITHUB_ENV"
          else
            echo "⚠️ 未找到历史全量快照，将执行全新安装"
          fi

      - name: 全量恢复 1Panel + Docker（有快照时执行）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          echo "===== 开始全量恢复 1Panel + Docker ====="
          
          # 停止所有相关服务
          sudo systemctl stop 1panel docker docker.socket 2>/dev/null || true
          sudo pkill -9 1panel docker dockerd 2>/dev/null || true
          sync && sleep 5
          
          # 解压快照到根目录，保留权限
          rclone cat mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions --absolute-names --warning=no-all
          
          # 修复文件权限
          sudo chmod +x /usr/bin/1panel /usr/bin/docker /usr/bin/dockerd /usr/bin/docker-compose 2>/dev/null || true
          sudo chown -R root:root /opt/1panel /etc/1panel /var/lib/docker /etc/docker 2>/dev/null || true
          
          # 重新加载 systemd
          sudo systemctl daemon-reload
          
          # 启动服务
          sudo systemctl enable --now docker.socket docker.service 1panel.service
          sleep 10
          
          # 验证服务状态
          if sudo systemctl is-active --quiet docker.service && sudo systemctl is-active --quiet 1panel.service; then
            echo "✅ 1Panel + Docker 恢复成功！服务已启动"
            echo "DEPLOY_STATUS=restored" >> "$GITHUB_ENV"
            # 删除旧快照（可选）
            rclone delete mywebdav:${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
          else
            echo "❌ 恢复后启动失败，将执行全新安装兜底"
            echo "DEPLOY_STATUS=restore_failed" >> "$GITHUB_ENV"
          fi

      - name: 全新安装 Docker（恢复失败/无快照时执行）
        if: ${{ env.DEPLOY_STATUS != 'restored' }}
        run: |
          set -e
          echo "===== 开始全新安装 Docker ====="
          
          # 卸载旧版本（如有）
          sudo apt remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
          sudo rm -rf /var/lib/docker /etc/docker 2>/dev/null || true
          
          # 配置 Docker 源
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          # 安装 Docker 最新稳定版
          sudo apt update -y
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          
          # 配置权限
          sudo usermod -aG docker runner
          sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
          
          # 启动 Docker
          sudo systemctl enable --now docker.socket docker.service
          sleep 5
          
          if sudo systemctl is-active --quiet docker.service; then
            echo "✅ Docker 全新安装成功"
          else
            echo "❌ Docker 安装失败"
            exit 1
          fi

      - name: 全新安装 1Panel（恢复失败/无快照时执行）
        if: ${{ env.DEPLOY_STATUS != 'restored' }}
        run: |
          set -e
          echo "===== 开始全新安装 1Panel ====="
          
          # 确保 Docker 已运行
          if ! sudo systemctl is-active --quiet docker.service; then
            echo "❌ Docker 未运行，无法安装 1Panel"
            exit 1
          fi
          
          # 安装 1Panel
          curl -fsSL https://resource.fit2cloud.com/1panel/package/quick_start.sh | sudo bash - || {
            echo "❌ 1Panel 安装失败，查看日志"
            cat /tmp/1panel-install.log 2>/dev/null || true
            exit 1
          }
          
          # 启动 1Panel
          sleep 5
          sudo systemctl enable --now 1panel.service
          sleep 5
          
          if sudo systemctl is-active --quiet 1panel.service; then
            echo "✅ 1Panel 全新安装成功"
            echo "DEPLOY_STATUS=installed" >> "$GITHUB_ENV"
          else
            echo "❌ 1Panel 启动失败"
            sudo 1panel repair || true
          fi

      - name: 全量备份（恢复/安装成功后执行）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && (env.DEPLOY_STATUS == 'restored' || env.DEPLOY_STATUS == 'installed') }}
        run: |
          set -e
          echo "===== 开始全量备份 1Panel + Docker ====="
          
          # 停止服务确保数据一致性
          sudo systemctl stop 1panel docker docker.socket 2>/dev/null || true
          sudo pkill -9 1panel docker dockerd 2>/dev/null || true
          sync && sleep 5
          
          # 生成快照名称
          SNAPSHOT_NAME="full-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
          TMP_SNAPSHOT="/tmp/${SNAPSHOT_NAME}"
          
          # 打包核心目录
          sudo tar -czf "${TMP_SNAPSHOT}" --absolute-names --preserve-permissions --warning=no-all $EXCLUDE_RULES $FULL_CORE_DIRS
          
          # 校验快照
          if [ -f "${TMP_SNAPSHOT}" ] && [ $(stat -c%s "${TMP_SNAPSHOT}") -gt 1024 ]; then
            SNAPSHOT_SIZE=$(du -sh ${TMP_SNAPSHOT} | awk '{print $1}')
            echo "✅ 全量快照创建成功，大小：${SNAPSHOT_SIZE}"
            
            # 上传到 WebDAV
            if rclone copy "${TMP_SNAPSHOT}" mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf; then
              echo "✅ 快照已上传至 WebDAV: ${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}"
            fi
          fi
          
          # 重启服务
          sudo systemctl enable --now docker.socket docker.service 1panel.service
          sleep 5
          
          # 清理临时文件
          rm -f "${TMP_SNAPSHOT}"

      - name: 环境清理（始终执行）
        if: ${{ always() }}
        run: |
          set -e
          # 解除 apt 服务 mask
          sudo systemctl unmask apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
          # 删除临时配置
          sudo rm -f /etc/sudoers.d/runner /home/runner/.rclone.conf
          echo "✅ 工作流执行完毕，环境清理完成"
