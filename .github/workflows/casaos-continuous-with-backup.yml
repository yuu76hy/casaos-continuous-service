name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      CURRENT_WORKFLOW_NAME: "CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰"
      CURRENT_WORKFLOW_FILE: "casaos-continuous-with-backup.yml"
      # æ€»è¿è¡Œè¶…æ—¶ï¼ˆä¸job timeoutä¿æŒä¸€è‡´ï¼‰
      TOTAL_TIMEOUT_MINS: 60

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæµ·å¤–æœåŠ¡å™¨é€‚é…+æ–‡ä»¶å®¹é”™ï¼‰
        run: |
          set -e
          echo "===== ç³»ç»Ÿå¿«é€Ÿåˆå§‹åŒ–ï¼ˆæµ·å¤–æºï¼‰ ====="
          # æµ·å¤–æœåŠ¡å™¨ä½¿ç”¨Ubuntuå®˜æ–¹æº
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # ä¿®å¤ï¼šæ£€æŸ¥å¹¶åˆ›å»ºman-dbé…ç½®æ–‡ä»¶
          if [ ! -f /etc/apt/apt.conf.d/00aptitude ]; then
            sudo touch /etc/apt/apt.conf.d/00aptitude
            echo 'man-db/auto-update boolean false' | sudo tee -a /etc/apt/apt.conf.d/00aptitude >/dev/null
          else
            sudo sed -i 's/^man-db\/auto-update.*/man-db\/auto-update boolean false/' /etc/apt/apt.conf.d/00aptitude
          fi
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: 2-å¼ºåˆ¶å…³é—­ä»“åº“æ‰€æœ‰å…¶ä»–å·¥ä½œæµï¼ˆä»…ä¿ç•™å½“å‰ï¼‰
        run: |
          set -e
          echo "===== å¼ºåˆ¶å…³é—­ä»“åº“æ‰€æœ‰å…¶ä»–å·¥ä½œæµ ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ] || [ -z "$CURRENT_WORKFLOW_FILE" ]; then
            echo "âš ï¸ ç¼ºå°‘USER_PAT/REPO/å½“å‰å·¥ä½œæµæ–‡ä»¶åé…ç½®ï¼Œè·³è¿‡å…³é—­å…¶ä»–å·¥ä½œæµ"
            exit 0
          fi

          echo "ğŸ“Œ å½“å‰ä¿ç•™çš„å·¥ä½œæµï¼šæ–‡ä»¶=$CURRENT_WORKFLOW_FILE | åç§°=$CURRENT_WORKFLOW_NAME"

          # è·å–ä»“åº“å†…æ‰€æœ‰å·¥ä½œæµ
          ALL_WORKFLOWS=$(curl -s -H "Authorization: token $USER_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/workflows" | \
            jq -r '.workflows[] | select(.path != null) | "\(.id)|\(.name)|\(.path)|\(.state)"')

          echo "ğŸ“Œ ä»“åº“å†…æ‰€æœ‰å·¥ä½œæµï¼š"
          echo "$ALL_WORKFLOWS"

          # ç¦ç”¨éå½“å‰å·¥ä½œæµ
          while IFS="|" read -r WORKFLOW_ID WORKFLOW_NAME WORKFLOW_FILE WORKFLOW_STATE; do
            if [ "$WORKFLOW_FILE" = ".github/workflows/$CURRENT_WORKFLOW_FILE" ]; then
              # ç¡®ä¿å½“å‰å·¥ä½œæµå¯ç”¨
              if [ "$WORKFLOW_STATE" != "active" ]; then
                curl -s -X PUT -H "Authorization: token $USER_PAT" \
                  "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/enable" >/dev/null
                echo "âœ… å·²å¯ç”¨å½“å‰å·¥ä½œæµï¼š$WORKFLOW_NAME"
              else
                echo "â„¹ï¸ è·³è¿‡å½“å‰å·¥ä½œæµï¼ˆå·²å¯ç”¨ï¼‰ï¼š$WORKFLOW_NAME"
              fi
              continue
            fi
            # ç¦ç”¨å…¶ä»–å·¥ä½œæµ
            echo "âš ï¸ æ­£åœ¨ç¦ç”¨å·¥ä½œæµï¼š$WORKFLOW_NAMEï¼ˆæ–‡ä»¶ï¼š$WORKFLOW_FILEï¼‰"
            curl -s -X PUT -H "Authorization: token $USER_PAT" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/disable" >/dev/null && echo "âœ… å·²ç¦ç”¨" || echo "âš ï¸ ç¦ç”¨å¤±è´¥"
          done <<< "$ALL_WORKFLOWS"

          # ç»ˆæ­¢å…¶ä»–è¿è¡Œä¸­å®ä¾‹
          RUNNING_WORKFLOWS=$(curl -s -H "Authorization: token $USER_PAT" \
            "https://api.github.com/repos/$REPO/actions/runs?status=in_progress" | \
            jq -r '.workflow_runs[] | select(.workflow_name != "'"$CURRENT_WORKFLOW_NAME"'") | "\(.id)|\(.workflow_name)"')
          if [ -n "$RUNNING_WORKFLOWS" ]; then
            while IFS="|" read -r RUN_ID WORKFLOW_NAME; do
              echo "âš ï¸ ç»ˆæ­¢è¿è¡Œä¸­å·¥ä½œæµï¼š$WORKFLOW_NAMEï¼ˆRun IDï¼š$RUN_IDï¼‰"
              curl -s -X POST -H "Authorization: token $USER_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/cancel" >/dev/null
            done <<< "$RUNNING_WORKFLOWS"
          else
            echo "âœ… æ— å…¶ä»–è¿è¡Œä¸­å·¥ä½œæµ"
          fi

          echo "âœ… ä»…å½“å‰å·¥ä½œæµå¯æ‰§è¡Œ"

      - name: 3-å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆæµ·å¤–ç‰ˆ+æƒé™ä¼˜åŒ–ï¼‰
        run: |
          set -e
          echo "===== å®‰è£…Dockerï¼ˆæµ·å¤–ç‰ˆï¼‰ ====="
          # å¸è½½æ—§ç‰ˆæœ¬+æ¸…ç†æ®‹ç•™
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo rm -rf /var/lib/docker /var/lib/containerd 2>/dev/null || true
          # å®‰è£…æ ¸å¿ƒç»„ä»¶
          install_docker() {
            curl -fsSL https://get.docker.com | sudo bash -s docker --install-options "--no-install-recommends"
            return $?
          }
          # é‡è¯•æœºåˆ¶
          if ! install_docker; then
            echo "âš ï¸ é¦–æ¬¡å®‰è£…å¤±è´¥ï¼Œ10ç§’åé‡è¯•..." && sleep 10
            install_docker || {
              echo "âš ï¸ é‡è¯•å¤±è´¥ï¼Œä½¿ç”¨aptå…œåº•å®‰è£…"
              sudo apt update -y
              sudo DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends docker-ce docker-ce-cli containerd.io docker-compose-plugin
            }
          fi
          # å¯åŠ¨æœåŠ¡+é…ç½®æƒé™
          sudo systemctl enable --now docker containerd && sleep 2
          sudo usermod -aG docker runner
          docker --version && docker compose version
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      - name: 4-åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå®‰å…¨ä¼˜åŒ–ï¼‰
        run: |
          set -e
          echo "===== åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ· ====="
          USER_NAME="roots"
          # é¿å…é‡å¤åˆ›å»º
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          # è®¾ç½®å¯†ç ï¼ˆä¼˜å…ˆç”¨é…ç½®ï¼Œå¦åˆ™éšæœºç”Ÿæˆï¼‰
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ éšæœºå¯†ç ï¼š$RANDOM_PASS"
          fi
          # é…ç½®å…å¯†sudoï¼ˆé™åˆ¶é£é™©ï¼‰
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 5-WebDAVé…ç½®+å¿«ç…§æ£€æµ‹ï¼ˆè¶…æ—¶ä¼˜åŒ–ï¼‰
        run: |
          set -e
          echo "===== WebDAVé…ç½® ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # é…ç½®rcloneï¼ˆå¢åŠ è¶…æ—¶ï¼‰
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          # åˆ›å»ºè¿œç¨‹ç›®å½•ï¼ˆè¶…æ—¶30ç§’ï¼‰
          if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf --timeout 30s; then
            echo "âŒ WebDAVä¸å¯è¾¾ï¼Œè·³è¿‡å¤‡ä»½"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # æ£€æµ‹æœ€æ–°å¿«ç…§
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… é¦–æ¬¡éƒ¨ç½²æ— å¿«ç…§"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: 6-çº¯å‡€å®‰è£…CasaOSï¼ˆä»…ç¨‹åºï¼‰
        run: |
          set -e
          echo "===== å®‰è£…CasaOS ====="
          # æ¸…ç†æ—§æœåŠ¡
          sudo systemctl stop casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          # å®‰è£…å®˜æ–¹ç‰ˆæœ¬
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOSå®‰è£…å®Œæˆ"

      - name: 7-æ¢å¤ä¸ªäººæ•°æ®ï¼ˆé˜²é”™ä¹±ä¼˜åŒ–ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ¢å¤æ•°æ® ====="
          # åœæ­¢æœåŠ¡é¿å…å†²çª
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd 2>/dev/null || true
          # æ¢å¤æ•°æ®ï¼ˆä»…æŒ‡å®šç›®å½•ï¼‰
          echo "ğŸ“Œ æ¢å¤ç›®å½•ï¼š$PERSONAL_DATA_DIRS"
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite $PERSONAL_DATA_DIRS
          # æ ¡æ­£æƒé™
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          # åˆ é™¤å·²æ¢å¤çš„å¿«ç…§
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆ"

      - name: 8-å¯åŠ¨æœåŠ¡+æƒé™æ ¡æ­£
        run: |
          set -e
          echo "===== å¯åŠ¨æœåŠ¡ ====="
          # é¢„åˆ›å»ºç›®å½•
          sudo mkdir -p /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          # æ ¡æ­£æƒé™
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          # å¯åŠ¨æœåŠ¡
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          # æ£€æµ‹ç«¯å£
          if sudo fuser 80/tcp >/dev/null 2>&1; then
            echo "âœ… CasaOSå·²å¯åŠ¨ï¼ˆç«¯å£80ï¼‰"
          else
            echo "âš ï¸ CasaOSå¯åŠ¨å¤±è´¥ï¼Œå¼ºåˆ¶é‡å¯"
            sudo systemctl restart casaos
          fi

      - name: 9-Tailscaleè¿œç¨‹ç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then exit 0; fi
          echo "===== é…ç½®Tailscale ====="
          # å®‰è£…Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          # å¯åŠ¨å¹¶ç»„ç½‘
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)"
          echo "âœ… Tailscale IPï¼š$(sudo tailscale ip -4 2>/dev/null || echo 'æœªè·å–')"

      - name: 10-ä¸ªäººæ•°æ®å¤‡ä»½+å‰©ä½™æ—¶é—´æ˜¾ç¤ºï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ•°æ®å¤‡ä»½ ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # æ¸…ç†æ—§å¤‡ä»½
          cleanup_old_backups(){
            echo "ğŸ“Œ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™${KEEP_BACKUPS}ä»½ï¼‰"
            BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
            BACKUP_COUNT=$(echo "$BACKUPS" | wc -l)
            if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ]; then
              DELETE_LIST=$(echo "$BACKUPS" | tail -n $((BACKUP_COUNT - KEEP_BACKUPS)))
              for FILE in $DELETE_LIST; do
                rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$FILE --config /home/runner/.rclone.conf && echo "âœ… åˆ é™¤æ—§å¤‡ä»½ï¼š$FILE" || echo "âš ï¸ åˆ é™¤å¤±è´¥ï¼š$FILE"
              done
            fi
            echo "âœ… å½“å‰å¤‡ä»½æ•°ï¼š$(echo "$BACKUPS" | wc -l)"
          }

          # å®Œæ•´å¤‡ä»½ï¼ˆæ˜¾ç¤ºè¿›åº¦+å‰©ä½™æ—¶é—´ï¼‰
          full_backup(){
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
            echo "ğŸ“Œ å¼€å§‹æ‰“åŒ…æ•°æ®ï¼ˆæ’é™¤åƒåœ¾æ–‡ä»¶ï¼‰"
            
            # æ‰“åŒ…å¹¶æ˜¾ç¤ºè¿›åº¦
            sudo tar -czPf $SNAPSHOT_PATH --exclude=${EXCLUDE_RULES} $PERSONAL_DATA_DIRS --checkpoint=1000 --checkpoint-action=echo="å·²æ‰“åŒ… %u æ–‡ä»¶"
            echo "âœ… æœ¬åœ°æ‰“åŒ…å®Œæˆï¼ˆå¤§å°ï¼š$(du -sh $SNAPSHOT_PATH | awk '{print $1}')ï¼‰"
            
            # ä¸Šä¼ å¹¶æ˜¾ç¤ºå‰©ä½™æ—¶é—´
            echo "ğŸ“Œ å¼€å§‹ä¸Šä¼ è‡³WebDAV..."
            UPLOAD_START=$(date +%s)
            if rclone copy $SNAPSHOT_PATH mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --transfers 4 --progress; then
              UPLOAD_END=$(date +%s)
              UPLOAD_DUR=$((UPLOAD_END - UPLOAD_START))
              echo "âœ… ä¸Šä¼ å®Œæˆï¼ˆè€—æ—¶ï¼š$((UPLOAD_DUR/60))åˆ†$((UPLOAD_DUR%60))ç§’ï¼‰"
              sudo rm -f $SNAPSHOT_PATH
              cleanup_old_backups
              return 0
            else
              echo "âŒ ä¸Šä¼ å¤±è´¥"
              sudo rm -f $SNAPSHOT_PATH
              return 1
            fi
          }

          # è‡ªåŠ¨ç»­è·‘
          trigger_renew(){
            if [ -z "$USER_PAT" ] || [ -z "$REPO" ]; then
              echo "âš ï¸ ç»­è·‘é…ç½®ç¼ºå¤±ï¼Œè·³è¿‡"
              return 0
            fi
            curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}' && echo "âœ… ç»­è·‘å·²è§¦å‘" || echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥"
            return 0
          }

          # ä¸»å¾ªç¯ï¼ˆæ˜¾ç¤ºå‰©ä½™æ—¶é—´ï¼‰
          while true; do
            run_mins=$(( ( $(date +%s) - start_time ) / 60 ))
            remaining_mins=$(( TOTAL_TIMEOUT_MINS - run_mins ))
            echo "â° å½“å‰è¿è¡Œï¼š$run_minsåˆ† | å‰©ä½™æ—¶é—´ï¼š$remaining_minsåˆ†"

            # è¿è¡Œ2åˆ†é’Ÿåæ‰§è¡Œå¤‡ä»½
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "ğŸ“Œ å¼€å§‹æ‰§è¡Œå¤‡ä»½..."
              if full_backup; then
                echo "âœ… å¤‡ä»½æˆåŠŸï¼"
                trigger_renew
                RENEW_TRIGGERED=true
              else
                echo "âŒ å¤‡ä»½å¤±è´¥ï¼Œ10åˆ†é’Ÿåé‡è¯•"
                sleep 600
                full_backup && RENEW_TRIGGERED=true || echo "âŒ å¤šæ¬¡å¤‡ä»½å¤±è´¥ï¼Œè·³è¿‡"
              fi
            fi

            # è¶…æ—¶é€€å‡º
            if [ $run_mins -ge $TOTAL_TIMEOUT_MINS ]; then
              echo "âœ… è¾¾åˆ°è¶…æ—¶ä¸Šé™ï¼Œæµç¨‹ç»“æŸ"
              exit 0
            fi
            sleep 60
          done

      - name: 11-æ”¶å°¾æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç† ====="
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "ğŸ‰ å…¨æµç¨‹å®Œæˆï¼"
          echo "âœ… è®¿é—®æœåŠ¡å™¨IPï¼ˆ80ç«¯å£ï¼‰è¿›å…¥CasaOS"
