name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆç»†åˆ†æ­¥éª¤ç‰ˆï½œè¶…ç¨³å¤§æ–‡ä»¶é€‚é…ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 60
      SNAPSHOT_MD5_SUFFIX: ".md5"

    steps:
      # ç³»ç»ŸåŸºç¡€å‡†å¤‡ï¼ˆ3æ­¥ï¼‰
      - name: 1-å®‰è£…ç³»ç»Ÿå¿…å¤‡ä¾èµ–
        run: |
          set -e
          echo "===== æ­¥éª¤1ï¼šå®‰è£…curl/rcloneç­‰å¿…å¤‡å·¥å…· ====="
          sudo apt update -y -qq
          sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… æ­¥éª¤1å®Œæˆï¼šä¾èµ–å®‰è£…å®Œæ¯•"

      - name: 2-æ£€æŸ¥ä¸´æ—¶ç›®å½•ç©ºé—´ï¼ˆâ‰¥5Gï¼‰
        run: |
          set -e
          echo "===== æ­¥éª¤2ï¼šæ£€æŸ¥/tmpä¸´æ—¶ç›®å½•ç©ºé—´ ====="
          TMP_FREE=$(df -h /tmp | grep /tmp | awk '{print $4}' | sed 's/G//')
          if [ "$TMP_FREE" -lt 5 ];then
            echo "âŒ /tmpç›®å½•ä»…å‰©ä½™${TMP_FREE}Gï¼Œéœ€è‡³å°‘5Gç©ºé—´"
            exit 1
          fi
          echo "âœ… æ­¥éª¤2å®Œæˆï¼š/tmpç›®å½•ç©ºé—´å……è¶³ï¼ˆå‰©ä½™${TMP_FREE}Gï¼‰"

      - name: 3-æ¸…ç†æ—§Dockerç›¸å…³ç»„ä»¶
        run: |
          set -e
          echo "===== æ­¥éª¤3ï¼šæ¸…ç†æ—§Docker/containerd ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          echo "âœ… æ­¥éª¤3å®Œæˆï¼šæ—§Dockerç»„ä»¶æ¸…ç†å®Œæ¯•"

      # Dockeréƒ¨ç½²ï¼ˆ3æ­¥ï¼‰
      - name: 4-å®‰è£…Docker+Composeï¼ˆé˜¿é‡Œäº‘é•œåƒï¼‰
        run: |
          set -e
          echo "===== æ­¥éª¤4ï¼šå®‰è£…Docker+Compose ====="
          INSTALL_RETRY=3
          while [ $INSTALL_RETRY -gt 0 ];do
            curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun && break
            INSTALL_RETRY=$((INSTALL_RETRY-1))
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$INSTALL_RETRY"
            sleep 30
          done
          if [ $INSTALL_RETRY -eq 0 ];then
            echo "âŒ Dockerå®‰è£…å¤šæ¬¡å¤±è´¥"
            exit 1
          fi
          docker --version && docker compose version
          echo "âœ… æ­¥éª¤4å®Œæˆï¼šDockerå®‰è£…æˆåŠŸ"

      - name: 5-å¯åŠ¨Docker+containerdæœåŠ¡
        run: |
          set -e
          echo "===== æ­¥éª¤5ï¼šå¯åŠ¨DockeræœåŠ¡å¹¶è®¾å¼€æœºè‡ªå¯ ====="
          sudo systemctl enable --now docker containerd && sleep 2
          sudo systemctl is-active --quiet docker || (echo "âŒ Dockerå¯åŠ¨å¤±è´¥" && exit 1)
          echo "âœ… æ­¥éª¤5å®Œæˆï¼šDockeræœåŠ¡å¯åŠ¨æˆåŠŸ"

      - name: 6-é…ç½®runnerç”¨æˆ·Dockeræƒé™
        run: |
          set -e
          echo "===== æ­¥éª¤6ï¼šç»™runnerç”¨æˆ·æ·»åŠ Dockeræƒé™ ====="
          sudo usermod -aG docker runner
          echo "âœ… æ­¥éª¤6å®Œæˆï¼šDockeræƒé™é…ç½®å®Œæ¯•"

      # ç®¡ç†å‘˜ç”¨æˆ·é…ç½®ï¼ˆ4æ­¥ï¼‰
      - name: 7-åˆ›å»ºrootsç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          echo "===== æ­¥éª¤7ï¼šåˆ›å»ºrootsç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          echo "âœ… æ­¥éª¤7å®Œæˆï¼šrootsç”¨æˆ·åˆ›å»ºæˆåŠŸ"

      - name: 8-é…ç½®rootsç”¨æˆ·å¯†ç 
        run: |
          set -e
          echo "===== æ­¥éª¤8ï¼šé…ç½®rootsç”¨æˆ·å¯†ç  ====="
          USER_NAME="roots"
          if [ -n "$ROOTS_PASSWORD" ];then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
            echo "ğŸ”‘ rootsç”¨æˆ·å¯†ç å·²é…ç½®"
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ rootséšæœºå¯†ç ï¼š$RANDOM_PASS"
          fi
          echo "âœ… æ­¥éª¤8å®Œæˆï¼šå¯†ç é…ç½®å®Œæ¯•"

      - name: 9-é…ç½®rootså…å¯†sudoæƒé™
        run: |
          set -e
          echo "===== æ­¥éª¤9ï¼šé…ç½®rootså…å¯†sudo ====="
          USER_NAME="roots"
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          echo "âœ… æ­¥éª¤9å®Œæˆï¼šå…å¯†sudoé…ç½®å®Œæ¯•"

      - name: 10-é…ç½®rootsç”¨æˆ·Dockeræƒé™
        run: |
          set -e
          echo "===== æ­¥éª¤10ï¼šç»™rootsæ·»åŠ Dockeræƒé™ ====="
          sudo usermod -aG docker roots
          echo "âœ… æ­¥éª¤10å®Œæˆï¼šrootsç”¨æˆ·Dockeræƒé™é…ç½®å®Œæ¯•"

      # WebDAVå¤‡ä»½ç¯å¢ƒå‡†å¤‡ï¼ˆ4æ­¥ï¼‰
      - name: 11-æ ¡éªŒWebDAVå‡­è¯
        run: |
          set -e
          echo "===== æ­¥éª¤11ï¼šæ ¡éªŒWebDAVå‡­è¯ ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œåç»­å¤‡ä»½ç›¸å…³æ­¥éª¤è·³è¿‡"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          else
            echo "âœ… WebDAVå‡­è¯é½å…¨"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
          fi
          echo "âœ… æ­¥éª¤11å®Œæˆï¼šå‡­è¯æ ¡éªŒå®Œæ¯•"

      - name: 12-é…ç½®rclone WebDAVè¿æ¥
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤12ï¼šé…ç½®rclone WebDAV ====="
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          echo "âœ… æ­¥éª¤12å®Œæˆï¼šrcloneé…ç½®å®Œæ¯•"

      - name: 13-åˆ›å»ºWebDAVè¿œç¨‹å¤‡ä»½ç›®å½•
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤13ï¼šåˆ›å»ºè¿œç¨‹å¤‡ä»½ç›®å½• ====="
          MKDIR_RETRY=3
          while [ $MKDIR_RETRY -gt 0 ];do
            rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf && break
            MKDIR_RETRY=$((MKDIR_RETRY-1))
            echo "âš ï¸ åˆ›å»ºå¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$MKDIR_RETRY"
            sleep 30
          done
          if [ $MKDIR_RETRY -eq 0 ];then
            echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "âœ… æ­¥éª¤13å®Œæˆï¼šè¿œç¨‹ç›®å½•åˆ›å»ºå®Œæ¯•"

      - name: 14-æ£€æµ‹WebDAVå†å²å¿«ç…§
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤14ï¼šæ£€æµ‹å†å²å¿«ç…§ ====="
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "LATEST_SNAPSHOT_MD5=${REMOTE_SNAPSHOTS}${SNAPSHOT_MD5_SUFFIX}" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… æ— å†å²å¿«ç…§ï¼Œçº¯å‡€éƒ¨ç½²"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "âœ… æ­¥éª¤14å®Œæˆï¼šå¿«ç…§æ£€æµ‹å®Œæ¯•"

      # CasaOSéƒ¨ç½²ï¼ˆ3æ­¥ï¼‰
      - name: 15-æ¸…ç†æ—§CasaOSæ®‹ç•™
        run: |
          set -e
          echo "===== æ­¥éª¤15ï¼šæ¸…ç†æ—§CasaOSé…ç½® ====="
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          echo "âœ… æ­¥éª¤15å®Œæˆï¼šæ—§CasaOSæ®‹ç•™æ¸…ç†å®Œæ¯•"

      - name: 16-çº¯å‡€å®‰è£…CasaOS
        run: |
          set -e
          echo "===== æ­¥éª¤16ï¼šå®‰è£…CasaOS ====="
          CASAOS_RETRY=2
          while [ $CASAOS_RETRY -gt 0 ];do
            curl -fsSL https://get.casaos.io | sudo bash && break
            CASAOS_RETRY=$((CASAOS_RETRY-1))
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$CASAOS_RETRY"
            sleep 30
          done
          if [ $CASAOS_RETRY -eq 0 ];then
            echo "âŒ CasaOSå®‰è£…å¤šæ¬¡å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ­¥éª¤16å®Œæˆï¼šCasaOSå®‰è£…æˆåŠŸ"

      - name: 17-åœæ­¢CasaOSï¼ˆå¾…æ•°æ®æ¢å¤ï¼‰
        run: |
          set -e
          echo "===== æ­¥éª¤17ï¼šåœæ­¢CasaOSæœåŠ¡ ====="
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… æ­¥éª¤17å®Œæˆï¼šCasaOSå·²åœæ­¢"

      # æ•°æ®æ¢å¤ï¼ˆä»…æœ‰å¿«ç…§æ—¶æ‰§è¡Œï¼Œ6æ­¥ï¼‰
      - name: 18-æ¢å¤å‰å…³åœç›¸å…³è¿›ç¨‹
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤18ï¼šå…³åœè¿›ç¨‹é‡Šæ”¾æ–‡ä»¶ ====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          echo "âœ… æ­¥éª¤18å®Œæˆï¼šè¿›ç¨‹å·²å…³åœ"

      - name: 19-æ£€æŸ¥ç›®æ ‡ç›®å½•ç©ºé—´ï¼ˆâ‰¥5Gï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤19ï¼šæ£€æŸ¥æ ¹ç›®å½•ç©ºé—´ ====="
          TARGET_FREE=$(df -h / | grep / | awk '{print $4}' | sed 's/G//')
          if [ "$TARGET_FREE" -lt 5 ];then
            echo "âŒ æ ¹ç›®å½•ä»…å‰©ä½™${TARGET_FREE}Gï¼Œéœ€è‡³å°‘5Gç©ºé—´"
            exit 1
          fi
          echo "âœ… æ­¥éª¤19å®Œæˆï¼šæ ¹ç›®å½•ç©ºé—´å……è¶³ï¼ˆå‰©ä½™${TARGET_FREE}Gï¼‰"

      - name: 20-ä¸‹è½½å¿«ç…§MD5æ–‡ä»¶
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤20ï¼šä¸‹è½½MD5æ ¡éªŒæ–‡ä»¶ ====="
          rclone copy mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT_MD5} /tmp/ --config /home/runner/.rclone.conf \
            --retries 5 --timeout 1h --contimeout 5m --progress
          echo "âœ… æ­¥éª¤20å®Œæˆï¼šMD5æ–‡ä»¶ä¸‹è½½å®Œæ¯•"

      - name: 21-ä¸‹è½½å¿«ç…§å¹¶æ ¡éªŒMD5
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤21ï¼šä¸‹è½½å¿«ç…§+MD5æ ¡éªŒ ====="
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf \
            --retries 5 --timeout 1h --contimeout 5m --fast-list --chunk-size 100M | \
            tee >(md5sum -c /tmp/${LATEST_SNAPSHOT_MD5}) >/dev/null
          if [ $? -ne 0 ];then
            echo "âŒ MD5æ ¡éªŒå¤±è´¥ï¼Œå¿«ç…§æŸå"
            exit 1
          fi
          echo "âœ… æ­¥éª¤21å®Œæˆï¼šå¿«ç…§ä¸‹è½½+æ ¡éªŒé€šè¿‡"

      - name: 22-è§£å‹æ¢å¤æ ¸å¿ƒæ•°æ®
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤22ï¼šè§£å‹æ¢å¤æ•°æ® ====="
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          echo "âœ… æ­¥éª¤22å®Œæˆï¼šæ•°æ®æ¢å¤å®Œæ¯•"

      - name: 23-æ¢å¤åæ ¡æ­£ç›®å½•æƒé™
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤23ï¼šæ ¡æ­£ç›®å½•æƒé™ ====="
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "âœ… æ­¥éª¤23å®Œæˆï¼šæƒé™æ ¡æ­£å®Œæ¯•"

      # æœåŠ¡å¯åŠ¨ä¸å¥åº·æ£€æµ‹ï¼ˆ6æ­¥ï¼‰
      - name: 24-é‡Šæ”¾80/443ç«¯å£å ç”¨
        run: |
          set -e
          echo "===== æ­¥éª¤24ï¼šé‡Šæ”¾ç«¯å£å ç”¨ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          echo "âœ… æ­¥éª¤24å®Œæˆï¼šç«¯å£å·²é‡Šæ”¾"

      - name: 25-é¢„åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          set -e
          echo "===== æ­¥éª¤25ï¼šåˆ›å»ºå¿…è¦ç›®å½• ====="
          sudo mkdir -p /run/docker 2>/dev/null || true
          if [ "${{ env.HAS_SNAPSHOT }}" = "false" ]; then
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          fi
          echo "âœ… æ­¥éª¤25å®Œæˆï¼šç›®å½•åˆ›å»ºå®Œæ¯•"

      - name: 26-æœ€ç»ˆæ ¡å‡†ç›®å½•æƒé™
        run: |
          set -e
          echo "===== æ­¥éª¤26ï¼šæœ€ç»ˆæƒé™æ ¡å‡† ====="
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          else
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          fi
          echo "âœ… æ­¥éª¤26å®Œæˆï¼šæƒé™æ ¡å‡†å®Œæ¯•"

      - name: 27-é‡å¯Docker+containerdæœåŠ¡
        run: |
          set -e
          echo "===== æ­¥éª¤27ï¼šé‡å¯DockeræœåŠ¡ ====="
          sudo systemctl daemon-reload
          sudo systemctl restart docker containerd && sleep 3
          sudo systemctl is-active --quiet docker || (echo "âŒ Dockerå¯åŠ¨å¤±è´¥" && exit 1)
          echo "âœ… æ­¥éª¤27å®Œæˆï¼šDockeræœåŠ¡é‡å¯æˆåŠŸ"

      - name: 28-DockeræœåŠ¡å¥åº·æ£€æµ‹
        run: |
          set -e
          echo "===== æ­¥éª¤28ï¼šDockerå¥åº·æ£€æµ‹ ====="
          DOCKER_HEALTH_RETRY=3
          while [ $DOCKER_HEALTH_RETRY -gt 0 ];do
            docker ps >/dev/null 2>&1 && break
            DOCKER_HEALTH_RETRY=$((DOCKER_HEALTH_RETRY-1))
            echo "âš ï¸ Dockeræœªå°±ç»ªï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$DOCKER_HEALTH_RETRY"
            sudo systemctl restart docker containerd
            sleep 10
          done
          if [ $DOCKER_HEALTH_RETRY -eq 0 ];then
            echo "âŒ Dockerå¥åº·æ£€æµ‹å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ­¥éª¤28å®Œæˆï¼šDockeræœåŠ¡å¥åº·"

      - name: 29-å¯åŠ¨CasaOSæœåŠ¡+å¥åº·æ£€æµ‹
        run: |
          set -e
          echo "===== æ­¥éª¤29ï¼šå¯åŠ¨CasaOS+å¥åº·æ£€æµ‹ ====="
          sudo systemctl enable --now casaos && sleep 5
          CASAOS_HEALTH_RETRY=3
          while [ $CASAOS_HEALTH_RETRY -gt 0 ];do
            sudo lsof -i:80 | grep LISTEN >/dev/null 2>&1 && break
            CASAOS_HEALTH_RETRY=$((CASAOS_HEALTH_RETRY-1))
            echo "âš ï¸ CasaOSæœªå°±ç»ªï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$CASAOS_HEALTH_RETRY"
            sudo systemctl restart casaos
            sleep 10
          done
          if [ $CASAOS_HEALTH_RETRY -eq 0 ];then
            echo "âŒ CasaOSå¥åº·æ£€æµ‹å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ­¥éª¤29å®Œæˆï¼šCasaOSå¯åŠ¨+å¥åº·æ£€æµ‹é€šè¿‡"
          echo "ğŸ“Œ è®¿é—®åœ°å€ï¼šæœåŠ¡å™¨å…¬ç½‘IP:80"

      # Tailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼Œ3æ­¥ï¼‰
      - name: 30-å®‰è£…Tailscaleå®¢æˆ·ç«¯
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          echo "===== æ­¥éª¤30ï¼šå®‰è£…Tailscale ====="
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          echo "âœ… æ­¥éª¤30å®Œæˆï¼šTailscaleå®‰è£…æˆåŠŸ"

      - name: 31-å¯åŠ¨tailscaledæœåŠ¡
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          echo "===== æ­¥éª¤31ï¼šå¯åŠ¨tailscaledæœåŠ¡ ====="
          sudo systemctl enable --now tailscaled && sleep 2
          sudo systemctl is-active --quiet tailscaled || (echo "âŒ tailscaledå¯åŠ¨å¤±è´¥" && exit 1)
          echo "âœ… æ­¥éª¤31å®Œæˆï¼štailscaledæœåŠ¡å¯åŠ¨æˆåŠŸ"

      - name: 32-Tailscaleç»„ç½‘é…ç½®
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          echo "===== æ­¥éª¤32ï¼šTailscaleç»„ç½‘ ====="
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null)
          echo "âœ… æ­¥éª¤32å®Œæˆï¼šTailscaleç»„ç½‘æˆåŠŸï¼Œå†…ç½‘IPï¼š${TAILSCALE_IP:-æœªè·å–}"

      # å¤‡ä»½æ ¸å¿ƒæµç¨‹ï¼ˆä»…WebDAVå¯ç”¨æ—¶æ‰§è¡Œï¼Œ10æ­¥ï¼‰
      - name: 33-æ¸…ç†æ—§å¤‡ä»½ï¼ˆå¿«ç…§+MD5ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤33ï¼šæ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™2ä»½ï¼‰ ====="
          BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
          BACKUP_COUNT=$(echo "$BACKUPS" | wc -l)
          if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ];then
            DELETE_COUNT=$((BACKUP_COUNT - KEEP_BACKUPS))
            DELETE_LIST=$(echo "$BACKUPS" | tail -n $DELETE_COUNT)
            for FILE in $DELETE_LIST;do
              rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$FILE --config /home/runner/.rclone.conf
              rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${FILE}${SNAPSHOT_MD5_SUFFIX} --config /home/runner/.rclone.conf
              echo "âœ… å·²åˆ æ—§å¤‡ä»½ï¼š$FILE"
            done
          else
            echo "âœ… å½“å‰å¤‡ä»½${BACKUP_COUNT}ä»½ï¼Œæ— éœ€æ¸…ç†"
          fi
          echo "âœ… æ­¥éª¤33å®Œæˆï¼šæ—§å¤‡ä»½æ¸…ç†å®Œæ¯•"

      - name: 34-ç²¾å‡†å»¶æ—¶æ ¡å‡†ï¼ˆæ»¡60åˆ†é’Ÿï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤34ï¼šå»¶æ—¶æ ¡å‡† ====="
          if [ -z "$GITHUB_RUN_STARTED_AT" ];then
            START_TIME_JOB=$(date +%s)
          else
            START_TIME_JOB=$(date -d "$GITHUB_RUN_STARTED_AT" +%s)
          fi
          CURRENT_DURATION=$(( $(date +%s) - START_TIME_JOB ))
          TARGET_DURATION=$(( TARGET_RUN_MINUTES * 60 ))
          WAIT_TIME=$(( TARGET_DURATION - CURRENT_DURATION ))
          if [ $WAIT_TIME -gt 0 ]; then
            echo "å·²è¿è¡Œ$((CURRENT_DURATION/60))åˆ†ï¼Œéœ€å†ç­‰$((WAIT_TIME/60))åˆ†"
            sleep $WAIT_TIME
          else
            echo "å·²è¾¾60åˆ†é’Ÿï¼Œç›´æ¥å¤‡ä»½"
          fi
          echo "âœ… æ­¥éª¤34å®Œæˆï¼šå»¶æ—¶æ ¡å‡†å®Œæ¯•"

      - name: 35-å¤‡ä»½å‰é¢„åœæ­¢CasaOS
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤35ï¼šé¢„åœæ­¢CasaOS ====="
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… æ­¥éª¤35å®Œæˆï¼šCasaOSå·²åœæ­¢"

      - name: 36-å¤‡ä»½å‰å…³åœæ‰€æœ‰ç›¸å…³è¿›ç¨‹
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤36ï¼šå…³åœè¿›ç¨‹+ç¼“å­˜è½ç›˜ ====="
          sudo systemctl stop docker containerd docker.socket 2>/dev/null || true
          sudo pkill -9 casaos docker dockerd containerd runc docker-proxy 2>/dev/null || true
          sudo fuser -k 2375/tcp 2376/tcp 80/tcp 443/tcp /var/lib/docker 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd/*.lock 2>/dev/null || true
          sync && sudo sync && sleep 5
          echo "âœ… æ­¥éª¤36å®Œæˆï¼šè¿›ç¨‹å…³åœ+ç¼“å­˜è½ç›˜"

      - name: 37-æ‰“åŒ…æ ¸å¿ƒæ•°æ®
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤37ï¼šæ‰“åŒ…æ ¸å¿ƒæ•°æ® ====="
          SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
          sudo tar -czPf $SNAPSHOT_PATH $EXCLUDE_RULES --warning=no-file-changed --exclude=*/socket --one-file-system $PERSONAL_DATA_DIRS
          SNAPSHOT_SIZE=$(du -sh $SNAPSHOT_PATH | awk '{print $1}')
          echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" >> "$GITHUB_ENV"
          echo "SNAPSHOT_PATH=$SNAPSHOT_PATH" >> "$GITHUB_ENV"
          echo "âœ… æ­¥éª¤37å®Œæˆï¼šæ‰“åŒ…å®Œæˆï¼Œå¤§å°ï¼š$SNAPSHOT_SIZE"

      - name: 38-ç”Ÿæˆå¿«ç…§MD5å“ˆå¸Œæ–‡ä»¶
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤38ï¼šç”ŸæˆMD5æ–‡ä»¶ ====="
          SNAPSHOT_MD5_PATH="${{ env.SNAPSHOT_PATH }}${{ env.SNAPSHOT_MD5_SUFFIX }}"
          sudo md5sum ${{ env.SNAPSHOT_PATH }} > $SNAPSHOT_MD5_PATH
          echo "SNAPSHOT_MD5_PATH=$SNAPSHOT_MD5_PATH" >> "$GITHUB_ENV"
          echo "âœ… æ­¥éª¤38å®Œæˆï¼šMD5æ–‡ä»¶ç”Ÿæˆå®Œæ¯•"

      - name: 39-ä¸Šä¼ å¿«ç…§æ–‡ä»¶åˆ°WebDAV
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤39ï¼šä¸Šä¼ å¿«ç…§æ–‡ä»¶ ====="
          rclone copy ${{ env.SNAPSHOT_PATH }} mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf \
            --transfers 2 --retries 5 --retries-sleep 30s --chunk-size 100M \
            --multi-thread-streams 4 --timeout 1h --contimeout 5m --resume-support --progress
          echo "âœ… æ­¥éª¤39å®Œæˆï¼šå¿«ç…§ä¸Šä¼ å®Œæ¯•"

      - name: 40-ä¸Šä¼ MD5æ–‡ä»¶åˆ°WebDAV
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤40ï¼šä¸Šä¼ MD5æ–‡ä»¶ ====="
          rclone copy ${{ env.SNAPSHOT_MD5_PATH }} mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf \
            --retries 5 --timeout 1h --contimeout 5m --progress
          echo "âœ… æ­¥éª¤40å®Œæˆï¼šMD5æ–‡ä»¶ä¸Šä¼ å®Œæ¯•"

      - name: 41-è¿œç¨‹æ–‡ä»¶æ ¡éªŒ
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤41ï¼šæ ¡éªŒè¿œç¨‹æ–‡ä»¶ ====="
          if ! rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/${{ env.SNAPSHOT_NAME }} --config /home/runner/.rclone.conf >/dev/null;then
            echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥"
            exit 1
          fi
          if ! rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/${{ env.SNAPSHOT_NAME }}${{ env.SNAPSHOT_MD5_SUFFIX }} --config /home/runner/.rclone.conf >/dev/null;then
            echo "âŒ MD5æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ­¥éª¤41å®Œæˆï¼šè¿œç¨‹æ–‡ä»¶æ ¡éªŒé€šè¿‡"

      - name: 42-å¤‡ä»½åå¯åŠ¨æ‰€æœ‰æœåŠ¡
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== æ­¥éª¤42ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡ ====="
          sudo rm -f ${{ env.SNAPSHOT_PATH }} ${{ env.SNAPSHOT_MD5_PATH }}
          sudo systemctl enable --now docker containerd casaos && sleep 3
          echo "âœ… æ­¥éª¤42å®Œæˆï¼šæ‰€æœ‰æœåŠ¡å¯åŠ¨æˆåŠŸ"

      - name: 43-è§¦å‘è‡ªåŠ¨ç»­è·‘äº‹ä»¶
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.USER_PAT != '' && env.REPO != '' }}
        run: |
          set -e
          echo "===== æ­¥éª¤43ï¼šè§¦å‘è‡ªåŠ¨ç»­è·‘ ====="
          if curl -fsSL --fail --connect-timeout 30 -X POST \
            -H "Authorization: token $USER_PAT" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"renew_casaos_snapshot"}';then
            echo "âœ… æ­¥éª¤43å®Œæˆï¼šè‡ªåŠ¨ç»­è·‘è§¦å‘æˆåŠŸ"
          else
            echo "âš ï¸ æ­¥éª¤43å®Œæˆï¼šè‡ªåŠ¨ç»­è·‘è§¦å‘å¤±è´¥"
          fi

      # æ”¶å°¾æ¸…ç†ï¼ˆ4æ­¥ï¼‰
      - name: 44-æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ­¥éª¤44ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶ ====="
          sudo rm -rf /tmp/* 2>/dev/null || true
          echo "âœ… æ­¥éª¤44å®Œæˆï¼šä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæ¯•"

      - name: 45-æ¸…ç†æ•æ„Ÿé…ç½®æ–‡ä»¶
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ­¥éª¤45ï¼šæ¸…ç†æ•æ„Ÿé…ç½® ====="
          sudo rm -f /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          echo "âœ… æ­¥éª¤45å®Œæˆï¼šæ•æ„Ÿé…ç½®æ¸…ç†å®Œæ¯•"

      - name: 46-æ¸…ç†ç³»ç»Ÿç¼“å­˜
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ­¥éª¤46ï¼šæ¸…ç†ç³»ç»Ÿç¼“å­˜ ====="
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "âœ… æ­¥éª¤46å®Œæˆï¼šç³»ç»Ÿç¼“å­˜æ¸…ç†å®Œæ¯•"

      - name: 47-æœ€ç»ˆæœåŠ¡çŠ¶æ€æ ¡éªŒ
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ­¥éª¤47ï¼šæœ€ç»ˆæœåŠ¡çŠ¶æ€æ ¡éªŒ ====="
          echo "ğŸ“Œ æ ¡éªŒç»“æœï¼š"
          sudo systemctl is-active --quiet docker && echo "âœ… Dockerï¼šè¿è¡Œæ­£å¸¸" || echo "âš ï¸ Dockerï¼šæœªè¿è¡Œ"
          sudo systemctl is-active --quiet casaos && echo "âœ… CasaOSï¼šè¿è¡Œæ­£å¸¸" || echo "âš ï¸ CasaOSï¼šæœªè¿è¡Œ"
          sudo systemctl is-active --quiet tailscaled && echo "âœ… Tailscaleï¼šè¿è¡Œæ­£å¸¸" || echo "âš ï¸ Tailscaleï¼šæœªè¿è¡Œï¼ˆæœªé…ç½®å¯å¿½ç•¥ï¼‰"
          echo "ğŸ‰ æ­¥éª¤47å®Œæˆï¼šå…¨æµç¨‹æ”¶å°¾å®Œæ¯•"
          echo "ğŸ”š 47æ­¥ç»†åˆ†æµç¨‹å…¨éƒ¨æ‰§è¡Œç»“æŸï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡Œ"