name: CasaOS çº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç†ï¼‰
# GitHubè§„èŒƒï¼šåç§°æ¸…æ™°æè¿°å·¥ä½œæµç”¨é€”
# è§¦å‘è§„åˆ™ï¼šæ”¯æŒæ‰‹åŠ¨è§¦å‘ã€ä»“åº“äº‹ä»¶è§¦å‘ã€ä¸»åˆ†æ”¯PRè§¦å‘ï¼ˆé¿å…éä¸»åˆ†æ”¯è¯¯æ“ä½œï¼‰
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # ä»“åº“äº‹ä»¶è§¦å‘
  pull_request:
    branches: [main]  # ä»…ä¸»åˆ†æ”¯PRè§¦å‘ï¼ˆé¿å…éæ ¸å¿ƒåˆ†æ”¯è¯¯æ‰§è¡Œï¼‰

# æƒé™æ§åˆ¶ï¼šéµå¾ªæœ€å°æƒé™åŸåˆ™
permissions:
  contents: read  # ä»…è¯»å–ä»“åº“å†…å®¹
  actions: read   # è¯»å–å·¥ä½œæµçŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰

jobs:
  casaos-deploy:
    runs-on: ubuntu-22.04  # è´´åˆCasaOSå®˜æ–¹æ¨èç¯å¢ƒ
    timeout-minutes: 60    # åˆç†è¶…æ—¶ï¼ˆé¿å…èµ„æºå ç”¨ï¼‰
    # ç¯å¢ƒå˜é‡ï¼šè§„èŒƒå‘½åï¼ˆå…¨å¤§å†™+ä¸‹åˆ’çº¿ï¼‰ï¼Œæ•æ„Ÿä¿¡æ¯é€šè¿‡Secretsä¼ é€’
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: "--exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
      KEEP_BACKUPS: "2"
      TARGET_RUN_MINUTES: "60"
      CASA_SERVICES: "casaos-gateway casaos-message-bus casaos-user-service casaos-local-storage casaos-app-management rclone casaos"
      SNAPSHOT_NAME: "casaos-full-snapshot-$(date +%Y%m%d-%H%M%S)-$(hostname | cut -c1-8).tar.gz"

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆGitHub Actionsè§„èŒƒï¼šå·¥ä½œæµéœ€å…ˆæ£€å‡ºä»£ç ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4  # ä½¿ç”¨å®˜æ–¹æœ€æ–°Action

      # æ­¥éª¤2ï¼šå®‰å…¨åˆå§‹åŒ–&ç¯å¢ƒæ ¡éªŒ
      - name: ğŸ”’ åˆå§‹åŒ–ç¯å¢ƒä¸ä¾èµ–
        run: |
          set -euo pipefail  # å¢å¼ºè„šæœ¬å¥å£®æ€§ï¼ˆç¦æ­¢æœªå®šä¹‰å˜é‡ã€ç®¡é“å¤±è´¥å³ç»ˆæ­¢ï¼‰
          echo "WORKFLOW_START_TIME=$(date +%s)" >> "$GITHUB_ENV"
          # æ•æ„Ÿä¿¡æ¯è„±æ•ï¼ˆGitHubè§„èŒƒï¼šé¿å…æ—¥å¿—æ³„éœ²æ•æ„Ÿæ•°æ®ï¼‰
          [ -n "${ROOTS_PASSWORD:-}" ] && echo "::add-mask::$ROOTS_PASSWORD"
          [ -n "${WEBDAV_PASSWORD:-}" ] && echo "::add-mask::$WEBDAV_PASSWORD"
          
          # å®‰è£…ä¾èµ–
          sudo apt update -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          
          # ç£ç›˜ç©ºé—´é¢„æ£€ï¼ˆé¿å…éƒ¨ç½²å¤±è´¥ï¼‰
          echo "ğŸ—‚ï¸  æ£€æŸ¥æ ¹ç›®å½•ç©ºé—´"
          if [ $(df -P / | awk 'NR==2{print $4}' | sed 's/G//') -le 10 ]; then
            echo "âŒ æ ¹ç›®å½•å¯ç”¨ç©ºé—´ä¸è¶³10GB" && exit 1
          fi

      # æ­¥éª¤3ï¼šå®‰è£…Dockerï¼ˆé˜¿é‡Œäº‘é•œåƒåŠ é€Ÿï¼‰
      - name: ğŸ³ å®‰è£…Dockerå¼•æ“
        run: |
          set -euo pipefail
          # æ¸…ç†æ—§ç‰ˆæœ¬
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          # å®‰è£…æœ€æ–°ç‰ˆDocker
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          # å¯ç”¨æœåŠ¡å¹¶éªŒè¯
          sudo systemctl enable --now docker containerd
          sudo usermod -aG docker "$USER"
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥" && exit 1
          fi

      # æ­¥éª¤4ï¼šåˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
      - name: ğŸ‘¤ é…ç½®rootsç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -euo pipefail
          USER_NAME="roots"
          # åˆ›å»ºç”¨æˆ·ï¼ˆä¸å­˜åœ¨æ—¶ï¼‰
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          # è®¾ç½®å¯†ç 
          if [ -n "${ROOTS_PASSWORD:-}" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 16 | tr -dc 'A-Za-z0-9' | head -c12)
            echo "::add-mask::$RANDOM_PASS"
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "ğŸ”‘ rootsä¸´æ—¶å¯†ç å·²ç”Ÿæˆï¼ˆå·²è„±æ•ï¼‰"
          fi
          # é…ç½®sudoæƒé™
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"

      # æ­¥éª¤5ï¼šWebDAVé…ç½®ä¸å¿«ç…§æ£€æµ‹
      - name: â˜ï¸ é…ç½®WebDAVå¤‡ä»½æº
        id: webdav
        run: |
          set -euo pipefail
          # æ ¡éªŒå‡­è¯æ˜¯å¦å­˜åœ¨
          if [ -z "${WEBDAV_URL:-}" ] || [ -z "${WEBDAV_USER:-}" ] || [ -z "${WEBDAV_PASSWORD:-}" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æµç¨‹"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # é…ç½®rclone
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /root/.rclone.conf 2>/dev/null || true
          sudo chmod 600 /root/.rclone.conf
          
          # é‡è¯•åˆ›å»ºè¿œç¨‹ç›®å½•
          for i in {1..3}; do
            if rclone mkdir "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf; then
              echo "âœ… WebDAVè¿œç¨‹ç›®å½•å·²å°±ç»ª" && break
            elif [ $i -eq 3 ]; then
              echo "âŒ WebDAVç›®å½•åˆ›å»ºå¤±è´¥" && echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV" && exit 0
            fi
            sleep 2
          done
          
          # æ£€æµ‹æœ€æ–°å¿«ç…§
          LATEST=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | head -1)
          if [ -n "$LATEST" ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å¿«ç…§ï¼š$LATEST"
            echo "LATEST_SNAPSHOT=$LATEST" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "â„¹ï¸ æ— å†å²å¿«ç…§"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      # æ­¥éª¤6ï¼šæ¸…ç†æ—§ç¯å¢ƒ
      - name: ğŸ§¹ æ¸…ç†æ—§CasaOSæœåŠ¡
        run: |
          set -euo pipefail
          # åœæ­¢å¹¶ç§»é™¤æ—§æœåŠ¡
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
            sudo systemctl disable "${svc}.service" 2>/dev/null || true
            sudo rm -f "/etc/systemd/system/${svc}.service" "/usr/lib/systemd/system/${svc}.service" 2>/dev/null || true
          done
          # æ¸…ç†æ®‹ç•™è¿›ç¨‹ä¸æ•°æ®
          sudo pkill -9 -f "casaos\|rclone" 2>/dev/null || true
          sudo rm -rf /var/lib/casaos/* /etc/casaos/* 2>/dev/null || true
          sudo systemctl daemon-reload

      # æ­¥éª¤7ï¼šå®‰è£…CasaOS
      - name: ğŸ“¦ å®‰è£…CasaOSæ ¸å¿ƒ
        run: |
          set -euo pipefail
          # å®‰è£…CasaOS
          curl -fsSL https://get.casaos.io | sudo bash
          # ä¸´æ—¶åœæ­¢æœåŠ¡ï¼ˆå¾…æ•°æ®æ¢å¤åå¯åŠ¨ï¼‰
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          # éªŒè¯å®‰è£…
          if [ ! -f /usr/bin/casaos ]; then
            echo "âŒ CasaOSå®‰è£…å¤±è´¥" && exit 1
          fi

      # æ­¥éª¤8ï¼šæ¢å¤å¿«ç…§æ•°æ®ï¼ˆæ¡ä»¶è§¦å‘ï¼‰
      - name: ğŸ”„ æ¢å¤å†å²å¿«ç…§æ•°æ®
        if: env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true'
        run: |
          set -euo pipefail
          # åœæ­¢ç›¸å…³æœåŠ¡
          sudo systemctl stop docker containerd 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 docker containerd runc 2>/dev/null || true
          sync && sleep 3
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" 2>/dev/null || true
          done
          
          # æ¢å¤å¿«ç…§
          echo "ğŸ”„ æ¢å¤å¿«ç…§ï¼š$LATEST_SNAPSHOT"
          rclone cat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf | \
            sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS 2>&1 | grep -v "Removing leading" || true
          
          # ä¿®å¤æƒé™
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true

      # æ­¥éª¤9ï¼šå¯åŠ¨æ ¸å¿ƒæœåŠ¡
      - name: âš™ï¸ å¯åŠ¨CasaOSæœåŠ¡
        run: |
          set -euo pipefail
          # é‡Šæ”¾ç«¯å£
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          # åˆ›å»ºå¿…è¦ç›®å½•
          sudo mkdir -p /run/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          
          # å¯åŠ¨Docker
          sudo systemctl enable --now docker containerd
          sleep 5
          if ! sudo systemctl is-active --quiet docker; then
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥" && exit 1
          fi
          
          # å¯åŠ¨CasaOSæœåŠ¡
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 8
          if ! sudo systemctl is-active --quiet casaos; then
            echo "âŒ CasaOSæ ¸å¿ƒæœåŠ¡å¯åŠ¨å¤±è´¥" && exit 1
          fi
          
          # é¦–æ¬¡éƒ¨ç½²æç¤º
          if [ "${HAS_SNAPSHOT:-false}" != "true" ]; then
            LOCAL_IP=$(hostname -I | awk '{print $1}')
            echo "âœ¨ é¦–æ¬¡éƒ¨ç½²å®Œæˆï¼Œè®¿é—®åœ°å€ï¼šhttp://$LOCAL_IP"
          fi

      # æ­¥éª¤10ï¼šé…ç½®Tailscaleï¼ˆå¯é€‰ï¼‰
      - name: ğŸŒ é…ç½®Tailscaleç»„ç½‘
        if: env.TAILSCALE_AUTH_KEY != ''
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          sudo systemctl enable --now tailscaled
          sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" \
            --hostname="CasaOS-$(hostname | cut -c1-8)" --accept-routes --advertise-exit-node 2>/dev/null || true
          TAIL_IP=$(sudo tailscale ip -4 2>/dev/null || echo "æœªè·å–")
          echo "âœ… Tailscaleè®¿é—®IPï¼š$TAIL_IP"

      # æ­¥éª¤11ï¼šé…ç½®Cloudflare Tunnelï¼ˆå¯é€‰ï¼‰
      - name: ğŸŒ‰ é…ç½®Cloudflare Tunnel
        if: env.CLOUDFLARED_TOKEN != ''
        run: |
          set -euo pipefail
          # å®‰è£…Cloudflared
          sudo mkdir -p /usr/local/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/local/share/keyrings/cloudflare.gpg >/dev/null
          echo "deb [signed-by=/usr/local/share/keyrings/cloudflare.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null
          sudo apt update -qq && sudo apt install -y cloudflared -qq
          
          # é…ç½®Token
          echo "CLOUDFLARED_TOKEN=${CLOUDFLARED_TOKEN}" | sudo tee /etc/default/cloudflared > /dev/null
          sudo chmod 600 /etc/default/cloudflared
          
          # é…ç½®systemdæœåŠ¡
          sudo tee /etc/systemd/system/cloudflared.service > /dev/null <<'EOF'
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
EnvironmentFile=/etc/default/cloudflared
ExecStart=/usr/bin/cloudflared tunnel run --token $CLOUDFLARED_TOKEN
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=cloudflared

[Install]
WantedBy=multi-user.target
EOF
          
          # å¯åŠ¨æœåŠ¡
          sudo systemctl daemon-reload
          sudo systemctl enable --now cloudflared
          sleep 8
          if ! sudo systemctl is-active --quiet cloudflared; then
            echo "âŒ Cloudflare Tunnelå¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—ï¼šjournalctl -u cloudflared" && exit 1
          fi

      # æ­¥éª¤12ï¼šç”Ÿæˆå¹¶ä¸Šä¼ æ–°å¿«ç…§
      - name: ğŸ“¤ ç”Ÿæˆå¹¶ä¸Šä¼ æœ€æ–°å¿«ç…§
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          set -euo pipefail
          # åœæ­¢æœåŠ¡ä»¥ä¿è¯å¿«ç…§å®Œæ•´æ€§
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo systemctl stop docker containerd 2>/dev/null || true
          sync && sleep 3
          
          # æ‰“åŒ…å¿«ç…§
          echo "ğŸ“¦ ç”Ÿæˆå¿«ç…§ï¼š$SNAPSHOT_NAME"
          sudo tar -czf - $EXCLUDE_RULES $PERSONAL_DATA_DIRS 2>/dev/null | \
            rclone rcat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}" --config /root/.rclone.conf
          
          # éªŒè¯ä¸Šä¼ 
          if ! rclone ls "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${SNAPSHOT_NAME}" --config /root/.rclone.conf; then
            echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥" && exit 1
          fi
          
          # é‡å¯æœåŠ¡
          sudo systemctl enable --now docker containerd
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 5

      # æ­¥éª¤13ï¼šæ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™2ä»½ï¼‰
      - name: ğŸ§¹ æ¸…ç†æ—§å¿«ç…§ï¼ˆä¿ç•™æœ€æ–°2ä»½ï¼‰
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          set -euo pipefail
          # è·å–æ—§å¿«ç…§åˆ—è¡¨ï¼ˆæ’é™¤æœ€æ–°2ä»½ï¼‰
          OLD_SNAPSHOTS=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | tail -n +$((KEEP_BACKUPS+1)))
          
          # åˆ é™¤æ—§å¿«ç…§
          if [ -n "$OLD_SNAPSHOTS" ]; then
            for snap in $OLD_SNAPSHOTS; do
              echo "åˆ é™¤æ—§å¿«ç…§ï¼š$snap"
              rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${snap}" --config /root/.rclone.conf 2>/dev/null
            done
            echo "âœ… å·²ä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½å¿«ç…§"
          else
            echo "â„¹ï¸ å¿«ç…§æ•°é‡æœªè¶…è¿‡${KEEP_BACKUPS}ä»½ï¼Œæ— éœ€æ¸…ç†"
          fi

      # æ­¥éª¤14ï¼šå»¶æ—¶æ ¡å‡†ï¼ˆè‡ªåŠ¨è§¦å‘æ—¶ï¼‰
      - name: â±ï¸ å»¶æ—¶æ ¡å‡†ï¼ˆæ»¡è¶³æœ€å°è¿è¡Œæ—¶é•¿ï¼‰
        if: env.WEBDAV_AVAILABLE == 'true' && github.event_name == 'repository_dispatch'
        run: |
          set -euo pipefail
          START_TIME="${WORKFLOW_START_TIME}"
          CURRENT_TIME=$(date +%s)
          CURRENT_DURATION=$((CURRENT_TIME - START_TIME))
          TARGET_DURATION=$((TARGET_RUN_MINUTES * 60))
          WAIT_TIME=$((TARGET_DURATION - CURRENT_DURATION))
          
          if [ $WAIT_TIME -gt 0 ]; then
            echo "â³ ç­‰å¾…$((WAIT_TIME / 60))åˆ†é’Ÿä»¥æ»¡è¶³è¿è¡Œæ—¶é•¿è¦æ±‚"
            sleep $WAIT_TIME
          fi

      # æ­¥éª¤15ï¼šè¾“å‡ºéƒ¨ç½²æŠ¥å‘Š
      - name: ğŸ“Š éƒ¨ç½²å®ŒæˆæŠ¥å‘Š
        run: |
          echo "========================================"
          echo "âœ… CasaOSéƒ¨ç½²ä¸å¤‡ä»½æµç¨‹å®Œæˆ"
          echo "ğŸ“Œ æ ¸å¿ƒä¿¡æ¯ï¼š"
          echo "   - æœ¬åœ°è®¿é—®ï¼šhttp://$(hostname -I | awk '{print $1}')"
          echo "   - Tailscale IPï¼š$(sudo tailscale ip -4 2>/dev/null || echo "æœªå¯ç”¨")"
          echo "   - Cloudflare Tunnelï¼š$(systemctl is-active cloudflared || echo "æœªå¯ç”¨")"
          echo "   - å¤‡ä»½çŠ¶æ€ï¼šå·²ä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½å¿«ç…§"
          echo "========================================"