name: CasaOS+Docker+Firefox+VNC+Tailscale æŒç»­æœåŠ¡ï¼ˆå¯¹è±¡å­˜å‚¨å¤‡ä»½ç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  casaos-firefox-server:
    runs-on: ubuntu-24.04
    timeout-minutes: 350
    env:
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340
      FIXED_VNC_PWD: "123456789"
      OPENLIST_PORT: 3000
      CASAOS_PORT: 80
      FIREFOX_PORT: 6080
      NETDISK_ROOT: /mnt/netdisk
      BACKUP_DIR: /home/runner/backup
      INC_BACKUP_BASE: "casaos_base.tar.gz"
      KEEP_BACKUP_NUM: 2
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/mnt --exclude=/run --exclude=/var/run"
    steps:
      - name: ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–æ›´æ–°
        id: init_env
        continue-on-error: false
        run: |
          echo "===== åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ ====="
          sudo apt update -y || { echo "ç³»ç»Ÿæ›´æ–°å¤±è´¥"; exit 1; }
          sudo apt upgrade -y || { echo "ç³»ç»Ÿå‡çº§å¤±è´¥"; exit 1; }
          sudo apt install -y tar gzip rsync rclone || { echo "å¤‡ä»½ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          mkdir -p $BACKUP_DIR $NETDISK_ROOT
          echo "===== ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ ====="

      - name: é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆrcloneï¼‰
        id: config_rclone
        continue-on-error: false
        env:
          OSS_CONFIG: ${{ secrets.OSS_CONFIG }}
        run: |
          echo "===== é…ç½®å¯¹è±¡å­˜å‚¨ ====="
          IFS=';' read -r -a oss_arr <<< "$OSS_CONFIG"
          for item in "${oss_arr[@]}"; do
            key=$(echo $item | cut -d ':' -f1)
            value=$(echo $item | cut -d ':' -f2-)
            export OSS_${key^^}=$value
          done
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
[oss]
type = s3
provider = Other
endpoint = $OSS_ENDPOINT
access_key_id = $OSS_AK
secret_access_key = $OSS_SK
EOF
          chmod 600 ~/.config/rclone/rclone.conf
          if rclone lsd oss:; then
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥æˆåŠŸ"
          else
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥å¤±è´¥"; exit 1;
          fi
          echo "===== å¯¹è±¡å­˜å‚¨é…ç½®å®Œæˆ ====="

      - name: æ¢å¤å†å²å¤‡ä»½ï¼ˆåŸºå‡†+å¢é‡ï¼‰
        id: restore_backup
        continue-on-error: true
        run: |
          echo "===== æ¢å¤å†å²å¤‡ä»½ ====="
          rclone copy oss:casaos-backup/ $BACKUP_DIR/ || { echo "æ— å†å²å¤‡ä»½ï¼Œè·³è¿‡æ¢å¤"; exit 0; }
          if [ -f "$BACKUP_DIR/$INC_BACKUP_BASE" ]; then
            echo "æ¢å¤åŸºå‡†å¤‡ä»½..."
            sudo tar -zxf $BACKUP_DIR/$INC_BACKUP_BASE -C / --preserve-permissions || echo "åŸºå‡†å¤‡ä»½æ¢å¤å¤±è´¥"
            LATEST_INC=$(ls -tp $BACKUP_DIR/inc_*.tar.gz 2>/dev/null | grep -v '/' | head -n1)
            if [ -n "$LATEST_INC" ]; then
              echo "æ¢å¤å¢é‡å¤‡ä»½ï¼š$LATEST_INC"
              sudo tar -zxf $LATEST_INC -C / --preserve-permissions || echo "å¢é‡å¤‡ä»½æ¢å¤å¤±è´¥"
            fi
          else
            echo "æ— åŸºå‡†å¤‡ä»½ï¼Œå°†åˆ›å»ºæ–°åŸºå‡†"
          fi
          echo "===== å¤‡ä»½æ¢å¤å®Œæˆ ====="

      - name: å®‰è£…æ ¸å¿ƒä¾èµ–+Docker+CasaOS
        id: install_services
        continue-on-error: true
        run: |
          echo "===== å®‰è£…æ ¸å¿ƒä¾èµ– ====="
          DEPS=(
            "tigervnc-standalone-server" "netcat-openbsd" "psmisc" "curl" "git"
            "sendmail" "mailutils" "openssh-client" "wget" "vim" "nano" "python3" "python3-pip" "python3-venv" "ca-certificates" "gnupg" "lsb-release"
          )
          for dep in "${DEPS[@]}"; do
            sudo apt install -y "$dep" || echo "è­¦å‘Šï¼š$dep å®‰è£…å¤±è´¥"
          done
          # å®‰è£…Docker
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          sudo apt update -y && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
          sudo systemctl start docker && sudo systemctl enable docker
          # å®‰è£…CasaOS
          curl -fsSL https://get.casaos.io | sudo bash || echo "è­¦å‘Šï¼šCasaOSå®‰è£…å¤±è´¥"
          sleep 10 && sudo systemctl start casaos || echo "CasaOSå¯åŠ¨å¤±è´¥"
          echo "===== æœåŠ¡ä¾èµ–å®‰è£…å®Œæˆ ====="

      - name: éƒ¨ç½²Firefox+VNC+OpenList+Tailscale
        id: deploy_apps
        continue-on-error: true
        run: |
          echo "===== éƒ¨ç½²Firefoxå®¹å™¨ ====="
          sudo docker stop firefox || true && sudo docker rm firefox || true
          sudo docker run -d --name firefox --restart always -p ${FIREFOX_PORT}:6080 -e DISPLAY_WIDTH=1920 -e DISPLAY_HEIGHT=1080 -v /tmp/.X11-unix:/tmp/.X11-unix jlesage/firefox || echo "Firefoxéƒ¨ç½²å¤±è´¥"
          
          echo "===== é…ç½®VNC ====="
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          cat > $VNCDIR/xstartup << "EOF"
#!/bin/bash
export DISPLAY=:0
export XDG_RUNTIME_DIR=/tmp/runtime-runner
mkdir -p $XDG_RUNTIME_DIR && chmod 700 $XDG_RUNTIME_DIR
exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title "CasaOSæœåŠ¡"
EOF
          chmod +x $VNCDIR/xstartup
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth || echo "VNCå¯åŠ¨å¤±è´¥"
          
          echo "===== éƒ¨ç½²OpenList ====="
          [ ! -d /home/runner/OpenList ] && git clone https://github.com/thsrite/OpenList.git /home/runner/OpenList || true
          cd /home/runner/OpenList && [ ! -d venv ] && python3 -m venv venv || true
          source venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt || true
          pkill -f "python3 main.py" || true
          nohup python3 main.py > openlist.log 2>&1 & disown
          
          echo "===== é…ç½®Tailscale ====="
          curl -fsSL https://tailscale.com/install.sh | sudo sh || echo "Tailscaleå®‰è£…å¤±è´¥"
          sudo systemctl enable --now tailscaled && sleep 3
          MAX_RETRIES=3
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1)) && sleep 5
          done
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "===== åº”ç”¨éƒ¨ç½²å®Œæˆ ====="

      - name: è¾“å‡ºæœåŠ¡è®¿é—®ä¿¡æ¯
        id: output_info
        continue-on-error: false
        run: |
          echo -e "\n========================================"
          echo -e " ğŸš€ æœåŠ¡å¯åŠ¨å®Œæˆ - è®¿é—®ä¿¡æ¯æ±‡æ€»"
          echo -e "========================================"
          echo -e " ğŸ”‘ å¯†ç ä¿¡æ¯"
          echo -e " VNCå¯†ç ï¼š\033[1;32m${FIXED_VNC_PWD}\033[0m"
          echo -e " CasaOSè´¦å·ï¼š\033[1;32madmin\033[0m / å¯†ç ï¼š\033[1;32madmin\033[0m"
          echo -e " \n ğŸŒ è®¿é—®åœ°å€ï¼ˆTailscale IPï¼‰"
          echo -e " CasaOSé¢æ¿ï¼š\033[1;34mhttp://${TAILSCALE_IP}:${CASAOS_PORT}\033[0m"
          echo -e " Firefoxæµè§ˆå™¨ï¼š\033[1;34mhttp://${TAILSCALE_IP}:${FIREFOX_PORT}\033[0m"
          echo -e " VNCè¿œç¨‹ï¼š\033[1;34m${TAILSCALE_IP}:${VNC_PORT}\033[0m"
          echo -e " OpenListç½‘ç›˜ï¼š\033[1;34m${TAILSCALE_IP}:${OPENLIST_PORT}\033[0m"
          echo -e " \n ğŸ“¦ å¤‡ä»½ä¿¡æ¯"
          echo -e " å¤‡ä»½å­˜å‚¨ï¼šå¯¹è±¡å­˜å‚¨ oss:casaos-backup/"
          echo -e " å¤‡ä»½ç­–ç•¥ï¼š1æ¬¡å…¨é‡ + å¢é‡å¤‡ä»½ï¼Œä¿ç•™${KEEP_BACKUP_NUM}ä»½"
          echo -e "========================================\n"

      - name: ä¿æ´»+ç»­è·‘+è‡ªåŠ¨å¤‡ä»½æ ¸å¿ƒé€»è¾‘
        id: core_logic
        continue-on-error: true
        run: |
          echo "===== å¯åŠ¨ä¿æ´»+å¤‡ä»½ç›‘æ§ ====="
          start_time=$(date +%s)
          last_backup_time=$start_time

          full_backup() {
            echo "===== åˆ›å»ºå…¨é‡åŸºå‡†å¤‡ä»½ ====="
            BACKUP_NAME=$BACKUP_DIR/$INC_BACKUP_BASE
            sudo tar -zcf $BACKUP_NAME $BACKUP_EXCLUDE / || { echo "å…¨é‡å¤‡ä»½å¤±è´¥"; return 1; }
            rclone copy $BACKUP_NAME oss:casaos-backup/ || echo "åŸºå‡†å¤‡ä»½ä¸Šä¼ å¤±è´¥"
            echo "å…¨é‡å¤‡ä»½å®Œæˆï¼š$BACKUP_NAME"
          }

          inc_backup() {
            echo "===== åˆ›å»ºå¢é‡å¤‡ä»½ ====="
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_NAME=$BACKUP_DIR/inc_$TIMESTAMP.tar.gz
            sudo tar -zcf $BACKUP_NAME $BACKUP_EXCLUDE / --listed-incremental=$BACKUP_DIR/backup.snar || { echo "å¢é‡å¤‡ä»½å¤±è´¥"; return 1; }
            rclone copy $BACKUP_NAME oss:casaos-backup/ || echo "å¢é‡å¤‡ä»½ä¸Šä¼ å¤±è´¥"
            ls -tp $BACKUP_DIR/inc_*.tar.gz 2>/dev/null | grep -v '/' | tail -n +$((KEEP_BACKUP_NUM)) | xargs -I {} sudo rm -f {} || true
            rclone delete oss:casaos-backup/ --include "inc_*.tar.gz" --min-age $((KEEP_BACKUP_NUM * 86400)) || true
            echo "å¢é‡å¤‡ä»½å®Œæˆï¼š$BACKUP_NAME"
          }

          [ ! -f "$BACKUP_DIR/$INC_BACKUP_BASE" ] && full_backup || inc_backup

          while true; do
            current_time=$(date +%s)
            run_minutes=$(( (current_time - start_time) / 60 ))

            # ç»­è·‘è§¦å‘ï¼šå‰©ä½™10åˆ†é’Ÿï¼ˆå…³é”®ä¿®æ”¹ï¼šUSER_GITHUB_PATï¼‰
            if [ $((MAX_RUN_MINUTES - run_minutes)) -eq 10 ]; then
              echo "===== å‰©ä½™10åˆ†é’Ÿï¼Œè§¦å‘ç»­è·‘ ====="
              full_backup
              curl -X POST https://api.github.com/repos/${{ github.repository }}/dispatches \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.USER_GITHUB_PAT }}" \
                -d '{"event_type":"renew_vnc"}' || echo "ç»­è·‘è§¦å‘å¤±è´¥"
            fi

            # æ¯å°æ—¶å¢é‡å¤‡ä»½
            if [ $((current_time - last_backup_time)) -ge 3600 ]; then
              inc_backup
              last_backup_time=$current_time
            fi

            # å¥åº·æ£€æŸ¥
            pgrep -x Xvnc || { echo "VNCå¼‚å¸¸ï¼Œé‡å¯"; vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth; }
            sudo docker inspect -f '{{.State.Running}}' firefox 2>/dev/null | grep true || { echo "Firefoxå¼‚å¸¸ï¼Œé‡å¯"; sudo docker start firefox; }
            pgrep -f "python3 main.py" || { echo "OpenListå¼‚å¸¸ï¼Œé‡å¯"; cd /home/runner/OpenList && source venv/bin/activate && nohup python3 main.py > openlist.log 2>&1 & disown; }
            pgrep -x tailscaled || { echo "Tailscaleå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart tailscaled; }

            echo "[$(date)] è¿è¡Œæ—¶é•¿ï¼š${run_minutes}åˆ†é’Ÿ | Tailscale IPï¼š${TAILSCALE_IP}"
            sleep 300
          done

      - name: ä¼˜é›…æ¸…ç†ç¯å¢ƒ
        id: clean_env
        if: always()
        run: |
          echo "===== æ¸…ç†ç¯å¢ƒ ====="
          [ -f "$BACKUP_DIR/$INC_BACKUP_BASE" ] && rclone copy $BACKUP_DIR/$INC_BACKUP_BASE oss:casaos-backup/ || true
          vncserver -kill $DISPLAY || true && pkill -9 Xvnc || true
          pkill -f "python3 main.py" || true
          sudo docker stop firefox && sudo docker rm firefox || true
          sudo systemctl stop docker casaos tailscaled || true
          sudo tailscale down || true
          rm -rf $BACKUP_DIR $VNCDIR /home/runner/OpenList || true
          echo "===== ç¯å¢ƒæ¸…ç†å®Œæˆ ====="
