name: CasaOS å…¨é‡å¤‡ä»½ä¸Žè‡ªåŠ¨æ¢å¤

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_snapshot]  # ç»­è·‘è§¦å‘ç±»åž‹

jobs:
  casaos_backup_restore:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_SNAPSHOT_EN_DIR: "/z/Ubu"
      
      # === ä¿®å¤ç‚¹ï¼šå°†å¤šè¡Œå˜é‡æ”¹ä¸ºå•è¡Œï¼Œé¿å…YAMLè§£æžå‡ºé”™ ===
      CORE_DIRS: "/var/lib/docker /etc/docker /etc/casaos /var/lib/casaos /DATA /etc/systemd/system /usr/lib/systemd/system /usr/local/bin /usr/local/lib /usr/lib /usr/share /etc/apt /etc/profile.d /etc/environment /var/lib/apt /var/cache/apt /usr/sbin /bin /sbin /etc/ld.so.conf.d /lib/x86_64-linux-gnu /lib64"
      
      EXCLUDE_RULES: "--exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/logs --exclude=/var/lib/docker/buildx --exclude=/var/lib/docker/plugins --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=*.swp --exclude=/tmp/* --exclude=/var/tmp/* --exclude=/var/log/* --exclude=/var/cache/apt/archives/* --exclude=/DATA/tmp --exclude=/DATA/logs --exclude=/DATA/cache --exclude=/etc/systemd/system/*.wants --exclude=/etc/systemd/system/*.requires --exclude=/usr/share/doc --exclude=/usr/share/man"
      
      WEBDAV_URL:  $ {{ secrets.WEBDAV_URL }}
      WEBDAV_USER:  $ {{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD:  $ {{ secrets.WEBDAV_PASSWORD }}
      USER_PAT:  $ {{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY:  $ {{ secrets.TAILSCALE_AUTH_KEY }}
      REPO:  $ {{ github.repository }}
      ROOTS_PASSWORD:  $ {{ secrets.ROOTS_PASSWORD }}
      WEBDAV_AVAILABLE: true
      BACKUP_MARK: "CASAOS_FULL_BACKUP_FULLY"

    steps:
      - name: 1. çŽ¯å¢ƒåˆå§‹åŒ–ä¸Žä¾èµ–å®‰è£…
        run: |
          set -e
          # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt update -y && sudo apt install -y curl wget jq fuse3 tar gzip locales openssl rsync ca-certificates apt-transport-https
          # é…ç½®ä¸­æ–‡ç¼–ç ï¼ˆé¿å…ä¹±ç ï¼‰
          sudo locale-gen zh_CN.UTF-8 en_US.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # å®‰è£…rcloneï¼ˆç”¨äºŽWebDAVä¼ è¾“ï¼‰
          curl https://rclone.org/install.sh | sudo bash
          # é…ç½®runneræƒé™
          sudo sed -i 's/^Defaults requiretty/#Defaults requiretty/' /etc/sudoers
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          # åˆ›å»ºDATAç›®å½•ï¼ˆé¿å…å¤‡ä»½æ—¶ç›®å½•ä¸å­˜åœ¨ï¼‰
          sudo mkdir -p /DATA && sudo chmod 755 /DATA
          # æ¸…ç†æ®‹ç•™çš„é”™è¯¯ç›®å½•ï¼ˆ/usr/bin/casaosåº”ä¸ºæ–‡ä»¶ï¼Œä¸æ˜¯ç›®å½•ï¼‰
          if [ -d "/usr/bin/casaos" ]; then
            sudo rm -rf /usr/bin/casaos
            echo "âœ… æ¸…ç†æ®‹ç•™é”™è¯¯ç›®å½•ï¼š/usr/bin/casaos"
          fi
          echo "âœ… çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: 2. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
          if ! id "roots" &>/dev/null; then
            sudo useradd -m -s /bin/bash roots
            # è®¾ç½®å¯†ç ï¼ˆä¼˜å…ˆä½¿ç”¨å¯†é’¥ï¼Œæ— åˆ™ç”Ÿæˆéšæœºå¯†ç ï¼‰
            if [ -n " $ ROOTS_PASSWORD" ]; then
              echo "roots: $ ROOTS_PASSWORD" | sudo chpasswd
            else
              RANDOM_PASS= $ (openssl rand -base64 12)
              echo "roots: $ RANDOM_PASS" | sudo chpasswd
              echo "âœ… rootsç”¨æˆ·åˆ›å»ºå®Œæˆï¼Œéšæœºå¯†ç ï¼š $ RANDOM_PASS"
            fi
            # æ·»åŠ sudoå’Œdockeræƒé™
            sudo usermod -aG sudo,root,docker roots
          fi
          echo "âœ… ç®¡ç†å‘˜ç”¨æˆ·é…ç½®å®Œæˆ"

      - name: 3. é…ç½®Rclone WebDAV
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          # æ ¡éªŒWebDAVå‡­è¯æ˜¯å¦å®Œæ•´
          if [ -z " $ WEBDAV_URL" ] || [ -z " $ WEBDAV_USER" ] || [ -z " $ WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> " $ GITHUB_ENV"
            exit 0
          fi
          # é…ç½®rcloneè¿žæŽ¥WebDAV
          ENCRYPTED_PASS= $ (rclone obscure " $ WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url=" $ WEBDAV_URL" \
            vendor="other" \ # ä¿®å¤ç‚¹ï¼šæ”¹ä¸ºotheræˆ–æŒ‡å®šæ­£ç¡®vendorï¼Œwebdavå¯èƒ½ä¸å‡†ç¡®
            user=" $ WEBDAV_USER" \
            pass=" $ ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf
          # è®¾ç½®rcloneé…ç½®æ–‡ä»¶æƒé™
          sudo chown runner:runner /home/runner/.rclone.conf
          sudo chmod 600 /home/runner/.rclone.conf
          # æ ¡éªŒWebDAVè¿žé€šæ€§
          if ! rclone ls mywebdav:/ --config /home/runner/.rclone.conf >/dev/null 2>&1; then
            echo "âŒ WebDAVè¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½/æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> " $ GITHUB_ENV"
            exit 0
          fi
          # åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          rclone mkdir mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR} --config /home/runner/.rclone.conf
          # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½å¿«ç…§
          REMOTE_SNAPSHOTS= $ (rclone lsf mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR} --mode=Time --reverse --config /home/runner/.rclone.conf | grep "casaos-full-snapshot-.*.tar.gz")
          if [ -n " $ REMOTE_SNAPSHOTS" ]; then
            LATEST_SNAPSHOT_FILENAME= $ (echo " $ REMOTE_SNAPSHOTS" | head -n1)
            LATEST_SNAPSHOT=" $ {WEBDAV_SNAPSHOT_EN_DIR}/ $ {LATEST_SNAPSHOT_FILENAME}"
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¤‡ä»½å¿«ç…§ï¼š $ {LATEST_SNAPSHOT}"
            echo "LATEST_SNAPSHOT= $ {LATEST_SNAPSHOT}" >> " $ GITHUB_ENV"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å¤‡ä»½å¿«ç…§ï¼Œå°†å…¨æ–°å®‰è£…CasaOS"
          fi
          echo "âœ… Rclone WebDAVé…ç½®å®Œæˆ"

      - name: 4. ä»ŽWebDAVæ¢å¤CasaOSå¿«ç…§
        if:  $ {{ env.WEBDAV_AVAILABLE == 'true' && env.LATEST_SNAPSHOT != '' }}
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹æ¢å¤å¿«ç…§ï¼š $ {LATEST_SNAPSHOT} ====="
          
          # === ä¿®å¤ç‚¹ï¼šç§»é™¤äº†ä¸å­˜åœ¨çš„ docker.socket ===
          # åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡ï¼ˆç¡®ä¿æ–‡ä»¶ä¸è¢«å ç”¨ï¼‰
          sudo systemctl stop docker casaos 2>/dev/null || true
          sudo pkill -9 docker || true
          sudo pkill -9 casaos || true
          sudo fuser -k /var/lib/docker /var/lib/casaos /DATA 2>/dev/null || true
          sync && sleep 5
          echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢ï¼Œå‡†å¤‡æ¢å¤"
          
          # æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
          if ! rclone cat mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | head -c 10240 >/dev/null 2>&1; then
            echo "âŒ å¿«ç…§æ–‡ä»¶æŸåï¼Œåœæ­¢æ¢å¤"
            echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
            exit 1
          fi
          
          # === ä¿®å¤ç‚¹ï¼šç§»é™¤äº† --absolute-namesï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„è§£åŽ‹ ===
          # è§£åŽ‹æ¢å¤å¿«ç…§ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
          rclone cat mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / \
            --overwrite --preserve-permissions --preserve-links \
            --warning=no-file-changed --no-ignore-failed-read \
             $ EXCLUDE_RULES
            
          if [  $ ? -ne 0 ]; then
            echo "âŒ å¿«ç…§æ¢å¤å¤±è´¥"
            echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
            exit 1
          fi
          
          # æ ¡éªŒæ¢å¤åŽçš„æ ‡è¯†æ–‡ä»¶
          if [ ! -f "/var/lib/casaos/ $ {BACKUP_MARK}.flag" ]; then
            echo "âŒ å¿«ç…§æ¢å¤ä¸å®Œæ•´ï¼Œç¼ºå°‘æ ‡è¯†æ–‡ä»¶"
            echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
            exit 1
          fi
          
          # ä¿®å¤æ–‡ä»¶æƒé™
          sudo chown -R root:root /etc /usr /bin /sbin /lib /lib64
          sudo chown -R root:docker /var/lib/docker /etc/docker
          sudo chown -R casaos:casaos /var/lib/casaos /etc/casaos
          sudo chmod -R 755 /usr/bin /usr/sbin /bin /sbin
          sudo chmod -R 775 /DATA
          sync && sleep 3
          
          # åˆ é™¤å·²æ¢å¤çš„å¿«ç…§ï¼ˆé¿å…é‡å¤æ¢å¤ï¼‰
          rclone delete mywebdav: $ {LATEST_SNAPSHOT} --config /home/runner/.rclone.conf
          rclone delete mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR}/snapshot_full_meta.txt --config /home/runner/.rclone.conf
          
          echo "âœ… å¿«ç…§æ¢å¤å®Œæˆ"
          echo "SNAPSHOT_RESTORED=true" >> " $ GITHUB_ENV"

      - name: 5. å…¨æ–°å®‰è£…CasaOSï¼ˆæ— å¿«ç…§æ—¶å…œåº•ï¼‰
        if:  $ {{ env.SNAPSHOT_RESTORED != 'true' }}
        run: |
          # å…³é—­å…¨å±€set -eï¼Œä»…æ‰‹åŠ¨åˆ¤æ–­å…³é”®é”™è¯¯
          set +e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          echo "===== å¼€å§‹å…¨æ–°å®‰è£…CasaOS ====="
          
          # å½»åº•æ¸…ç†æ®‹ç•™æ–‡ä»¶/ç›®å½•
          sudo rm -rf /usr/bin/casaos /etc/casaos /var/lib/casaos /usr/lib/casaos 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo systemctl reset-failed casaos 2>/dev/null || true
          
          # å®‰è£…CasaOSä¾èµ–
          sudo apt install -y cgroupfs-mount fuse3 dbus avahi-daemon libssl-dev libcurl4-openssl-dev libnss-mdns || true
          
          # === ä¿®å¤ç‚¹ï¼šæ·»åŠ äº†URLæœ«å°¾çš„æ–œæ  ===
          # ä¸‹è½½å¹¶æ‰§è¡Œå®˜æ–¹å®‰è£…è„šæœ¬ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
          curl -fsSL https://get.casaos.io/ -o /tmp/casaos_install.sh
          sudo chmod +x /tmp/casaos_install.sh
          
          INSTALL_SUCCESS=false
          for i in 1 2 3; do
            echo "ðŸ“Œ ç¬¬ $ iæ¬¡å°è¯•å®‰è£…CasaOS"
            sudo /tmp/casaos_install.sh 2>&1 | tee /var/log/casaos-install- $ i.log
            # æ ¡éªŒå®‰è£…æ˜¯å¦æˆåŠŸï¼ˆå¯æ‰§è¡Œæ–‡ä»¶+æœåŠ¡è¿è¡Œï¼‰
            if [ -f "/usr/bin/casaos" ] && [ -x "/usr/bin/casaos" ] && sudo systemctl is-active --quiet casaos; then
              INSTALL_SUCCESS=true
              echo "âœ… CasaOSå®‰è£…æˆåŠŸï¼ˆç¬¬ $ iæ¬¡å°è¯•ï¼‰"
              break
            else
              echo "âš ï¸ ç¬¬ $ iæ¬¡å®‰è£…å¤±è´¥ï¼Œæ¸…ç†æ®‹ç•™åŽé‡è¯•"
              sudo rm -rf /usr/bin/casaos /etc/casaos /var/lib/casaos 2>/dev/null || true
              sleep 5
            fi
          done
          
          # æœ€ç»ˆæ ¡éªŒï¼Œå¤±è´¥åˆ™é€€å‡º
          if [ " $ INSTALL_SUCCESS" = "false" ]; then
            echo "âŒ CasaOSå®‰è£…å¤±è´¥ï¼Œæœ€åŽä¸€æ¬¡æ—¥å¿—ï¼š"
            cat /var/log/casaos-install-3.log
            exit 1
          fi
          
          # è¡¥å…¨ç³»ç»Ÿä¾èµ–
          sudo apt install -y --fix-missing || true
          
          # åˆ›å»ºå¤‡ä»½æ ‡è¯†æ–‡ä»¶
          sudo mkdir -p /var/lib/casaos
          sudo touch /var/lib/casaos/ $ {BACKUP_MARK}.flag
          echo "âœ… CasaOSå…¨æ–°å®‰è£…å®Œæˆ"
          echo "SNAPSHOT_RESTORED=false" >> " $ GITHUB_ENV"
          # å¼ºåˆ¶è¿”å›ž0ï¼Œé¿å…éžå…³é”®é”™è¯¯å¯¼è‡´æ­¥éª¤å¤±è´¥
          exit 0

      - name: 6. å¯åŠ¨å¹¶æ ¡éªŒCasaOSæœåŠ¡ï¼ˆæ¢å¤/å®‰è£…åŽï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          
          # === ä¿®å¤ç‚¹ï¼šç§»é™¤äº†ä¸å­˜åœ¨çš„ docker.socket ===
          # å¯åŠ¨DockeræœåŠ¡ï¼ˆæœ€å¤šé‡è¯•5æ¬¡ï¼‰
          for i in 1 2 3 4 5; do
            sudo systemctl enable --now docker
            sleep 8
            if sudo systemctl is-active --quiet docker; then
              echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            sudo systemctl reset-failed docker
            echo "âš ï¸ Dockerå¯åŠ¨ç¬¬ $ iæ¬¡é‡è¯•"
            # æœ€åŽä¸€æ¬¡é‡è¯•æ—¶é‡è£…Docker
            if [  $ i -eq 5 ]; then
              echo "ðŸ“Œ é‡è£…Dockerä¿®å¤å¯åŠ¨é—®é¢˜"
              sudo apt reinstall -y docker-ce docker-ce-cli containerd.io
              sudo systemctl enable --now docker
            fi
          done
          
          # å¯åŠ¨CasaOSæœåŠ¡
          sudo systemctl enable --now casaos
          sleep 5
          if sudo systemctl is-active --quiet casaos; then
            echo "âœ… CasaOSæœåŠ¡å¯åŠ¨æˆåŠŸ"
          else
            echo "âš ï¸ CasaOSæœåŠ¡æœªå¯åŠ¨ï¼Œå°è¯•æ‰‹åŠ¨å¯åŠ¨"
            sudo journalctl -u casaos -n 50
            sudo systemctl reset-failed casaos
            sudo systemctl start casaos
          fi
          
          # æ ¡éªŒå®¹å™¨è¿è¡ŒçŠ¶æ€
          sleep 5
          if sudo docker ps | grep -q casaos; then
            echo "âœ… CasaOSå®¹å™¨è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸ CasaOSå®¹å™¨æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨"
            sudo docker start  $ (sudo docker ps -a | grep casaos | awk '{print  $ 1}')
          fi
          
          # è¾“å‡ºCasaOSè®¿é—®åœ°å€
          CASAOS_IP= $ (hostname -I | awk '{print  $ 1}')
          echo "âœ… CasaOSæœåŠ¡å¯ç”¨ï¼Œè®¿é—®åœ°å€ï¼šhttp:// $ {CASAOS_IP}"

      - name: 7. éƒ¨ç½²Tailscaleï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=en_US.UTF-8
          # æ— å¯†é’¥åˆ™è·³è¿‡
          if [ -z " $ TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ Tailscaleå¯†é’¥ç¼ºå¤±ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
          # å®‰è£…Tailscale
          sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y && sudo apt install -y tailscale
          # å¯åŠ¨å¹¶è®¤è¯Tailscale
          TAILSCALE_PATH= $ (which tailscale)
          if [ -z " $ TAILSCALE_PATH" ]; then
            echo "âŒ Tailscaleå®‰è£…å¤±è´¥"
            exit 0
          fi
          sudo " $ TAILSCALE_PATH" up --authkey=" $ TAILSCALE_AUTH_KEY" --accept-routes --accept-dns --hostname="casaos-full-snap- $ {{ github.run_id }}"
          # è¾“å‡ºTailscale IP
          TAILSCALE_IP= $ (sudo " $ TAILSCALE_PATH" ip -4)
          echo "âœ… Tailscaleéƒ¨ç½²å®Œæˆï¼ŒIPï¼š $ {TAILSCALE_IP}"

      - name: 8. å…¨é‡å¤‡ä»½CasaOSåˆ°WebDAV
        run: |
          set -e
          export LC_ALL=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          start_time= $ (date +%s)
          RENEW_TRIGGERED=false

          # ç»­è·‘è§¦å‘å‡½æ•°
          trigger_renew() {
            if [ -z " $ USER_PAT" ] || [ -z " $ REPO" ]; then
              echo "âŒ ç»­è·‘å‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡ç»­è·‘"
              return 1
            fi
            if ! curl -fsSL --fail -X POST \
              -H "Authorization: token  $ USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/ $ REPO/dispatches" \
              -d '{"event_type":"renew_casaos_snapshot"}'; then
              echo "âŒ ç»­è·‘å·¥ä½œæµè§¦å‘å¤±è´¥"
              return 1
            fi
            echo "âœ… ç»­è·‘å·¥ä½œæµè§¦å‘æˆåŠŸ"
            RENEW_TRIGGERED=true
            return 0
          }

          # æ ¸å¿ƒå¤‡ä»½å‡½æ•°
          full_backup_snapshot() {
            # WebDAVä¸å¯ç”¨åˆ™é€€å‡º
            if [ " $ {WEBDAV_AVAILABLE}" != "true" ]; then
              return 1
            fi
            # æ ¡éªŒCasaOSçŽ¯å¢ƒæ˜¯å¦å®Œæ•´
            if [ ! -f "/usr/bin/casaos" ] || [ ! -f "/var/lib/casaos/ $ {BACKUP_MARK}.flag" ]; then
              echo "âŒ CasaOSçŽ¯å¢ƒä¸å®Œæ•´ï¼Œæ‹’ç»å¤‡ä»½"
              exit 1
            fi
            echo "âœ… å¤‡ä»½å‰çŽ¯å¢ƒæ ¡éªŒé€šè¿‡"

            # ç”Ÿæˆå¿«ç…§åç§°
            SNAPSHOT_NAME="casaos-full-snapshot- $ (date +%Y%m%d-%H%M%S).tar.gz"
            TMP_SNAPSHOT="/tmp/ $ {SNAPSHOT_NAME}"
            REMOTE_PATH="mywebdav: $ {WEBDAV_SNAPSHOT_EN_DIR}/ $ {SNAPSHOT_NAME}"
            echo "ðŸ”„ å¼€å§‹åˆ›å»ºå¿«ç…§ï¼š $ {SNAPSHOT_NAME}"

            # åœæ­¢æœåŠ¡
            sudo systemctl stop docker casaos
            # === ä¿®å¤ç‚¹ï¼šç§»é™¤äº†ä¸å­˜åœ¨çš„æœåŠ¡å ===
            sudo pkill -9 docker || true
            sudo pkill -9 casaos || true
            sync && sleep 3
            echo "âœ… æœåŠ¡å·²åœæ­¢ï¼Œå¼€å§‹æ‰“åŒ…"

            # === ä¿®å¤ç‚¹ï¼šç§»é™¤äº† --absolute-names ===
            # æ‰“åŒ…å¿«ç…§
            sudo tar -czf " $ {TMP_SNAPSHOT}" \
              --preserve-permissions --preserve-links \
              --preserve-time --ignore-failed-read --warning=no-all \
               $ EXCLUDE_RULES \
               $ CORE_DIRS

            # é‡å¯æœåŠ¡
            sudo systemctl start docker casaos
            echo "âœ… æœåŠ¡å·²é‡å¯"

            # æ ¡éªŒå¿«ç…§å®Œæ•´æ€§
            if [ ! -f " $ {TMP_SNAPSHOT}" ]; then
              echo "âŒ å¿«ç…§æœªç”Ÿæˆ"
              return 1
            fi
            if [  $ (stat -c%s " $ {TMP_SNAPSHOT}") -lt 104857600 ]; then
              echo "âŒ å¿«ç…§å°äºŽ100MBï¼Œåˆ¤å®šä¸ºæ®‹ç¼º"
              return 1
            fi
            if ! tar -tzf " $ {TMP_SNAPSHOT}" | grep -q "/var/lib/casaos"; then
              echo "âŒ å¿«ç…§è§£åŽ‹æµ‹è¯•å¤±è´¥"
              return 1
            fi
            echo "âœ… å¿«ç…§åˆ›å»ºå®Œæˆï¼Œå¤§å°ï¼š $ (du -sh  $ {TMP_SNAPSHOT} | awk '{print  $ 1}')"

            # ä¸Šä¼ å¿«ç…§åˆ°WebDAV
            sudo -u runner rclone copy " $ {TMP_SNAPSHOT}" " $ {REMOTE_PATH}" \
              --config /home/runner/.rclone.conf \
              --transfers 8 --checkers 16 --fast-list --retries 5 \
              --ignore-existing --progress --log-level INFO --log-file /tmp/rclone_full_upload.log
            if [  $ ? -ne 0 ]; then
              echo "âŒ å¿«ç…§ä¸Šä¼ å¤±è´¥ï¼Œæ—¥å¿—ï¼š/tmp/rclone_full_upload.log"
              return 1
            fi

            # ä¸Šä¼ å…ƒæ•°æ®
            META_FILE="/tmp/snapshot_full_meta.txt"
            echo "snapshot_name= $ {SNAPSHOT_NAME}" > " $ {META_FILE}"
            echo "create_time= $ (date -u +%Y-%m-%dT%H:%M:%
