name: CasaOS-VNC-Tailscale-Service
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  run-service:
    runs-on: ubuntu-24.04
    timeout-minutes: 350
    env:
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340
      FIXED_VNC_PWD: "123456789"
      RUNNER_PASSWORD: "runner123"
      CASAOS_PORT: 80
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      CLEAN_INTERVAL: 3600
      B2_BACKUP_BUCKET: "casaos-backup"
      BACKUP_MARKER: "latest_backup.txt"

    steps:
      - name: Step1 - Init System
        id: step1
        continue-on-error: false
        run: |
          echo "Init system start"
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "Update failed"; exit 1; }
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "Upgrade failed"; exit 1; }
          pkgs="tar gzip rsync rclone tigervnc-standalone-server netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release bc"
          sudo apt install -y $pkgs || { echo "Install pkgs failed"; exit 1; }
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          echo "Init system done"

      - name: Step2 - Config B2 Storage
        id: step2
        continue-on-error: false
        run: |
          echo "Config B2 start"
          B2_KEY_ID=${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY=${{ secrets.B2_APPLICATION_KEY }}
          if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
            echo "B2 key empty"; exit 1;
          fi
          mkdir -p ~/.config/rclone
          echo "[b2_backend]" > ~/.config/rclone/rclone.conf
          echo "type = b2" >> ~/.config/rclone/rclone.conf
          echo "account = $B2_KEY_ID" >> ~/.config/rclone/rclone.conf
          echo "key = $B2_APPLICATION_KEY" >> ~/.config/rclone/rclone.conf
          echo "hard_delete = true" >> ~/.config/rclone/rclone.conf
          echo "timeout = 30s" >> ~/.config/rclone/rclone.conf
          echo "retries = 3" >> ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          rclone mkdir b2_backend:${B2_BACKUP_BUCKET}/ || echo "Bucket exists"
          if rclone lsd b2_backend:${B2_BACKUP_BUCKET}/ --verbose --retries 3; then
            echo "B2 connect success"
            echo "B2_STATUS=success" >> $GITHUB_ENV
          else
            echo "B2 connect failed"; exit 1;
          fi
          echo "Config B2 done"

      - name: Step3 - Check Backup & Restore (if exists)
        id: step3
        continue-on-error: false
        run: |
          echo "Check backup start"
          # 核心逻辑：检查到备份就立即恢复，无备份则直接跳过
          if rclone copy b2_backend:${B2_BACKUP_BUCKET}/${BACKUP_MARKER} $BACKUP_DIR/ --timeout 30s; then
            LATEST_BACKUP=$(cat $BACKUP_DIR/${BACKUP_MARKER})
            echo "Found backup: $LATEST_BACKUP → Start restore immediately"
            
            # 立即执行恢复操作（无需后续步骤判断）
            echo "$BACKUP_EXCLUDE" | tr ' ' '\n' | sed 's/--exclude=//g' > $BACKUP_DIR/exclude-list.txt
            rclone cat b2_backend:${B2_BACKUP_BUCKET}/${LATEST_BACKUP} --timeout 120s --retries 3 | sudo tar -zxf - -C / --exclude-from=$BACKUP_DIR/exclude-list.txt 2>/dev/null
            
            if [ $? -eq 0 ]; then
              echo "Backup restore success!"
              echo "HAS_BACKUP=true" >> $GITHUB_ENV
            else
              echo "Backup restore failed → Use new environment"
              echo "HAS_BACKUP=false" >> $GITHUB_ENV
            fi
          else
            echo "No backup found → Skip restore, use new environment"
            echo "HAS_BACKUP=false" >> $GITHUB_ENV
          fi
          echo "Check & restore backup done"

      - name: Step4 - Install CasaOS Only
        id: step4
        continue-on-error: false
        run: |
          echo "Install CasaOS start"
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || { echo "CasaOS warn"; }
          # 恢复场景：恢复后启动CasaOS；全新场景：直接启动CasaOS
          sudo systemctl start casaos
          echo "CasaOS install done (Docker auto-installed by CasaOS)"

      - name: Step5 - Deploy VNC & Tailscale
        id: step5
        continue-on-error: false
        run: |
          echo "Deploy VNC start"
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          echo "#!/bin/bash" > $VNCDIR/xstartup
          echo "export DISPLAY=:0" >> $VNCDIR/xstartup
          echo "export XDG_RUNTIME_DIR=/tmp/runtime-runner" >> $VNCDIR/xstartup
          echo "mkdir -p \$XDG_RUNTIME_DIR && chmod 700 \$XDG_RUNTIME_DIR" >> $VNCDIR/xstartup
          echo "exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title \"CasaOS Console\"" >> $VNCDIR/xstartup
          chmod +x $VNCDIR/xstartup
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth || { echo "VNC start failed"; exit 1; }
          echo "VNC deploy done"
          
          echo "Deploy Tailscale start"
          curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart" || { echo "Tailscale install failed"; exit 1; }
          sudo systemctl enable --now tailscaled && sleep 3
          MAX_RETRIES=3
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              echo "Tailscale IP: $TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1))
            echo "Tailscale retry: $MAX_RETRIES"
            sleep 5
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "Tailscale failed"; exit 1;
          fi
          echo "Tailscale deploy done"

      - name: Step6 - Show Info
        id: step6
        continue-on-error: false
        run: |
          echo "====================================="
          echo "Service Info"
          echo "====================================="
          echo "Run time: $MAX_RUN_MINUTES mins"
          echo "Free space: $(df -h / | awk 'NR==2{print $4}')"
          echo "Runner PWD: $RUNNER_PASSWORD"
          echo "B2 Status: $B2_STATUS"
          echo "VNC: $TAILSCALE_IP:$VNC_PORT (PWD: $FIXED_VNC_PWD)"
          echo "CasaOS: http://$TAILSCALE_IP:$CASAOS_PORT"
          echo "Backup: Only at last 10 mins"
          echo "Data: $(if [ $HAS_BACKUP = 'true' ]; then echo "Restored from backup"; else echo "New environment (no backup)"; fi)"
          echo "====================================="

      - name: Step7 - Core Logic
        id: step7
        continue-on-error: true
        run: |
          echo "Core logic start"
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}

          auto_clean() {
            echo "Clean start"
            BEFORE=$(df -h / | awk 'NR==2{print $4}')
            sudo apt clean -y && sudo apt autoremove -y --purge
            sudo docker system prune -af --volumes 2>/dev/null || true
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null
            AFTER=$(df -h / | awk 'NR==2{print $4}')
            echo "Clean done: $BEFORE -> $AFTER"
          }

          do_backup() {
            echo "Backup start (last 10 mins)"
            TS=$(date +%Y%m%d_%H%M%S)
            BK_NAME="casaos_$TS.tar.gz"
            sudo systemctl stop casaos
            sleep 3
            sudo tar -zcf - $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat b2_backend:${B2_BACKUP_BUCKET}/$BK_NAME --timeout 60s --retries 3
            if [ $? -eq 0 ]; then
              echo "Backup success: $BK_NAME"
              echo "$BK_NAME" > $BACKUP_DIR/$BACKUP_MARKER
              rclone copy $BACKUP_DIR/$BACKUP_MARKER b2_backend:${B2_BACKUP_BUCKET}/ --timeout 30s
            else
              echo "Backup failed"
            fi
            sudo systemctl start casaos
            backup_done=true
          }

          trigger_renew() {
            echo "Trigger renew"
            curl -X POST https://api.github.com/repos/$REPO/dispatches -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_PAT" -d '{"event_type":"renew_vnc"}' --connect-timeout 30s || echo "Renew failed"
          }

          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            free_space=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi

            if (( $(echo "$free_space < 1" | bc -l) )); then
              echo "Low space, clean now"
              auto_clean
              last_clean=$now
            fi

            if [ $((MAX_RUN_MINUTES - run_mins)) -eq 10 ] && [ "$backup_done" = false ]; then
              do_backup
              trigger_renew
            fi

            pgrep -x Xvnc || { echo "VNC restart"; vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth; }
            sudo systemctl is-active --quiet casaos || { echo "CasaOS restart"; sudo systemctl restart casaos; }
            sudo systemctl is-active --quiet tailscaled || { echo "Tailscale restart"; sudo systemctl restart tailscaled; }

            echo "[$(date)] Run mins: $run_mins | Free: $(df -h / | awk 'NR==2{print $4}')"
            sleep 300
          done

      - name: Step8 - Clean Env
        id: step8
        if: always()
        run: |
          echo "Clean env start"
          vncserver -kill $DISPLAY || true && pkill -9 Xvnc || true
          sudo systemctl stop casaos tailscaled || true
          sudo tailscale down || true
          rm -rf $BACKUP_DIR $VNCDIR $NETDISK_ROOT || true
          echo "Clean env done"
