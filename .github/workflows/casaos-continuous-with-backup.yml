name: CasaOS纯净部署（备份保留2份+自动清理+续跑 稳定版）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      CURRENT_WORKFLOW_NAME: "CasaOS纯净部署（备份保留2份+自动清理+续跑 稳定版）"
      CURRENT_WORKFLOW_FILE: "casaos-continuous-with-backup.yml"  # 与实际文件名一致
      TOTAL_TIMEOUT_MINS: 60

    steps:
      - name: 1-系统初始化（海外源+文件容错）
        run: |
          set -e
          echo "===== 系统快速初始化 ====="
          # 海外服务器用Ubuntu官方源，不替换国内镜像
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          # 修复man-db配置文件不存在问题
          if [ ! -f /etc/apt/apt.conf.d/00aptitude ]; then
            sudo touch /etc/apt/apt.conf.d/00aptitude
            echo 'man-db/auto-update boolean false' | sudo tee -a /etc/apt/apt.conf.d/00aptitude >/dev/null
          else
            sudo sed -i 's/^man-db\/auto-update.*/man-db\/auto-update boolean false/' /etc/apt/apt.conf.d/00aptitude
          fi
          echo "✅ 初始化完成"

      - name: 2-强制关闭仓库所有其他工作流（仅保留当前）
        run: |
          set -e
          echo "===== 强制关闭仓库所有其他工作流 ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ] || [ -z "$CURRENT_WORKFLOW_FILE" ]; then
            echo "⚠️ 缺少USER_PAT/REPO/当前工作流文件名配置，跳过关闭其他工作流"
            exit 0
          fi

          echo "📌 当前保留的工作流：文件=$CURRENT_WORKFLOW_FILE | 名称=$CURRENT_WORKFLOW_NAME"
          # 获取仓库内所有工作流
          ALL_WORKFLOWS=$(curl -s -H "Authorization: token $USER_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/workflows" | \
            jq -r '.workflows[] | select(.path != null) | "\(.id)|\(.name)|\(.path)|\(.state)"')

          echo "📌 仓库内所有工作流："
          echo "$ALL_WORKFLOWS"

          # 禁用非当前工作流
          while IFS="|" read -r WORKFLOW_ID WORKFLOW_NAME WORKFLOW_FILE WORKFLOW_STATE; do
            if [ "$WORKFLOW_FILE" = ".github/workflows/$CURRENT_WORKFLOW_FILE" ]; then
              # 确保当前工作流启用
              if [ "$WORKFLOW_STATE" != "active" ]; then
                curl -s -X PUT -H "Authorization: token $USER_PAT" \
                  "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/enable" >/dev/null
                echo "✅ 已启用当前工作流：$WORKFLOW_NAME"
              else
                echo "ℹ️ 跳过当前工作流（已启用）：$WORKFLOW_NAME"
              fi
              continue
            fi
            # 禁用其他工作流
            echo "⚠️ 正在禁用工作流：$WORKFLOW_NAME（文件：$WORKFLOW_FILE）"
            curl -s -X PUT -H "Authorization: token $USER_PAT" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/disable" >/dev/null && echo "✅ 已禁用" || echo "⚠️ 禁用失败"
          done <<< "$ALL_WORKFLOWS"

          # 终止其他运行中实例
          RUNNING_WORKFLOWS=$(curl -s -H "Authorization: token $USER_PAT" \
            "https://api.github.com/repos/$REPO/actions/runs?status=in_progress" | \
            jq -r '.workflow_runs[] | select(.workflow_name != "'"$CURRENT_WORKFLOW_NAME"'") | "\(.id)|\(.workflow_name)"')
          if [ -n "$RUNNING_WORKFLOWS" ]; then
            while IFS="|" read -r RUN_ID WORKFLOW_NAME; do
              echo "⚠️ 终止运行中工作流：$WORKFLOW_NAME（Run ID：$RUN_ID）"
              curl -s -X POST -H "Authorization: token $USER_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/cancel" >/dev/null
            done <<< "$RUNNING_WORKFLOWS"
          else
            echo "✅ 无其他运行中工作流"
          fi

          echo "✅ 仅当前工作流可执行"

      - name: 3-旧版Docker安装（apt直接安装，无等待）
        run: |
          set -e
          echo "===== 旧版Docker安装（无交互+无等待） ====="
          # 1. 卸载旧版本+清理残留（旧版逻辑）
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo rm -rf /var/lib/docker /var/lib/containerd /etc/docker 2>/dev/null || true
          sudo rm -f /etc/apt/sources.list.d/docker.list 2>/dev/null || true

          # 2. 添加Docker官方GPG密钥（旧版验证方式）
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

          # 3. 添加Docker官方源（海外版，无镜像）
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

          # 4. apt直接安装核心组件（旧版核心逻辑，无任何等待）
          sudo apt update -y -qq
          DEBIAN_FRONTEND=noninteractive sudo apt install -y --no-install-recommends \
            docker-ce docker-ce-cli containerd.io docker-compose-plugin -qq

          # 5. 启动服务+配置权限
          sudo systemctl enable --now docker containerd && sleep 1
          sudo usermod -aG docker runner
          docker --version && docker compose version
          echo "✅ Docker安装完成（旧版逻辑，无等待）"

      - name: 4-创建免密管理员用户（安全优化）
        run: |
          set -e
          echo "===== 创建管理员用户 ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "🔑 随机密码：$RANDOM_PASS"
          fi
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "✅ 用户配置完成"

      - name: 5-WebDAV配置+快照检测（超时优化）
        run: |
          set -e
          echo "===== WebDAV配置&快照检测 ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "⚠️ WebDAV凭证缺失，跳过备份"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          # 创建远程目录（超时30秒）
          if ! rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf --timeout 30s; then
            echo "❌ WebDAV不可达，跳过备份"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # 检测最新快照
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "✅ 找到最新快照：$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "✅ 首次部署无快照"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: 6-纯净安装CasaOS（仅程序）
        run: |
          set -e
          echo "===== 安装纯净CasaOS ====="
          # 清理旧服务
          sudo systemctl stop casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          # 非交互安装
          DEBIAN_FRONTEND=noninteractive curl -fsSL https://get.casaos.io | sudo bash -s -- --force
          sudo systemctl stop casaos 2>/dev/null || true
          echo "✅ CasaOS安装完成"

      - name: 7-恢复个人数据（防错乱优化）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== 恢复个人数据 ====="
          # 停止服务避免冲突
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd 2>/dev/null || true
          # 预创建目录
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          echo "📌 仅恢复目录：$PERSONAL_DATA_DIRS"
          # 恢复数据并保留权限
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          # 校正权限
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          # 删除已恢复的快照
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "✅ 数据恢复完成，无错乱"

      - name: 8-权限校正+极速启动服务
        run: |
          set -e
          echo "===== 启动服务 ====="
          # 预创建目录
          sudo mkdir -p /etc/casaos /var/lib/casaos /DATA /run/docker 2>/dev/null || true
          # 校正权限
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          # 终止占用端口进程
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          # 启动服务
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 2
          sudo systemctl enable --now casaos && sleep 3
          # 检测服务状态
          if sudo systemctl is-active --quiet casaos; then
            echo "✅ CasaOS服务已正常启动"
          else
            echo "⚠️ CasaOS启动异常，强制重启"
            sudo systemctl restart casaos && sleep 2
          fi
          echo "✅ 服务启动完成，访问服务器IP（80端口）初始化"

      - name: 9-Tailscale远程组网（可选）
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then exit 0; fi
          echo "===== 配置Tailscale远程组网 ====="
          # 安装Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && DEBIAN_FRONTEND=noninteractive sudo apt install -y tailscale -qq
          # 启动并组网
          sudo systemctl enable --now tailscaled && sleep 1
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "未获取")
          echo "✅ Tailscale组网完成，远程IP：$TAILSCALE_IP"

      - name: 10-个人数据备份+进度+剩余时间+自动续跑（核心优化）
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== 个人数据备份（保留2份+自动清理+续跑） ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false

          # 清理旧备份（仅保留最新2份）
          cleanup_old_backups(){
            echo "📌 开始清理旧备份（保留最新${KEEP_BACKUPS}份）"
            BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
            BACKUP_COUNT=$(echo "$BACKUPS" | wc -l)
            if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ]; then
              DELETE_COUNT=$((BACKUP_COUNT - KEEP_BACKUPS))
              DELETE_LIST=$(echo "$BACKUPS" | tail -n $DELETE_COUNT)
              echo "⚠️
