name: CasaOS纯净部署（Tailscale内网版 /aaa目录 拉取即删 检测删除）
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"
      TARGET_RUN_MINUTES: 5  # 已改为 5 分钟

    steps:
      - name: 1-系统初始化+全域深度清理
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 1-系统初始化+全域深度清理 ====="
          sudo apt update -y -qq
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server -qq
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo rm -rf /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y 2>/dev/null || true
          sudo DEBIAN_FRONTEND=noninteractive apt clean 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true
          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          sudo systemctl enable --now ssh
          echo "✅ 系统初始化+清理完成"

      - name: 2-官方纯净安装 Docker（官方源·无交互）
        run: |
          set -e
          echo "===== 2-安装 Docker（官方源·静默无交互） ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash
          sudo systemctl enable docker containerd
          sudo systemctl stop docker containerd 2>/dev/null || true
          docker --version || true
          sudo usermod -aG docker runner
          echo "✅ Docker 官方安装完成，已停止"

      - name: 3-官方纯净安装 CasaOS（装完立即停止）
        run: |
          set -e
          echo "===== 3-安装 CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          echo "✅ CasaOS 安装完成，已停止"

      - name: 4-创建 roots 管理员+免密+SSH密码登录
        run: |
          set -e
          echo "===== 4-配置管理员用户 ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          echo "$USER_NAME:$SSH_PASS" | sudo chpasswd
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config 2>/dev/null
          sudo sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null
          sudo systemctl restart ssh
          echo "✅ 管理员配置完成"

      - name: 5-Tailscale 组网+自动发现所有在线CasaOS机器
        run: |
          set -e
          echo "===== 5-Tailscale组网+自动搜索CasaOS ====="
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "⚠️ Tailscale未配置，无法内网"
            echo "HAS_CASAOS_PEERS=false" >> $GITHUB_ENV
            exit 0
          fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq
          sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          TS_HOSTNAME="CasaOS-$(head -c4 /dev/urandom | xxd -p -c4)"
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$TS_HOSTNAME" --accept-routes
          sudo tailscale status --json | jq -r '.Peer[] | select(.Hostname | contains("CasaOS") and .Online == true) | .Hostname' | grep -v "$TS_HOSTNAME" | sort | uniq > /tmp/casaos_peers.txt
          if [ -s /tmp/casaos_peers.txt ]; then
            echo "🔍 发现内网CasaOS："
            cat /tmp/casaos_peers.txt
            echo "HAS_CASAOS_PEERS=true" >> $GITHUB_ENV
          else
            echo "ℹ️ 无其他CasaOS机器"
            echo "HAS_CASAOS_PEERS=false" >> $GITHUB_ENV
          fi

      - name: 6-从内网/aaa拉最新备份→删除远程→本地恢复+权限校正
        run: |
          set -e
          echo "===== 6-从/aaa拉备份→删远程→恢复 ====="
          if [ "$HAS_CASAOS_PEERS" != "true" ]; then
            echo "ℹ️ 无机器，纯净启动"
            exit 0
          fi
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sync && sleep 2
          LATEST_FILE=""
          TARGET_HOST=""
          while IFS= read -r host; do
            FILE=$(sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 "$SSH_USER@$host" "ls -t $REMOTE_BACKUP_BASE/casaos-*.tar.gz 2>/dev/null | head -1")
            if [ -n "$FILE" ]; then
              LATEST_FILE="$FILE"
              TARGET_HOST="$host"
              break
            fi
          done < /tmp/casaos_peers.txt
          if [ -z "$LATEST_FILE" ]; then
            echo "ℹ️ 无备份，纯净启动"
            exit 0
          fi
          echo "✅ 从 $TARGET_HOST 取备份: $LATEST_FILE"
          sudo mkdir -p "$LOCAL_BACKUP_DIR"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$(basename $LATEST_FILE)"
          sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_HOST:$LATEST_FILE" "$LOCAL_FILE"
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_HOST" "rm -f $LATEST_FILE"
          echo "✅ 远程源文件已删除"
          sudo tar -xzf "$LOCAL_FILE" -C / --overwrite --preserve-permissions
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          echo "✅ 恢复+权限校正完成"

      - name: 7-启动 Docker & CasaOS
        run: |
          set -e
          echo "===== 7-启动核心服务 ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          sudo systemctl enable --now casaos && sleep 4
          echo "✅ CasaOS 正常启动完成"

      - name: 8-延时满5分钟再备份
        run: |
          set -e
          echo "===== 8-延时 5 分钟 ====="
          START=$(date +%s)
          sleep 5
          USED=$(( $(date +%s) - START ))
          WAIT=$(( TARGET_RUN_MINUTES*60 - USED ))
          [ $WAIT -gt 0 ] && sleep $WAIT
          echo "✅ 已稳定运行 5 分钟"

      - name: 9-停止所有服务（安全备份）
        run: |
          set -e
          echo "===== 9-停止所有服务（安全备份） ====="
          sudo systemctl stop casaos docker containerd tailscaled 2>/dev/null || true
          sudo pkill -9 -f "casaos|docker|containerd|tailscaled" 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sync && sleep 5
          echo "✅ 已停止，可安全备份"

      - name: 10-本地全量备份
        run: |
          set -e
          echo "===== 10-生成本地全量备份 ====="
          sudo mkdir -p "$LOCAL_BACKUP_DIR"
          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.gz"
          LOCAL_FILE="$LOCAL_BACKUP_DIR/$SNAP_NAME"
          sudo tar -czPf "$LOCAL_FILE" $EXCLUDE_RULES $PERSONAL_DATA_DIRS
          echo "✅ 备份完成: $SNAP_NAME"
          echo "BACKUP_FILE=$LOCAL_FILE" >> $GITHUB_ENV
          echo "SNAP_NAME=$SNAP_NAME" >> $GITHUB_ENV

      - name: 11-备份完成→立即触发续跑
        run: |
          set -e
          echo "===== 11-触发下一轮续跑 ====="
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            curl -s -f -X POST \
              -H "Authorization: token $USER_PAT" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/dispatches \
              -d '{"event_type":"renew_casaos_snapshot"}' >/dev/null 2>&1
            [ $? -eq 0 ] && echo "✅ 续跑触发成功" || echo "⚠️ 续跑失败"
          fi

      - name: 12-同步到所有机器/aaa→检测文件被删除后继续
        run: |
          set -e
          echo "===== 12-同步到所有机器/aaa并检测删除 ====="
          if [ "$HAS_CASAOS_PEERS" != "true" ]; then
            echo "ℹ️ 无其他机器，跳过同步"
            exit 0
          fi
          while IFS= read -r host; do
            sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$host" "sudo mkdir -p $REMOTE_BACKUP_BASE"
            sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no "$BACKUP_FILE" "$SSH_USER@$host:$REMOTE_BACKUP_BASE/$SNAP_NAME"
            echo "✅ 已同步到 $host:$REMOTE_BACKUP_BASE/$SNAP_NAME"
          done < /tmp/casaos_peers.txt
          echo "🔍 等待远程文件被删除..."
          while true; do
            FOUND=0
            while IFS= read -r host; do
              sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 "$SSH_USER@$host" "ls $REMOTE_BACKUP_BASE/$SNAP_NAME 2>/dev/null" && FOUND=1 && break
            done < /tmp/casaos_peers.txt
            [ $FOUND -eq 0 ] && break
            sleep 3
          done
          echo "✅ 检测到文件已删除，进入收尾"

      - name: 13-敏感清理+流程完结
        if: ${{ always() }}
        run: |
          set -e
          echo "===== 13-清理+完结 ====="
          sudo rm -rf "$LOCAL_BACKUP_DIR" /tmp/* /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "✅ 敏感信息清理完成"
          echo "🎉 CasaOS 部署+内网备份恢复同步 全流程完成"