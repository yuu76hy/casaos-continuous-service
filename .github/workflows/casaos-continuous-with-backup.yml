name: CasaOS+VNC+Tailscale æŒç»­æœåŠ¡ï¼ˆå†…å­˜å¤‡ä»½+å®šæ—¶æ¸…ç†ç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  casaos-vnc-server:
    runs-on: ubuntu-24.04
    timeout-minutes: 350
    env:
      DISPLAY: :0
      VNCDIR: /home/runner/.vnc
      VNC_PORT: 5900
      MAX_RUN_MINUTES: 340
      FIXED_VNC_PWD: "123456789"
      CASAOS_PORT: 80
      NETDISK_ROOT: /home/runner/netdisk
      BACKUP_DIR: /home/runner/backup
      INC_BACKUP_BASE: "casaos_base.tar.gz"
      KEEP_BACKUP_NUM: 2
      BACKUP_EXCLUDE: "--exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/dev --exclude=/run --exclude=/var/run --exclude=/home/runner/actions-runner --exclude=/var/lib/docker/overlay2"
      RUNNER_PASSWORD: "runner123"
      # åƒåœ¾æ¸…ç†é—´éš”ï¼ˆ3600ç§’=1å°æ—¶ï¼‰
      CLEAN_INTERVAL: 3600
    steps:
      - name: ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–æ›´æ–°
        id: init_env
        continue-on-error: false
        run: |
          echo "===== åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ ====="
          sudo apt update -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿæ›´æ–°å¤±è´¥"; exit 1; }
          sudo apt upgrade -y 2>&1 | grep -v "restart" || { echo "ç³»ç»Ÿå‡çº§å¤±è´¥"; exit 1; }
          sudo apt install -y tar gzip rsync rclone tigervnc-standalone-server netcat-openbsd psmisc curl git wget vim nano python3 python3-pip ca-certificates gnupg lsb-release || { echo "ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          
          # ä¸º runner ç”¨æˆ·è®¾ç½®å¯†ç 
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          echo "===== runner ç”¨æˆ·å¯†ç å·²è®¾ç½® ====="
          
          sudo mkdir -p $BACKUP_DIR $NETDISK_ROOT
          sudo chown -R runner:runner $BACKUP_DIR $NETDISK_ROOT
          sudo chmod -R 755 $BACKUP_DIR $NETDISK_ROOT
          echo "===== ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ ====="

      - name: é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆrcloneï¼‰
        id: config_rclone
        continue-on-error: false
        env:
          OSS_CONFIG: ${{ secrets.OSS_CONFIG }}
        run: |
          echo "===== é…ç½®å¯¹è±¡å­˜å‚¨ ====="
          export OSS_ENDPOINT=$(echo "$OSS_CONFIG" | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /endpoint:/){gsub("endpoint:","",$i);print $i}}}')
          export OSS_AK=$(echo "$OSS_CONFIG" | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /ak:/){gsub("ak:","",$i);print $i}}}')
          export OSS_SK=$(echo "$OSS_CONFIG" | awk -F';' '{for(i=1;i<=NF;i++){if($i ~ /sk:/){gsub("sk:","",$i);print $i}}}')
          
          mkdir -p ~/.config/rclone
          echo "[oss]" > ~/.config/rclone/rclone.conf
          echo "type = s3" >> ~/.config/rclone/rclone.conf
          echo "provider = Other" >> ~/.config/rclone/rclone.conf
          echo "endpoint = $OSS_ENDPOINT" >> ~/.config/rclone/rclone.conf
          echo "access_key_id = $OSS_AK" >> ~/.config/rclone/rclone.conf
          echo "secret_access_key = $OSS_SK" >> ~/.config/rclone/rclone.conf
          
          chmod 600 ~/.config/rclone/rclone.conf
          if rclone lsd oss:casaos-backup/; then
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥æˆåŠŸ"
            echo "OSS_CONNECT_STATUS=âœ… æˆåŠŸ" >> $GITHUB_ENV
          else
            echo "å¯¹è±¡å­˜å‚¨è¿æ¥å¤±è´¥"; exit 1;
          fi
          echo "===== å¯¹è±¡å­˜å‚¨é…ç½®å®Œæˆ ====="

      - name: æ¢å¤å¢é‡å¤‡ä»½ç´¢å¼•ï¼ˆä»…ç´¢å¼•ï¼Œæ— æ•°æ®ï¼‰
        id: restore_backup_index
        continue-on-error: true
        run: |
          echo "===== æ¢å¤å¢é‡å¤‡ä»½ç´¢å¼• ====="
          rclone copy oss:casaos-backup/backup.snar $BACKUP_DIR/ || { echo "æ— å†å²å¢é‡ç´¢å¼•ï¼Œè·³è¿‡æ¢å¤"; exit 0; }
          rclone copy oss:casaos-backup/current_full_backup.txt $BACKUP_DIR/ || true
          echo "å¢é‡å¤‡ä»½ç´¢å¼•æ¢å¤å®Œæˆ"

      - name: å®‰è£… Docker + CasaOS
        id: install_services
        continue-on-error: true
        run: |
          echo "===== å®‰è£… Docker å¼•æ“ ====="
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
          sudo apt update -y 2>&1 | grep -v "restart" && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
          sudo systemctl start docker && sudo systemctl enable docker
          
          echo "===== å®‰è£… CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash 2>&1 | grep -v "restart" || echo "è­¦å‘Šï¼šCasaOSå®‰è£…å¤±è´¥"
          sleep 10 && sudo systemctl start casaos || echo "CasaOSå¯åŠ¨å¤±è´¥"
          echo "===== æœåŠ¡å®‰è£…å®Œæˆ ====="

      - name: é…ç½® VNC + Tailscale
        id: deploy_core
        continue-on-error: true
        run: |
          echo "===== é…ç½® VNC æœåŠ¡ ====="
          mkdir -p $VNCDIR && chmod 700 $VNCDIR
          echo "$FIXED_VNC_PWD" | vncpasswd -f > $VNCDIR/passwd && chmod 600 $VNCDIR/passwd
          
          echo "#!/bin/bash" > $VNCDIR/xstartup
          echo "export DISPLAY=:0" >> $VNCDIR/xstartup
          echo "export XDG_RUNTIME_DIR=/tmp/runtime-runner" >> $VNCDIR/xstartup
          echo "mkdir -p \$XDG_RUNTIME_DIR && chmod 700 \$XDG_RUNTIME_DIR" >> $VNCDIR/xstartup
          echo "exec /usr/bin/xterm -geometry 140x40+0+0 -ls -title \"CasaOSæœåŠ¡\"" >> $VNCDIR/xstartup
          chmod +x $VNCDIR/xstartup
          
          pgrep -x Xvnc && vncserver -kill $DISPLAY || true
          vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth || echo "VNCå¯åŠ¨å¤±è´¥"
          
          echo "===== é…ç½® Tailscale ç»„ç½‘ ====="
          curl -fsSL https://tailscale.com/install.sh | sudo sh 2>&1 | grep -v "restart" || echo "Tailscaleå®‰è£…å¤±è´¥"
          sudo systemctl enable --now tailscaled && sleep 3
          MAX_RETRIES=3
          while [ $MAX_RETRIES -gt 0 ]; do
            if sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} --accept-routes=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              break
            fi
            MAX_RETRIES=$((MAX_RETRIES-1)) && sleep 5
          done
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "===== æ ¸å¿ƒæœåŠ¡éƒ¨ç½²å®Œæˆ ====="

      - name: è¾“å‡ºè¯¦ç»†æœåŠ¡çŠ¶æ€ä¿¡æ¯
        id: output_info
        continue-on-error: false
        run: |
          echo -e "\n========================================"
          echo -e " ğŸš€ æœåŠ¡éƒ¨ç½²å®Œæˆ - è¯¦ç»†çŠ¶æ€æ±‡æ€»"
          echo -e "========================================"
          echo -e " ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯ | å¯ç”¨ç©ºé—´: $(df -h / | awk 'NR==2{print $4}')"
          echo -e "   - runnerå¯†ç : \033[1;32m${RUNNER_PASSWORD}\033[0m"
          echo -e " ğŸ“¦ å¯¹è±¡å­˜å‚¨ | çŠ¶æ€: ${OSS_CONNECT_STATUS}"
          echo -e " ğŸ”— è®¿é—®åœ°å€ | VNC: ${TAILSCALE_IP:-æœªè·å–}:${VNC_PORT} | CasaOS: http://${TAILSCALE_IP:-æœªè·å–}:${CASAOS_PORT}"
          echo -e " ğŸ“‹ å¤‡ä»½ç­–ç•¥ | å…¨é‡+å¢é‡ï¼ˆå†…å­˜ç›´ä¼ ï¼Œä¸è½åœ°ï¼‰"
          echo -e " ğŸ§¹ æ¸…ç†ç­–ç•¥ | æ¯1å°æ—¶è‡ªåŠ¨æ‰«æå¹¶æ¸…é™¤åƒåœ¾æ•°æ®"
          echo -e "========================================\n"

      - name: ä¿æ´»+ç»­è·‘+å†…å­˜ç›´ä¼ å¤‡ä»½+å®šæ—¶æ¸…ç†æ ¸å¿ƒé€»è¾‘
        id: core_logic
        continue-on-error: true
        run: |
          echo "===== å¯åŠ¨ä¿æ´»+å¤‡ä»½+å®šæ—¶æ¸…ç†ç›‘æ§ ====="
          start_time=$(date +%s)
          last_backup_time=$start_time
          last_clean_time=$start_time  # è®°å½•ä¸Šæ¬¡æ¸…ç†æ—¶é—´

          # å…¨é‡å¤‡ä»½ï¼šå†…å­˜ç›´ä¼ 
          full_backup() {
            echo "===== å†…å­˜ç›´ä¼  - åˆ›å»ºå…¨é‡å¤‡ä»½ ====="
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            FULL_BACKUP_NAME="casaos_full_${TIMESTAMP}.tar.gz"
            sudo tar -zcf - $BACKUP_EXCLUDE / --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat oss:casaos-backup/${FULL_BACKUP_NAME}
            if [ $? -eq 0 ]; then
              echo "å…¨é‡å¤‡ä»½å†…å­˜ç›´ä¼ æˆåŠŸï¼šoss:casaos-backup/${FULL_BACKUP_NAME}"
              echo "${FULL_BACKUP_NAME}" > $BACKUP_DIR/current_full_backup.txt
              rclone copy $BACKUP_DIR/current_full_backup.txt oss:casaos-backup/
            else
              echo "å…¨é‡å¤‡ä»½ç›´ä¼ å¤±è´¥"
            fi
          }

          # å¢é‡å¤‡ä»½ï¼šå†…å­˜ç›´ä¼ 
          inc_backup() {
            echo "===== å†…å­˜ç›´ä¼  - åˆ›å»ºå¢é‡å¤‡ä»½ ====="
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            INC_BACKUP_NAME="casaos_inc_${TIMESTAMP}.tar.gz"
            sudo tar -zcf - $BACKUP_EXCLUDE / --listed-incremental=$BACKUP_DIR/backup.snar --wildcards "*/casaos/*" "*/docker/*" 2>/dev/null | rclone rcat oss:casaos-backup/${INC_BACKUP_NAME}
            if [ $? -eq 0 ]; then
              echo "å¢é‡å¤‡ä»½å†…å­˜ç›´ä¼ æˆåŠŸï¼šoss:casaos-backup/${INC_BACKUP_NAME}"
              rclone copy $BACKUP_DIR/backup.snar oss:casaos-backup/
              rclone ls oss:casaos-backup/ --include "casaos_inc_*.tar.gz" | sort -k2 | head -n -${KEEP_BACKUP_NUM} | awk '{print $2}' | xargs -I {} rclone delete oss:casaos-backup/{}
            else
              echo "å¢é‡å¤‡ä»½ç›´ä¼ å¤±è´¥"
            fi
          }

          # æ ¸å¿ƒåƒåœ¾æ¸…ç†å‡½æ•°ï¼ˆå¤šç»´åº¦æ¸…ç†ï¼‰
          auto_clean() {
            echo "===== å¼€å§‹æ¯å°æ—¶åƒåœ¾æ¸…ç† ====="
            BEFORE_CLEAN=$(df -h / | awk 'NR==2{print $4}')
            
            # 1. æ¸…ç†ç³»ç»ŸAPTç¼“å­˜ï¼ˆæœ€å¤§åƒåœ¾æ¥æºï¼‰
            sudo apt clean -y
            sudo apt autoremove -y --purge
            
            # 2. æ¸…ç†Dockerå†—ä½™ï¼ˆé•œåƒã€å®¹å™¨ã€å·ã€ç½‘ç»œï¼‰
            sudo docker system prune -af --volumes 2>/dev/null || true
            
            # 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ç›®å½•
            sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null
            sudo rm -rf /home/runner/.cache/* 2>/dev/null
            
            # 4. æ¸…ç†GitHub Actionsæ—¥å¿—å’Œç¼“å­˜
            sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null
            sudo rm -rf /home/runner/actions-runner/_work/_temp/* 2>/dev/null
            
            # 5. æ¸…ç†VNCä¸´æ—¶æ–‡ä»¶
            sudo rm -rf /tmp/runtime-runner/* 2>/dev/null
            
            AFTER_CLEAN=$(df -h / | awk 'NR==2{print $4}')
            echo "===== åƒåœ¾æ¸…ç†å®Œæˆ ====="
            echo "æ¸…ç†å‰å¯ç”¨ç©ºé—´ï¼š${BEFORE_CLEAN} | æ¸…ç†åå¯ç”¨ç©ºé—´ï¼š${AFTER_CLEAN}"
          }

          # åˆå§‹åŒ–å¤‡ä»½
          [ ! -f "$BACKUP_DIR/current_full_backup.txt" ] && full_backup || inc_backup

          while true; do
            current_time=$(date +%s)
            run_minutes=$(( (current_time - start_time) / 60 ))
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}' | sed 's/[^0-9.]//g')
            
            # 1. æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡åƒåœ¾æ¸…ç†
            if [ $((current_time - last_clean_time)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean_time=$current_time
            fi

            # 2. ç©ºé—´åº”æ€¥æ¸…ç†ï¼ˆä¸è¶³1GBæ—¶ç«‹å³æ¸…ç†ï¼‰
            if (( $(echo "$FREE_SPACE < 1" | bc -l) )); then
              echo "âš ï¸  ç©ºé—´ä¸è¶³1GBï¼Œç´§æ€¥æ¸…ç†..."
              auto_clean
              last_clean_time=$current_time
            fi

            # 3. å‰©ä½™10åˆ†é’Ÿè§¦å‘ç»­è·‘
            if [ $((MAX_RUN_MINUTES - run_minutes)) -eq 10 ]; then
              echo "===== å‰©ä½™10åˆ†é’Ÿï¼Œè§¦å‘ç»­è·‘ ====="
              full_backup
              curl -X POST https://api.github.com/repos/${{ github.repository }}/dispatches \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.USER_GITHUB_PAT }}" \
                -d '{"event_type":"renew_vnc"}' || echo "ç»­è·‘è§¦å‘å¤±è´¥"
            fi

            # 4. æ¯å°æ—¶å¢é‡å¤‡ä»½
            if [ $((current_time - last_backup_time)) -ge 3600 ]; then
              inc_backup
              last_backup_time=$current_time
            fi

            # 5. æœåŠ¡å¥åº·æ£€æŸ¥
            pgrep -x Xvnc || { echo "VNCå¼‚å¸¸ï¼Œé‡å¯"; vncserver $DISPLAY -localhost no -geometry 1280x720 -depth 16 -SecurityTypes VncAuth; }
            sudo systemctl is-active --quiet docker || { echo "Dockerå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart docker; }
            sudo systemctl is-active --quiet casaos || { echo "CasaOSå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart casaos; }
            sudo systemctl is-active --quiet tailscaled || { echo "Tailscaleå¼‚å¸¸ï¼Œé‡å¯"; sudo systemctl restart tailscaled; }

            echo "[$(date)] è¿è¡Œ${run_minutes}åˆ†é’Ÿ | å‰©ä½™ç©ºé—´: $(df -h / | awk 'NR==2{print $4}') | ä¸‹æ¬¡æ¸…ç†ï¼š$(( (last_clean_time + CLEAN_INTERVAL - current_time) / 60 ))åˆ†é’Ÿå"
            sleep 300
          done

      - name: ä¼˜é›…æ¸…ç†ç¯å¢ƒ
        id: clean_env
        if: always()
        run: |
          echo "===== æ¸…ç†ç¯å¢ƒ ====="
          vncserver -kill $DISPLAY || true && pkill -9 Xvnc || true
          sudo systemctl stop docker casaos tailscaled || true
          sudo tailscale down || true
          rm -rf $BACKUP_DIR $VNCDIR $NETDISK_ROOT || true
          echo "===== ç¯å¢ƒæ¸…ç†å®Œæˆ ====="
