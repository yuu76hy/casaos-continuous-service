name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: >-
        --exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      CURRENT_WORKFLOW_NAME: "CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰"
      CURRENT_WORKFLOW_FILE: "casaos-continuous-with-backup.yml"
      # æ–°å¢ï¼šè¶…æ—¶å‰æå‰å¤‡ä»½çš„é˜ˆå€¼ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰
      BACKUP_THRESHOLD_MINS: 5

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæç®€ç‰ˆï¼‰
        run: |
          set -e
          echo "===== ç³»ç»Ÿå¿«é€Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"
      
      - name: 2-ç¦ç”¨ä»“åº“æ‰€æœ‰éå½“å‰å·¥ä½œæµï¼ˆä»…ä¿ç•™å½“å‰å¯è¿è¡Œï¼‰
        run: |
          set -e
          echo "===== ç¦ç”¨ä»“åº“æ‰€æœ‰éå½“å‰å·¥ä½œæµ ====="
          if [ -z "$USER_PAT" ] || [ -z "$REPO" ] || [ -z "$CURRENT_WORKFLOW_FILE" ]; then
            echo "âš ï¸ ç¼ºå°‘USER_PAT/REPO/CURRENT_WORKFLOW_FILEé…ç½®ï¼Œè·³è¿‡ç¦ç”¨æ“ä½œ"
            exit 0
          fi
          echo "ğŸ“Œ ä¿ç•™å¯è¿è¡Œå·¥ä½œæµï¼šæ–‡ä»¶=$CURRENT_WORKFLOW_FILE | åç§°=$CURRENT_WORKFLOW_NAME"
          
          ALL_WORKFLOWS=$(curl -s -H "Authorization: token $USER_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/workflows" | \
            jq -r '.workflows[] | select(.id != null and .path != null) | "\(.id)|\(.name)|\(.path)|\(.state)"')
          
          if [ -z "$ALL_WORKFLOWS" ] || [ "$ALL_WORKFLOWS" = "null" ]; then
            echo "âš ï¸ æœªæ‹‰å–åˆ°ä»“åº“å·¥ä½œæµåˆ—è¡¨ï¼Œè·³è¿‡ç¦ç”¨æ“ä½œ"
            exit 0
          fi
          
          while IFS="|" read -r WORKFLOW_ID WORKFLOW_NAME WORKFLOW_FILE WORKFLOW_STATE; do
            [ -z "$WORKFLOW_ID" ] || [ -z "$WORKFLOW_FILE" ] && continue
            
            if [ "$WORKFLOW_FILE" = ".github/workflows/$CURRENT_WORKFLOW_FILE" ]; then
              if [ "$WORKFLOW_STATE" != "active" ]; then
                echo "ğŸ”„ å¯ç”¨å½“å‰å·¥ä½œæµï¼š$WORKFLOW_NAMEï¼ˆID:$WORKFLOW_IDï¼‰"
                curl -s -o /dev/null -w "%{http_code}" -X PUT -H "Authorization: token $USER_PAT" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/enable" | grep -q "204" && \
                  echo "âœ… æˆåŠŸå¯ç”¨å½“å‰å·¥ä½œæµ" || echo "âš ï¸ å¯ç”¨å½“å‰å·¥ä½œæµå¤±è´¥"
              else
                echo "âœ… å½“å‰å·¥ä½œæµå·²å¯ç”¨ï¼š$WORKFLOW_NAME"
              fi
              continue
            fi
            
            echo "ğŸ”„ ç¦ç”¨éå½“å‰å·¥ä½œæµï¼š$WORKFLOW_NAMEï¼ˆID:$WORKFLOW_IDï¼‰"
            curl -s -o /dev/null -w "%{http_code}" -X PUT -H "Authorization: token $USER_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/disable" | grep -q "204" && \
              echo "âœ… æˆåŠŸç¦ç”¨ï¼š$WORKFLOW_NAME" || echo "âš ï¸ ç¦ç”¨$WORKFLOW_NAMEå¤±è´¥"
          done <<< "$ALL_WORKFLOWS"
          
          echo -e "\nâœ… å·¥ä½œæµç¦ç”¨æ“ä½œå®Œæˆï¼šä»…å½“å‰å·¥ä½œæµå¯è¿è¡Œ"

      - name: 3-å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆå«composeï¼‰
        run: |
          set -e
          echo "===== å®˜æ–¹ä¸€é”®å®‰è£…Docker ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          docker --version && docker compose version
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆ"
      
      - name: 4-åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          echo "===== åˆ›å»ºå…å¯†ç”¨æˆ· ====="
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          [ -n "$ROOTS_PASSWORD" ] && echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd || { RANDOM_PASS=$(openssl rand -base64 12); echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd; echo "éšæœºå¯†ç ï¼š$RANDOM_PASS"; }
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null && sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ·é…ç½®å®Œæˆ"
      
      - name: 5-WebDAVé…ç½®+å¿«ç…§æ£€æµ‹+ç›®å½•é¢„åˆ›å»º
        run: |
          set -e
          echo "===== WebDAVé…ç½®&å¿«ç…§æ£€æµ‹&ç›®å½•é¢„åˆ›å»º ====="
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /home/runner/.rclone.conf >/dev/null
          sudo chmod 600 /home/runner/.rclone.conf
          if rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf; then
            echo "âœ… è¿œç¨‹å¤‡ä»½ç›®å½•åˆ›å»ºæˆåŠŸ"
          else
            echo "âš ï¸ è¿œç¨‹ç›®å½•åˆ›å»ºå¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"
            rclone mkdir mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf || { echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾ï¼Œè·³è¿‡å¤‡ä»½"; echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"; exit 0; }
          fi
          REMOTE_SNAPSHOTS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r | head -1 | xargs)
          if [ -n "$REMOTE_SNAPSHOTS" ]; then
            echo "âœ… æ‰¾åˆ°æœ€æ–°å¿«ç…§ï¼š$REMOTE_SNAPSHOTS"
            echo "LATEST_SNAPSHOT=$REMOTE_SNAPSHOTS" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "âœ… é¦–æ¬¡éƒ¨ç½²æ— å¿«ç…§ï¼Œçº¯å‡€å¯åŠ¨"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
      
      - name: 6-çº¯å‡€å®‰è£…CasaOSï¼ˆä»…ç¨‹åºï¼Œæ— æ•°æ®ï¼‰
        run: |
          set -e
          echo "===== å®‰è£…çº¯å‡€CasaOS ====="
          sudo systemctl restart docker containerd && sleep 2
          sudo systemctl stop casaos 2>/dev/null || true && sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          echo "âœ… CasaOSå®‰è£…å®Œæˆï¼Œå¾…å¯åŠ¨"
      
      - name: 7-æ¢å¤ä¸ªäººæ•°æ®ï¼ˆæ— å¿«ç…§è‡ªåŠ¨è·³è¿‡ï¼Œé˜²é”™ä¹±ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== æ¢å¤ä¸ªäººæ•°æ®ï¼ˆç²¾å‡†é˜²é”™ä¹±ï¼‰====="
          sudo systemctl stop docker containerd casaos 2>/dev/null || true
          sudo pkill -9 docker containerd casaos 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 2
          sudo mkdir -p $PERSONAL_DATA_DIRS 2>/dev/null || true
          echo "ğŸ“Œ ä»…æ¢å¤ç›®å½•ï¼š$PERSONAL_DATA_DIRS"
          rclone cat mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf | sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
          rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT} --config /home/runner/.rclone.conf 2>/dev/null || true
          echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼Œæƒé™å·²æ ¡æ­£ï¼Œæ— é”™ä¹±"
      
      - name: 8-æƒé™æ ¡æ­£+æé€Ÿå¯åŠ¨æœåŠ¡ï¼ˆæ— å¿«ç…§ä¸å¡ç‚¹ï¼‰
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£+æé€Ÿå¯åŠ¨ ====="
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker
            sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
            sudo systemctl daemon-reload
            sudo systemctl enable --now docker containerd && sleep 3
            sudo systemctl enable --now casaos && sleep 4
            echo "âœ… æœ‰å¿«ç…§ï¼šæœåŠ¡å¯åŠ¨å®Œæˆï¼Œæƒé™æ­£å¸¸"
          else
            sudo mkdir -p /etc/casaos /var/lib/casaos /DATA /run/docker 2>/dev/null || true
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos && sudo chmod -R 700 /var/lib/casaos /var/lib/docker
            sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
            sudo systemctl daemon-reload
            sudo systemctl enable --now docker containerd
            sudo systemctl enable --now casaos
            echo "âœ… æ— å¿«ç…§ï¼šå¼ºåˆ¶å¯åŠ¨å®Œæˆï¼è®¿é—®æœåŠ¡å™¨IPåˆå§‹åŒ–"
          fi
      
      - name: 9-Tailscaleè¿œç¨‹ç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        run: |
          set -e
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then exit 0; fi
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-6)" --accept-routes
          echo "âœ… Tailscaleç»„ç½‘å®Œæˆï¼ŒIPï¼š$(sudo tailscale ip -4 2>/dev/null || echo 'æœªè·å–')"
      
      - name: 10-ä¸ªäººæ•°æ®å¤‡ä»½+ä¿ç•™2ä»½è‡ªåŠ¨æ¸…ç†+å‰©ä½™æ—¶é—´æ£€æµ‹
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== ä¸ªäººæ•°æ®å¤‡ä»½+å‰©ä½™æ—¶é—´æ£€æµ‹ ====="
          start_time=$(date +%s)
          # å·¥ä½œæµæ€»è¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
          TOTAL_TIMEOUT_SECS=$((60 * ${{ github.job.timeout-minutes }}))
          # æå‰å¤‡ä»½çš„é˜ˆå€¼ï¼ˆå•ä½ï¼šç§’ï¼‰
          THRESHOLD_SECS=$((60 * $BACKUP_THRESHOLD_MINS))
          RENEW_TRIGGERED=false
          
          cleanup_old_backups(){
            echo "ğŸ“Œ æ¸…ç†æ—§å¤‡ä»½ï¼Œä»…ä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
            BACKUPS=$(rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR} --config /home/runner/.rclone.conf | grep casaos-full-snapshot | sed 's/^[0-9]\+ //' | sort -r)
            BACKUP_COUNT=$(echo "$BACKUPS" | wc -l)
            if [ $BACKUP_COUNT -gt $KEEP_BACKUPS ]; then
              DELETE_COUNT=$((BACKUP_COUNT - KEEP_BACKUPS))
              DELETE_LIST=$(echo "$BACKUPS" | tail -n $DELETE_COUNT)
              echo "âš ï¸ å‘ç°${BACKUP_COUNT}ä»½å¤‡ä»½ï¼Œéœ€åˆ ${DELETE_COUNT}ä»½æ—§å¤‡ä»½"
              for FILE in $DELETE_LIST; do
                rclone delete mywebdav:${WEBDAV_SNAPSHOT_DIR}/$FILE --config /home/runner/.rclone.conf && echo "âœ… å·²åˆ æ—§å¤‡ä»½ï¼š$FILE" || echo "âš ï¸ åˆ $FILEå¤±è´¥ï¼Œè·³è¿‡"
              done
              echo "âœ… æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–°${KEEP_BACKUPS}ä»½"
            else
              echo "âœ… å½“å‰å¤‡ä»½æ•°${BACKUP_COUNT}â‰¤${KEEP_BACKUPS}ï¼Œæ— éœ€æ¸…ç†"
            fi
          }
          
          full_backup(){
            SNAPSHOT_NAME="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
            SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"
            echo "ğŸ“Œ æ‰“åŒ…ä¸ªäººæ•°æ®ï¼ˆæ’é™¤åƒåœ¾æ–‡ä»¶ï¼‰"
            sudo tar -czPf $SNAPSHOT_PATH --exclude=${EXCLUDE_RULES} $PERSONAL_DATA_DIRS || { echo "âŒ æ‰“åŒ…å¤±è´¥"; return 1; }
            echo "âœ… æœ¬åœ°æ‰“åŒ…å®Œæˆï¼Œå¤§å°ï¼š$(du -sh $SNAPSHOT_PATH | awk '{print $1}')"
            
            echo "ğŸ“Œ ä¸Šä¼ è‡³WebDAVï¼š${WEBDAV_SNAPSHOT_DIR}"
            rclone copy $SNAPSHOT_PATH mywebdav:${WEBDAV_SNAPSHOT_DIR}/ --config /home/runner/.rclone.conf --transfers 4 --fast-list --retries 3 || { echo "âŒ ä¸Šä¼ å¤±è´¥"; return 1; }
            
            if rclone ls mywebdav:${WEBDAV_SNAPSHOT_DIR}/$SNAPSHOT_NAME --config /home/runner/.rclone.conf >/dev/null; then
              echo "âœ… è¿œç¨‹æ ¡éªŒæˆåŠŸ"
              sudo rm -f $SNAPSHOT_PATH
              cleanup_old_backups
              return 0
            else
              echo "âŒ ä¸Šä¼ æœªè½åœ°"
              sudo rm -f $SNAPSHOT_PATH
              return 1
            fi
          }
          
          trigger_renew(){
            [ -z "$USER_PAT" ] || [ -z "$REPO" ] && { echo "âš ï¸ ç»­è·‘é…ç½®ç¼ºå¤±ï¼Œè·³è¿‡"; return 0; }
            curl -fsSL --fail --connect-timeout 30 -X POST \
              -H "Authorization: token $USER_PAT" -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/dispatches -d '{"event_type":"renew_casaos_snapshot"}' \
              && echo "âœ… è‡ªåŠ¨ç»­è·‘å·²è§¦å‘" || echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥ï¼Œè·³è¿‡"
          }
          
          while true; do
            current_time=$(date +%s)
            run_seconds=$((current_time - start_time))
            run_mins=$((run_seconds / 60))
            remaining_seconds=$((TOTAL_TIMEOUT_SECS - run_seconds))
            
            echo "â„¹ï¸ å½“å‰è¿è¡Œæ—¶é•¿ï¼š${run_mins}åˆ†é’Ÿ | å‰©ä½™æ—¶é•¿ï¼š$((remaining_seconds / 60))åˆ†é’Ÿ"
            
            # æ¡ä»¶1ï¼šè¿è¡Œæ»¡2åˆ†é’Ÿè§¦å‘é¦–æ¬¡å¤‡ä»½
            if [ $run_mins -ge 2 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° è¿è¡Œæ»¡2åˆ†é’Ÿï¼Œæ‰§è¡Œé¦–æ¬¡å¤‡ä»½"
              if full_backup; then
                echo "âœ… é¦–æ¬¡å¤‡ä»½æˆåŠŸï¼"
                trigger_renew
                RENEW_TRIGGERED=true
              else
                echo "âŒ é¦–æ¬¡å¤‡ä»½å¤±è´¥ï¼Œ10åˆ†é’Ÿåé‡è¯•"
                sleep 600
                if full_backup; then
                  echo "âœ… é‡è¯•å¤‡ä»½æˆåŠŸ"
                  trigger_renew
                  RENEW_TRIGGERED=true
                else
                  echo "âŒ å¤šæ¬¡å¤‡ä»½å¤±è´¥ï¼Œåç»­å°†é€šè¿‡å‰©ä½™æ—¶é—´æ£€æµ‹é‡è¯•"
                fi
              fi
            fi
            
            # æ¡ä»¶2ï¼šå‰©ä½™æ—¶é—´ä¸è¶³é˜ˆå€¼æ—¶ï¼Œå¼ºåˆ¶è§¦å‘å¤‡ä»½
            if [ $remaining_seconds -le $THRESHOLD_SECS ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "âš ï¸ å·¥ä½œæµå³å°†è¶…æ—¶ï¼ˆå‰©ä½™${remaining_seconds}ç§’ï¼‰ï¼Œå¼ºåˆ¶è§¦å‘å¤‡ä»½"
              if full_backup; then
                echo "âœ… è¶…æ—¶å‰å¤‡ä»½æˆåŠŸï¼"
                trigger_renew
                RENEW_TRIGGERED=true
              else
                echo "âŒ è¶…æ—¶å‰å¤‡ä»½å¤±è´¥ï¼Œå°†ç›´æ¥ç»“æŸæµç¨‹"
                exit 0
              fi
            fi
            
            # æ¡ä»¶3ï¼šè¿è¡Œæ—¶é•¿è¶…è¿‡æ€»è¶…æ—¶ï¼Œå¼ºåˆ¶ç»“æŸ
            if [ $run_seconds -ge $TOTAL_TIMEOUT_SECS ]; then
              echo "âœ… è¾¾åˆ°å·¥ä½œæµè¶…æ—¶ä¸Šé™ï¼Œæµç¨‹ç»“æŸ"
              exit 0
            fi
            
            sleep 60
          done
      
      - name: 11-æ”¶å°¾æ¸…ç†ï¼ˆæé€Ÿå®Œæˆï¼‰
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ”¶å°¾æ¸…ç† ====="
          sudo rm -rf /tmp/* /home/runner/.rclone.conf /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          echo "âœ… è®¿é—®æœåŠ¡å™¨IPï¼ˆ80ç«¯å£ï¼‰åˆå§‹åŒ–CasaOSï¼Œå¤‡ä»½ä¿ç•™æœ€æ–°2ä»½"
