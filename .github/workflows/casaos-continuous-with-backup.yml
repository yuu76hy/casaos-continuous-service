name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆå¤‡ä»½ä¿ç•™2ä»½+è‡ªåŠ¨æ¸…ç† ç¨³å®šç‰ˆï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      WEBDAV_SNAPSHOT_DIR: "/z/Udu/CasaOS-Backup"
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA /root/.config"
      EXCLUDE_RULES: "--exclude=*.log --exclude=*.tmp --exclude=*.cache --exclude=/var/lib/docker/tmp --exclude=/var/lib/docker/containers/*/*.log --exclude=/var/lib/docker/overlay2/*/tmp --exclude=/DATA/tmp --exclude=/DATA/cache --exclude=/DATA/logs"
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ secrets.REPO }}
      KEEP_BACKUPS: 2
      TARGET_RUN_MINUTES: 60
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
      CASA_SERVICES: "casaos-gateway casaos-message-bus casaos-user-service casaos-local-storage casaos-app-management rclone casaos"

    steps:
      - name: ğŸ”’ å®‰å…¨åˆå§‹åŒ–ï¼ˆå±è”½æ•æ„Ÿè¾“å‡º+è®°å½•å…¨å±€å¯åŠ¨æ—¶é—´ï¼‰
        run: |
          set -e
          echo "WORKFLOW_START_TIME=$(date +%s)" >> "$GITHUB_ENV"
          
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "::add-mask::$ROOTS_PASSWORD"
          fi
          echo "===== ç³»ç»Ÿåˆå§‹åŒ– ====="
          sudo apt update -y -qq && sudo apt install -y curl wget jq tar gzip rclone lsof ca-certificates gnupg -qq
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… åˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ³ å®˜æ–¹ä¸€é”®è£…Dockerï¼ˆå«composeï¼‰
        run: |
          set -e
          echo "===== å®‰è£…Dockerï¼ˆé˜¿é‡Œäº‘é•œåƒï¼‰ ====="
          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true
          curl -fsSL https://get.docker.com | sudo bash -s docker --mirror Aliyun
          sudo systemctl enable --now docker containerd && sleep 2
          echo "ğŸ“Œ Dockerç‰ˆæœ¬: $(docker --version)"
          echo "ğŸ“Œ Composeç‰ˆæœ¬: $(docker compose version)"
          sudo usermod -aG docker runner
          echo "âœ… Dockerå®‰è£…å®Œæˆ"

      - name: ğŸ‘¤ åˆ›å»ºå…å¯†ç®¡ç†å‘˜ç”¨æˆ·
        run: |
          set -e
          USER_NAME="roots"
          id -u "$USER_NAME" &>/dev/null || sudo useradd -m -s /bin/bash "$USER_NAME"
          
          if [ -n "$ROOTS_PASSWORD" ]; then
            echo "$USER_NAME:$ROOTS_PASSWORD" | sudo chpasswd
          else
            RANDOM_PASS=$(openssl rand -base64 16 | tr -dc 'A-Za-z0-9' | head -c12)
            echo "$USER_NAME:$RANDOM_PASS" | sudo chpasswd
            echo "::add-mask::$RANDOM_PASS"
            echo "ğŸ”‘ rootséšæœºå¯†ç ï¼ˆä»…æœ¬æ¬¡æœ‰æ•ˆï¼‰: $RANDOM_PASS"
            echo "âš ï¸ é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼"
          fi
          
          echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"$USER_NAME" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"$USER_NAME"
          sudo usermod -aG docker "$USER_NAME"
          echo "âœ… ç”¨æˆ· $USER_NAME é…ç½®å®Œæˆ"

      - name: â˜ï¸ WebDAVé…ç½®+å¿«ç…§æ£€æµ‹
        run: |
          set -e
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âš ï¸ WebDAVå‡­è¯ç¼ºå¤±ï¼Œè·³è¿‡å¤‡ä»½æ¢å¤"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          echo "::add-mask::$WEBDAV_PASSWORD"
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav url="$WEBDAV_URL" user="$WEBDAV_USER" pass="$ENCRYPTED_PASS" --config /root/.rclone.conf 2>/dev/null
          sudo chmod 600 /root/.rclone.conf
          
          # ä¿®å¤{1..3}å¾ªç¯ï¼Œrun:|å·²åŒ…è£¹æ— æ­§ä¹‰
          for i in {1..3}; do
            if rclone mkdir "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null; then
              echo "âœ… è¿œç¨‹å¤‡ä»½ç›®å½•å°±ç»ª"
              break
            fi
            [ $i -eq 3 ] && { echo "âŒ è¿œç¨‹ç›®å½•ä¸å¯è¾¾"; echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"; exit 0; }
            sleep 2
          done
          
          LATEST=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r | head -1)
          
          if [ -n "$LATEST" ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°å¿«ç…§: $LATEST"
            echo "LATEST_SNAPSHOT=$LATEST" >> "$GITHUB_ENV"
            echo "HAS_SNAPSHOT=true" >> "$GITHUB_ENV"
          else
            echo "â„¹ï¸ é¦–æ¬¡éƒ¨ç½²ï¼šæ— å†å²å¿«ç…§ï¼Œå°†çº¯å‡€å¯åŠ¨"
            echo "HAS_SNAPSHOT=false" >> "$GITHUB_ENV"
          fi
          echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"

      - name: ğŸ§¹ å½»åº•æ¸…ç†æ—§CasaOSï¼ˆå«æ‰€æœ‰æœåŠ¡ï¼‰
        run: |
          set -e
          echo "===== åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰CasaOSæœåŠ¡ ====="
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
            sudo systemctl disable "${svc}.service" 2>/dev/null || true
            sudo rm -f "/etc/systemd/system/${svc}.service" "/usr/lib/systemd/system/${svc}.service" 2>/dev/null || true
          done
          
          sudo pkill -9 -f "casaos\|rclone" 2>/dev/null || true
          sudo rm -rf /var/lib/casaos/* /etc/casaos/* 2>/dev/null || true
          sudo systemctl daemon-reload
          echo "âœ… æ—§CasaOSç¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: ğŸ“¦ çº¯å‡€å®‰è£…CasaOS
        run: |
          set -e
          echo "===== å®‰è£…CasaOSï¼ˆå®˜æ–¹è„šæœ¬ï¼‰ ====="
          curl -fsSL https://get.casaos.io | sudo bash
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          echo "âœ… CasaOSå®‰è£…å®Œæˆï¼ˆæœåŠ¡æš‚æœªå¯åŠ¨ï¼‰"

      - name: ğŸ”„ æ¢å¤ä¸ªäººæ•°æ®ï¼ˆå«Dockerç‰ˆæœ¬æç¤ºï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && env.HAS_SNAPSHOT == 'true' }}
        run: |
          set -e
          echo "===== ç²¾å‡†æ¢å¤ä¸ªäººæ•°æ® ====="
          
          sudo systemctl stop docker containerd 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sudo pkill -9 docker containerd runc 2>/dev/null || true
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock 2>/dev/null || true
          sync && sleep 3
          
          for dir in $PERSONAL_DATA_DIRS; do
            sudo mkdir -p "$dir" 2>/dev/null || true
          done
          
          echo "âš ï¸ é‡è¦æç¤ºï¼šæ­£åœ¨æ¢å¤ /var/lib/docker"
          echo "   â€¢ å¤‡ä»½Dockerç‰ˆæœ¬: $(tar -tzf <(rclone cat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf) etc/docker/version 2>/dev/null | head -1 || echo 'æœªçŸ¥')"
          echo "   â€¢ å½“å‰Dockerç‰ˆæœ¬: $(docker version --format '{{.Server.Version}}' 2>/dev/null || echo 'æœªè¿è¡Œ')"
          echo "   â€¢ ç‰ˆæœ¬å·®å¼‚å¯èƒ½å¯¼è‡´å…¼å®¹æ€§é—®é¢˜ï¼Œè¯·ç¡®ä¿ç›¸è¿‘"
          
          rclone cat "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf | \
            sudo tar -xzf - -C / --overwrite --preserve-permissions $PERSONAL_DATA_DIRS 2>&1 | grep -v "tar: Removing leading" || true
          
          sudo chown -R root:root $PERSONAL_DATA_DIRS
          sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
          sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          
          rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/${LATEST_SNAPSHOT}" --config /root/.rclone.conf 2>/dev/null && \
            echo "âœ… æœ¬åœ°æ•°æ®æ¢å¤å®Œæˆï¼Œå·²æ¸…ç†è¿œç¨‹å¿«ç…§" || echo "âš ï¸ å¿«ç…§æ¸…ç†å¤±è´¥ï¼ˆä¸å½±å“æ¢å¤ï¼‰"

      - name: âš™ï¸ æƒé™æ ¡æ­£+æœåŠ¡å¯åŠ¨
        run: |
          set -e
          echo "===== æƒé™æ ¡æ­£ä¸æœåŠ¡å¯åŠ¨ ====="
          
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker /etc/casaos /var/lib/casaos /DATA 2>/dev/null || true
          
          # ä¿®å¤ï¼šenvå˜é‡åˆ¤ç­‰åŠ å¼•å·ï¼Œè§„é¿YAMLè§£ææ­§ä¹‰
          if [ "${{ env.HAS_SNAPSHOT }}" = "true" ]; then
            sudo chown -R root:root $PERSONAL_DATA_DIRS
            sudo chmod -R 755 /etc/casaos /DATA /root/.config 2>/dev/null || true
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          else
            sudo chown -R root:root /etc/casaos /var/lib/casaos /var/lib/docker
            sudo chmod -R 755 /etc/casaos 2>/dev/null || true
            sudo chmod -R 700 /var/lib/casaos /var/lib/docker 2>/dev/null || true
          fi
          
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 3
          for svc in $CASA_SERVICES; do
            sudo systemctl enable --now "${svc}.service" 2>/dev/null || true
          done
          sleep 5
          
          if [ "${{ env.HAS_SNAPSHOT }}" != "true" ]; then
            echo "âœ¨ é¦–æ¬¡éƒ¨ç½²æˆåŠŸï¼"
            echo "   ğŸŒ è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}')"
            echo "   ğŸ“Œ æ³¨æ„: ç³»ç»Ÿå°†åœ¨ ${TARGET_RUN_MINUTES} åˆ†é’Ÿåè‡ªåŠ¨æ‰§è¡Œé¦–æ¬¡å¤‡ä»½"
          fi
          echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ"

      - name: ğŸŒ Tailscaleç»„ç½‘ï¼ˆå¯é€‰ï¼‰
        if: ${{ env.TAILSCALE_AUTH_KEY != '' }}
        run: |
          set -e
          echo "===== å®‰è£…Tailscale ====="
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y tailscale -qq
          sudo systemctl enable --now tailscaled && sleep 2
          sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="CasaOS-$(hostname | cut -c1-8)" --accept-routes --advertise-exit-node 2>/dev/null || true
          TAIL_IP=$(sudo tailscale ip -4 2>/dev/null || echo "æœªè·å–")
          echo "âœ… Tailscaleç»„ç½‘æˆåŠŸ | å†…ç½‘IP: $TAIL_IP"

      - name: ğŸŒ‰ Cloudflare Tunneléƒ¨ç½²
        if: ${{ env.CLOUDFLARED_TOKEN != '' }}
        run: |
          set -e
          echo "===== éƒ¨ç½²Cloudflare Tunnelï¼ˆsystemdæ‰˜ç®¡ï¼‰ ====="
          
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared noble main" | sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null
          sudo apt update -y -qq && sudo apt install -y cloudflared -qq
          
          sudo cloudflared service install "$CLOUDFLARED_TOKEN" 2>/dev/null || \
            (echo "âš ï¸ service installå¤±è´¥ï¼Œå›é€€æ‰‹åŠ¨é…ç½®" && \
             echo "[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/cloudflared tunnel run --token $CLOUDFLARED_TOKEN
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target" | sudo tee /etc/systemd/system/cloudflared.service && \
             sudo systemctl daemon-reload && \
             sudo systemctl enable --now cloudflared)
          
          sleep 8
          if sudo systemctl is-active --quiet cloudflared; then
            echo "âœ… Cloudflare Tunnel æœåŠ¡è¿è¡Œä¸­ (PID: $(pgrep cloudflared | head -1))"
            echo "ğŸ“Œ éš§é“çŠ¶æ€: $(cloudflared tunnel list 2>/dev/null | head -2 || echo 'è¿è¡Œä¸­')"
          else
            echo "âŒ Tunnelå¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: journalctl -u cloudflared -n 50"
            exit 1
          fi

      - name: â±ï¸ æ™ºèƒ½å»¶æ—¶æ ¡å‡†ï¼ˆä»…è‡ªåŠ¨è§¦å‘æ—¶ç­‰å¾…ï¼‰
        if: ${{ env.WEBDAV_AVAILABLE == 'true' && github.event_name == 'repository_dispatch' }}
        run: |
          set -e
          # ä¿®å¤ï¼šenvå˜é‡å¼•ç”¨åŠ å¼•å·ï¼Œé¿å…YAMLè§£æå†²çª
          START_TIME="${{ env.WORKFLOW_START_TIME }}"
          CURRENT_TIME=$(date +%s)
          CURRENT_DURATION=$(( CURRENT_TIME - START_TIME ))
          TARGET_DURATION=$(( TARGET_RUN_MINUTES * 60 ))
          WAIT_TIME=$(( TARGET_DURATION - CURRENT_DURATION ))
          
          if [ $WAIT_TIME -gt 0 ]; then
            echo "â³ ç­‰å¾…è‡³æ»¡ ${TARGET_RUN_MINUTES} åˆ†é’Ÿï¼ˆå½“å‰: $((CURRENT_DURATION/60))m$((CURRENT_DURATION%60))sï¼‰"
            echo "   å‰©ä½™ç­‰å¾…: $((WAIT_TIME/60))m$((WAIT_TIME%60))s"
            sleep $WAIT_TIME
          else
            echo "âœ… å·²è¿è¡Œ ${TARGET_RUN_MINUTES}+ åˆ†é’Ÿï¼Œç›´æ¥è¿›å…¥å¤‡ä»½æµç¨‹"
          fi

      - name: ğŸ’¾ å…¨é‡å¤‡ä»½+æ¸…ç†+ç»­è·‘
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== å¤‡ä»½æ ¸å¿ƒæµç¨‹ï¼ˆæœåŠ¡æš‚åœä¸­ï¼‰ ====="
          
          # å®‰å…¨åœæ­¢æ‰€æœ‰æœåŠ¡
          echo "ğŸ“Œ åœæ­¢æ‰€æœ‰æœåŠ¡ï¼ˆDocker/CasaOS/Tailscale/Tunnelï¼‰"
          sudo systemctl stop docker containerd tailscaled cloudflared 2>/dev/null || true
          for svc in $CASA_SERVICES; do
            sudo systemctl stop "${svc}.service" 2>/dev/null || true
          done
          sleep 3
          sudo pkill -9 -f "docker\|containerd\|casaos\|tailscaled\|cloudflared\|runc" 2>/dev/null || true
          sudo sync && sleep 5
          
          # ä¿®å¤ï¼štarå‚æ•°åŠ å¼•å·ï¼Œé¿å…åˆ†è¯å¤±æ•ˆ
          SNAPSHOT="casaos-full-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "ğŸ“Œ æ‰“åŒ…å¤‡ä»½: $SNAPSHOT"
          if ! sudo tar -czf "/tmp/$SNAPSHOT" $EXCLUDE_RULES $PERSONAL_DATA_DIRS 2>&1 | grep -v "tar: Removing leading"; then
            echo "âŒ å¤‡ä»½æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          SIZE=$(du -h "/tmp/$SNAPSHOT" | cut -f1)
          echo "âœ… æœ¬åœ°æ‰“åŒ…å®Œæˆ ($SIZE)"
          
          # ä¸Šä¼ ä¸æ ¡éªŒ
          if rclone copy "/tmp/$SNAPSHOT" "mywebdav:${WEBDAV_SNAPSHOT_DIR}/" --config /root/.rclone.conf --transfers=4 --fast-list --retries=3; then
            if rclone size "mywebdav:${WEBDAV_SNAPSHOT_DIR}/$SNAPSHOT" --config /root/.rclone.conf >/dev/null 2>&1; then
              echo "âœ… è¿œç¨‹å¤‡ä»½æ ¡éªŒæˆåŠŸ"
              sudo rm -f "/tmp/$SNAPSHOT"
            else
              echo "âŒ è¿œç¨‹æ ¡éªŒå¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ ä¸Šä¼ å¤±è´¥"
            exit 1
          fi
          
          # æ¸…ç†æ—§å¤‡ä»½
          echo "ğŸ“Œ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™ $KEEP_BACKUPS ä»½ï¼‰"
          BACKUPS=$(rclone lsjson "mywebdav:${WEBDAV_SNAPSHOT_DIR}" --config /root/.rclone.conf 2>/dev/null | \
            jq -r '.[] | select(.Name | test("^casaos-full-snapshot-.*\\.tar\\.gz$")) | .Name' | sort -r)
          COUNT=$(echo "$BACKUPS" | wc -l)
          if [ "$COUNT" -gt "$KEEP_BACKUPS" ]; then
            echo "$BACKUPS" | tail -n $((COUNT - KEEP_BACKUPS)) | while read file; do
              rclone delete "mywebdav:${WEBDAV_SNAPSHOT_DIR}/$file" --config /root/.rclone.conf && \
                echo "âœ… å·²åˆ é™¤: $file" || echo "âš ï¸ åˆ é™¤å¤±è´¥: $file"
            done
          fi
          echo "âœ… å¤‡ä»½æ¸…ç†å®Œæˆï¼ˆå½“å‰ä¿ç•™ $(echo "$BACKUPS" | wc -l) ä»½ï¼‰"
          
          # è§¦å‘ç»­è·‘
          if [ -n "$USER_PAT" ] && [ -n "$REPO" ]; then
            if [[ ! "$REPO" =~ / ]]; then
              echo "âš ï¸ REPOæ ¼å¼é”™è¯¯ï¼ˆè¦æ±‚ï¼šç”¨æˆ·å/ä»“åº“åï¼‰ï¼Œè·³è¿‡ç»­è·‘è§¦å‘"
              exit 0
            fi
            echo "ğŸ“Œ è§¦å‘è‡ªåŠ¨ç»­è·‘å·¥ä½œæµ"
            PAYLOAD=$(jq -n --arg et "renew_casaos_snapshot" '{"event_type": $et}')
            if curl -fsSL -X POST --max-time 30 \
              -H "Authorization: token $USER_PAT" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "https://api.github.com/repos/$REPO/dispatches" 2>/dev/null; then
              echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸï¼ˆæ–°å·¥ä½œæµå°†ç«‹å³å¯åŠ¨ï¼‰"
            else
              echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥ï¼ˆä½†å¤‡ä»½å·²æˆåŠŸï¼‰"
            fi
          else
            echo "â„¹ï¸ æœªé…ç½® USER_PAT/REPOï¼Œè·³è¿‡ç»­è·‘è§¦å‘"
          fi
          echo "ğŸ‰ å¤‡ä»½å…¨æµç¨‹å®Œæˆï¼æœåŠ¡å°†ç”±ç»­è·‘å·¥ä½œæµæ¢å¤"

      - name: ğŸ§¹ æ”¶å°¾æ¸…ç†
        if: ${{ always() }}
        run: |
          set -e
          echo "===== æ¸…ç†ä¸´æ—¶èµ„æº ====="
          sudo rm -rf /tmp/casaos-* /tmp/cloudflared* /root/.rclone.conf 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
          echo "ğŸ”š å½“å‰å·¥ä½œæµç»“æŸ | ç»­è·‘å·¥ä½œæµå°†æ¥ç®¡æœåŠ¡æ¢å¤"