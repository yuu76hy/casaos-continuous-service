name: CasaOS-Tailscale-Full-Deploy

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [renew_casaos_tailscale]  # ä»“åº“äº‹ä»¶è§¦å‘ç±»åž‹

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MAX_RUN_MINUTES: 360
      WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
      BACKUP_DIRS: "/z/Ubu"
      CASAOS_DATA: /var/lib/casaos
      DOCKER_DATA: /var/lib/docker
      EXCLUDE_DIRS: >-
        /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
        /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
        /usr/share/doc /usr/share/man /usr/share/locale /etc/ssl/certs
        /etc/fstab /etc/mtab /etc/hostname /etc/machine-id
      MAX_MOUNT_RETRIES: 5  # å¢žåŠ é‡è¯•æ¬¡æ•°
      RETRY_DELAY: 10       # é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      REPO: ${{ github.repository }}
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}  # ä»Žç§˜é’¥è¯»å–å¯†ç ï¼Œä¸é…ç½®åˆ™éšæœºç”Ÿæˆ

    steps:
      # ========== æ­¥éª¤1ï¼šç³»ç»ŸçŽ¯å¢ƒåˆå§‹åŒ–ï¼ˆæ ¸å¿ƒä¿®å¤sudoé—®é¢˜ï¼‰ ==========
      - name: Step 1 - Initialize System Environment
        run: |
          set -e  # å‡ºé”™ç«‹å³é€€å‡º
          echo "===== Step 1: Install rclone and dependencies ====="
          sudo apt update -y && sudo apt install -y rsync curl wget jq fuse3 || { echo "âŒ Dependency installation failed"; exit 1; }
          
          # å®‰è£…rcloneå¹¶éªŒè¯
          curl https://rclone.org/install.sh | sudo bash
          if ! command -v rclone &> /dev/null; then
            echo "âŒ rclone installation failed"
            exit 1
          fi
          
          # é…ç½®fuseå…è®¸éžrootç”¨æˆ·ä½¿ç”¨allow_other
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          
          # ========== æ ¸å¿ƒä¿®å¤ï¼šè§£å†³GitHub Actionsä¸­sudoéœ€è¦tty/å¯†ç çš„é—®é¢˜ ==========
          # 1. ç¦ç”¨sudoçš„ttyè¦æ±‚ï¼ˆéžäº¤äº’çŽ¯å¢ƒå¿…å¤‡ï¼‰
          sudo sed -i 's/^Defaults    requiretty/#Defaults    requiretty/' /etc/sudoers
          # 2. é…ç½®runnerç”¨æˆ·å®Œå…¨å…å¯†sudoï¼ˆé€‚é…Actionsä¸´æ—¶çŽ¯å¢ƒï¼‰
          echo "runner ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/runner
          sudo chmod 0440 /etc/sudoers.d/runner
          # 3. éªŒè¯å…å¯†sudoæ˜¯å¦ç”Ÿæ•ˆ
          echo "ðŸ” Verifying password-less sudo access..."
          if ! sudo -n true; then
            echo "âŒ Sudo password-less configuration failed!"
            exit 1
          fi
          echo "âœ… Sudo password-less access verified"
          # ========== sudoä¿®å¤ç»“æŸ ==========
          
          echo "âœ… Initialization completed"

      # ========== æ­¥éª¤1.5ï¼šåˆ›å»º roots ç”¨æˆ·ï¼ˆå®‰å…¨ä¼˜åŒ–ï¼‰ ==========
      - name: Step 1.5 - Create roots User
        run: |
          set -e
          echo "===== Step 1.5: Create roots user ====="
          # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
          if id "roots" &>/dev/null; then
            echo "â„¹ï¸ roots user already exists"
          else
            sudo useradd -m -s /bin/bash roots
            # ä½¿ç”¨ç§˜é’¥å¯†ç æˆ–éšæœºç”Ÿæˆï¼ˆé¿å…ç¡¬ç¼–ç ï¼‰
            if [ -n "$ROOTS_PASSWORD" ]; then
              echo "roots:$ROOTS_PASSWORD" | sudo chpasswd
              echo "âœ… roots user created with custom password"
            else
              RANDOM_PASS=$(openssl rand -base64 12)
              echo "roots:$RANDOM_PASS" | sudo chpasswd
              echo "âœ… roots user created with random password: $RANDOM_PASS"
            fi
            sudo usermod -aG sudo roots
          fi
          echo "âœ… Debug user 'roots' is ready"

      # ========== æ­¥éª¤2ï¼šä½¿ç”¨ rclone æŒ‚è½½ WebDAVï¼ˆä¿®å¤å‚æ•°é”™è¯¯ï¼‰ ==========
      - name: Step 2 - Mount WebDAV with rclone
        run: |
          set -e
          echo "===== Step 2: Mount WebDAV via rclone ====="
          # ç©ºå€¼æ£€æŸ¥ï¼šç¼ºå°‘WebDAVé…ç½®åˆ™ç›´æŽ¥è·³è¿‡
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASSWORD" ]; then
            echo "âŒ WebDAV secrets not configured"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # åˆ›å»ºæŒ‚è½½ç›®å½•
          mkdir -p "$WEBDAV_MOUNT_POINT"
          
          # é…ç½®rcloneï¼ˆåŠ å¯†å¯†ç ï¼Œæå‡å®‰å…¨æ€§ï¼‰
          ENCRYPTED_PASS=$(rclone obscure "$WEBDAV_PASSWORD")
          rclone config create mywebdav webdav \
            url="$WEBDAV_URL" \
            vendor="other" \
            user="$WEBDAV_USER" \
            pass="$ENCRYPTED_PASS" \
            --config /home/runner/.rclone.conf

          # ========== æ ¸å¿ƒä¿®å¤ï¼šrclone mount å‘½ä»¤å‚æ•°æ ¼å¼ ==========
          # åˆå¹¶å‘½ä»¤è¡Œå‚æ•°ä¸ºå•è¡Œï¼Œé¿å…æ¢è¡Œ/ç©ºæ ¼å¯¼è‡´çš„ç©ºå‚æ•°
          nohup rclone mount mywebdav: "$WEBDAV_MOUNT_POINT" --config /home/runner/.rclone.conf --vfs-cache-mode full --daemon-timeout 1h --allow-other --umask 022 --log-file /tmp/rclone.log --log-level DEBUG --retries 3 >/dev/null 2>&1 &
          # ========== ä¿®å¤ç»“æŸ ==========

          # å¢žå¼ºåž‹æŒ‚è½½æ£€æŸ¥ï¼ˆå¤šæ¬¡é‡è¯•ï¼‰
          MOUNT_SUCCESS=false
          for i in $(seq 1 $MAX_MOUNT_RETRIES); do
            echo "ðŸ” Checking mount attempt $i/$MAX_MOUNT_RETRIES..."
            if timeout 5 ls "$WEBDAV_MOUNT_POINT" >/dev/null 2>&1; then
              MOUNT_SUCCESS=true
              break
            fi
            sleep $RETRY_DELAY
          done

          # æŒ‚è½½ç»“æžœå¤„ç†
          if [ "$MOUNT_SUCCESS" = true ]; then
            echo "âœ… rclone WebDAV mount succeeded"
            echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
            # æ£€æŸ¥å¤‡ä»½ç›®å½•æ˜¯å¦å­˜åœ¨æœ‰æ•ˆæ•°æ®
            for dir in $BACKUP_DIRS; do
              target_path="$WEBDAV_MOUNT_POINT$dir"
              mkdir -p "$target_path"
              if [ -n "$(ls -A "$target_path" 2>/dev/null)" ]; then
                echo "âœ… Valid backup detected: $dir"
                key="HAS_$(echo "$dir" | tr '/' '_' | tr -d '-')"
                echo "${key}=true" >> "$GITHUB_ENV"
              else
                echo "âš ï¸ Empty backup directory: $dir"
                key="HAS_$(echo "$dir" | tr '/' '_' | tr -d '-')"
                echo "${key}=false" >> "$GITHUB_ENV"
              fi
            done
          else
            echo "âŒ rclone mount failed after $MAX_MOUNT_RETRIES retries"
            cat /tmp/rclone.log || echo "No rclone log found"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      # ========== æ­¥éª¤3ï¼šæ•°æ®æ¢å¤ï¼ˆå¢žå¼ºå®¹é”™ï¼‰ ==========
      - name: Step 3 - Restore Data
        if: ${{ env.WEBDAV_AVAILABLE == 'true' }}
        run: |
          set -e
          echo "===== Step 3: Restore Data ====="
          RESTORE_DONE=false
          
          # éªŒè¯rsyncå‘½ä»¤æ˜¯å¦å­˜åœ¨
          if ! command -v rsync &> /dev/null; then
            echo "âŒ rsync not found"
            echo "DATA_RESTORED=false" >> "$GITHUB_ENV"
            exit 0
          fi

          # éåŽ†å¤‡ä»½ç›®å½•å°è¯•æ¢å¤
          for dir in $BACKUP_DIRS; do
            env_key="HAS_$(echo "$dir" | tr '/' '_' | tr -d '-')"
            if [ "${!env_key}" = "true" ]; then
              echo "ðŸ”„ Restoring system state from $dir..."
              # æž„å»ºæŽ’é™¤å‚æ•°
              EXCLUDE_PARAMS=()
              for excl in $EXCLUDE_DIRS; do
                EXCLUDE_PARAMS+=("--exclude=$excl")
              done
              # æŽ’é™¤æŒ‚è½½ç‚¹è‡ªèº«ï¼Œé¿å…å¾ªçŽ¯å¤‡ä»½
              EXCLUDE_PARAMS+=("--exclude=$WEBDAV_MOUNT_POINT")
              target_path="$WEBDAV_MOUNT_POINT$dir"

              # æ‰§è¡Œrsyncæ¢å¤ï¼ˆå¸¦è¿›åº¦å’Œæ—¥å¿—ï¼‰
              sudo rsync -avP --delete --copy-links --sparse --numeric-ids \
                "${EXCLUDE_PARAMS[@]}" "$target_path/" / \
                --log-file=/tmp/rsync_restore.log
              
              # æ£€æŸ¥æ¢å¤æ˜¯å¦æˆåŠŸ
              if [ $? -eq 0 ]; then
                RESTORE_DONE=true
                echo "âœ… Restore succeeded ($dir)"
                break
              else
                echo "âš ï¸ Restore $dir failed, log:"
                cat /tmp/rsync_restore.log || echo "No restore log"
              fi
            fi
          done
          echo "DATA_RESTORED=$RESTORE_DONE" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤4ï¼šå®‰è£… CasaOS ==========
      - name: Step 4 - Install or Skip CasaOS
        run: |
          set -e
          echo "===== Step 4: Install or Skip CasaOS ====="
          # å·²æ¢å¤æ•°æ®åˆ™è·³è¿‡å®‰è£…
          if [ -d "$CASAOS_DATA" ] && [ "$DATA_RESTORED" = "true" ]; then
            echo "âœ… CasaOS data restored, skip installation"
          else
            # å®‰è£…å‰æ£€æŸ¥ç½‘ç»œè¿žé€šæ€§
            if ! curl -fsSL https://get.casaos.io >/dev/null; then
              echo "âŒ Cannot reach CasaOS install server"
              exit 1
            fi
            # æ‰§è¡ŒCasaOSå®‰è£…
            curl -fsSL https://get.casaos.io | sudo bash || { 
              echo "âŒ CasaOS installation failed"
              cat /var/log/casaos-install.log || echo "No CasaOS install log"
              exit 1
            }
            echo "âœ… CasaOS installation completed"
          fi

      # ========== æ­¥éª¤5ï¼šå¯åŠ¨æœåŠ¡ï¼ˆå¢žåŠ é‡è¯•ï¼‰ ==========
      - name: Step 5 - Start Services
        run: |
          set -e
          echo "===== Step 5: Start Docker + CasaOS ====="
          # å¯åŠ¨æœåŠ¡å¹¶é‡è¯•ï¼ˆå®¹é”™å¤„ç†ï¼‰
          for i in $(seq 1 3); do
            sudo systemctl enable --now docker casaos
            sleep 10
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
              echo "âœ… Services started successfully"
              break
            fi
            echo "âš ï¸ Service startup attempt $i failed, retrying..."
            sudo systemctl restart docker casaos
          done

          # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ï¼Œå¤±è´¥åˆ™ç»ˆæ­¢
          if ! sudo systemctl is-active --quiet docker || ! sudo systemctl is-active --quiet casaos; then
            echo "âŒ Service startup failed after retries"
            echo "Docker status: $(sudo systemctl status docker --no-pager)"
            echo "CasaOS status: $(sudo systemctl status casaos --no-pager)"
            exit 1
          fi

      # ========== æ­¥éª¤6ï¼šéƒ¨ç½² Tailscale ==========
      - name: Step 6 - Deploy Tailscale
        run: |
          set -e
          echo "===== Step 6: Deploy Tailscale ====="
          # ç¼ºå°‘å¯†é’¥åˆ™è·³è¿‡
          if [ -z "$TAILSCALE_AUTH_KEY" ]; then
            echo "âš ï¸ TAILSCALE_AUTH_KEY not configured, skip networking"
            exit 0
          fi

          # å®‰è£…Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo bash
          if ! command -v tailscale &> /dev/null; then
            echo "âŒ Tailscale installation failed"
            exit 1
          fi

          # è¿žæŽ¥Tailscaleï¼ˆå¸¦é‡è¯•ï¼‰
          for i in $(seq 1 3); do
            sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --accept-routes --hostname="casaos-runner-${{ github.run_id }}"
            sleep 5
            TAILSCALE_IP=$(sudo tailscale ip -4)
            if [ -n "$TAILSCALE_IP" ]; then
              break
            fi
            echo "âš ï¸ Tailscale connection attempt $i failed"
          done

          # éªŒè¯è¿žæŽ¥ç»“æžœ
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Tailscale connection failed"
            echo "Tailscale log: $(sudo tailscale status)"
            exit 1
          fi
          echo "âœ… Tailscale IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      # ========== æ­¥éª¤7ï¼šè¾“å‡ºè®¿é—®ä¿¡æ¯ ==========
      - name: Step 7 - Print Access Info
        run: |
          set -e
          echo "===== Step 7: Access Information ====="
          # å¤šæºèŽ·å–å…¬ç½‘IPï¼ˆé¿å…å•æºå¤±æ•ˆï¼‰
          PUBLIC_IP=$(curl -s --max-time 10 ifconfig.me || curl -s --max-time 10 icanhazip.com || echo "Unknown")
          echo "ðŸ”— Public IP: http://$PUBLIC_IP"
          if [ -n "${{ env.TAILSCALE_IP }}" ]; then
            echo "ðŸ”’ Tailscale IP: http://${{ env.TAILSCALE_IP }}"
          fi
          echo "ðŸ‘¤ Debug User: roots (password from secrets or random generated)"
          echo "âš ï¸ Please change CasaOS default password immediately!"

      # ========== æ­¥éª¤8ï¼šä¿æ´» + å¤‡ä»½ + ç»­è·‘ï¼ˆä¿®å¤é€»è¾‘ï¼‰ ==========
      - name: Step 8 - Keep Alive + Backup + Renew
        shell: bash
        run: |
          set -e
          echo "===== Step 8: Keep Alive + Backup + Renew ====="
          start_time=$(date +%s)
          RENEW_TRIGGERED=false  # é˜²æ­¢é‡å¤è§¦å‘ç»­è·‘

          # è§¦å‘ç»­è·‘å·¥ä½œæµå‡½æ•°
          trigger_renew() {
            if [ -n "$USER_PAT" ] && [ -n "$REPO" ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "ðŸ”„ Triggering renew workflow..."
              RESPONSE=$(curl -fsS -X POST -H "Authorization: token $USER_PAT" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/dispatches" \
                -d '{"event_type":"renew_casaos_tailscale"}' 2>&1)
              if [ $? -eq 0 ]; then
                echo "âœ… Renew workflow triggered"
                RENEW_TRIGGERED=true
              else
                echo "âŒ Failed to trigger renew: $RESPONSE"
              fi
            fi
          }
          
          # å¤‡ä»½å•ä¸ªç›®å½•å‡½æ•°
          backup_single_dir() {
            if [ "${WEBDAV_AVAILABLE}" != "true" ]; then
              echo "âŒ WebDAV not available, skip backup"
              return 1
            fi
            local dir="$1"
            local target_path="$WEBDAV_MOUNT_POINT$dir"
            mkdir -p "$target_path"

            # æž„å»ºæŽ’é™¤å‚æ•°
            EXCLUDE_PARAMS=()
            for excl in $EXCLUDE_DIRS; do
              EXCLUDE_PARAMS+=("--exclude=$excl")
            done
            EXCLUDE_PARAMS+=("--exclude=$WEBDAV_MOUNT_POINT")
            
            # æ‰§è¡Œå¤‡ä»½ï¼ˆå¸¦è¿›åº¦å’Œæ—¥å¿—ï¼‰
            echo "ðŸ”„ Starting backup to $dir ..."
            if sudo rsync -avP --delete --copy-links --sparse --numeric-ids \
                "${EXCLUDE_PARAMS[@]}" / "$target_path/" \
                --log-file=/tmp/rsync_backup.log; then
              # å†™å…¥å¤‡ä»½å…ƒä¿¡æ¯ï¼ˆsudoç¡®ä¿æƒé™ï¼‰
              BACKUP_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              RUNNER_ID="${{ github.run_id }}"
              GITHUB_REPO="${{ github.repository }}"
              WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              
              sudo printf '%s\n' \
                "backup_time=$BACKUP_TIME" \
                "runner_id=$RUNNER_ID" \
                "github_repo=$GITHUB_REPO" \
                "workflow_run_url=$WORKFLOW_URL" \
                > "$target_path/backup_info.txt"
              
              echo "âœ… Backup completed ($dir)"
              return 0
            else
              echo "âŒ Backup failed, log:"
              cat /tmp/rsync_backup.log || echo "No backup log"
              return 1
            fi
          }
          
          # ä¿æ´»ä¸»å¾ªçŽ¯ï¼ˆä¿®å¤é‡å¤è§¦å‘é—®é¢˜ï¼‰
          while true; do
            current_time=$(date +%s)
            run_mins=$(( (current_time - start_time) / 60 ))
            echo "ðŸ“Š Running for $run_mins/$MAX_RUN_MINUTES minutes"
            
            # å‰©ä½™60åˆ†é’Ÿæ—¶è§¦å‘å¤‡ä»½å’Œç»­è·‘ï¼ˆä»…è§¦å‘ä¸€æ¬¡ï¼‰
            if [ $run_mins -ge 300 ] && [ "$RENEW_TRIGGERED" = "false" ]; then
              echo "â° 60 minutes remaining, starting backup and renew..."
              for dir in $BACKUP_DIRS; do
                if backup_single_dir "$dir"; then
                  trigger_renew
                  break
                fi
              done
            fi
            
            # è¾¾åˆ°æ—¶é—´é™åˆ¶åˆ™é€€å‡º
            if [ $run_mins -ge $MAX_RUN_MINUTES ]; then
              echo "â¹ï¸ Reached $MAX_RUN_MINUTES minutes limit, exiting"
              exit 0
            fi
            
            sleep 60
          done

      # ========== æ­¥éª¤9ï¼šæ¸…ç†çŽ¯å¢ƒï¼ˆæ— è®ºæˆè´¥éƒ½æ‰§è¡Œï¼‰ ==========
      - name: Step 9 - Cleanup Environment
        if: ${{ always() }}
        run: |
          set -e
          echo "===== Step 9: Cleanup ====="
          # å®‰å…¨å¸è½½WebDAVæŒ‚è½½ç‚¹
          if mount | grep -q "$WEBDAV_MOUNT_POINT"; then
            fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null || sudo fusermount3 -u "$WEBDAV_MOUNT_POINT" 2>/dev/null
          fi
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œé…ç½®
          sudo rm -rf /tmp/* /var/tmp/* /home/runner/.rclone.conf 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/runner 2>/dev/null || true
          echo "âœ… Cleanup completed"
