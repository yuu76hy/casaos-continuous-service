name: CasaOS Cloud Instance

# è§¦å‘è§„åˆ™ï¼šæ‰‹åŠ¨+æ¯5å°æ—¶è‡ªåŠ¨+å¯è¢«è°ƒç”¨
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'
  workflow_call:

# ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
env:
  SOURCE_DIRS: "/var/lib/casaos /var/lib/docker /DATA"
  BACKUP_BUCKET: "/z/Ubu"
  WEBDAV_MOUNT_POINT: /home/runner/webdav_mount
  WEBDAV_REMOTE_NAME: "mywebdav"
  EXCLUDE_DIRS: >-
    /bin /boot /dev /lib /lib32 /lib64 /lost+found /proc /root /run /sbin /sys /tmp
    /var/cache /var/log /var/tmp /var/backups /home/runner /mnt /media
    /usr/share/doc /usr/share/man /usr/share/locale /etc/ssl/certs
    /etc/fstab /etc/mtab /etc/hostname /etc/machine-id
    /var/lib/docker/tmp
    /var/lib/docker/overlay2
    /var/lib/docker/containers/*/mounts
    /var/lib/docker/network/files
    /var/lib/docker/buildkit
    /var/lib/docker/runtimes
    /var/lib/docker/swarm
    /var/lib/docker/trust

# æ ¸å¿ƒä»»åŠ¡ï¼ˆå”¯ä¸€jobï¼‰
jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      # 1. å‡†å¤‡ç³»ç»Ÿç¯å¢ƒï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
      - name: ğŸ“¦ 1. å‡†å¤‡ç³»ç»Ÿç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone rsync curl wget fuse
          echo 'user_allow_other' | sudo tee -a /etc/fuse.conf > /dev/null
          mkdir -p ${{ env.WEBDAV_MOUNT_POINT }}
          mkdir -p ~/.config/rclone
          chmod 700 ~/.config/rclone

      # 2. é…ç½®å¹¶æŒ‚è½½ WebDAVï¼ˆå¯¹åº”ä½ æŠ¥é”™çš„60/61è¡Œï¼Œæ ¸å¿ƒä¿®å¤ï¼ï¼‰
      - name: ğŸŒ 2. é…ç½®å¹¶æŒ‚è½½ WebDAV
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          # æ ¡éªŒWebDAVé…ç½®æ˜¯å¦å­˜åœ¨
          if [ -z "$WEBDAV_URL" ]; then
            echo "âš ï¸ æœªé…ç½® WEBDAV_URL"
            echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"
            exit 0
          fi
          # ç”ŸæˆRcloneé…ç½®æ–‡ä»¶
          cat > ~/.config/rclone/rclone.conf << EOF
[${{ env.WEBDAV_REMOTE_NAME }}]
type = webdav
url = $WEBDAV_URL
vendor = other
user = $WEBDAV_USER
pass = $WEBDAV_PASSWORD
EOF
          chmod 600 ~/.config/rclone/rclone.conf
          # æŒ‚è½½WebDAVï¼ˆå‚æ•°åˆè§„ï¼Œæ— è¯­æ³•é”™è¯¯ï¼‰
          rclone mount ${{ env.WEBDAV_REMOTE_NAME }}: ${{ env.WEBDAV_MOUNT_POINT }} \
            --allow-other \
            --vfs-cache-mode writes \
            --daemon \
            --timeout 5m \
            --dir-cache-time 10m \
            --poll-interval 5m \
            --log-file /tmp/rclone_mount.log
          # å¾ªç¯æ£€æŸ¥æŒ‚è½½çŠ¶æ€
          for i in {1..5}; do
            sleep 3
            if mountpoint -q ${{ env.WEBDAV_MOUNT_POINT }}; then
              echo "âœ… WebDAV æŒ‚è½½æˆåŠŸ"
              echo "WEBDAV_AVAILABLE=true" >> "$GITHUB_ENV"
              exit 0
            fi
          done
          # æŒ‚è½½å¤±è´¥å¤„ç†
          echo "âŒ WebDAV æŒ‚è½½å¤±è´¥ï¼Œæ—¥å¿—ï¼š"
          cat /tmp/rclone_mount.log 2>/dev/null || echo "æ— æ—¥å¿—"
          echo "WEBDAV_AVAILABLE=false" >> "$GITHUB_ENV"

      # 3. æ¢å¤æ•°æ®ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
      - name: ğŸ“¥ 3. æ¢å¤æ•°æ®ï¼ˆä» /z/Ubuï¼‰
        if: env.WEBDAV_AVAILABLE == 'true'
        run: |
          echo "ğŸ“‚ æ­£åœ¨ä»ç½‘ç›˜æ¢å¤æ•°æ®..."
          IFS=' ' read -r -a dirs <<< "$SOURCE_DIRS"
          for dir in "${dirs[@]}"; do
            webdav_src="${WEBDAV_MOUNT_POINT}${BACKUP_BUCKET}${dir}"
            if [ -d "$webdav_src" ] && [ -n "$(ls -A "$webdav_src" 2>/dev/null)" ]; then
              echo "ğŸ”„ æ¢å¤ $dir ..."
              sudo mkdir -p "$dir"
              # æ„å»ºæ’é™¤å‚æ•°ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
              EXCLUDE_PARAMS=()
              while IFS= read -r excl; do
                [ -z "$excl" ] && continue
                if [[ "$excl" == "$dir"* ]]; then
                  EXCLUDE_PARAMS+=("--exclude=$excl")
                fi
              done <<< "$EXCLUDE_DIRS"
              # æ‰§è¡Œrsyncæ¢å¤
              sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                "${EXCLUDE_PARAMS[@]}" "$webdav_src/" "$dir/"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ° $dir çš„å¤‡ä»½ï¼Œè·³è¿‡..."
            fi
          done

      # 4. å®‰è£… CasaOSï¼ˆå¯¹åº”ä½ æŠ¥é”™çš„78è¡Œï¼Œæ ¸å¿ƒä¿®å¤ï¼ï¼‰
      - name: ğŸ  4. å®‰è£… CasaOS
        if: ${{ env.WEBDAV_AVAILABLE != 'true' || github.event_name != 'schedule' }}
        run: |
          echo "ğŸš€ å®‰è£… CasaOS..."
          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
          if ! command -v casaos-service &> /dev/null; then
            # é‡è¯•æœºåˆ¶ï¼Œæé«˜å®‰è£…æˆåŠŸç‡
            curl -fsSL https://get.casaos.io | sudo bash || {
              echo "âš ï¸ é¦–æ¬¡å®‰è£…å¤±è´¥ï¼Œé‡è¯•..."
              sleep 10
              curl -fsSL https://get.casaos.io | sudo bash
            }
          fi
          # åˆå§‹åŒ–DATAç›®å½•
          sudo mkdir -p /DATA
          sudo chown -R runner:runner /DATA
          sudo chmod 775 /DATA

      # 5. å¯åŠ¨æœåŠ¡ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
      - name: â–¶ï¸ 5. å¯åŠ¨æœåŠ¡
        run: |
          # é‡è½½ç³»ç»ŸæœåŠ¡é…ç½®
          sudo systemctl daemon-reload
          sudo systemctl enable docker casaos
          sudo systemctl start docker
          sleep 5  # ç­‰å¾…Dockerå¯åŠ¨
          sudo systemctl start casaos
          sleep 10
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          if sudo systemctl is-active --quiet docker && sudo systemctl is-active --quiet casaos; then
            echo "âœ… CasaOS å’Œ Docker å·²å¯åŠ¨"
          else
            echo "âŒ CasaOS æˆ– Docker å¯åŠ¨å¤±è´¥"
            sudo systemctl status docker
            sudo systemctl status casaos
            exit 1
          fi

      # 6. è¿æ¥ Tailscaleï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
      - name: ğŸ” 6. è¿æ¥ Tailscale
        if: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # å®‰è£…Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          # å¯åŠ¨å¹¶è®¤è¯
          sudo tailscale up --authkey="$TS_AUTH_KEY" --hostname=CasaOS-Cloud --accept-routes --accept-dns
          sleep 5
          # è¾“å‡ºTailscale IP
          echo "ğŸ›¡ï¸ Tailscale IPv4: $(tailscale ip -4)"
          echo "ğŸ›¡ï¸ Tailscale IPv6: $(tailscale ip -6)"

      # 7. æŒç»­è¿è¡Œä¸è‡ªåŠ¨å¤‡ä»½ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
      - name: ğŸ”„ 7. æŒç»­è¿è¡Œä¸è‡ªåŠ¨å¤‡ä»½
        run: |
          echo "â³ å®ä¾‹å·²å¯åŠ¨ï¼Œæ­£åœ¨è¿è¡Œ..."
          START_TIME=$(date +%s)
          # å®šä¹‰å¤‡ä»½å‡½æ•°
          backup_dir() {
            local src="$1"
            local dst="${WEBDAV_MOUNT_POINT}${BACKUP_BUCKET}${src}"
            echo "ğŸ“¦ æ­£åœ¨å¤‡ä»½ $src ..."
            sudo mkdir -p "$dst"
            # æ„å»ºæ’é™¤å‚æ•°
            local exclude_params=()
            while IFS= read -r excl; do
              [ -z "$excl" ] && continue
              if [[ "$excl" == "$src"* ]]; then
                exclude_params+=(--exclude="$excl")
              fi
            done <<< "$EXCLUDE_DIRS"
            # æ‰§è¡Œå¤‡ä»½
            if sudo rsync -av --delete --copy-links --sparse --numeric-ids \
                "${exclude_params[@]}" "$src/" "$dst/"; then
              sudo date -u +"%Y-%m-%dT%H:%M:%SZ" > "$dst/backup_timestamp.txt"
              echo "âœ… $src å¤‡ä»½æˆåŠŸ"
              return 0
            else
              echo "âŒ $src å¤‡ä»½å¤±è´¥"
              return 1
            fi
          }
          # ä¸»å¾ªç¯ï¼šæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿è¡Œæ—¶é•¿
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$(( (CURRENT_TIME - START_TIME) / 60 ))
            # è¿è¡Œ5å°æ—¶ï¼ˆ300åˆ†é’Ÿï¼‰åæ‰§è¡Œå¤‡ä»½å¹¶ç»­æ¯
            if [ $ELAPSED -ge 300 ]; then
              echo "â° æ—¶é—´å³å°†è€—å°½ï¼Œå¼€å§‹æ‰§è¡Œæœ€ç»ˆå¤‡ä»½..."
              IFS=' ' read -r -a dirs <<< "$SOURCE_DIRS"
              ALL_SUCCESS=true
              # éå†ç›®å½•æ‰§è¡Œå¤‡ä»½
              for dir in "${dirs[@]}"; do
                if [ -d "$dir" ]; then
                  if ! backup_dir "$dir"; then
                    ALL_SUCCESS=false
                  fi
                fi
              done
              # å¤‡ä»½æˆåŠŸåˆ™è§¦å‘ç»­æ¯
              if [ "$ALL_SUCCESS" = true ]; then
                echo "ğŸ”„ è§¦å‘ç»­æ¯..."
                # å…¼å®¹ä¸¤ç§PATå¯†é’¥åç§°
                PAT=${{ secrets.USER_PAT || secrets.USER_GITHUB_PAT }}
                if [ -n "$PAT" ]; then
                  # è‡ªåŠ¨è·å–å·¥ä½œæµæ–‡ä»¶åç§°
                  WORKFLOW_FILE="$(basename ${{ github.workflow_ref }})"
                  # è°ƒç”¨GitHub APIè§¦å‘å·¥ä½œæµ
                  curl -X POST \
                    -H "Authorization: Bearer $PAT" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${WORKFLOW_FILE}/dispatches" \
                    -d '{"ref": "main"}'
                  echo "âœ… ç»­æ¯è¯·æ±‚å·²å‘é€"
                else
                  echo "âŒ æœªæ‰¾åˆ° Personal Access Tokenï¼Œæ— æ³•ç»­æ¯"
                fi
              fi
              # é€€å‡ºå¾ªç¯ï¼Œç»“æŸä»»åŠ¡
              break
            fi
            # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            sleep 300
          done

      # 8. æ¸…ç†æŒ‚è½½ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
      - name: ğŸ§¹ 8. æ¸…ç†æŒ‚è½½
        if: always()
        run: |
          # å®‰å…¨å¸è½½WebDAVæŒ‚è½½
          fusermount -u ${{ env.WEBDAV_MOUNT_POINT }} 2>/dev/null || \
          sudo fusermount -u ${{ env.WEBDAV_MOUNT_POINT }} 2>/dev/null || true
          # åœæ­¢ç›¸å…³æœåŠ¡ï¼Œé‡Šæ”¾èµ„æº
          sudo systemctl stop casaos docker 2>/dev/null || true
