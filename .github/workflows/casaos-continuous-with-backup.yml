name: CasaOSçº¯å‡€éƒ¨ç½²ï¼ˆTailscaleå†…ç½‘ç‰ˆ /aaaç›®å½• æ‹‰å–å³åˆ  æ— é™æ£€æµ‹åˆ é™¤ï¼‰
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_casaos_snapshot]

jobs:
  casaos-deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      PERSONAL_DATA_DIRS: "/var/lib/docker /etc/casaos /var/lib/casaos /DATA"
      ROOTS_PASSWORD: ${{ secrets.ROOTS_PASSWORD }}
      USER_PAT: ${{ secrets.USER_PAT }}
      REPO: ${{ secrets.REPO }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      SSH_USER: "roots"
      SSH_PASS: ${{ secrets.ROOTS_PASSWORD }}
      REMOTE_BACKUP_BASE: "/aaa"
      LOCAL_BACKUP_DIR: "/tmp/casaos-backup"
      TARGET_RUN_MINUTES: 60
      RETRY_TIMES: 3
      MAX_POLL_TIMES: 360

    steps:
      - name: 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç†
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 1-ç³»ç»Ÿåˆå§‹åŒ–+å…¨åŸŸæ·±åº¦æ¸…ç† ====="
          sudo apt update -y -qq
          sudo apt install -y curl wget jq tar gzip lsof ca-certificates gnupg sshpass openssh-server zstd -qq

          sudo apt remove -y docker* containerd* runc* 2>/dev/null || true

          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          sudo rm -f /etc/systemd/system/casaos.service /usr/lib/systemd/system/casaos.service 2>/dev/null || true
          sudo systemctl daemon-reload

          sudo rm -rf \
            /usr/local/lib /usr/local/.ghcup /usr/local/julia* /usr/local/aws-* /usr/local/n \
            /opt/hostedtoolcache /opt/actionarchivecache /opt/runner-cache /opt/microsoft /opt/google \
            2>/dev/null || true

          sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y
          sudo DEBIAN_FRONTEND=noninteractive apt clean
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /root/.cache/* /var/cache/apt/* 2>/dev/null || true

          sync && sudo sysctl -w vm.drop_caches=3 2>/dev/null || true
          sudo systemctl enable --now ssh
          echo "âœ… ç³»ç»Ÿåˆå§‹åŒ–+æ·±åº¦æ¸…ç†å®Œæˆ"

      - name: 2-å®˜æ–¹çº¯å‡€å®‰è£… Docker
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 2-å®‰è£… Dockerï¼ˆå®˜æ–¹æºï¼‰ ====="
          export DEBIAN_FRONTEND=noninteractive
          curl -fsSL https://get.docker.com | sudo bash
          sudo systemctl enable docker containerd
          sudo systemctl stop docker containerd 2>/dev/null || true
          docker --version
          sudo usermod -aG docker runner
          echo "âœ… Docker å®‰è£…å®Œæˆï¼Œå·²åœæ­¢æœåŠ¡"

      - name: 3-å®˜æ–¹çº¯å‡€å®‰è£… CasaOS
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 3-å®‰è£… CasaOS ====="
          curl -fsSL https://get.casaos.io | sudo bash
          sudo systemctl stop casaos 2>/dev/null || true
          sudo systemctl disable casaos 2>/dev/null || true
          echo "âœ… CasaOS å®‰è£…å®Œæˆï¼Œå·²åœæ­¢æœåŠ¡"

      - name: 4-åˆ›å»º roots ç®¡ç†å‘˜+SSHå¯†ç ç™»å½•
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 4-é…ç½®ç®¡ç†å‘˜ç”¨æˆ· roots ====="
          if [[ -z "${SSH_PASS:-}" ]]; then
            echo "âŒ é”™è¯¯ï¼šROOTS_PASSWORD æœªé…ç½®"
            exit 1
          fi

          USER_NAME="roots"
          if ! id -u "${USER_NAME}" &>/dev/null; then
            sudo useradd -m -s /bin/bash "${USER_NAME}"
          fi
          echo "${USER_NAME}:${SSH_PASS}" | sudo chpasswd
          echo "${USER_NAME} ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/"${USER_NAME}" >/dev/null
          sudo chmod 0440 /etc/sudoers.d/"${USER_NAME}"
          sudo usermod -aG docker "${USER_NAME}"

          # ä»…å¼€å¯å¯†ç è®¤è¯ï¼Œä¸å¼€ root ç™»å½•ï¼ˆæ›´å®‰å…¨ï¼‰
          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          echo "âœ… ç®¡ç†å‘˜ç”¨æˆ· & SSH å¯†ç ç™»å½•é…ç½®å®Œæˆ"

      - name: 5-Tailscale ç»„ç½‘+ä¸Šçº¿+æ˜¾ç¤ºæœ¬æœºIP
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 5-Tailscaleç»„ç½‘ + æ˜¾ç¤ºæœ¬æœºä¿¡æ¯ ====="
          if [[ -z "${TAILSCALE_AUTH_KEY:-}" ]]; then
            echo "âš ï¸ Tailscale æœªé…ç½®ï¼Œè·³è¿‡ç»„ç½‘"
            exit 0
          fi

          echo "ğŸ”§ ä½¿ç”¨å®˜æ–¹ä¸€é”®è„šæœ¬å®‰è£… Tailscale"
          curl -fsSL https://tailscale.com/install.sh | sudo bash

          sudo systemctl enable --now tailscaled && sleep 2

          TS_SUFFIX=$((RANDOM % 10000))
          TS_HOSTNAME="CasaOS-${TS_SUFFIX}"
          echo "ğŸ”– æœ¬æ¬¡ Tailscale ä¸»æœºåï¼š${TS_HOSTNAME}"

          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${TS_HOSTNAME}" --accept-routes

          echo -e "\n=== ğŸ–¥ï¸ æœ¬æœº IP ä¿¡æ¯ ==="
          LOCAL_IP=$(hostname -I | awk '{print $1}')
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "è·å–å¤±è´¥")
          echo "âœ… ç‰©ç†å†…ç½‘IP: ${LOCAL_IP}"
          echo "âœ… Tailscaleå†…ç½‘IP: ${TAILSCALE_IP}"
          echo "==================================="
          echo "âœ… Tailscale ç»„ç½‘ä¸Šçº¿å®Œæˆ"

      - name: 6-ä»å†…ç½‘/aaaæ‹‰å¤‡ä»½â†’å¤šèŠ‚ç‚¹å°è¯•â†’æ‹‰å–å³åˆ â†’è¦†ç›–æ¢å¤
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 6-æ‹‰å–å¤‡ä»½+æ‹‰å–å³åˆ +è¦†ç›–æ¢å¤ ====="
          if [[ -z "${TAILSCALE_AUTH_KEY:-}" ]]; then
            echo "â„¹ï¸ Tailscale æœªé…ç½®ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi
          if [[ -z "${SSH_PASS:-}" ]]; then
            echo "âŒ é”™è¯¯ï¼šSSH_PASS æœªé…ç½®"
            exit 1
          fi

          TS_STATUS_JSON=$(sudo tailscale status --json)
          SELF_ID=$(echo "${TS_STATUS_JSON}" | jq -r '.Self.ID')

          echo -e "\nğŸ” ç­›é€‰åœ¨çº¿+å«casaos+æ’é™¤æœ¬æœºèŠ‚ç‚¹"
          TARGET_LIST=$(echo "${TS_STATUS_JSON}" | jq -r --arg self "${SELF_ID}" '
            .Peer[] |
            select(.Online == true) |
            select(.ID != $self) |
            select( (.HostName | tostring | ascii_downcase) | contains("casaos") ) |
            "\(.HostName // "unknown")|\(.TailscaleIPs[0] // "no-ip")"
          ' || true)

          if [[ -z "${TARGET_LIST}" ]]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶èŠ‚ç‚¹ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi

          echo -e "\nğŸ›‘ åœæ­¢ Docker/CasaOS ç¡®ä¿æ— æ–‡ä»¶å ç”¨"
          sudo systemctl stop casaos 2>/dev/null
          sudo systemctl stop docker containerd 2>/dev/null
          sync && sleep 2

          sudo mkdir -p "${LOCAL_BACKUP_DIR}"
          RESTORE_SUCCESS=0

          while IFS='|' read -r TARGET_HOST TARGET_IP; do
            echo -e "\n==========================================================="
            echo "ğŸ¯ å°è¯•èŠ‚ç‚¹ï¼š${TARGET_HOST} | ${TARGET_IP}"
            echo "==========================================================="

            LATEST_FILE=""
            for ((i=1; i<=RETRY_TIMES; i++)); do
              LATEST_FILE=$(sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
                "${SSH_USER}@${TARGET_IP}" "ls -t \"${REMOTE_BACKUP_BASE}\"/casaos-*.tar.zst 2>/dev/null | head -1" || true)
              [[ -n "${LATEST_FILE}" ]] && break
              sleep 3
            done

            if [[ -z "${LATEST_FILE}" ]]; then
              echo "âš ï¸ æ— å¤‡ä»½æ–‡ä»¶ï¼Œè·³è¿‡"
              continue
            fi

            LOCAL_FILE="${LOCAL_BACKUP_DIR}/$(basename "${LATEST_FILE}")"
            pull_success=0
            for ((i=1; i<=RETRY_TIMES; i++)); do
              if sudo sshpass -p "${SSH_PASS}" scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
                "${SSH_USER}@${TARGET_IP}:${LATEST_FILE}" "${LOCAL_FILE}"; then
                pull_success=1
                break
              fi
              sleep 3
            done

            if [[ ${pull_success} -ne 1 || ! -s "${LOCAL_FILE}" ]]; then
              echo "âš ï¸ æ‹‰å–å¤±è´¥/æ–‡ä»¶æ— æ•ˆï¼Œè·³è¿‡"
              rm -f "${LOCAL_FILE}" 2>/dev/null || true
              continue
            fi

            echo -e "\nğŸ—‘ï¸ æ‹‰å–æˆåŠŸï¼Œåˆ é™¤è¿œç¨‹æºæ–‡ä»¶"
            sshpass -p "${SSH_PASS}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              "${SSH_USER}@${TARGET_IP}" "sudo rm -f '${LATEST_FILE}'" || echo "âš ï¸ è¿œç¨‹åˆ é™¤å¤±è´¥ï¼Œç»§ç»­æ¢å¤"

            echo -e "\nğŸ”§ è§£å‹æ¢å¤åˆ°æ ¹ç›®å½• / â†’ è¦†ç›–æ¨¡å¼"
            sudo tar --zstd -xf "${LOCAL_FILE}" -C / --overwrite --preserve-permissions

            echo -e "\nğŸ” ä¿®å¤ç›®å½•æƒé™"
            for dir in ${PERSONAL_DATA_DIRS}; do
              [[ -d "${dir}" ]] && sudo chown -R root:root "${dir}"
            done
            [[ -d "/etc/casaos" ]]     && sudo chmod -R 755 /etc/casaos
            [[ -d "/DATA" ]]           && sudo chmod -R 755 /DATA
            [[ -d "/var/lib/casaos" ]] && sudo chmod -R 700 /var/lib/casaos
            [[ -d "/var/lib/docker" ]] && sudo chmod -R 700 /var/lib/docker

            echo -e "\nğŸ‰ æ¢å¤æˆåŠŸï¼"
            RESTORE_SUCCESS=1
            break

          done < <(echo "${TARGET_LIST}")

          if [[ ${RESTORE_SUCCESS} -ne 1 ]]; then
            echo -e "\nâŒ æ‰€æœ‰èŠ‚ç‚¹å°è¯•å¤±è´¥ï¼Œçº¯å‡€å¯åŠ¨"
            exit 0
          fi

      - name: 7-å¯åŠ¨ Docker & CasaOS
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 7-å¯åŠ¨æ ¸å¿ƒæœåŠ¡ ====="
          sudo fuser -k 80/tcp 443/tcp 2>/dev/null || true
          sudo mkdir -p /run/docker 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo systemctl enable --now docker containerd && sleep 5
          sudo systemctl enable --now casaos && sleep 5
          echo "âœ… Docker & CasaOS å¯åŠ¨å®Œæˆ"

      - name: 8-ç¨³å®šè¿è¡Œ60åˆ†é’Ÿ
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 8-ç¨³å®šè¿è¡Œ ${TARGET_RUN_MINUTES} åˆ†é’Ÿ ====="
          sleep 3600
          echo "âœ… ç¨³å®šè¿è¡Œç»“æŸ"

      - name: 9-å®‰å…¨åœæ­¢ä¸šåŠ¡æœåŠ¡ï¼ˆä¿ç•™Tailscaleï¼‰
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 9-åœæ­¢ä¸šåŠ¡æœåŠ¡ ====="
          sudo systemctl stop casaos 2>/dev/null
          sudo systemctl stop docker containerd 2>/dev/null
          sudo rm -f /var/run/docker.pid /var/run/docker.sock.lock /var/run/containerd.pid 2>/dev/null || true
          sudo umount /var/lib/docker/overlay2/*/merged 2>/dev/null || true
          sync && sleep 5
          echo "âœ… ä¸šåŠ¡æœåŠ¡å·²åœæ­¢"

      - name: 10-æœ¬åœ°å…¨é‡å¤‡ä»½ï¼ˆä»…4ä¸ªç›®å½•ï¼Œtar.zst å‹ç¼©çº§åˆ«13ï¼‰
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 10-ç”Ÿæˆæœ¬åœ°å…¨é‡å¤‡ä»½ ====="
          sudo mkdir -p "${LOCAL_BACKUP_DIR}"
          DIR_ARRAY=(${PERSONAL_DATA_DIRS})
          for dir in "${DIR_ARRAY[@]}"; do
            [[ ! -d "${dir}" ]] && sudo mkdir -p "${dir}"
          done

          SNAP_NAME="casaos-full-$(date +%Y%m%d-%H%M%S).tar.zst"
          LOCAL_FILE="${LOCAL_BACKUP_DIR}/${SNAP_NAME}"

          # ä¿®å¤ï¼šæ”¹ç”¨ç®¡é“æ–¹å¼æŒ‡å®šzstdå‹ç¼©çº§åˆ«ï¼ˆé€‚é…Ubuntu 24.04çš„GNU tarï¼‰
          sudo tar -cf - --ignore-failed-read "${DIR_ARRAY[@]}" | sudo zstd -13 -o "${LOCAL_FILE}"

          if [[ -f "${LOCAL_FILE}" && -s "${LOCAL_FILE}" ]]; then
            echo "âœ… å¤‡ä»½å®Œæˆï¼š${SNAP_NAME}"
            echo "BACKUP_FILE=${LOCAL_FILE}" >> "${GITHUB_ENV}"
            echo "SNAP_NAME=${SNAP_NAME}" >> "${GITHUB_ENV}"
          else
            echo "âŒ å¤‡ä»½å¤±è´¥"
            exit 1
          fi

      - name: 11-è§¦å‘ä¸‹ä¸€è½®ç»­è·‘
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 11-è§¦å‘ä¸‹ä¸€è½®ç»­è·‘ ====="
          if [[ -z "${USER_PAT:-}" || -z "${REPO:-}" ]]; then
            echo "âš ï¸ æœªé…ç½® PAT/REPOï¼Œè·³è¿‡"
            exit 0
          fi
          response=$(curl -s -w "%{http_code}" -o /dev/null -X POST \
            --connect-timeout 10 --max-time 15 \
            -H "Authorization: token ${USER_PAT}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${REPO}/dispatches \
            -d '{"event_type":"renew_casaos_snapshot"}')
          if [[ "${response}" == "204" ]]; then
            echo "âœ… ç»­è·‘è§¦å‘æˆåŠŸ"
          else
            echo "âš ï¸ ç»­è·‘è§¦å‘å¤±è´¥ï¼ŒHTTP code: ${response}"
          fi

      - name: 12-ç§»å…¥/aaaå¹¶æ— é™è½®è¯¢æ£€æµ‹åˆ é™¤
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 12-å¤‡ä»½ç§»å…¥/aaa + è½®è¯¢åˆ é™¤æ£€æµ‹ ====="
          if [[ -z "${BACKUP_FILE:-}" || -z "${SNAP_NAME:-}" ]]; then
            echo "â„¹ï¸ æ— å¤‡ä»½ï¼Œè·³è¿‡"
            exit 0
          fi

          LOCAL_AAA="/aaa"
          sudo mkdir -p "${LOCAL_AAA}"
          TARGET_FILE="${LOCAL_AAA}/${SNAP_NAME}"
          sudo mv -v "${BACKUP_FILE}" "${TARGET_FILE}"

          echo -e "\nâŒ› æ¯1åˆ†é’Ÿæ£€æµ‹æ–‡ä»¶æ˜¯å¦è¢«åˆ é™¤ï¼ˆæœ€å¤š${MAX_POLL_TIMES}æ¬¡ï¼‰"
          poll_count=0
          while true; do
            if [[ ! -f "${TARGET_FILE}" ]]; then
              echo "ğŸ‰ æ–‡ä»¶å·²åˆ é™¤ï¼Œé€€å‡ºè½®è¯¢"
              break
            fi
            ((poll_count++))
            if [[ ${poll_count} -ge ${MAX_POLL_TIMES} ]]; then
              echo "âš ï¸ è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œè‡ªåŠ¨é€€å‡º"
              break
            fi
            echo "â†’ ${poll_count}/${MAX_POLL_TIMES} æ–‡ä»¶å­˜åœ¨ï¼Œ60ç§’åé‡è¯•"
            sleep 60
          done

      - name: 13-æœ€ç»ˆæ¸…ç†+å…³é—­Tailscale
        if: ${{ always() }}
        run: |
          set -euo pipefail
          echo "===== [$(date '+%Y-%m-%d %H:%M:%S')] 13-æœ€ç»ˆæ¸…ç† + å…³é—­Tailscale ====="
          sudo systemctl stop tailscaled 2>/dev/null || true
          sudo rm -rf "${LOCAL_BACKUP_DIR:-}" /tmp/* 2>/dev/null || true
          sudo rm -f /etc/sudoers.d/roots 2>/dev/null || true
          sudo apt autoremove -y -qq && sudo apt clean -y -qq
          sudo rm -rf /var/cache/apt/* 2>/dev/null || true
          echo "âœ… å·²åœæ­¢Tailscale & æ¸…ç†å®Œæˆ"
          echo "ğŸ‰ å…¨æµç¨‹æ­£å¸¸ç»“æŸ"