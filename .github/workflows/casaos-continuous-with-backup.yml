name: Full-Featured CasaOS-Tailscale-Backup (Auto-Renew + Precision Backup)
on:
  workflow_dispatch:
  repository_dispatch:
    types: [renew_vnc]

jobs:
  deploy-casaos-tailscale:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      # ========== æ ¸å¿ƒè¿è¡Œé…ç½® ==========
      MAX_RUN_MINUTES: 330          # è§¦å‘å¤‡ä»½ç»­è·‘çš„é˜ˆå€¼ï¼ˆå‰©ä½™30åˆ†é’Ÿæ—¶æ‰§è¡Œï¼‰
      RUNNER_PASSWORD: "runner123"  # Runner ç”¨æˆ·å¯†ç ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      CASAOS_PORT: 80               # CasaOS é¢æ¿é»˜è®¤ç«¯å£
      KEEP_BACKUP_COUNT: 3          # å¤‡ä»½ä¿ç•™æ•°é‡ï¼ˆä»…ä¿ç•™æœ€æ–°3ä¸ªï¼‰
      CLEAN_INTERVAL: 3600          # æ·±åº¦æ¸…ç†é—´éš”ï¼ˆ3600ç§’=1å°æ—¶ï¼‰
      HEALTH_CHECK_TIMEOUT: 300     # æ–°å®¹å™¨å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆ300ç§’=5åˆ†é’Ÿï¼‰
      # ========== ç›®å½•è·¯å¾„é…ç½® ==========
      BACKUP_DIR: /home/runner/backup
      LOG_DIR: /home/runner/logs
      LOCAL_MOUNT_POINT: /mnt/webdav_casaos  # æœ¬åœ°æŒ‚è½½ç‚¹
      WEBDAV_REMOTE_DIR: /z/Ubu              # WebDAV æœåŠ¡ç«¯ç›®æ ‡ç›®å½•
      RCLONE_CACHE_DIR: /tmp/rclone_cache
      NEW_RUN_ID_FILE: /home/runner/new_run_id.txt
      # ========== å¤‡ä»½æ’é™¤è§„åˆ™ï¼ˆæ ¸å¿ƒï¼šæ’é™¤åƒåœ¾æ–‡ä»¶ï¼‰ ==========
      BACKUP_EXCLUDE: >-
        --exclude=/proc
        --exclude=/sys
        --exclude=/tmp
        --exclude=/dev
        --exclude=/run
        --exclude=/var/run
        --exclude=/home/runner/actions-runner
        --exclude=/var/lib/docker/tmp
        --exclude=/var/lib/docker/logs
        --exclude=/var/lib/docker/build
        --exclude=/var/lib/docker/tmpfs
        --exclude=/var/lib/docker/overlay2/tmp
        --exclude=/var/lib/docker/*-tmp
      # ========== å…¶ä»–é…ç½® ==========
      BACKUP_MARKER: latest_backup.txt
      LOG_FILE: casaos_service_${{ github.run_id }}_$(date +%Y%m%d_%H%M%S).log

    steps:
      - name: "Step 0: Pre-Check - Shell Env & Log Dir Init"
        id: pre_check
        continue-on-error: false
        run: |
          set -euo pipefail
          mkdir -p $LOG_DIR $RCLONE_CACHE_DIR
          chmod 755 $LOG_DIR $RCLONE_CACHE_DIR
          exec > >(tee -a $LOG_DIR/$LOG_FILE) 2>&1
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Pre-Check Completed ===="
          # æ‰“å°å·¥ä½œæµåŸºç¡€ä¿¡æ¯
          echo "===================================== WORKFLOW BASIC INFO ====================================="
          echo "ğŸ”§ Workflow Run ID: ${{ github.run_id }}"
          echo "ğŸ”§ WebDAV Remote Target: $WEBDAV_REMOTE_DIR"
          echo "ğŸ”§ Local Mount Point: $LOCAL_MOUNT_POINT"
          echo "ğŸ”§ Backup Retention: Keep Latest $KEEP_BACKUP_COUNT Backups"
          echo "ğŸ”§ Max Runtime: $MAX_RUN_MINUTES Minutes | Renew Trigger: 30 Mins Remaining"
          echo "=============================================================================================="

      - name: "Step 1: System Env Initialization"
        id: sys_init
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 1 Start: System Initialization ===="
          # ç³»ç»Ÿæ›´æ–°ä¸ä¾èµ–å®‰è£…
          echo "ğŸ“Š Initial System Free Space: $(df -h / | awk 'NR==2{print $4}')"
          sudo apt update -y && sudo apt upgrade -y -qq
          REQUIRED_PACKAGES="tar gzip rsync rclone fuse3 netcat-openbsd psmisc curl git wget jq bc"
          sudo apt install -y $REQUIRED_PACKAGES
          # é…ç½®Runnerå¯†ç 
          echo "runner:$RUNNER_PASSWORD" | sudo chpasswd
          # åˆ›å»ºæ ¸å¿ƒç›®å½•
          sudo mkdir -p $BACKUP_DIR $LOCAL_MOUNT_POINT /DATA
          sudo chown -R runner:runner $BACKUP_DIR $LOCAL_MOUNT_POINT /DATA
          sudo chmod -R 755 $BACKUP_DIR $LOCAL_MOUNT_POINT /DATA
          # æ‰“å°åˆå§‹åŒ–ç»“æœ
          echo "âœ… Dependencies Installed: $REQUIRED_PACKAGES"
          echo "âœ… Core Directories Created: $BACKUP_DIR | $LOCAL_MOUNT_POINT | /DATA"
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 1 Completed ===="

      - name: "Step 2: WebDAV Mount (Remote Dir: /z/Ubu) With Retry"
        id: webdav_setup
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 2 Start: WebDAV Configuration ===="
          # è¯»å–å¹¶æ ¡éªŒSecrets
          WEBDAV_URL=${{ secrets.WEBDAV_URL }}
          WEBDAV_USER=${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASS=${{ secrets.WEBDAV_PASSWORD }}
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USER" ] || [ -z "$WEBDAV_PASS" ]; then
            echo "ERROR: WebDAV Secrets Not Configured! Exit."
            exit 1
          fi
          # é…ç½®Rclone
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [webdav_remote]
          type = webdav
          url = $WEBDAV_URL
          vendor = generic
          user = $WEBDAV_USER
          pass = $WEBDAV_PASS
          timeout = 30s
          retries = 3
          EOF
          chmod 600 ~/.config/rclone/rclone.conf
          echo "ğŸ”— Rclone Configured (URL: ${WEBDAV_URL%%/*}, User: $WEBDAV_USER)"
          # WebDAVæŒ‚è½½ï¼ˆæœ€å¤š3æ¬¡é‡è¯•ï¼‰
          MOUNT_RETRY=0
          while [ $MOUNT_RETRY -lt 3 ]; do
            rclone mount webdav_remote:$WEBDAV_REMOTE_DIR $LOCAL_MOUNT_POINT \
              --daemon --allow-other --vfs-cache-mode writes --cache-dir $RCLONE_CACHE_DIR --timeout 1h --retries 2
            sleep 5
            if mount | grep -q $LOCAL_MOUNT_POINT; then
              echo "âœ… WebDAV Mount Success: WebDAV($WEBDAV_REMOTE_DIR) â†’ Local($LOCAL_MOUNT_POINT)"
              echo "ğŸ“Š WebDAV Mount Point Free Space: $(df -h $LOCAL_MOUNT_POINT | awk 'NR==2{print $4}')"
              break
            fi
            MOUNT_RETRY=$((MOUNT_RETRY + 1))
            echo "âš ï¸ WebDAV Mount Retry $MOUNT_RETRY Failed"
            sudo fusermount -u $LOCAL_MOUNT_POINT 2>/dev/null || true
          done
          if [ $MOUNT_RETRY -eq 3 ]; then
            echo "ERROR: WebDAV Mount Failed After 3 Retries! Exit."
            exit 1
          fi
          # åˆ›å»ºWebDAVæ—¥å¿—ç›®å½•
          mkdir -p $LOCAL_MOUNT_POINT/logs
          echo "WEBDAV_STATUS=success" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 2 Completed ===="

      - name: "Step 3: Backup Restore & Validation (CasaOS+Docker+/DATA)"
        id: backup_restore
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 3 Start: Backup Restore ===="
          BACKUP_MARKER_FILE="$LOCAL_MOUNT_POINT/$BACKUP_MARKER"
          HAS_BACKUP="false"
          if [ -f "$BACKUP_MARKER_FILE" ]; then
            LATEST_BACKUP=$(cat "$BACKUP_MARKER_FILE")
            echo "ğŸ” Found Backup Marker: $BACKUP_MARKER_FILE"
            echo "ğŸ” Latest Backup File: $LATEST_BACKUP | Size: $(du -h $LOCAL_MOUNT_POINT/$LATEST_BACKUP 2>/dev/null | awk '{print $1}')"
            # ç”Ÿæˆæ’é™¤åˆ—è¡¨
            echo "$BACKUP_EXCLUDE" | tr ' ' '\n' > $BACKUP_DIR/exclude-list.txt
            # åœæ­¢Dockeré¿å…æ–‡ä»¶å ç”¨
            sudo systemctl stop docker containerd 2>/dev/null || true
            sleep 3
            echo "ğŸ“Œ Start Restore From WebDAV: $LOCAL_MOUNT_POINT/$LATEST_BACKUP"
            if sudo tar -zxf "$LOCAL_MOUNT_POINT/$LATEST_BACKUP" -C / --exclude-from=$BACKUP_DIR/exclude-list.txt; then
              # æ ¡éªŒæ ¸å¿ƒç›®å½•
              if [ -d "/etc/casaos" ] && [ -d "/var/lib/docker/containers" ] && [ -d "/DATA" ]; then
                echo "âœ… Restore Success - Critical Directories Exist: /etc/casaos | /var/lib/docker/containers | /DATA"
                HAS_BACKUP="true"
              else
                echo "WARNING: Restore Validation Failed - Critical Directories Missing"
              fi
            else
              echo "WARNING: Restore Command Failed - Use Fresh Env"
            fi
            # é‡å¯Docker
            sudo systemctl start docker containerd 2>/dev/null || true
            echo "âœ… Docker Service Restarted After Restore"
          else
            echo "â„¹ï¸ No Backup Marker Found - Use Fresh Environment"
          fi
          echo "HAS_BACKUP=$HAS_BACKUP" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 3 Completed ===="

      - name: "Step 4: CasaOS Installation & Startup"
        id: casaos_install
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 4 Start: CasaOS Install ===="
          # å®‰è£…CasaOS
          curl -fsSL https://get.casaos.io | sudo bash -s -- --debug 2>&1 | grep -v "restart" || { echo "WARNING: CasaOS Install Has Warnings"; }
          sudo systemctl daemon-reload
          sudo systemctl enable --now casaos
          sleep 10
          # æ ¡éªŒæœåŠ¡çŠ¶æ€
          if sudo systemctl is-active --quiet casaos; then
            echo "âœ… CasaOS Service Status: Running"
            echo "ğŸ”— CasaOS Core Paths: /etc/casaos (Config) | /var/lib/casaos (Data)"
          else
            echo "WARNING: CasaOS Service Status: Not Running - Check Logs Later"
          fi
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 4 Completed ===="

      - name: "Step 5: Tailscale Deployment (5 Retries)"
        id: tailscale_deploy
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 5 Start: Tailscale Deploy ===="
          # åŒæ–¹æ¡ˆå®‰è£…Tailscale
          if ! curl -fsSL https://tailscale.com/install.sh | sudo sh -s -- -q; then
            echo "âš ï¸ Script Install Failed - Fallback to APT"
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
            curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
            sudo apt update && sudo apt install -y tailscale
          fi
          sudo systemctl enable --now tailscaled
          sleep 5
          # ç»„ç½‘ï¼ˆæœ€å¤š5æ¬¡é‡è¯•ï¼‰
          TS_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          if [ -z "$TS_AUTH_KEY" ]; then
            echo "ERROR: Tailscale Auth Key Not Configured! Exit."
            exit 1
          fi
          TS_RETRY=0
          TAILSCALE_IP=""
          while [ $TS_RETRY -lt 5 ]; do
            if sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=casaos-${{ github.run_id }} --accept-routes=false --accept-dns=false; then
              TAILSCALE_IP=$(sudo tailscale ip -4)
              if [ -n "$TAILSCALE_IP" ]; then
                echo "âœ… Tailscale Joined - Internal IP: $TAILSCALE_IP"
                echo "âœ… Tailscale Hostname: casaos-${{ github.run_id }}"
                break
              fi
            fi
            TS_RETRY=$((TS_RETRY + 1))
            echo "âš ï¸ Tailscale Retry $TS_RETRY Failed"
            sleep 5
          done
          if [ -z "$TAILSCALE_IP" ]; then
            echo "ERROR: Tailscale Join Failed After 5 Retries! Exit."
            exit 1
          fi
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 5 Completed ===="

      - name: "Step 6: Output Service Access Info"
        id: output_info
        continue-on-error: false
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 6 Start: Access Info Output ===="
          echo "===================================== SERVICE ACCESS INFO ====================================="
          echo "âœ… Total Runtime: 360 Minutes (6 Hours)"
          echo "âœ… Renew Trigger: When Remaining Time = 30 Minutes"
          echo "âœ… System Free Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "âœ… Runner Password: $RUNNER_PASSWORD"
          echo "âœ… WebDAV Status: $WEBDAV_STATUS | Remote Dir: $WEBDAV_REMOTE_DIR"
          echo "âœ… CasaOS Panel: http://$TAILSCALE_IP:$CASAOS_PORT"
          echo "âœ… Data Source: $(if [ $HAS_BACKUP = 'true' ]; then echo "Restored From Backup"; else echo "Fresh Install"; fi)"
          echo "âœ… Backup Scope: CasaOS Core + Docker Core + /DATA | Exclude: Logs/Temp/Junk"
          echo "âœ… Log File: $LOG_DIR/$LOG_FILE | WebDAV Log Dir: $LOCAL_MOUNT_POINT/logs"
          echo "=============================================================================================="
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 6 Completed ===="

      - name: "Step 7: Core Keepalive + Hourly Clean + Full Stop Backup + Auto Renew"
        id: core_keepalive
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 7 Start: Core Keepalive Logic ===="
          start_time=$(date +%s)
          last_clean=$start_time
          backup_done=false
          GITHUB_PAT=${{ secrets.USER_GITHUB_PAT }}
          REPO=${{ github.repository }}
          CURRENT_RUN_ID=${{ github.run_id }}

          # å­å‡½æ•°1ï¼šæ¯å°æ—¶æ·±åº¦æ¸…ç†ï¼ˆç³»ç»Ÿ+Docker+æ—¥å¿—ï¼‰
          auto_clean() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [HOURLY CLEAN] Start Deep Cleanup"
            BEFORE=$(df -h / | awk 'NR==2{print $4}')
            BEFORE_SIZE=$(df -B1 / | awk 'NR==2{print $4}')
            # æ¸…ç†ç³»ç»Ÿç¼“å­˜
            sudo apt clean -y && sudo apt autoremove -y --purge -qq
            # æ¸…ç†Dockeråƒåœ¾
            DOCKER_DANGLING=$(sudo docker images -f "dangling=true" -q | wc -l)
            sudo docker system prune -af --volumes 2>/dev/null || true
            sudo docker rmi $(sudo docker images -f "dangling=true" -q) 2>/dev/null || true
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/* 2>/dev/null || true
            # æ¸…ç†æ—§æ—¥å¿—
            OLD_LOGS=$(find $LOG_DIR -name "*.log" ! -name "$LOG_FILE" | wc -l)
            find $LOG_DIR -name "*.log" ! -name "$LOG_FILE" -delete 2>/dev/null || true
            WEBDAV_OLD_LOGS=$(find $LOCAL_MOUNT_POINT/logs -name "*.log" -type f -mtime +7 | wc -l)
            find $LOCAL_MOUNT_POINT/logs -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true
            # æ‰“å°æ¸…ç†ç»“æœ
            AFTER=$(df -h / | awk 'NR==2{print $4}')
            AFTER_SIZE=$(df -B1 / | awk 'NR==2{print $4}')
            FREED_SIZE=$(( (BEFORE_SIZE - AFTER_SIZE) / 1024 / 1024 ))
            echo "ğŸ“Š Cleanup Result: $BEFORE â†’ $AFTER (Freed ~${FREED_SIZE}MB)"
            echo "ğŸ—‘ï¸ Cleaned: $DOCKER_DANGLING Dangling Images | $OLD_LOGS Local Logs | $WEBDAV_OLD_LOGS WebDAV Logs"
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [HOURLY CLEAN] Completed"
          }

          # å­å‡½æ•°2ï¼šå…¨è¿›ç¨‹åœæ­¢å¤‡ä»½ï¼ˆç²¾å‡†å¤‡ä»½æ ¸å¿ƒæ•°æ®ï¼Œæ— åƒåœ¾ï¼‰
          do_backup() {
            FREE_SPACE=$(df -h / | awk 'NR==2{print $4}')
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [BACKUP] Triggered - Free Space: $FREE_SPACE"
            # ç©ºé—´ä¸è¶³åˆ™ç´§æ€¥æ¸…ç†
            if (( $(echo "$FREE_SPACE < 5" | bc -l) )); then
              echo "âš ï¸ Free Space <5G - Run Emergency Cleanup First"
              auto_clean
            fi
            # åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
            TS=$(date +%Y%m%d_%H%M%S)
            BK_NAME="casaos_${CURRENT_RUN_ID}_$TS.tar.gz"
            BK_PATH="$LOCAL_MOUNT_POINT/$BK_NAME"
            DOCKER_CONTAINERS=$(sudo docker ps -q | wc -l)
            sudo docker stop $(sudo docker ps -q) 2>/dev/null || true
            sudo systemctl stop docker containerd casaos tailscaled 2>/dev/null || true
            sleep 5
            echo "ğŸ›‘ Stopped $DOCKER_CONTAINERS Containers + All Services"
            # æ‰§è¡Œç²¾å‡†å¤‡ä»½
            echo "ğŸ“¥ Start Backup - Target: $BK_PATH"
            echo "ğŸ“¥ Backup Includes: /etc/casaos | /var/lib/casaos | /var/lib/docker/{image,containers,volumes,networks} | /DATA"
            sudo tar -z -cf $BK_PATH $BACKUP_EXCLUDE \
              /etc/casaos \
              /var/lib/casaos \
              /var/lib/docker/image \
              /var/lib/docker/containers \
              /var/lib/docker/volumes \
              /var/lib/docker/networks \
              /DATA \
              --warning=no-file-changed
            # å¤‡ä»½æ ¡éªŒ
            if [ -f "$BK_PATH" ] && [ $(stat -c%s "$BK_PATH") -gt 1024 ]; then
              BK_SIZE=$(du -h $BK_PATH | awk '{print $1}')
              echo "âœ… Backup Valid - Name: $BK_NAME | Size: $BK_SIZE"
              echo "âœ… Stored in WebDAV: $WEBDAV_REMOTE_DIR/$BK_NAME"
              # æ›´æ–°æ ‡è®°æ–‡ä»¶
              echo "$BK_NAME" > "$LOCAL_MOUNT_POINT/$BACKUP_MARKER"
              cp $LOG_DIR/$LOG_FILE "$LOCAL_MOUNT_POINT/logs/"
              echo "âœ… Backup Marker Updated: $LOCAL_MOUNT_POINT/$BACKUP_MARKER"
              # æ¸…ç†æ—§å¤‡ä»½
              BACKUP_FILES=$(ls -t $LOCAL_MOUNT_POINT/casaos_*.tar.gz 2>/dev/null | grep -v "tmp")
              BACKUP_COUNT=$(echo "$BACKUP_FILES" | wc -l)
              if [ $BACKUP_COUNT -gt $KEEP_BACKUP_COUNT ]; then
                FILES_TO_DELETE=$(echo "$BACKUP_FILES" | tail -n +$((KEEP_BACKUP_COUNT + 1)))
                DELETE_COUNT=$(echo "$FILES_TO_DELETE" | wc -l)
                for FILE in $FILES_TO_DELETE; do
                  sudo rm -f "$FILE" || true
                done
                echo "ğŸ—‘ï¸ Cleaned $DELETE_COUNT Old Backups | Retained $KEEP_BACKUP_COUNT Latest"
              else
                echo "â„¹ï¸ Backup Count ($BACKUP_COUNT) â‰¤ Retention - No Cleanup"
              fi
            else
              echo "âŒ Backup Invalid - Delete Corrupted File"
              sudo rm -f "$BK_PATH" 2>/dev/null || true
            fi
            # é‡å¯æ‰€æœ‰æœåŠ¡
            echo "ğŸ”„ Restart Services (Dependency Order)"
            sudo systemctl start docker containerd 2>/dev/null || true
            sleep 3
            sudo systemctl start casaos tailscaled 2>/dev/null || true
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=casaos-${{ github.run_id }} 2>/dev/null || true
            echo "âœ… All Services Restarted"
            backup_done=true
          }

          # å­å‡½æ•°3ï¼šè§¦å‘æ–°å·¥ä½œæµç»­è·‘
          trigger_renew() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [RENEW] Trigger New Workflow"
            if [ -z "$GITHUB_PAT" ] || [ -z "$REPO" ]; then
              echo "âŒ Failed - PAT/Repo Not Configured"
              return 1
            fi
            RESPONSE=$(curl -s -X POST https://api.github.com/repos/$REPO/dispatches \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_PAT" \
              -d '{"event_type":"renew_vnc"}' \
              -w "%{http_code}" -o /dev/null --connect-timeout 30s)
            if [ "$RESPONSE" -eq 204 ]; then
              echo "âœ… Trigger Success - HTTP Code: $RESPONSE"
              return 0
            else
              echo "âŒ Trigger Failed - HTTP Code: $RESPONSE"
              return 1
            fi
          }

          # å­å‡½æ•°4ï¼šæ£€æŸ¥æ–°å®¹å™¨å¥åº·çŠ¶æ€
          check_new_container() {
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [HEALTH CHECK] Check New Container - Timeout: $HEALTH_CHECK_TIMEOUTs"
            start_check=$(date +%s)
            while [ $(( $(date +%s) - start_check )) -lt $HEALTH_CHECK_TIMEOUT ]; do
              RUNS=$(curl -s -H "Authorization: Bearer $GITHUB_PAT" \
                "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&event=repository_dispatch" \
                | jq -r '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID') | .id')
              if [ -n "$RUNS" ]; then
                NEW_RUN_ID=$(echo "$RUNS" | head -n 1)
                echo "âœ… New Container Found - Run ID: $NEW_RUN_ID"
                echo $NEW_RUN_ID > $NEW_RUN_ID_FILE
                sleep 120
                echo "âœ… New Container Healthy"
                return 0
              fi
              echo "â³ New Container Not Ready - Wait 10s"
              sleep 10
            done
            echo "âŒ Timeout - No Valid New Container"
            return 1
          }

          # æ ¸å¿ƒä¿æ´»å¾ªç¯ï¼ˆæ¯60ç§’æ‰§è¡Œä¸€æ¬¡çŠ¶æ€æ£€æŸ¥ï¼‰
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] [KEEPALIVE] Monitoring Loop Started - Interval: 60s"
          while true; do
            now=$(date +%s)
            run_mins=$(( (now - start_time) / 60 ))
            remaining_mins=$((MAX_RUN_MINUTES - run_mins))
            free_space=$(df -h / | awk 'NR==2{print $4}')
            # æ‰“å°å®æ—¶çŠ¶æ€
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [KEEPALIVE] Status - Running: $run_mins Mins | Remaining: $remaining_mins Mins | Free Space: $free_space"
            # å®šæ—¶æ¸…ç†
            if [ $((now - last_clean)) -ge $CLEAN_INTERVAL ]; then
              auto_clean
              last_clean=$now
            fi
            # ç´§æ€¥æ¸…ç†ï¼ˆç©ºé—´<1Gæ—¶è§¦å‘ï¼‰
            if (( $(echo "$free_space < 1" | bc -l) )); then
              echo "âš ï¸ Emergency Cleanup Triggered - Free Space <1G"
              auto_clean
              last_clean=$now
            fi
            # å¤‡ä»½+ç»­è·‘è§¦å‘ï¼ˆå‰©ä½™30åˆ†é’Ÿæ—¶æ‰§è¡Œï¼‰
            if [ $remaining_mins -eq 30 ] && [ "$backup_done" = false ]; then
              do_backup
              if trigger_renew; then
                if check_new_container; then
                  echo "âœ… New Container Ready - Old Container Exit Safely"
                  sudo systemctl stop casaos tailscaled docker containerd
                  sudo tailscale down
                  exit 0
                else
                  echo "âš ï¸ New Container Unhealthy - Old Container Continue"
                fi
              else
                echo "âš ï¸ Renew Trigger Failed - Old Container Continue"
              fi
            fi
            # æœåŠ¡ä¿æ´»ç›‘æ§ï¼ˆåœæ­¢åˆ™è‡ªåŠ¨é‡å¯ï¼‰
            if ! sudo systemctl is-active --quiet casaos; then
              echo "âš ï¸ CasaOS Down - Restarting"
              sudo systemctl restart casaos
            fi
            if ! sudo systemctl is-active --quiet tailscaled; then
              echo "âš ï¸ Tailscale Down - Restarting"
              sudo systemctl restart tailscaled
            fi
            if ! sudo systemctl is-active --quiet docker; then
              echo "âš ï¸ Docker Down - Restarting"
              sudo systemctl restart docker containerd
            fi
            sleep 60
          done

      - name: "Step 8: Post-Service Cleanup & WebDAV Unmount"
        id: post_cleanup
        if: always()
        run: |
          set -euo pipefail
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 8 Start: Post Cleanup ===="
          # åœæ­¢æ‰€æœ‰æœåŠ¡
          echo "ğŸ›‘ Stop All Services"
          sudo systemctl stop casaos tailscaled docker containerd 2>/dev/null || true
          sudo tailscale down 2>/dev/null || true
          echo "âœ… Services Stopped"
          # åŒæ­¥æœ€ç»ˆæ—¥å¿—åˆ°WebDAV
          echo "ğŸ“¤ Sync Final Log to WebDAV"
          cp $LOG_DIR/$LOG_FILE "$LOCAL_MOUNT_POINT/logs/final_$LOG_FILE" 2>/dev/null || echo "âš ï¸ Log Sync Failed"
          # å¸è½½WebDAVï¼ˆåŒé‡å¸è½½å®¹é”™ï¼‰
          if mount | grep -q $LOCAL_MOUNT_POINT; then
            echo "ğŸ”“ Unmount WebDAV: $LOCAL_MOUNT_POINT"
            sudo fusermount -u $LOCAL_MOUNT_POINT 2>/dev/null || sudo umount -l $LOCAL_MOUNT_POINT 2>/dev/null || true
            echo "âœ… WebDAV Unmounted"
          fi
          # æ¸…ç†æœ¬åœ°ä¸´æ—¶ç›®å½•
          echo "ğŸ—‘ï¸ Clean Local Temp Directories"
          sudo rm -rf $BACKUP_DIR $RCLONE_CACHE_DIR /tmp/* 2>/dev/null || true
          echo "âœ… Cleaned: $BACKUP_DIR | $RCLONE_CACHE_DIR | /tmp"
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] ==== Step 8 Completed ===="
          echo "===================================== WORKFLOW EXECUTION COMPLETED ==================================="
